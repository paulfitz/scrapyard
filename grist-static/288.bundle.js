(self.webpackChunkgrist_core=self.webpackChunkgrist_core||[]).push([[288],{14400:(e,t,o)=>{"use strict";o.d(t,{P:()=>I});var s=o(3988),i=o(18222),n=o(19058),r=o(29922),l=o(1370),a=o(64978),c=o(58375),d=o(18099),u=o(21467),h=o(70387),p=o(83277),m=o(78870),g=o.n(m),f=Object.defineProperty,w=Object.defineProperties,b=Object.getOwnPropertyDescriptors,v=Object.getOwnPropertySymbols,_=Object.prototype.hasOwnProperty,y=Object.prototype.propertyIsEnumerable,x=(e,t,o)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,S=(e,t)=>{for(var o in t||(t={}))_.call(t,o)&&x(e,o,t[o]);if(v)for(var o of v(t))y.call(t,o)&&x(e,o,t[o]);return e};const C=(0,h.makeT)("ViewAsDropdown");class I extends d.Disposable{constructor(e,t=(()=>this._fetchData())){super(),this.pageModel=e,this.fetch=t,this.isInitialized=d.Observable.create(this,!1),this.allUsers=d.Observable.create(this,[]),this._shareUsers=[],this._attributeTableUsers=[],this._exampleUsers=[],this._currentUser=null}async load(){const e=await this.fetch();this.isDisposed()||this.init(e)}getUsers(){const e=[...this._shareUsers,...this._attributeTableUsers];return this._showExampleUsers()&&e.push(...this._exampleUsers),e}init(e){var t;const o=this.pageModel;this._currentUser=(null==(t=o.userOverride.get())?void 0:t.user)||o.appModel.currentValidUser,e&&(this._shareUsers=e.users.map((t=>{return o=S({},t),s={access:(0,c.U9)(t,e)},w(o,b(s));var o,s})).filter((e=>{return e.access&&!((t=e.email)===c._J||t===c.CF);var t})).filter((e=>{var t;return(null==(t=this._currentUser)?void 0:t.id)!==e.id})),this._attributeTableUsers=e.attributeTableUsers,this._exampleUsers=e.exampleUsers,this.allUsers.set(this.getUsers()),this.isInitialized.set(!0))}attachPopup(e,t){(0,u.setPopupToCreateDom)(e,(e=>{const t=e=>this._buildUserRow(e,{isExampleUser:!0});return(0,u.cssMenuWrap)((0,u.cssMenu)(d.dom.cls(l.menuCssClass),R.cls(""),k(C("View As"),d.dom.show(this._shareUsers.length>0)),d.dom.forEach(this._shareUsers,(e=>this._buildUserRow(e))),this._attributeTableUsers.length>0?k(C("Users from table")):null,d.dom.forEach(this._attributeTableUsers,t),this._showExampleUsers()?[this._exampleUsers.length>0?k(C("Example Users")):null,d.dom.forEach(this._exampleUsers,t)]:null,(e=>{setTimeout((()=>e.focus()),0)}),d.dom.onKeyDown({Escape:()=>e.close()})))}),S(S({},u.defaultMenuOptions),t))}menu(e){return(0,l.menu)((()=>(this.load().catch(g()),[M("view as"),d.dom.forEach(this.allUsers,(e=>(0,l.menuItemLink)(`${e.name||e.email} (${(0,c.kw)(e)})`,(0,r.testId)("acl-user-access"),this._viewAs(e))))])),e)}async _fetchData(){const e=this.pageModel.currentDoc.get(),t=await(0,p.waitGrainObs)(this.pageModel.gristDoc);return e&&t.docComm.getUsersForViewAs()}_showExampleUsers(){return this._shareUsers.length+this._attributeTableUsers.length<5}_buildUserRow(e,t={}){return(0,d.dom)("a",{class:n.T7.className+" "+D.className},(0,n.XL)((0,i.O_)(t.isExampleUser?"exampleUser":e,"large")),(0,n.rk)((0,n.tE)(e.name||(0,d.dom)("span",e.email),T("(",(0,c.kw)(e),")",(0,r.testId)("acl-user-access"))),e.name?(0,n.gE)(e.email):null),this._viewAs(e),(0,r.testId)("acl-user-item"))}_viewAs(e){var t,o,i;return(null==(t=this.pageModel)?void 0:t.isPrefork.get())&&"owners"!==(null==(i=null==(o=this.pageModel)?void 0:o.currentDoc.get())?void 0:i.access)?d.dom.on("click",(async()=>{var t,o;const i=await(null==(o=null==(t=this.pageModel)?void 0:t.gristDoc.get())?void 0:o.docComm.fork());if(!i)throw new Error("Failed to create fork");window.location.assign((0,s.urlState)().makeUrl((0,a.xV)(e.email,{doc:i.urlId,docPage:void 0})))})):(0,s.urlState)().setHref((0,a.xV)(e.email,{docPage:void 0}))}}const R=(0,d.styled)("div","\n  max-width: unset;\n"),D=(0,d.styled)(n.T7,`\n  width: auto;\n  padding: 8px 16px;\n  align-items: center;\n  &:hover {\n    background-color: ${r.theme.lightHover};\n  }\n  &, &:hover, &:focus {\n    text-decoration: none;\n  }\n`),T=(0,d.styled)("span","\n  margin: 0 8px;\n  font-weight: normal;\n"),k=(0,d.styled)("div",`\n  margin: 11px 24px 14px 24px;\n  font-weight: 700;\n  text-transform: uppercase;\n  font-size: ${r.vars.xsmallFontSize};\n  color: ${r.theme.darkText};\n`),M=(0,d.styled)("div",`\n  margin: 8px 24px;\n  margin-bottom: 4px;\n  font-weight: 700;\n  text-transform: uppercase;\n  font-size: ${r.vars.xsmallFontSize};\n  color: ${r.theme.darkText};\n`)},23735:(e,t,o)=>{"use strict";o.r(t),o.d(t,{parsePasteForView:()=>r});var s=o(15323),i=o(631);const n=o(61393);async function r(e,t,o){const r={},l=[],a=(0,s.getDocIdHash)();return e.forEach(((e,s)=>{const c=t[s],d=null==c?void 0:c.column();if(!d||d.isRealFormula()||d.disableEditData())return;const u=c.createValueParser()||(e=>e);let h=!1;if(e[0]&&"object"==typeof e[0]){const{colType:t,docIdHash:s,colRef:r}=e[0],c=d.type(),u=s===a;if(h=u||!(0,i.isFullReferencingType)(t||""),"Any"!==c)h=h&&t===c;else if(u&&r){const e=o.docModel.columns.getRowModel(r),s=e.type();if(e.getRowId()&&"Text"!==s&&s===t){const t={type:s,visibleCol:e.visibleCol(),widgetOptions:JSON.stringify(n(e.widgetOptionsJson(),"rulesOptions"))};l.push(["UpdateRecord","_grist_Tables_column",d.getRowId(),t],["MaybeCopyDisplayFormula",r,d.getRowId()])}}}r[d.colId()]=e.map((e=>{if(e){if("string"==typeof e)return u(e);if(h&&e.hasOwnProperty("rawValue"))return e.rawValue;if(e.hasOwnProperty("displayValue"))return u(e.displayValue)}return e}))})),l.length&&await o.docData.sendActions(l),r}},3719:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CELL:()=>c,COL:()=>a,CellSelector:()=>u,NONE:()=>d,ROW:()=>l});var s=o(29301),i=o.n(s),n=o(83277),r=o(18099);const l="row",a="col",c="cell",d="";class u extends r.Disposable{constructor(e){super(),this.view=e,this.row={start:i().observable(0),end:i().observable(0),linePos:i().observable("0px"),dropIndex:i().observable(-1)},this.col={start:i().observable(0),end:i().observable(0),linePos:i().observable("0px"),dropIndex:i().observable(-1)},this.currentSelectType=i().observable(d),this.currentDragType=i().observable(d),this.autoDispose(this.view.cursor.rowIndex.subscribe((()=>this.setToCursor()))),this.autoDispose(this.view.cursor.fieldIndex.subscribe((()=>this.setToCursor()))),this.setToCursor()}setToCursor(e=d){this.view.cursor.rowIndex&&(this.row.start(this.view.cursor.rowIndex()),this.row.end(this.view.cursor.rowIndex())),this.view.cursor.fieldIndex&&(this.col.start(this.view.cursor.fieldIndex()),this.col.end(this.view.cursor.fieldIndex())),this.currentSelectType(e)}containsCell(e,t){return this.containsCol(t)&&this.containsRow(e)}containsRow(e){return(0,n.between)(e,this.row.start(),this.row.end())}containsCol(e){return(0,n.between)(e,this.col.start(),this.col.end())}isSelected(e,t){if(t!==this.currentSelectType())return!1;const o=this.view.domToRowModel(e,t),s=this.view.domToColModel(e,t);switch(t){case l:return this.containsRow(o._index());case a:return this.containsCol(s._index());case c:return this.containsCell(o._index(),s._index());default:return console.error("Given element is not a row, cell or column"),!1}}isRowSelected(e){return this.isCurrentSelectType(a)||this.containsRow(e)}isColSelected(e){return this.isCurrentSelectType(l)||this.containsCol(e)}isCellSelected(e,t){return this.isColSelected(t)&&this.isRowSelected(e)}onlyCellSelected(e,t){return this.row.start()===e&&this.row.end()===e&&this.col.start()===t&&this.col.end()===t}isCurrentSelectType(e){return this._isCurrentType(this.currentSelectType(),e)}isCurrentDragType(e){return this._isCurrentType(this.currentDragType(),e)}colLower(){return Math.min(this.col.start(),this.col.end())}colUpper(){return Math.max(this.col.start(),this.col.end())}rowLower(){return Math.min(this.row.start(),this.row.end())}rowUpper(){return Math.max(this.row.start(),this.row.end())}colCount(){return this.colUpper()-this.colLower()+1}rowCount(){return this.rowUpper()-this.rowLower()+1}selectArea(e,t,o,s){this.row.start(e),this.col.start(t),this.row.end(o),this.col.end(s),(this.colCount()>1||this.rowCount()>1)&&this.currentSelectType(c)}_isCurrentType(e,t){return console.assert(-1!==[l,a,c,d].indexOf(t)),e===t}}},47079:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CopySelection:()=>s});class s{constructor(e,t,o,s){this.rowIds=t,this.fields=o,this.colIds=this.fields.map((e=>e.colId())),this.colRefs=this.fields.map((e=>e.colRef())),this.displayColIds=this.fields.map((e=>e.displayColModel().colId())),this.rowStyle=s.rowStyle,this.colStyle=s.colStyle,this.columns=o.map(((t,o)=>{const s=t.formatter(),i=e.getRowPropFunc(this.displayColIds[o]),n=e.getRowPropFunc(this.colIds[o]);return{colId:this.colIds[o],fmtGetter:e=>s.formatAny(i(e)),rawGetter:e=>n(e)}}))}isCellSelected(e,t){return this.rowIds.includes(e)&&this.colIds.includes(t)}onlyAddRowSelected(){return 1===this.rowIds.length&&"new"===this.rowIds[0]}}},28250:(e,t,o)=>{"use strict";o.d(t,{S:()=>K});var s=o(30583),i=o.n(s),n=o(24412),r=o(11527),l=o(21296),a=o(9072),c=o(413),d=o(631),u=o(45353),h=o(18099),p=Object.defineProperty,m=Object.getOwnPropertySymbols,g=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,w=(e,t,o)=>t in e?p(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,b=(e,t)=>{for(var o in t||(t={}))g.call(t,o)&&w(e,o,t[o]);if(m)for(var o of m(t))f.call(t,o)&&w(e,o,t[o]);return e};const v=o(78870),_=o(88466),y=o(36812),x=o(16914),S=(0,r.get)("window");class C extends a.G{constructor(e){var t;super(),this._options=e,e.access=e.access||l.u.none,this._rpc=new u.Rpc({}),this._rpc.queueOutgoingUntilReadyMessage(),this._rpc.setSendMessage((e=>{var t;return null==(t=this._iframe)?void 0:t.contentWindow.postMessage(e,"*")}));const o=this._onMessage.bind(this);S.window.addEventListener("message",o),this.onDispose((()=>{S.window.removeEventListener("message",o),this._rpc.setSendMessage(v)})),null==(t=e.configure)||t.call(e,this)}useEvents(e,t){this.listenTo(e,"event",(async e=>{t.check(this._options.access)&&await this._rpc.postMessage(e)})),e.attach(this)}exposeAPI(e,t,o){this._rpc.registerImpl(e,function(e,t,o){return new Proxy(e,{get:(e,s)=>function(){if("then"!==s)return t.check(o,s)?e[s](...arguments):void I(o)}})}(t,o,this._options.access)),this.onDispose((()=>this._rpc.unregisterImpl(e)))}exposeMethod(e,t,o){this._rpc.registerFunc(e,((...e)=>{if(o.check(this._options.access,"invoke"))return t(...e);I(this._options.access)}))}editOptions(){return this.callRemote("editOptions")}callRemote(e,...t){return this._rpc.callRemoteFunc(e,...t)}buildDom(){var e;const t=(e=>{if(!e)return e;const t=new URL(e);return t.searchParams.append("access",this._options.access),t.searchParams.append("readonly",String(this._options.readonly)),t.href})(this._options.url);return(null!=(e=this._options.onElem)?e:e=>e)(this._iframe=(0,h.dom)("iframe",h.dom.cls("clipboard_focus"),h.dom.cls("custom_view"),{src:t}))}_onMessage(e){this._iframe&&e.source===this._iframe.contentWindow&&!this.isDisposed()&&("grist"===e.data.mdest&&(e.data.mdest=""),e.data.mtype===u.MsgType.Ready&&this.trigger("ready",this),this._rpc.receiveMessage(e.data))}}const I=e=>{throw new Error("Access not granted. Current access level "+e)};class R{constructor(e){this._minimum=e}check(e){return(0,l.Z)(e,this._minimum)}}class D{constructor(e){this._doc=e}async getDocName(){return this._doc.docId()}async listTables(){const{tableData:e}=await this._doc.docComm.fetchTable("_grist_Tables");return e[3].tableId.filter((e=>""!==e))}async fetchTable(e){return(0,c.fromTableDataAction)(await this._doc.docComm.fetchTable(e))}async applyUserActions(e,t){return this._doc.docComm.applyUserActions(e,b({desc:void 0},t))}async getAccessToken(e){return this._doc.docComm.getAccessToken({readOnly:e.readOnly})}}D.defaultAccess=(new class{constructor(){this._accessMap=new Map}require(e,t="*"){return this._accessMap.set(t,e),this}check(e,t){if(!t)throw new Error("Method name is required for MethodAccess check");if(this._accessMap.has(t)){const o=this._accessMap.get(t);return(0,l.Z)(e,o)}if(this._accessMap.has("*")){const t=this._accessMap.get("*");return(0,l.Z)(e,t)}return!1}}).require(l.u.read_table,"getDocName").require(l.u.full);class T{constructor(e){this._baseView=e}async fetchSelectedTable(){const e=this._visibleColumns(),t=this._baseView.sortedRows.getKoArray().peek().filter((e=>"new"!=e)),o={};for(const s of e){const e=s.displayColModel.peek().colId.peek(),i=this._baseView.tableModel.tableData.getRowPropFunc(e),n=(0,d.extractInfoFromColType)(s.type.peek());o[s.colId.peek()]=t.map((e=>(0,d.reencodeAsAny)(i(e),n)))}return o.id=t,o}async fetchSelectedRecord(e){const t=this._visibleColumns(),o={id:e};for(const s of t){const t=s.displayColModel.peek().colId.peek(),i=(0,d.extractInfoFromColType)(s.type.peek());o[s.colId.peek()]=(0,d.reencodeAsAny)(this._baseView.tableModel.tableData.getValue(e,t),i)}return o}async allowSelectBy(){this._baseView.viewSection.allowSelectBy.set(!0)}async setSelectedRows(e){this._baseView.viewSection.selectedRows.set(e)}_visibleColumns(){const e=this._baseView.viewSection.columns.peek(),t=this._baseView.viewSection.hiddenColumns.peek().map((e=>e.id.peek())),o=this._baseView.viewSection.mappedColumns.peek(),s=new Set(x(Object.values(o||{})));return o?e.filter((e=>o&&s.has(e.colId.peek()))):e.filter((e=>!t.includes(e.id.peek())))}}class k{constructor(e){this._section=e}async setOptions(e){if(null==e||"object"!=typeof e)throw new Error("options must be a valid JSON object");this._section.activeCustomOptions(e)}async getOptions(){var e;return null!=(e=this._section.activeCustomOptions.peek())?e:null}async clearOptions(){this._section.activeCustomOptions(null)}async setOption(e,t){const o=b({},this._section.activeCustomOptions.peek());o[e]=t,this._section.activeCustomOptions(o)}getOption(e){const t=this._section.activeCustomOptions.peek();return null==t?void 0:t[e]}}class M extends a.G{attach(e){this.listenTo(e,"ready",this._ready.bind(this))}_ready(){}_notify(e){this.isDisposed()||this.trigger("event",e)}}class P extends M{constructor(e){super(),this._baseView=e,this._debounced=_((()=>this._update()),0),this.autoDispose(e.cursor.rowIndex.subscribe(this._debounced))}_update(){if(this.isDisposed())return;const e={tableId:this._baseView.viewSection.table().tableId(),rowId:this._baseView.cursor.getCursorPos().rowId||void 0,dataChange:!1};this._notify(e)}}class A extends M{constructor(e,t){super(),this._section=e,this._accessLevel=t,this._currentConfig=h.Computed.create(this,(e=>e(this._section.activeCustomOptions))),this._debounced=_((()=>this._update()),0),(e=>{this.autoDispose(e.addListener(((e,t)=>{y(t,e)||this._debounced()})))})(this._currentConfig)}_ready(){this._debounced()}_update(){this.isDisposed()||this._notify({options:this._currentConfig.get(),settings:{accessLevel:this._accessLevel}})}}class O extends M{constructor(e){super(),this._baseView=e,this._updateMapping=!0,this._debounced=_((()=>this._update()),0),this.autoDispose(e.viewSection.viewFields().subscribe(this._debounced.bind(this))),this.listenTo(e.sortedRows,"rowNotify",this._debounced.bind(this)),this.autoDispose(e.sortedRows.getKoArray().subscribe(this._debounced.bind(this))),this.autoDispose(e.viewSection.mappedColumns.subscribe((()=>{this._updateMapping=!0,this._debounced()})))}_ready(){this._debounced()}_update(){if(this.isDisposed())return;const e={tableId:this._baseView.viewSection.table().tableId(),rowId:this._baseView.cursor.getCursorPos().rowId||void 0,dataChange:!0,mappingsChange:this._updateMapping};this._updateMapping=!1,this._notify(e)}}class F extends h.Disposable{constructor(e,t,o){super(),this._section=e,this._currentAccess=t,this._promptCallback=o}async mappings(){return this._section.mappedColumns.peek()}async configure(e){void 0!==e.hasCustomOptions&&this._section.hasCustomOptions(e.hasCustomOptions),e.requiredAccess&&e.requiredAccess!==this._currentAccess&&this._promptCallback(e.requiredAccess),void 0!==e.columns?this._section.columnsToMap(e.columns):this._section.columnsToMap(null)}}var E=o(59011),B=o(88438),L=o(81294),$=o.n(L),U=o(92979),z=o(92769),V=o(1370),N=o(36322),W=o(86277),j=o(29301);const H=o(52906),G=class extends B.Disposable{create(e,t){i().call(this,e,t,{addNewRow:!0}),this._customDef=this.viewSection.customDef,this._emptyWidgetPage=new URL("custom-widget.html",(0,N.getGristConfig)().homeUrl).href,this.autoDisposeCallback((()=>{this._customSection&&this._customSection.dispose()})),this._foundPlugin=j.observable(!1),this._foundSection=j.observable(!1),this._foundSection.extend({notify:"always"}),this.autoDispose(this._customDef.pluginId.subscribe(this._updatePluginInstance,this)),this.autoDispose(this._customDef.sectionId.subscribe(this._updateCustomSection,this)),this.autoDispose(n.createGroup(G._commands,this,this.viewSection.hasFocus)),this.viewPane=this.autoDispose(this._buildDom()),this._updatePluginInstance()}async triggerPrint(){if(!this.isDisposed()&&this._frame)return await this._frame.callRemote("print")}_updatePluginInstance(){const e=this._customDef.pluginId();this._pluginInstance=this.gristDoc.docPluginManager.pluginsList.find((t=>t.definition.id===e)),this._pluginInstance?this._foundPlugin(!0):(this._foundPlugin(!1),this._foundSection(!1)),this._updateCustomSection()}_updateCustomSection(){if(!this._pluginInstance)return;const e=this._customDef.sectionId();this._customSection=E.CustomSectionElement.find(this._pluginInstance,e),this._customSection?(this._customSection.element.classList.add("flexitem"),this._foundSection(!0)):this._foundSection(!1)}_buildDom(){const{mode:e,url:t,access:o}=this._customDef,s=j.pureComputed((()=>"plugin"===this._customDef.mode())),i=j.pureComputed((()=>s()&&!this._foundPlugin())),n=j.pureComputed((()=>s()&&this._foundPlugin()&&!this._foundSection())),r=j.pureComputed((()=>s()&&this._foundSection())).extend({notify:"always"});return $()("div.flexauto.flexvbox.custom_view_container",$().autoDispose(s),$().autoDispose(i),$().autoDispose(n),$().autoDispose(r),U.scope((()=>[e(),t(),o()]),(([e,t,o])=>"url"===e?this._buildIFrame(t,o||l.u.none):null)),U.maybe(i,(()=>J("Plugin ",$()("strong",U.text(this._customDef.pluginId))," was not found",$().testId("customView_notification_plugin")))),U.maybe(n,(()=>J("Section ",$()("strong",U.text(this._customDef.sectionId))," was not found in plugin ",$()("strong",U.text(this._customDef.pluginId)),$().testId("customView_notification_section")))),U.maybe(r,(()=>this._customSection.element)))}_promptAccess(e){this.gristDoc.isReadonly.get()||this.viewSection.desiredAccessLevel(e)}_buildIFrame(e,t){return h.dom.create(C,{url:e||this._emptyWidgetPage,access:t,readonly:this.gristDoc.isReadonly.get(),configure:e=>{this._frame=e;const o=this;e.exposeAPI("GristDocAPI",new D(this.gristDoc),D.defaultAccess),e.exposeAPI("GristView",new T(o),new R(l.u.read_table)),e.exposeAPI("CustomSectionAPI",new F(this.viewSection,t,this._promptAccess.bind(this)),new R(l.u.none)),e.useEvents(P.create(e,o),new R(l.u.read_table)),e.useEvents(O.create(e,o),new R(l.u.read_table)),e.exposeAPI("WidgetAPI",new k(this.viewSection),new R(l.u.none)),e.useEvents(A.create(e,this.viewSection,t),new R(l.u.none))},onElem:e=>function(e,t){let o=null,s=!1;function i(){o&&(clearInterval(o),o=null)}return h.dom.update(e,h.dom.on("mouseenter",(()=>{s||document.activeElement!==e&&(o=setInterval((()=>{if(document.activeElement===e)try{t()}finally{i()}}),70))})),h.dom.on("mouseleave",i),h.dom.onDispose((()=>{i(),s=!0})))}(e,(()=>{this.isDisposed()||(this.viewSection.isDisposed()||this.viewSection.hasFocus()||this.viewSection.hasFocus(!0),(0,V.closeRegisteredMenu)())}))})}};let K=G;function J(...e){return $()("div.custom_view_notification.bg-warning",$()("p",...e))}K._commands={async openWidgetConfiguration(){var e;if(!this.isDisposed()&&!(null==(e=this._frame)?void 0:e.isDisposed()))try{await this._frame.editOptions()}catch(e){throw"Unknown interface"===e.message?new z.UserError("Custom widget doesn't expose configuration screen."):e}}},H(K.prototype,i().prototype),Object.assign(K.prototype,W.Events)},20288:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DocComm:()=>Jo,GristDoc:()=>Fd,startDocTour:()=>cd});var s=o(29922),i=o(7454),n=o(1370),r=o(18099),l=Object.defineProperty,a=Object.getOwnPropertySymbols,c=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,u=(e,t,o)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;function h(e,t,o={}){return p(e,t,((e,t)=>{for(var o in t||(t={}))c.call(t,o)&&u(e,o,t[o]);if(a)for(var o of a(t))d.call(t,o)&&u(e,o,t[o]);return e})({buttonArrow:g("Collapse")},o))}const p=(0,r.styled)(n.select,`\n  height: 28px;\n  width: 100%;\n  border: 1px solid transparent;\n  cursor: pointer;\n\n  &:hover, &:focus, &.weasel-popup-open, &-active {\n    border: 1px solid ${s.colors.darkGrey};\n    box-shadow: none;\n  }\n`),m=p.className,g=(0,r.styled)(i.icon,`\n  margin: 0 2px;\n  pointer-events: none;\n  display: none;\n\n  .${m}:hover &, .${m}:focus &, .weasel-popup-open &, .${m}-active & {\n    display: flex;\n  }\n`);const f=(0,r.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n  position: relative;\n  outline: none;\n  margin: 6px 8px;\n  cursor: pointer;\n  border-radius: 4px;\n\n  border: 1px solid transparent;\n  &:not(&-editing):hover {\n    border: 1px solid ${s.theme.accessRulesColumnListBorder};\n  }\n`),w=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  border-radius: 3px;\n  padding-left: 6px;\n  padding-right: 2px;\n  color: ${s.theme.accessRulesColumnItemFg};\n\n  .${f.className}-editing & {\n    background-color: ${s.theme.accessRulesColumnItemBg};\n  }\n`),b=(0,r.styled)("div","\n  flex: auto;\n  height: 24px;\n  line-height: 24px;\n  min-width: 0;\n  overflow: hidden;\n  text-overflow: ellipsis;\n"),v=(0,r.styled)("div",`\n  margin-top: 2px;\n  display: none;\n  .${f.className}-editing & {\n    display: flex;\n  }\n`),_=(0,r.styled)("div",`\n  flex: none;\n  height: 16px;\n  width: 16px;\n  border-radius: 16px;\n  display: none;\n  cursor: default;\n  --icon-color: ${s.theme.accessRulesColumnItemIconFg};\n  &:hover {\n    background-color: ${s.theme.accessRulesColumnItemIconHoverBg};\n    --icon-color: ${s.theme.accessRulesColumnItemIconHoverFg};\n  }\n  .${f.className}-editing & {\n    display: flex;\n  }\n`);var y=o(50489),x=o(30835),S=o(88466),C=o.n(S);function I(e){const t=(0,r.dom)("div"),o=x.edit(t);o.setTheme("ace/theme/chrome"),o.setOptions({enableLiveAutocompletion:!0,maxLines:10}),o.renderer.setShowGutter(!1),o.renderer.setPadding(5),o.renderer.setScrollMargin(4,4,0,0),o.$blockScrolling=1/0,o.setReadOnly(e.readOnly),o.setFontSize("12"),o.setHighlightActiveLine(!1);const s=o.getSession();s.setMode("ace/mode/python"),s.setTabSize(2),s.setUseWrapMode(!1);const i=r.Observable.create(null,!e.initialValue.length);o.renderer.scroller.appendChild(D(r.dom.show(i),e.placeholder)),o.on("change",(()=>i.set(!o.getValue().length))),(0,y.setupAceEditorCompletions)(o,{getSuggestions:async function(t){return["and","or","not","in","is","True","False","None","OWNER","EDITOR","VIEWER","user","rec","newRec",...e.getSuggestions(t)].map((e=>[e,null]))}}),o.on("blur",(()=>e.setValue(o.getValue())));const n=C()((()=>e.setValue(o.getValue())),1e3);return o.on("change",n),o.commands.addCommand({name:"onEnter",bindKey:{win:"Enter",mac:"Enter"},exec:()=>o.blur()}),o.commands.removeCommands(["indent","outdent"]),o.setValue(e.initialValue),e.customiseEditor&&e.customiseEditor(o),R(R.cls("-disabled",e.readOnly),r.dom.on("mousedown",(()=>{o.focus()}),{useCapture:!0}),r.dom.onDispose((()=>o.destroy())),r.dom.onDispose((()=>n.cancel())),t)}const R=(0,r.styled)("div",`\n  width: 100%;\n  min-height: 28px;\n  padding: 1px;\n  border-radius: 3px;\n  border: 1px solid transparent;\n  cursor: pointer;\n\n  &:hover {\n    border: 1px solid ${s.colors.darkGrey};\n  }\n  &:not(&-disabled):focus-within {\n    box-shadow: inset 0 0 0 1px ${s.colors.cursor};\n    border-color: ${s.colors.cursor};\n  }\n  &:not(:focus-within) .ace_scroller, &-disabled .ace_scroller {\n    cursor: unset;\n  }\n  &-disabled, &-disabled:hover {\n    background-color: ${s.colors.mediumGreyOpaque};\n    box-shadow: unset;\n    border-color: transparent;\n  }\n  &-disabled .ace-chrome {\n    background-color: ${s.colors.mediumGreyOpaque};\n  }\n  & .ace_marker-layer, & .ace_cursor-layer {\n    display: none;\n  }\n  &:not(&-disabled) .ace_focus .ace_marker-layer, &:not(&-disabled) .ace_focus .ace_cursor-layer {\n    display: block;\n  }\n`),D=(0,r.styled)("div","\n  padding: 4px 5px;\n  opacity: 0.5;\n"),T=(0,r.styled)("input",`\n  width: 100%;\n  min-height: 28px;\n  padding: 4px 5px;\n  border-radius: 3px;\n  border: 1px solid transparent;\n  cursor: pointer;\n  color: ${s.theme.accentText};\n  background-color: ${s.theme.inputBg};\n  caret-color : ${s.theme.inputFg};\n  font: 12px 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;\n  overflow: hidden;\n  text-overflow: ellipsis;\n\n  &:hover {\n    border: 1px solid ${s.theme.inputBorder};\n  }\n  &:not(&-disabled):focus-within {\n    outline: none !important;\n    cursor: text;\n    box-shadow: inset 0 0 0 1px ${s.theme.accentBorder};\n    border-color: ${s.theme.accentBorder};\n  }\n`);var k=o(14400),M=Object.defineProperty,P=Object.defineProperties,A=Object.getOwnPropertyDescriptors,O=Object.getOwnPropertySymbols,F=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,B=(e,t,o)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,L=(e,t)=>{for(var o in t||(t={}))F.call(t,o)&&B(e,o,t[o]);if(O)for(var o of O(t))E.call(t,o)&&B(e,o,t[o]);return e},$=(e,t)=>P(e,A(t));const U=o(66287),z=(o(87604),{R:"read",C:"create",U:"update",D:"delete",S:"schemaEdit"}),V="CRUDS",N=Array.from(V,(e=>z[e])),W={all:"+CRUDS",none:"-CRUDS"},j=U(Object.entries(W).map((([e,t])=>[t,e])));function H(e){W.hasOwnProperty(e)&&(e=W[e]);const t={read:"",create:"",update:"",delete:"",schemaEdit:""};let o="";for(const s of e)if("+"===s)o="allow";else if("-"===s)o="deny";else{if(!z.hasOwnProperty(s)||""===o)throw new Error(`Invalid permissions specification ${JSON.stringify(e)}`);t[z[s]]=o}return t}function G(e){let t="",o="";for(const s of V){const i=e[z[s]];"allow"===i?t+=s:"deny"===i&&(o+=s)}const s=(t?"+"+t:"")+(o?"-"+o:"");return j[s]||s}function K(e){return Object.values(e).every((e=>""===e))}var J=o(83277),q=o(70387),X=Object.defineProperty,Y=Object.defineProperties,Z=Object.getOwnPropertyDescriptors,Q=Object.getOwnPropertySymbols,ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable,oe=(e,t,o)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const se=o(36812),ie="RUCDS",ne=(0,q.makeT)("PermissionsWidget");function re(e){switch(e){case"allow":return"";case"deny":return"allow"}return"deny"}function le(e,t){const o={read:"",create:"",update:"",delete:"",schemaEdit:""};for(const s of e)o[s]=t(s);return o}function ae(e){return e?(0,n.menuIcon)("Tick"):ue()}const ce=(0,r.styled)("div","\n  display: flex;\n  gap: 4px;\n"),de=(0,r.styled)("div",`\n  flex: none;\n  height: 24px;\n  width: 24px;\n  border-radius: 2px;\n  font-size: 13px;\n  font-weight: 500;\n  border: 1px dashed ${s.colors.darkGrey};\n  color: ${s.colors.darkGrey};\n  cursor: pointer;\n\n  display: flex;\n  align-items: center;\n  justify-content: center;\n\n  &-allow {\n    background-color: ${s.colors.lightGreen};\n    border: 1px solid ${s.colors.lightGreen};\n    color: white;\n  }\n  &-deny {\n    background-image: linear-gradient(-45deg, ${s.colors.error} 14px, white 15px 16px, ${s.colors.error} 16px);\n    border: 1px solid ${s.colors.error};\n    color: white;\n  }\n  &.disabled {\n    opacity: 0.5;\n  }\n`),ue=(0,r.styled)("div","\n  width: 24px;\n"),he=(0,r.styled)(n.menuItem,"\n  align-items: start;\n  &.disabled {\n    opacity: unset;\n  }\n"),pe=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n"),me=(0,r.styled)("div","\n  font-size: 12px;\n");var ge=o(92769),fe=o(98987),we=o(11187),be=o(92478),ve=o(29002),_e=o(93965),ye=Object.defineProperty,xe=Object.defineProperties,Se=Object.getOwnPropertyDescriptors,Ce=Object.getOwnPropertySymbols,Ie=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable,De=(e,t,o)=>t in e?ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Te=(e,t)=>{for(var o in t||(t={}))Ie.call(t,o)&&De(e,o,t[o]);if(Ce)for(var o of Ce(t))Re.call(t,o)&&De(e,o,t[o]);return e},ke=(e,t)=>xe(e,Se(t));const Me=o(91944),Pe=()=>!0,Ae="*SPECIAL",Oe={tableId:"*",colIds:"*",body:[{aclFormula:"user.Access in [EDITOR, OWNER]",matchFunc:e=>["editors","owners"].includes(String(e.user.Access)),permissions:H("all"),permissionsText:"all"},{aclFormula:"user.Access in [VIEWER]",matchFunc:e=>["viewers"].includes(String(e.user.Access)),permissions:H("+R-CUDS"),permissionsText:"+R"},{aclFormula:"",matchFunc:Pe,permissions:H("none"),permissionsText:"none"}]};function Fe(e){return e.tableId===Ae&&"SchemaEdit"===e.colIds}const Ee={SchemaEdit:{tableId:Ae,colIds:["SchemaEdit"],body:[{aclFormula:"user.Access in [EDITOR, OWNER]",matchFunc:e=>["editors","owners"].includes(String(e.user.Access)),permissions:H("+S"),permissionsText:"+S"},{aclFormula:"",matchFunc:Pe,permissions:H("-S"),permissionsText:"-S"}]},AccessRules:{tableId:Ae,colIds:["AccessRules"],body:[{aclFormula:"user.Access in [OWNER]",matchFunc:e=>["owners"].includes(String(e.user.Access)),permissions:H("+R"),permissionsText:"+R"},{aclFormula:"",matchFunc:Pe,permissions:H("-R"),permissionsText:"-R"}]},FullCopies:{tableId:Ae,colIds:["FullCopies"],body:[{aclFormula:"user.Access in [OWNER]",matchFunc:e=>["owners"].includes(String(e.user.Access)),permissions:H("+R"),permissionsText:"+R"},{aclFormula:"",matchFunc:Pe,permissions:H("-R"),permissionsText:"-R"}]},SeedRule:{tableId:Ae,colIds:["SeedRule"],body:[]}},Be={tableId:"*",colIds:"*",body:[{aclFormula:"user.Access in [OWNER]",matchFunc:e=>["owners"].includes(String(e.user.Access)),permissions:H("all"),permissionsText:"all"},{aclFormula:"",matchFunc:Pe,permissions:H("none"),permissionsText:"none"}]};class Le{constructor(){this._haveRules=!1,this._columnRuleSets=new Map,this._tableColumnMap=new Map,this._specialRuleSets=new Map,this._tableRuleSets=new Map,this._defaultRuleSet=Oe,this._tableIds=[],this._userAttributeRules=new Map}haveRules(){return this._haveRules}getColumnRuleSet(e,t){return e===Ae?this._specialRuleSets.get(t):this._tableColumnMap.get(`${e}:${t}`)}getAllColumnRuleSets(e){return this._columnRuleSets.get(e)||[]}getTableDefaultRuleSet(e){return this._tableRuleSets.get(e)}getDocDefaultRuleSet(){return this._defaultRuleSet}getAllTableIds(){return this._tableIds}getUserAttributeRules(){return this._userAttributeRules}async update(e,t){const{ruleSets:o,userAttributes:s}=this._safeReadAclRules(e,t),i=new Map;for(const e of s)i.set(e.name,e);const n=new Map,r=new Map,l=new Map,a=new Set;let c=Oe;const d=new Map(Object.entries(Ee));for(const e of o)if(e.tableId===Ae){const o=String(e.colIds),s=d.get(o);s?d.set(o,ke(Te({},e),{body:[...e.body,...s.body]})):t.log.error(`Invalid rule for ${e.tableId}:${e.colIds}`)}else if(t.pullOutSchemaEdit&&"*"===e.tableId&&"*"===e.colIds){const t=e.body.map((e=>Ue(e).schemaEdit)).filter(J.isNonNullish);if(t.length>0){const e="SchemaEdit",o=d.get(e);d.set(e,{tableId:Ae,colIds:["SchemaEdit"],body:[...t,...o.body]})}}for(const e of d.values())(0,J.getSetMapValue)(n,Ae,(()=>[])).push(e);this._haveRules=o.length>0;for(const e of o)if("*"===e.tableId){if("*"!==e.colIds)throw new Error(`Invalid rule for tableId ${e.tableId}, colIds ${e.colIds}`);{const o=t.pullOutSchemaEdit?e.body.map((e=>Ue(e).nonSchemaEdit)).filter(J.isNonNullish):e.body;c=ke(Te({},e),{body:[...o,...Oe.body]})}}else if(e.tableId===Ae);else if("*"===e.colIds){if(a.add(e.tableId),l.has(e.tableId))throw new Error(`Invalid duplicate default rule for ${e.tableId}`);l.set(e.tableId,e)}else{a.add(e.tableId),(0,J.getSetMapValue)(n,e.tableId,(()=>[])).push(e);for(const t of e.colIds)r.set(`${e.tableId}:${t}`,e)}this._columnRuleSets=n,this._tableColumnMap=r,this._tableRuleSets=l,this._defaultRuleSet=c,this._tableIds=[...a],this._userAttributeRules=i,this._specialRuleSets=d}checkDocEntities(e){const t=this.findRuleProblems(e);if(0!==t.length)throw new Error(t[0].comment)}findRuleProblems(e){const t=[],o=e.getMetaTable("_grist_Tables"),s=e.getMetaTable("_grist_Tables_column"),i=new Set(o.getColValues("tableId")),n=this.getAllTableIds().filter((e=>!i.has(e)));n.length>0&&t.push({tables:{tableIds:n},comment:`Invalid tables in rules: ${n.join(", ")}`});const r=new Map,l=s.getColValues("parentId");for(const[e,t]of s.getColValues("colId").entries())(0,J.getSetMapValue)(r,l[e],(()=>new Set)).add(t);for(const e of this.getAllTableIds()){if(!i.has(e))continue;const s=o.findRow("tableId",e),n=r.get(s);for(const o of this.getAllColumnRuleSets(e))if(Array.isArray(o.colIds)){const s=o.colIds.filter((e=>!(null==n?void 0:n.has(e))));s.length>0&&t.push({columns:{tableId:e,colIds:s},comment:`Invalid columns in rules for table ${e}: ${s.join(", ")}`})}}const a=[],c=[];for(const e of this.getUserAttributeRules().values()){const t=o.findRow("tableId",e.tableId);s.findMatchingRowId({parentId:t,colId:e.lookupColId})||(a.push(`${e.tableId}.${e.lookupColId}`),c.push(e.name))}return a.length>0&&t.push({userAttributes:{invalidUAColumns:a,names:c},comment:`Invalid columns in User Attribute rules: ${a.join(", ")}`}),t}_safeReadAclRules(e,t){try{return this.ruleError=void 0,function(e,{log:t,compile:o,includeHelperCols:s}){const i=e.getMetaTable("_grist_ACLResources"),n=e.getMetaTable("_grist_ACLRules"),r=[],l=[],a=new Map;for(const e of Me(n.getRecords(),"rulePos"))(0,J.getSetMapValue)(a,e.resource,(()=>[])).push(e);for(const[n,c]of a.entries()){const a=i.getRecord(n);if(!a)throw new Error(`ACLRule ${c[0].id} refers to an invalid ACLResource ${n}`);if(!a.tableId||!a.colIds)continue;const d=a.tableId,u="*"===a.colIds?"*":a.colIds.split(",");s&&Array.isArray(u)&&u.push(...$e(e,d,u,t));const h=[];for(const e of c)if(e.userAttributes){if("*"!==d||"*"!==u)throw new Error(`ACLRule ${e.id} invalid; user attributes must be on the default resource`);const t=JSON.parse(String(e.userAttributes));if(!t||"object"!=typeof t||![t.name,t.tableId,t.lookupColId,t.charId].every((e=>e&&"string"==typeof e)))throw new Error(`User attribute rule ${e.id} is invalid`);t.origRecord=e,l.push(t)}else{if(h.length>0&&!h[h.length-1].aclFormula)throw new Error(`ACLRule ${e.id} invalid because listed after default rule`);if(e.aclFormula&&!e.aclFormulaParsed)throw new Error(`ACLRule ${e.id} invalid because missing its parsed formula`);{const t=e.aclFormula&&JSON.parse(String(e.aclFormulaParsed));h.push({origRecord:e,aclFormula:String(e.aclFormula),matchFunc:e.aclFormula?null==o?void 0:o(t):Pe,memo:e.memo,permissions:H(String(e.permissionsText)),permissionsText:String(e.permissionsText)})}}const p={tableId:d,colIds:u,body:h};r.push(p)}return{ruleSets:r,userAttributes:l}}(e,t)}catch(e){return this.ruleError=e,{ruleSets:[Be],userAttributes:[]}}}}function $e(e,t,o,s){const i=e.getMetaTable("_grist_Tables"),n=e.getMetaTable("_grist_Tables_column"),r=e.getMetaTable("_grist_Views_section_field"),l=i.findRow("tableId",t);if(!l)return[];const a=[];for(const e of o){let o=function(o){if(Array.isArray(o))for(const i of o){if("number"!=typeof i)continue;const o=n.getRecord(i);o&&(o.colId.startsWith("gristHelper_")&&o.parentId===l?a.push(o.colId):s.error(`Invalid helper column ${o.colId} of ${t}:${e}`))}},i=function(e){o([e.displayCol]),o((0,_e.xD)(e.rules))};const[c]=n.filterRecords({parentId:l,colId:e});if(c){i(c);for(const e of r.filterRecords({colRef:c.id}))i(e)}}return a}function Ue(e){const t=function(e){const t=$(L({},{read:"",create:"",update:"",delete:"",schemaEdit:""}),{schemaEdit:e.schemaEdit}),o=$(L({},e),{schemaEdit:""});return{schemaEdit:K(t)?void 0:t,nonSchemaEdit:!K(o)||K(t)?o:void 0}}(e.permissions);let o,s;return t.schemaEdit&&(o=ke(Te({},e),{permissions:t.schemaEdit,permissionsText:G(t.schemaEdit)})),t.nonSchemaEdit&&(s=ke(Te({},e),{permissions:t.nonSchemaEdit,permissionsText:G(t.nonSchemaEdit)})),o&&s&&(o.origRecord={id:-1}),{schemaEdit:o,nonSchemaEdit:s}}function ze(e){return`[${e.length?"by "+e.join(", "):"Totals"}]`}var Ve=o(413);function Ne(e){const t={};We(e)&&(t.hasRecOrNewRec=!0);const o=new Set;return He(e,o),t.usedColIds=Array.from(o),t}function We(e){if(!Array.isArray(e))throw new Error("expected a list");return!!je(e)||e.some((e=>!!Array.isArray(e)&&We(e)))}function je(e){return Array.isArray(e)&&"Name"===e[0]&&("rec"===e[1]||"newRec"===e[1])}function He(e,t){if(!Array.isArray(e))throw new Error("expected a list");if("Attr"===e[0]&&je(e[1])){const o=e[2];t.add(String(o))}else e.forEach((e=>Array.isArray(e)&&He(e,t)))}var Ge,Ke,Je,qe,Xe,Ye,Ze=o(631),Qe=Object.defineProperty,et=Object.defineProperties,tt=Object.getOwnPropertyDescriptors,ot=Object.getOwnPropertySymbols,st=Object.prototype.hasOwnProperty,it=Object.prototype.propertyIsEnumerable,nt=(e,t,o)=>t in e?Qe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,rt=(e,t)=>{for(var o in t||(t={}))st.call(t,o)&&nt(e,o,t[o]);if(ot)for(var o of ot(t))it.call(t,o)&&nt(e,o,t[o]);return e},lt=(e,t)=>et(e,tt(t));const at=o(36812),ct=(0,q.makeT)("AccessRules");class dt extends r.Disposable{constructor(e){super(),this._gristDoc=e,this._ruleCollection=new Le,this._tableRules=this.autoDispose((0,r.obsArray)()),this._docDefaultRuleSet=r.Observable.create(this,null),this._specialRulesWithDefault=r.Observable.create(this,null),this._specialRulesSeparate=r.Observable.create(this,null),this._userAttrRules=this.autoDispose((0,r.obsArray)()),this._errorMessage=r.Observable.create(this,""),this._ruleProblems=this.autoDispose((0,r.obsArray)()),this._aclResources=new Map,this._aclUsersPopup=k.P.create(this,this._gristDoc.docPageModel),this._ruleStatus=r.Computed.create(this,(e=>{const t=e(this._docDefaultRuleSet),o=e(this._tableRules),s=e(this._specialRulesWithDefault),i=e(this._specialRulesSeparate),n=e(this._userAttrRules);return Math.max(t?e(t.ruleStatus):0,kt(o.length<this._ruleCollection.getAllTableIds().length),kt(n.length<this._ruleCollection.getUserAttributeRules().size),...o.map((t=>e(t.ruleStatus))),...n.map((t=>e(t.ruleStatus))),s?e(s.ruleStatus):0,i?e(i.ruleStatus):0)})),this._savingEnabled=r.Computed.create(this,this._ruleStatus,((e,t)=>1===t)),this._userAttrChoices=r.Computed.create(this,this._userAttrRules,((e,t)=>{const o=[{ruleIndex:-1,value:"user.Access"},{ruleIndex:-1,value:"user.Email"},{ruleIndex:-1,value:"user.UserID"},{ruleIndex:-1,value:"user.Name"},{ruleIndex:-1,value:"user.LinkKey."},{ruleIndex:-1,value:"user.Origin"},{ruleIndex:-1,value:"user.SessionID"},{ruleIndex:-1,value:"user.IsLoggedIn"},{ruleIndex:-1,value:"user.UserRef"}];for(const[s,i]of t.entries()){const t=e(i.tableId),n=e(i.name);for(const e of this.getValidColIds(t)||[])o.push({ruleIndex:s,value:`user.${n}.${e}`})}return o}));for(const e of["_grist_ACLResources","_grist_ACLRules"]){const t=this._gristDoc.docData.getTable(e);this.autoDispose(t.tableActionEmitter.addListener(this._onChange,this))}this.autoDispose(this._gristDoc.docPageModel.currentDoc.addListener(this._updateDocAccessData,this)),this.update().catch((e=>this._errorMessage.set(e.message)))}get allTableIds(){return Array.from(this._aclResources.keys()).sort()}get userAttrRules(){return this._userAttrRules}get userAttrChoices(){return this._userAttrChoices}getTableTitle(e){const t=this._aclResources.get(e);return t?function(e){let{title:t}=e;return e.groupByColLabels&&(t+=" "+ze(e.groupByColLabels)),t}(t):`#Invalid (${e})`}async update(){if(this.isDisposed())return;this._errorMessage.set("");const e=this._ruleCollection,[,,t]=await Promise.all([e.update(this._gristDoc.docData,{log:console,pullOutSchemaEdit:!0}),this._updateDocAccessData(),this._gristDoc.docComm.getAclResources()]);if(this._aclResources=new Map(Object.entries(t.tables)),this._ruleProblems.set(t.problems),this.isDisposed())return;this._tableRules.set(e.getAllTableIds().filter((e=>e!==Ae)).map((t=>ut.create(this._tableRules,t,this,e.getAllColumnRuleSets(t),e.getTableDefaultRuleSet(t)))));const o=["SeedRule"],s=["SchemaEdit","FullCopies","AccessRules"];ht.create(this._specialRulesWithDefault,Ae,this,Pt(o,e.getAllColumnRuleSets(Ae)),Mt(o,e.getTableDefaultRuleSet(Ae))),ht.create(this._specialRulesSeparate,Ae,this,Pt(s,e.getAllColumnRuleSets(Ae)),Mt(s,e.getTableDefaultRuleSet(Ae))),gt.create(this._docDefaultRuleSet,this,null,void 0,e.getDocDefaultRuleSet()),this._userAttrRules.set(Array.from(e.getUserAttributeRules().values(),(e=>xt.create(this._userAttrRules,this,e))))}async save(){var e,t,o;if(!this._savingEnabled.get())return;const s=this._gristDoc.docData,i=s.getMetaTable("_grist_ACLResources"),n=s.getMetaTable("_grist_ACLRules"),r=Ct(i,Dt([{tableId:"*",colIds:"*"}],(null==(e=this._specialRulesWithDefault.get())?void 0:e.getResources())||[],(null==(t=this._specialRulesSeparate.get())?void 0:t.getResources())||[],...this._tableRules.get().map((e=>e.getResources()))).filter((e=>!Fe(e))).map((e=>rt({id:-1},e))),Rt),l=r.rowIdMap.get(Rt({id:-1,tableId:"*",colIds:"*"}));if(!l)throw new Error("Default resource missing in resource map");const a=[];for(const e of this.getRules()){if(0===e.id)continue;let t;if(Fe(e.resourceRec))t=l;else{const o=Rt(e.resourceRec);if(t=r.rowIdMap.get(o),!t)throw new Error(`Resource missing in resource map: ${o}`)}a.push({id:e.id||-1,resource:t,aclFormula:e.aclFormula,permissionsText:e.permissionsText,rulePos:e.rulePos||null,memo:null!=(o=e.memo)?o:""})}for(const e of this._userAttrRules.get()){const t=e.getRule();a.push({id:t.id||-1,resource:l,rulePos:t.rulePos||null,userAttributes:t.userAttributes})}let c=0,d=-1;for(let e=0;e<a.length;e++){const t=a[e].rulePos;if(t&&t>c){const o=(t-c)/(e-d);for(let t=d+1;t<e;t++)a[t].rulePos=c+o*(t-d);c=t,d=e}}for(let e=d+1;e<a.length;e++)a[e].rulePos=++c;const u=Ct(n,a);try{await s.sendActions([...r.userActions,...u.userActions])}catch(e){(0,ge.reportError)(e)}await this.update()}buildDom(){return At((0,r.dom)("div",this._gristDoc.behavioralPromptsManager.attachTip("accessRules",{hideArrow:!0})),Ot((0,we.bigBasicButton)({disabled:!0},r.dom.hide(this._savingEnabled),r.dom.text((e=>{const t=e(this._ruleStatus);return ct(3===t?"Checking...":0===t?"Saved":"Invalid")})),(0,s.testId)("rules-non-save")),(0,we.bigPrimaryButton)(ct("Save"),r.dom.show(this._savingEnabled),r.dom.on("click",(()=>this.save())),(0,s.testId)("rules-save")),(0,we.bigBasicButton)(ct("Reset"),r.dom.show((e=>0!==e(this._ruleStatus))),r.dom.on("click",(()=>this.update())),(0,s.testId)("rules-revert")),(0,we.bigBasicButton)(ct("Add Table Rules"),Ft("Dropdown"),{style:"margin-left: auto"},(0,n.menu)((()=>this.allTableIds.map((e=>(0,n.menuItemAsync)((()=>this._addTableRules(e)),this.getTableTitle(e),r.dom.cls("disabled",(t=>t(this._tableRules).some((t=>t.tableId===e)))))))))),(0,we.bigBasicButton)(ct("Add User Attributes"),r.dom.on("click",(()=>this._addUserAttributes()))),(0,we.bigBasicButton)(ct("View As"),Ft("Dropdown"),(e=>this._aclUsersPopup.attachPopup(e,{placement:"bottom-end"})),r.dom.style("visibility",(e=>e(this._aclUsersPopup.isInitialized)?"":"hidden")))),zt({style:"margin-left: 16px"},r.dom.text(this._errorMessage),(0,s.testId)("access-rules-error")),r.dom.maybe((e=>{const t=e(this._ruleProblems);return t.length>0?t:null}),(e=>Bt(io(this.buildRuleProblemsDom(e))))),(0,fe.a)(r.dom.maybe((e=>e(this._userAttrRules).length),(()=>Bt(Lt(ct("User Attributes")),Vt(Wt(Jt(Ht.cls("-rborder"),Ht.cls("-center"),jt("Name")),Xt(Yt(Jt(jt(ct("Attribute to Look Up"))),Jt(jt(ct("Lookup Table"))),Jt(jt(ct("Lookup Column"))),Gt()))),r.dom.forEach(this._userAttrRules,(e=>e.buildUserAttrDom())))))),r.dom.forEach(this._tableRules,(e=>e.buildDom())),Bt(Lt(ct("Default Rules"),(0,s.testId)("rule-table-header")),r.dom.maybe(this._specialRulesWithDefault,(e=>ao(e.buildCheckBoxes()))),Vt(Wt(Jt(Ht.cls("-rborder"),Ht.cls("-center"),jt("Columns")),Xt(Yt(Gt(),qt(jt(ct("Condition"))),Jt(jt(ct("Permissions"))),Kt(),Gt()))),r.dom.maybe(this._docDefaultRuleSet,(e=>e.buildRuleSetDom()))),(0,s.testId)("rule-table")),r.dom.maybe(this._specialRulesSeparate,(e=>e.buildDom()))))}buildRuleProblemsDom(e){const t=[];for(const o of e)if(o.tables&&this._addButtonsForMissingTables(t,o.tables.tableIds),o.columns&&this._addButtonsForMissingColumns(t,o.columns.tableId,o.columns.colIds),o.userAttributes){const e=o.userAttributes.names;this._addButtonsForMisconfiguredUserAttributes(t,e)}return t.map((e=>(0,r.dom)("span",e)))}getRules(){var e,t,o;return Dt(...this._tableRules.get().map((e=>e.getRules())),(null==(e=this._specialRulesWithDefault.get())?void 0:e.getRules())||[],(null==(t=this._specialRulesSeparate.get())?void 0:t.getRules())||[],(null==(o=this._docDefaultRuleSet.get())?void 0:o.getRules("*"))||[])}removeTableRules(e){Tt(this._tableRules,e)}removeUserAttributes(e){Tt(this._userAttrRules,e)}async checkAclFormula(e){return e?this._gristDoc.docComm.checkAclFormula(e):{}}checkTableColumns(e,t,o){var s;if(!e||e===Ae)return"";const i=null==(s=this._aclResources.get(e))?void 0:s.colIds;if(!i)return`Invalid table: ${e}`;if(t){const s=new Set([...i,...o||[]]),n=t.filter((e=>!s.has(e)));return 0===n.length?"":`Invalid columns in table ${e}: ${n.join(", ")}`}return""}getValidColIds(e){var t;return null==(t=this._aclResources.get(e))?void 0:t.colIds.filter((e=>!(0,Ze.isHiddenCol)(e))).sort()}getSeedRules(){var e;return(null==(e=this._specialRulesWithDefault.get())?void 0:e.getCustomRules("SeedRule"))||[]}_addTableRules(e){if(this._tableRules.get().some((t=>t.tableId===e)))throw new Error(`Trying to add TableRules for existing table ${e}`);const t={tableId:e,colIds:"*",body:[]},o=ut.create(this._tableRules,e,this,void 0,t);this._tableRules.push(o),o.addDefaultRules(this.getSeedRules())}_addUserAttributes(){this._userAttrRules.push(xt.create(this._userAttrRules,this,void 0,{focus:!0}))}_onChange(){0===this._ruleStatus.get()?this.update().catch((e=>this._errorMessage.set(e.message))):this._errorMessage.set("Access rules have changed. Click Reset to revert your changes and refresh the rules.")}async _updateDocAccessData(){await this._aclUsersPopup.load()}_addButtonsForMissingTables(e,t){for(const o of t){const t=ct("Remove {{- tableId }} rules",{tableId:o}),s=(0,we.bigBasicButton)(t,Et("Remove"),r.dom.on("click",(async()=>{await Promise.all(this._tableRules.get().filter((e=>e.tableId===o)).map((e=>e.remove()))),s.style.display="none"})));e.push(s)}}_addButtonsForMissingColumns(e,t,o){const s=(e,t)=>{for(const o of e.columnRuleSets.get()){const e=new Set(o.getColIdList());e.has(t)&&(1===e.size?o.remove():o.removeColId(t))}};for(const i of o){const o=ct("Remove column {{- colId }} from {{- tableId }} rules",{tableId:t,colId:i}),n=(0,we.bigBasicButton)(o,Et("Remove"),r.dom.on("click",(async()=>{await Promise.all(this._tableRules.get().filter((e=>e.tableId===t)).map((e=>s(e,i)))),n.style.display="none"})));e.push(n)}}_addButtonsForMisconfiguredUserAttributes(e,t){for(const o of t){const t=ct("Remove {{- name }} user attribute",{name:o}),s=(0,we.bigBasicButton)(t,Et("Remove"),r.dom.on("click",(async()=>{await Promise.all(this._userAttrRules.get().filter((e=>e.name.get()===o)).map((e=>e.remove()))),s.style.display="none"})));e.push(s)}}}class ut extends r.Disposable{constructor(e,t,o,s){var i;super(),this.tableId=e,this._accessRules=t,this._colRuleSets=o,this._defRuleSet=s,this._columnRuleSets=this.autoDispose((0,r.obsArray)()),this._haveColumnRules=r.Computed.create(this,this._columnRuleSets,((e,t)=>t.length>0)),this._defaultRuleSet=r.Observable.create(this,null),this._columnRuleSets.set((null==(i=this._colRuleSets)?void 0:i.map((e=>this._createColumnObsRuleSet(this._columnRuleSets,this._accessRules,this,e,"*"===e.colIds?[]:e.colIds))))||[]),this._colRuleSets?this._defRuleSet&&gt.create(this._defaultRuleSet,this._accessRules,this,this._haveColumnRules,this._defRuleSet):gt.create(this._defaultRuleSet,this._accessRules,this,this._haveColumnRules),this.ruleStatus=r.Computed.create(this,(e=>{const t=e(this._columnRuleSets),o=e(this._defaultRuleSet);return Math.max(kt(!this._colRuleSets||Boolean(o)!==Boolean(this._defRuleSet)||t.length<this._colRuleSets.length),o?e(o.ruleStatus):0,...t.map((t=>e(t.ruleStatus))))}))}getCustomRules(e){for(const t of this._columnRuleSets.get())if(t.getColIds()===e)return t.getCustomRules();return[]}addDefaultRules(e){const t=this._defaultRuleSet.get();null==t||t.addRuleParts(e,{foldEveryoneRule:!0})}remove(){this._accessRules.removeTableRules(this)}get columnRuleSets(){return this._columnRuleSets}buildDom(){return Bt(Lt((0,r.dom)("span",ct("Rules for table "),$t(this._accessRules.getTableTitle(this.tableId))),(0,i.cssIconButton)((0,i.icon)("Dots"),{style:"margin-left: auto"},(0,n.menu)((()=>[(0,n.menuItemAsync)((()=>this._addColumnRuleSet()),ct("Add Column Rule")),(0,n.menuItemAsync)((()=>this._addDefaultRuleSet()),ct("Add Default Rule"),r.dom.cls("disabled",(e=>Boolean(e(this._defaultRuleSet))))),(0,n.menuItemAsync)((()=>this._accessRules.removeTableRules(this)),ct("Delete Table Rules"))])),(0,s.testId)("rule-table-menu-btn")),(0,s.testId)("rule-table-header")),Vt(Wt(Jt(Ht.cls("-rborder"),Ht.cls("-center"),jt("Columns")),Xt(Yt(Gt(),qt(jt(ct("Condition"))),Jt(jt(ct("Permissions"))),Kt(),Gt()))),this.buildColumnRuleSets()),this.buildErrors(),(0,s.testId)("rule-table"))}buildColumnRuleSets(){return[r.dom.forEach(this._columnRuleSets,(e=>e.buildRuleSetDom())),r.dom.maybe(this._defaultRuleSet,(e=>e.buildRuleSetDom()))]}buildErrors(){return r.dom.forEach(this._columnRuleSets,(e=>zt(r.dom.text(e.formulaError))))}getResources(){const e={allow:new Set,deny:new Set,mixed:new Set};for(const t of this._columnRuleSets.get()){const o=t.summarizePermissions(),s="mixed"===o?"mixed":"allow"===o?"deny":"allow",i=t.getColIdList();if(0===i.length)throw new ge.UserError(`No columns listed in a column rule for table ${this.tableId}`);for(const t of i){if(e[s].has(t))throw new ge.UserError(`Column ${t} appears in multiple rules for table ${this.tableId} that might be order-dependent. Try splitting rules up differently?`);"mixed"===o?(e.allow.add(t),e.deny.add(t),e.mixed.add(t)):(e[o].add(t),e.mixed.add(t))}}return[...this._columnRuleSets.get().map((e=>({tableId:this.tableId,colIds:e.getColIds()}))),{tableId:this.tableId,colIds:"*"}]}getRules(){var e;return Dt(...this._columnRuleSets.get().map((e=>e.getRules(this.tableId))),(null==(e=this._defaultRuleSet.get())?void 0:e.getRules(this.tableId))||[])}removeRuleSet(e){e===this._defaultRuleSet.get()?this._defaultRuleSet.set(null):Tt(this._columnRuleSets,e),this._defaultRuleSet.get()||0!==this._columnRuleSets.get().length||this._accessRules.removeTableRules(this)}_createColumnObsRuleSet(e,t,o,s,i){return mt.create(e,t,o,s,i)}_addColumnRuleSet(){const e=mt.create(this._columnRuleSets,this._accessRules,this,void 0,[]);this._columnRuleSets.push(e),e.addRuleParts(this._accessRules.getSeedRules(),{foldEveryoneRule:!0})}_addDefaultRuleSet(){this._defaultRuleSet.get()||(gt.create(this._defaultRuleSet,this._accessRules,this,this._haveColumnRules),this.addDefaultRules(this._accessRules.getSeedRules()))}}class ht extends ut{buildDom(){return Bt(Lt(ct("Special Rules"),(0,s.testId)("rule-table-header")),this.buildCheckBoxes(),(0,s.testId)("rule-table"))}buildCheckBoxes(){return[this.buildColumnRuleSets(),this.buildErrors()]}getResources(){return this._columnRuleSets.get().filter((e=>!e.hasOnlyBuiltInRules())).map((e=>({tableId:this.tableId,colIds:e.getColIds()})))}_createColumnObsRuleSet(e,t,o,s,i){return at(null==s?void 0:s.colIds,["SchemaEdit"])?yt.create(e,t,o,s,i):vt.create(e,t,o,s,i)}}class pt extends r.Disposable{constructor(e,t,o){var s;super(),this.accessRules=e,this._tableRules=t,this._ruleSet=o,this._body=this.autoDispose((0,r.obsArray)());const i=(null==(s=this._ruleSet)?void 0:s.body.map((e=>St.create(this._body,this,e))))||[];0===i.length&&i.push(St.create(this._body,this,void 0)),this._body.set(i),this.ruleStatus=r.Computed.create(this,this._body,((e,t)=>{var o,s;return Math.max(kt(t.filter((t=>!t.isEmpty(e))).length<((null==(s=null==(o=this._ruleSet)?void 0:o.body)?void 0:s.length)||0)),...t.map((t=>e(t.ruleStatus))))}))}remove(){var e;null==(e=this._tableRules)||e.removeRuleSet(this)}getRules(e){return this._body.get().map((t=>lt(rt({},t.getRulePart()),{resourceRec:{tableId:e,colIds:this.getColIds()}}))).filter((e=>e.aclFormula||e.permissionsText))}getColIds(){return"*"}summarizePermissions(){return function(e){if(0===e.length)return"mixed";const t=e[0];return e.some((e=>e!==t))?"mixed":t}(this._body.get().map((e=>e.summarizePermissions())))}buildRuleSetDom(){return Nt(Jt(Ht.cls("-rborder"),this.buildResourceDom(),(0,s.testId)("rule-resource")),Xt(Zt.cls(""),r.dom.forEach(this._body,(e=>e.buildRulePartDom())),r.dom.maybe((e=>!this.hasDefaultCondition(e)),(()=>Yt({style:"min-height: 28px"},Gt((0,i.cssIconButton)((0,i.icon)("Plus"),r.dom.on("click",(()=>this.addRulePart(null))),(0,s.testId)("rule-add"))),(0,s.testId)("rule-extra-add"))))),(0,s.testId)("rule-set"))}removeRulePart(e){var t;Tt(this._body,e),0===this._body.get().length&&(null==(t=this._tableRules)||t.removeRuleSet(this))}addRulePart(e,t,o=!1){const s=this._body.get(),i=e?s.indexOf(e):s.length,n=St.create(this._body,this,t,o);return this._body.splice(i,0,n),n}addRuleParts(e,t){var o;if(t.foldEveryoneRule){const t=this._body.get(),s=1!==t.length||t[0].getRulePart().aclFormula?null:t[0],i=(null==(o=e[e.length-1])?void 0:o.getRulePart().aclFormula)?null:e[e.length-1];s&&i&&Tt(this._body,s)}for(const t of[...e].reverse()){const{permissionsText:e,aclFormula:o,memo:s}=t.getRulePart();void 0!==e&&void 0!==o&&this.addRulePart(this.getFirst()||null,{aclFormula:o,permissionsText:e,permissions:H(e),memo:s},!0)}}getFirstBuiltIn(){return this._body.get().find((e=>e.isBuiltIn()))}getFirst(){return this._body.get()[0]}isSoleCondition(e,t){const o=e(this._body);return 1===o.length&&o[0]===t}isLastCondition(e,t){const o=e(this._body);return o[o.length-1]===t}hasDefaultCondition(e){const t=e(this._body);return t.length>0&&t[t.length-1].hasEmptyCondition(e)}getAvailableBits(){return["read","update","create","delete"]}getValidColIds(){var e;const t=null==(e=this._tableRules)?void 0:e.tableId;return t&&this.accessRules.getValidColIds(t)||[]}hasColumns(){return!1}hasOnlyBuiltInRules(){return this._body.get().every((e=>e.isBuiltIn()))}getCustomRules(){return this._body.get().filter((e=>!e.isBuiltInOrEmpty()))}}class mt extends pt{constructor(e,t,o,s){super(e,t,o),this._initialColIds=s,this._colIds=r.Observable.create(this,this._initialColIds),this.formulaError=r.Computed.create(this,(o=>e.checkTableColumns(t.tableId,o(this._colIds),this._initialColIds)));const i=this.ruleStatus;this.ruleStatus=r.Computed.create(this,(e=>e(this.formulaError)?2:Math.max(kt(!at(e(this._colIds),this._initialColIds)),e(i))))}buildResourceDom(){return function(e,t){function o(){!c.matches(".weasel-popup-open")&&e.get().length>0&&a.set(!1)}const n=r.Computed.create(null,(e=>"")).onWrite((t=>{setTimeout((()=>{return o=t,e.set([...e.get(),o]),void c.focus();var o}),0)})),l=r.Computed.create(null,e,((e,o)=>{const s=new Set(o);return t.filter((e=>!s.has(e)))})),a=r.Observable.create(null,!e.get().length);let c;return f({tabIndex:"0"},r.dom.autoDispose(l),f.cls("-editing",a),r.dom.on("focus",(function(e){a.set(!0),e.relatedTarget!==c&&c.focus()})),r.dom.forEach(e,(t=>w(b(t),_((0,i.icon)("CrossSmall"),r.dom.on("click",(()=>function(t){e.set(e.get().filter((e=>e!==t)))}(t))),(0,s.testId)("acl-col-remove")),(0,s.testId)("acl-column")))),v(r.dom.update(c=h(n,l,{defaultLabel:"[Add Column]"}),p.cls("-active"),r.dom.on("blur",o),r.dom.onKeyDown({Escape:o}),a.get()?e=>{setTimeout((()=>e.focus()),0)}:null)))}(this._colIds,this.getValidColIds())}getColIdList(){return this._colIds.get()}removeColId(e){this._colIds.set(this._colIds.get().filter((t=>t!==e)))}getColIds(){return this._colIds.get().join(",")}getAvailableBits(){return["read","update"]}hasColumns(){return!0}}class gt extends pt{constructor(e,t,o,s){super(e,t,s),this._haveColumnRules=o}buildResourceDom(){return[oo.cls(""),so(r.dom.text((e=>this._haveColumnRules&&e(this._haveColumnRules)?"All Other":"All")))]}}const ft={permissions:"+S",formula:"user.Access == EDITOR"},wt={permissions:"-S",formula:"user.Access != OWNER"},bt={AccessRules:{name:ct("Permission to view Access Rules"),description:ct("Allow everyone to view Access Rules."),availableBits:["read"],permissions:"+R",formula:"True"},FullCopies:{name:ct("Permission to access the document in full when needed"),description:ct("Allow everyone to copy the entire document, or view it in full in fiddle mode.\nUseful for examples and templates, but not for sensitive data."),availableBits:["read"],permissions:"+R",formula:"True"},SeedRule:{name:ct("Seed rules"),description:ct("When adding table rules, automatically add a rule to grant OWNER full access."),availableBits:["read","create","update","delete"],permissions:"+CRUD",formula:"user.Access in [OWNER]"},SchemaEdit:rt({name:ct("Permission to edit document structure"),description:ct("Allow editors to edit structure (e.g. modify and delete tables, columns, layouts), and to write formulas, which give access to all data regardless of read restrictions."),availableBits:["schemaEdit"]},wt)};class vt extends mt{constructor(){super(...arguments),this._isExpanded=r.Observable.create(this,!1)}get props(){return e=this.getColIds(),bt[e]||lt(rt({},bt.AccessRules),{name:e,description:e});var e}buildRuleSetDom(){const e=this._createIsNonStandardObs(),t=this._createIsCheckedObs(e);return e.get()&&this._isExpanded.set(!0),(0,r.dom)("div",r.dom.autoDispose(t),r.dom.autoDispose(e),Qt((0,i.cssIconButton)((0,i.icon)("Expand"),r.dom.style("transform",(e=>e(this._isExpanded)?"rotate(90deg)":"")),r.dom.on("click",(()=>this._isExpanded.set(!this._isExpanded.get()))),(0,s.testId)("rule-special-expand"),{style:"margin: -4px"}),eo(t,r.dom.prop("disabled",e),(0,s.testId)("rule-special-checkbox")),this.props.description),this._buildDomWarning(),r.dom.maybe(this._isExpanded,(()=>Vt({style:"margin-left: 56px"},Wt(Gt(),Xt(jt(this.props.name)),Jt(jt("Permissions")),Kt(),Gt()),Nt(Zt.cls(""),r.dom.forEach(this._body,(e=>e.buildRulePartDom(!0))),r.dom.maybe((e=>!this.hasDefaultCondition(e)),(()=>Yt({style:"min-height: 28px"},Gt((0,i.cssIconButton)((0,i.icon)("Plus"),r.dom.on("click",(()=>this.addRulePart(null))),(0,s.testId)("rule-add"))),(0,s.testId)("rule-extra-add"))))),(0,s.testId)("rule-set")))),(0,s.testId)("rule-special"),(0,s.testId)(`rule-special-${this.getColIds()}`))}getAvailableBits(){return this.props.availableBits}removeRulePart(e){Tt(this._body,e),0===this._body.get().length&&(this._isExpanded.set(!1),this._allowEveryone(!1))}_buildDomWarning(){return null}_createIsNonStandardObs(){return r.Computed.create(null,this._body,((e,t)=>!t.every((t=>t.isBuiltInOrEmpty(e)||t.matches(e,this.props.formula,this.props.permissions)))))}_createIsCheckedObs(e){return r.Computed.create(null,this._body,((t,o)=>!t(e)&&!o.every((e=>e.isBuiltInOrEmpty(t))))).onWrite((e=>this._allowEveryone(e)))}_allowEveryone(e){const t=this._body.get().filter((e=>e.isBuiltIn()));if(e){const e=_t(this.props);this._body.set([St.create(this._body,this,e,!0),...t])}else this._body.set(t),0===t.length&&this._body.push(St.create(this._body,this,void 0))}}function _t({permissions:e,formula:t}){return{aclFormula:t,permissionsText:e,permissions:H(e)}}class yt extends vt{_buildDomWarning(){return r.dom.maybe((e=>e(this._body).every((t=>t.isBuiltInOrEmpty(e)))),(()=>zt({style:"margin-left: 56px; margin-bottom: 8px;"},"This default should be changed if editors' access is to be limited. ",(0,r.dom)("a",{style:"color: inherit; text-decoration: underline"},"Dismiss",r.dom.on("click",(()=>this._allowEditors("confirm")))),(0,s.testId)("rule-schema-edit-warning"))))}_createIsNonStandardObs(){return r.Computed.create(null,this._body,((e,t)=>!t.every((t=>t.isBuiltInOrEmpty(e)||t.matches(e,this.props.formula,this.props.permissions)||t.matches(e,ft.formula,ft.permissions)))))}_createIsCheckedObs(e){return r.Computed.create(null,this._body,((e,t)=>t.every((t=>t.isBuiltInOrEmpty(e)||t.matches(e,ft.formula,ft.permissions))))).onWrite((e=>this._allowEditors(e)))}_allowEditors(e){const t=this._body.get().filter((e=>e.isBuiltIn()));if("confirm"===e){const e=_t(ft);this._body.set([St.create(this._body,this,e,!0),...t])}else if(e)this._body.set(t);else{const e=_t(wt);this._body.set([St.create(this._body,this,e,!0),...t])}}}class xt extends r.Disposable{constructor(e,t,o={}){super(),this._accessRules=e,this._userAttr=t,this._options=o,this._name=r.Observable.create(this,(null==(Ge=this._userAttr)?void 0:Ge.name)||""),this._tableId=r.Observable.create(this,(null==(Ke=this._userAttr)?void 0:Ke.tableId)||""),this._lookupColId=r.Observable.create(this,(null==(Je=this._userAttr)?void 0:Je.lookupColId)||""),this._charId=r.Observable.create(this,"user."+((null==(qe=this._userAttr)?void 0:qe.charId)||"")),this._validColIds=r.Computed.create(this,this._tableId,((e,t)=>this._accessRules.getValidColIds(t)||[])),this._userAttrError=r.Observable.create(this,""),this.formulaError=r.Computed.create(this,this._tableId,this._lookupColId,this._userAttrError,((t,o,s,i)=>{var n,r;return i.length?i:t(this._tableId)===(null==(n=this._userAttr)?void 0:n.tableId)&&t(this._lookupColId)===(null==(r=this._userAttr)?void 0:r.lookupColId)?"":e.checkTableColumns(o,s?[s]:void 0)})),this.ruleStatus=r.Computed.create(this,(e=>{var t,o,s,i;return e(this.formulaError)?2:kt(e(this._name)!==(null==(t=this._userAttr)?void 0:t.name)||e(this._tableId)!==(null==(o=this._userAttr)?void 0:o.tableId)||e(this._lookupColId)!==(null==(s=this._userAttr)?void 0:s.lookupColId)||e(this._charId)!=="user."+(null==(i=this._userAttr)?void 0:i.charId))})),this.autoDispose(this._tableId.addListener((()=>this._lookupColId.set("")))),this._userAttrChoices=r.Computed.create(this,e.userAttrRules,((e,t)=>{const o=t.indexOf(this);return e(this._accessRules.userAttrChoices).filter((e=>e.ruleIndex<o))}))}remove(){this._accessRules.removeUserAttributes(this)}get name(){return this._name}get tableId(){return this._tableId}buildUserAttrDom(){return Nt(Jt(Ht.cls("-rborder"),to(Ut(this._name,(async e=>this._name.set(e)),{placeholder:ct("Attribute name")},this._options.focus?e=>{setTimeout((()=>e.focus()),0)}:null,(0,s.testId)("rule-userattr-name")))),Xt(Zt.cls(""),Yt(Jt(I({initialValue:this._charId.get(),readOnly:!1,setValue:e=>this._setUserAttr(e),placeholder:"",getSuggestions:()=>this._userAttrChoices.get().map((e=>e.value)),customiseEditor:e=>{e.on("focus",(()=>{var t;"user."==e.getValue()&&(null==(t=e.completer)||t.showPopup(e))}))}}),(0,s.testId)("rule-userattr-attr")),Jt(h(this._tableId,this._accessRules.allTableIds.map((e=>({value:e,label:this._accessRules.getTableTitle(e)}))),{defaultLabel:"[Select Table]"}),(0,s.testId)("rule-userattr-table")),Jt(h(this._lookupColId,this._validColIds,{defaultLabel:"[Select Column]"}),(0,s.testId)("rule-userattr-col")),Gt((0,i.cssIconButton)((0,i.icon)("Remove"),r.dom.on("click",(()=>this._accessRules.removeUserAttributes(this))))),r.dom.maybe(this.formulaError,(e=>zt(e,(0,s.testId)("rule-error")))))),(0,s.testId)("rule-userattr"))}getRule(){var e,t,o,s;const i=this._charId.get().trim(),n=i.startsWith("user.")?i.substring("user.".length):i,r={name:this._name.get(),tableId:this._tableId.get(),lookupColId:this._lookupColId.get(),charId:n};for(const[e,t]of Object.entries(r))if(!t)throw new ge.UserError(`Invalid user attribute rule: ${e} must be set`);if(this._getUserAttrError(i))throw new ge.UserError("Invalid user attribute to look up");return{id:null==(t=null==(e=this._userAttr)?void 0:e.origRecord)?void 0:t.id,rulePos:null==(s=null==(o=this._userAttr)?void 0:o.origRecord)?void 0:s.rulePos,userAttributes:JSON.stringify(r)}}_setUserAttr(e){e!==this._charId.get()&&(this._charId.set(e),this._userAttrError.set(this._getUserAttrError(e)||""))}_getUserAttrError(e){return(e=e.trim()).startsWith("user.LinkKey")?/user\.LinkKey\.\w+$/.test(e)?null:"Use a simple attribute of user.LinkKey, e.g. user.LinkKey.something":this._userAttrChoices.get().map((e=>e.value)).includes(e)?null:"Not a valid user attribute"}}class St extends r.Disposable{constructor(e,t,o=!1){var s;super(),this._ruleSet=e,this._rulePart=t,this._aclFormula=r.Observable.create(this,(null==(Xe=this._rulePart)?void 0:Xe.aclFormula)||""),this._completions=r.Computed.create(this,(e=>[...e(this._ruleSet.accessRules.userAttrChoices).map((e=>e.value)),...this._ruleSet.getValidColIds().map((e=>`rec.${e}`)),...this._ruleSet.getValidColIds().map((e=>`$${e}`)),...this._ruleSet.getValidColIds().map((e=>`newRec.${e}`))])),this._permissions=r.Observable.create(this,(null==(Ye=this._rulePart)?void 0:Ye.permissions)||{read:"",create:"",update:"",delete:"",schemaEdit:""}),this._checkPending=r.Observable.create(this,!1),this._formulaError=r.Observable.create(this,""),this._formulaProperties=r.Observable.create(this,function(e){var t;const o=null==(t=null==e?void 0:e.origRecord)?void 0:t.aclFormulaParsed;return o?Ne(JSON.parse(String(o))):{}}(this._rulePart)),this._memo=r.Observable.create(this,null!=(s=null==t?void 0:t.memo)?s:""),t&&o&&(this._rulePart=void 0),this._showMemoEditor=r.Observable.create(this,!this.isBuiltIn()&&""!==this._memo.get()),this._error=r.Computed.create(this,(e=>e(this._formulaError)||this._warnInvalidColIds(e(this._formulaProperties).usedColIds)||(this._ruleSet.isLastCondition(e,this)||""!==e(this._aclFormula)||""===G(e(this._permissions))?"":"Condition cannot be blank")));const i={read:"",create:"",update:"",delete:"",schemaEdit:""};this.ruleStatus=r.Computed.create(this,(e=>{var t,o,s,n,r,l;return e(this._error)?2:e(this._checkPending)?3:kt(e(this._aclFormula)!==(null!=(o=null==(t=this._rulePart)?void 0:t.aclFormula)?o:"")||e(this._memo)!==(null!=(n=null==(s=this._rulePart)?void 0:s.memo)?n:"")||!at(e(this._permissions),null!=(l=null==(r=this._rulePart)?void 0:r.permissions)?l:i))}))}getRulePart(){var e,t,o,s;return{id:this.isBuiltIn()?0:null==(t=null==(e=this._rulePart)?void 0:e.origRecord)?void 0:t.id,aclFormula:this._aclFormula.get(),permissionsText:G(this._permissions.get()),rulePos:null==(s=null==(o=this._rulePart)?void 0:o.origRecord)?void 0:s.rulePos,memo:this._memo.get()}}hasEmptyCondition(e){return""===e(this._aclFormula)}matches(e,t,o){return e(this._aclFormula)===t&&G(e(this._permissions))===o}summarizePermissions(){return function(e){let t="";for(const o of Object.keys(e)){const s=e[o],i="allowSome"===s?"allow":"denySome"===s?"deny":s;i&&i!==t&&(t=t?"mixed":i)}return"allow"===t||"deny"===t?t:"mixed"}(this._permissions.get())}sanityCheck(e){}buildRulePartDom(e=!1){return no(Yt(Gt(this._isNonFirstBuiltIn()?null:(0,i.cssIconButton)((0,i.icon)("Plus"),r.dom.on("click",(()=>this._ruleSet.addRulePart(this))),(0,s.testId)("rule-add"))),qt(e?Xt.cls(""):null,I({initialValue:this._aclFormula.get(),readOnly:this.isBuiltIn(),setValue:e=>this._setAclFormula(e),placeholder:r.dom.text((e=>this._ruleSet.isSoleCondition(e,this)?ct("Everyone"):this._ruleSet.isLastCondition(e,this)?ct("Everyone Else"):ct("Enter Condition"))),getSuggestions:e=>this._completions.get()}),(0,s.testId)("rule-acl-formula")),Jt(Ht.cls("-stretch"),function(e,t,o,...l){e=e.sort(((e,t)=>ie.indexOf(e.slice(0,1).toUpperCase())-ie.indexOf(t.slice(0,1).toUpperCase())));const a={read:"",create:"",update:"",delete:"",schemaEdit:""},c=le(e,(()=>"allow")),d=le(e,(()=>"deny")),u=le(e,(e=>"read"===e?"allow":"deny")),h=e=>{var s;null==(s=o.sanityCheck)||s.call(o,e),t.set(e)};return ce(r.dom.forEach(e,(e=>de(e.slice(0,1).toUpperCase(),de.cls((o=>"-"+o(t)[e])),r.dom.attr("title",(o=>(0,J.capitalize)(`${o(t)[e]} ${e}`.trim()))),r.dom.cls("disabled",o.disabled),o.disabled?null:r.dom.on("click",(()=>{return h((o=((e,t)=>{for(var o in t||(t={}))ee.call(t,o)&&oe(e,o,t[o]);if(Q)for(var o of Q(t))te.call(t,o)&&oe(e,o,t[o]);return e})({},t.get()),s={[e]:re(t.get()[e])},Y(o,Z(s))));var o,s}))))),(0,i.cssIconButton)((0,i.icon)("Dropdown"),(0,s.testId)("permissions-dropdown"),(0,n.menu)((()=>[[c,d,u,a].every((e=>!se(e,t.get())))?he((()=>null),r.dom.cls("disabled"),(0,n.menuIcon)("Tick"),pe("Custom",me(r.dom.text((e=>function(e){const t=[],o=[];for(const s of N){const i=e[s];"allow"===i?t.push((0,J.capitalize)(s)):"deny"===i&&o.push((0,J.capitalize)(s))}const s=[];return t.length&&s.push(`Allow ${t.join(", ")}.`),o.length&&s.push(`Deny ${o.join(", ")}.`),s.join(" ")}(e(t))))))):null,he((()=>h(c)),ae(se(t.get(),c)),ne("Allow All"),r.dom.cls("disabled",o.disabled)),he((()=>h(d)),ae(se(t.get(),d)),ne("Deny All"),r.dom.cls("disabled",o.disabled)),he((()=>h(u)),ae(se(t.get(),u)),ne("Read Only"),r.dom.cls("disabled",o.disabled)),he((()=>h(a)),se(t.get(),a)?[ae(!0),"No Effect"]:[ae(!1),"Clear"],r.dom.cls("disabled",o.disabled))]))),...l)}(this._ruleSet.getAvailableBits(),this._permissions,{disabled:this.isBuiltIn(),sanityCheck:e=>this.sanityCheck(e)},(0,s.testId)("rule-permissions"))),Kt(r.dom.maybe((e=>!this.isBuiltIn()&&!e(this._showMemoEditor)),(()=>(0,i.cssIconButton)((0,i.icon)("Memo"),r.dom.on("click",(()=>{this._showMemoEditor.set(!0),setTimeout((()=>{var e;return null==(e=this._memoEditor)?void 0:e.focus()}),0)})),(0,s.testId)("rule-memo-add"))))),Gt(this.isBuiltIn()?null:(0,i.cssIconButton)((0,i.icon)("Remove"),r.dom.on("click",(()=>this._ruleSet.removeRulePart(this))),(0,s.testId)("rule-remove"))),r.dom.maybe(this._error,(e=>zt(e,(0,s.testId)("rule-error")))),(0,s.testId)("rule-part")),r.dom.maybe(this._showMemoEditor,(()=>ro(Gt(),lo("Memo"),qt(e?Xt.cls(""):null,this._memoEditor=function(e,...t){return T(r.dom.prop("value",e),r.dom.on("input",((t,o)=>e.set(o.value))),...t)}(this._memo,{placeholder:ct("Type a message...")},r.dom.onKeyDown({Enter:(e,t)=>t.blur()})),(0,s.testId)("rule-memo-editor")),Kt(),Gt((0,i.cssIconButton)((0,i.icon)("Remove"),r.dom.on("click",(()=>{this._showMemoEditor.set(!1),this._memo.set("")})),(0,s.testId)("rule-memo-remove"))),(0,s.testId)("rule-memo")))),(0,s.testId)("rule-part-and-memo"))}isBuiltIn(){var e;return!!this._rulePart&&!(null==(e=this._rulePart.origRecord)?void 0:e.id)}isEmpty(e=J.unwrap){return""===e(this._aclFormula)&&at(e(this._permissions),{read:"",create:"",update:"",delete:"",schemaEdit:""})&&""===e(this._memo)}isBuiltInOrEmpty(e=J.unwrap){return this.isBuiltIn()||this.isEmpty(e)}_isNonFirstBuiltIn(){return this.isBuiltIn()&&this._ruleSet.getFirstBuiltIn()!==this}async _setAclFormula(e){if(e!==this._aclFormula.get()){this._aclFormula.set(e),this._checkPending.set(!0),this._formulaProperties.set({}),this._formulaError.set("");try{this._formulaProperties.set(await this._ruleSet.accessRules.checkAclFormula(e)),this.sanityCheck()}catch(e){this._formulaError.set(e.message)}finally{this._checkPending.set(!1)}}}_warnInvalidColIds(e){if(!e||!e.length)return!1;const t=new Set(this._ruleSet.getValidColIds()),o=e.filter((e=>!t.has(e)));return o.length>0?`Invalid columns: ${o.join(", ")}`:void 0}}function Ct(e,t,o=(e=>String(e.id))){const s=e.getRecords(),i=new Map(s.map((e=>[o(e),e.id]))),n=new Map(t.map((e=>[o(e),e]))),r=s.filter((e=>!n.has(o(e)))),l=t.filter((e=>!i.has(o(e)))).map(((e,t)=>lt(rt({},e),{id:-(t+1)}))),a=s.map((e=>{const t=n.get(o(e)),s=t&&lt(rt(rt({},e),t),{id:e.id});return s&&!at(s,e)?[e,s]:null})).filter(J.isNonNullish);console.log("syncRecords: removing [%s], adding [%s], updating [%s]",r.map(o).join(", "),l.map(o).join(", "),a.map((([e])=>o(e))).join(", "));const c=e.tableId,d=[];return r.length>0&&d.push(["BulkRemoveRecord",c,r.map((e=>e.id))]),a.length>0&&d.push(["BulkUpdateRecord",c,a.map((([e])=>e.id)),It(a)]),l.length>0&&d.push(["BulkAddRecord",c,l.map((e=>e.id)),(0,Ve.getColValues)(l)]),l.forEach((e=>i.set(o(e),e.id))),{userActions:d,rowIdMap:i}}function It(e){const t=new Set;for(const[o,s]of e)for(const e of Object.keys(s))"id"===e||at(o[e],s[e])||t.add(e);const o={};for(const s of t)o[s]=e.map((([e,t])=>t[s]));return o}function Rt(e){return JSON.stringify([e.tableId,e.colIds])}function Dt(...e){return[].concat(...e)}function Tt(e,t){const o=e.get().indexOf(t);return o>=0&&(e.splice(o,1),!0)}function kt(e){return e?1:0}function Mt(e,t){if(t){if("*"===t.colIds)return t;for(const o of t.colIds)if(e.includes(o))return t}}function Pt(e,t){return t.map((t=>Mt(e,t))).filter((e=>e))}const At=(0,r.styled)("div","\n  flex: auto;\n  height: 100%;\n  width: 100%;\n  max-width: 800px;\n  margin: 0 auto;\n  display: flex;\n  flex-direction: column;\n"),Ot=(0,r.styled)("div","\n  flex: none;\n  margin: 16px 16px 8px 16px;\n  display: flex;\n  gap: 16px;\n"),Ft=(0,r.styled)(i.icon,"\n  margin: -2px -2px 0 4px;\n"),Et=(0,r.styled)(i.icon,"\n  margin: -2px -2px 0 4px;\n"),Bt=(0,r.styled)("div","\n  margin: 16px 16px 24px 16px;\n"),Lt=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  margin-bottom: 8px;\n  font-weight: bold;\n  color: ${s.theme.lightText};\n`),$t=(0,r.styled)("span",`\n  color: ${s.theme.text};\n`),Ut=(0,r.styled)(ve.textInput,`\n  color: ${s.theme.inputFg};\n  background-color: ${s.theme.inputBg};\n  width: 100%;\n  border: 1px solid transparent;\n  cursor: pointer;\n\n  &:hover {\n    border: 1px solid ${s.theme.inputBorder};\n  }\n  &:focus {\n    box-shadow: inset 0 0 0 1px ${s.theme.controlFg};\n    border-color: ${s.theme.controlFg};\n    cursor: unset;\n  }\n  &[disabled] {\n    color: ${s.theme.inputDisabledFg};\n    background-color: ${s.theme.inputDisabledBg};\n    box-shadow: unset;\n    border-color: transparent;\n  }\n  &::placeholder {\n    color: ${s.theme.inputPlaceholderFg};\n  }\n`),zt=(0,r.styled)("div",`\n  margin-top: 4px;\n  width: 100%;\n  color: ${s.theme.errorText};\n`),Vt=(0,r.styled)("div",`\n  border: 1px solid ${s.theme.accessRulesTableBorder};\n  border-radius: 8px;\n  overflow: hidden;\n`),Nt=(0,r.styled)("div",`\n  display: flex;\n  border-bottom: 1px solid ${s.theme.accessRulesTableBorder};\n  &:last-child {\n    border-bottom: none;\n  }\n`),Wt=(0,r.styled)(Nt,`\n  background-color: ${s.theme.accessRulesTableHeaderBg};\n  color: ${s.theme.accessRulesTableHeaderFg};\n`),jt=(0,r.styled)("div","\n  margin: 4px 8px;\n  text-transform: uppercase;\n  font-weight: 500;\n  font-size: 10px;\n"),Ht=(0,r.styled)("div",`\n  min-width: 0px;\n  overflow: hidden;\n\n  &-rborder {\n    border-right: 1px solid ${s.theme.accessRulesTableBorder};\n  }\n  &-center {\n    text-align: center;\n  }\n  &-stretch {\n    min-width: unset;\n    overflow: visible;\n  }\n`),Gt=(0,r.styled)(Ht,"flex: none; width: 24px;"),Kt=(0,r.styled)(Gt,"margin: 0px 8px;"),Jt=(0,r.styled)(Ht,"flex: 1;"),qt=(0,r.styled)(Ht,"flex: 2;"),Xt=(0,r.styled)(Ht,"flex: 4;"),Yt=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  gap: 0px 8px;\n  margin: 0 8px;\n  flex-wrap: wrap;\n"),Zt=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n  margin: 4px 0;\n"),Qt=(0,r.styled)("div",`\n  color: ${s.theme.text};\n  display: flex;\n  align-items: top;\n  margin: 16px 0 8px 0;\n  gap: 12px;\n  white-space: pre-line;  /* preserve line breaks in long descriptions */\n`),eo=(0,r.styled)(be.n2,"\n  flex: none;\n"),to=(0,r.styled)("div","\n  margin: 4px 8px;\n"),oo=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  justify-content: center;\n"),so=(0,r.styled)("div",`\n  color: ${s.theme.accessRulesTableBodyFg};\n  font-weight: bold;\n`),io=(0,r.styled)("div","\n  flex: auto;\n  height: 100%;\n  width: 100%;\n  display: flex;\n  flex-direction: row;\n  flex-wrap: wrap;\n  gap: 8px;\n"),no=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  row-gap: 4px;\n"),ro=(0,r.styled)(Yt,"\n  margin-bottom: 8px;\n"),lo=(0,r.styled)(i.icon,`\n  --icon-color: ${s.theme.accentIcon};\n  margin-left: 8px;\n  margin-right: 8px;\n`),ao=(0,r.styled)("div","\n  margin-bottom: 16px;\n");var co=o(88438),uo=o(81294),ho=o.n(uo),po=o(85550),mo=o(29301),go=o(13988),fo=o.n(go),wo=o(92979),bo=o(73783),vo=o(549);const _o=o(13314),yo=window.gristNotify,xo="undone",So="default",Co=(0,q.makeT)("ActionLog");class Io extends co.Disposable{constructor(){super(...arguments),this._pending=[],this._loaded=!1}create(e){this._showAllTables=mo.observable(!1),this._loading=mo.observable(!1),this._gristDoc=e.gristDoc,this._displayStack=fo()(),this._gristDoc?this._selectedTableId=this.autoDispose(mo.computed((()=>this._gristDoc.viewModel.activeSection().table().tableId()))):this._selectedTableId=this.autoDispose(mo.computed((()=>"")))}buildDom(){return this._buildLogDom()}pushAction(e){if(this._loading())return void this._pending.push(e);this._setupFilters(e,this._displayStack.at(0)||void 0);const t=e.otherId?this._displayStack.all().find((t=>t.actionNum===e.otherId)):null;if(t)t.state&&t.state(e.isUndo?xo:So);else{if(e.fromSelf)for(let e=0;e<this._displayStack.peekLength;e++){const t=this._displayStack.at(e);if(!t.state)continue;const o=t.state();if(t.fromSelf&&o===So)break;t.fromSelf&&o===xo&&t.state("buried")}e.otherId||(e.state=mo.observable(So),this._displayStack.unshift(e))}}renderTabularDiffs(e,t,o){const s=(0,vo.$g)(e);return ho()("div",this._renderTableSchemaChanges(e,o),this._renderColumnSchemaChanges(e,o),_o(s,((e,t)=>0===e.cells.length?ho()("div"):ho()("table.action_log_table",wo.show((()=>this._showForTable(t,o))),ho()("caption",this._renderTableName(t)),ho()("tr",ho()("th"),e.header.map((e=>ho()("th",this._renderCell(e))))),e.cells.map((e=>ho()("tr",ho()("td",this._renderCell(e[0])),e[2].map(((i,n)=>ho()("td",this._renderCell(i),ho().on("click",(()=>this._selectCell(e[1],s[t].header[n],t,o?o.actionNum:0)))))))))))),ho()("span.action_comment",t))}_setupFilters(e,t){const o=e.tableFilters={};if(t){const s=new Map(e.actionSummary.tableRenames);for(const e of Object.keys(t.tableFilters))if(e.startsWith("-"));else if(s.has(e)){const i=s.get(e)||(0,vo.QB)(e);o[i]=t.tableFilters[e],o[i](i)}else o[e]=t.tableFilters[e]}const s=(0,vo.r2)(e.actionSummary);for(const e of s)o[e]||(o[e]=mo.observable(e));e.affectedTableIds=s.map((t=>e.tableFilters[t])).filter((e=>e))}_hasSelectedTable(e){return!this._gristDoc||e.affectedTableIds.some((e=>e()===this._selectedTableId()))}_showForTable(e,t){if(!t)return!0;const o=t.tableFilters[e];return this._showAllTables()||!o||o()===this._selectedTableId()}_buildLogDom(){return this._loadActionSummaries().catch((e=>yo(Co("Action Log failed to load")))),ho()("div.action_log",ho()("div.preference_item",bo.checkbox(this._showAllTables,ho().testId("ActionLog_allTables"),ho()("span.preference_desc","All tables"))),ho()("div.action_log_load",wo.show((()=>this._loading())),"Loading..."),wo.foreach(this._displayStack,(e=>{const t=e.time?(0,po.i)("D T",new Date(e.time)):"";let o=e.desc||"";return e.actionSummary&&(o=this.renderTabularDiffs(e.actionSummary,o,e)),ho()("div.action_log_item",wo.cssClass(e.state),wo.show((()=>this._showAllTables()||this._hasSelectedTable(e))),ho()("div.action_info",ho()("span.action_info_action_num",`#${e.actionNum}`),e.user?ho()("span.action_info_user",e.user,wo.toggleClass("action_info_from_self",e.fromSelf)):"",ho()("span.action_info_timestamp",t)),ho()("span.action_desc",o))})))}async _loadActionSummaries(){if(this._loaded||!this._gristDoc)return;this._loading(!0);const e=await this._gristDoc.docComm.getActionSummaries();this._loading(!1),this._loaded=!0,e.forEach((e=>this.pushAction(e)));const t=e.length>0?e[e.length-1].actionNum:0;for(const e of this._pending)e.actionNum>t&&this.pushAction(e);this._pending.length=0}_renderCell(e){if(null===e)return"...";if("string"==typeof e)return e;const[t,o]=e;return t||o?t&&!o?ho()("span.action_log_cell_remove",t[0]):!o||null!==t&&null!==t[0]&&""!==t[0]?t&&o?ho()("div",ho()("span.action_log_cell_remove.action_log_cell_pre",t[0]),ho()("span.action_log_cell_add",o[0])):JSON.stringify(e):ho()("span.action_log_cell_add",o[0]):""}_renderTableName(e){return 0!==e.indexOf("_grist_")?e:`[${e.split("_grist_")[1].replace(/_/g,".")}]`}_renderSchemaChange(e,t,o){const[s,i]=t;return"manualSort"===(s||i)?ho()("div"):ho()("div.action_log_rename",wo.show((()=>this._showForTable(i||(0,vo.QB)(s),o))),i?s?["Rename ",e,ho()("span.action_log_rename_pre",s)," to ",ho()("span.action_log_rename_post",i)]:["Add ",e,ho()("span.action_log_rename_post",i)]:["Remove ",e,ho()("span.action_log_rename_pre",s)])}_renderTableSchemaChanges(e,t){return ho()("div",e.tableRenames.map((e=>this._renderSchemaChange("",e,t))))}_renderColumnSchemaChanges(e,t){return ho()("div",Object.keys(e.tableDeltas).filter((e=>!e.startsWith("-"))).map((o=>ho()("div",wo.show((()=>this._showForTable(o,t))),e.tableDeltas[o].columnRenames.map((e=>this._renderSchemaChange(o+".",e)))))))}async _selectCell(e,t,o,s){if(!this._gristDoc)return;const i=this._displayStack.peek().findIndex((e=>e.actionNum===s));if(i<0)throw new Error(`Cannot find action ${s} in the action log.`);for(let n=i;n>=0;n--){const i=this._displayStack.at(n),r=i.actionSummary,l=r.tableRenames.find((e=>e[0]===o));if(l){const e=l[1];if(!e)return void yo(Co("Table {{tableId}} was subsequently removed in action #{{actionNum}}",{tableId:o,actionNum:i.actionNum}));o=e}const a=r.tableDeltas[o];if(!a)continue;if(a.removeRows.indexOf(e)>=0)return void yo(Co("This row was subsequently removed in action {{action.actionNum}}",{actionNum:s}));const c=a.columnRenames.find((e=>e[0]===t));if(c){const e=c[1];if(!e)return void yo(Co("Column {{colId}} was subsequently removed in action #{{action.actionNum}}",{colId:t,actionNum:i.actionNum}));t=e}}const n=this._gristDoc.getTableModel(o);if(!n)return;const r=n.tableMetaRow.primaryView(),l=r.getRowId();await this._gristDoc.openDocPage(l);const a=r.viewSections().peek().find((e=>e.table().tableId()===o));if(!a)return;const c=a.getRowId(),d=a.viewFields().peek().findIndex((e=>e.colId.peek()===t));this._gristDoc.moveToCursorPos({rowId:e,sectionId:c,fieldIndex:d}).catch((()=>{}))}}var Ro=o(44747),Do=o(9072);const To=o(1066);To.registerLanguage("python",o(68940));const ko=(0,q.makeT)("CodeEditorPanel");class Mo extends Do.G{constructor(e){super(),this._gristDoc=e,this._schema=r.Observable.create(this,""),this._denied=r.Observable.create(this,!1),this.listenTo(e,"schemaUpdateAction",this._onSchemaAction.bind(this)),this._onSchemaAction().catch(ge.reportError)}buildDom(){return(0,r.dom)("div.g-code-panel.clipboard",{tabIndex:"-1"},r.dom.maybe(this._denied,(()=>(0,r.dom)("div.g-code-panel-denied",(0,r.dom)("h2",r.dom.text(ko("Access denied"))),(0,r.dom)("div",r.dom.text(ko("Code View is available only when you have full document access my friend.")))))),r.dom.maybe(this._schema,(e=>{const t=(0,r.dom)("code.g-code-viewer",r.dom.text(e),r.dom.hide(!0));return setTimeout((()=>{To.highlightBlock(t),r.dom.showElem(t,!0)})),t})))}async _onSchemaAction(){try{const e=await this._gristDoc.docComm.fetchTableSchema();this.isDisposed()||(this._schema.set(e),this._denied.set(!1))}catch(e){if(!String(e).match(/Cannot view code/))throw e;this.isDisposed()||(this._schema.set(""),this._denied.set(!0))}}}var Po=o(24412),Ao=o(268),Oo=o(64978);class Fo extends r.Disposable{constructor(e,t){var o,s,i;super(),this._restored=!1,this._store=new Eo(t);const n=null!=(i=null==(s=null==(o=e.app.topAppModel.appObs.get())?void 0:o.currentUser)?void 0:s.id)?i:null;this._key=e.docId()+n,this._whenDocumentLoadsRestorePosition(e),this._whenCursorHasChangedStoreInMemory(e)}clear(){this._store.clear(this._key)}_whenCursorHasChangedStoreInMemory(e){this.autoDispose(e.cursorPosition.addListener((e=>{this._restored&&e&&void 0!==e.rowId&&this._storePosition(e)})))}_whenDocumentLoadsRestorePosition(e){if(e.hasCustomNav.get())return this._abortRestore();"data"!==e.activeViewId.get()?this.autoDispose(Bo(e.currentView,(async()=>{await this._doRestorePosition(e)}))):this._doRestorePosition(e).catch((e=>(0,ge.reportError)(e)))}async _doRestorePosition(e){if(this._restored)return;this._restored=!0;const t=e.activeViewId.get();if(!(0,Oo.NZ)(t))return this._abortRestore();const o=this._readPosition(t);o&&await e.recursiveMoveToCursorPos(o,!0,!0)}_abortRestore(){this.clear(),this._restored=!0}_storePosition(e){this._store.update(this._key,e)}_readPosition(e){const t=this._store.read(this._key);return this._store.clear(this._key),t&&t.position.viewId==e?t.position:null}}class Eo{constructor(e=(0,Ao.c)()){this._storage=e}update(e,t){try{const o=this._storage,s={docId:e,position:t,timestamp:Date.now()};o.setItem(this._key(e),JSON.stringify(s))}catch(e){console.error("Can't store latest position in storage. Detail error "+e.message)}}clear(e){this._storage.removeItem(this._key(e))}read(e){const t=this._storage.getItem(this._key(e));if(t)return JSON.parse(t)}_key(e){return`grist-last-position-${e}`}}function Bo(e,t){let o=e.addListener((e=>{setImmediate(s),t(e)}));function s(){o&&(o.dispose(),o=null)}return{dispose:s}}var Lo=o(30919),$o=o(11527),Uo=o(56964),zo=o(54292),Vo=o(27973),No=o.n(Vo);const Wo=(0,$o.get)("document","window");class jo extends r.Disposable{constructor(e){super(),this._gristDoc=e,this._holder=r.Holder.create(this),Wo.window.resetSeenWarnings=()=>{}}attach(){this._holder.clear();const e=this._gristDoc.docPageModel.appModel.deprecatedWarnings;if(Wo.window.resetSeenWarnings=()=>{this._gristDoc.isDisposed()||(e.set([]),this.attach())},!this._gristDoc.docPageModel.appModel.currentValidUser)return;const t=Object.values(Po.allCommands).filter((e=>e.deprecated)),o=t.map((e=>e.name));if(No()(e.get(),o).length===o.length)return;const s={};for(const e of t)s[e.name]=this._handleCommand.bind(this,e);Object.keys(s).length&&this._holder.autoDispose(Po.createGroup(s,this,!0))}_handleCommand(e){return!!this._hasSeenWarning(e.name)||(this._showWarning(e),!1)}_showWarning(e){var t;const o=null==(t=this._gristDoc.currentView.get())?void 0:t.viewPane.querySelector(".selected_cursor"),s=this._gristDoc.docPageModel.appModel.deprecatedWarnings;o?(0,zo.showDeprecatedWarning)(o,this._createMessage(e.desc),(function(t){if(t){const t=["deprecatedDeleteRecords","deprecatedInsertRecordAfter","deprecatedInsertRowBefore"];t.includes(e.name)?t.forEach((e=>(0,Lo.markAsSeen)(s,e))):(0,Lo.markAsSeen)(s,e.name)}})):(0,ge.reportMessage)((()=>(0,r.dom)("div",this._createMessage(e.desc))),{level:"info",key:"deprecated-command"})}_hasSeenWarning(e){var t;return(null!=(t=this._gristDoc.docPageModel.appModel.deprecatedWarnings.get())?t:[]).includes(Uo.DeprecationWarning.check(e))}_createMessage(e){const t=[];for(const o of e.split(/({\w+})/g))if("{"===o[0]){const e=Po.allCommands[o.slice(1,-1)];e&&t.push(e.getKeysDom((()=>(0,r.dom)("span","or"))))}else t.push(Ho(o));return t}}const Ho=(0,r.styled)("span","\n  line-height: 24px;\n");var Go=o(36322),Ko=o(86277);class Jo extends r.Disposable{constructor(e,t,o,s){super(),this._comm=e,this._docId=o,this._notifier=s,this.fetchTable=this._wrapMethod("fetchTable"),this.fetchTableSchema=this._wrapMethod("fetchTableSchema"),this.useQuerySet=this._wrapMethod("useQuerySet"),this.disposeQuerySet=this._wrapMethod("disposeQuerySet"),this.applyUserActionsById=this._wrapMethod("applyUserActionsById"),this.importFiles=this._wrapMethod("importFiles"),this.finishImportFiles=this._wrapMethod("finishImportFiles"),this.cancelImportFiles=this._wrapMethod("cancelImportFiles"),this.generateImportDiff=this._wrapMethod("generateImportDiff"),this.addAttachments=this._wrapMethod("addAttachments"),this.findColFromValues=this._wrapMethod("findColFromValues"),this.getFormulaError=this._wrapMethod("getFormulaError"),this.fetchURL=this._wrapMethod("fetchURL"),this.autocomplete=this._wrapMethod("autocomplete"),this.removeInstanceFromDoc=this._wrapMethod("removeInstanceFromDoc"),this.getActionSummaries=this._wrapMethod("getActionSummaries"),this.startBundleUserActions=this._wrapMethod("startBundleUserActions"),this.stopBundleUserActions=this._wrapMethod("stopBundleUserActions"),this.forwardPluginRpc=this._wrapMethod("forwardPluginRpc"),this.reloadPlugins=this._wrapMethod("reloadPlugins"),this.reloadDoc=this._wrapMethod("reloadDoc"),this.fork=this._wrapMethod("fork"),this.checkAclFormula=this._wrapMethod("checkAclFormula"),this.getAclResources=this._wrapMethod("getAclResources"),this.waitForInitialization=this._wrapMethod("waitForInitialization"),this.getUsersForViewAs=this._wrapMethod("getUsersForViewAs"),this.getAccessToken=this._wrapMethod("getAccessToken"),this.changeUrlIdEmitter=this.autoDispose(new r.Emitter),this._forkPromise=null,this._isClosed=!1,this._setOpenResponse(t),this.listenTo(e,"docShutdown",(e=>{this.isActionFromThisDoc(e)&&(this._isClosed=!0)})),this.onDispose((async()=>{try{await this._shutdown()}catch(e){String(e).match(/GristWSConnection disposed/)||(0,ge.reportError)(e)}}))}getUrlParams(){return{clientId:this._clientId,docFD:this._docFD}}docUrl(e){return(0,Go.docUrl)(this.docWorkerUrl,e)}get docWorkerUrl(){return this._comm.getDocWorkerUrl(this._docId)}isActionFromThisDoc(e){return e.docFD===this._docFD}applyUserActions(e,t){return this._comm.addUserActions(e),this._callMethod("applyUserActions",e,t)}closeDoc(){return this._callDocMethod("closeDoc")}async forkAndUpdateUrl(){await(this._forkPromise||(this._forkPromise=this._doForkDoc()))}async _shutdown(){console.log(`DocComm: shutdown clientId ${this._clientId} docFD ${this._docFD}`);try{this._isClosed||await this.closeDoc()}catch(e){console.warn(`DocComm: closeDoc failed: ${e}`)}finally{this._comm.isDisposed()||this._comm.releaseDocConnection(this._docId)}}_setOpenResponse(e){this._docFD=e.docFD,this._clientId=e.clientId,this._comm.useDocConnection(this._docId)}_wrapMethod(e){return this._callMethod.bind(this,e)}async _callMethod(e,...t){return this._notifier.slowNotification(this._doCallMethod(e,...t),1e3)}async _doCallMethod(e,...t){if(this._forkPromise)return await this._forkPromise,this._callDocMethod(e,...t);try{return await this._callDocMethod(e,...t)}catch(o){if(o.shouldFork)return await this.forkAndUpdateUrl(),this._callDocMethod(e,...t);throw o}}_callDocMethod(e,...t){return this._comm._makeRequest(this._clientId,this._docId,e,this._docFD,...t)}async _doForkDoc(){(0,ge.reportMessage)("Preparing your copy...",{key:"forking"});const{urlId:e,docId:t}=await this.fork(),o=await this._comm.openDoc(t);this.closeDoc().catch((()=>null)),this._comm.releaseDocConnection(this._docId),this._docId=t,this._setOpenResponse(o),this.changeUrlIdEmitter.emit(e),(0,ge.reportMessage)("You are now editing your own copy",{key:"forking"})}}Object.assign(Jo.prototype,Ko.Events);var qo=o(27910);function Xo(e,t){const o=t.viewSections.getRowModel(e.sectionId).viewFields().peek().findIndex((t=>t.colRef.peek()==e.colRef));return{rowId:e.rowId,fieldIndex:o,sectionId:e.sectionId}}o(55424);var Yo=o(8881),Zo=o(4425);const Qo=(0,q.makeT)("components.Drafts");class es extends r.Disposable{constructor(e){super();const t=ts.create(this,e),o=os.create(this),s=ss.create(this,e),i=is.create(this,e),n=ns.create(this,e),r=(l=this,function(e,t){l.autoDispose(e.addListener(t))});var l;r(n.cellCancelled,(e=>{if(!e.modified)return i.close(),void s.close();s.showUndoDiscard(),o.save(e),i.close()})),r(s.pressed,(async()=>{const e=o.get();e&&(await t.goToCell(e.position),await n.activate(),n.setState(e.state)),o.clear(),s.close()})),r(s.disappeared,(()=>{o.clear()})),r(n.activated,(e=>{o.hasDraftFor(e)&&i.showContinueDraft(),s.close()})),r(n.cellModified,(e=>{i.scheduleClose()})),r(n.cellSaved,(e=>{o.clear(),i.close(),s.close()})),r(i.click,(()=>{const e=o.get();e&&n.setState(e.state),i.close()}))}}class ts extends r.Disposable{constructor(e){super(),this._doc=e}async goToCell(e){await this._doc.recursiveMoveToCursorPos(Xo(e,this._doc.docModel),!0)}}class os extends r.Disposable{get(){return this._memory}save(e){this._memory=e}hasDraftFor(e){const t=this._memory;return!(!t||!class{static equals(e,t){return e&&t&&e.colRef==t.colRef&&e.sectionId==t.sectionId&&e.rowId==t.rowId}static create(e,t){return{rowId:e.id.peek(),colRef:t.colRef.peek(),sectionId:t.viewSection.peek().id.peek()}}}.equals(t.position,e))}clear(){this._memory=null}}class ss extends r.Disposable{constructor(e){super(),this._doc=e,this._hadAction=!1,this._holder=r.Holder.create(this),this.pressed=this.autoDispose(new r.Emitter),this.disappeared=this.autoDispose(new r.Emitter)}close(){this._hadAction=!0,this._holder.clear()}showUndoDiscard(){const e=this._doc.app.topAppModel.notifier.createUserMessage(Qo("Undo discard"),{message:()=>function(...e){return ls(Qo("Undo discard"),(0,s.testId)("draft-notification"),...e)}(r.dom.on("click",(()=>{this._hadAction=!0,this.pressed.emit()})))});e.onDispose((()=>{this._hadAction||this.disappeared.emit()})),this._holder.autoDispose(e),this._hadAction=!1}}class is extends r.Disposable{constructor(e){super(),this._doc=e,this._tooltip=null,this._scheduled=!1,this.click=this.autoDispose(new r.Emitter),this.onDispose((()=>{this.close()}))}scheduleClose(){if(this._tooltip&&!this._scheduled){this._scheduled=!0;const e=this._tooltip.close;this._tooltip.close=()=>{clearTimeout(t),e()};const t=setTimeout(this._tooltip.close,6e3)}}showContinueDraft(){var e;this.close();const t=null==(e=this._doc.activeEditor.get())?void 0:e.getDom();var o;t&&(this._tooltip=(0,Yo.showTooltip)(t,(o=()=>this.click.emit(),function(e){return rs((0,Zo.Y3)(Qo("Restore last edit"),r.dom.on("mousedown",(t=>{t.preventDefault(),e.close(),o()})),(0,s.testId)("draft-tooltip")),(0,Yo.tooltipCloseButton)(e))})))}close(){var e;this._scheduled=!1,null==(e=this._tooltip)||e.close(),this._tooltip=null}}class ns extends r.Disposable{constructor(e){super(),this._doc=e,this.cellSaved=this.autoDispose(new r.Emitter),this.cellModified=this.autoDispose(new r.Emitter),this.activated=this.autoDispose(new r.Emitter),this.cellCancelled=this.autoDispose(new r.Emitter),this._holder=r.Holder.create(this),this.autoDispose(e.activeEditor.addListener((e=>{if(!e)return;this.activated.emit(e.cellPosition());const t=r.MultiHolder.create(this._holder);t.autoDispose(e.changeEmitter.addListener((e=>{this.cellModified.emit({position:e.position,state:e.currentState,modified:e.wasModified})}))),t.autoDispose(e.cancelEmitter.addListener((e=>{this.cellCancelled.emit({position:e.position,state:e.currentState,modified:e.wasModified})}))),t.autoDispose(e.saveEmitter.addListener((e=>{this.cellSaved.emit({position:e.position,state:e.currentState,modified:e.wasModified})})))})))}setState(e){var t;null==(t=this._doc.activeEditor.get())||t.rebuildEditor(void 0,Number.POSITIVE_INFINITY,e)}async activate(){await this._doc.activateEditorAtCursor({})}}const rs=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  --icon-color: ${s.theme.controlFg};\n\n  & > .${Zo.Y3.className} {\n    margin-left: 8px;\n  }\n`),ls=(0,r.styled)("div",`\n  cursor: pointer;\n  color: ${s.theme.controlFg};\n  &:hover {\n    text-decoration: underline;\n  }\n`);class as extends r.Disposable{constructor(e,t){var o,s,i;super(),this._restored=!1;const n=null!=(i=null==(s=null==(o=e.app.topAppModel.appObs.get())?void 0:o.currentUser)?void 0:s.id)?i:null,r=e.docId()+n;this._store=new cs(r,t),this._listenToReload(e).catch((e=>{if(!(e instanceof ge.UserError))throw e;console.error("Error while restoring last edit position",e)}))}monitorEditor(e){const t=(o=this,function(e,t){o.autoDispose(e.addListener(t))});var o;t(e.cancelEmitter,(e=>{this._store.clear()})),t(e.saveEmitter,(e=>{this._store.clear()})),t(e.changeEmitter,(e=>{this._store.updateValue(e.position,e.currentState)}))}async _listenToReload(e){e.isReadonly.get()||e.hasCustomNav.get()?this._store.clear():"data"===e.activeViewId.get()?await this._doRestorePosition(e):this.autoDispose(Bo(e.currentView,(async()=>{await this._doRestorePosition(e)})))}async _doRestorePosition(e){if(this._restored)return;this._restored=!0;const t=e.activeViewId.get();if(!(0,Oo.NZ)(t))return void this._store.clear();const o=this._store.readValue();o&&(await e.recursiveMoveToCursorPos(Xo(o.position,e.docModel),!0,!0),await e.activateEditorAtCursor({state:o.value}))}}class cs{constructor(e,t=(0,Ao.c)()){this._key=e,this._storage=t,this._entry=null,this._timestamp=0}updateValue(e,t){this._entry={position:e,value:t},this.save()}readValue(){return this.load(),this._entry}clear(){this._entry=null,this.save()}timestamp(){return this._timestamp}_storageKey(){return`grist-last-edit-${this._key}`}load(){const e=this._storage.getItem(this._storageKey());if(this._entry=null,this._timestamp=0,e)try{const{entry:t,timestamp:o}=JSON.parse(e);if(void 0===t||"number"!=typeof o)return void console.error("[EditMemory] Data in local storage has a different structure");this._entry=t,this._timestamp=o}catch(e){console.error("[EditMemory] Can't deserialize date from local storage")}}save(){const e=this._storage;if(this._entry)try{this._timestamp=Date.now();const t={timestamp:this._timestamp,entry:this._entry};e.setItem(this._storageKey(),JSON.stringify(t))}catch(e){console.error("Can't save current edited cell state. Error message: "+(null==e?void 0:e.message))}else e.removeItem(this._storageKey())}}var ds=o(442),us=o(20742);const hs=o(66287),ps=o(79462),ms={"\n":"\\n","\r":"\\r","\t":"\\t"},gs=ps(ms);function fs(e,t,o,i,n){const l=t.filter((e=>e.visible)),a=new Map(l.map((t=>[t.name,r.Observable.create(e,o[t.name])])));return[ws(l.map((t=>bs(vs(t.label),function(e,t,o){if("boolean"===t)return(0,be.n2)(o);{const t=r.Computed.create(e,(e=>function(e){return e.replace(/[\n\r\t]/g,(e=>ms[e]))}(String(e(o)||"")))).onWrite((e=>o.set(function(e){return e.replace(/\\[nrt]/g,(e=>gs[e]))}(e))));return _s(t,{onInput:!0},r.dom.on("focus",((e,t)=>t.select())))}}(e,t.type,a.get(t.name)),(0,s.testId)("parseopts-opt"))))),(0,us.cssModalButtons)(r.dom.domComputed((e=>l.every((t=>e(a.get(t.name))===o[t.name]))),(e=>e?(0,we.bigBasicButton)("Back to preview",r.dom.on("click",n),(0,s.testId)("parseopts-back")):(0,we.bigPrimaryButton)("Update preview",r.dom.on("click",(()=>i(hs(l.map((e=>[e.name,a.get(e.name).get()])))))),(0,s.testId)("parseopts-update")))))]}const ws=(0,r.styled)("div","\n  display: flex;\n  flex-wrap: wrap;\n  justify-content: space-between;\n  padding: 16px 0;\n  width: 400px;\n  overflow-y: auto;\n"),bs=(0,r.styled)("div","\n  flex: none;\n  margin: 8px 0;\n  width: calc(50% - 16px);\n  font-weight: initial;   /* negate bootstrap */\n"),vs=(0,r.styled)("div","\n  margin-bottom: 8px;\n"),_s=(0,r.styled)(r.input,`\n  color: ${s.theme.inputFg};\n  background-color: ${s.theme.inputBg};\n  position: relative;\n  display: inline-block;\n  outline: none;\n  height: 28px;\n  border: 1px solid ${s.theme.inputBorder};\n  border-radius: 3px;\n  padding: 0 6px;\n  width: 100%;\n\n  &::placeholder {\n    color: ${s.theme.inputPlaceholderFg};\n  }\n`);var ys=o(4491),xs=o(29813),Ss=o(56634),Cs=o(38109),Is=o(85050),Rs=o(86391),Ds=o(99002),Ts=o(20354),ks=o(1464),Ms=Object.defineProperty,Ps=Object.defineProperties,As=Object.getOwnPropertyDescriptors,Os=Object.getOwnPropertySymbols,Fs=Object.prototype.hasOwnProperty,Es=Object.prototype.propertyIsEnumerable,Bs=(e,t,o)=>t in e?Ms(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Ls=(e,t)=>{for(var o in t||(t={}))Fs.call(t,o)&&Bs(e,o,t[o]);if(Os)for(var o of Os(t))Es.call(t,o)&&Bs(e,o,t[o]);return e},$s=(e,t)=>Ps(e,As(t));const Us=o(88466),zs=(0,q.makeT)("Importer");class Vs extends Do.G{constructor(e,t,o){super(),this._gristDoc=e,this._importSourceElem=t,this._createPreview=o,this._docComm=this._gristDoc.docComm,this._mergeOptions={},this._parseOptions=r.Observable.create(this,{}),this._sourceInfoArray=r.Observable.create(this,[]),this._sourceInfoSelected=r.Observable.create(this,null),this._formulaEditorHolder=r.Holder.create(this),this._previewViewSection=r.Computed.create(this,this._sourceInfoSelected,((e,t)=>{if(!t)return null;if(e(t.isLoadingSection))return null;const o=e(t.transformSection);return o&&!e(o._isDeleted)?o:null})),this._isLoadingDiff=r.Observable.create(this,!1),this._lastGenImportDiffPromise=null,this._debouncedUpdateDiff=Us(this._updateDiff,1e3,{leading:!0,trailing:!0}),this._hasScheduledDiffUpdate=!1,this._destTables=r.Computed.create(this,(e=>[{value:null,label:"New Table"},...e(this._sourceInfoArray).length>1?[{value:"",label:"Skip"}]:[],...e(this._gristDoc.docModel.visibleTableIds.getObservable()).map((e=>({value:e,label:e})))])),this._sourceColLabelsById=r.Computed.create(this,this._sourceInfoSelected,((e,t)=>{if(!t||e(t.sourceSection._isDeleted))return null;const o=e(e(t.sourceSection.viewFields).getObservable());return new Map(o.map((t=>[e(e(t.column).colId),e(e(t.column).label)])))})),this._transformSectionCols=r.Computed.create(this,this._sourceInfoSelected,((e,t)=>{if(!t)return null;const o=e(t.transformSection);return!o||e(o._isDeleted)?null:e(e(o.viewFields).getObservable()).map((t=>e(t.column)))})),this._unmatchedFields=r.Computed.create(this,this._transformSectionCols,((e,t)=>t?t.filter((t=>""===e(t.formula).trim())).map((e=>e.label())):null)),this._screen=ys.F.create(this,(null==t?void 0:t.importSource.label)||"Import from file"),this.onDispose((()=>{this._resetImportDiffState()}))}static async selectAndImport(e,t,o,s){let i=null;if(!o){const t=await(0,Rs.y)({multiple:!0});await e.forkIfNeeded();const o=t.map((e=>e.name)).join(", "),s=t.reduce(((e,t)=>e+t.size),0),n=e.app.topAppModel.appObs.get(),r=n?n.notifier.createProgressIndicator(o,(0,J.byteString)(s)):null,l=e=>r&&r.setProgress(e);try{l(0),i=await(0,Ss.IL)(t,{docWorkerUrl:e.docComm.docWorkerUrl,sizeLimit:"import"},l),l(100)}finally{r&&r.dispose()}}try{await Vs.create(null,e,o,s).pickAndUploadSource(i)}catch(n){if(n instanceof Ns){const r=t.find((e=>"builtIn/gdrive"===e.plugin.definition.id&&e!==o));if(r)try{await Vs.create(null,e,r,s).pickAndUploadSource(i)}catch(e){(0,Cs.eK)(e)}else(0,Cs.eK)(n)}else(0,Cs.eK)(n)}}async pickAndUploadSource(e){try{if(this._importSourceElem){const t=this._importSourceElem.plugin,o=this._screen.renderPlugin(t),s=await this._importSourceElem.importSourceStub.getImportSource(o);if(t.removeRenderTarget(o),this._screen.renderSpinner(),s){const t=s.item;if("fileList"===t.kind){const o=t.files.map((({content:e,name:t})=>new File([e],t)));e=await(0,Ss.IL)(o,{docWorkerUrl:this._docComm.docWorkerUrl,sizeLimit:"import"})}else{if("url"!==t.kind)throw new Error(`Import source of kind ${t.kind} are not yet supported!`);e=(0,Ss.c5)(t.url)?await this._fetchFromDrive(t.url):await(0,Ss.QK)(this._docComm,t.url)}}}else e=e||await(0,Ss.lX)({docWorkerUrl:this._docComm.docWorkerUrl,multiple:!0,sizeLimit:"import"})}catch(e){if(e instanceof Ws)return void await this._cancelImport();if(e instanceof Ns)throw await this._cancelImport(),e;return void this._screen.renderError(e.message)}e?(this._uploadResult=e,await this._reImport(e)):await this._cancelImport()}_getPrimaryViewSection(e){return this._gristDoc.getTableModel(e).tableMetaRow.primaryView.peek().viewSections.peek().peek()[0]}_getSectionByRef(e){return this._gristDoc.docModel.viewSections.getRowModel(e)}async _updateTransformSection(e){this._resetImportDiffState(),e.isLoadingSection.set(!0),e.transformSection.set(null);const t=this._gristDoc.docData.sendAction(["GenImporterView",e.hiddenTableId,e.destTableId.get(),null]);e.lastGenImporterViewPromise=t;const o=await t;this.isDisposed()||e.lastGenImporterViewPromise!==t||(e.transformSection.set(this._gristDoc.docModel.viewSections.getRowModel(o)),e.isLoadingSection.set(!1),this._gristDoc.viewModel.activeSectionId(o))}_getTransformedDataSource(e){const t=e.files.map(((e,t)=>this._createTransformRuleMap(t)));return{uploadId:e.uploadId,transforms:t}}_getMergeOptionMaps(e){return e.files.map(((e,t)=>this._createMergeOptionsMap(t)))}_createTransformRuleMap(e){const t={};for(const o of this._sourceInfoArray.get())o.uploadFileIndex===e&&(t[o.origTableName]=this._createTransformRule(o));return t}_createMergeOptionsMap(e){const t={};for(const o of this._sourceInfoArray.get())o.uploadFileIndex===e&&(t[o.origTableName]=this._getMergeOptionsForSource(o));return t}_createTransformRule(e){const t=e.transformSection.get();if(!t)throw new Error(`Table ${e.hiddenTableId} is missing transform section`);const o=t.viewFields().peek(),s=e.sourceSection.viewFields().peek(),i=e.destTableId.get();return{destTableId:i,destCols:o.map((e=>({label:e.label(),colId:i?e.colId():null,type:e.column().type(),widgetOptions:e.column().widgetOptions(),formula:e.column().formula()}))),sourceCols:s.map((e=>e.colId()))}}_getMergeOptionsForSource(e){const t=this._mergeOptions[e.hiddenTableId];if(!t)return;const{updateExistingRecords:o,mergeCols:s,mergeStrategy:i}=t;return{mergeCols:o.get()?s.get():[],mergeStrategy:i.get()}}_getHiddenTableIds(){return this._sourceInfoArray.get().map((e=>e.hiddenTableId))}async _reImport(e){this._screen.renderSpinner(),this._resetImportDiffState();try{const t=$s(Ls({},this._parseOptions.get()),{NUM_ROWS:0}),o=await this._docComm.importFiles(this._getTransformedDataSource(e),t,this._getHiddenTableIds());if(this._parseOptions.set(o.options),this._sourceInfoArray.set(o.tables.map((e=>{var t;return{hiddenTableId:e.hiddenTableId,uploadFileIndex:e.uploadFileIndex,origTableName:e.origTableName,sourceSection:this._getPrimaryViewSection(e.hiddenTableId),transformSection:r.Observable.create(null,this._getSectionByRef(e.transformSectionRef)),destTableId:r.Observable.create(null,null!=(t=e.destTableId)?t:null),isLoadingSection:r.Observable.create(null,!1),lastGenImporterViewPromise:null}}))),0===this._sourceInfoArray.get().length)throw new Error("No data was imported");this._mergeOptions={},this._getHiddenTableIds().forEach((e=>{this._mergeOptions[e]={updateExistingRecords:r.Observable.create(null,!1),mergeCols:(0,r.obsArray)(),mergeStrategy:r.Observable.create(null,{type:"replace-with-nonblank-source"}),hasInvalidMergeCols:r.Observable.create(null,!1)}})),this._sourceInfoSelected.set(this._sourceInfoArray.get()[0]||null),this._renderMain(e)}catch(e){console.warn("Import failed",e),this._screen.renderError(e.message)}}async _maybeFinishImport(e){var t;if(!this._validateImportConfiguration())return;this._screen.renderSpinner(),this._resetImportDiffState();const o=$s(Ls({},this._parseOptions.get()),{NUM_ROWS:0}),s=this._getMergeOptionMaps(e),i=await this._docComm.finishImportFiles(this._getTransformedDataSource(e),this._getHiddenTableIds(),{mergeOptionMaps:s,parseOptions:o});if(null==(t=i.tables[0])?void 0:t.hiddenTableId){const e=this._gristDoc.docModel.dataTables[i.tables[0].hiddenTableId].tableMetaRow;await this._gristDoc.openDocPage(e.primaryViewId())}this._screen.close(),this.dispose()}async _cancelImport(){this._resetImportDiffState(),this._formulaEditorHolder.dispose(),this._uploadResult&&await this._docComm.cancelImportFiles(this._uploadResult.uploadId,this._getHiddenTableIds()),this._screen.close(),this.dispose()}_resetTableMergeOptions(e){var t;null==(t=this._mergeOptions[e])||t.mergeCols.set([])}_validateImportConfiguration(){let e=!0;const t=this._sourceInfoSelected.get();if(!t)return e;const o=this._mergeOptions[t.hiddenTableId];if(!o)return e;const s=t.destTableId.get(),{updateExistingRecords:i,mergeCols:n,hasInvalidMergeCols:r}=o;return null!==s&&i.get()&&0===n.get().length&&(r.set(!0),e=!1),e}_buildModalTitle(e){const t=this._importSourceElem?this._importSourceElem.importSource.label:"Import from file";return Ks((0,us.cssModalTitle)(t),e)}async _updateImportDiff(e){const{updateExistingRecords:t,mergeCols:o}=this._mergeOptions[e.hiddenTableId],s=e.destTableId&&t.get()&&o.get().length>0;!s&&this._gristDoc.comparison&&(this._isLoadingDiff.set(!0),this._gristDoc.comparison=null,this._isLoadingDiff.set(!1)),s&&(this._hasScheduledDiffUpdate=!0,this._isLoadingDiff.set(!0),await this._debouncedUpdateDiff(e))}async _updateDiff(e){this._hasScheduledDiffUpdate=!1;const t=this._docComm.generateImportDiff(e.hiddenTableId,this._createTransformRule(e),this._getMergeOptionsForSource(e));this._lastGenImportDiffPromise=t;const o=await t;this.isDisposed()||t!==this._lastGenImportDiffPromise||(this._gristDoc.comparison=o,this._hasScheduledDiffUpdate||this._isLoadingDiff.set(!1))}_resetImportDiffState(){this._cancelPendingDiffRequests(),this._gristDoc.comparison=null}_cancelPendingDiffRequests(){this._debouncedUpdateDiff.cancel(),this._lastGenImportDiffPromise=null,this._hasScheduledDiffUpdate=!1,this._isLoadingDiff.set(!1)}_renderMain(e){const t=this._parseOptions.get().SCHEMA,o=js(r.dom.autoDispose(this._formulaEditorHolder),{tabIndex:"-1"},this._buildModalTitle(t?Hs(Gs("Settings"),"Import options",(0,s.testId)("importer-options-link"),r.dom.on("click",(()=>this._renderParseOptions(t,e)))):null),Js(Xs(r.dom.forEach(this._sourceInfoArray,(t=>{const o=r.Computed.create(null,(e=>e(t.destTableId))).onWrite((async e=>{(t===this._sourceInfoSelected.get()||this._validateImportConfiguration())&&(t.destTableId.set(e),this._resetTableMergeOptions(t.hiddenTableId),""!==e&&await this._updateTransformSection(t))}));return Ys(r.dom.autoDispose(o),Zs(Qs("From"),ei(function(e,t){const o=t.files[e.uploadFileIndex].origName;return e.origTableName?`${e.origTableName} - ${o}`:o}(t,e),(0,s.testId)("importer-from"))),Zs(Qs("To"),(0,n.linkSelect)(o,this._destTables)),Ys.cls("-selected",(e=>e(this._sourceInfoSelected)===t)),r.dom.on("click",(async()=>{t!==this._sourceInfoSelected.get()&&this._validateImportConfiguration()&&(this._cancelPendingDiffRequests(),this._sourceInfoSelected.set(t),await this._updateImportDiff(t))})),(0,s.testId)("importer-source"))}))),r.dom.maybe(this._sourceInfoSelected,(e=>{const{mergeCols:t,updateExistingRecords:o,hasInvalidMergeCols:l}=this._mergeOptions[e.hiddenTableId];return ti(r.dom.maybe(e.destTableId,(()=>oi(r.dom.maybe(e.transformSection,(a=>{const c=o.addListener((async()=>{await this._updateImportDiff(e)}));return[ai(ci((0,be.rp)(o,zs("Update existing records"),r.dom.autoDispose(c),(0,s.testId)("importer-update-existing-records"))),r.dom.maybe(o,(()=>{var o;const i=t.addListener((async t=>{0!==t.length&&l.get()&&l.set(!1),await this._updateImportDiff(e)}));return[di(zs("Merge rows that match these fields:"),(0,s.testId)("importer-merge-fields-message")),(0,n.multiSelect)(t,null!=(o=a.viewFields().peek().map((e=>({label:e.label(),value:e.colId()}))))?o:[],{placeholder:zs("Select fields to match on"),error:l},r.dom.autoDispose(i),(0,s.testId)("importer-merge-fields-select"))]}))),r.dom.domComputed(this._unmatchedFields,(e=>e&&e.length>0?vi((0,r.dom)("div",yi(`${e.length} unmatched ${e.length>1?"fields":"field"}`)," in import:"),_i(e.join(", ")),(0,s.testId)("importer-unmatched-fields")):null)),ui(r.dom.forEach((0,r.fromKo)(a.viewFields().getObservable()),(t=>hi(mi("ImportArrow"),fi(gi(wi(r.dom.text(t.label)),bi((0,i.icon)("Dots"),(0,n.menu)((()=>{const o=t.origCol().id(),i=[...this._sourceColLabelsById.get().entries()];return[(0,n.menuItem)((async()=>{await this._gristDoc.clearColumns([o],{keepType:!0}),await this._updateImportDiff(e)}),"Skip",(0,s.testId)("importer-column-match-menu-item")),(0,n.menuDivider)(),...i.map((([t,i])=>(0,n.menuItem)((async()=>{await this._setColumnFormula(o,"$"+t),await this._updateImportDiff(e)}),i,(0,s.testId)("importer-column-match-menu-item")))),(0,s.testId)("importer-column-match-menu")]}),{placement:"right-start"}),(0,s.testId)("importer-column-match-destination-settings")),(0,s.testId)("importer-column-match-destination")),r.dom.domComputed((o=>r.dom.create(this._buildColMappingFormula.bind(this),o(t.column),(o=>this._activateFormulaEditor(o,t,(()=>this._updateImportDiff(e)))),"Skip"))),(0,s.testId)("importer-column-match-source-destination"))))),(0,s.testId)("importer-column-match-options"))]}))))),si(qs("Preview"),r.dom.domComputed((t=>{const o=t(this._previewViewSection);if(t(this._isLoadingDiff)||!o)return ni((0,Ds.M)(),(0,s.testId)("importer-preview-spinner"));const i=this._createPreview(o);return li(r.dom.maybe((t=>""===t(e.destTableId)),(()=>ri((0,s.testId)("importer-preview-overlay")))),r.dom.autoDispose(i),i.viewPane,(0,s.testId)("importer-preview"))}))))}))),(0,us.cssModalButtons)((0,we.bigPrimaryButton)("Import",r.dom.on("click",(()=>this._maybeFinishImport(e))),r.dom.boolAttr("disabled",(e=>null===e(this._previewViewSection)||e(this._sourceInfoArray).every((t=>""===e(t.destTableId))))),(0,s.testId)("modal-confirm")),(0,we.bigBasicButton)("Cancel",r.dom.on("click",(()=>this._cancelImport())),(0,s.testId)("modal-cancel"))));this._addFocusLayer(o),this._screen.render(o,{fullscreen:!0})}_addFocusLayer(e){r.dom.autoDisposeElem(e,new xs.FocusLayer({defaultFocusElem:e,allowFocus:e=>e!==document.body,onDefaultFocus:()=>this.trigger("importer_focus")}))}async _setColumnFormula(e,t){return this._gristDoc.docModel.columns.sendTableAction(["UpdateRecord",e,{formula:t,isFormula:!0}])}_activateFormulaEditor(e,t,o){const s=this._gristDoc.viewModel.activeSection().viewInstance(),i=null==s?void 0:s.moveEditRowToCursor(),n=(0,Ts.Ex)({gristDoc:this._gristDoc,column:t.column(),editingFormula:t.editingFormula,refElem:e,editRow:i,setupCleanup:this._setupFormulaEditorCleanup.bind(this),onSave:async(e,t)=>{t!==e.formula.peek()&&(await e.updateColValues({formula:t}),await o())}});this._formulaEditorHolder.autoDispose(n)}_setupFormulaEditorCleanup(e,t,o,s){const i=()=>s().catch(Cs.eK);this.on("importer_focus",i),e.onDispose((()=>{this.off("importer_focus",i),o(!1)}))}_buildColMappingFormula(e,t,o,i){const n=e=>{const t=this._sourceColLabelsById.get();return t&&(e=e.trim()).startsWith("$")&&t.has(e.slice(1))?t.get(e.slice(1)):e};return pi((e=>n(e(t.formula))),{placeholder:i,maxLines:1},r.dom.cls("disabled"),{tabIndex:"-1"},r.dom.on("focus",((e,t)=>o(t))),(0,s.testId)("importer-column-match-formula"))}_renderParseOptions(e,t){this._screen.render([this._buildModalTitle(),r.dom.create(fs,e,this._parseOptions.get(),(e=>{this._parseOptions.set(e),this._reImport(t).catch((e=>(0,Cs.eK)(e)))}),(()=>{this._renderMain(t)}))])}async _fetchFromDrive(e){try{return await(0,Ss.QK)(this._docComm,e)}catch(t){if((0,ks.F0)()){const o={};try{const e=await(0,ks.X3)(this);o.googleAuthorizationCode=e}catch(o){throw(null==o?void 0:o.message)===ks.au?new Ns(e):(null==o?void 0:o.message)===ks.dw?new Ws:t}return await(0,Ss.QK)(this._docComm,e,o)}throw new Ns(e)}}}class Ns extends Error{constructor(e){super(`This url ${e} is not supported`),this.url=e}}class Ws extends Error{}const js=(0,r.styled)("div","\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  outline: unset;\n"),Hs=(0,r.styled)("div",`\n  display: inline-flex;\n  align-items: center;\n  cursor: pointer;\n  color: ${s.theme.controlFg};\n  --icon-color: ${s.theme.controlFg};\n  &:hover {\n    color: ${s.theme.controlHoverFg};\n    --icon-color: ${s.theme.controlHoverFg};\n  }\n`),Gs=(0,r.styled)(i.icon,"\n  flex: none;\n  margin-right: 4px;\n"),Ks=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 16px;\n  & > .${us.cssModalTitle.className} {\n    margin-bottom: 0px;\n  }\n`),Js=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex-grow: 1;\n  overflow-y: auto;\n"),qs=(0,r.styled)("div",`\n  margin-bottom: 8px;\n  color: ${s.theme.lightText};\n  text-transform: uppercase;\n  font-weight: 500;\n  font-size: ${s.vars.xsmallFontSize};\n  letter-spacing: 1px;\n`),Xs=(0,r.styled)("div","\n  max-height: 50%;\n  column-gap: 32px;\n  display: flex;\n  flex-flow: row wrap;\n  margin-bottom: 16px;\n  align-items: flex-start;\n  overflow-y: auto;\n"),Ys=(0,r.styled)("div",`\n  padding: 4px 8px;\n  margin: 4px 0px;\n  width: 300px;\n  border-radius: 3px;\n  border: 1px solid ${s.theme.importerTableInfoBorder};\n  &:hover, &-selected {\n    background-color: ${s.theme.hover};\n  }\n`),Zs=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  margin: 4px 0;\n"),Qs=(0,r.styled)("span",`\n  flex: none;\n  margin-right: 8px;\n  color: ${s.theme.lightText};\n  text-transform: uppercase;\n  font-weight: 500;\n  font-size: ${s.vars.xsmallFontSize};\n  letter-spacing: 1px;\n  width: 40px;\n  text-align: right;\n`),ei=(0,r.styled)("div","\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n"),ti=(0,r.styled)("div","\n  display: flex;\n  gap: 32px;\n  flex-grow: 1;\n  height: 0px;\n"),oi=(0,r.styled)("div","\n  width: 300px;\n  padding-right: 8px;\n  display: flex;\n  flex-direction: column;\n  overflow-y: auto;\n"),si=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex-grow: 1;\n"),ii=(0,r.styled)("div","\n  display: flex;\n  flex-grow: 1;\n"),ni=(0,r.styled)(ii,"\n  align-items: center;\n  justify-content: center;\n"),ri=(0,r.styled)("div",`\n  position: absolute;\n  top: 0px;\n  left: 0px;\n  height: 100%;\n  width: 100%;\n  z-index: 10;\n  background: ${s.theme.importerSkippedTableOverlay};\n`),li=(0,r.styled)(ii,`\n  border: 1px solid ${s.theme.importerPreviewBorder};\n  position: relative;\n`),ai=(0,r.styled)("div","\n  margin-bottom: 16px;\n"),ci=(0,r.styled)("div","\n  margin-bottom: 8px;\n"),di=(0,r.styled)("div",`\n  color: ${s.theme.lightText};\n  margin-bottom: 8px;\n`),ui=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  gap: 20px;\n"),hi=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n"),pi=(0,r.styled)(Is.L,`\n  flex: auto;\n  cursor: pointer;\n  margin-top: 1px;\n  padding-left: 4px;\n  --icon-color: ${s.theme.accentIcon};\n`),mi=(0,r.styled)(i.icon,`\n  flex-shrink: 0;\n  width: 20px;\n  height: 32px;\n  background-color: ${s.theme.importerMatchIcon};\n  margin-right: 4px;\n`),gi=(0,r.styled)("div","\n  align-items: center;\n  display: flex;\n"),fi=(0,r.styled)("div","\n  min-width: 0;\n  display: flex;\n  flex-direction: column;\n  flex-grow: 1;\n"),wi=(0,r.styled)("div","\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  padding-left: 4px;\n"),bi=(0,r.styled)("div",`\n  flex: none;\n  margin: 0 4px 0 auto;\n  height: 24px;\n  width: 24px;\n  padding: 4px;\n  line-height: 0px;\n  border-radius: 3px;\n  cursor: pointer;\n  --icon-color: ${s.theme.lightText};\n\n  &:hover, &.weasel-popup-open {\n    background-color: ${s.theme.hover};\n  }\n`),vi=(0,r.styled)("div","\n  margin-bottom: 16px;\n"),_i=(0,r.styled)("div",`\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n  padding-right: 16px;\n  color: ${s.theme.lightText};\n`),yi=(0,r.styled)("span",`\n  color: ${s.theme.accentText};\n`);var xi=o(61217),Si=o(80864),Ci=o(36524),Ii=o(37540),Ri=o(7740);const Di=(0,q.makeT)("DuplicateTable"),Ti=(0,r.makeTestId)("test-duplicate-table-");class ki extends r.Disposable{constructor(e,t){super(),this._gristDoc=e,this._tableId=t,this._newTableName=r.Observable.create(this,""),this._includeData=r.Observable.create(this,!1),this._saveDisabled=r.Computed.create(this,this._newTableName,((e,t)=>!t.trim()))}get saveDisabled(){return this._saveDisabled}save(){return this._duplicateTable()}buildDom(){return[(0,Ri.$S)((0,r.input)(this._newTableName,{onInput:!0},{placeholder:Di("Name for new table")},(e=>{setTimeout((()=>{e.focus()}),20)}),r.dom.on("focus",((e,t)=>{t.select()})),r.dom.cls(Ii.g.className),Ti("name"))),Pi(Ai("Warning"),(0,r.dom)("div",Di("Instead of duplicating tables, it's usually better to segment data using linked views. {{link}}",{link:(0,Zo.Y3)({href:Oo.PH.helpLinkingWidgets,target:"_blank"},"Read More.")}))),(0,Ri.$S)(Mi(this._includeData,Di("Copy all data in addition to the table structure."),Ti("copy-all-data"))),r.dom.maybe(this._includeData,(()=>Pi(Ai("Warning"),(0,r.dom)("div",Di("Only the document default access rules will apply to the copy.")),Ti("acl-warning"))))]}_duplicateTable(){const{docData:e}=this._gristDoc,[t,o]=[this._newTableName.get(),this._includeData.get()];return e.sendAction(["DuplicateTable",this._tableId,t,o])}}const Mi=(0,r.styled)(be.rp,"\n  margin-top: 8px;\n"),Pi=(0,r.styled)("div","\n  display: flex;\n  column-gap: 8px;\n"),Ai=(0,r.styled)(i.icon,`\n  --icon-color: ${s.colors.orange};\n  flex-shrink: 0;\n`);var Oi=o(21467);const Fi=(0,r.makeTestId)("test-widget-title-"),Ei=(0,q.makeT)("WidgetTitle");function Bi(e,t,o,...s){return $i(Ui(Fi("text"),r.dom.text(t),Ui.cls("-empty",(e=>{var o;return!(null==(o=e(t))?void 0:o.trim())})),(t=>{(0,Oi.setPopupToCreateDom)(t,(t=>function(e,t,o){var s;const i=t.table.peek(),l=Boolean(i.summarySourceTable.peek()),a=[i.tableNameDef.peek(),i.groupDesc.peek()].filter((e=>Boolean(null==e?void 0:e.trim()))).join(" "),c=r.Observable.create(e,a),d=r.Observable.create(e,null!=(s=t.title.peek())?s:""),u=t.title.peek()?t.defaultWidgetTitle.peek():Ei("Override widget title"),h=r.Computed.create(e,(e=>{var o,s,i,n;const r=null!=(s=null==(o=e(c))?void 0:o.trim())?s:"",l=null!=(n=null==(i=e(d))?void 0:i.trim())?n:"";return!r||r===a&&l===e(t.title)})),p=us.ModalControl.create(e,(()=>e.close())),m=async()=>{l||c.get().trim()&&c.get()!==i.tableNameDef.peek()&&await i.tableNameDef.saveOnly(c.get())},g=async()=>{var e,o;const s=null!=(o=null==(e=d.get())?void 0:e.trim())?o:"";s!==t.title.peek()&&await t.title.saveOnly(s)},f=p.doWork((()=>Promise.all([m(),g()])),{close:!0});function w(){const e=!v,o=!t.title.peek();var s;null==(s=l?v:e||o?b:v)||s.focus(),null==s||s.select()}let b,v;return zi((t=>{xs.FocusLayer.create(e,{defaultFocusElem:t,pauseMousetrap:!0})}),Fi("popup"),r.dom.cls(n.menuCssClass),r.dom.maybe(!o.tableNameHidden,(()=>[Vi(Ei("DATA TABLE NAME")),b=ji(c,Li,{disabled:l,placeholder:Ei("Provide a table name")},Fi("table-name-input"))])),r.dom.maybe(!o.widgetNameHidden,(()=>[Vi(Ei("WIDGET TITLE")),v=ji(d,Li,{placeholder:u},Fi("section-name-input"))])),Ni((0,we.primaryButton)(Ei("Save"),r.dom.on("click",f),r.dom.boolAttr("disabled",(e=>e(h)||e(p.workInProgress))),Fi("save")),(0,we.basicButton)(Ei("Cancel"),Fi("cancel"),r.dom.on("click",(()=>p.close())))),r.dom.onKeyDown({Escape:()=>p.close(),Enter:()=>h.get()?p.close():f()}),(e=>{setTimeout(w,0)}))}(t,e,o)),{placement:"bottom-start",trigger:["click"],attach:"body",boundaries:"viewport"})}),r.dom.on("click",(e=>{e.stopPropagation(),e.preventDefault()}))),...s)}const Li={onInput:!0},$i=(0,r.styled)("div","\n  flex: 1 1 0px;\n  min-width: 0px;\n  display: flex;\n"),Ui=(0,r.styled)("div",`\n  cursor: pointer;\n  overflow: hidden;\n  border-radius: 3px;\n  margin: -4px;\n  padding: 4px;\n  text-overflow: ellipsis;\n  align-self: start;\n  &:hover {\n    background-color: ${s.theme.hover};\n  }\n  &-empty {\n    min-width: 48px;\n    min-height: 23px;\n  }\n`),zi=(0,r.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  min-width: 280px;\n  padding: 16px;\n  background-color: ${s.theme.popupBg};\n  border-radius: 2px;\n  outline: none;\n`),Vi=(0,r.styled)("label",`\n  color: ${s.theme.text};\n  font-size: ${s.vars.xsmallFontSize};\n  font-weight: ${s.vars.bigControlTextWeight};\n  margin: 0 0 8px 0;\n  &:not(:first-child) {\n    margin-top: 16px;\n  }\n`),Ni=(0,r.styled)("div",`\n  display: flex;\n  margin-top: 16px;\n  & > .${we.cssButton.className}:not(:first-child) {\n    margin-left: 8px;\n  }\n`),Wi=(0,r.styled)("div","\n  position: relative;\n  display: flex;\n  flex-direction: column;\n"),ji=(0,r.styled)(((e,t,...o)=>(0,r.input)(e,t,ve.cssTextInput.cls(""),...o)),`\n  text-overflow: ellipsis;\n  color: ${s.theme.inputFg};\n  background-color: transparent;\n  &:disabled {\n    color: ${s.theme.inputDisabledFg};\n    background-color: ${s.theme.inputDisabledBg};\n    pointer-events: none;\n  }\n  &::placeholder {\n    color: ${s.theme.inputPlaceholderFg};\n  }\n  .${Wi.className} > &:disabled {\n    padding-right: 28px;\n  }\n`),Hi=(0,r.makeTestId)("test-raw-data-"),Gi=(0,q.makeT)("DataTables");class Ki extends r.Disposable{constructor(e){super(),this._gristDoc=e,this._rowCount=r.Computed.create(this,this._gristDoc.docPageModel.currentDocUsage,((e,t)=>null==t?void 0:t.rowCount)),this._rowCountFormatter=new Intl.NumberFormat("en-US"),this._tables=r.Computed.create(this,(t=>[...t(e.docModel.rawDataTables.getObservable()),...t(e.docModel.rawSummaryTables.getObservable())].filter((e=>Boolean(t(e.tableId))))))}buildDom(){return Ji(pn(Hi("list"),qi(Gi("Raw Data Tables")),Xi(r.dom.forEach(this._tables,(e=>Yi(Hi("table"),Zi(r.dom.domComputed((t=>sn(0!==t(e.summarySourceTable)?"PivotLight":"TypeTable",Hi(`table-id-${t(e.tableId)}`))))),Qi(en(un(this._tableTitle(e),Hi("table-title"))),tn(rn(an(hn("Table ID: "),cn(Hi("table-id"),r.dom.text(e.tableId)),{title:Gi("Click to copy")},r.dom.on("click",(async(t,o)=>{t.stopImmediatePropagation(),t.preventDefault(),(0,Yo.showTransientTooltip)(o,Gi("Table ID copied to clipboard"),{key:"copy-table-id"}),await(0,xi.copyToClipboard)(e.tableId.peek()),(0,Si.setTestState)({clipboard:e.tableId.peek()})})))),this._tableRows(e))),on((0,Ci.f)(Hi("table-menu"),(0,i.icon)("Dots"),(0,n.menu)((()=>this._menuItems(e)),{placement:"bottom-start"}),r.dom.on("click",(e=>{e.stopPropagation(),e.preventDefault()})))),r.dom.on("click",(()=>{const t=e.rawViewSection.peek().getRowId();if(!t)throw new Error(`Table ${e.tableId.peek()} doesn't have a raw view section.`);this._gristDoc.viewModel.activeSectionId(t)}))))))))}_tableTitle(e){return r.dom.domComputed((t=>{const o=t((0,r.fromKo)(e.rawViewSectionRef)),s=0!==t(e.summarySourceTable);if(!o||s){const o=[t(e.tableNameDef),s?t(e.groupDesc):""].filter((e=>Boolean(null==e?void 0:e.trim()))).join(" ");return gn(o)}return(0,r.dom)("div",r.dom.domComputed((0,r.fromKo)(e.rawViewSection),(e=>function(e,...t){const o=r.Computed.create(null,(t=>t(t(e.table).tableNameDef)));return Bi(e,o,{widgetNameHidden:!0},r.dom.autoDispose(o),...t)}(e,Hi("widget-title")))))}))}_menuItems(e){const{isReadonly:t,docModel:o}=this._gristDoc;return[(0,n.menuItem)((()=>this._duplicateTable(e)),Gi("Duplicate Table"),Hi("menu-duplicate-table"),r.dom.cls("disabled",(o=>o(t)||o(e.isHidden)||0!==o(e.summarySourceTable)))),(0,n.menuItem)((()=>this._removeTable(e)),"Remove",Hi("menu-remove"),r.dom.cls("disabled",(s=>s(t)||s(o.visibleTables.getObservable()).length<=1&&!s(e.isHidden)))),r.dom.maybe(t,(()=>(0,n.menuText)(Gi("You do not have edit access to this document"))))]}_duplicateTable(e){!function(e,t,{onSuccess:o}={}){(0,us.saveModal)(((s,i)=>{const n=ki.create(i,e,t);return{title:"Duplicate Table",body:n.buildDom(),saveFunc:async()=>{const e=await n.save();null==o||o(e)},saveDisabled:n.saveDisabled,width:"normal"}}))}(this._gristDoc,e.tableId(),{onSuccess:({raw_section_id:e})=>this._gristDoc.viewModel.activeSectionId(e)})}_removeTable(e){const{docModel:t}=this._gristDoc;(0,us.confirmModal)(Gi("Delete {{formattedTableName}} data, and remove it from all pages?",{formattedTableName:e.formattedTableName()}),"Delete",(function(){return t.docData.sendAction(["RemoveTable",e.tableId()])}))}_tableRows(e){return r.dom.maybe(this._rowCount,(t=>"hidden"===t?null:ln(hn("Rows: "),"pending"===t?mn():dn(void 0!==t[e.getRowId()]?this._rowCountFormatter.format(t[e.getRowId()]):"",Hi("table-rows")))))}}const Ji=(0,r.styled)("div","\n  overflow-y: auto;\n  position: relative;\n"),qi=(0,r.styled)(Ci.gs,"\n  display: inline-block;\n"),Xi=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n"),Yi=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  cursor: pointer;\n  border-radius: 3px;\n  width: 100%;\n  height: calc(1em * 56/13); /* 56px for 13px font */\n  max-width: 750px;\n  border: 1px solid ${s.theme.rawDataTableBorder};\n  &:hover {\n    border-color: ${s.theme.rawDataTableBorderHover};\n  }\n`),Zi=(0,r.styled)("div","\n  padding-top: 11px;\n  padding-left: 12px;\n  margin-right: 8px;\n  align-self: flex-start;\n  display: flex;\n  flex: none;\n"),Qi=(0,r.styled)("div","\n  flex-grow: 1;\n  min-width: 0px;\n  display: flex;\n  flex-wrap: wrap;\n  margin-top: 6px;\n  margin-bottom: 4px;\n"),en=(0,r.styled)("div","\n  min-width: 100%;\n  margin-right: 4px;\n"),tn=(0,r.styled)("div","\n  min-width: 100%;\n  display: flex;\n  gap: 8px;\n"),on=(0,r.styled)("div","\n  padding-right: 8px;\n  margin-left: 8px;\n  align-self: center;\n  display: flex;\n  flex: none;\n"),sn=(0,r.styled)(i.icon,`\n  --icon-color: ${s.theme.accentIcon};\n`),nn=(0,r.styled)("span","\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n"),rn=(0,r.styled)("div","\n  display: flex;\n  flex-grow: 1;\n  min-width: 0;\n"),ln=(0,r.styled)("div",`\n  display: flex;\n  flex-shrink: 0;\n  min-width: 100px;\n  overflow: hidden;\n  align-items: baseline;\n  color: ${s.theme.lightText};\n  line-height: 18px;\n  padding: 0px 2px;\n`),an=(0,r.styled)("div",`\n  display: flex;\n  overflow: hidden;\n  cursor: default;\n  align-items: baseline;\n  color: ${s.theme.lightText};\n  transition: background 0.05s;\n  padding: 0px 2px;\n  line-height: 18px;\n  &:hover {\n    background: ${s.theme.lightHover};\n  }\n`),cn=(0,r.styled)(nn,`\n  font-size: ${s.vars.smallFontSize};\n`),dn=cn,un=(0,r.styled)("div",`\n  color: ${s.theme.text};\n  white-space: nowrap;\n`),hn=(0,r.styled)("span","\n  text-transform: uppercase;\n  letter-spacing: 0.81px;\n  font-weight: 500;\n  font-size: 9px; /* xxsmallFontSize is to small */\n  margin-right: 2px;\n  flex: 0;\n  white-space: nowrap;\n"),pn=(0,r.styled)("div","\n  overflow-y: auto;\n  position: relative;\n  margin-bottom: 56px;\n"),mn=(0,r.styled)(Ds.W,"\n  --dot-size: 6px;\n"),gn=(0,r.styled)("span",`\n  color: ${s.theme.text};\n`);var fn=o(3988),wn=o(7485),bn=o(49668),vn=o(51503);const _n=(0,q.makeT)("DocumentUsage"),yn=(0,r.makeTestId)("test-doc-usage-");class xn extends r.Disposable{constructor(e){super(),this._docPageModel=e,this._currentDoc=this._docPageModel.currentDoc,this._currentDocUsage=this._docPageModel.currentDocUsage,this._currentOrg=this._docPageModel.currentOrg,this._currentProduct=this._docPageModel.currentProduct,this._rowCountFormatter=new Intl.NumberFormat("en-US"),this._dataLimitStatus=r.Computed.create(this,this._currentDocUsage,((e,t)=>{var o;return null!=(o=null==t?void 0:t.dataLimitStatus)?o:null})),this._rowCount=r.Computed.create(this,this._currentDocUsage,((e,t)=>null==t?void 0:t.rowCount)),this._dataSizeBytes=r.Computed.create(this,this._currentDocUsage,((e,t)=>null==t?void 0:t.dataSizeBytes)),this._attachmentsSizeBytes=r.Computed.create(this,this._currentDocUsage,((e,t)=>null==t?void 0:t.attachmentsSizeBytes)),this._rowMetricOptions=r.Computed.create(this,this._currentProduct,this._rowCount,((e,t,o)=>{const s=null==t?void 0:t.features.baseMaxRowsPerDocument,i=s&&s>0?s:void 0;return{name:_n("Rows"),currentValue:"object"!=typeof o?void 0:o.total,maximumValue:null!=i?i:2e4,unit:"rows",shouldHideLimits:void 0===i,formatValue:e=>this._rowCountFormatter.format(e)}})),this._dataSizeMetricOptions=r.Computed.create(this,this._currentProduct,this._dataSizeBytes,((e,t,o)=>{const s=null==t?void 0:t.features.baseMaxDataSizePerDocument,i=s&&s>0?s:void 0;return{name:_n("Data Size"),currentValue:"number"!=typeof o?void 0:o,maximumValue:null!=i?i:4096e4,unit:"MB",shouldHideLimits:void 0===i,tooltipContentFunc:wn.D.dataSize,formatValue:e=>(e/1024/1e3).toFixed(2)}})),this._attachmentsSizeMetricOptions=r.Computed.create(this,this._currentProduct,this._attachmentsSizeBytes,((e,t,o)=>{const s=null==t?void 0:t.features.baseMaxAttachmentsBytesPerDocument,i=s&&s>0?s:void 0;return{name:_n("Attachments Size"),currentValue:"number"!=typeof o?void 0:o,maximumValue:null!=i?i:1073741824,unit:"GB",shouldHideLimits:void 0===i,formatValue:e=>(e/1073741824).toFixed(2)}})),this._areAllMetricsPending=r.Computed.create(this,this._currentDoc,this._rowCount,this._dataSizeBytes,this._attachmentsSizeBytes,((e,t,o,s,i)=>{const n=[o,s,i].some((e=>"pending"!==e&&void 0!==e));return!t||!n})),this._isAccessDenied=r.Computed.create(this,this._areAllMetricsPending,this._currentDoc,this._rowCount,this._dataSizeBytes,this._attachmentsSizeBytes,((e,t,o,s,i,n)=>{if(t)return null;const{access:r}=o.workspace.org,l="guests"===r||null===r,a=[s,i,n].some((e=>"hidden"===e));return l||a}))}buildDom(){return(0,r.dom)("div",On(_n("Usage"),yn("heading")),r.dom.domComputed(this._areAllMetricsPending,(e=>e?Un((0,Ds.M)(),yn("loading")):[this._buildMessage(),this._buildMetrics()])),yn("container"))}_buildMessage(){return r.dom.domComputed((e=>{const t=e(this._isAccessDenied);if(null===t)return null;if(t)return Dn(_n("Usage statistics are only available to users with full access to the document data."));const o=e(this._currentOrg),s=e(this._currentProduct),i=e(this._dataLimitStatus);return o&&i?Dn([Sn(i,null==s?void 0:s.features,{disableRawDataLink:!0}),s&&(0,bn.Vz)(s.name)?[" ",Cn((0,vn.eb)(o),"long",(()=>this._docPageModel.appModel.showUpgradeModal()))]:null]):null}))}_buildMetrics(){return r.dom.maybe((e=>!1===e(this._isAccessDenied)),(()=>En(r.dom.domComputed(this._rowMetricOptions,(e=>Rn(e,yn("rows")))),r.dom.domComputed(this._dataSizeMetricOptions,(e=>Rn(e,yn("data-size")))),r.dom.domComputed(this._attachmentsSizeMetricOptions,(e=>Rn(e,yn("attachments-size")))),yn("metrics"))))}}function Sn(e,t,o={}){const{disableRawDataLink:s=!1}=o;switch(e){case"approachingLimit":return["This document is ",s?"approaching":In("approaching")," free plan limits."];case"gracePeriod":{const e=null==t?void 0:t.gracePeriodDays;return e?["Document limits ",s?"exceeded":In("exceeded"),`. In ${e} days, this document will be read-only.`]:["Document limits ",s?"exceeded":In("exceeded"),"."]}case"deleteOnly":return["This document ",s?"exceeded":In("exceeded")," free plan limits and is now read-only, but you can delete rows."]}}function Cn(e,t,o){if(!e)return _n("Contact the site owner to upgrade the plan to raise limits.");const s=_n("start your 30-day free trial of the Pro plan.");return["short"===t?null:_n("For higher limits, "),(i="short"===t?(0,J.capitalizeFirstWord)(s):s,n=()=>o(),Fn(i,r.dom.on("click",(()=>n()))))];var i,n}function In(e){return Fn(e,(0,fn.urlState)().setLinkUrl({docPage:"data"}))}function Rn(e,...t){const{name:o,tooltipContentFunc:s}=e;return Bn(Pn(s?(0,Yo.withInfoTooltip)(An(o,yn("name")),s()):An(o,yn("name"))),function(e){const{currentValue:t,maximumValue:o,shouldHideLimits:s,unit:i,formatValue:n=(e=>e.toString())}=e;let l,a;return void 0===t?(l=0,a=0):(l=t/(o||1/0),a=Math.min(100,Math.floor(100*l))),[Ln($n({style:`width: ${a}%`},s||l<=.9?null:$n.cls("-approaching-limit"),yn("progress-fill"))),(0,r.dom)("div",void 0===t?["Loading ",zn()]:n(t)+(s||!o?"":" of "+n(o))+(i?` ${i}`:""),yn("value"))]}(e),...t)}function Dn(e){return kn(Mn("Idea"),Tn(e,yn("message-text")),yn("message"))}const Tn=(0,r.styled)("div","\n  font-weight: 500;\n"),kn=(0,r.styled)("div",`\n  color: ${s.theme.text};\n  --icon-color: ${s.theme.text};\n  display: flex;\n  gap: 16px;\n  margin-top: 16px;\n`),Mn=(0,r.styled)(i.icon,"\n  flex-shrink: 0;\n  width: 16px;\n  height: 16px;\n"),Pn=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  font-weight: 700;\n"),An=(0,r.styled)("span","\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n"),On=(0,r.styled)(Ci.gs,"\n  margin-bottom: 0px;\n"),Fn=(0,r.styled)("span","\n  cursor: pointer;\n  color: unset;\n  text-decoration: underline;\n\n  &:hover, &:focus {\n    color: unset;\n  }\n"),En=(0,r.styled)("div","\n  display: flex;\n  flex-wrap: wrap;\n  margin-top: 24px;\n  row-gap: 24px;\n  column-gap: 54px;\n"),Bn=(0,r.styled)("div",`\n  color: ${s.theme.text};\n  display: flex;\n  flex-direction: column;\n  width: 180px;\n  gap: 8px;\n\n  @media ${s.mediaXSmall} {\n    & {\n      width: 100%;\n    }\n  }\n`),Ln=(0,r.styled)("div",`\n  width: 100%;\n  height: 4px;\n  border-radius: 5px;\n  background: ${s.theme.progressBarBg};\n`),$n=(0,r.styled)(Ln,`\n  background: ${s.theme.progressBarFg};\n\n  &-approaching-limit {\n    background: ${s.theme.progressBarErrorFg};\n  }\n`),Un=(0,r.styled)("div","\n  display: flex;\n  justify-content: center;\n  margin-top: 32px;\n"),zn=(0,r.styled)(Ds.W,"\n  --dot-size: 8px;\n");var Vn=o(68498),Nn=o(28250),Wn=o(18285),jn=o(87346),Hn=o(29255),Gn=o(96682),Kn=o(59727),Jn=o(60664),qn=o(91465),Xn=o(3411),Yn=o(21376);const Zn=(0,q.makeT)("ViewLayoutMenu");var Qn=Object.defineProperty,er=Object.defineProperties,tr=Object.getOwnPropertyDescriptors,or=Object.getOwnPropertySymbols,sr=Object.prototype.hasOwnProperty,ir=Object.prototype.propertyIsEnumerable,nr=(e,t,o)=>t in e?Qn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,rr=(e,t)=>{for(var o in t||(t={}))sr.call(t,o)&&nr(e,o,t[o]);if(or)for(var o of or(t))ir.call(t,o)&&nr(e,o,t[o]);return e},lr=(e,t)=>er(e,tr(t));const ar=(0,r.makeTestId)("test-section-menu-"),cr=(0,q.makeT)("ViewSectionMenu");function dr(e,t,o){const{docModel:i,isReadonly:l}=t,a=r.Computed.create(e,(e=>Boolean(e(o.activeFilters).length))),c=r.Computed.create(e,(e=>e(o.filterSpecChanged)||!e(o.activeSortJson.isSaved)||!e(o.activeCustomOptions.isSaved))),d=()=>{(async function(e,t){await e.docData.bundleActions(cr("Update Sort&Filter settings"),(()=>Promise.all([t.activeSortJson.save(),t.saveFilters(),t.activeCustomOptions.save()])))})(i,o).catch(Cs.eK)},u=()=>function(e){e.activeSortJson.revert(),e.revertFilters(),e.activeCustomOptions.revert()}(o),h=r.Computed.create(e,(e=>!e((0,s.isNarrowScreenObs)())&&e(t.sectionInPopup)!==e(o.id)&&!e(o.isRaw)));return[fr(fr.cls("-unsaved",c),ar("wrapper"),pr(ar("sortAndFilter"),yr(ar("filter-icon"),yr.cls("-any",a),xr("Filter"),(0,Yo.hoverTooltip)("Sort and filter",{key:"sortFilterBtnTooltip"}))),r.dom.maybe(c,(()=>kr(Rr(cr("Save"),Rr.cls("-accent"),r.dom.on("click",d),(0,Yo.hoverTooltip)("Save sort & filter settings",{key:"sortFilterBtnTooltip"}),ar("small-btn-save"),r.dom.hide(l)),Dr(Tr("Revert",Tr.cls("-normal")),r.dom.on("click",u),(0,Yo.hoverTooltip)("Revert sort & filter settings",{key:"sortFilterBtnTooltip"}),ar("small-btn-revert"))))),(0,n.menu)((e=>{return[ur(o,t),(s=o,[(0,Xn.cssLabel)(cr("FILTER"),ar("heading-filter")),r.dom.create(qn.P,s,{menuOptions:{attach:null}})]),r.dom.maybe((e=>"custom"===e(o.parentKey)),(()=>function(e){const t=r.Computed.create(null,(t=>t(e.activeCustomOptions.isSaved)?"-normal":"-accent")),o=r.Computed.create(null,(t=>t(e.activeCustomOptions)?t(e.activeCustomOptions.isSaved)?cr("(customized)"):cr("(modified)"):cr("(empty)")));return[Sr(cr("Custom options"),ar("heading-widget-options")),Cr(r.dom.autoDispose(o),r.dom.autoDispose(t),r.dom.text(o),Cr.cls(t),Mr(),r.dom.maybe((t=>Boolean(t(e.activeCustomOptions))),(()=>gr(wr("Remove",ar("btn-remove-options"),r.dom.on("click",(()=>e.activeCustomOptions(null))))))),ar("custom-options"))]}(o))),r.dom.domComputed(c,(t=>[t?(0,Xn.cssSaveButtonsRow)(Ir(cr("Save"),ar("btn-save"),r.dom.on("click",(()=>{e.close(),d()})),r.dom.boolAttr("disabled",l)),(0,we.basicButton)(cr("Revert"),ar("btn-revert"),r.dom.on("click",(()=>{e.close(),u()})))):null])),r.dom.autoDispose(o.activeFilters.addListener((()=>e.update()))),r.dom.autoDispose(o.activeSortJson.subscribe((()=>e.update())))];var s}),lr(rr({},Oi.defaultMenuOptions),{placement:"bottom-end",trigger:[(e,t)=>r.dom.onMatchElem(e,".test-section-menu-sortAndFilter","click",(()=>{t.toggle()})),(e,t)=>r.dom.onMatchElem(e,".test-section-menu-small-btn-save","click",(()=>{t.close()})),(e,t)=>r.dom.onMatchElem(e,".test-section-menu-small-btn-revert","click",(()=>{t.close()}))]}))),pr(ar("viewLayout"),br(wr("Dots")),(0,n.menu)((e=>function(e,t){var o;const i=e.viewInstance.peek(),l=i.gristDoc,a=i.cursor.rowIndex.peek(),c="new"===(null!==a?i.viewData.getRowId(a):null),d=[(0,n.menuItemCmd)(Po.allCommands.deleteRecords,Zn("Delete record"),(0,s.testId)("section-delete-card"),r.dom.cls("disabled",t||c)),(0,n.menuItemCmd)(Po.allCommands.copyLink,Zn("Copy anchor link"),(0,s.testId)("section-card-link")),(0,n.menuDivider)()],u=e.view(),h="light"===(null==(o=(0,fn.urlState)().state.get().params)?void 0:o.style),p=e.table.peek().rawViewSectionRef.peek(),m=i.getAnchorLinkForSection(p);m.hash.popup=!0;const g=(0,fn.urlState)().makeUrl(m);return[r.dom.maybe((t=>["single"].includes(t(e.parentKey))),(()=>d)),r.dom.maybe((t=>!t(e.isRaw)&&!h&&!t(l.sectionInPopup)),(()=>(0,n.menuItemLink)({href:g},Zn("Show raw data"),(0,s.testId)("show-raw-data"),r.dom.on("click",(e=>{e.stopImmediatePropagation(),e.preventDefault(),(0,fn.urlState)().pushUrl(m,{replace:!0}).catch(reportError)}))))),(0,n.menuItemCmd)(Po.allCommands.printSection,Zn("Print widget"),(0,s.testId)("print-section")),(0,n.menuItemLink)({href:l.getCsvLink(),target:"_blank",download:""},Zn("Download as CSV"),(0,s.testId)("download-section")),(0,n.menuItemLink)({href:l.getXlsxActiveViewLink(),target:"_blank",download:""},Zn("Download as XLSX"),(0,s.testId)("download-section")),r.dom.maybe((t=>["detail","single"].includes(t(e.parentKey))),(()=>(0,n.menuItemCmd)(Po.allCommands.editLayout,Zn("Edit Card Layout"),r.dom.cls("disabled",t)))),r.dom.maybe(!h,(()=>[(0,n.menuDivider)(),(0,n.menuItemCmd)(Po.allCommands.viewTabOpen,Zn("Widget options"),(0,s.testId)("widget-options")),(0,n.menuItemCmd)(Po.allCommands.sortFilterTabOpen,Zn("Advanced Sort & Filter")),(0,n.menuItemCmd)(Po.allCommands.dataSelectionTabOpen,Zn("Data selection"))])),(0,n.menuDivider)(),r.dom.maybe((t=>"custom"===t(e.parentKey)&&t(e.hasCustomOptions)),(()=>(0,n.menuItemCmd)(Po.allCommands.openWidgetConfiguration,Zn("Open configuration"),(0,s.testId)("section-open-configuration")))),(0,n.menuItemCmd)(Po.allCommands.deleteSection,Zn("Delete widget"),r.dom.cls("disabled",!u.getRowId()||u.viewSections().peekLength<=1||t),(0,s.testId)("section-delete"))]}(o,l.get())),lr(rr({},Oi.defaultMenuOptions),{placement:"bottom-end"}))),r.dom.maybe(h,(()=>vr(_r("Grow"),ar("expandSection"),r.dom.on("click",(()=>Po.allCommands.maximizeActiveSection.run())),(0,Yo.hoverTooltip)("Expand section",{key:"expandSection"}))))]}function ur(e,t){return[(0,Xn.cssLabel)(cr("SORT"),ar("heading-sort")),r.dom.create(Yn.m,e,t,{menuOptions:{attach:null}})]}const hr=(0,r.styled)("div",""),pr=(0,r.styled)("div",`\n  display: flex;\n  cursor: pointer;\n  border-radius: 3px;\n  &.${hr.className} {\n    margin-top: 0px;\n    border-radius: 0px;\n  }\n  &:hover, &.weasel-popup-open {\n    background-color: ${s.theme.hover};\n  }\n`),mr=(0,r.styled)("div","\n  padding: 3px;\n  border-radius: 3px;\n  cursor: pointer;\n  user-select: none;\n"),gr=(0,r.styled)(mr,`\n  display: flex;\n  margin: -3px 0;\n  width: 22px;\n  height: 22px;\n\n  &:hover, &.weasel-popup-open {\n    background-color: ${s.theme.hover};\n  }\n  &-changed {\n    background-color: ${s.theme.accentIcon};\n  }\n  &-changed:hover, &-changed:hover.weasel-popup-open {\n    background-color: ${s.theme.controlHoverFg};\n  }\n`),fr=(0,r.styled)("div",`\n  display: flex;\n  border-radius: 3px;\n  align-items: center;\n  &-unsaved {\n    border: 1px solid ${s.theme.accentBorder};\n  }\n  & .${pr.className} {\n    border: none;\n  }\n`),wr=(0,r.styled)(i.icon,`\n  flex: none;\n  cursor: pointer;\n  background-color: ${s.theme.lightText};\n\n  .${gr.className}-changed & {\n    background-color: ${s.theme.controlPrimaryFg};\n  }\n\n  .${hr.className} & {\n    background-color: ${s.theme.controlPrimaryFg};\n  }\n\n  &-accent {\n    background-color: ${s.theme.accentIcon};\n  }\n`),br=(0,r.styled)(mr,`\n  border-radius: 0px 2px 2px 0px;\n  display: flex;\n  .${hr.className} & {\n    border-radius: 0px;\n  }\n`),vr=(0,r.styled)("div",`\n  display: flex;\n  border-radius: 3px;\n  align-items: center;\n  padding: 4px;\n  cursor: pointer;\n  &:hover, &.weasel-popup-open {\n    background-color: ${s.theme.hover};\n  }\n`),_r=(0,r.styled)(wr,"\n  height: 13px;\n  width: 13px;\n"),yr=(0,r.styled)(mr,`\n  border-radius: 2px 0px 0px 2px;\n  display: flex;\n  &-any {\n    border-radius: 2px;\n    background-color: ${s.theme.controlSecondaryFg};\n  }\n  .${fr.className}-unsaved & {\n    background-color: ${s.theme.controlPrimaryBg};\n  }\n`),xr=(0,r.styled)(wr,`\n  .${yr.className}-any & {\n    background-color: ${s.theme.controlPrimaryFg};\n  }\n  .${fr.className}-unsaved & {\n    background-color: ${s.theme.controlPrimaryFg};\n  }\n`),Sr=(0,r.styled)("div",`\n  color: ${s.theme.menuSubheaderFg};\n  font-weight: ${s.vars.bigControlTextWeight};\n  padding: 8px 24px 8px 24px;\n  cursor: default;\n`),Cr=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  padding: 0px 24px 8px 24px;\n  cursor: default;\n  white-space: nowrap;\n  &-accent {\n    color: ${s.theme.accentText};\n  }\n  &-normal {\n    color: ${s.theme.lightText};\n  }\n`),Ir=(0,r.styled)(we.primaryButton,"\n  margin-right: 8px;\n"),Rr=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  cursor: pointer;\n  font-size: ${s.vars.mediumFontSize};\n  padding: 0px 5px;\n  border-right: 1px solid ${s.theme.accentBorder};\n\n  &-accent {\n    color: ${s.theme.accentText};\n  }\n`),Dr=(0,r.styled)("div","\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  cursor: pointer;\n"),Tr=(0,r.styled)(i.icon,`\n  --icon-color: ${s.theme.accentIcon};\n  margin: 0 5px 0 5px;\n`),kr=(0,r.styled)("div","\n  padding: 0 1px 0 1px;\n  display: flex;\n  justify-content: space-between;\n  align-self: normal;\n"),Mr=(0,r.styled)("div","\n  margin: 0 auto;\n");var Pr=o(77949);const Ar={record:ds,detail:Wn,chart:Ro.ChartView,single:Wn,custom:Nn.S};class Or extends r.Disposable{constructor(e,t){super(),this._instance=r.Holder.create(this),this.onDispose((()=>t.viewInstance(null))),this.autoDispose((0,r.subscribe)((o=>{const s=o(t.table),i=function(e){const t=Ar[e];return t||console.error("ViewLayout error: requested an unsupported section type:",e),t||Ar.record}(o(t.parentKey));this._instance.clear(),s.getRowId()&&this._instance.autoDispose(i.create(e,t)),t.viewInstance(this._instance.get())})))}}class Fr extends Do.G{constructor(e,t){super(),this.gristDoc=e,this.docModel=this.gristDoc.docModel,this._freeze=!1,this._isResizing=r.Observable.create(this,!1),this.viewModel=this.docModel.views.getRowModel(t);const o=(0,Kn.$)(this,this.viewModel.viewSections());this.autoDispose((0,r.computedArray)(o,((t,o,s)=>Or.create(s,e,t)))),this.layoutSpec=this.autoDispose(mo.computed((()=>this._updateLayoutSpecWithSections(this.viewModel.layoutSpecObj()))).extend({rateLimit:0})),this._layout=this.autoDispose(jn.Layout.create(this.layoutSpec(),this._buildLeafContent.bind(this),!0)),this._sectionIds=this._layout.getAllLeafIds(),this.autoDispose(this.layoutSpec.subscribe((e=>this._freeze||this._rebuildLayout(e))));const i=this.autoDispose(new Gn.Delay);this.listenTo(this._layout,"layoutUserEditStop",(()=>{this._isResizing.set(!1),i.schedule(1e3,(()=>{this._layout&&(this.gristDoc.isReadonly.get()||this.viewModel.layoutSpecObj.setAndSave(this._layout.getLayoutSpec()),this._onResize())}))})),this.listenTo(this._layout,"layoutUserEditStart",(()=>{i.cancel(),this._isResizing.set(!0)})),this.autoDispose(Hn.LayoutEditor.create(this._layout)),this.onDispose((()=>this._layout.dispose())),this.autoDispose(this.gristDoc.resizeEmitter.addListener(this._onResize,this)),this.listenTo(this.gristDoc.app,"clipboard_blur",this._maybeFocusInSection);const n=C()((e=>{if("flex-grow"!==e.propertyName||!(0,s.isNarrowScreen)())return;if(this.viewModel.isDisposed()||!this.viewModel.activeSection)return;const t=this.viewModel.activeSection.peek();if(!t||t.isDisposed())return;const o=t.viewInstance.peek();o&&!o.isDisposed()&&o.onResize()}),0);this._layout.rootElem.addEventListener("transitionend",n);const l=zr.className+"-active",a=zr.className+"-inactive";this.autoDispose((0,r.subscribe)((0,r.fromKo)(this.viewModel.activeSection),((e,t)=>{var o,i;const n=t.getRowId();this._layout.forEachBox((e=>{e.dom.classList.add(a),e.dom.classList.remove(l),e.dom.classList.remove("transition")}));let r=(null==(o=this._layout.getLeafBox(n))?void 0:o.dom)||null;for(;null==r?void 0:r.matches(".layout_box");)r.classList.remove(a),r.classList.add(l),r=r.parentElement;(0,s.isNarrowScreen)()||null==(i=t.viewInstance.peek())||i.onResize()})));const c={deleteSection:()=>{this._removeViewSection(this.viewModel.activeSectionId())},nextSection:()=>{this._otherSection(1)},prevSection:()=>{this._otherSection(-1)},printSection:()=>{(0,Vn.printViewSection)(this._layout,this.viewModel.activeSection()).catch(ge.reportError)},sortFilterMenuOpen:e=>{this._openSortFilterMenu(e)},maximizeActiveSection:()=>{this._maximizeActiveSection()},cancel:()=>{this.maximized.get()&&this.maximized.set(null)}};this.autoDispose(Po.createGroup(c,this,!0)),this.maximized=(0,r.fromKo)(this._layout.maximized),this.autoDispose(this.maximized.addListener((e=>{var t;const o=this.viewModel.activeSection.peek();!o.isDisposed()&&o.id.peek()&&(null==(t=null==o?void 0:o.viewInstance.peek())||t.onResize())})))}buildDom(){const e=()=>this.maximized.set(null);return jr(jr.cls("-active",(e=>!!e(this.maximized))),(0,s.testId)("viewLayout-overlay"),Wr(Wr.cls("-active",(e=>!!e(this.maximized))),this._layout.rootElem),r.dom.maybe((e=>!!e(this.maximized)),(()=>Hr("CrossBig",(0,s.testId)("close-button"),r.dom.on("click",(()=>e()))))),r.dom.on("click",((t,o)=>{t.target===o&&this.maximized.get()&&e()})))}async freezeUntil(e){this._freeze=!0;try{return await e}finally{this._freeze=!1,this._rebuildLayout(this.layoutSpec.peek())}}_removeViewSection(e){this.gristDoc.docData.sendAction(["RemoveViewSection",e]).catch(ge.reportError)}_maximizeActiveSection(){const e=this.viewModel.activeSection().getRowId(),t=this._layout.getLeafBox(e);t&&t.maximize()}_buildLeafContent(e){return Er({gristDoc:this.gristDoc,sectionRowId:e,isResizing:this._isResizing,viewModel:this.viewModel})}_updateLayoutSpecWithSections(e){const t=jn.Layout.create(e,(()=>(0,r.dom)("div")),!0),o=t.getAllLeafIds(),s=this.viewModel.viewSections().all().map((function(e){return e.getRowId()}));return Pr.difference(o,s).forEach((function(e){var o;null==(o=t.getLeafBox(e))||o.dispose()})),Pr.difference(s,o).forEach((function(e){!function(e){const o=t.buildLayoutBox({leaf:e}),s=t.rootBox().childBoxes.peek(),i=s[s.length-1];s.length>=1&&i.isLeaf()?i.addChild(o,!0):t.rootBox().addChild(o,!0)}(e)})),e=t.getLayoutSpec(),t.dispose(),e}_rebuildLayout(e){this._layout.buildLayout(e,!0),this._onResize(),this._sectionIds=this._layout.getAllLeafIds()}_onResize(){this.viewModel.viewSections().all().forEach((e=>{const t=e.viewInstance.peek();t&&t.onResize()}))}_otherSection(e){const t=this.viewModel.activeSectionId.peek(),o=this._sectionIds.indexOf(t),s=(0,J.mod)(o+e,this._sectionIds.length);this.viewModel.activeSectionId(this._sectionIds[s])}_maybeFocusInSection(){const e=this._layout.getContainingBox(document.activeElement);e&&e.leafId&&this.gristDoc.viewModel.activeSectionId(e.leafId.peek())}_openSortFilterMenu(e){var t;const o=null!=e?e:this.viewModel.activeSectionId(),s=null==(t=this._layout.getLeafBox(o))?void 0:t.dom;if(!s)return;const i=s.querySelector(".test-section-menu-sortAndFilter");null==i||i.click()}}function Er(e){var t;const o=null!=(t=e.isResizing)?t:r.Observable.create(null,!1),{gristDoc:i,sectionRowId:n,viewModel:l,draggable:a=!0,focusable:c=!0}=e,d=i.docModel.viewSections.getRowModel(n);return(0,r.dom)("div.view_leaf.viewsection_content.flexvbox.flexauto",(0,s.testId)(`viewlayout-section-${n}`),e.isResizing?null:r.dom.autoDispose(o),$r.cls(""),Ur.cls("",(e=>!d.isDisposed()&&!e(d.hasFocus))),r.dom.cls("active_section",d.hasFocus),r.dom.cls("active_section--no-indicator",!c),r.dom.maybe((e=>e(d.viewInstance)),(t=>(0,r.dom)("div.viewsection_title.flexhbox",Vr("DragDrop",r.dom.cls("viewsection_drag_indicator"),r.dom.cls("layout_grabbable",(e=>!e(i.isReadonlyKo))),a?null:r.dom.style("visibility","hidden")),r.dom.maybe((e=>e(e(t.viewSection.table).summarySourceTable)),(()=>Lr("Pivot",(0,s.testId)("sigma")))),function(e,t,...o){const s=r.Computed.create(null,(t=>t(e.titleDef)));return Bi(e,s,t,r.dom.autoDispose(s),...o)}(d,e,(0,s.testId)("viewsection-title"),Br((0,s.testId)("viewsection-blank"))),t.buildTitleControls(),(0,r.dom)("div.viewsection_buttons",r.dom.create(dr,i,d))))),r.dom.create(Jn.B,i,d),r.dom.maybe(d.viewInstance,(e=>[(0,r.dom)("div.view_data_pane_container.flexvbox",Nr.cls("",o),r.dom.maybe(e.disableEditing,(()=>(0,r.dom)("div.disable_viewpane.flexvbox","No data"))),r.dom.maybe(e.isTruncated,(()=>(0,r.dom)("div.viewsection_truncated","Not all data is shown"))),r.dom.cls((e=>"viewsection_type_"+e(d.parentKey))),e.viewPane),r.dom.maybe((e=>!e((0,s.isNarrowScreenObs)())),(()=>{var t;return null==(t=e.selectionSummary)?void 0:t.buildDom()}))])),r.dom.on("mousedown",(()=>{null==l||l.activeSectionId(n)})))}const Br=(0,r.styled)("div","\n  min-width: 2px;\n"),Lr=(0,r.styled)(i.icon,`\n  bottom: 1px;\n  margin-right: 5px;\n  background-color: ${s.theme.lightText}\n`),$r=(0,r.styled)("div",`\n  @media ${s.mediaSmall} {\n    & {\n      margin: 4px;\n    }\n  }\n`),Ur=(0,r.styled)("div",`\n  @media screen and ${s.mediaSmall} {\n    & {\n      overflow: hidden;\n      background: repeating-linear-gradient(\n        -45deg,\n        ${s.theme.widgetInactiveStripesDark},\n        ${s.theme.widgetInactiveStripesDark} 10px,\n        ${s.theme.widgetInactiveStripesLight} 10px,\n        ${s.theme.widgetInactiveStripesLight} 20px\n      );\n      border: 1px solid ${s.theme.widgetBorder};\n      border-radius: 4px;\n      padding: 0 2px;\n    }\n    &::after {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n    }\n    &.layout_vbox {\n      max-width: 32px;\n    }\n    &.layout_hbox {\n      max-height: 32px;\n    }\n    & > .viewsection_title.flexhbox {\n      position: absolute;\n    }\n    & > .view_data_pane_container,\n    & .viewsection_buttons,\n    & .grist-single-record__menu,\n    & > .filter_bar {\n      display: none;\n    }\n  }\n`),zr=(0,r.styled)("div",`\n  @media screen and ${s.mediaSmall} {\n    &-active, &-inactive {\n      transition: flex-grow var(--grist-layout-animation-duration, 0.4s); // Exposed for tests\n    }\n    &-active > &-inactive,\n    &-active > &-inactive.layout_hbox .layout_hbox,\n    &-active > &-inactive.layout_vbox .layout_vbox {\n      flex: none !important;\n    }\n\n    &-active > &-inactive.layout_hbox.layout_leaf,\n    &-active > &-inactive.layout_hbox .layout_hbox.layout_leaf {\n      height: 40px;\n    }\n\n    &-active > &-inactive.layout_vbox.layout_leaf,\n    &-active > &-inactive.layout_vbox .layout_vbox.layout_leaf {\n      width: 40px;\n    }\n\n    &-inactive.layout_leaf {\n      min-height: 40px;\n      min-width: 40px;\n    }\n  }\n`),Vr=(0,r.styled)(i.icon,`\n  visibility: hidden;\n  --icon-color: ${s.colors.slate};\n  top: -1px;\n  z-index: 100;\n\n  .viewsection_title:hover &.layout_grabbable {\n    visibility: visible;\n  }\n`),Nr=(0,r.styled)("div","\n  pointer-events: none;\n"),Wr=(0,r.styled)("div",`\n  @media not print {\n    &-active {\n      background: ${s.theme.mainPanelBg};\n      height: 100%;\n      width: 100%;\n      border-radius: 5px;\n      border-bottom-left-radius: 0px;\n      border-bottom-right-radius: 0px;\n      position: relative;\n    }\n    &-active .viewsection_content {\n      margin: 0px;\n      margin-top: 12px;\n    }\n    &-active .viewsection_title {\n      padding: 0px 12px;\n    }\n    &-active .filter_bar {\n      margin-left: 6px;\n    }\n  }\n`),jr=(0,r.styled)("div",`\n  @media screen {\n    &-active {\n      background-color: ${s.theme.modalBackdrop};\n      inset: 0px;\n      height: 100%;\n      width: 100%;\n      padding: 20px 56px 20px 56px;\n      position: absolute;\n    }\n  }\n  @media screen and ${s.mediaSmall} {\n    &-active {\n      padding: 22px;\n      padding-top: 30px;\n    }\n  }\n`),Hr=(0,r.styled)(i.icon,`\n  position: absolute;\n  top: 16px;\n  right: 16px;\n  height: 24px;\n  width: 24px;\n  cursor: pointer;\n  --icon-color: ${s.theme.modalBackdropCloseButtonFg};\n  &:hover {\n    --icon-color: ${s.theme.modalBackdropCloseButtonHoverFg};\n  }\n  @media ${s.mediaSmall} {\n    & {\n      top: 6px;\n      right: 6px;\n    }\n  }\n`),Gr=(0,r.makeTestId)("test-raw-data-");class Kr extends r.Disposable{constructor(e){super(),this._gristDoc=e;const t={printSection:()=>{(0,Vn.printViewSection)(null,this._gristDoc.viewModel.activeSection()).catch(ge.reportError)}};this.autoDispose(Po.createGroup(t,this,!0)),this._lightboxVisible=r.Computed.create(this,(e=>{const t=e(this._gristDoc.viewModel.activeSection);return Boolean(e(t.id))&&e(t.isRaw)}));const o=this._gristDoc.docModel.views.rowModels.find((e=>void 0===e.id.peek()));this.autoDispose(this._gristDoc.activeViewId.addListener((()=>{null==o||o.activeSectionId(0)}))),this.autoDispose(this._lightboxVisible.addListener((e=>{e||this._gristDoc.cursorMonitor.clear()})))}buildDom(){return qr(Xr((0,r.dom)("div",this._gristDoc.behavioralPromptsManager.attachTip("rawDataPage",{hideArrow:!0})),(0,r.dom)("div",r.dom.create(Ki,this._gristDoc),r.dom.create(xn,this._gristDoc.docPageModel)),r.dom.hide(this._lightboxVisible)),r.dom.domComputed((0,r.fromKo)(this._gristDoc.viewModel.activeSection),(e=>e.getRowId()&&e.isRaw.peek()?r.dom.create(Jr,this._gristDoc,e,(()=>this._close())):null)))}_close(){this._gristDoc.viewModel.activeSectionId(0)}}class Jr extends r.Disposable{constructor(e,t,o){super(),this._gristDoc=e,this._viewSection=t,this._onClose=o;const s={cancel:()=>{this._onClose()}};this.autoDispose(Po.createGroup(s,this,!0))}buildDom(){return Or.create(this,this._gristDoc,this._viewSection),Yr(Gr("overlay"),Zr(Er({gristDoc:this._gristDoc,sectionRowId:this._viewSection.getRowId(),draggable:!1,focusable:!1,widgetNameHidden:!0})),Qr("CrossBig",Gr("close-button"),r.dom.on("click",(()=>this._onClose()))),r.dom.on("click",((e,t)=>{e.target===t&&this._onClose()})))}}const qr=(0,r.styled)("div","\n  height: 100%;\n  overflow: hidden;\n  position: relative;\n"),Xr=(0,r.styled)("div",`\n  overflow-y: auto;\n  height: 100%;\n  padding: 32px 64px 24px 64px;\n  @media ${s.mediaSmall} {\n    & {\n      padding: 32px 24px 24px 24px;\n    }\n  }\n`),Yr=(0,r.styled)("div",`\n  background-color: ${s.theme.modalBackdrop};\n  inset: 0px;\n  height: 100%;\n  width: 100%;\n  padding: 20px 56px 20px 56px;\n  position: absolute;\n  @media ${s.mediaSmall} {\n    & {\n      padding: 22px;\n      padding-top: 30px;\n    }\n  }\n`),Zr=(0,r.styled)("div",`\n  background: ${s.theme.mainPanelBg};\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  border-radius: 5px;\n  border-bottom-left-radius: 0px;\n  border-bottom-right-radius: 0px;\n  & .viewsection_content {\n    margin: 0px;\n    margin-top: 12px;\n  }\n  & .viewsection_title {\n    padding: 0px 12px;\n  }\n  & .filter_bar {\n    margin-left: 6px;\n  }\n`),Qr=(0,r.styled)(i.icon,`\n  position: absolute;\n  top: 16px;\n  right: 16px;\n  height: 24px;\n  width: 24px;\n  cursor: pointer;\n  --icon-color: ${s.theme.modalBackdropCloseButtonFg};\n  &:hover {\n    --icon-color: ${s.theme.modalBackdropCloseButtonHoverFg};\n  }\n  @media ${s.mediaSmall} {\n    & {\n      top: 6px;\n      right: 6px;\n    }\n  }\n`);var el=o(84462),tl=o(11104),ol=o(66632),sl=o(73454),il=o(22985),nl=o(68652);const rl=(0,q.makeT)("DocumentSettings");class ll extends r.Disposable{constructor(e){super(),this._gristDoc=e,this._docInfo=this._gristDoc.docInfo,this._timezone=this._docInfo.timezone,this._locale=this._docInfo.documentSettingsJson.prop("locale"),this._currency=this._docInfo.documentSettingsJson.prop("currency"),this._engine=r.Computed.create(this,(e=>e(this._docInfo.documentSettingsJson.prop("engine")))).onWrite((e=>this._setEngine(e)))}buildDom(){const e=pl().length>0,t=this._gristDoc.docPageModel;return dl(cl(rl("Document Settings")),hl(rl("Time Zone:")),hl(r.dom.create(sl.buildTZAutocomplete,nl,(0,r.fromKo)(this._timezone),(e=>this._timezone.saveOnly(e)))),hl(rl("Locale:")),hl(r.dom.create(al,this._locale)),hl(rl("Currency:")),hl(r.dom.domComputed((0,r.fromKo)(this._locale),(e=>r.dom.create(ol.g,(0,r.fromKo)(this._currency),(e=>this._currency.saveOnly(e)),{defaultCurrencyLabel:rl("Local currency ({{currency}})",{currency:(0,il.zC)(e)})})))),e?[hl(rl("Engine (experimental {{span}} change at own risk):",{span:(0,r.dom)("span","☠",r.dom.style("cursor","pointer"),r.dom.on("click",(async()=>{await t.appModel.api.getDocAPI(t.currentDocId.get()).forceReload(),document.location.reload()})))})),(0,n.select)(this._engine,pl())]:null,cl(rl("API")),hl(rl("This document's ID (for API use):")),hl(ul((0,r.dom)("tt",t.currentDocId.get()),r.dom.on("click",(async(e,o)=>{e.stopImmediatePropagation(),e.preventDefault(),(0,Yo.showTransientTooltip)(o,rl("Document ID copied to clipboard"),{key:"copy-document-id"}),await(0,xi.copyToClipboard)(t.currentDocId.get())})))))}async _setEngine(e){(0,us.confirmModal)(rl("Save and Reload"),rl("Ok"),(()=>this._doSetEngine(e)))}async _doSetEngine(e){const t=this._gristDoc.docPageModel;this._engine.get()!==e&&(await this._docInfo.documentSettingsJson.prop("engine").saveOnly(e),await t.appModel.api.getDocAPI(t.currentDocId.get()).forceReload())}}function al(e,t){const o=il.k1.map((e=>({value:e.name,label:e.name,locale:e.code,cleanText:e.name.trim().toLowerCase()}))).sort((0,J.propertyCompare)("label")),i=new tl.ACIndexImpl(o,200,!0),n=r.Computed.create(e,(e=>{var o;const s=e(t);return(null==(o=il.k1.find((e=>e.code===s)))?void 0:o.name)||s}));return(0,el.R)(e,{acIndex:i,valueObs:n,save(e,o){if(!o)throw new Error("Invalid locale");t.saveOnly(o.locale).catch(Cs.eK)}},(0,s.testId)("locale-autocomplete"))}const cl=(0,r.styled)(Ci.gs,"\n  margin-bottom: 0;\n  &:not(:first-of-type) {\n    margin-top: 40px;\n  }\n"),dl=(0,r.styled)("div",`\n  overflow-y: auto;\n  position: relative;\n  height: 100%;\n  padding: 32px 64px 24px 64px;\n  max-width: 487px;\n  @media ${s.mediaSmall} {\n    & {\n      padding: 32px 24px 24px 24px;\n    }\n  }\n`),ul=(0,r.styled)("div",`\n  display: inline-block;\n  cursor: default;\n  color: ${s.theme.lightText};\n  transition: background 0.05s;\n  &:hover {\n    background: ${s.theme.lightHover};\n  }\n`),hl=(0,r.styled)("div",`\n  margin: 16px 0px;\n  font-size: ${s.vars.largeFontSize};\n  color: ${s.theme.text};\n`);function pl(){return(window.gristConfig||{}).supportEngines||[]}const ml=o(91944);class gl extends co.Disposable{constructor(){super(...arguments),this._undoChain=new J.PromiseChain}create(e,t){this._gristDoc=t.gristDoc,this._stack=[],this._pointer=0,this._linkMap=new Map,this.undoDisabledObs=mo.observable(!0),this.redoDisabledObs=mo.observable(!0),this._gristDoc.docPageModel&&this._gristDoc.docPageModel.undoState.set({isUndoDisabled:(0,r.fromKo)(this.undoDisabledObs),isRedoDisabled:(0,r.fromKo)(this.redoDisabledObs)}),e.forEach((e=>{this.pushAction(e)}))}pushAction(e){if(!e.fromSelf)return;const t=e.otherId?this._stack.findIndex((t=>t.actionNum===e.otherId)):-1;e.linkId?(0,J.setDefault)(this._linkMap,e.linkId,[]).push(e):t>-1?this._pointer=e.isUndo?t:t+1:(this.redoDisabledObs()||this._stack.splice(this._pointer),e.otherId||this._stack.push(e),this._pointer=this._stack.length),this.undoDisabledObs(this._pointer<=0),this.redoDisabledObs(this._pointer>=this._stack.length)}sendUndoAction(){return this._undoChain.add((()=>this._sendAction(!0)))}sendRedoAction(){return this._undoChain.add((()=>this._sendAction(!1)))}async _sendAction(e){const t=this._stack[e?this._pointer-1:this._pointer];if(t)try{const o=this._findActionBundle(t);this._gristDoc.moveToCursorPos(t.cursorPos,t).catch((()=>{})),await this._gristDoc.docComm.applyUserActionsById(o.map((e=>e.actionNum)),o.map((e=>e.actionHash)),e,{otherId:t.actionNum}),this._gristDoc.moveToCursorPos(t.cursorPos,t).catch((()=>{}))}catch(t){throw t.message=`Failed to apply ${e?"undo":"redo"} action: ${t.message}`,t}}_findActionBundle(e){const t=new Set,o=[],s=[e];for(;s.length&&(e=s.pop(),!t.has(e.actionNum));)o.push(e),t.add(e.actionNum),s.push(...this._linkMap.get(e.actionNum)||[]);return ml(o,(e=>e.actionNum))}}var fl=o(12856),wl=o(55688),bl=o(45353);class vl{constructor(e,t,o,s){this._untrustedContentOrigin=t,this._docComm=o,this._clientScope=s,this.pluginsList=[];for(const t of e)try{const e=new wl.dl(t,(0,wl.GO)(console,`PLUGIN ${t.id}:`)),o=t.manifest.components||{},s=e.safeBrowser=new fl.u0(e,this._clientScope,this._untrustedContentOrigin,o.safeBrowser);o.safeBrowser&&e.rpc.registerForwarder(o.safeBrowser,s),e.rpc.registerForwarder("*",{forwardCall:e=>this._docComm.forwardPluginRpc(t.id,e),forwardMessage:e=>this._docComm.forwardPluginRpc(t.id,e)}),this.pluginsList.push(e)}catch(e){console.error(`DocPluginManager: failed to instantiate ${t.id}: ${e.message}`)}}receiveAction(e){for(const t of this.pluginsList){const o=t.safeBrowser;o&&o.receiveAction(e)}}makeAnonForwarder(){const e=new bl.Rpc({});return e.queueOutgoingUntilReadyMessage(),e.registerForwarder("*",{forwardCall:e=>this._docComm.forwardPluginRpc("builtIn/core",e),forwardMessage:e=>this._docComm.forwardPluginRpc("builtIn/core",e)}),e}}var _l=o(98279),yl=o(56209),xl=o(89971);class Sl{constructor(e){this._tableData=e,this._cachedColIndexes=new Map,this._tableData.tableActionEmitter.addListener(this._invalidateCache,this),this._tableData.dataLoadedEmitter.addListener(this._clearCache,this)}getValue(e,t){return(0,J.getSetMapValue)(this._cachedColIndexes,e,t)}_invalidateCache(e){if((0,Ve.isUpdateRecord)(e)||(0,Ve.isBulkUpdateRecord)(e)){const t=e[3];for(const e of Object.keys(t))this._cachedColIndexes.delete(e)}else this._clearCache()}_clearCache(){this._cachedColIndexes.clear()}}class Cl{constructor(e){this._tableData=e,this._columnCache=new Sl(this._tableData)}getColACIndex(e,t){return this._columnCache.getValue(e,(()=>this._buildColACIndex(e,t)))}_buildColACIndex(e,t){const o=this._tableData.getRowIds(),s=this._tableData.getColValues(e);if(!s)throw new ge.UserError(`Invalid column ${this._tableData.tableId}.${e}`);const i=s.map(((e,s)=>{const i=o[s],n=t.formatAny(e);return{rowId:i,text:n,cleanText:(0,tl.normalizeText)(n)}}));return i.sort(Il),new tl.ACIndexImpl(i)}}function Il(e,t){return(0,J.localeCompare)(e.cleanText,t.cleanText)||(0,J.localeCompare)(e.text,t.text)||(0,J.nativeCompare)(e.rowId,t.rowId)}const Rl=o(87604);class Dl{dispatchAction(e){const t=e;switch(e[0]){case"AddRecord":return this.onAddRecord(e,t[1],t[2],t[3]);case"UpdateRecord":return this.onUpdateRecord(e,t[1],t[2],t[3]);case"RemoveRecord":return this.onRemoveRecord(e,t[1],t[2]);case"BulkAddRecord":return this.onBulkAddRecord(e,t[1],t[2],t[3]);case"BulkUpdateRecord":return this.onBulkUpdateRecord(e,t[1],t[2],t[3]);case"BulkRemoveRecord":return this.onBulkRemoveRecord(e,t[1],t[2]);case"ReplaceTableData":return this.onReplaceTableData(e,t[1],t[2],t[3]);case"AddColumn":return this.onAddColumn(e,t[1],t[2],t[3]);case"RemoveColumn":return this.onRemoveColumn(e,t[1],t[2]);case"RenameColumn":return this.onRenameColumn(e,t[1],t[2],t[3]);case"ModifyColumn":return this.onModifyColumn(e,t[1],t[2],t[3]);case"AddTable":return this.onAddTable(e,t[1],t[2]);case"RemoveTable":return this.onRemoveTable(e,t[1]);case"RenameTable":return this.onRenameTable(e,t[1],t[2]);default:throw new Error(`Received unknown action ${e[0]}`)}}onBulkAddRecord(e,t,o,s){for(let i=0;i<o.length;i++)this.onAddRecord(e,t,o[i],Rl(s,(e=>e[i])))}onBulkUpdateRecord(e,t,o,s){for(let i=0;i<o.length;i++)this.onUpdateRecord(e,t,o[i],Rl(s,(e=>e[i])))}onBulkRemoveRecord(e,t,o){for(const s of o)this.onRemoveRecord(e,t,s)}}const Tl=o(36812),kl=o(66287);class Ml extends Dl{constructor(e,t,o){super(),this._isLoaded=!1,this._columns=new Map,this._colArray=[],this._rowIdCol=[],this._rowMap=new Map,this._tableId=e;for(const e in o)if(o.hasOwnProperty(e)){const t=o[e],s={colId:e,type:t,defl:(0,Ze.getDefaultForType)(t),values:[]};this._columns.set(e,s),this._colArray.push(s)}this._columns.set("id",{colId:"id",type:"Id",defl:0,values:this._rowIdCol}),t&&this.loadData(t)}fetchData(e){return this._fetchPromise||(this._fetchPromise=e(this._tableId).then((e=>{this._fetchPromise=void 0,this.loadData(e)}))),this._fetchPromise}loadData(e){const t=e[2],o=e[3],s=this._rowIdCol.slice(0);Al(this._rowIdCol,t);for(const e of this._colArray){const s="id"===e.colId?t:o[e.colId];Al(e.values,s||this._rowIdCol.map((()=>e.defl)))}this._rowMap.clear();for(let e=0;e<t.length;e++)this._rowMap.set(t[e],e);return this._isLoaded=!0,s}loadPartial(e){const t=e[2];this.onBulkAddRecord(e,e[1],t,e[3]),this._isLoaded=!0}unloadPartial(e){this.onBulkRemoveRecord(["BulkRemoveRecord",this.tableId,e],this.tableId,e)}get tableId(){return this._tableId}get isLoaded(){return this._isLoaded}numRecords(){return this._rowIdCol.length}getValue(e,t){const o=this._columns.get(t),s=this._rowMap.get(e);return o&&void 0!==s?o.values[s]:void 0}hasRowId(e){return this._rowMap.has(e)}getRowIdIndex(e){return this._rowMap.get(e)}getRowPropFunc(e){const t=this._columns.get(e);if(!t)return()=>{};const o=t.values,s=this._rowMap;return e=>o[s.get(e)]}getKeepFunc(){}getSkipRowId(){throw new Error("no skip row id defined")}getRowIds(){return this._rowIdCol}getSortedRowIds(){return this._rowIdCol.slice(0).sort(((e,t)=>e-t))}mayHaveVersions(){return!1}getColIds(){return Array.from(this._columns.keys())}getColValues(e){const t=this._columns.get(e);return t?t.values:void 0}getDistinctValues(e,t=1/0){const o=this.getColValues(e);if(o)return(0,J.getDistinctValues)(o,t)}getTableDataAction(e){const t=e||this.getRowIds();let o;if(e){const e=t.length;o={};for(const t of this.getColIds())o[t]=Array(e);for(let s=0;s<e;s++){const e=this._rowMap.get(t[s]);for(const{colId:t,values:i}of this._colArray){const n=void 0===e?null:i[e];o[t][s]=n}}}else o=kl(this.getColIds().filter((e=>"id"!==e)).map((e=>[e,this.getColValues(e)])));return["TableData",this.tableId,t,o]}getBulkAddRecord(e){const t=this.getTableDataAction(null==e?void 0:e.sort(((e,t)=>e-t)));return["BulkAddRecord",t[1],t[2],t[3]]}getColType(e){const t=this._columns.get(e);return t?t.type:void 0}getRecord(e){const t=this._rowMap.get(e);if(void 0===t)return;const o={id:this._rowIdCol[t]};for(const e of this._colArray)o[e.colId]=e.values[t];return o}getRecords(){const e=this._rowIdCol.map((e=>({id:e})));for(const{colId:t,values:o}of this._colArray)for(let s=0;s<e.length;s++)e[s][t]=o[s];return e}filterRowIds(e){return this._filterRowIndices(e).map((e=>this._rowIdCol[e]))}filterRecords(e){const t=this._filterRowIndices(e),o=t.map((e=>({id:this._rowIdCol[e]})));for(const{colId:e,values:s}of this._colArray)for(let i=0;i<o.length;i++)o[i][e]=s[t[i]];return o}findRow(e,t){const o=this._columns.get(e);if(!o)return 0;const s=o.values.indexOf(t);return s<0?0:this._rowIdCol[s]}findMatchingRowId(e){const t=Object.keys(e).map((t=>({col:this._columns.get(t),value:e[t]})));return t.every((e=>e.col))&&this._rowIdCol.find(((e,o)=>t.every((e=>Tl(e.col.values[o],e.value)))))||0}receiveAction(e){return!(!this._isLoaded&&!(0,Ve.isSchemaAction)(e)||(this.dispatchAction(e),0))}onAddRecord(e,t,o,s){if(void 0!==this._rowMap.get(o))return void this.onUpdateRecord(e,t,o,s);const i=this._rowIdCol.length;this._rowMap.set(o,i),this._rowIdCol[i]=o;for(const{colId:e,defl:t,values:o}of this._colArray)o[i]=s.hasOwnProperty(e)?s[e]:t}onBulkAddRecord(e,t,o,s){let i=this._rowIdCol.length;for(let e=0;e<o.length;e++){const t=this._rowMap.get(o[e]);if(void 0!==t){for(const o in s)if(s.hasOwnProperty(o)){const i=this._columns.get(o);i&&(i.values[t]=s[o][e])}}else{this._rowMap.set(o[e],i),this._rowIdCol[i]=o[e];for(const{colId:t,defl:o,values:n}of this._colArray)n[i]=s.hasOwnProperty(t)?s[t][e]:o;i++}}}onRemoveRecord(e,t,o){const s=this._rowMap.get(o);if(void 0!==s){const e=this._rowIdCol.length-1;for(const{values:t}of this._columns.values())t[s]=t[e],t.pop();this._rowMap.set(this._rowIdCol[s],s),this._rowMap.delete(o)}}onUpdateRecord(e,t,o,s){const i=this._rowMap.get(o);if(void 0!==i)for(const e in s)if(s.hasOwnProperty(e)){const t=this._columns.get(e);t&&(t.values[i]=s[e])}}onBulkUpdateRecord(e,t,o,s){for(let e=0;e<o.length;e++){const t=this._rowMap.get(o[e]);if(void 0!==t)for(const o in s)if(s.hasOwnProperty(o)){const i=this._columns.get(o);i&&(i.values[t]=s[o][e])}}}onReplaceTableData(e,t,o,s){this.loadData(e)}onAddColumn(e,t,o,s){if(this._columns.has(o))return;const i=s.type,n=(0,Ze.getDefaultForType)(i),r={colId:o,type:i,defl:n,values:this._rowIdCol.map((()=>n))};this._columns.set(o,r),this._colArray.push(r)}onRemoveColumn(e,t,o){const s=this._columns.get(o);s&&(this._columns.delete(o),(0,J.arrayRemove)(this._colArray,s))}onRenameColumn(e,t,o,s){const i=this._columns.get(o);i&&(i.colId=s,this._columns.set(s,i),this._columns.delete(o))}onModifyColumn(e,t,o,s){const i=this._columns.get(o);i&&s.hasOwnProperty("type")&&(i.type=s.type,i.defl=(0,Ze.getDefaultForType)(s.type))}onRenameTable(e,t,o){this._tableId=o}onAddTable(e,t,o){}onRemoveTable(e,t){this._isLoaded=!1}_filterRowIndices(e){const t=[],o=Object.keys(e).map((t=>({col:this._columns.get(t),value:e[t]})));return this._rowIdCol.forEach(((e,s)=>{o.every((e=>Tl(e.col.values[s],e.value)))&&t.push(s)})),t}}class Pl extends Ml{constructor(e,t,o){super(e,t,o)}getValue(e,t){return super.getValue(e,t)}getRecords(){return super.getRecords()}getRecord(e){return super.getRecord(e)}filterRecords(e){return super.filterRecords(e)}findMatchingRowId(e){return super.findMatchingRowId(e)}getRowPropFunc(e){return super.getRowPropFunc(e)}getColValues(e){return super.getColValues(e)}findRow(e,t){return super.findRow(e,t)}}function Al(e,t){e.length=0,(0,J.arraySplice)(e,0,t)}class Ol extends Ml{constructor(e,t,o,s){super(t,o,s),this.docData=e,this.tableActionEmitter=new r.Emitter,this.dataLoadedEmitter=new r.Emitter,this.columnACIndexes=new Cl(this),this._columnErrorCounts=new Sl(this)}loadData(e){const t=super.loadData(e);return this.dataLoadedEmitter&&this.dataLoadedEmitter.emit(t,this.getRowIds()),t}loadPartial(e){super.loadPartial(e),this.dataLoadedEmitter.emit([],e[2])}unloadPartial(e){super.unloadPartial(e),this.dataLoadedEmitter.emit(e,[])}countErrors(e){return this._columnErrorCounts.getValue(e,(()=>{const t=this.getColValues(e);return t&&(0,J.countIf)(t,Ze.isRaisedException)}))}sendTableActions(e,t){return e.forEach((e=>e.splice(1,0,this.tableId))),this.docData.sendActions(e,t)}sendTableAction(e,t){if(e)return e.splice(1,0,this.tableId),this.docData.sendAction(e,t)}receiveAction(e){const t=super.receiveAction(e);return t&&this.tableActionEmitter.emit(e),t}}var Fl=o(90744);const El=o(66287),Bl=o(24013);class Ll extends Dl{constructor(e,t){if(super(),this._tables=new Map,this._fetchTableFunc=async t=>{const{tableData:o,attachments:s}=await e(t);return s&&this.receiveAction(s),o},null===t)return;for(const e in Fl.f)if(Fl.f.hasOwnProperty(e)){const o=Fl.f[e];this._tables.set(e,this.createTableData(e,t[e],o))}const o=Bl(this._tables.get("_grist_Tables_column").getRecords(),"parentId");for(const e of this._tables.get("_grist_Tables").getRecords()){const t=e.tableId,s=o[e.id]||[],i=El(s.map((e=>[e.colId,e.type])));this._tables.set(t,this.createTableData(t,null,i))}}createTableData(e,t,o){return new(e in Fl.f?Pl:Ml)(e,t,o)}getTable(e){return this._tables.get(e)}getMetaTable(e){return this.getTable(e)}getTables(){return this._tables}fetchTable(e,t){const o=this._tables.get(e);if(!o)throw new Error(`DocData.fetchTable: unknown table ${e}`);return!o.isLoaded||t?o.fetchData(this._fetchTableFunc):Promise.resolve()}async syncTable(e){const t=await this._fetchTableFunc(e),o=El(Object.keys(t[3]).map((e=>[e,"Any"])));o.id="Any",this._tables.set(e,this.createTableData(e,t,o))}receiveAction(e){const t=e[1],o=this._tables.get(t);this.dispatchAction(e),o&&o.receiveAction(e)}docInfo(){return this.getMetaTable("_grist_DocInfo").getRecord(1)}docSettings(){return(0,J.safeJsonParse)(this.docInfo().documentSettings,{})}onAddTable(e,t,o){const s=El(o.map((e=>[e.id,e.type])));this._tables.set(t,this.createTableData(t,null,s))}onRemoveTable(e,t){this._tables.delete(t)}onRenameTable(e,t,o){const s=this._tables.get(t);s&&(this._tables.set(o,s),this._tables.delete(t))}onAddRecord(e,t,o,s){}onUpdateRecord(e,t,o,s){}onRemoveRecord(e,t,o){}onBulkAddRecord(e,t,o,s){}onBulkUpdateRecord(e,t,o,s){}onBulkRemoveRecord(e,t,o){}onReplaceTableData(e,t,o,s){}onAddColumn(e,t,o,s){}onRemoveColumn(e,t,o){}onRenameColumn(e,t,o,s){}onModifyColumn(e,t,o,s){}}var $l=o(74392);const Ul=o(52906),zl=window.gristNotify;class Vl extends Ll{constructor(e,t){super((t=>e.fetchTable(t)),t),this.docComm=e,this.sendActionsEmitter=new r.Emitter,this.sendActionsDoneEmitter=new r.Emitter,this._bundlesPending=0,this._nextDesc=null,this._lastActionNum=null,this._bundleSender=new Nl(this.docComm)}createTableData(e,t,o){return new Ol(this,e,t,o)}getTable(e){return super.getTable(e)}getMetaTable(e){return super.getMetaTable(e)}async findColFromValues(e,t,o){try{return await this.docComm.findColFromValues(e,t,o)}catch(e){return zl(`Error finding matching columns: ${e.message}`),[]}}getFormulaError(e,t,o){return this.docComm.getFormulaError(e,t,o)}startBundlingActions(e){if(this._bundlesPending>=2)throw new Error("Too many actions already pending");let t;this._bundlesPending++;const o=new Promise((e=>{t=e}));let s;const i=new Promise((e=>{s=e})),n=this._lastBundlePromise=(async()=>{var n;this._lastBundlePromise&&(null==(n=this._triggerBundleFinalize)||n.call(this),await this._lastBundlePromise);try{this._nextDesc=e.description,this._lastActionNum=null,this._triggerBundleFinalize=s,t(e.prepare()),this._shouldIncludeInBundle=e.shouldIncludeInBundle,await Promise.all([i,o]),this._shouldIncludeInBundle=void 0,await e.finalize()}finally{this._shouldIncludeInBundle=void 0,this._triggerBundleFinalize=void 0,this._bundlesPending--,0===this._bundlesPending&&(this._lastBundlePromise=void 0)}})();return{preparePromise:o,triggerFinalize:s,completionPromise:n}}async bundleActions(e,t,o={}){if(o.nestInActiveBundle&&this._bundlesPending)return await t();const s=this.startBundlingActions({description:e,shouldIncludeInBundle:()=>!0,prepare:t,finalize:async()=>{}});try{return await s.preparePromise}finally{s.triggerFinalize(),await s.completionPromise}}sendActions(e,t){return $l.Promise.resolve(this._sendActionsImpl(e,t))}sendAction(e,t){return this.sendActions([e],t).then((e=>e[0]))}async _sendActionsImpl(e,t){var o;const s={actions:e};this.sendActionsEmitter.emit(s);const i={desc:t};this._shouldIncludeInBundle&&!this._shouldIncludeInBundle(e)&&(null==(o=this._triggerBundleFinalize)||o.call(this),await this._lastBundlePromise),this._bundlesPending&&(Ul(i,{desc:this._nextDesc,linkId:this._lastActionNum}),this._nextDesc=null);const n=await this._bundleSender.applyUserActions(e,i);return this._lastActionNum=n.actionNum,this.sendActionsDoneEmitter.emit(s),n.retValues}}class Nl{constructor(e){this._docComm=e,this._options={},this._actions=[]}applyUserActions(e,t){Ul(this._options,t);const o=this._actions.length;this._actions.push(...e);const s=this._actions.length;return this._getSendPromise().then((e=>({actionNum:e.actionNum,retValues:e.retValues.slice(o,s),isModification:e.isModification})))}_getSendPromise(){return this._sendPromise||(this._sendPromise=Promise.resolve().then((()=>{this._sendPromise=void 0;const e=this._docComm.applyUserActions(this._actions,this._options);return this._options={},this._actions=[],e}))),this._sendPromise}}var Wl=o(28082),jl=o.n(Wl),Hl=o(33620),Gl=o(41367),Kl=o.n(Gl),Jl=o(10832),ql=o.n(Jl),Xl=o(3871),Yl=o(33444);function Zl(e){}var Ql=o(32529),ea=o(11486),ta=o(48807);function oa(e){this.table=Qa(e.tables,this.parentId),this.widgetOptionsJson=(0,Ql.jsonObservable)(this.widgetOptions),this.viewFields=Za(this,e.viewFields,"colRef"),this.summarySource=Qa(e.columns,this.summarySourceCol),this.cells=Za(this,e.cells,"colRef"),this.isEmpty=mo.pureComputed((()=>this.isFormula()&&""===this.formula())),this.isRealFormula=mo.pureComputed((()=>this.isFormula()&&""!==this.formula())),this.hasTriggerFormula=mo.pureComputed((()=>!this.isFormula()&&""!==this.formula())),this.origColRef=mo.observable(this.getRowId()),this.origCol=Qa(e.columns,this.origColRef),this.isTransforming=mo.observable(!1),this.pureType=mo.pureComputed((()=>Ze.extractTypeFromColType(this.type()))),this._displayColModel=Qa(e.columns,this.displayCol),this.saveDisplayFormula=function(t){if(t!==(this._displayColModel().formula()||""))return e.docData.sendAction(["SetDisplayFormula",this.table().tableId(),null,this.getRowId(),t])},this.displayColRef=mo.pureComputed((()=>this.displayCol()||this.origColRef())),this.displayColModel=Qa(e.columns,this.displayColRef),this.visibleColModel=Qa(e.columns,this.visibleCol),this.disableModifyBase=mo.pureComputed((()=>Boolean(this.summarySourceCol()))),this.disableModify=mo.pureComputed((()=>this.disableModifyBase()||this.isTransforming())),this.disableEditData=mo.pureComputed((()=>Boolean(this.summarySourceCol()))),this.isHiddenCol=mo.pureComputed((()=>Ze.isHiddenCol(this.colId()))),this.refTable=mo.pureComputed((()=>{const t=(0,Ze.getReferencedTableId)(this.type()||"");return t&&e.visibleTables.all().find((e=>e.tableId()===t))||null})),this.visibleColFormatter=mo.pureComputed((()=>sa(this,this,e,"vcol"))),this.formatter=mo.pureComputed((()=>sa(this,this,e,"full"))),this.createValueParser=function(){const t=(0,ta.jo)(e.docData,this.id.peek());return t.cleanParse.bind(t)},this.behavior=mo.pureComputed((()=>this.isEmpty()?"empty":this.isFormula()?"formula":"data"))}function sa(e,t,o,s){const i=e.visibleColModel();return("full"===s?ea.EF:ea.ku)({docData:o.docData,type:t.type(),widgetOpts:e.widgetOptionsJson(),visibleColType:null==i?void 0:i.type(),visibleColWidgetOpts:null==i?void 0:i.widgetOptionsJson(),docSettings:o.docInfoRow.documentSettingsJson()})}function ia(e){this.documentSettingsJson=(0,Ql.jsonObservable)(this.documentSettings),this.defaultViewId=this.autoDispose(mo.pureComputed((()=>{const t=e.allTabs.at(0);return t?t.viewRef():0}))),this.newDefaultViewId=this.autoDispose(mo.pureComputed((()=>{const t=e.visibleDocPages()[0];return t?t.viewRef():0})))}function na(e){this.viewSection=Qa(e.viewSections,this.viewSectionRef),this.column=Qa(e.columns,this.colRef),this.activeFilter=Ql.customComputed({read:()=>{const e=this.filter();return"null"===e?"":e}})}function ra(e){this.view=Qa(e.views,this.viewRef),this.isCensored=mo.pureComputed((()=>!this.view().name())),this.isSpecial=mo.pureComputed((()=>"GristDocTour"===this.view().name()&&!e.showDocTourTable||(()=>{var t;const o=this.view().id(),s=e.rawDataTables.all().find((e=>e.primaryViewId()===o));return!!s&&(null==(t=s.tableId())?void 0:t.startsWith("GristHidden_"))})())),this.isHidden=mo.pureComputed((()=>this.isCensored()||this.isSpecial()))}function la(e){this.view=Qa(e.views,this.viewRef)}var aa=o(90771),ca=o.n(aa);function da(e){this.columns=Za(this,e.columns,"parentId",{sortBy:"parentPos"}),this.validations=Za(this,e.validations,"tableRef"),this.primaryView=Qa(e.views,this.primaryViewId),this.rawViewSection=Qa(e.viewSections,this.rawViewSectionRef),this.summarySource=Qa(e.tables,this.summarySourceTable),this.isHidden=this.autoDispose(mo.pureComputed((()=>!this.tableId()||!!this.summarySourceTable()||this.tableId().startsWith("GristHidden_")))),this.summarySourceColRefs=this.autoDispose(mo.pureComputed((()=>new Set(this.columns().all().map((e=>e.summarySourceCol())).filter((e=>e)))))),this.primaryTableId=mo.pureComputed((()=>this.summarySourceTable()?this.summarySource().tableId():this.tableId())),this.groupByColumns=mo.pureComputed((()=>this.columns().all().filter((e=>e.summarySourceCol())))),this.groupDesc=mo.pureComputed((()=>this.summarySourceTable()?ze(this.groupByColumns().map((e=>e.label()))):"")),this.tableColor=ca()({luminosity:"light",seed:"number"==typeof this.id()?5*this.id():this.id()}),this.disableAddRemoveRows=mo.pureComputed((()=>Boolean(this.summarySourceTable()))),this.supportsManualSort=mo.pureComputed((()=>this.columns().all().some((e=>e.colId()===Ze.MANUALSORT)))),this.tableName=Ql.savingComputed({read:()=>this.isDisposed()?"":this.summarySourceTable()?this.summarySource().rawViewSection().title():this.rawViewSection().isDisposed()?"":this.rawViewSection().title(),write:(e,t)=>{this.summarySourceTable()?e(this.summarySource().rawViewSection().title,t):e(this.rawViewSection().title,t)}}),this.tableNameDef=Ql.fieldWithDefault(this.tableName,mo.computed((()=>this.isDisposed()?"":(this.summarySourceTable()?this.summarySource():this).tableId()||""))),this.formattedTableName=mo.pureComputed((()=>this.summarySourceTable()?`${this.tableNameDef()} ${this.groupDesc()}`:this.tableNameDef()))}function ua(e){}async function ha(e,t,o){var s,i;const n=t.rulesCols.peek()[o];if(!n)throw new Error(`There is no rule at index ${o}`);const r=null!=(i=null==(s=t.rulesStyles.peek())?void 0:s.slice())?i:[];r.length>=o?r.splice(o,1):console.debug(`There are not style options at index ${o}`),await e.docData.bundleActions("Remove conditional rule",(()=>Promise.all([t.rulesStyles.setAndSave(r),e.docData.sendAction(["RemoveColumn",t.tableId.peek(),n.colId.peek()])])))}var pa=o(49142),ma=o(36812),ga=o.n(ma),fa=o(80687),wa=o.n(fa),ba=Object.defineProperty,va=Object.getOwnPropertySymbols,_a=Object.prototype.hasOwnProperty,ya=Object.prototype.propertyIsEnumerable,xa=(e,t,o)=>t in e?ba(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Sa=(e,t)=>{for(var o in t||(t={}))_a.call(t,o)&&xa(e,o,t[o]);if(va)for(var o of va(t))ya.call(t,o)&&xa(e,o,t[o]);return e};class Ca{constructor(e,t){this._field=e,this._docModel=t;const o=e;this.fields=o.autoDispose(mo.pureComputed((()=>{const t=this._field.viewSection().selectedFields();return t&&t.length?t.filter((e=>!e.isDisposed()&&!e.column().isDisposed())):[e]}))),this.multiselect=o.autoDispose(mo.pureComputed((()=>this.fields().length>1))),this.sameWidgets=o.autoDispose(mo.pureComputed((()=>{var e;const t=this.fields();if(t.length<=1)return!0;const o=t.map((e=>{var t,o;return Object.keys(null!=(o=null==(t=pa.UD[e.column().pureType()])?void 0:t.widgets)?o:{})}));return No()(...o).length===(null==(e=o[0])?void 0:e.length)}))),this.widget=o.autoDispose(mo.pureComputed({read:()=>{if(!this.multiselect())return this._field.widget();const e=this.fields().map((e=>e.widget()));return Ia(e)?e[0]:void 0},write:e=>{for(const t of this.fields.peek()){const o=t.widgetOptionsJson.peek();t.widgetOptionsJson.setAndSave({widget:e,fillColor:o.fillColor,textColor:o.textColor}).catch(reportError)}}}));const s=o.autoDispose(mo.pureComputed((()=>{var e,t;const o=this.fields();let s=null;for(const i of o){const o=i.widget()||"",n=null==(t=null==(e=pa.UD[i.column().pureType()])?void 0:e.widgets[o])?void 0:t.options;if(n)if(s){const e=new Set(Object.keys(n));for(const t of s)e.has(t)||s.delete(t)}else s=new Set(Object.keys(n))}return null!=s?s:new Set}))),i=Ql.savingComputed({read:()=>{var e;if(!this.multiselect())return this._field.widgetOptionsJson();const t={},o=this.fields().map((e=>e.widgetOptionsJson())),i=s();for(const s of i)t[s]=null,Ia(o.map((e=>e[s])))&&(t[s]=null!=(e=o[0][s])?e:null);return t},write:(e,t)=>{if(!this.multiselect.peek())return e(this._field.widgetOptionsJson,t);t=Sa({},t);for(const e of Object.keys(t))null===t[e]&&delete t[e];for(const o of this.fields.peek()){const s=o.widgetOptionsJson.peek();e(o.widgetOptionsJson,Sa(Sa({},s),t))}}});this.options=o.autoDispose(Da(Ql.objObservable(i),{disabled:e=>mo.pureComputed((()=>!s().has(e))),mixed:e=>mo.pureComputed((()=>!Ia(this.fields().map((t=>t.widgetOptionsJson.prop(e)()))))),empty:e=>mo.pureComputed((()=>Ra(this.fields().map((t=>t.widgetOptionsJson.prop(e)())))))})),this.wrap=Ql.fieldWithDefault(this.options.prop("wrap"),(()=>"record"!==this._field.viewSection().parentKey())),this.alignment=this.options.prop("alignment"),this.style=mo.pureComputed((()=>{const e=this.fields(),t=e.length>1,o=Ql.savingComputed({read:()=>{var o;if(!t)return this._field.widgetOptionsJson();const s={},i=e.map((e=>e.widgetOptionsJson()));for(const e of["textColor","fillColor","fontBold","fontItalic","fontUnderline","fontStrikethrough"])s[e]=null,Ia(i.map((t=>t[e])))&&(s[e]=null!=(o=i[0][e])?o:null);return s},write:(o,s)=>{if(!t)return o(this._field.widgetOptionsJson,s);s=Sa({},s);for(const e of Object.keys(s))null===s[e]&&delete s[e];for(const t of e){const e=t.widgetOptionsJson.peek();o(t.widgetOptionsJson,Sa(Sa({},e),s))}}}),s=e.map((e=>e.style.peek())),i=Da(Ql.objObservable(o),{mixed:t=>mo.pureComputed((()=>!Ia(e.map((e=>e.widgetOptionsJson.prop(t)()))))),empty:t=>mo.pureComputed((()=>Ra(e.map((e=>e.widgetOptionsJson.prop(t)())))))});return i.revert=()=>{wa()(e,s).forEach((([e,t])=>e.style(t)))},i}))}async updateChoices(e,t){const o=!!Object.entries(e).length,s=this._field.column.peek().table.peek().tableId.peek();if(this.multiselect.peek()){this._field.config.options.update(t);const i=this.fields.peek().map((e=>e.colId.peek()));return this._docModel.docData.bundleActions("Update choices configuration",(()=>Promise.all([this._field.config.options.save(),o?this._docModel.docData.sendActions(i.map((t=>["RenameChoices",s,t,e]))):null])))}{const i=this._field.column.peek(),n={nestInActiveBundle:i.isTransforming.peek()};return this._field.widgetOptionsJson.update(t),this._docModel.docData.bundleActions("Update choices configuration",(()=>Promise.all([this._field.widgetOptionsJson.save(),o?this._docModel.docData.sendAction(["RenameChoices",s,i.colId.peek(),e]):null])),n)}}}function Ia(e){if(e.length<=1)return!0;const t=(0,J.ifNotSet)(e[0],null),o=e.every((e=>ga()((0,J.ifNotSet)(e,null),t)));return o}function Ra(e){return 0===e.length||e.every((e=>null===(0,J.ifNotSet)(e,null)))}function Da(e,t){const o=e;for(const e of Object.keys(t)){const s=`__${e}`;o[s]=new Map,o[e]=i=>(o[s].has(i)||o[s].set(i,t[e](i)),o[s].get(i))}return o}function Ta(e){this.viewSection=Qa(e.viewSections,this.parentId),this.widthDef=Ql.fieldWithDefault(this.width,(()=>this.viewSection().defaultWidth())),this.widthPx=mo.pureComputed((()=>this.widthDef()+"px")),this.column=Qa(e.columns,this.colRef),this.origCol=mo.pureComputed((()=>this.column().origCol())),this.colId=mo.pureComputed((()=>this.column().colId())),this.label=mo.pureComputed((()=>this.column().label())),this.displayLabel=Ql.savingComputed({read:()=>e.editingFormula()?"$"+this.origCol().colId():this.origCol().label(),write:(e,t)=>e(this.column().label,t)});const t=mo.observable(!1);this.editingFormula=mo.pureComputed({read:()=>t(),write:o=>{e.editingFormula(o),t(o)}}),this.formulaCssClass=mo.pureComputed((()=>{const e=this.column();return this.column().isTransforming()?"transform_field":this.editingFormula()?"formula_field_edit":e.isFormula()&&""!==e.formula()?"formula_field":null})),this._displayColModel=Qa(e.columns,this.displayCol),this.saveDisplayFormula=function(t){if(t!==(this._displayColModel().formula()||""))return e.docData.sendAction(["SetDisplayFormula",this.column().table().tableId(),this.getRowId(),null,t])},this.useColOptions=this.autoDispose(mo.pureComputed((()=>!this.widgetOptions()||this.column().isTransforming()))),this._fieldOrColumn=this.autoDispose(mo.pureComputed((()=>this.useColOptions()?this.column():this))),this.displayColRef=this.autoDispose(mo.pureComputed((()=>this._fieldOrColumn().displayCol()||this.colRef()))),this.visibleColRef=Ql.addSaveInterface(mo.pureComputed({read:()=>this._fieldOrColumn().visibleCol(),write:e=>this._fieldOrColumn().visibleCol(e)}),(t=>e.docData.bundleActions(null,(async()=>{const o=e.columns.getRowModel(t);await Promise.all([this._fieldOrColumn().visibleCol.saveOnly(t),this._fieldOrColumn().saveDisplayFormula(t?`$${this.colId()}.${o.colId()}`:"")])}),{nestInActiveBundle:this.column.peek().isTransforming.peek()}))),this.displayColModel=Qa(e.columns,this.displayColRef),this.visibleColModel=Qa(e.columns,this.visibleColRef),this.visibleColFormatter=mo.pureComputed((()=>sa(this,this.column(),e,"vcol"))),this.formatter=mo.pureComputed((()=>sa(this,this.column(),e,"full"))),this.createValueParser=function(){const t=this.useColOptions.peek()?void 0:this.id.peek(),o=(0,ta.jo)(e.docData,this.colRef.peek(),t);return o.cleanParse.bind(o)},this._widgetOptionsStr=this.autoDispose(Ql.savingComputed({read:()=>this._fieldOrColumn().widgetOptions(),write:(e,t)=>e(this._fieldOrColumn().widgetOptions,t)})),this.widgetOptionsJson=this.autoDispose(Ql.jsonObservable(this._widgetOptionsStr,(e=>pa.JH(e||{},this.column().pureType())))),this.wrap=this.autoDispose(Ql.fieldWithDefault(this.widgetOptionsJson.prop("wrap"),(()=>"record"!==this.viewSection().parentKey()))),this.widget=this.widgetOptionsJson.prop("widget"),this.textColor=this.widgetOptionsJson.prop("textColor"),this.fillColor=this.widgetOptionsJson.prop("fillColor"),this.fontBold=this.widgetOptionsJson.prop("fontBold"),this.fontUnderline=this.widgetOptionsJson.prop("fontUnderline"),this.fontItalic=this.widgetOptionsJson.prop("fontItalic"),this.fontStrikethrough=this.widgetOptionsJson.prop("fontStrikethrough"),this.documentSettings=mo.pureComputed((()=>e.docInfoRow.documentSettingsJson())),this.style=mo.pureComputed({read:()=>({textColor:this.textColor(),fillColor:this.fillColor(),fontBold:this.fontBold(),fontUnderline:this.fontUnderline(),fontItalic:this.fontItalic(),fontStrikethrough:this.fontStrikethrough()}),write:e=>{this.widgetOptionsJson.update(e)}}),this.tableId=mo.pureComputed((()=>this.column().table().tableId())),this.rulesCols=ec(e.columns,mo.pureComputed((()=>this._fieldOrColumn().rules()))),this.rulesColsIds=mo.pureComputed((()=>this.rulesCols().map((e=>e.colId())))),this.rulesStyles=Ql.fieldWithDefault(this.widgetOptionsJson.prop("rulesOptions"),[]),this.hasRules=mo.pureComputed((()=>this.rulesCols().length>0)),this.addEmptyRule=async()=>{const t=this.useColOptions.peek(),o=["AddEmptyRule",this.column.peek().table.peek().tableId.peek(),t?0:this.id.peek(),t?this.column.peek().id.peek():0];await e.docData.sendAction(o,`Update rules for ${this.colId.peek()}`)},this.removeRule=t=>ha(e,this,t),this.config=new Ca(this,e),this.disableModify=this.autoDispose(mo.pureComputed((()=>this.column().disableModify()))),this.disableEditData=this.autoDispose(mo.pureComputed((()=>this.column().disableEditData())))}function ka(e){this.viewSections=Za(this,e.viewSections,"parentId"),this.tabBarItem=Za(this,e.tabBar,"viewRef"),this.layoutSpecObj=Ql.jsonObservable(this.layoutSpec),this.activeSectionId=Hl.observableWithDefault(mo.observable(),(()=>!this.isDisposed()&&this.getRowId()&&this.viewSections().all().length>0?this.viewSections().at(0).getRowId():0)),this.activeSection=Qa(e.viewSections,this.activeSectionId),this._isActiveSectionGone=this.autoDispose(mo.computed((()=>this.activeSection()._isDeleted()))),this.autoDispose(this._isActiveSectionGone.subscribe((e=>{e&&this.activeSectionId(0)})))}const Ma=o(72827),Pa=o(87604),Aa=o(46402);class Oa extends r.Disposable{constructor(e,t){var o;super();const{srcSection:s,srcCol:i,srcColId:n,tgtSection:r,tgtCol:l,tgtColId:a}=t;this._srcSection=s,this._srcCol=i,this._srcColId=n,this._srcTableModel=e.dataTables[s.table().tableId()];const c=this._srcTableModel.tableData;if(a){const e=(0,Ze.isRefListType)(l.type())?"intersects":"in";"custom"===s.parentKey()?this.filterColValues=this._srcCustomFilter(a,e):this.filterColValues=n?this._srcCellFilter(a,e):this._simpleFilter(a,e,(e=>[e]))}else if(n&&(0,Ze.isRefListType)(i.type()))this.filterColValues=this._srcCellFilter("id","in");else if(!n&&function(e,t){const o=e.summarySourceTable();if(o===t.getRowId())return!0;const s=t.summarySourceTable();return Boolean(o)&&s===o&&e.getRowId()!==t.getRowId()&&J.isSubset(e.summarySourceColRefs(),t.summarySourceColRefs())}(s.table(),r.table())){let e=function(){const e={filters:{},operations:{}};if(s.isDisposed())return e;const i=s.activeRowId();for(const o of s.table().groupByColumns()){const s=o.colId(),n=c.getValue(i,s);e.filters[s]=[n],e.operations[s]="in",t&&(0,Ze.isListType)(o.summarySource().type())&&(e.operations[s]=n?"intersects":"empty")}o(e)};const t=s.table().summarySourceTable()===r.table().getRowId(),o=mo.observable();this.filterColValues=this.autoDispose(mo.computed((()=>o()))),this.autoDispose(c.dataLoadedEmitter.addListener(e)),e()}else if("custom"===s.parentKey())this.filterColValues=this._srcCustomFilter("id","in");else{const e=n?this._makeSrcCellGetter():Ma;if(e&&(this.cursorPos=this.autoDispose(mo.computed((()=>e(s.activeRowId()))))),!n){const e=null==(o=s.linkingState())?void 0:o.getDefaultColValues;e&&(this.getDefaultColValues=e)}}this.getDefaultColValues||(this.getDefaultColValues=()=>{if(!this.filterColValues)return{};const{filters:e,operations:t}=this.filterColValues.peek();return Pa(Aa(e,((e,t)=>e.length>0&&"id"!==t)),((e,o)=>"intersects"===t[o]?(0,_e.Cx)(e):e[0]))})}disableEditing(){return Boolean(this.filterColValues)&&"new"===this._srcSection.activeRowId()}_simpleFilter(e,t,o){return this.autoDispose(mo.computed((()=>{const s=this._srcSection.activeRowId();if(null===s)return console.warn("_simpleFilter activeRowId is null"),{filters:{},operations:{}};const i=o(s);return{filters:{[e]:i},operations:{[e]:t}}})))}_srcCellFilter(e,t){const o=this._makeSrcCellGetter();if(o){const s=(0,Ze.isRefListType)(this._srcCol.type());return this._simpleFilter(e,t,(e=>{const t=o(e);return s?(0,Ze.isList)(t)?t.slice(1):[]:[t]}))}}_srcCustomFilter(e,t){return this.autoDispose(mo.computed((()=>{const o=(0,r.toKo)(mo,this._srcSection.selectedRows)();return{filters:{[e]:o},operations:{[e]:t}}})))}_makeSrcCellGetter(){const e=this.autoDispose(this._srcTableModel.createFloatingRowModel()),t=e.cells[this._srcColId];return t?o=>(e.assign(o),"new"===o?"new":t()):null}}var Fa=o(21602),Ea=o(90098),Ba=o(48210),La=o(82882),$a=Object.defineProperty,Ua=Object.getOwnPropertySymbols,za=Object.prototype.hasOwnProperty,Va=Object.prototype.propertyIsEnumerable,Na=(e,t,o)=>t in e?$a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Wa=(e,t)=>{for(var o in t||(t={}))za.call(t,o)&&Na(e,o,t[o]);if(Ua)for(var o of Ua(t))Va.call(t,o)&&Na(e,o,t[o]);return e};const ja=o(52906);function Ha(e){this.viewFields=Za(this,e.viewFields,"parentId",{sortBy:"parentPos"}),this.columns=this.autoDispose(mo.pureComputed((()=>this.table().columns().all().filter((e=>!e.isHiddenCol()))))),this.editingFormula=mo.pureComputed({read:()=>e.editingFormula(),write:t=>{e.editingFormula(t)}});const t={verticalGridlines:!0,horizontalGridlines:!0,zebraStripes:!1,customView:"",numFrozen:0};this.optionsObj=Ql.jsonObservable(this.options,(e=>ja(e||{},t)));const o={mode:"url",url:null,widgetDef:null,access:"",pluginId:"",sectionId:""},s=Ql.jsonObservable(this.optionsObj.prop("customView"),(e=>ja(e||{},o)));this.customDef={mode:s.prop("mode"),url:s.prop("url"),widgetDef:s.prop("widgetDef"),widgetOptions:s.prop("widgetOptions"),columnsMapping:s.prop("columnsMapping"),access:s.prop("access"),pluginId:s.prop("pluginId"),sectionId:s.prop("sectionId")},this.selectedFields=mo.observable([]);const i=this.autoDispose(mo.pureComputed((()=>this.selectedFields().filter((e=>!e.isDisposed())).map((e=>e.column())).filter((e=>!e.isDisposed())))));this.columnsBehavior=mo.pureComputed((()=>{const e=new Set(i().map((e=>e.behavior())));return 1===e.size?e.values().next().value:"mixed"})),this.columnsType=mo.pureComputed((()=>{const e=new Set(i().map((e=>e.type())));return 1===e.size?e.values().next().value:"mixed"})),this.columnsAllIsFormula=mo.pureComputed((()=>i().every((e=>e.isFormula())))),this.activeCustomOptions=Ql.customValue(this.customDef.widgetOptions),this.saveCustomDef=async()=>{await s.save(),this.activeCustomOptions.revert()},this.themeDef=Ql.fieldWithDefault(this.theme,"form"),this.chartTypeDef=Ql.fieldWithDefault(this.chartType,"bar"),this.view=Qa(e.views,this.parentId),this.table=Qa(e.tables,this.tableRef),this.defaultWidgetTitle=this.autoDispose(mo.pureComputed((()=>{var e;const t="record"!==this.parentKey()?`${(0,Ea.a)(this.parentKey.peek()).label}`:"",o=this.table();return[null==(e=o.tableNameDef())?void 0:e.toUpperCase(),o.groupDesc(),t].filter((e=>Boolean(null==e?void 0:e.trim()))).join(" ")}))),this.titleDef=Ql.fieldWithDefault(this.title,this.defaultWidgetTitle),this.isRaw=this.autoDispose(mo.pureComputed((()=>this.table().rawViewSectionRef()===this.getRowId()))),this.borderWidthPx=mo.pureComputed((()=>this.borderWidth()+"px")),this.layoutSpecObj=Ql.jsonObservable(this.layoutSpec),this._savedFilters=Za(this,e.filters,"viewSectionRef"),this._unsavedFilters=new Map,this.filters=this.autoDispose(mo.computed((()=>{const e=new Map(this._savedFilters().all().map((e=>[e.colRef(),e]))),t=new Map(this.viewFields().all().map((e=>[e.origCol().getRowId(),e])));return this.columns().map((o=>{var s;const i=e.get(o.origColRef()),n=Ql.customComputed({read:()=>i?i.activeFilter():""}),r=Ql.customComputed({read:()=>!!i&&i.pinned()}),l=this._unsavedFilters.get(o.origColRef());if(l){const{filter:e,pinned:t}=l;void 0!==e&&n(e),void 0!==t&&r(t)}return{viewSection:this,filter:n,pinned:r,fieldOrColumn:null!=(s=t.get(o.origColRef()))?s:o,isFiltered:mo.pureComputed((()=>""!==n())),isPinned:mo.pureComputed((()=>r()))}}))}))),this.activeFilters=r.Computed.create(this,(e=>e(this.filters).filter((t=>e(t.isFiltered))))),this.pinnedActiveFilters=r.Computed.create(this,(e=>e(this.activeFilters).filter((t=>e(t.isPinned))))),this.filterSpecChanged=r.Computed.create(this,(e=>e(this.filters).some((t=>!e(t.filter.isSaved)||!e(t.pinned.isSaved))))),this.showNestedFilteringPopup=r.Observable.create(this,!1),this.saveFilters=()=>e.docData.bundleActions(`Save all filters in ${this.titleDef()}`,(async()=>{const t=new Map(this._savedFilters().all().map((e=>[e.colRef(),e]))),o=[],s=[],i=[];for(const e of this.filters()){const{fieldOrColumn:n,filter:r,pinned:l}=e;if(r.isSaved()&&l.isSaved())continue;const a=t.get(n.origCol().origColRef());if(a)""===r()?s.push(a.id()):o.push([a.id(),{filter:r(),pinned:l()}]);else{if(""===r())continue;i.push([n.origCol().origColRef(),{filter:r(),pinned:l()}])}}const n=[];s.length>0&&n.push(["BulkRemoveRecord",s]),o.length>0&&n.push(["BulkUpdateRecord",o.map((([e])=>e)),{filter:o.map((([,{filter:e}])=>e)),pinned:o.map((([,{pinned:e}])=>e))}]),i.length>0&&n.push(["BulkAddRecord",(0,J.arrayRepeat)(i.length,null),{viewSectionRef:(0,J.arrayRepeat)(i.length,this.id()),colRef:i.map((([e])=>e)),filter:i.map((([,{filter:e}])=>e)),pinned:i.map((([,{pinned:e}])=>e))}]),n.length>0&&await e.filters.sendTableActions(n),this.revertFilters()})),this.revertFilters=()=>{this._unsavedFilters.clear(),this.filters().forEach((e=>{e.filter.revert(),e.pinned.revert()}))},this.setFilter=(e,t)=>{this._unsavedFilters.set(e,Wa(Wa({},this._unsavedFilters.get(e)),t));const o=this.filters().find((t=>t.fieldOrColumn.origCol().origColRef()===e));if(!o)return;const{filter:s,pinned:i}=t;void 0!==s&&o.filter(s),void 0!==i&&o.pinned(i)},this.revertFilter=e=>{this._unsavedFilters.delete(e);const t=this.filters().find((t=>t.fieldOrColumn.origCol().origColRef()===e));t&&(t.filter.revert(),t.pinned.revert())},this.activeSortJson=Ql.customValue(this.sortColRefs),this.activeSortSpec=Ql.jsonObservable(this.activeSortJson,(t=>(t||[]).filter((t=>{const o=e.columns.getRowModel(Ba.Sort.getColRef(t));return!o._isDeleted()&&o.getRowId()})))),this.activeDisplaySortSpec=this.autoDispose(mo.computed((()=>this.activeSortSpec().map((e=>{const t=Ba.Sort.getColRef(e),o=this.viewFields().all().find((e=>e.column().origColRef()===t)),s=o?o.displayColRef():t;return Ba.Sort.swapColRef(e,s)}))))),this.hiddenColumns=this.autoDispose(mo.pureComputed((()=>{const e=new Set(this.viewFields().all().map((e=>e.column().origColRef())));return this.columns().filter((t=>!e.has(t.getRowId())))}))),this.hasFocus=mo.pureComputed({read:()=>!this.isDisposed()&&this.view().activeSectionId()===this.id(),write:e=>{this.view().activeSectionId(e?this.id():0)}}),this.activeLinkSrcSectionRef=Ql.customValue(this.linkSrcSectionRef),this.activeLinkSrcColRef=Ql.customValue(this.linkSrcColRef),this.activeLinkTargetColRef=Ql.customValue(this.linkTargetColRef),this.isActiveLinkSaved=this.autoDispose(mo.pureComputed((()=>this.activeLinkSrcSectionRef.isSaved()&&this.activeLinkSrcColRef.isSaved()&&this.activeLinkTargetColRef.isSaved()))),this.linkSrcSection=Qa(e.viewSections,this.activeLinkSrcSectionRef),this.linkSrcCol=Qa(e.columns,this.activeLinkSrcColRef),this.linkTargetCol=Qa(e.columns,this.activeLinkTargetColRef),this.activeRowId=mo.observable(null),this._linkingState=r.Holder.create(this),this.linkingState=this.autoDispose(mo.pureComputed((()=>{if(!this.activeLinkSrcSectionRef())return null;try{const t=new Fa.vH(this);return Oa.create(this._linkingState,e,t)}catch(e){return console.warn(e),this._linkingState.dispose(),null}}))),this.linkingFilter=this.autoDispose(mo.pureComputed((()=>{var e,t;return(null==(t=null==(e=this.linkingState())?void 0:e.filterColValues)?void 0:t.call(e))||{filters:{},operations:{}}}))),this.viewInstance=mo.observable(null),this.lastCursorPos={rowId:0,fieldIndex:0},this.lastScrollPos={rowIndex:0,offset:0,scrollLeft:0},this.disableAddRemoveRows=mo.pureComputed((()=>this.table().disableAddRemoveRows())),this.isSorted=mo.pureComputed((()=>this.activeSortSpec().length>0)),this.disableDragRows=mo.pureComputed((()=>this.isSorted()||!this.table().supportsManualSort())),this.rawNumFrozen=Ql.customValue(this.optionsObj.prop("numFrozen")),this.numFrozen=mo.pureComputed((()=>Math.max(0,Math.min(this.rawNumFrozen(),this.viewFields().all().length-1)))),this.hasCustomOptions=mo.observable(!1),this.desiredAccessLevel=mo.observable(null),this.columnsToMap=mo.observable(null),this.mappedColumns=mo.pureComputed((()=>{const e=this.columnsToMap(),t=this.customDef.columnsMapping();if(!e||!t)return null;const o=e.map((e=>new La.V(e))),s={},i=new Map(this.columns().map((e=>[e.id.peek(),e])));for(const e of o){s[e.name]=e.allowMultiple?[]:null;const o=t[e.name];if(o)if(e.allowMultiple){if(!Array.isArray(o))continue;s[e.name]=o.filter((e=>i.has(e))).filter((t=>e.canByMapped(i.get(t).pureType()))).map((e=>i.get(e).colId()))}else{if(Array.isArray(o)||!i.has(o))continue;const t=i.get(o);s[e.name]=e.canByMapped(t.pureType())?t.colId():null}}return s})),this.allowSelectBy=r.Observable.create(this,!1),this.selectedRows=r.Observable.create(this,[]),this.tableId=this.autoDispose(mo.pureComputed((()=>this.table().tableId())));const n=this.autoDispose(mo.pureComputed((()=>this.table().rawViewSection())));this.rulesCols=ec(e.columns,mo.pureComputed((()=>n().rules()))),this.rulesColsIds=mo.pureComputed((()=>this.rulesCols().map((e=>e.colId())))),this.rulesStyles=Ql.savingComputed({read:()=>{var e;return null!=(e=n().optionsObj.prop("rulesOptions")())?e:[]},write:(e,t)=>e(n().optionsObj.prop("rulesOptions"),t)}),this.hasRules=mo.pureComputed((()=>this.rulesCols().length>0)),this.addEmptyRule=async()=>{const t=["AddEmptyRule",this.tableId.peek(),null,null];await e.docData.sendAction(t,`Update rules for ${this.table.peek().tableId.peek()}`)},this.removeRule=t=>ha(e,this,t)}function Ga(e){this.hidden=mo.pureComputed((()=>(0,Ze.isCensored)(this.content()))),this.column=Qa(e.columns,this.colRef),this.table=Qa(e.tables,this.tableRef),this.parent=Qa(e.cells,this.parentId),this.children=Za(this,e.cells,"parentId");const t=Ql.savingComputed({read:()=>this.hidden()?"{}":this.content(),write:(e,t)=>e(this.content,t)}),o=(0,Ql.jsonObservable)(t);this.text=o.prop("text"),this.userName=o.prop("userName"),this.timeCreated=o.prop("timeCreated"),this.timeUpdated=o.prop("timeUpdated"),this.resolved=o.prop("resolved"),this.resolvedBy=o.prop("resolvedBy")}var Ka=Object.defineProperty,Ja=Object.getOwnPropertySymbols,qa=Object.prototype.hasOwnProperty,Xa=Object.prototype.propertyIsEnumerable,Ya=(e,t,o)=>t in e?Ka(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;function Za(e,t,o,s){const i=((e,t)=>{for(var o in t||(t={}))qa.call(t,o)&&Ya(e,o,t[o]);if(Ja)for(var o of Ja(t))Xa.call(t,o)&&Ya(e,o,t[o]);return e})({groupBy:o,sortBy:"id"},s);return Hl.computedAutoDispose((()=>t.createRowGroupModel(e.id()||0,i)),null,{pure:!0})}function Qa(e,t){return mo.pureComputed((()=>e.getRowModel(t()||0,!0)))}function ec(e,t){return mo.pureComputed((()=>{const o=(0,_e.xD)(t());return Array.isArray(o)?o.map((t=>e.getRowModel(t,!0))):[]}))}class tc{constructor(e){this.docData=e,this.docInfo=this._metaTableModel("_grist_DocInfo",ia),this.tables=this._metaTableModel("_grist_Tables",da),this.columns=this._metaTableModel("_grist_Tables_column",oa),this.views=this._metaTableModel("_grist_Views",ka),this.viewSections=this._metaTableModel("_grist_Views_section",Ha),this.viewFields=this._metaTableModel("_grist_Views_section_field",Ta),this.tabBar=this._metaTableModel("_grist_TabBar",la),this.validations=this._metaTableModel("_grist_Validations",ua),this.pages=this._metaTableModel("_grist_Pages",ra),this.rules=this._metaTableModel("_grist_ACLRules",Zl),this.filters=this._metaTableModel("_grist_Filters",na),this.cells=this._metaTableModel("_grist_Cells",Ga),this.dataTables={},this.dataTablesByRef=new Map,this.allTabs=this.tabBar.createAllRowsModel("tabPos"),this.editingFormula=mo.observable(!1),this.showDocTourTable="GristDocTour"===(0,fn.urlState)().state.get().docPage;for(const e of this._metaTables)e.loadData();var t;this.docInfoRow=this.docInfo.getRowModel(1),this.visibleTables=oc(t=this.tables,(e=>!(0,Yl.Pr)(t.tableData,e))),this.rawDataTables=function(e){return oc(e,(t=>!(0,Yl.$U)(e.tableData,t)))}(this.tables),this.rawSummaryTables=function(e){return oc(e,(t=>(0,Yl.$U)(e.tableData,t)))}(this.tables);const o=mo.computed((()=>this.visibleTables.all().map((e=>e.tableId()))));this.visibleTableIds=go.syncedKoArray(o),this.tables.createAllRowsModel("id").subscribeForEach({add:e=>this._onAddTable(e),remove:e=>this._onRemoveTable(e)});const s=this.pages.createAllRowsModel("pagePos");this.menuPages=mo.computed((()=>{const e=s.all().filter((e=>!e.isSpecial())).sort(((e,t)=>e.pagePos()-t.pagePos())),t=jl()((t=>{const o=e.slice(e.indexOf(t)+1),s=o.findIndex((e=>e.indentation()<=t.indentation()));return s>=0?o.slice(0,s):o})),o=jl()((e=>e.isCensored()&&t(e).every((e=>o(e)))));return e.filter((e=>!o(e)))})),this.visibleDocPages=mo.computed((()=>s.all().filter((e=>!e.isHidden()))))}_metaTableModel(e,t){const o=Object.keys(Fl.f[e]),s=new(ql())(this,this.docData.getTable(e),o,t);return this._metaTables||(this._metaTables=[]),this._metaTables.push(s),s}_onAddTable(e){let t=e.tableId();const o=new(Kl())(this,this.docData.getTable(t),e);this.dataTables[t]=o,this.dataTablesByRef.set(e.getRowId(),o),e.tableId.subscribe((e=>{this.dataTables[e]=this.dataTables[t],delete this.dataTables[t],t=e}))}_onRemoveTable(e){const t=e.tableId();this.dataTables[t].dispose(),delete this.dataTables[t],this.dataTablesByRef.delete(e.getRowId())}}function oc(e,t=(e=>!0)){const o=new Xl.FilteredRowSource(t);return o.subscribeTo(e),e._createRowSetModel(o,"tableId")}var sc=o(25192),ic=o(88748),nc=o(98108),rc=o(88261),lc=o(45689),ac=o(60611),cc=o.n(ac),dc=Object.defineProperty,uc=Object.defineProperties,hc=Object.getOwnPropertyDescriptors,pc=Object.getOwnPropertySymbols,mc=Object.prototype.hasOwnProperty,gc=Object.prototype.propertyIsEnumerable,fc=(e,t,o)=>t in e?dc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,wc=(e,t)=>{for(var o in t||(t={}))mc.call(t,o)&&fc(e,o,t[o]);if(pc)for(var o of pc(t))gc.call(t,o)&&fc(e,o,t[o]);return e},bc=(e,t)=>uc(e,hc(t));const vc=(0,q.makeT)("DocHistory"),_c=(0,lc.U)("activity","snapshots");class yc extends r.Disposable{constructor(e,t){super(),this._docPageModel=e,this._actionLog=t,this._subTab=(0,yl.h4)(this,"docHistorySubTab","snapshots",_c.guard)}buildDom(){const e=[{value:"activity",label:vc("Activity")},{value:"snapshots",label:vc("Snapshots")}];return[xc((0,rc.buttonSelect)(this._subTab,e,{},(0,s.testId)("doc-history-tabs"))),r.dom.domComputed(this._subTab,(e=>(0,nc.lX)("activity"===e?this._actionLog.buildDom():"snapshots"===e?r.dom.create(this._buildSnapshots.bind(this)):null)))]}_buildSnapshots(e){var t;const o=this._docPageModel.currentDoc.get();if(!o)return null;const l=(0,Oo.L3)(bc(wc({},o.idParts),{snapshotId:void 0})),a=null==(t=(0,fn.urlState)().state.get().params)?void 0:t.compare,c=a&&(0,Oo.wA)(a).snapshotId;function d(e,t){return r.dom.attr("href",(o=>(0,fn.urlState)().makeUrl(bc(wc({},o((0,fn.urlState)().state)),{doc:e.docId,params:t?{compare:t}:{}}))))}const u=r.Observable.create(e,[]),h=r.Observable.create(e,!1);return this._docPageModel.appModel.api.getDocAPI(l).getSnapshots().then((e=>u.isDisposed()||u.set(e.snapshots))).catch((e=>{h.set(!0),(0,ge.reportError)(e)})),(0,r.dom)("div",r.dom.maybe(h,(()=>Cc(vc("Snapshots are unavailable."),(0,s.testId)("doc-history-error")))),r.dom.domComputed(u,(e=>e.map(((t,a)=>{const u=cc()(t.lastModified),h=e[a+1]||null;return Sc(Ic((0,ic.i0)(t.lastModified)),Rc(Rc.cls("-current",Boolean(t.snapshotId===o.idParts.snapshotId||c&&t.snapshotId===c)),(0,r.dom)("div",Dc(u.format("ddd ll"))," ",Dc(u.format("LT"))),Tc((0,i.icon)("Dots"),(0,n.menu)((()=>[(0,n.menuItemLink)(d(t),vc("Open Snapshot")),(0,n.menuItemLink)(d(t,l),vc("Compare to Current"),(0,n.menuAnnotate)(vc("Beta"))),h&&(0,n.menuItemLink)(d(h,t.docId),vc("Compare to Previous"),(0,n.menuAnnotate)(vc("Beta")))]),{placement:"bottom-end",parentSelectorToMark:"."+Rc.className}),(0,s.testId)("doc-history-snapshot-menu")),(0,s.testId)("doc-history-card")),(0,s.testId)("doc-history-snapshot"))})))))}}const xc=(0,r.styled)("div",`\n  padding: 16px;\n  border-bottom: 1px solid ${s.theme.pagePanelsBorder};\n`),Sc=(0,r.styled)("div","\n  margin: 8px 16px;\n"),Cc=(0,r.styled)("div","\n  margin: 8px 16px;\n"),Ic=(0,r.styled)("div",`\n  text-align: right;\n  color: ${s.theme.lightText};\n  font-size: ${s.vars.smallFontSize};\n`),Rc=(0,r.styled)("div",`\n  border: 1px solid ${s.theme.documentHistorySnapshotBorder};\n  padding: 8px;\n  color: ${s.theme.documentHistorySnapshotFg};\n  background: ${s.theme.documentHistorySnapshotBg};\n  border-radius: 8px;\n  overflow: hidden;\n  display: flex;\n  align-items: center;\n  --icon-color: ${s.theme.controlSecondaryFg};\n\n  &-current {\n    background-color: ${s.theme.documentHistorySnapshotSelectedBg};\n    color: ${s.theme.documentHistorySnapshotSelectedFg};\n    --icon-color: ${s.theme.documentHistorySnapshotSelectedFg};\n  }\n`),Dc=(0,r.styled)("span","\n  display: inline-block;\n"),Tc=(0,r.styled)("div",`\n  flex: none;\n  margin: 0 4px 0 auto;\n  height: 24px;\n  width: 24px;\n  padding: 4px;\n  line-height: 0px;\n  border-radius: 3px;\n  cursor: default;\n  &:hover, &.weasel-popup-open {\n    background-color: ${s.theme.hover};\n  }\n`);var kc=o(64985),Mc=o(84602),Pc=o(84418),Ac=o(50733),Oc=o(39764);const Fc=o(49268),Ec=(0,q.makeT)("OnBoardingPopups"),Bc=(0,r.makeTestId)("test-onboarding-"),Lc=r.Holder.create(null);function $c(e,t){Vc.create(Lc,e,t).start().catch(ge.reportError)}class Uc extends Error{constructor(e){super(e),this.name="OnBoardingError"}}let zc=0;class Vc extends r.Disposable{constructor(e,t){if(super(),this._messages=e,this._onFinishCB=t,this._arrowEl=jc((0,r.svg)("svg",{style:"width: 13px; height: 34px;"},(0,r.svg)("path",{d:"M 2 19 h 13 v 18 Z"}))),0===this._messages.length)throw new Uc("messages should not be an empty list");zc=Math.min(zc,this._messages.length-1),this.onDispose((()=>{var e;null==(e=this._openPopupCtl)||e.close()}))}async start(){this._showOverlay(),await this._move(0),Ac.setPaused(!0),this.onDispose((()=>{Ac.setPaused(!1)}))}_finish(){this._onFinishCB(),this.dispose()}async _move(e,t=!1){var o;const s=zc+e,i=this._messages[s];i?(zc=s,i.skip?await this._move(e||1):(null==(o=this._openPopupCtl)||o.close(),i.urlState&&(await(0,fn.urlState)().pushUrl(i.urlState),await(0,Oc.g)(100)),i.showHasModal?this._showHasModal():await this._showHasPopup(e))):t&&(zc=0,this._finish())}async _showHasPopup(e){const t=this._buildPopupContent(),o=this._messages[zc],s=document.querySelector(o.selector),{placement:i}=o;if(!s)return console.warn(`On boarding tour: element ${o.selector} not found!`),this._move(e||1);this._openPopupCtl={close:function(){l.destroy(),r.dom.domDispose(t),t.remove()}},document.body.appendChild(t),this._addFocusLayer(t);const n=o.cropPadding?this._getAdjacentPadding(s,i):0,l=(0,Pc.fi)(s,t,{placement:i,modifiers:[{name:"arrow",options:{element:this._arrowEl}},{name:"offset",options:{offset:[0,12-n]}}]})}_addFocusLayer(e){r.dom.autoDisposeElem(e,new xs.FocusLayer({defaultFocusElem:e,allowFocus:e=>e!==document.body}))}_getAdjacentPadding(e,t){if(t){let o="";if(t.includes("bottom")?o=getComputedStyle(e).paddingBottom:t.includes("top")?o=getComputedStyle(e).paddingTop:t.includes("left")?o=getComputedStyle(e).paddingLeft:t.includes("right")&&(o=getComputedStyle(e).paddingRight),o&&o.endsWith("px"))return Number(o.slice(0,o.length-2))}return 0}_showHasModal(){const e=this._buildPopupContent();r.dom.update(this._overlay,e),this._addFocusLayer(e),this._openPopupCtl={close:function(){e.remove(),r.dom.domDispose(e)}}}_buildPopupContent(){return Nc({tabindex:"-1"},this._arrowEl,Hc((0,Mc.Ot)((0,Mc.gQ)("CrossBig"),r.dom.on("click",(()=>this._finish())),Bc("close")),Yc(this._messages[zc].title),Zc(this._messages[zc].body),this._buildFooter(),Bc("popup")),r.dom.onKeyDown({Escape:()=>this._finish(),ArrowLeft:()=>this._move(-1),ArrowRight:()=>this._move(1),Enter:()=>this._move(1,!0)}))}_buildFooter(){const e=this._messages.length,t=zc===e-1,o=0===zc;return Gc(Kc(Fc(e).map((e=>qc(qc.cls("-done",e>zc))))),Jc((0,we.bigBasicButton)("Previous",Bc("previous"),r.dom.on("click",(()=>this._move(-1))),r.dom.prop("disabled",o),{style:"margin-right: 8px; visibility: "+(o?"hidden":"visible")}),(0,we.bigPrimaryButton)(Ec(t?"Finish":"Next"),Bc("next"),r.dom.on("click",(()=>this._move(1,!0))))))}_showOverlay(){document.body.appendChild(this._overlay=Xc()),this.onDispose((()=>{document.body.removeChild(this._overlay),r.dom.domDispose(this._overlay)}))}}const Nc=(0,r.styled)("div",`\n  align-self: center;\n  border: 2px solid ${s.theme.accentBorder};\n  border-radius: 3px;\n  z-index: 1000;\n  max-width: 490px;\n  position: relative;\n  background-color: ${s.theme.popupBg};\n  box-shadow: 0 2px 18px 0 ${s.theme.popupInnerShadow}, 0 0 1px 0 ${s.theme.popupOuterShadow};\n  outline: unset;\n`);function Wc(e){return`.${Nc.className}[data-popper-placement^=${e}]`}const jc=(0,r.styled)("div",`\n  position: absolute;\n\n  & path {\n    stroke: ${s.theme.accentBorder};\n    stroke-width: 2px;\n    fill: ${s.theme.popupBg};\n  }\n\n  ${Wc("top")} > & {\n    bottom: -26px;\n  }\n\n  ${Wc("bottom")} > & {\n    top: -23px;\n  }\n\n  ${Wc("right")} > & {\n    left: -12px;\n  }\n\n  ${Wc("left")} > & {\n    right: -12px;\n  }\n\n  ${Wc("top")} svg {\n    transform: rotate(-90deg);\n  }\n\n  ${Wc("bottom")} svg {\n    transform: rotate(90deg);\n  }\n\n  ${Wc("left")} svg {\n    transform: scalex(-1);\n  }\n`),Hc=(0,r.styled)("div",`\n  position: relative;\n  padding: 32px;\n  background-color: ${s.theme.popupBg};\n`),Gc=(0,r.styled)("div","\n  display: flex;\n  flex-direction: row;\n  margin-top: 32px;\n  justify-content: space-between;\n  align-items: center;\n"),Kc=(0,r.styled)("div","\n  display: flex;\n  flex-direction: row;\n  flex-wrap: wrap;\n  row-gap: 12px;\n"),Jc=(0,r.styled)("div","\n  display: flex;\n  flex-directions: row;\n"),qc=(0,r.styled)("div",`\n  width: 6px;\n  height: 6px;\n  border-radius: 3px;\n  margin-right: 12px;\n  align-self: center;\n  background-color: ${s.theme.progressBarFg};\n  &-done {\n    background-color: ${s.theme.progressBarBg};\n  }\n`),Xc=(0,r.styled)("div","\n  position: fixed;\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  width: 100%;\n  height: 100%;\n  top: 0;\n  left: 0;\n  z-index: 999;\n  overflow-y: auto;\n"),Yc=(0,r.styled)("div",`\n  font-size: ${s.vars.xxxlargeFontSize};\n  font-weight: ${s.vars.headerControlTextWeight};\n  color: ${s.theme.text};\n  margin: 0 0 16px 0;\n  line-height: 32px;\n`),Zc=(0,r.styled)("div",`\n  color: ${s.theme.text};\n`),Qc=["ChartArea","ChartBar","ChartDonut","ChartKaplan","ChartLine","ChartPie","TypeCard","TypeCardList","TypeCell","TypeChart","TypeCustom","TypeDetails","TypeTable","FieldAny","FieldAttachment","FieldCheckbox","FieldChoice","FieldColumn","FieldDate","FieldDateTime","FieldFunction","FieldFunctionEqual","FieldInteger","FieldLink","FieldNumeric","FieldReference","FieldSpinner","FieldSwitcher","FieldTable","FieldText","FieldTextbox","FieldToggle","LoginStreamline","LoginUnify","LoginVisualize","GoogleLogo","GristLogo","ThumbPreview","AddUser","BarcodeQR","BarcodeQR2","CenterAlign","Chat","Code","Collapse","Convert","Copy","CrossBig","CrossSmall","Database","Dots","Download","DragDrop","Dropdown","DropdownUp","Empty","Expand","EyeHide","EyeShow","Feedback","Filter","FilterSimple","Fireworks","Folder","FontBold","FontItalic","FontStrikethrough","FontUnderline","FunctionResult","Grow","Help","Home","Idea","Import","ImportArrow","Info","LeftAlign","Lock","Log","Mail","Memo","Message","Minus","MobileChat","MobileChat2","NewNotification","Notification","Offline","Page","PanelLeft","PanelRight","Pencil","PinBig","PinSmall","PinTilted","Pivot","PivotLight","Plus","Popup","Public","PublicColor","PublicFilled","Redo","Remove","Repl","ResizePanel","Revert","RightAlign","Script","Search","Settings","Share","Sort","Sparks","Tick","TickSolid","Undo","Validation","Video","Warning","Widget","Wrap","Zoom","UseChart","UseEducate","UseFinance","UseHr","UseMedia","UseMonitor","UseOther","UseProduct","UseSales","UseScience"];var ed=Object.defineProperty,td=Object.defineProperties,od=Object.getOwnPropertyDescriptors,sd=Object.getOwnPropertySymbols,id=Object.prototype.hasOwnProperty,nd=Object.prototype.propertyIsEnumerable,rd=(e,t,o)=>t in e?ed(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const ld=o(91944),ad=(0,q.makeT)("DocTour");async function cd(e,t,o){const i=await async function(e,t){const o="GristDocTour";if(!e.getTable(o))return null;await t.waitForInitialization(),await e.fetchTable(o);const i=e.getTable(o),n=ld(i.getRowIds(),i.getRowPropFunc("manualSort")).map((e=>{function t(t){return String(i.getValue(e,t)||"")}const o=t("Title");let n=t("Body");const l=t("Link_Text"),a=t("Link_URL"),c=t("Link_Icon"),d=t("Location");let u=t("Placement");if(!o&&!n)return null;const h=(0,fn.sameDocumentUrlState)(d);!(0,s.isNarrowScreen)()&&kc.Ct.includes(u)||(u="auto");let p=!0;try{new URL(a)}catch(e){p=!1}return p&&l&&(n=(0,r.dom)("div",(0,r.dom)("p",n),(0,r.dom)("p",(0,Mc.ED)((0,Mc.ct)(Qc.includes(c)?(0,Mc.K1)(c):null,l,{href:a,target:"_blank"}))))),{title:o,body:n,placement:u,urlState:h,selector:".active_cursor",showHasModal:!(null==h?void 0:h.hash)}})).filter((e=>null!==e));return n.length?n:null}(e,t)||dd;!function(e){window._gristDocTour=()=>e.map((e=>{var t,o,s,i;return s=((e,t)=>{for(var o in t||(t={}))id.call(t,o)&&rd(e,o,t[o]);if(sd)for(var o of sd(t))nd.call(t,o)&&rd(e,o,t[o]);return e})({},e),i={body:"string"==typeof e.body?e.body:null==(t=e.body)?void 0:t.outerHTML.replace(/_grain\d+_/g,"_grainXXX_"),urlState:null==(o=e.urlState)?void 0:o.hash},td(s,od(i))}))}(i),$c(i,o)}const dd=[{title:ad("No valid document tour"),body:ad("Cannot construct a document tour from the data in this document. Ensure there is a table named GristDocTour with columns Title, Body, Placement, and Location."),selector:"document",showHasModal:!0}];var ud=o(22641);const hd=[{title:"Editing Data",body:()=>[(0,r.dom)("p","Double-click or hit ",gd(pd("Enter"))," on a cell to edit it. ","Start with ",gd(md("="))," to enter a formula.")],selector:".field_clip",placement:"bottom"},{selector:".tour-creator-panel",title:"Configuring your document",body:()=>[(0,r.dom)("p","Toggle the ",(0,r.dom)("em","creator panel")," to format columns, ","convert to card view, select data, and more.")],placement:"left",cropPadding:!0},{selector:".tour-type-selector",title:"Customizing columns",body:()=>[(0,r.dom)("p","Set formatting options, formulas, or column types, such as dates, choices, or attachments. "),(0,r.dom)("p","Make it relational! Use the ",gd("Reference")," type to link tables. ")],placement:"right"},{selector:".tour-add-new",title:"Building up",body:()=>[(0,r.dom)("p","Use ",gd("Add New")," to add widgets, pages, or import more data. ")],placement:"right"},{selector:".tour-share-icon",title:"Sharing",body:()=>[(0,r.dom)("p","Use the Share button (",fd("Share"),") to share the document or export data.")],placement:"bottom",cropPadding:!0},{selector:".tour-help-center",title:"Flying higher",body:()=>[(0,r.dom)("p","Use ",gd(wd("Help"),"Help Center")," for documentation or questions.")],placement:"right"},{selector:".tour-welcome",title:"Welcome to Grist!",body:()=>[(0,r.dom)("p","Browse our ",(0,Zo.Y3)({target:"_blank",href:(0,fn.urlState)().makeUrl({homePage:"templates"})},"template library",bd("FieldLink")),"to discover what's possible and get inspired.")],showHasModal:!0}];const pd=(0,r.styled)("span",`\n  font-style: normal;\n  font-family: inherit;\n  color: ${s.theme.shortcutKeyPrimaryFg};\n`),md=(0,r.styled)(pd,"\n  font-weight: 700;\n"),gd=(0,r.styled)("div",`\n  display: inline-block;\n  padding: 2px 5px;\n  border-radius: 4px;\n  margin: 0px 2px;\n  border: 1px solid ${s.theme.shortcutKeyBorder};\n  color: ${s.theme.shortcutKeyFg};\n  background-color: ${s.theme.shortcutKeyBg};\n  font-family: inherit;\n  font-style: normal;\n  white-space: nowrap;\n`),fd=(0,r.styled)(i.icon,`\n  --icon-color: ${s.theme.topBarButtonPrimaryFg};\n`),wd=(0,r.styled)(i.icon,`\n  --icon-color: ${s.theme.shortcutKeySecondaryFg};\n  margin-right: 8px;\n`),bd=(0,r.styled)(i.icon,"\n  margin: -3px 8px 0 4px;\n");var vd=o(85837),_d=Object.defineProperty,yd=Object.defineProperties,xd=Object.getOwnPropertyDescriptors,Sd=Object.getOwnPropertySymbols,Cd=Object.prototype.hasOwnProperty,Id=Object.prototype.propertyIsEnumerable,Rd=(e,t,o)=>t in e?_d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Dd=(e,t)=>{for(var o in t||(t={}))Cd.call(t,o)&&Rd(e,o,t[o]);if(Sd)for(var o of Sd(t))Id.call(t,o)&&Rd(e,o,t[o]);return e},Td=(e,t)=>yd(e,xd(t));const kd=o(24843),Md=o(36812),Pd=(0,q.makeT)("GristDoc"),Ad=(0,$o.get)("document","window"),Od=(0,lc.U)("none","docHistory","validations","discussion");class Fd extends Do.G{constructor(e,t,o,i,n,l={}){super(),this.app=e,this.docComm=t,this.docPageModel=o,this.isReadonly=this.docPageModel.isReadonly,this.isReadonlyKo=(0,r.toKo)(mo,this.isReadonly),this.resizeEmitter=this.autoDispose(new r.Emitter),this.fieldEditorHolder=r.Holder.create(this),this.activeEditor=r.Observable.create(this,null),this.userOrgPrefs=(0,Lo.getUserOrgPrefsObs)(this.docPageModel.appModel),this.behavioralPromptsManager=this.docPageModel.appModel.behavioralPromptsManager,this.sectionInPopup=r.Observable.create(this,null),this._lastOwnActionGroup=null,this._rightPanelTabs=new Map,this._rightPanelTool=(0,yl.h4)(this,"rightPanelTool","none",Od.guard),this._viewLayout=null,this._showGristTour=(0,Lo.getUserOrgPrefObs)(this.userOrgPrefs,"showGristTour"),this._seenDocTours=(0,Lo.getUserOrgPrefObs)(this.userOrgPrefs,"seenDocTours"),this._rawSectionOptions=r.Observable.create(this,null),console.log("RECEIVED DOC RESPONSE",i),this.docData=new Vl(this.docComm,i.doc),this.docModel=new tc(this.docData),this.querySetManager=sc.QuerySetManager.create(this,this.docModel,this.docComm),this.docPluginManager=new vl(n,e.topAppModel.getUntrustedContentOrigin(),this.docComm,e.clientScope),this.docInfo=this.docModel.docInfoRow,this.hasDocTour=r.Computed.create(this,(e=>e(this.docModel.visibleTableIds.getObservable()).includes("GristDocTour")));const a=this.docInfo.newDefaultViewId;this.activeViewId=r.Computed.create(this,(e=>{const{docPage:t}=e((0,fn.urlState)().state);return"string"==typeof t&&"GristDocTour"!==t&&Oo.VP.guard(t)?t:this.docModel.views.tableData.findRow("GristDocTour"===t?"name":"id",t)||e(a)})),this._activeContent=r.Computed.create(this,(e=>{var t;return null!=(t=e(this._rawSectionOptions))?t:e(this.activeViewId)})),this.viewModel=this.autoDispose(this.docModel.views.createFloatingRowModel((0,r.toKo)(mo,this.activeViewId))),this.autoDispose(this.viewModel.activeSectionId.subscribe((()=>{var e,t;this.sectionInPopup.set(null),(null==(e=this._viewLayout)?void 0:e.isDisposed())||null==(t=this._viewLayout)||t.maximized.set(null)}))),this.currentPageName=r.Computed.create(this,this.activeViewId,((e,t)=>"number"==typeof t?e(this.viewModel.name):t)),this.autoDispose(this.viewModel._isDeleted.subscribe((e=>{e&&Promise.resolve().then((()=>(0,fn.urlState)().pushUrl({docPage:void 0}))).catch((()=>null))}))),this.autoDispose((0,r.subscribe)((0,fn.urlState)().state,(async(e,t)=>{if(t.hash)try{if(t.hash.popup)await this.openPopup(t.hash);else{const e=this._getCursorPosFromHash(t.hash);await this.recursiveMoveToCursorPos(e,!0)}}catch(e){(0,Cs.eK)(e)}finally{setTimeout(Ed,0)}})));let c=!1;this.autoDispose((0,r.subscribe)((0,fn.urlState)().state,(async(e,t)=>{var o,i;if((0,s.isNarrowScreen)())return;if("light"===(null==(o=t.params)?void 0:o.style))return;if(c||!Lc.isEmpty())return;const n=this.hasDocTour.get()&&!(null==(i=this._seenDocTours.get())?void 0:i.includes(this.docId())),r=t.docTour||n;if(t.welcomeTour||this._shouldAutoStartWelcomeTour()||r){c=!0;try{if(await this._waitForView(),await(0,fn.urlState)().pushUrl({welcomeTour:!1,docTour:!1},{replace:!0,avoidReload:!0}),r){const e=()=>n&&(0,Lo.markAsSeen)(this._seenDocTours,this.docId());await cd(this.docData,this.docComm,e)}else l=()=>this._showGristTour.set(!1),Po.allCommands.fieldTabOpen.run(),$c(hd,l)}finally{c=!1}}var l})));const d=e=>ds.create(this,e,!0),u=_l.j.fromArray(this.docPluginManager.pluginsList),h=[{label:Pd("Import from file"),action:()=>Vs.selectAndImport(this,u,null,d)},...u.map((e=>({label:e.importSource.label,action:()=>Vs.selectAndImport(this,u,e,d)})))];this.docPageModel.importSources=h,this._actionLog=this.autoDispose(Io.create({gristDoc:this})),this._undoStack=this.autoDispose(gl.create(i.log,{gristDoc:this})),this._docHistory=yc.create(this,this.docPageModel,this._actionLog),this._discussionPanel=vd.un.create(this,this),this.autoDispose(this.docData.sendActionsEmitter.addListener(this._onSendActionsStart,this)),this.autoDispose(this.docData.sendActionsDoneEmitter.addListener(this._onSendActionsEnd,this)),this.autoDispose(Po.createGroup({undo(){this._undoStack.sendUndoAction().catch(Cs.eK)},redo(){this._undoStack.sendRedoAction().catch(Cs.eK)},reloadPlugins(){this.docComm.reloadPlugins().then((()=>Ad.window.location.reload(!1)))}},this,!0)),this.listenTo(e.comm,"docUserAction",this.onDocUserAction),this.listenTo(e.comm,"docUsage",this.onDocUsageMessage),this.autoDispose(qo.create({gristDoc:this})),this.rightPanelTool=r.Computed.create(this,(e=>this._getToolContent(e(this._rightPanelTool)))),this.comparison=l.comparison||null,this.autoDispose(r.dom.onElem(window,"dragover",(e=>e.preventDefault()))),this.autoDispose(r.dom.onElem(window,"drop",(e=>e.preventDefault()))),this.autoDispose(r.dom.onElem(window,"resize",(()=>this.resizeEmitter.emit()))),this.currentView=r.Observable.create(this,null);const p=(0,r.fromKo)(this.autoDispose(mo.pureComputed((()=>{const e=(0,r.toKo)(mo,this.activeViewId)();return(0,Oo.NZ)(e)?this.viewModel.activeSection().viewInstance():null}))));this.autoDispose(p.addListener((async e=>{e&&await e.getLoadingDonePromise(),(null==e?void 0:e.isDisposed())||this.currentView.set(e)}))),this.cursorPosition=r.Computed.create(this,(e=>{const t=e(this.currentView);if(!t)return;const o=e(this.activeViewId);if(!(0,Oo.NZ)(o))return;const s=e(t.cursor.currentPosition);return s?Td(Dd({},s),{viewId:o}):void 0})),this.hasCustomNav=r.Computed.create(this,(0,fn.urlState)().state,((e,t)=>{const o=t.hash;return!(!o||void 0===(0,J.undef)(o.colRef,o.rowId,o.sectionId))})),this.draftMonitor=es.create(this,this),this.cursorMonitor=Fo.create(this,this),this.editorMonitor=as.create(this,this),jo.create(this,this).attach(),Ad.window.resetSeenPopups=(e=!1)=>{this.docPageModel.appModel.dismissedPopups.set(e?Uo.DismissedPopup.values:[])}}docId(){return this.docPageModel.currentDocId.get()}addOptionsTab(e,t,o,s){return this._rightPanelTabs.set(e,o),{dispose:()=>null}}buildDom(){const e=r.Computed.create(this,(e=>null!==e(this.sectionInPopup))),t=r.Computed.create(this,(t=>["data","settings"].includes(t(this.activeViewId))||t(e)||"object"==typeof t(this._activeContent)));return Bd((0,s.testId)("gristdoc"),Bd.cls("-contents",t),r.dom.domComputed(this._activeContent,(e=>"code"===e?r.dom.create(Mo,this):"acl"===e?r.dom.create(dt,this):"data"===e?r.dom.create(Kr,this):"settings"===e?r.dom.create(ll,this):"GristDocTour"===e?null:"object"==typeof e?r.dom.create((t=>(t.autoDispose(this.activeViewId.addListener(e.close)),e.viewSection.autoDispose({dispose:e.close}),r.dom.create(Jr,this,e.viewSection,e.close)))):r.dom.create((t=>(this._viewLayout=Fr.create(t,this,e),this._viewLayout.maximized.addListener((e=>this.sectionInPopup.set(e))),this._viewLayout))))))}openDocPage(e){return(0,fn.urlState)().pushUrl({docPage:e})}showTool(e){this._rightPanelTool.set(e)}getCursorPos(){const e={sectionId:this.viewModel.activeSectionId()},t=this.viewModel.activeSection.peek().viewInstance.peek();return Object.assign(e,t?t.cursor.getCursorPos():{})}async moveToCursorPos(e,t){if(e&&e.sectionId)try{const t=await this._switchToSectionId(e.sectionId);t&&t.setCursorPos(e)}catch(e){(0,Cs.eK)(e)}}onDocUserAction(e){console.log("GristDoc.onDocUserAction",e);let t=!1;if(e.data.error)(0,Cs.eK)(new Error(e.data.error));else if(this.docComm.isActionFromThisDoc(e)){const o=e.data.docActions;for(let e=0,s=o.length;e<s;e++)console.log("GristDoc applying #%d",e,o[e]),this.docData.receiveAction(o[e]),this.docPluginManager.receiveAction(o[e]),!t&&(0,Ve.isSchemaAction)(o[e])&&(t=!0);const s=e.data.actionGroup;s.fromSelf=e.fromSelf||!1,s.internal||(this._actionLog.pushAction(s),this._undoStack.pushAction(s),s.fromSelf&&(this._lastOwnActionGroup=s)),t&&this.trigger("schemaUpdateAction",o),this.docPageModel.updateCurrentDocUsage(e.data.docUsage),this.trigger("onDocUserAction",o)}}onDocUsageMessage(e){this.docComm.isActionFromThisDoc(e)&&(0,r.bundleChanges)((()=>{var t;this.docPageModel.updateCurrentDocUsage(e.data.docUsage),this.docPageModel.currentProduct.set(null!=(t=e.data.product)?t:null)}))}getTableModel(e){return this.docModel.dataTables[e]}getTableModelMaybeWithDiff(e){var t;const o=this.getTableModel(e);return(null==(t=this.comparison)?void 0:t.details)?new xl.DataTableModelWithDiff(o,this.comparison.details):o}async addEmptyTable(){const e=await this._promptForName();if(void 0===e)return;const t=await this.docData.sendAction(["AddEmptyTable",e||null]);await this.openDocPage(this.docModel.tables.getRowModel(t.id).primaryViewId())}async addWidgetToPage(e){const t=this.docModel.docData,o=this.viewModel.name.peek();let s;if("New Table"===e.table&&(s=await this._promptForName(),void 0===s))return;const i=await t.bundleActions(Pd("Added new linked section to view {{viewName}}",{viewName:o}),(()=>this.addWidgetToPageImpl(e,null!=s?s:null)));this.viewModel.activeSectionId(i.sectionRef),this._maybeShowEditCardLayoutTip(e.type).catch(Cs.eK)}async addWidgetToPageImpl(e,t=null){const o=this.activeViewId.get(),s="New Table"===e.table?0:e.table,i=await this.docData.sendAction(["CreateViewSection",s,o,e.type,e.summarize?e.columns:null,t]);return"chart"===e.type&&await this._ensureOneNumericSeries(i.sectionRef),await this.saveLink(e.link,i.sectionRef),i}async addNewPage(e){if("New Table"===e.table){const e=await this._promptForName();if(void 0===e)return;const t=await this.docData.sendAction(["AddEmptyTable",e]);await this.openDocPage(t.views[0].id)}else{let t;await this.docData.bundleActions("Add new page",(async()=>{t=await this.docData.sendAction(["CreateViewSection",e.table,0,e.type,e.summarize?e.columns:null,null]),"chart"===e.type&&await this._ensureOneNumericSeries(t.sectionRef)})),await this.openDocPage(t.viewRef),this.viewModel.activeSectionId(t.sectionRef),this._maybeShowEditCardLayoutTip(e.type).catch(Cs.eK)}}async uploadNewTable(){const e=await(0,Ss.lX)({docWorkerUrl:this.docComm.docWorkerUrl,multiple:!0});if(e){const t={uploadId:e.uploadId,transforms:[]},o=(await this.docComm.finishImportFiles(t,[],{})).tables[0].hiddenTableId,s=this.docModel.dataTables[o].tableMetaRow;await this.openDocPage(s.primaryViewId())}}async saveViewSection(e,t){const o=this.docModel.docData,s=(0,ud.FU)(e),i=e.view(),n=e.viewFields().all().map((e=>e.column().colId()));return Md(s,t)?e:await this._viewLayout.freezeUntil(o.bundleActions(Pd("Saved linked section {{title}} in view {{name}}",{title:e.title(),name:i.name()}),(async()=>s.table!==t.table||s.summarize!==t.summarize?await this._replaceViewSection(e,s,t):(s.type!==t.type&&await e.parentKey.saveOnly(t.type),Md(s.columns,t.columns)||(await o.sendAction(["UpdateSummaryViewSection",e.getRowId(),t.columns]),"chart"===t.type&&"chart"===s.type&&await this.setSectionViewFieldsFromArray(e,n)),s.link!==t.link&&await this.saveLink(t.link),e)),{nestInActiveBundle:!0}))}async setSectionViewFieldsFromArray(e,t){await Promise.all(e.viewFields.peek().all().map((e=>this.docModel.viewFields.sendTableAction(["RemoveRecord",e.id()]))));const o=new Map;for(const t of e.table().columns().all())o.set(t.colId(),t);t.length&&(e.optionsObj.prop("multiseries")()?(o.has(t[0])||await e.optionsObj.prop("multiseries").saveOnly(!1),t.length>1&&!o.has(t[1])&&await e.optionsObj.prop("isXAxisUndefined").saveOnly(!0)):o.has(t[0])||await e.optionsObj.prop("isXAxisUndefined").saveOnly(!0)),await Promise.all(t.map(((t,s)=>{if(!o.has(t))return;const i=["AddRecord",null,{parentId:e.id(),colRef:o.get(t).id(),parentPos:s}];return this.docModel.viewFields.sendTableAction(i)})))}async saveLink(e,t){t=t||this.viewModel.activeSection.peek().getRowId();const o=(0,Fa.pS)(e);if(o.targetColRef){const e=this.docModel.viewSections.getRowModel(t).table(),s=this.docModel.columns.getRowModel(o.targetColRef);e.id()!==s.table().id()&&(o.targetColRef=e.columns().all().find((e=>e.summarySourceCol()===o.targetColRef)).id())}return this.docData.sendAction(["UpdateRecord","_grist_Views_section",t,{linkSrcSectionRef:o.srcSectionRef,linkSrcColRef:o.srcColRef,linkTargetColRef:o.targetColRef}])}selectBy(e){const t=this.viewModel.viewSections.peek().peek();return(0,Fa.Kg)(this.docModel,t,e)}async forkIfNeeded(){this.docPageModel.isPrefork.get()&&await this.docComm.forkAndUpdateUrl()}async clearColumns(e,{keepType:t}={}){await this.docModel.columns.sendTableAction(["BulkUpdateRecord",e,Td(Dd({isFormula:e.map((e=>!0)),formula:e.map((e=>""))},t?{}:{type:e.map((e=>"Any")),widgetOptions:e.map((e=>"")),visibleCol:e.map((e=>null)),displayCol:e.map((e=>null)),rules:e.map((e=>null))}),{recalcWhen:e.map((e=>Ze.RecalcWhen.DEFAULT)),recalcDeps:e.map((e=>null))})])}async convertIsFormula(e,t){return this.docModel.columns.sendTableAction(["BulkUpdateRecord",e,{isFormula:e.map((e=>t.toFormula)),recalcWhen:e.map((e=>t.noRecalc?Ze.RecalcWhen.NEVER:Ze.RecalcWhen.DEFAULT)),recalcDeps:e.map((e=>null))}])}async updateFormula(e,t){return this.docModel.columns.sendTableAction(["UpdateRecord",e,{formula:t}])}async convertToFormula(e,t){return this.docModel.columns.sendTableAction(["UpdateRecord",e,{isFormula:!0,formula:t,recalcWhen:Ze.RecalcWhen.DEFAULT,recalcDeps:null}])}async convertToTrigger(e,t){return this.docModel.columns.sendTableAction(["UpdateRecord",e,{isFormula:!1,formula:t,recalcWhen:Ze.RecalcWhen.DEFAULT,recalcDeps:null}])}getCsvLink(){const e=this._getDocApiDownloadParams();return this.docPageModel.appModel.api.getDocAPI(this.docId()).getDownloadCsvUrl(e)}getXlsxActiveViewLink(){const e=this._getDocApiDownloadParams();return this.docPageModel.appModel.api.getDocAPI(this.docId()).getDownloadXlsxUrl(e)}hasGranularAccessRules(){const e=this.docData.getMetaTable("_grist_ACLRules");return e.numRecords()>e.filterRowIds({permissionsText:"",permissions:63}).length}async recursiveMoveToCursorPos(e,t,o=!1){try{if(!e.sectionId)throw new Error("sectionId required");if(!e.rowId)throw new Error("rowId required");const s=this.docModel.viewSections.getRowModel(e.sectionId);if(!s.id.peek())throw new Error(`Section ${e.sectionId} does not exist`);const i=s.linkSrcSection.peek();if(i.id.peek()){const t=s.linkTargetCol.peek();let n;n=t.colId.peek()?(await this._getTableData(s)).getValue(e.rowId,t.colId.peek()):e.rowId;const r=s.linkSrcCol.peek().colId.peek();let l;const a=i.table.peek().summarySource.peek().id.peek();if(r||a){const t=await this._getTableData(i),o={tableId:t.tableId,filters:{},operations:{}};if(r)o.operations[r]=(0,Ze.isRefListType)(s.linkSrcCol.peek().type.peek())?"intersects":"in",o.filters[r]=(0,Ze.isList)(n)?n.slice(1):[n];else{const t=await this._getTableData(s);for(const s of i.table.peek().groupByColumns.peek()){const i=s.summarySource.peek(),r=i.colId.peek();n=t.getValue(e.rowId,r),o.operations[r]=(0,Ze.isListType)(i.type.peek())&&!n?"empty":"in",o.filters[r]=(0,Ze.isList)(n)?n.slice(1):[n]}}l=t.getRowIds().find((0,sc.getFilterFunc)(this.docData,o))}else(0,Ze.isList)(n)&&(n=n[1]),l=n;if(!l||"number"!=typeof l)throw new Error("cannot trace rowId");await this.recursiveMoveToCursorPos({rowId:l,sectionId:i.id.peek()},!1,o)}const n=s.view.peek(),r=s.isRaw.peek()?"data":n.getRowId();r!=this.activeViewId.get()&&await this.openDocPage(r),t&&n.activeSectionId(e.sectionId);const l=e.fieldIndex,a=await(0,J.waitObs)(s.viewInstance);if(!a)throw new Error("view not found");return await(0,Oc.g)(0),a.setCursorPos(Td(Dd({},e),{fieldIndex:l})),await(0,Oc.g)(0),!0}catch(t){if(console.debug(`_recursiveMoveToCursorPos(${JSON.stringify(e)}): ${t}`),!o)throw new ge.UserError("There was a problem finding the desired cell.");return!1}}async activateEditorAtCursor(e){const t=await this._waitForView();null==t||t.activateEditorAtCursor(e)}async renameTable(e,t){const o=this.docModel.visibleTables.all().find((t=>t.tableId.peek()===e));if(!o)throw new ge.UserError(`No table with id ${e}`);await o.tableName.saveOnly(t)}async openPopup(e){if(!e.sectionId)return;if(this.viewModel.viewSections.peek().peek().some((t=>t.id.peek()===e.sectionId))){if(this.viewModel.activeSectionId(e.sectionId),e.colRef&&e.rowId){const t=this.viewModel.activeSection.peek(),o=t.viewFields.peek().all().findIndex((t=>t.colRef.peek()===e.colRef));if(o>=0){const s=await this._waitForView(t);null==s||s.setCursorPos({sectionId:e.sectionId,rowId:e.rowId,fieldIndex:o})}}return void Po.allCommands.maximizeActiveSection.run()}const t=this.viewModel.activeSection.peek();this.viewModel.activeSectionId(e.sectionId);const o=this.viewModel.activeSection.peek();if(o.hasFocus(!0),this._rawSectionOptions.set({hash:e,viewSection:o,close:()=>{this._rawSectionOptions.get()&&(o!==t&&(o.isDisposed()||o.hasFocus(!1),t.isDisposed()||t.hasFocus(!0)),this._rawSectionOptions.set(null))}}),e.colRef&&e.rowId){const t=o.viewFields.peek().all().findIndex((t=>t.colRef.peek()===e.colRef));if(t>=0){const s=await this._waitForView(o);null==s||s.setCursorPos({sectionId:e.sectionId,rowId:e.rowId,fieldIndex:t})}}}async _waitForView(e){const t=null!=e?e:this.viewModel.activeSection.peek();if(!t.getRowId())return null;async function o(e){return await(0,J.waitObs)(t.viewInstance,(e=>Boolean(e&&!e.isDisposed())))}let s=await o();return s.isDisposed()&&(e&&(s=await o()),s.isDisposed())?null:(await s.getLoadingDonePromise(),await(0,Oc.g)(0),s)}_getToolContent(e){switch(e){case"docHistory":return{icon:"Log",label:"Document History",content:this._docHistory};case"validations":{const e=this._rightPanelTabs.get("Validate Data");return e?{icon:"Validation",label:"Validation Rules",content:e}:null}case"discussion":return{icon:"Chat",label:this._discussionPanel.buildMenu(),content:this._discussionPanel};default:return null}}async _maybeShowEditCardLayoutTip(e){if(!["single","detail"].includes(e)||this.behavioralPromptsManager.hasSeenTip("editCardLayout"))return;Po.allCommands.viewTabOpen.run(),await Po.allCommands.rightPanelOpen.run();const t=document.querySelector(".behavioral-prompt-edit-card-layout");if(!t)throw new Error("GristDoc failed to find edit card layout button");this.behavioralPromptsManager.showTip(t,"editCardLayout",{popupOptions:{placement:"left-start"}})}async _promptForName(){return await(0,us.invokePrompt)("Table name","Create","","Default table name")}async _replaceViewSection(e,t,o){const s=this.docModel,i=e.view(),n=this.docModel.docData,r=e.options(),l=e.viewFields().all().map((e=>e.column().colId())),a=e.chartType(),c=e.theme(),d=this._viewLayout.layoutSpec(),u=e.title(),h=e.id(),p=await this.addWidgetToPageImpl(o),m=s.viewSections.getRowModel(p.sectionRef);await m.title.saveOnly(u);const g=kd(d,(e=>{if("object"==typeof e&&e.leaf===h)return Td(Dd({},e),{leaf:m.id()})}));return await i.layoutSpec.saveOnly(JSON.stringify(g)),await m.options.saveOnly(r),"chart"===t.type&&"chart"===o.type&&await this.setSectionViewFieldsFromArray(m,l),await m.theme.saveOnly(c),await m.chartType.saveOnly(a),this.viewModel.activeSectionId(m.getRowId()),await n.sendAction(["RemoveViewSection",h]),m}_onSendActionsStart(e){this._lastOwnActionGroup=null,e.cursorPos=this.getCursorPos()}_onSendActionsEnd(e){const t=this._lastOwnActionGroup;t&&(t.cursorPos=e.cursorPos,t.rowIdHint&&(t.cursorPos.rowId=t.rowIdHint))}_getDocApiDownloadParams(){const e=this.viewModel.activeSection.peek().activeFilters.get().map((e=>({colRef:e.fieldOrColumn.origCol().origColRef(),filter:e.filter()})));return{viewSection:this.viewModel.activeSectionId(),tableId:this.viewModel.activeSection().table().tableId(),activeSortSpec:JSON.stringify(this.viewModel.activeSection().activeSortSpec()),filters:JSON.stringify(e)}}async _switchToSectionId(e){const t=this.docModel.viewSections.getRowModel(e);if(t.isRaw.peek())await(0,fn.urlState)().pushUrl({docPage:"data"}),this.viewModel.activeSectionId(e);else{const o=t.view.peek();await this.openDocPage(o.getRowId()),o.activeSectionId(e)}return(0,J.waitObs)(t.viewInstance)}async _getTableData(e){const t=await(0,J.waitObs)(e.viewInstance);if(!t)throw new Error("view not found");await t.getLoadingDonePromise();const o=this.docData.getTable(e.table.peek().tableId.peek());if(!o)throw new Error("no section table");return o}_getCursorPosFromHash(e){const t={rowId:e.rowId,sectionId:e.sectionId};if(null!=t.sectionId&&void 0!==e.colRef){const o=this.docModel.viewSections.getRowModel(t.sectionId).viewFields.peek().all().findIndex((t=>t.colRef.peek()==e.colRef));o>=0&&(t.fieldIndex=o)}return t}_shouldAutoStartWelcomeTour(){var e,t;if(this.hasDocTour.get())return!1;const o=this.docPageModel.appModel;return!(!(null==(e=o.currentOrg)?void 0:e.owner)||this.isReadonly.get())&&(null!=(t=this._showGristTour.get())?t:!o.currentValidUser)}async _ensureOneNumericSeries(e){const t=this.docModel.viewSections.getRowModel(e);if(1===t.viewFields.peek().peek().length)return;const o=t.viewFields.peek().peek()[1];if((0,Ro.isNumericOnly)(t.chartTypeDef.peek())&&!(0,Ro.isNumericLike)(o.column.peek())){const e=[];e.push(["RemoveRecord",o.id.peek()]);const s=t.hiddenColumns.peek().find((e=>(0,Ro.isNumericLike)(e)));if(s){const o={parentId:t.id.peek(),colRef:s.id.peek()};e.push(["AddRecord",null,o])}await this.docModel.viewFields.sendTableActions(e)}}}async function Ed(){await(0,fn.urlState)().pushUrl({hash:{}},{replace:!0}),(0,Si.setTestState)({anchorApplied:!0})}const Bd=(0,r.styled)("div",`\n  flex: auto;\n  display: flex;\n  flex-direction: column;\n  overflow: visible;\n  position: relative;\n  min-width: 240px;\n  margin: 12px;\n  @media ${s.mediaSmall} {\n    & {\n      margin: 4px;\n    }\n  }\n  @media print {\n    & {\n      margin: 0px;\n    }\n  }\n  &-contents {\n    margin: 0px;\n    overflow: hidden;\n  }\n`)},87346:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Layout:()=>f,LayoutBox:()=>m});var s=o(81294),i=o.n(s),n=o(13988),r=o.n(n),l=o(92979),a=o(88438),c=o(20543),d=o.n(c),u=o(86277),h=o(29301),p=o(77949);class m extends a.Disposable{constructor(){super(...arguments),this.dom=null}create(e){this.layout=e,this.parentBox=(0,h.observable)(null),this.childBoxes=r()(),this.leafId=(0,h.observable)(null),this.leafContent=(0,h.observable)(null),this.uniqueId=(0,p.uniqueId)("lb"),this.isVBox=this.autoDispose((0,h.computed)((()=>!this.parentBox()||!this.parentBox().isVBox()),this)),this.isHBox=this.autoDispose((0,h.computed)((()=>!this.isVBox()))),this.isLeaf=this.autoDispose((0,h.computed)((()=>null!==this.leafId()),this)),this.isMaximized=this.autoDispose(h.pureComputed((()=>{var e;const t=null==(e=this.layout)?void 0:e.maximized();return!!t&&(t===this.leafId()||this.childBoxes.all().some((function(e){return e.isMaximized()})))}),this)),this.isHidden=this.autoDispose(h.pureComputed((()=>{var e;return!!(null==(e=this.layout)?void 0:e.maximized())&&!this.isMaximized()}),this)),this.flexSize=(0,h.observable)(100),this.dom=null,this._parentBeingDisposed=!1,this.autoDisposeCallback((()=>{this._parentBeingDisposed||this.removeFromParent(),this.childBoxes.peek().forEach((function(e){e._parentBeingDisposed=!0,e.dispose()}))}))}getDom(){return this.dom||(this.dom=this.autoDispose(this.buildDom()))}maximize(){this.layout.maximized.peek()!==this.leafId.peek()?this.layout.maximized(this.leafId()):this.layout.maximized(null)}buildDom(){const e=this,t=this.layout.needDynamic?p.identity:g;return i()("div.layout_box",(0,l.toggleClass)("layout_leaf",t(this.isLeaf)),(0,l.toggleClass)("layout_hidden",this.isHidden),(0,l.toggleClass)(this.layout.leafId,t(this.isLeaf)),(0,l.cssClass)(t((function(){return e.isVBox()?"layout_vbox":"layout_hbox"}))),(0,l.cssClass)(t((function(){return e.layout.fillWindow?"layout_fill_window":e.isLastChild()?"layout_last_child":null}))),(0,l.style)("--flex-grow",t((function(){return e.isVBox()||e.isHBox()&&e.layout.fillWindow?e.flexSize():""}))),(0,l.domData)("layoutBox",this),(0,l.foreach)(t(this.childBoxes),(function(e){return e.getDom()})),(0,l.scope)(t(this.leafContent),(function(e){return e})))}takeLeafFrom(e){this.leafId(e.leafId.peek()),this.leafContent((0,s.detachNode)(e.leafContent.peek())),e.leafId(null),e.leafContent(null)}setChildren(e){e.forEach((e=>e.parentBox(this))),this.childBoxes.assign(e)}isFirstChild(){return!this.parentBox()||this.parentBox().childBoxes.peek()[0]===this}isLastChild(){return!this.parentBox()||(0,p.last)(this.parentBox().childBoxes.all())===this}isDomDetached(){return!(this.dom&&this.dom.parentNode)}getSiblingBox(e){if(!this.parentBox())return null;const t=this.parentBox().childBoxes.peek();let o=t.indexOf(this);return o<0?null:(o+=e?1:-1,o<0||o>=t.length?null:t[o])}_addChild(e,t,o){let s;d()(null===e.parentBox(),"LayoutBox._addChild: child already has parentBox set"),s=o?this.childBoxes.peek().indexOf(o)+(t?1:0):t?this.childBoxes.peekLength:0,e.parentBox(this),this.childBoxes.splice(s,0,e)}addSibling(e,t){e.removeFromParent();const o=this.parentBox();if(o)o._addChild(e,t,this);else if(1===this.childBoxes.peekLength){const o=this.childBoxes.peek()[0];d()(!o.isLeaf(),"LayoutBox.addSibling: should not have leaf as a single child"),o._addChild(e,t)}else{const o=m.create(this.layout),s=m.create(this.layout);o._addChild(s,!1),s._addChild(this,!1),s._addChild(e,t),this.layout.setRoot(o)}this.layout.trigger("layoutChanged")}addChild(e,t){if(e.removeFromParent(),this.isLeaf()){const e=m.create(this.layout);e.takeLeafFrom(this),this._addChild(e,!1)}this._addChild(e,t),this.layout.trigger("layoutChanged")}toString(){return this.isDisposed()?this.uniqueId+"[disposed]":this.uniqueId+(this.isHBox()?"H":"V")+(this.isLeaf()?"("+this.leafId()+")":"["+this.childBoxes.peek().map((function(e){return e.toString()})).join(",")+"]")}_removeChildBox(e){let t=this.childBoxes.peek().indexOf(e);if(e.parentBox(null),t>=0&&(this.childBoxes.splice(t,1),this.rescaleFlexSizes()),1===this.childBoxes.peekLength){const e=this.childBoxes.peek()[0],o=this.parentBox();if(e.isLeaf())this.takeLeafFrom(e),e.dispose();else if(o){t=o.childBoxes.peek().indexOf(this),d()(t>=0,"LayoutBox._removeChildBox: box not found in parent");const s=e.childBoxes.peek();s.forEach((function(e){e.parentBox(o)})),o.childBoxes.arraySplice(t,0,s),e.childBoxes.splice(0,e.childBoxes.peekLength),this.removeFromParent(),e.dispose(),this.dispose()}}}removeFromParent(){this.parentBox()&&(this.parentBox()._removeChildBox(this),this.layout.trigger("layoutChanged"))}rescaleFlexSizes(){const e=this.childBoxes.peek(),t=Math.min.apply(null,e.map((function(e){return e.flexSize()})));t<1&&e.forEach((function(e){e.flexSize(e.flexSize()/t)}))}}function g(e){return(0,h.isObservable)(e)||(0,n.isKoArray)(e)?e.peek():"function"==typeof e?e():e}class f extends a.Disposable{static getContainingBox(e,t){const o=(0,s.findAncestor)(e,t,".layout_box");return o?h.utils.domData.get(o,"layoutBox"):null}create(e,t,o){this.maximized=(0,h.observable)(null),this.rootBox=(0,h.observable)(null),this.createLeafFunc=t,this._leafIdMap=null,this.fillWindow=o||!1,this.needDynamic=!1,this.rootElem=this.autoDispose(this.buildDom()),this.leafId=(0,p.uniqueId)("layout_leaf_"),this.buildLayout(e||{}),this.listenTo(this,"layoutChanged",(()=>{this._leafIdMap=null})),this.autoDisposeCallback((()=>{this.rootBox()&&this.rootBox().dispose()}))}getLeafBox(e){return this.getLeafIdMap().get(e)}getAllLeafIds(){return Array.from(this.getLeafIdMap().keys())}setRoot(e){this.rootBox(e)}buildDom(){return i()("div.layout_root",(0,l.domData)("layoutModel",this),(0,l.toggleClass)("layout_fill_window",this.fillWindow),(0,l.toggleClass)("layout_box_maximized",this.maximized),(0,l.scope)(this.rootBox,(e=>e?e.getDom():null)))}forEachBox(e,t){!function o(s){e.call(t,s),s.childBoxes.peek().forEach(o)}(this.rootBox.peek())}buildLayoutBox(e){const t=m.create(this);return e.size&&t.flexSize(e.size),e.leaf?(t.leafId(e.leaf),t.leafContent(this.createLeafFunc(t.leafId()))):e.children&&t.setChildren(e.children.map(this.buildLayoutBox,this)),t}buildLayout(e,t=!1){this.needDynamic=t;const o=this.rootBox();this.rootBox(this.buildLayoutBox(e)),this.trigger("layoutChanged"),o&&o.dispose()}_getBoxSpec(e){const t={};return e.isDisposed()||(e.flexSize()&&100!==e.flexSize()&&(t.size=e.flexSize()),e.isLeaf()?t.leaf=e.leafId():t.children=e.childBoxes.peek().map(this._getBoxSpec,this)),t}getLayoutSpec(){return this._getBoxSpec(this.rootBox())}getLeafIdMap(){return this._leafIdMap||(this._leafIdMap=new Map,this.forEachBox((e=>{const t=e.leafId.peek();null!==t&&this._leafIdMap.set(t,e)}),this)),this._leafIdMap}getContainingBox(e){return f.getContainingBox(e,this.rootElem)}}Object.assign(f.prototype,u.Events)},29255:(e,t,o)=>{"use strict";o.r(t),o.d(t,{LayoutEditor:()=>y});var s=o(77949),i=o(29301),n=o(20543),r=o.n(n),l=o(74392),a=o.n(l),c=o(86277),d=o(88438),u=o(96682),h=o(81294),p=o.n(h),m=o(92979),g=o(87346);const f=(0,o(11527).get)("document","window","$");class w{constructor(e){this.scalePerFlexUnit=0,this.nextSiblings=[],this.origNextSizes=[],this.origSize=0,this.sumAll=0,this.sumPrev=0,this.sumNext=0,e&&(0,s.extend)(this,e)}}class b extends d.Disposable{create(e){this.leafId=(0,i.observable)(null),this.leafContent=(0,i.observable)(null),this.fillWindow=e||!1,this.floaterElem=this.autoDispose(p()("div.layout_editor_floater",m.show(this.leafContent),m.scope(this.leafContent,(e=>e)))),f.document.body.appendChild(this.floaterElem),this.mouseOffsetX=0,this.mouseOffsetY=0,this.lastMouseEvent=null}onInitialMouseMove(e,t){const o=t.dom.getBoundingClientRect();this.floaterElem.style.width=o.width+"px",this.floaterElem.style.height=o.height+"px",this.mouseOffsetX=.2*o.width,this.mouseOffsetY=.1*o.height,this.onMouseMove(e),this.leafId(t.leafId()),this.leafContent(t.leafContent()),t.leafId("empty"),t.leafContent(p()("div.layout_editor_empty_space",m.style("margin",.02*o.height+"px"),m.style("min-height",.96*o.height+"px")))}onMouseUp(){this.lastMouseEvent=null}onMouseMove(e){this.lastMouseEvent=e,this.floaterElem.style.left=e.clientX-this.mouseOffsetX+"px",this.floaterElem.style.top=e.clientY-this.mouseOffsetY+"px"}}class v extends d.Disposable{create(){this.overlayElem=this.autoDispose(p()("div.layout_editor_drop_overlay")),this.overlayRect=null,this.hBorder=null,this.vBorder=null}detach(){this.overlayElem.parentNode&&this.overlayElem.parentNode.removeChild(this.overlayElem)}attach(e){const t=this.overlayRect=e.getBoundingClientRect();this.hBorder=Math.floor(Math.min(t.height,2*t.width)/3),this.vBorder=Math.floor(Math.min(t.width,2*t.height)/3);const o=this.overlayElem.style;o.borderTopWidth=o.borderBottomWidth=this.hBorder+"px",o.borderLeftWidth=o.borderRightWidth=this.vBorder+"px"}getAffinity(e){const t=this.overlayRect,o=e.clientX-t.left,s=e.clientY-t.top,i=x(s,this.hBorder),n=x(t.height-s,this.hBorder),r=x(o,this.vBorder),l=x(t.width-o,this.vBorder),a=Math.min(i,n,r,l);return a===1/0?-1:[i,n,r,l].indexOf(a)}}class _ extends d.Disposable{create(e){this.rootElem=e,this.targetsDom=null,this.currentBox=null,this.currentAffinity=null,this.delayedInsertion=u.Delay.create(),this.activeTarget=null,this.autoDisposeCallback(this.removeTargetHints)}removeTargetHints(){this.activeTarget=null,this.delayedInsertion.cancel(),this.targetsDom&&((0,i.removeNode)(this.targetsDom),this.targetsDom=null),this.currentBox=null,this.currentAffinity=null}updateTargetHints(e,t,o,s){if(!e||e===this.currentBox&&t===this.currentAffinity)return;if(this.removeTargetHints(),-1===t)return;this.currentBox=e,this.currentAffinity=t;const i=function(e){return e>>1==0}(t),n=function(e){return 1==(1&e)}(t),r=[];for(i===e.isVBox()&&e!==s&&r.push({box:e,isChild:!0,isAfter:n});e;){if(i===e.isHBox()){const t=e.childBoxes.peek();if(2===t.length&&s.parentBox()===e?r.splice(r.length-1,1,{box:e,isChild:!1,isAfter:n}):s!==e&&s!==e.getSiblingBox(n)&&1!==t.length&&r.push({box:e,isChild:!1,isAfter:n}),n&&!e.isLastChild())break;if(!n&&!e.isFirstChild())break}e=e.parentBox()}if(0===r.length)return;n||r.reverse();const l=i?"top":"left",a=i?"height":"width",c=i?"left":"top",d=i?"width":"height";let u=i?o.hBorder:o.vBorder;const h=Math.floor(u/r.length);u=h*r.length;const g=this.rootElem.getBoundingClientRect(),f=this.currentBox.dom.getBoundingClientRect(),w=this;this.targetsDom=p()("div.layout_editor_drop_targeter",m.style(l,f[l]-g[l]+(n?f[a]-u:0)+"px"),r.map(((e,t)=>{const o=e.box.dom.getBoundingClientRect();return p()("div.layout_editor_drop_target",(e=>{e.style[a]=h+1+"px",e.style[d]=o[d]+"px",e.style[c]=o[c]-g[c]+"px",e.style[l]=h*t+"px"}),p().on("mouseenter",(function(){this.classList.add("layout_hover"),w.activeTarget=e;const t="padding"+(i?n?"Bottom":"Top":n?"Right":"Left");e.box.dom.style.transition="padding .3s",e.box.dom.style[t]="20px"})),p().on("mouseleave",(function(){this.classList.remove("layout_hover"),w.activeTarget=null,e.box.dom.style.padding="0"})),p().on("transitionend",this.triggerInsertion.bind(this,e)))}))),this.rootElem.appendChild(this.targetsDom)}triggerInsertion(e){this.removeTargetHints(),this.trigger("insertBox",(t=>{e.isChild?e.box.addChild(t,e.isAfter):e.box.addSibling(t,e.isAfter)}))}accelerateInsertion(){this.activeTarget&&(this.activeTarget.box.dom.style.transition="",this.activeTarget.box.dom.style.padding="0",this.triggerInsertion(this.activeTarget))}}(0,s.extend)(_.prototype,c.Events);class y extends d.Disposable{create(e){this.layout=e,this.rootElem=e.rootElem,this.layout.buildLayout(this.layout.getLayoutSpec(),!0),this.floater=this.autoDispose(b.create(this.layout.fillWindow)),this.dropOverlay=this.autoDispose(v.create()),this.dropTargeter=this.autoDispose(_.create(this.rootElem)),this.listenTo(this.dropTargeter,"insertBox",this.onInsertBox),this.measuringBox=this.autoDispose(p()("div.layout_editor_measuring_box")),this.rootElem.appendChild(this.measuringBox),this.transitionPromise=a().resolve(),this.trashDelay=u.Delay.create(),this.originalBox=null,this.targetBox=null,this.layout.forEachBox(this.makeResizable,this),this.listenTo(this.layout,"layoutChanged",(()=>{this.layout.forEachBox(this.makeResizable,this)}));const t=this;this.boundMouseDown=function(e){return t.handleMouseDown(e,this)},this.boundMouseMove=this.handleMouseMove.bind(this),this.boundMouseUp=this.handleMouseUp.bind(this),f.$(this.rootElem).on("mousedown",".layout_leaf",this.boundMouseDown),this.initialMouseDown=!1,this.lastTriggered="stop",this.autoDisposeCallback((()=>{f.$(f.window).off("mouseup",this.boundMouseUp),f.$(f.window).off("mousemove",this.boundMouseMove),f.$(this.rootElem).off("mousedown",this.boundMouseDown),this.layout.isDisposed()||(this.layout.buildLayout(this.layout.getLayoutSpec(),!1),this.layout.forEachBox(this.unmakeResizable,this))}))}triggerUserEditStart(){r()("stop"===this.lastTriggered,"UserEditStart triggered twice in succession"),this.lastTriggered="start",this.rootElem.setAttribute("data-useredit","start"),this.layout.trigger("layoutUserEditStart")}triggerUserEditStop(){r()("start"===this.lastTriggered,"UserEditStop triggered twice in succession"),this.lastTriggered="stop",this.layout.trigger("layoutUserEditStop"),this.rootElem.setAttribute("data-useredit","stop")}makeResizable(e){if(f.$(e.dom).resizable("instance")||e.isHBox()&&!this.layout.fillWindow||e.isLastChild())return;const t=new w({box:e}),o=e.isVBox();f.$(e.dom).resizable({handles:o?"e":"s",start:this.onResizeStart.bind(this,t,o),resize:this.onResizeMove.bind(this,t,o),stop:this.triggerUserEditStop.bind(this)})}unmakeResizable(e){f.$(e.dom).resizable("instance")&&f.$(e.dom).resizable("destroy")}onResizeStart(e,t,o,s){this.triggerUserEditStart();const i=t?s.originalSize.width:s.originalSize.height;e.scalePerFlexUnit=i/(e.box.flexSize()||1);const n=e.box.parentBox().childBoxes.peek(),r=n.indexOf(e.box);e.nextSiblings=n.slice(r+1),e.origNextSizes=e.nextSiblings.map((function(e){return e.flexSize()})),e.origSize=e.box.flexSize(),e.sumPrev=n.slice(0,r).reduce(D,0),e.sumAll=n.reduce(D,0),e.sumNext=e.sumAll-e.sumPrev}onResizeMove(e,t,o,s){let i=(t?s.size.width:s.size.height)/e.scalePerFlexUnit;i=S(i,e.sumPrev,e.sumAll);const n=(e.sumNext-i)/(e.sumNext-e.origSize);let r=e.sumPrev+i;const l=[];e.origNextSizes.forEach((function(t){const o=S(t*n,r,e.sumAll);r+=o,l.push(o)})),i<=0||l.some((e=>e<=0))||i!==e.box.flexSize.peek()&&(e.box.flexSize(i),e.nextSiblings.forEach((function(e,t){e.flexSize(l[t])})),this.layout.trigger("layoutResized"))}handleMouseDown(e,t){const o=e.target;if(0===e.button&&!(null==o?void 0:o.classList.contains("ui-resizable-handle")))return(null==o?void 0:o.classList.contains("layout_grabbable"))?(this.initialMouseDown=!0,this.originalBox=i.utils.domData.get(t,"layoutBox"),r()(this.originalBox,"MouseDown on element without an associated layoutBox"),f.$(f.window).on("mousemove",this.boundMouseMove),f.$(f.window).on("mouseup",this.boundMouseUp),!1):void 0}dragInNewBox(e,t){const o=this.layout.buildLayoutBox({leaf:t});this.measuringBox.appendChild(o.getDom()),this.handleMouseDown(e,o.dom)}startDragBox(e,t){this.triggerUserEditStart(),this.targetBox=t,this.floater.onInitialMouseMove(e,t)}handleMouseUp(e){f.$(f.window).off("mousemove",this.boundMouseMove),f.$(f.window).off("mouseup",this.boundMouseUp),this.initialMouseDown?this.initialMouseDown=!1:(this.targetBox.takeLeafFrom(this.floater),this.dropTargeter.activeTarget?this.dropTargeter.accelerateInsertion():C(this.targetBox,"reset"),this.dropTargeter.removeTargetHints(),this.dropOverlay.detach(),this.transitionPromise.finally((()=>{this.floater.onMouseUp(),C(this.targetBox,"reset"),this.targetBox=this.originalBox=null,(0,d.emptyNode)(this.measuringBox),this.triggerUserEditStop()})))}removeContainingBox(e){const t=this.layout.getContainingBox(e);if(t&&!t.isDomDetached()){this.triggerUserEditStart(),this.targetBox=t;const e=t.dom.getBoundingClientRect();t.leafId("empty"),t.leafContent(p()("div.layout_editor_empty_space",m.style("min-height",e.height+"px"))),this.onInsertBox(s.noop).catch(s.noop),this.triggerUserEditStop()}}handleMouseMove(e){var t;if(!this.originalBox||(null==(t=this.originalBox)?void 0:t.isDisposed()))return;if(this.initialMouseDown&&(this.initialMouseDown=!1,this.startDragBox(e,this.originalBox)),this.floater.onMouseMove(e),this.transitionPromise.isPending())return;if(p().findAncestor(e.target,null,".layout_trash")){const e=this.targetBox&&this.targetBox.isDomDetached();return void(this.trashDelay.isPending()||e||this.trashDelay.schedule(100,this.onInsertBox,this,s.noop))}this.trashDelay.cancel();const o=p().findAncestor(e.target,this.rootElem,"."+this.layout.leafId);if(o){const t=i.utils.domData.get(o,"layoutBox");this.dropOverlay.attach(o);const s=this.dropOverlay.getAffinity(e);this.dropTargeter.updateTargetHints(t,s,this.dropOverlay,this.targetBox)}else p().findAncestor(e.target,this.rootElem,".layout_editor_drop_target")||this.dropTargeter.removeTargetHints()}async onInsertBox(e){const t=this.targetBox;let o;this.targetBox=g.LayoutBox.create(this.layout),this.targetBox.takeLeafFrom(t),this.targetBox.flexSize(t.flexSize()),this.targetBox.getDom(),this.transitionPromise=new(a())((function(e,t){o=e})),e(this.targetBox);const s=t.dom.getBoundingClientRect(),i=t.dom.style.flexGrow;t.dom.style.flexGrow="0";const n=this.targetBox.dom.getBoundingClientRect();t.dom.style.flexGrow=i,await a().all([R(t,s,"collapse"),R(this.targetBox,"collapse",n)]),t.dispose(),this.targetBox&&(C(this.targetBox,"reset"),this.dropOverlay.attach(this.targetBox.dom)),o(),this.layout.trigger("layoutResized")}}function x(e,t){return e<t?e/t:1/0}function S(e,t,o){const s=(i=t+e,n=o/60,Math.round(i/n)*n);var i,n;return Math.min(s,o)-t}function C(e,t){const o="reset"===t,s="collapse"===t;"current"===t&&(t=e.dom.getBoundingClientRect()),e.isHBox()?e.dom.style.height=o?"":s?"0px":t.height+"px":e.dom.style.width=o?"":s?"0px":t.width+"px",e.dom.style.opacity=s?"0.0":"1.0"}function I(e){return"string"==typeof e?e:Math.floor(e.width)+"x"+Math.floor(e.height)}function R(e,t,o){if(e.isDomDetached())return a().resolve();const i=e.dom.style.flexGrow;return e.dom.style.flexGrow="0",C(e,t),(0,s.pick)(f.window.getComputedStyle(e.dom),"height","width"),e.dom.classList.add("layout_editor_resize_transition"),new(a())((function(t,s){p().once(e.dom,"transitionend",(function(){t()})),C(e,o)})).timeout(600).catch(a().TimeoutError,(function(){console.error("LayoutEditor.resizeLayoutBoxSmoothly %s %s->%s: transition didn't run",e,I(t),I(o))})).finally((function(){e.dom.classList.remove("layout_editor_resize_transition"),e.dom.style.flexGrow=i}))}function D(e,t){return e+t.flexSize.peek()}(0,s.extend)(y.prototype,c.Events)},4491:(e,t,o)=>{"use strict";o.d(t,{F:()=>d});var s=o(70387),i=o(11187),n=o(29922),r=o(99002),l=o(20742),a=o(18099);const c=(0,s.makeT)("PluginScreen");class d extends a.Disposable{constructor(e){super(),this._title=e,this._openModalCtl=null,this._importerContent=a.Observable.create(this,null),this._fullscreen=a.Observable.create(this,!1)}renderContent(e){this.render([this._buildModalTitle(),e])}renderPlugin(e){return e.addRenderTarget(((e,t={})=>{e.style.width="100%",e.style.height=t.height||"200px",this.renderContent(e)}))}render(e,t){this.showImportDialog(),this._importerContent.set(e),this._fullscreen.set(Boolean(null==t?void 0:t.fullscreen))}renderError(e){this.render([this._buildModalTitle(),h(c("Import failed: "),e,(0,n.testId)("importer-error")),(0,l.cssModalButtons)((0,i.bigBasicButton)("Close",a.dom.on("click",(()=>this.close())),(0,n.testId)("modal-cancel")))])}renderSpinner(){this.render([this._buildModalTitle(),m((0,r.M)())])}close(){var e;null==(e=this._openModalCtl)||e.close(),this._openModalCtl=null}showImportDialog(){this._openModalCtl||(0,l.modal)((e=>(this._openModalCtl=e,[u.cls(""),u.cls("-fullscreen",this._fullscreen),a.dom.domComputed(this._importerContent),(0,n.testId)("importer-dialog")])),{noClickAway:!0,noEscapeKey:!0})}_buildModalTitle(e){return p((0,l.cssModalTitle)(this._title),e)}}const u=(0,a.styled)("div",`\n  max-height: calc(100% - 32px);\n  display: flex;\n  flex-direction: column;\n  & > .${l.cssModalButtons.className} {\n    margin-top: 16px;\n  }\n\n  &-fullscreen {\n    height: 100%;\n    margin: 32px;\n  }\n`),h=(0,a.styled)("div","\n  padding: 16px 0;\n  overflow-y: auto;\n  max-width: 470px;\n  white-space: pre-line;\n"),p=(0,a.styled)("div",`\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 16px;\n  & > .${l.cssModalTitle.className} {\n    margin-bottom: 0px;\n  }\n`),m=(0,a.styled)("div","\n  display: flex;\n  align-items: center;\n  height: 80px;\n  margin: auto;\n")},68498:(e,t,o)=>{"use strict";o.r(t),o.d(t,{printViewSection:()=>n,renderAllRows:()=>r});var s=o(28250),i=o(18099);async function n(e,t){var o;const n=t.viewInstance.peek(),r=null==(o=null==n?void 0:n.viewPane)?void 0:o.closest(".viewsection_content");if(!r)throw new Error("No page widget to print");if(n instanceof s.S)try{return void await n.triggerPrint()}catch(e){console.warn(`Failed to trigger print in CustomView: ${e}`)}function l(t){null==e||e.forEachBox((e=>{e.dom.contains(r)||e.dom.classList.toggle("print-hide",t)})),r.classList.toggle("print-widget",t),null==n||n.prepareToPrint(t);let o=(r.querySelector(".print-all-rows")||r).parentElement;for(;o;)o.classList.toggle("print-parent",t),o=o.parentElement}const a=i.dom.onElem(window,"beforeprint",(()=>l(!0))),c=i.dom.onElem(window,"afterprint",window.afterPrintCallback=()=>{a.dispose(),c.dispose(),window.debugPrinting?window.finishPrinting=()=>l(!1):l(!1),delete window.afterPrintCallback});setTimeout((()=>window.print()),0)}function r(e,t,o){const s=e.createFloatingRowModel(null),n=[];t.forEach(((e,t)=>{if("new"!==e){s._index(t),s.assign(e);const r=o(s);n.push(`<div class="print-row">${r.outerHTML}</div>`),i.dom.domDispose(r)}})),s.dispose();const r=(0,i.dom)("div.print-all-rows");return r.innerHTML=n.join("\n"),r}},50254:(e,t,o)=>{"use strict";o.r(t),o.d(t,{SelectionSummary:()=>g});var s=o(3719),i=o(61217),n=o(96682),r=o(92769),l=o(3871),a=o(8881),c=o(29922),d=o(7454),u=o(631),h=o(18099);const p=(0,o(70387).makeT)("SelectionSummary"),m=(0,h.makeTestId)("test-selection-summary-");class g extends h.Disposable{constructor(e,t,o,i){super(),this._cellSelector=e,this._tableData=t,this._sortedRows=o,this._viewFields=i,this._colTotalCount=h.Computed.create(this,(e=>e(e(this._viewFields).getObservable()).length)),this._rowTotalCount=h.Computed.create(this,(e=>{const t=e(this._sortedRows.getKoArray().getObservable()),o=t.length>0&&"new"===t[t.length-1];return t.length-(o?1:0)})),this._rowRange=h.Computed.create(this,(e=>{if(e(this._cellSelector.currentSelectType)===s.COL)return{begin:0,end:e(this._rowTotalCount)};{const t=e(this._cellSelector.row.start),o=e(this._cellSelector.row.end);return{begin:Math.min(t,o),end:Math.max(t,o)+1}}})),this._colRange=h.Computed.create(this,(e=>{if(e(this._cellSelector.currentSelectType)===s.ROW)return{begin:0,end:e(this._colTotalCount)};{const t=e(this._cellSelector.col.start),o=e(this._cellSelector.col.end);return{begin:Math.min(t,o),end:Math.max(t,o)+1}}})),this._summary=h.Observable.create(this,[]),this._delayedRecalc=this.autoDispose(n.Delay.create()),this.autoDispose(this._sortedRows.getKoArray().subscribe(this._onSpliceChange,this,"spliceChange"));const r=this._onRowNotify.bind(this);this._sortedRows.on("rowNotify",r),this.onDispose((()=>this._sortedRows.off("rowNotify",r))),this.autoDispose((0,h.subscribe)(this._rowRange,this._colRange,(()=>this._scheduleRecalc()))),this.autoDispose((0,c.isNarrowScreenObs)().addListener((e=>{e||this._scheduleRecalc()})))}buildDom(){return f(h.dom.forEach(this._summary,(({id:e,label:t,value:o,clickToCopy:s})=>w(t?(0,h.dom)("span",b(t),v("Copy")):null,o,w.cls("-copyable",Boolean(s)),s?h.dom.on("click",((e,t)=>async function(e,t){await(0,i.copyToClipboard)(e),(0,a.showTransientTooltip)(t,p("Copied to clipboard"),{key:"copy-selection-summary"})}(o,t))):null,m(e)))))}_onSpliceChange(e){const t=this._rowRange.get();1!=t.end-t.begin&&(e.start>=t.end||this._scheduleRecalc())}_onRowNotify(e){const t=this._rowRange.get();if(e===l.ALL)this._scheduleRecalc();else{const o=this._sortedRows.getKoArray().peek(),s=new Set(e);for(let e=t.begin;e<t.end;e++)if(s.has(o[e])){this._scheduleRecalc();break}}}_scheduleRecalc(){this._delayedRecalc.schedule(0,(()=>this._recalc()))}_recalc(){const e=this._rowRange.get(),t=this._colRange.get();let o=e.end-e.begin,s=t.end-t.begin;const i=o*s,n=[];if(i>1&&!(0,c.isNarrowScreen)()){if(i<=1e6){const i=this._sortedRows.getKoArray().peek(),l=this._viewFields.peek().peek();let a=0,c=0,d=0,h=null;const p=[];for(let t=e.begin;t<e.end;t++){const e=i[t];void 0!==e&&"new"!==e?p.push(this._tableData.getRowIdIndex(e)):o-=1}for(let e=t.begin;e<t.end;e++){if(void 0===l[e]){s-=1;continue}const t=l[e].column.peek(),o=l[e].displayColModel.peek(),i=t.type.peek(),n=l[e].visibleColModel.peek().type.peek(),m=null!=n?n:i,g=o.colId.peek(),f=this._tableData.getColValues(g);if(!f)throw new r.UserError(`Invalid column ${this._tableData.tableId}.${g}`);const w=["Numeric","Int","Any"].includes(m),b=i.startsWith("Ref:")&&!n?e=>0===e:(0,u.isRefListType)(i)||(0,u.isListType)(m)?u.isEmptyList:void 0;if(w){h||(h=l[e].formatter.peek());for(const e of p){const t=f[e];"number"==typeof t?(a++,d+=t):null==t||""===t||(null==b?void 0:b(t))||c++}}else for(const e of p){const t=f[e];null==t||""===t||(null==b?void 0:b(t))||c++}}if(a>0){const e=h?h.formatAny(d):String(d);n.push({id:"sum",label:"Sum ",value:e,clickToCopy:!0})}else n.push({id:"count",label:"Count ",value:String(c),clickToCopy:!0})}n.push({id:"dimensions",label:"",value:`${o}⨯${s}`})}this._summary.set(n)}}const f=(0,h.styled)("div",`\n  position: absolute;\n  bottom: -18px;\n  height: 18px;\n  line-height: 18px;\n  display: flex;\n  column-gap: 8px;\n  width: 100%;\n  justify-content: end;\n  color: ${c.theme.text};\n  font-family: ${c.vars.fontFamilyData};\n\n  @media print {\n    & {\n      display: none;\n    }\n  }\n`),w=(0,h.styled)("div",`\n  padding: 0 8px;\n  border-radius: 4px;\n  border-top-left-radius: 0px;\n  border-top-right-radius: 0px;\n  border-top: none;\n  z-index: 100;\n  position: relative;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  /* Set explicit backdrop to improve visibility in raw data views. */\n  background-color: ${c.theme.mainPanelBg};\n\n  &-copyable:hover {\n    cursor: pointer;\n  }\n  &::before {\n    content: "";\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    right: 0;\n    background-color: ${c.colors.mediumGrey};\n    opacity: 0.8;\n    z-index: -1;\n  }\n`),b=(0,h.styled)("span",`\n  font-size: ${c.vars.xsmallFontSize};\n  text-transform: uppercase;\n  position: relative;\n  margin-right: 4px;\n  .${w.className}-copyable:hover & {\n    visibility: hidden;\n  }\n`),v=(0,h.styled)(d.icon,`\n  position: absolute;\n  top: 0;\n  margin: 1px 0 0 4px;\n  --icon-color: ${c.theme.controlFg};\n  display: none;\n  .${w.className}-copyable:hover & {\n    display: block;\n  }\n`)},98279:(e,t,o)=>{"use strict";o.d(t,{j:()=>i});var s=o(18975);class i{constructor(e,t){this.plugin=e,this.importSource=t,this.importSourceStub=e.getStub(t.importSource,s.C4.InternalImportSourceAPI)}static fromArray(e){const t=[];for(const o of e){const e=o.definition.manifest.contributions.importSources;if(e)for(const s of e)t.push(new i(o,s))}return t}}},31248:(e,t,o)=>{"use strict";o.r(t),o.d(t,{onDblClickMatchElem:()=>i});var s=o(18099);function i(e,t,o){s.dom.styleElem(e,"touch-action","manipulation"),s.dom.onMatchElem(e,t,"dblclick",((e,t)=>{o(e,t)}));let i=0,n=null;s.dom.onMatchElem(e,t,"touchend",((e,t)=>{const s=Date.now(),r=s-i,l=t===n;i=s,n=t,l&&r<500&&r>0&&(e.preventDefault(),o(e,t))}))}},41675:(e,t,o)=>{"use strict";o.d(t,{a:()=>i});var s=o(62258);async function i(){const e=await(0,s.ic)();return new URLSearchParams(window.location.search).get("timezone")||e.tz.guess()}},88748:(e,t,o)=>{"use strict";o.d(t,{Xp:()=>P,i0:()=>M,Nj:()=>A});var s=o(41675),i=o(12856),n=o(55688);class r{constructor(e,t,o){this.pluginsList=[];for(const s of e)try{const e=s.manifest.components||{};if(e.safePython||e.unsafeNode)continue;const r=s.manifest.contributions.importSources;if(!(null==r?void 0:r.some((e=>e.safeHome))))continue;const a=new n.dl(s,(0,n.GO)(console,`HOME PLUGIN ${s.id}:`)),c=a.safeBrowser=new i.u0(a,o,t,e.safeBrowser);e.safeBrowser&&a.rpc.registerForwarder(e.safeBrowser,c);const d=new l;a.rpc.registerForwarder("*",{forwardCall:e=>d.forwardPluginRpc(s.id,e),forwardMessage:e=>d.forwardPluginRpc(s.id,e)}),this.pluginsList.push(a)}catch(e){console.error(`HomePluginManager: failed to instantiate ${s.id}: ${e.message}`)}}}class l{async forwardPluginRpc(e,t){throw new Error("This api is not available")}}var a=o(98279),c=o(76961),d=o(38109),u=o(92769),h=o(3988);if(179==o.j)var p=o(43272);var m,g=o(83277),f=o(56964),w=o(51503),b=o(18099),v=o(60611),_=o.n(v),y=Object.defineProperty,x=Object.defineProperties,S=Object.getOwnPropertyDescriptors,C=Object.getOwnPropertySymbols,I=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable,D=(e,t,o)=>t in e?y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const T=o(50949),k=o(91944);function M(e){const t=_().utc(e),o=_()(),s=o.diff(t,"s");return s<0&&s>-60?o.fromNow():t.fromNow()}class P extends(179==o.j?b.Disposable:null){constructor(e,t){if(super(),this._app=e,this.pageType="home",this.currentPage=b.Computed.create(this,(0,h.urlState)().state,((e,t)=>t.homePage||(void 0!==t.ws?"workspace":"all"))),this.currentWSId=b.Computed.create(this,(0,h.urlState)().state,((e,t)=>t.ws)),this.workspaces=b.Observable.create(this,[]),this.loading=b.Observable.create(this,!0),this.available=b.Observable.create(this,!1),this.singleWorkspace=b.Observable.create(this,!0),this.trashWorkspaces=b.Observable.create(this,[]),this.templateWorkspaces=b.Observable.create(this,[]),this.importSources=b.Observable.create(this,[]),this.currentWS=b.Computed.create(this,(e=>e(this.workspaces).find((t=>t.id===e(this.currentWSId))))),this.currentWSPinnedDocs=b.Computed.create(this,this.currentPage,this.currentWS,((e,t,o)=>{const s="all"===t?T(e(this.workspaces).map((e=>e.docs))):o?o.docs:[];return k(s.filter((e=>e.isPinned)),(e=>e.name.toLowerCase()))})),this.featuredTemplates=b.Computed.create(this,this.templateWorkspaces,((e,t)=>{const o=T(t.map((e=>e.docs))).filter((e=>e.isPinned));return k(o,(e=>e.name.toLowerCase()))})),this.otherSites=b.Computed.create(this,this.currentPage,this.app.topAppModel.orgs,((e,t,o)=>{if("all"!==t)return[];const s=this._app.currentOrg;return s&&(s.owner||"viewers"===s.access&&s.public)?o.filter((e=>e.id!==s.id)):[]})),this.newDocWorkspace=b.Computed.create(this,this.currentPage,this.currentWS,((e,t,o)=>{if(!this.app.currentValidUser)return"unsaved";if("trash"===t)return null;const s=["all","templates"].includes(t)?e(this.workspaces)[0]||null:o;return s&&w.J5(s.access)?s:null})),this.showIntro=b.Computed.create(this,this.workspaces,((e,t)=>t.every((e=>e.isSupportWorkspace||0===e.docs.length)))),this.shouldShowAddNewTip=b.Observable.create(this,!this._app.behavioralPromptsManager.hasSeenTip("addNew")),this._userOrgPrefs=b.Observable.create(this,null==(m=this._app.currentOrg)?void 0:m.userOrgPrefs),this.app.currentValidUser)this.currentSort=b.Computed.create(this,this._userOrgPrefs,((e,t)=>f.SortPref.parse(null==t?void 0:t.docMenuSort)||"name")).onWrite((e=>this._saveUserOrgPref("docMenuSort",e))),this.currentView=b.Computed.create(this,this._userOrgPrefs,((e,t)=>f.ViewPref.parse(null==t?void 0:t.docMenuView)||function(e){const t=e.filter((e=>!e.isSupportWorkspace)),o=t.reduce(((e,t)=>e+t.docs.length),0),s=t.some((e=>e.docs.some((e=>e.isPinned))));return o>4||s?"list":"icons"}(e(this.workspaces)))).onWrite((e=>this._saveUserOrgPref("docMenuView",e)));else{const e=A(null,"all");this.currentSort=e.currentSort,this.currentView=e.currentView}this.autoDispose((0,b.subscribe)(this.currentPage,this.currentWSId,(e=>this._updateWorkspaces().catch(d.eK))));const o=new r(e.topAppModel.plugins,e.topAppModel.getUntrustedContentOrigin(),t),s=a.j.fromArray(o.pluginsList);this.importSources.set(s),this._app.refreshOrgUsage().catch(d.eK)}get app(){return this._app}async createWorkspace(e){const t=this._app.currentOrg;t&&(this._checkForDuplicates(e),await this._app.api.newWorkspace({name:e},t.id),await this._updateWorkspaces())}async renameWorkspace(e,t){this._checkForDuplicates(t),await this._app.api.renameWorkspace(e,t),await this._updateWorkspaces()}async deleteWorkspace(e,t){await(t?this._app.api.deleteWorkspace(e):this._app.api.softDeleteWorkspace(e)),await this._updateWorkspaces()}async restoreWorkspace(e){await this._app.api.undeleteWorkspace(e.id),await this._updateWorkspaces(),(0,u.reportMessage)(`Workspace "${e.name}" restored`)}async createDoc(e,t){if("unsaved"===t){const e=await(0,s.a)();return await this._app.api.newUnsavedDoc({timezone:e})}const o=await this._app.api.newDoc({name:e},t);return await this._updateWorkspaces(),o}async renameDoc(e,t){await this._app.api.renameDoc(e,t),await this._updateWorkspaces()}async deleteDoc(e,t){await(t?this._app.api.deleteDoc(e):this._app.api.softDeleteDoc(e)),await this._updateWorkspaces()}async restoreDoc(e){await this._app.api.undeleteDoc(e.id),await this._updateWorkspaces(),(0,u.reportMessage)(`Document "${e.name}" restored`)}async pinUnpinDoc(e,t){await(t?this._app.api.pinDoc(e):this._app.api.unpinDoc(e)),await this._updateWorkspaces()}async moveDoc(e,t){await this._app.api.moveDoc(e,t),await this._updateWorkspaces()}_checkForDuplicates(e){if(this.workspaces.get().find((t=>t.name===e)))throw new u.UserError("Name already exists. Please choose a different name.")}async _updateWorkspaces(){if(this.isDisposed())return;const e=this._app.currentOrg;if(!e)return this.workspaces.set([]),this.trashWorkspaces.set([]),void this.templateWorkspaces.set([]);this.loading.set(!0);const t=this.currentPage.get(),o=[this._fetchWorkspaces(e.id,!1).catch(d.eK),"trash"===t?this._fetchWorkspaces(e.id,!0).catch(d.eK):null,this._maybeFetchTemplates()],s=Promise.all(o);await(0,g.isLongerThan)(s,500)&&this.loading.set("slow");const[i,n,r]=await s;this.isDisposed()||(0,b.bundleChanges)((()=>{this.workspaces.set(i||[]),this.trashWorkspaces.set(n||[]),this.templateWorkspaces.set(r||[]),this.loading.set(!1),this.available.set(!!i);const e=Array.isArray(i)?i.filter((e=>!e.isSupportWorkspace)):null;this.singleWorkspace.set(!!e&&1===e.length&&1===this._app.currentFeatures.maxWorkspacesPerOrg)}))}async _fetchWorkspaces(e,t){var o;let s=this._app.api;t&&(s=s.forRemoved());const i=await s.getOrgWorkspaces(e);if(this.isDisposed())return null;for(const e of i){if(e.docs=k(e.docs,(e=>e.name.toLowerCase())),t)for(const t of e.docs)t.removedAt=t.removedAt||e.removedAt;for(const t of e.docs)t.workspace=null!=(o=t.workspace)?o:e}return k(i,(e=>[e.isSupportWorkspace,(0,p.pE)(this._app,e).toLowerCase(),e.name.toLowerCase()]))}async _maybeFetchTemplates(){var e;const t=this.currentPage.get();if(!["all","templates"].includes(t))return null;let o=[];try{const e="all"===t;o=await this._app.api.getTemplates(e)}catch(e){return null}if(this.isDisposed())return null;for(const t of o){for(const o of t.docs)o.workspace=null!=(e=o.workspace)?e:t;t.docs=k(t.docs,(e=>e.name.toLowerCase()))}return o}async _saveUserOrgPref(e,t){const o=this._app.currentOrg;var s;o&&(o.userOrgPrefs=(s=((e,t)=>{for(var o in t||(t={}))I.call(t,o)&&D(e,o,t[o]);if(C)for(var o of C(t))R.call(t,o)&&D(e,o,t[o]);return e})({},o.userOrgPrefs),x(s,S({[e]:t}))),this._userOrgPrefs.set(o.userOrgPrefs),await this._app.api.updateOrg("current",{userOrgPrefs:o.userOrgPrefs}))}}function A(e,t){var o;const s=(null==(o=null==e?void 0:e.app.currentUser)?void 0:o.id)||0,i=(0,c.BW)(`u=${s}:ws=${t}:sort`),n=(0,c.BW)(`u=${s}:ws=${t}:view`);return{currentSort:b.Computed.create(null,(t=>f.SortPref.parse(t(i))||(e?t(e.currentSort):"name"))).onWrite((e=>i.set(e))),currentView:b.Computed.create(null,(o=>f.ViewPref.parse(o(n))||("trash"===t?"list":e?o(e.currentView):"icons"))).onWrite((e=>n.set(e)))}}},43272:(e,t,o)=>{"use strict";function s(e,t){const{owner:o,name:s}=n(e,t);return[s,o?`@${o.name}`:""].join(" ").trim()}function i(e,t){const{owner:o,self:s}=n(e,t);return s?"":o?o.name:""}function n(e,t){const o=e.currentUser,{name:s,owner:i}=t,n="Home"===s;if(!o||!i)return{owner:i,name:s};const r=o.id===i.id,l=r&&n;return t.isSupportWorkspace?{name:s,self:r,isDefault:l}:n&&!l?{name:"",owner:i,self:r,isDefault:l}:r?{name:s,self:r,isDefault:l}:{name:s,owner:i,self:r,isDefault:l}}o.d(t,{BT:()=>n,pE:()=>i,rq:()=>s})},58847:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CellContextMenu:()=>c});var s=o(24412),i=o(70387),n=o(1370),r=o(36258),l=o(18099);const a=(0,i.makeT)("CellContextMenu");function c(e,t){const{disableInsert:o,disableDelete:i,isViewSorted:c}=e,{disableModify:d,isReadonly:u}=t,h=l.dom.cls("disabled",Boolean(d)||u),p=l.dom.cls("disabled",u),m=t.numColumns,g=t.isFiltered?a("Reset {{count}} entire columns",{count:m}):a("Reset {{count}} columns",{count:m}),f=a("Delete {{count}} columns",{count:m}),w=e.numRows,b=a("Delete {{count}} rows",{count:w}),v=a(w>1||m>1?"Clear values":"Clear cell"),_=[];return _.push(t.isFormula?null:(0,n.menuItemCmd)(s.allCommands.clearValues,v,h),(0,n.menuItemCmd)(s.allCommands.clearColumns,g,h),...m>1||w>1?[]:[(0,n.menuDivider)(),(0,n.menuItemCmd)(s.allCommands.copyLink,a("Copy anchor link")),(0,n.menuDivider)(),(0,n.menuItemCmd)(s.allCommands.filterByThisCellValue,a("Filter by this value")),(0,n.menuItemCmd)(s.allCommands.openDiscussion,"Comment",l.dom.cls("disabled",u||0===w||0===m),l.dom.hide((e=>!e((0,r.COMMENTS)()))))],(0,n.menuDivider)(),...c?[(0,n.menuItemCmd)(s.allCommands.insertRecordAfter,a("Insert row"),l.dom.cls("disabled",o))]:[(0,n.menuItemCmd)(s.allCommands.insertRecordBefore,a("Insert row above"),l.dom.cls("disabled",o)),(0,n.menuItemCmd)(s.allCommands.insertRecordAfter,a("Insert row below"),l.dom.cls("disabled",o))],(0,n.menuItemCmd)(s.allCommands.duplicateRows,a("Duplicate rows",{count:w}),l.dom.cls("disabled",o||0===w)),(0,n.menuItemCmd)(s.allCommands.insertFieldBefore,a("Insert column to the left"),p),(0,n.menuItemCmd)(s.allCommands.insertFieldAfter,a("Insert column to the right"),p),(0,n.menuDivider)(),(0,n.menuItemCmd)(s.allCommands.deleteRecords,b,l.dom.cls("disabled",i)),(0,n.menuItemCmd)(s.allCommands.deleteFields,f,h)),_}},36524:(e,t,o)=>{"use strict";o.d(t,{AV:()=>k,BS:()=>R,C4:()=>_,CT:()=>V,D2:()=>E,DC:()=>v,F5:()=>W,FS:()=>y,J7:()=>m,Jj:()=>T,Lc:()=>B,ME:()=>S,P2:()=>b,Pt:()=>K,Ri:()=>w,S1:()=>L,SH:()=>A,XN:()=>f,Zw:()=>g,az:()=>h,e9:()=>O,eo:()=>c,f:()=>U,fK:()=>N,gs:()=>u,h9:()=>J,j2:()=>I,lY:()=>j,m2:()=>H,mV:()=>$,nm:()=>z,o9:()=>F,qE:()=>C,qk:()=>p,tp:()=>M,ud:()=>G,uj:()=>x,vs:()=>P,wj:()=>a});var s=o(68370),i=o(29922),n=o(7454),r=o(18099),l=o(11187);o(21467);const a=(0,r.styled)("div","\n  flex-grow: 1;\n  max-width: 100%;\n"),c=(0,r.styled)("div",`\n  height: 100%;\n  padding: 32px 64px 24px 64px;\n  overflow-y: auto;\n  position: relative;\n  display: flex;\n\n  &:after {\n    content: "";\n    display: block;\n    height: 64px;\n  }\n  @media ${i.mediaSmall} {\n    & {\n      padding: 32px 24px 24px 24px;\n    }\n  }\n  @media print {\n    & {\n      display: none;\n    }\n  }\n`),d=(0,r.styled)("div",`\n  min-height: 32px;\n  line-height: 32px;\n  color: ${i.theme.text};\n  font-size: ${i.vars.xxxlargeFontSize};\n  font-weight: ${i.vars.headerControlTextWeight};\n`),u=(0,r.styled)(d,"\n  margin-bottom: 24px;\n"),h=(0,r.styled)("div",`\n  display: flex;\n  align-items: baseline;\n  justify-content: space-between;\n  gap: 16px;\n  margin-bottom: 24px;\n\n  @media ${i.mediaSmall} {\n    & {\n      flex-direction: column;\n      align-items: flex-start;\n    }\n  }\n`),p=(0,r.styled)(d,"\n  cursor: pointer;\n"),m=(0,r.styled)(u,"\n  display: flex;\n  align-items: center;\n"),g=179==o.j?p:null,f=(0,r.styled)("div","\n  display: flex;\n"),w=(0,r.styled)("div",`\n  color: ${i.theme.text};\n  max-width: 550px;\n  min-width: 300px;\n  margin-bottom: 28px;\n\n  &-icons {\n    max-width: max-content;\n    min-width: calc(min(550px, 100%));\n  }\n`),b=(0,r.styled)(w,"\n  margin-top: 32px;\n"),v=(0,r.styled)("div",`\n  color: ${i.theme.text};\n  margin-bottom: 32px;\n`),_=(0,r.styled)("div","\n  display: flex;\n  overflow: auto;\n  padding-bottom: 16px;\n  margin-top: 16px;\n  margin-bottom: 28px;\n  gap: 16px;\n"),y=(0,r.styled)(l.bigBasicButton,"\n  flex: 0 0 auto;\n"),x=(0,r.styled)(n.icon,`\n  margin-right: 8px;\n  margin-top: -3px;\n  --icon-color: ${i.theme.lightText};\n`),S=(0,r.styled)(x,`\n  --icon-color: ${i.theme.text};\n`),C=(0,r.styled)(n.icon,`\n  --icon-color: ${i.theme.text};\n  margin-right: 8px;\n  width: 20px;\n  height: 20px;\n`),I=(0,r.styled)(x,"\n  width: 24px;\n  height: 24px;\n"),R=179==o.j?I:null,D=`\n  display: flex;\n  align-items: center;\n  height: 40px;\n  line-height: 40px;\n  margin-bottom: 8px;\n  margin-right: -16px;\n  color: ${i.theme.text};\n  font-size: ${i.vars.mediumFontSize};\n  font-weight: bold;\n  &, &:hover, &:focus {\n    text-decoration: none;\n    outline: none;\n    color: inherit;\n  }\n`,T=(0,r.styled)("a",D),k=(0,r.styled)("div",D),M=(0,r.styled)("div",`\n  color: ${i.theme.text};\n  flex: 1 0 50%;\n  min-width: 0px;\n  margin-right: 24px;\n`),P=(0,r.styled)("div",`\n  position: relative;\n  margin: 0px -16px 8px -16px;\n  border-radius: 3px;\n  font-size: ${i.vars.mediumFontSize};\n  color: ${i.theme.text};\n  --icon-color: ${i.theme.lightText};\n\n  &:hover, &.weasel-popup-open, &-renaming {\n    background-color: ${i.theme.hover};\n  }\n`),A=(0,r.styled)("a",`\n  display: flex;\n  align-items: center;\n  height: 40px;\n  line-height: 40px;\n  border-radius: 3px;\n  outline: none;\n  transition: background-color 2s;\n  &, &:hover, &:focus {\n    text-decoration: none;\n    outline: none;\n    color: inherit;\n  }\n  &-no-access, &-no-access:hover, &-no-access:focus {\n    color: ${i.theme.disabledText};\n    cursor: not-allowed;\n  }\n`),O=(0,r.styled)("div","\n  flex: 1 0 50%;\n  min-width: 0px;\n  margin: 0 16px;\n  display: flex;\n  align-items: center;\n"),F=(0,r.styled)("div","\n  flex: 0 1 auto;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n"),E=(0,r.styled)(n.icon,`\n  flex: none;\n  margin-left: 4px;\n  --icon-color: ${i.theme.accentIcon};\n`),B=(0,r.styled)(n.icon,`\n  flex: none;\n  margin-left: auto;\n  --icon-color: ${i.theme.accentIcon};\n`),L=(0,r.styled)(s.o,"\n  flex: 1 0 50%;\n  min-width: 0px;\n  margin: 0 16px;\n  color: initial;\n  font-size: inherit;\n  line-height: initial;\n"),$=(0,r.styled)("div",`\n  flex: 1 1 50%;\n  color: ${i.theme.lightText};\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-weight: normal;\n`),U=(0,r.styled)("div",`\n  flex: none;\n  margin: 0 4px 0 auto;\n  height: 24px;\n  width: 24px;\n  padding: 4px;\n  line-height: 0px;\n  border-radius: 3px;\n  cursor: default;\n  --icon-color: ${i.theme.docMenuDocOptionsFg};\n  .${A.className}:hover > & {\n    --icon-color: ${i.theme.docMenuDocOptionsHoverFg};\n  }\n  &:hover, &.weasel-popup-open {\n    background-color: ${i.theme.docMenuDocOptionsHoverBg};\n    --icon-color: ${i.theme.docMenuDocOptionsHoverFg};\n  }\n`),z=(0,r.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  border-bottom: 1px solid ${i.theme.modalBorderDark};\n  margin: 0 -64px;\n  height: 200px;\n`),V=(0,r.styled)("div",`\n  display: flex;\n  justify-content: space-between;\n  width: 100%;\n  height: 32px;\n  padding: 12px 64px;\n  cursor: pointer;\n  font-size: ${i.vars.mediumFontSize};\n\n  &-selected {\n    background-color: ${i.theme.moveDocsSelectedBg};\n    color: ${i.theme.moveDocsSelectedFg};\n  }\n  &-disabled {\n    color: ${i.theme.moveDocsDisabledFg};\n    cursor: default;\n  }\n`),N=(0,r.styled)("div","\n  display: flex;\n  flex: 1 1 0;\n  flex-direction: column;\n  justify-content: center;\n"),W=(0,r.styled)(N,"\n  text-align: right;\n"),j=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  height: 80px;\n  margin: auto;\n  margin-top: 80px;\n"),H=(0,r.styled)("div","\n  float: right;\n  display: flex;\n  align-items: center;\n"),G=(0,r.styled)("div",`\n  margin-right: 24px;\n\n  /* negate the styles of a select that normally looks like a button */\n  border: none;\n  display: inline-flex;\n  height: unset;\n  line-height: unset;\n  align-items: center;\n  border-radius: ${i.vars.controlBorderRadius};\n  color: ${i.theme.controlFg};\n  --icon-color: ${i.theme.controlFg};\n  background-color: unset;\n\n  &:focus, &:hover {\n    outline: none;\n    box-shadow: none;\n    background-color: ${i.theme.hover};\n  }\n  @media ${i.mediaSmall} {\n    & {\n      margin-right: 0;\n    }\n  }\n`),K=(0,r.styled)("div",`\n  margin-left: 32px;\n\n  @media ${i.mediaSmall} {\n    & {\n      margin-left: 8px;\n    }\n  }\n`),J=(0,r.styled)("div","\n  margin-left: 64px;\n")},84602:(e,t,o)=>{"use strict";o.d(t,{ED:()=>w,K1:()=>v,Ot:()=>_,_5:()=>c,ct:()=>b,gQ:()=>y});var s=o(97837),i=o(29922),n=o(7454),r=o(4425),l=o(18099);let a=null;function c(e,t){const{elem:o,markAsSeen:n,reopen:r}=t,c=e.welcomeCard;if(!c)return null;const x=h(p({src:e.imgUrl}),m(g(c.title),f(c.text),w(b(v("Page"),c.tutorialName,{href:e.tutorialUrl,target:"_blank"}))),_(y("CrossBig"),l.dom.on("click",(function(){a=null,function(e,t){new s.T9(e).onDispose((()=>d(e))),u(e,t)}(x,o.getBoundingClientRect()),n()})),(0,i.testId)("example-card-close")),(0,i.testId)("example-card"));document.body.appendChild(x),r&&function(e,t){(0,s.b1)(e,(()=>u(e,t))),Object.assign(e.style,{transform:"",opacity:"",visibility:"visible"})}(x,o.getBoundingClientRect()),null==a||a(),a=()=>d(x)}function d(e){l.dom.domDispose(e),e.remove()}function u(e,t){const o=e.getBoundingClientRect(),s=t.left+t.width/2-o.left,i=t.top+t.height/2-o.top;Object.assign(e.style,{transform:`scale(${t.width/o.width}, ${t.height/o.height})`,transformOrigin:`${s}px ${i}px`,opacity:"0"})}const h=(0,l.styled)("div",`\n  position: absolute;\n  left: 24px;\n  bottom: 24px;\n  margin-right: 24px;\n  max-width: 624px;\n  padding: 32px 56px 32px 32px;\n  background-color: ${i.theme.popupBg};\n  box-shadow: 0 2px 18px 0 ${i.theme.popupInnerShadow}, 0 0 1px 0 ${i.theme.popupOuterShadow};\n  display: flex;\n  overflow: hidden;\n  transition-property: opacity, transform;\n  transition-duration: 0.5s;\n  transition-timing-func: ease-in;\n  --title-font-size: ${i.vars.headerControlFontSize};\n\n  @media ${i.mediaXSmall} {\n    & {\n      flex-direction: column;\n      padding: 32px;\n      --title-font-size: 18px;\n    }\n  }\n`),p=(0,l.styled)("img",`\n  flex: none;\n  width: 180px;\n  height: 140px;\n  margin: 0 16px 0 -8px;\n  @media ${i.mediaXSmall} {\n    & {\n      margin: auto;\n    }\n  }\n`),m=(0,l.styled)("div",`\n  color: ${i.theme.text};\n  min-width: 0px;\n`),g=(0,l.styled)("div",`\n  color: ${i.theme.text};\n  font-size: var(--title-font-size);\n  font-weight: ${i.vars.headerControlTextWeight};\n  margin-bottom: 16px;\n`),f=(0,l.styled)("div","\n  margin: 16px 0 24px 0;\n  line-height: 1.6;\n"),w=(0,l.styled)("div","\n  display: flex;\n"),b=(0,l.styled)(r.Y3,"\n  &:not(:last-child) {\n    margin-right: 32px;\n  }\n"),v=(0,l.styled)(n.icon,"\n  margin-right: 8px;\n  margin-top: -2px;\n"),_=(0,l.styled)("div",`\n  position: absolute;\n  top: 8px;\n  right: 8px;\n  padding: 4px;\n  border-radius: 4px;\n  cursor: pointer;\n  --icon-color: ${i.theme.popupCloseButtonFg};\n\n  &:hover {\n    background-color: ${i.theme.hover};\n  }\n`),y=(0,l.styled)(n.icon,"\n  padding: 12px;\n")},7916:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ColumnAddMenu:()=>h,ColumnContextMenu:()=>m,MultiColumnMenu:()=>g,calcFieldsCondition:()=>p,freezeAction:()=>f});var s=o(70387),i=o(24412),n=o(29922),r=o(7454),l=o(1370),a=o(48210),c=o(18099);const d=o(36812),u=(0,s.makeT)("GridViewMenus");function h(e,t){return[(0,l.menuItem)((()=>e.addNewColumn()),u("Add Column")),(0,l.menuDivider)(),...t.hiddenColumns().map((o=>(0,l.menuItem)((()=>{e.showColumn(o.id(),t.viewFields().peekLength)}),u("Show column {{- label}}",{label:o.label()}))))]}function p(e,t){return!!e.every(t)||!!e.some(t)&&"mixed"}function m(e){const{disableModify:t,filterOpenFunc:o,colId:s,sortSpec:h,isReadonly:p}=e,m=c.dom.cls("disabled",Boolean(t)||p),f=function(e,t){const o=e.map((e=>a.Sort.getColRef(e)));if(0!==e.length&&!d(o,[t])){const e=o.indexOf(t);return e>-1?u("Sorted (#{{count}})",{count:e+1}):u("Add to sort")}}(h,s);return[(0,l.menuItemCmd)(i.allCommands.fieldTabOpen,u("Column Options")),(0,l.menuItem)(o,u("Filter Data")),(0,l.menuDivider)({style:"margin-bottom: 0;"}),b(y(i.allCommands.sortAsc.run,(0,c.dom)("span",u("Sort"),{style:"flex: 1  0 auto; margin-right: 8px;"},(0,n.testId)("sort-label")),(0,r.icon)("Sort",c.dom.style("transform","scaley(-1)")),"A-Z",c.dom.style("flex",""),_.cls("-selected",a.Sort.containsOnly(h,s,a.Sort.ASC)),(0,n.testId)("sort-asc")),y(i.allCommands.sortDesc.run,(0,r.icon)("Sort"),"Z-A",_.cls("-selected",a.Sort.containsOnly(h,s,a.Sort.DESC)),(0,n.testId)("sort-dsc")),(0,n.testId)("sort")),f?[b(y(i.allCommands.addSortAsc.run,v(f,(0,n.testId)("add-to-sort-label")),(0,r.icon)("Sort",c.dom.style("transform","scaley(-1)")),"A-Z",_.cls("-selected",a.Sort.contains(h,s,a.Sort.ASC)),(0,n.testId)("add-to-sort-asc")),y(i.allCommands.addSortDesc.run,(0,r.icon)("Sort"),"Z-A",_.cls("-selected",a.Sort.contains(h,s,a.Sort.DESC)),(0,n.testId)("add-to-sort-dsc")),(0,n.testId)("add-to-sort"))]:null,(0,l.menuDivider)({style:"margin-bottom: 0; margin-top: 0;"}),(0,l.menuItem)(i.allCommands.sortFilterTabOpen.run,u("More sort options ..."),(0,n.testId)("more-sort-options")),(0,l.menuDivider)({style:"margin-top: 0;"}),(0,l.menuItemCmd)(i.allCommands.renameField,u("Rename column"),m),w(e),(0,l.menuDivider)(),g((e.disableFrozenMenu=!0,e)),(0,n.testId)("column-menu")]}function g(e){const t=c.dom.cls("disabled",Boolean(e.disableModify)||e.isReadonly),o=c.dom.cls("disabled",e.isReadonly),s=e.numColumns,n=e.isFiltered?u("Reset {{count}} entire columns",{count:s}):u("Reset {{count}} columns",{count:s}),r=u("Delete {{count}} columns",{count:s}),a=u("Hide {{count}} columns",{count:s}),d=e.disableFrozenMenu?null:w(e);return[d?[d,(0,l.menuDivider)()]:null,e.isFormula?(0,l.menuItemCmd)(i.allCommands.convertFormulasToData,u("Convert formula to data"),t):null,!0!==e.isFormula?(0,l.menuItemCmd)(i.allCommands.clearValues,u("Clear values"),t):null,e.isRaw?null:(0,l.menuItemCmd)(i.allCommands.hideFields,a,o),(0,l.menuItemCmd)(i.allCommands.clearColumns,n,t),(0,l.menuItemCmd)(i.allCommands.deleteFields,r,t),(0,l.menuDivider)(),(0,l.menuItemCmd)(i.allCommands.insertFieldBefore,u("Insert column to the {{to}}",{to:"left"}),o),(0,l.menuItemCmd)(i.allCommands.insertFieldAfter,u("Insert column to the {{to}}",{to:"right"}),o)]}function f(e){const t=e.numColumns;if(0===t)return null;const o=e.columnIndices,s=o[0],i=o[o.length-1],n=e.numFrozen;if(i==e.totalColumnCount-1)return null;const r=1===t&&s+1>n,l=1===t&&s+1<=n,a=t>1,c=a&&s===n,d=a&&s<=n&&i>=n;let h="";if(a){if(a&&i+1===n)return h=u("Unfreeze {{count}} columns",{count:t}),{text:h,numFrozen:n-t};if(c)return h=u("Freeze {{count}} columns",{count:t}),{text:h,numFrozen:n+t};if(d){const e=i+1-n;return h=u("Freeze {{count}} more columns",{count:e}),{text:h,numFrozen:n+e}}return null}if(r){if(0===s||s===n)h=u("Freeze {{count}} columns",{count:1});else{h=u(n?"Freeze {{count}} more columns":"Freeze {{count}} columns",{count:s-n+1})}return{text:h,numFrozen:s+1}}if(l){if(s+1===n)h=u("Unfreeze {{count}} columns",{count:1});else{const e=n-s;h=e===n?u("Unfreeze all columns"):u("Unfreeze {{count}} columns",{count:e})}return{text:h,numFrozen:o[0]}}return null}function w(e){const t=f(e);return t?(0,l.menuItemCmd)(i.allCommands.toggleFreeze,t.text):null}const b=(0,c.styled)(((...e)=>(0,c.dom)("li",{tabindex:"-1"},...e)),"\n  display: flex;\n  outline: none;\n"),v=(0,c.styled)("div","\n  margin-right: 8px;\n  flex: 1 0 auto;\n"),_=(0,c.styled)("div",`\n  padding: 8px 8px;\n  display: flex;\n  &:not(:hover) {\n    background-color: ${n.theme.menuBg};\n    color: ${n.theme.menuItemFg};\n    --icon-color: ${n.theme.menuItemFg};\n  }\n  &:last-of-type {\n    padding-right: 24px;\n    flex: 0 0 auto;\n  }\n  &:first-of-type {\n    padding-left: 24px;\n    flex: 1 0 auto;\n  }\n  &-selected, &-selected:not(:hover) {\n    background-color: ${n.theme.menuItemSelectedBg};\n    color: ${n.theme.menuItemSelectedFg};\n    --icon-color: ${n.theme.menuItemSelectedFg};\n  }\n`);function y(e,...t){return _(...t,c.dom.on("click",(()=>e())))}},42882:(e,t,o)=>{"use strict";o.r(t),o.d(t,{menuToggle:()=>r});var s=o(29922),i=o(7454),n=o(18099);function r(e,...t){return l((0,i.icon)("Dropdown",n.dom.cls("menu_toggle_icon")),...t)}const l=(0,n.styled)("div.menu_toggle",`\n  background: ${s.theme.menuToggleBg};\n  cursor: pointer;\n  --icon-color: ${s.theme.menuToggleFg};\n  border: 1px solid ${s.theme.menuToggleBorder};\n  border-radius: 4px;\n  &:hover  {\n    --icon-color: ${s.theme.menuToggleHoverFg};\n    border-color: ${s.theme.menuToggleHoverFg};\n  }\n  &:active  {\n    --icon-color: ${s.theme.menuToggleActiveFg};\n    border-color: ${s.theme.menuToggleActiveFg};\n  }\n  & > .menu_toggle_icon {\n    display: block; /* don't create a line */\n  }\n`)},19085:(e,t,o)=>{"use strict";o.r(t),o.d(t,{RowContextMenu:()=>a});var s=o(24412),i=o(70387),n=o(1370),r=o(18099);const l=(0,i.makeT)("RowContextMenu");function a({disableInsert:e,disableDelete:t,isViewSorted:o,numRows:i}){const a=[];return o?a.push((0,n.menuItemCmd)(s.allCommands.insertRecordAfter,l("Insert row"),r.dom.cls("disabled",e))):a.push((0,n.menuItemCmd)(s.allCommands.insertRecordBefore,l("Insert row above"),r.dom.cls("disabled",e)),(0,n.menuItemCmd)(s.allCommands.insertRecordAfter,l("Insert row below"),r.dom.cls("disabled",e))),a.push((0,n.menuItemCmd)(s.allCommands.duplicateRows,l("Duplicate rows",{count:i}),r.dom.cls("disabled",e||0===i))),a.push((0,n.menuDivider)(),(0,n.menuItemCmd)(s.allCommands.deleteRecords,l("Delete"),r.dom.cls("disabled",t))),a.push((0,n.menuDivider)(),(0,n.menuItemCmd)(s.allCommands.copyLink,l("Copy anchor link"))),a}},19058:(e,t,o)=>{"use strict";o.d(t,{KA:()=>h,ND:()=>m,T7:()=>l,XL:()=>a,bE:()=>b,dg:()=>g,fe:()=>w,gE:()=>u,hS:()=>p,j$:()=>f,rk:()=>c,tE:()=>d});var s=o(29922),i=o(7454),n=o(18099),r=o(21467);const l=(0,n.styled)("div","\n  display: flex;\n  width: 460px;\n  min-height: 64px;\n  margin: 0 auto;\n  padding: 12px 0;\n"),a=(0,n.styled)("div",`\n  width: 40px;\n  height: 40px;\n  margin: 0 4px;\n  border-radius: 20px;\n  background-color: ${s.colors.lightGreen};\n  background-size: cover;\n\n  .${l.className}-removed & {\n    opacity: 0.4;\n  }\n`),c=(0,n.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  margin: 2px 12px;\n  flex: 1 1 0;\n  min-width: 0px;\n  font-size: ${s.vars.mediumFontSize};\n\n  .${l.className}-removed & {\n    opacity: 0.4;\n  }\n`),d=(0,n.styled)("span",`\n  font-weight: bold;\n  color: ${s.theme.text};\n  padding: 2px 0;\n\n  .${r.cssMenuItem.className}-sel & {\n    color: ${s.theme.menuItemSelectedFg};\n  }\n`),u=(0,n.styled)("span",`\n  color: ${s.theme.lightText};\n  /* the following just undo annoying bootstrap styles that apply to all labels */\n  margin: 0px;\n  font-weight: normal;\n  padding: 2px 0;\n  white-space: nowrap;\n\n  .${r.cssMenuItem.className}-sel & {\n    color: ${s.theme.menuItemSelectedFg};\n  }\n`),h=(0,n.styled)("span",`\n  color: ${s.theme.lightText};\n  /* the following just undo annoying bootstrap styles that apply to all labels */\n  margin: 0px;\n  font-weight: normal;\n  padding: 2px 0;\n  white-space: nowrap;\n\n  .${r.cssMenuItem.className}-sel & {\n    color: ${s.theme.menuItemSelectedFg};\n  }\n`),p=(0,n.styled)("span",`\n  color: ${s.theme.errorText};\n  /* the following just undo annoying bootstrap styles that apply to all labels */\n  margin: 0px;\n  font-weight: normal;\n  padding: 2px 0;\n  white-space: nowrap;\n\n  .${r.cssMenuItem.className}-sel & {\n    color: ${s.theme.menuItemSelectedFg};\n  }\n`),m=(0,n.styled)("div","\n  width: 16px;\n  height: 16px;\n  cursor: pointer;\n\n  &-disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n"),g=(0,n.styled)(i.icon,`\n  background-color: ${s.theme.lightText};\n  margin: 12px 0;\n`),f=(0,n.styled)("div",`\n  position: relative;\n  display: flex;\n  height: 42px;\n  padding: 0 3px;\n  margin: 16px 63px;\n  border: 1px solid ${s.theme.inputBorder};\n  border-radius: 3px;\n  font-size: ${s.vars.mediumFontSize};\n  outline: none;\n\n  &-green {\n    border: 1px solid ${s.theme.inputValid};\n  }\n`),w=(0,n.styled)(n.input,`\n  color: ${s.theme.inputFg};\n  background-color: ${s.theme.inputBg};\n  flex: 1 1 0;\n  font-size: ${s.vars.mediumFontSize};\n  font-family: ${s.vars.fontFamily};\n  outline: none;\n  border: none;\n\n  &::placeholder {\n    color: ${s.theme.inputPlaceholderFg};\n  }\n`),b=(0,n.styled)(i.icon,`\n  margin: 12px 8px 12px 13px;\n  background-color: ${s.theme.lightText};\n`)},74624:(e,t,o)=>{"use strict";o.r(t),o.d(t,{contextMenu:()=>l});var s=o(18099),i=o(1370),n=o(21467);class r extends s.Disposable{constructor(e,t){super(),this._event=e,setTimeout((()=>this._updatePosition()),0);const o=n.Menu.create(null,this,[t(this)],{menuCssClass:i.cssMenuElem.className+" grist-floating-menu"}),r=this._content=o.content;r.style.visibility="hidden",document.body.appendChild(r),s.dom.onKeyElem(r,"keydown",{ArrowLeft:e=>e.stopPropagation(),ArrowRight:e=>e.stopPropagation()});const l=e=>{const t=e.target;t&&!r.contains(t)&&this.close()};this.autoDispose(s.dom.onElem(document,"contextmenu",l,{useCapture:!0})),this.autoDispose(s.dom.onElem(document,"click",l,{useCapture:!0})),this.onDispose((()=>{s.dom.domDispose(r),r.remove()})),(0,i.registerMenuOpen)(this)}close(){this.dispose()}setOpenClass(){}getTriggerElem(){return document.body}update(){}_updatePosition(){const e=this._content,t=this._event,o=e.getBoundingClientRect();e.style.left=(t.pageX+o.width<window.innerWidth?t.pageX:t.pageX-o.width)+"px",e.style.bottom=Math.max(window.innerHeight-(t.pageY+o.height),0)+"px",e.style.visibility=""}}function l(e){return t=>{const o=s.Holder.create(null);s.dom.autoDisposeElem(t,o),s.dom.onElem(t,"contextmenu",(t=>{t.preventDefault(),t.stopPropagation(),r.create(o,t,e)}))}}},68370:(e,t,o)=>{"use strict";o.d(t,{o:()=>r});var s=o(38109),i=o(29922),n=o(18099);function r({initialValue:e,save:t,close:o},...i){let r=e;async function a(e){try{(e||d.value!==r)&&(r=d.value,await t(d.value)),o()}catch(e){(0,s.eK)(e),c()}}function c(){setTimeout((()=>{d.focus(),d.select()}),10)}const d=l({type:"text",placeholder:"Enter name"},n.dom.prop("value",e),n.dom.on("blur",(()=>a(!1))),n.dom.onKeyDown({Enter:()=>a(!0),Escape:()=>o()}),...i);return c(),d}const l=(0,n.styled)("input",`\n  background-color: transparent;\n  color: ${i.theme.inputFg};\n\n  &::placeholder {\n    color: ${i.theme.inputPlaceholderFg};\n  }\n`)},90744:(e,t,o)=>{"use strict";o.d(t,{f:()=>s});const s={_grist_DocInfo:{docId:"Text",peers:"Text",basketId:"Text",schemaVersion:"Int",timezone:"Text",documentSettings:"Text"},_grist_Tables:{tableId:"Text",primaryViewId:"Ref:_grist_Views",summarySourceTable:"Ref:_grist_Tables",onDemand:"Bool",rawViewSectionRef:"Ref:_grist_Views_section"},_grist_Tables_column:{parentId:"Ref:_grist_Tables",parentPos:"PositionNumber",colId:"Text",type:"Text",widgetOptions:"Text",isFormula:"Bool",formula:"Text",label:"Text",untieColIdFromLabel:"Bool",summarySourceCol:"Ref:_grist_Tables_column",displayCol:"Ref:_grist_Tables_column",visibleCol:"Ref:_grist_Tables_column",rules:"RefList:_grist_Tables_column",recalcWhen:"Int",recalcDeps:"RefList:_grist_Tables_column"},_grist_Imports:{tableRef:"Ref:_grist_Tables",origFileName:"Text",parseFormula:"Text",delimiter:"Text",doublequote:"Bool",escapechar:"Text",quotechar:"Text",skipinitialspace:"Bool",encoding:"Text",hasHeaders:"Bool"},_grist_External_database:{host:"Text",port:"Int",username:"Text",dialect:"Text",database:"Text",storage:"Text"},_grist_External_table:{tableRef:"Ref:_grist_Tables",databaseRef:"Ref:_grist_External_database",tableName:"Text"},_grist_TableViews:{tableRef:"Ref:_grist_Tables",viewRef:"Ref:_grist_Views"},_grist_TabItems:{tableRef:"Ref:_grist_Tables",viewRef:"Ref:_grist_Views"},_grist_TabBar:{viewRef:"Ref:_grist_Views",tabPos:"PositionNumber"},_grist_Pages:{viewRef:"Ref:_grist_Views",indentation:"Int",pagePos:"PositionNumber"},_grist_Views:{name:"Text",type:"Text",layoutSpec:"Text"},_grist_Views_section:{tableRef:"Ref:_grist_Tables",parentId:"Ref:_grist_Views",parentKey:"Text",title:"Text",defaultWidth:"Int",borderWidth:"Int",theme:"Text",options:"Text",chartType:"Text",layoutSpec:"Text",filterSpec:"Text",sortColRefs:"Text",linkSrcSectionRef:"Ref:_grist_Views_section",linkSrcColRef:"Ref:_grist_Tables_column",linkTargetColRef:"Ref:_grist_Tables_column",embedId:"Text",rules:"RefList:_grist_Tables_column"},_grist_Views_section_field:{parentId:"Ref:_grist_Views_section",parentPos:"PositionNumber",colRef:"Ref:_grist_Tables_column",width:"Int",widgetOptions:"Text",displayCol:"Ref:_grist_Tables_column",visibleCol:"Ref:_grist_Tables_column",filter:"Text",rules:"RefList:_grist_Tables_column"},_grist_Validations:{formula:"Text",name:"Text",tableRef:"Int"},_grist_REPL_Hist:{code:"Text",outputText:"Text",errorText:"Text"},_grist_Attachments:{fileIdent:"Text",fileName:"Text",fileType:"Text",fileSize:"Int",imageHeight:"Int",imageWidth:"Int",timeDeleted:"DateTime",timeUploaded:"DateTime"},_grist_Triggers:{tableRef:"Ref:_grist_Tables",eventTypes:"ChoiceList",isReadyColRef:"Ref:_grist_Tables_column",actions:"Text"},_grist_ACLRules:{resource:"Ref:_grist_ACLResources",permissions:"Int",principals:"Text",aclFormula:"Text",aclColumn:"Ref:_grist_Tables_column",aclFormulaParsed:"Text",permissionsText:"Text",rulePos:"PositionNumber",userAttributes:"Text",memo:"Text"},_grist_ACLResources:{tableId:"Text",colIds:"Text"},_grist_ACLPrincipals:{type:"Text",userEmail:"Text",userName:"Text",groupName:"Text",instanceId:"Text"},_grist_ACLMemberships:{parent:"Ref:_grist_ACLPrincipals",child:"Ref:_grist_ACLPrincipals"},_grist_Filters:{viewSectionRef:"Ref:_grist_Views_section",colRef:"Ref:_grist_Tables_column",filter:"Text",pinned:"Bool"},_grist_Cells:{tableRef:"Ref:_grist_Tables",colRef:"Ref:_grist_Tables_column",rowId:"Int",root:"Bool",parentId:"Ref:_grist_Cells",type:"Int",content:"Text",userRef:"Text"}}},18285:(e,t,o)=>{const s=o(77949),i=o(29301),n=o(81294),r=o(92979),l=o(61237),{renderAllRows:a}=o(68498);o(33620);const c=o(27601),d=o(30583),{CopySelection:u}=o(47079),h=o(42683),p=o(24412),{RowContextMenu:m}=o(19085),{parsePasteForView:g}=o(23735);function f(e,t){d.call(this,e,t,{addNewRow:!0}),this.viewFields=e.docModel.viewFields,this._isSingle="single"===this.viewSection.parentKey.peek(),this.recordLayout=this.autoDispose(h.create({viewSection:this.viewSection,buildFieldDom:this.buildFieldDom.bind(this),buildContextMenu:this.buildContextMenu.bind(this),resizeCallback:()=>{this._isSingle||(this.scrolly().updateSize(),this.scrolly().scrollRowIntoView(this.cursor.rowIndex.peek()))}})),this.scrolly=this.autoDispose(i.computed((()=>{if(!this.recordLayout.isEditingLayout()&&!this._isSingle)return l.getInstance(this.viewData)}))),this.autoDispose(this.viewSection.themeDef.subscribe((()=>{var e=this.scrolly();e&&setTimeout((function(){e.resetHeights()}),0)}))),this.layoutBoxIdx=i.observable(0),this._isSingle?(this.detailRecord=this.autoDispose(this.tableModel.createFloatingRowModel()),this._updateFloatingRow(),this.autoDispose(this.cursor.rowIndex.subscribe(this._updateFloatingRow,this)),this.autoDispose(this.viewData.subscribe(this._updateFloatingRow,this))):this.detailRecord=null,this.scrollPane=null,this.viewPane=this.autoDispose(this.buildDom()),this.onEvent(this.viewPane,"mousedown",".g_record_detail_el",(function(e,t){this.viewSection.hasFocus(!0);var o=this.recordLayout.getContainingRow(e,this.viewPane),s=this.recordLayout.getContainingField(e,this.viewPane);p.allCommands.setCursor.run(o,s)})),this.onEvent(this.viewPane,"dblclick",".g_record_detail_el",(function(e,t){this.activateEditorAtCursor()})),this.autoDispose(p.createGroup(f.generalCommands,this,this.viewSection.hasFocus)),this.newFieldCommandGroup=this.autoDispose(p.createGroup(f.newFieldCommands,this,this.isNewFieldActive))}c.setBaseFor(f),s.extend(f.prototype,d.prototype),f.prototype.onTableLoaded=function(){d.prototype.onTableLoaded.call(this),this._updateFloatingRow();const e=this.scrolly();e&&e.scrollToSavedPos(this.viewSection.lastScrollPos)},f.prototype._updateFloatingRow=function(){this.detailRecord&&this.viewData.setFloatingRowModel(this.detailRecord,this.cursor.rowIndex.peek())},f.generalCommands={cursorUp:function(){this.cursor.fieldIndex(this.cursor.fieldIndex()-1)},cursorDown:function(){this.cursor.fieldIndex(this.cursor.fieldIndex()+1)},pageUp:function(){this.cursor.rowIndex(this.cursor.rowIndex()-1)},pageDown:function(){this.cursor.rowIndex(this.cursor.rowIndex()+1)},copy:function(){return this.copy(this.getSelection())},cut:function(){return this.cut(this.getSelection())},paste:function(e,t){return this.gristDoc.docData.bundleActions(null,(()=>this.paste(e,t)))},editLayout:function(){this.scrolly()&&this.scrolly().scrollRowIntoView(this.cursor.rowIndex()),this.recordLayout.editLayout(this.cursor.rowIndex())}},f.prototype.selectedRows=function(){return this._isAddRow()?[]:[this.viewData.getRowId(this.cursor.rowIndex())]},f.prototype.deleteRows=async function(e){const t=this.cursor.rowIndex();try{await d.prototype.deleteRows.call(this,e)}finally{this.cursor.rowIndex(t)}},f.prototype.paste=async function(e,t){let o=e[0][0],i=this.viewSection.viewFields().at(this.cursor.fieldIndex()),n=1===e.length&&1===e[0].length;const r=await g([[o]],[i],this.gristDoc);if(s.isEmpty(r))return;const l=this.viewData.getRowId(this.cursor.rowIndex()),a="new"===l?["BulkAddRecord",[null],r]:["BulkUpdateRecord",[l],r],c=this.cursor.getCursorPos();return this.sendPasteActions(n?t:null,this.prepTableActions([a])).then((e=>{const t="BulkAddRecord"===a[0]?e[0][0]:null;this.cursor.setCursorPos({rowId:"new"===c.rowId?t:c.rowId}),this.copySelection(null)}))},f.prototype.getSelection=function(){return new u(this.tableModel.tableData,[this.viewData.getRowId(this.cursor.rowIndex())],[this.viewSection.viewFields().at(this.cursor.fieldIndex())],{})},f.prototype.buildContextMenu=function(e,t){const o={disableInsert:Boolean(this.gristDoc.isReadonly.get()||this.viewSection.disableAddRemoveRows()||this.tableModel.tableMetaRow.onDemand()),disableDelete:Boolean(this.gristDoc.isReadonly.get()||this.viewSection.disableAddRemoveRows()||e._isAddRow()),isViewSorted:this.viewSection.activeSortSpec.peek().length>0,numRows:this.getSelection().rowIds.length};return m(t?Object.assign(o,t):o)},f.prototype.buildFieldDom=function(e,t){var o=this;if(e.isNewField)return n("div.g_record_detail_el.flexitem",r.cssClass((function(){return"detail_theme_field_"+o.viewSection.themeDef()})),n("div.g_record_detail_label",e.label),n("div.g_record_detail_value",e.value));var l=i.pureComputed((function(){return this.cursor.fieldIndex()===(e&&e._index())&&this.cursor.rowIndex()===(t&&t._index())}),this),a=i.pureComputed((function(){return this.viewSection.hasFocus()&&l()}),this),c=i.computed((function(){return o.copySelection()&&o.copySelection().isCellSelected(t.getRowId(),e.colId())}));this.autoDispose(l.subscribe((e=>{if(e){var t=n.findAncestor(u,".layout_hbox");this.layoutBoxIdx(s.indexOf(t.parentElement.childNodes,t))}})));var d=this.fieldBuilders.at(e._index()),u=n("div.g_record_detail_el.flexitem",n.autoDispose(l),n.autoDispose(a),r.cssClass((function(){return"detail_theme_field_"+o.viewSection.themeDef()})),n("div.g_record_detail_label",r.text(e.displayLabel)),n("div.g_record_detail_value",r.toggleClass("scissors",c),r.toggleClass("record-add",t._isAddRow),n.autoDispose(c),d.buildDomWithCursor(t,a,l)));return u},f.prototype.buildDom=function(){return n("div.flexvbox.flexitem",r.toggleClass("detailview_single",(()=>this._isSingle||this.recordLayout.isEditingLayout())),r.toggleClass("detailview_layout_editor",this.recordLayout.isEditingLayout),r.maybe(this.recordLayout.isEditingLayout,(()=>{const e=this.viewData.getRowId(this.recordLayout.editIndex.peek()),t=this.getRenderedRowModel(e);return n(this.recordLayout.buildLayoutDom(t,!0),r.cssClass((()=>"detail_theme_record_"+this.viewSection.themeDef())),r.cssClass("detailview_record_"+this.viewSection.parentKey.peek()))})),r.maybe((()=>!this.recordLayout.isEditingLayout()),(()=>this._isSingle?n(this.makeRecord(this.detailRecord),r.domData("itemModel",this.detailRecord),r.hide((()=>null===this.cursor.rowIndex()))):this.scrollPane=n("div.detailview_scroll_pane.flexitem",r.scrollChildIntoView(this.cursor.rowIndex),n.onDispose((()=>{this.scrolly()&&(this.viewSection.lastScrollPos=this.scrolly().getScrollPos())})),l.scrolly(this.viewData,{fitToWidth:!0},(e=>this.makeRecord(e))),r.maybe(this._isPrinting,(()=>a(this.tableModel,this.sortedRows.getKoArray().peek(),(e=>this.makeRecord(e)))))))))},f.prototype.buildTitleControls=function(){const e=i.computed((()=>{if(!this._isSingle||this.recordLayout.layoutEditor())return!1;const e=this.viewSection.linkingState();return!(e&&Boolean(e.cursorPos))}));return n("div",n.autoDispose(e),r.toggleClass("record-layout-editor",this.recordLayout.layoutEditor),r.maybe(this.recordLayout.layoutEditor,(e=>e.buildEditorDom())),r.maybe(e,(()=>n("div.grist-single-record__menu.flexhbox.flexnone",n("div.grist-single-record__menu__count.flexitem",r.text((()=>this._isAddRow()?"Add record":`${this.cursor.rowIndex()+1} of ${this.getLastDataRowIndex()+1}`))),n("div.btn-group.btn-group-xs",n("div.btn.btn-default.detail-left",n("span.glyphicon.glyphicon-chevron-left"),n.on("click",(()=>{this.cursor.rowIndex(this.cursor.rowIndex()-1)})),r.toggleClass("disabled",(()=>0===this.cursor.rowIndex()))),n("div.btn.btn-default.detail-right",n("span.glyphicon.glyphicon-chevron-right"),n.on("click",(()=>{this.cursor.rowIndex(this.cursor.rowIndex()+1)})),r.toggleClass("disabled",(()=>this.cursor.rowIndex()>=this.viewData.all().length-1)))),n("div.btn-group.btn-group-xs.detail-add-grp",n("div.btn.btn-default.detail-add-btn",n("span.glyphicon.glyphicon-plus"),n.on("click",(()=>{let e=this.viewData.getRowIndex("new");this.cursor.rowIndex(e)})),r.toggleClass("disabled",(()=>"new"===this.viewData.getRowId(this.cursor.rowIndex())))))))))},f.prototype.onResize=function(){var e=this.scrolly();e&&e.scheduleUpdateSize()},f.prototype.onRowResize=function(e){var t=this.scrolly();t&&t.resetItemHeights(e)},f.prototype.makeRecord=function(e){return n(this.recordLayout.buildLayoutDom(e),r.cssClass((()=>"detail_theme_record_"+this.viewSection.themeDef())),this.comparison?r.cssClass((()=>{const t=this.extraRows.getRowType(e.id());return t&&`diff-${t}`||""})):null,r.toggleClass("active",(()=>this.cursor.rowIndex()===e._index()&&this.viewSection.hasFocus())),r.cssClass("detailview_record_"+this.viewSection.parentKey.peek()))},f.prototype.getRenderedRowModel=function(e){return this.detailRecord?this.detailRecord.getRowId()===e?this.detailRecord:null:this.viewData.getRowModel(e)},f.prototype._isAddRow=function(e=this.cursor.rowIndex()){return"new"===this.viewData.getRowId(e)},f.prototype.scrollToCursor=function(e=!0){return this.scrollPane?r.doScrollChildIntoView(this.scrollPane,this.cursor.rowIndex(),e):Promise.resolve()},f.prototype._duplicateRows=async function(){const e=await d.prototype._duplicateRows.call(this);this.setCursorPos({rowId:e[0]})},e.exports=f},27910:(e,t,o)=>{var s=o(88438),i=o(81294),n=o(8113);function r(e,t){this.gristDoc=e.gristDoc,this.validationPanel=this.autoDispose(n.create({gristDoc:this.gristDoc})),this.autoDispose(this.gristDoc.addOptionsTab("Validate Data",i("span.glyphicon.glyphicon-check"),this.buildValidationsConfigDomObj(),{shortLabel:"Valid"}))}s.makeDisposable(r),r.prototype.buildValidationsConfigDomObj=function(){return[{buildDom:this.validationPanel.buildDom.bind(this.validationPanel),keywords:["document","validations","rules","validate"]}]},e.exports=r},442:(e,t,o)=>{var s=Object.defineProperty,i=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,l=(e,t,o)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const a=o(77949),c=o(29301),d=o(88466),u=o(83277),h=o(10328),{Sort:p}=o(48210),m=o(81294),g=o(92979),f=o(73783),w=o(61237),b=o(15323),{addToSort:v,sortBy:_}=o(52064),y=o(24412),x=o(52103),S=o(27601),C=o(30583),I=o(3719),{CopySelection:R}=o(47079),{SelectionSummary:D}=o(50254),T=o(33620),k=o(81401),{renderAllRows:M}=o(68498),{reportWarning:P}=o(92769),{reportUndo:A}=o(54292),{onDblClickMatchElem:O}=o(31248),{dom:F,Holder:E,Computed:B}=o(18099),{closeRegisteredMenu:L,menu:U}=o(1370),{calcFieldsCondition:z}=o(7916),{ColumnAddMenu:V,ColumnContextMenu:N,MultiColumnMenu:W,freezeAction:j}=o(7916),{RowContextMenu:H}=o(19085),{setPopupToCreateDom:G}=o(21467),{CellContextMenu:K}=o(58847),{testId:J,isNarrowScreen:q}=o(29922),{contextMenu:X}=o(74624),{mouseDragMatchElem:Y}=o(79365),{menuToggle:Z}=o(42882),{showTooltip:Q}=o(8881),{parsePasteForView:ee}=o(23735),{NEW_FILTER_JSON:te}=o(45051),{CombinedStyle:oe}=o(53186);function se(e,t,o=!1){C.call(this,e,t,{isPreview:o,addNewRow:!0}),this.viewSection=t,this.dragX=c.observable(0),this.dragY=c.observable(0),this.rowShadowAdjust=0,this.colShadowAdjust=0,this.scrollLeft=c.observable(0),this.isScrolledLeft=this.autoDispose(c.computed((()=>this.scrollLeft()>0))),this.scrollTop=c.observable(0),this.isScrolledTop=this.autoDispose(c.computed((()=>this.scrollTop()>0))),this.cellSelector=I.CellSelector.create(this,this),o||(this.selectionSummary=D.create(this,this.cellSelector,this.tableModel.tableData,this.sortedRows,this.viewSection.viewFields)),this.colMenuTargets={},this.selectedColumns=this.autoDispose(c.pureComputed((()=>this.viewSection.viewFields().all().filter(((e,t)=>!e.isDisposed()&&!e.column().isDisposed()&&this.cellSelector.containsCol(t)))))),this.colRightOffsets=this.autoDispose(c.computed((()=>{let e=this.viewSection.viewFields(),t=new h;return t.fillFromValues(e.all().map((e=>e.widthDef()))),t}))),this.visibleRowIndex=c.observable(this.cursor.rowIndex()).extend({notify:"always"}),this.currentPosition=B.create(this,(e=>({rowIndex:e(this.cursor.rowIndex),fieldIndex:e(this.cursor.fieldIndex)}))),this.autoDispose(this.currentPosition.addListener(((e,t)=>{e.rowIndex===t.rowIndex&&e.fieldIndex===t.fieldIndex||this.visibleRowIndex(e.rowIndex)}))),this.autoDispose(this.cursor.fieldIndex.subscribe((e=>{const t=this.colRightOffsets.peek().getSumTo(e),o=this._cornerDom.clientWidth,s=this.scrollPane.clientWidth-o,i=this.colRightOffsets.peek().getValue(e)+1,n=this.scrollPane.scrollLeft,r=n+s,l=t-u.clamp(t,n,r-i);this.scrollPane.scrollLeft=this.scrollPane.scrollLeft+l}))),this.isPreview=o,this.scrollShadow={left:this.isScrolledLeft,top:this.isScrolledTop},this.ctxMenuHolder=E.create(this),this.width=c.observable(0),this.numFrozen=this.viewSection.numFrozen,this.frozenWidth=this.autoDispose(c.pureComputed((()=>this.colRightOffsets().getSumTo(this.numFrozen())))),this.frozenLine=this.autoDispose(c.pureComputed((()=>this.numFrozen()&&!this.isScrolledLeft()))),this.frozenOffset=this.autoDispose(c.computed((()=>{const e=this.viewSection.viewFields().all(),t=e[e.length-1],o=t?t.widthDef():0,s=-this.frozenWidth()-52+this.width()-o-40,i=-this.frozenWidth()-52+this.width()/2,n=Math.floor(Math.max(s,i));return n>0?0:Math.abs(n)}))),this.frozenScrollOffset=this.autoDispose(c.computed((()=>this.numFrozen()?this.scrollLeft():0))),this.frozenShadow=this.autoDispose(c.computed((()=>this.numFrozen()&&this.frozenOffset()&&this.isScrolledLeft()))),this.frozenPositions=this.autoDispose(this.viewSection.viewFields().map((function(e){return c.pureComputed((()=>this.colRightOffsets().getSumTo(e._index())))}),this)),this.frozenMap=this.autoDispose(this.viewSection.viewFields().map((function(e){return c.pureComputed((()=>e._index()<this.numFrozen()))}),this)),this.hoverColumn=c.observable(-1),this.changeHover=d((e=>{this.isDisposed()||this.gristDoc.docModel.editingFormula()&&this.hoverColumn(e)}),0),this.isColSelected=this.autoDispose(this.viewSection.viewFields().map((function(e){return this._createColSelectedObs(e)}),this)),this.header=null,this._cornerDom=null,this._modField=null,this.scrollPane=null,this.viewPane=this.autoDispose(this.buildDom()),this.attachSelectorHandlers(),this.scrolly=w.getInstance(this.viewData),O(this.scrollPane,".field",(()=>this.activateEditorAtCursor())),this.isPreview||F.onMatchElem(this.scrollPane,".field:not(.column_name)","contextmenu",((e,t)=>this.onCellContextMenu(e,t)),{useCapture:!0}),this.onEvent(this.scrollPane,"scroll",this.onScroll),this.autoDispose(y.createGroup(se.gridCommands,this,this.viewSection.hasFocus));const s=this.autoDispose(c.pureComputed((()=>!this.cellSelector.isCurrentSelectType("")||this.copySelection())));this.autoDispose(y.createGroup(se.selectionCommands,this,s)),this._colClickTime=0}function ie(e,t,o){return c.computed((()=>{if(e.isDisposed())return null;const s=t();return s&&s.style&&s.style[o]||""}))}S.setBaseFor(se),a.extend(se.prototype,C.prototype),se.selectionCommands={cancel:function(){this.clearSelection()}},se.gridCommands={cursorUp:function(){0===this.cursor.rowIndex()&&(this.scrollPane.scrollTop=0),this.cursor.rowIndex(this.cursor.rowIndex()-1)},shiftDown:function(){this._shiftSelect(1,this.cellSelector.row.end,I.COL,this.getLastDataRowIndex())},shiftUp:function(){this._shiftSelect(-1,this.cellSelector.row.end,I.COL,this.getLastDataRowIndex())},shiftRight:function(){this._shiftSelect(1,this.cellSelector.col.end,I.ROW,this.viewSection.viewFields().peekLength-1)},shiftLeft:function(){this._shiftSelect(-1,this.cellSelector.col.end,I.ROW,this.viewSection.viewFields().peekLength-1)},fillSelectionDown:function(){this.fillSelectionDown()},selectAll:function(){this.selectAll()},fieldEditSave:function(){this.cursor.rowIndex(this.cursor.rowIndex()+1)},editField:function(){L(),this.scrollToCursor(!0),this.activateEditorAtCursor()},insertFieldBefore:function(){this.insertColumn(this.cursor.fieldIndex())},insertFieldAfter:function(){this.insertColumn(this.cursor.fieldIndex()+1)},renameField:function(){this.currentEditingColumnIndex(this.cursor.fieldIndex())},hideFields:function(){this.hideFields(this.getSelection())},deleteFields:function(){const e=this.getSelection(),t=e.colIds.length;this.deleteColumns(e).then((e=>{!1!==e&&A(this.gristDoc,`You deleted ${t} column${t>1?"s":""}.`)}))},clearValues:function(){this.clearValues(this.getSelection())},clearColumns:function(){this._clearColumns(this.getSelection())},convertFormulasToData:function(){this._convertFormulasToData(this.getSelection())},copy:function(){return this.copy(this.getSelection())},cut:function(){return this.cut(this.getSelection())},paste:async function(e,t){await this.gristDoc.docData.bundleActions(null,(()=>this.paste(e,t))),await this.scrollToCursor(!1)},sortAsc:function(){_(this.viewSection.activeSortSpec,this.currentColumn().getRowId(),p.ASC)},sortDesc:function(){_(this.viewSection.activeSortSpec,this.currentColumn().getRowId(),p.DESC)},addSortAsc:function(){v(this.viewSection.activeSortSpec,this.currentColumn().getRowId(),p.ASC)},addSortDesc:function(){v(this.viewSection.activeSortSpec,this.currentColumn().getRowId(),p.DESC)},toggleFreeze:function(){const e=this.getSelection(),t=this._getColumnMenuOptions(e),o=j(t);o&&(this.gristDoc.isReadonly.get()?this.viewSection.rawNumFrozen(o.numFrozen):this.viewSection.rawNumFrozen.setAndSave(o.numFrozen))}},se.prototype.onTableLoaded=function(){C.prototype.onTableLoaded.call(this),this.onScroll(),this.scrollPane.scrollLeft=this.viewSection.lastScrollPos.scrollLeft,this.scrolly.scrollToSavedPos(this.viewSection.lastScrollPos)},se.prototype._shiftSelect=function(e,t,o,s){if(console.assert(o===I.ROW||o===I.COL),!this.cellSelector.isCurrentSelectType(o)){this.cellSelector.isCurrentSelectType(I.NONE)&&this.cellSelector.currentSelectType(I.CELL);var i=u.clamp(t()+e,0,s);t(i)}},se.prototype.paste=async function(e,t){let o=a.unzip(e),s=o[0].length,i=o.length,n=Math.max(u.roundDownToMultiple(this.cellSelector.rowCount(),s),s),r=Math.max(u.roundDownToMultiple(this.cellSelector.colCount(),i),i),l=this.cellSelector.rowLower(),c=a.range(l,l+n).map((e=>this.viewData.getRowId(e))),d=this.cellSelector.colLower(),h=a.range(d,d+r);o=u.growMatrix(o,h.length,c.length);let p=this.viewSection.viewFields().peek(),m=h.map((e=>p[e]||null));const g=await ee(o,m,this.gristDoc);let f=this._createBulkActionsFromPaste(c,g);if(f.length>0){let e=this.cursor.getCursorPos();return this.sendPasteActions(t,f).then((t=>{let o="BulkAddRecord"===f[0][0]?t[0]:[];console.assert(o.length<=c.length,`Unexpected number of added rows: ${o.length} of ${c.length}`);let s=c.slice(0,c.length-o.length).concat(o);this.cursor.setCursorPos({rowId:"new"===e.rowId?o[0]:e.rowId});let i=this.viewData.getRowIndex(s[0]);s.every(((e,t)=>e===this.viewData.getRowId(i+t)))&&this.cellSelector.selectArea(i,d,i+n-1,d+r-1),this.copySelection(null)}))}},se.prototype._createBulkActionsFromPaste=function(e,t){if(a.isEmpty(t))return[];let o=e.filter((e=>null===e||"new"===e)).length,s=e.length-o,i=[];return o>0&&i.push(["BulkAddRecord",u.arrayRepeat(o,null),a.mapObject(t,(e=>e.slice(-o)))]),s>0&&i.push(["BulkUpdateRecord",e.slice(0,s),a.mapObject(t,(e=>e.slice(0,s)))]),this.prepTableActions(i)},se.prototype.fillSelectionDown=function(){var e=this.cellSelector.rowLower(),t=a.times(this.cellSelector.rowCount(),(t=>this.viewData.getRowId(e+t)));if(!(t.length<=1)){var o=this.cellSelector.colLower(),s=this.viewSection.viewFields().peek(),i=a.times(this.cellSelector.colCount(),(e=>{if(!s[o+e].column().isFormula())return s[o+e].colId()})).filter((e=>e)),n=a.object(i,i.map((e=>{var o=this.tableModel.tableData.getValue(t[0],e);return t.map((()=>o))})));this.tableModel.sendTableAction(["BulkUpdateRecord",t,n])}},se.prototype.getSelection=function(){var e,t=[],o=[],s={},i={},n=this.cellSelector.colLower(),r=this.cellSelector.colUpper(),l=this.cellSelector.rowLower(),a=this.cellSelector.rowUpper();if(this.cellSelector.isCurrentSelectType(I.NONE)&&(l=a=this.cursor.rowIndex(),n=r=this.cursor.fieldIndex()),this.cellSelector.isCurrentSelectType(I.ROW)?(n=0,r=this.viewSection.viewFields().peekLength-1):this.cellSelector.isCurrentSelectType(I.COL)&&(l=0,a=this.getLastDataRowIndex()),null!==n&&null!==r)for(var c=n;c<=r;c++){let e=this.viewSection.viewFields().at(c);o.push(e),i[e.colId()]=this._getColStyle(c)}for(var d=l;d<=a;d++)e=this.viewData.getRowId(d),t.push(e),s[e]=this._getRowStyle(d);return new R(this.tableModel.tableData,t,o,{rowStyle:s,colStyle:i})},se.prototype.clearSelection=function(){this.copySelection(null),this.cellSelector.setToCursor()},se.prototype.clearValues=function(e){if(!0===this._getColumnMenuOptions(e).isFormula)this.activateEditorAtCursor({init:""});else{let t=b.makeDeleteAction(e);t&&this.gristDoc.docData.sendAction(t)}},se.prototype._clearColumns=function(e){const t=e.fields;return this.gristDoc.clearColumns(t.map((e=>e.colRef.peek())))},se.prototype._convertFormulasToData=function(e){const t=e.fields.filter((e=>e.column.peek().isFormula.peek()));return t.length?this.gristDoc.convertIsFormula(t.map((e=>e.colRef.peek())),{toFormula:!1}):null},se.prototype.selectAll=function(){this.cellSelector.selectArea(0,0,this.getLastDataRowIndex(),this.viewSection.viewFields().peekLength-1)},se.prototype.assignCursor=function(e,t){this.viewSection.hasFocus(!0);try{let o=this.domToRowModel(e,t),s=this.domToColModel(e,t);y.allCommands.setCursor.run(o,s)}catch(e){console.error(e),console.error("GridView.assignCursor expects a row/col header, or cell as an input.")}this.cellSelector.setToCursor(t)},se.prototype.scheduleAssignCursor=function(e,t){this._assignCursorTimeoutId=setTimeout((()=>{this.assignCursor(e,t),this._assignCursorTimeoutId=null}),0)},se.prototype.preventAssignCursor=function(){clearTimeout(this._assignCursorTimeoutId),this._assignCursorTimeoutId=null},se.prototype.selectedRows=function(){const e=this.getSelection();return a.without(e.rowIds,"new")},se.prototype.deleteRows=async function(e){const t=this.cursor.getCursorPos();this.cursor.setLive(!1);try{await C.prototype.deleteRows.call(this,e)}finally{this.cursor.setCursorPos(t),this.cursor.setLive(!0),this.clearSelection()}},se.prototype.addNewColumn=function(){this.insertColumn(this.viewSection.viewFields().peekLength).then((()=>this.scrollPaneRight()))},se.prototype.insertColumn=async function(e){const t=b.fieldInsertPositions(this.viewSection.viewFields(),e)[0];var o=["AddColumn",null,{_position:t}];await this.gristDoc.docData.bundleActions("Insert column",(async()=>{const e=await this.tableModel.sendTableAction(o);if(!this.viewSection.isRaw.peek()){const o={colRef:e.colRef,parentPos:t,parentId:this.viewSection.id.peek()};await this.gristDoc.docModel.viewFields.sendTableAction(["AddRecord",null,o])}})),this.selectColumn(e),this.currentEditingColumnIndex(e)},se.prototype.scrollPaneRight=function(){this.scrollPane.scrollLeft=Number.MAX_SAFE_INTEGER},se.prototype.selectColumn=function(e){this.cursor.fieldIndex(e),this.cellSelector.currentSelectType(I.COL)},se.prototype.showColumn=function(e,t){let o=b.fieldInsertPositions(this.viewSection.viewFields(),t,1)[0],s={parentId:this.viewSection.id(),colRef:e,parentPos:o};return this.gristDoc.docModel.viewFields.sendTableAction(["AddRecord",null,s]).then((()=>this.selectColumn(t))).then((()=>this.scrollPaneRight()))},se.prototype.deleteColumns=function(e){var t=e.fields;if(t.length===this.viewSection.viewFields().peekLength)return P("You can't delete all the columns on the grid.",{key:"delete-all-columns"}),Promise.resolve(!1);let o=t.filter((e=>!e.disableModify())).map((e=>["RemoveColumn",e.colId()]));return o.length>0?this.tableModel.sendTableActions(o,`Removed columns ${o.map((e=>e[1])).join(", ")} from ${this.tableModel.tableData.tableId}.`).then((()=>this.clearSelection())):Promise.resolve(!1)},se.prototype.hideFields=function(e){var t=e.fields.map((e=>["RemoveRecord",e.id()]));return this.gristDoc.docModel.viewFields.sendTableActions(t,`Hide columns ${t.map((e=>e[1])).join(", ")} from ${this.tableModel.tableData.tableId}.`)},se.prototype.moveColumns=function(e,t){if(0===e.length)return;if(e[0]===t||e[0]+1===t)return;var o=b.fieldInsertPositions(this.viewSection.viewFields(),t,e.length),s=["BulkUpdateRecord",e.map((function(e){return this.viewSection.viewFields().at(e).id()}),this),{parentPos:o}],i=this.gristDoc.docModel.viewFields,n=e.length;const r=t<this.cellSelector.colLower()?t:t-n;i.sendTableAction(s).then((()=>{this.cursor.fieldIndex(r),this.cellSelector.currentSelectType(I.COL),this.cellSelector.col.start(r),this.cellSelector.col.end(r+n-1)}))},se.prototype.moveRows=function(e,t){if(0===e.length)return;if(e[0]===t||e[0]+1===t)return;var o=this._getRowInsertPos(t,e.length),s=["BulkUpdateRecord",e.map((function(e){return this.viewData.getRowId(e)}),this),{manualSort:o}],i=e.length;const n=t<this.cellSelector.rowLower()?t:t-i;this.tableModel.sendTableAction(s).then((()=>{this.cursor.rowIndex(n),this.cellSelector.currentSelectType(I.ROW),this.cellSelector.row.start(n),this.cellSelector.row.end(n+i-1)}))},se.prototype.getMousePosRow=function(e){var t=this.header.getBoundingClientRect().bottom;return this.scrolly.rowOffsetTree.getIndex(e-t)},se.prototype.currentMouseRow=function(e){return Math.min(this.getMousePosRow(this.scrollTop()+e),this.getLastDataRowIndex())},se.prototype.getMousePosCol=function(e){const t=this.scrollLeft(),o=e-this._cornerDom.getBoundingClientRect().right,s=this.frozenWidth.peek(),i=Math.min(this.frozenOffset.peek(),t),n=o+(this.numFrozen.peek()&&o<=s-i?i:t);return this.colRightOffsets.peek().getIndex(n)},se.prototype._getRowStyle=function(e){return{height:this.scrolly.rowOffsetTree.getValue(e)+"px"}},se.prototype._getColStyle=function(e){return{width:this.viewSection.viewFields().at(e).widthPx()}},se.prototype.domToRowModel=function(e,t){switch(t){case I.COL:return 0;case I.ROW:return c.utils.domData.get(e.parentNode,"itemModel");case I.NONE:case I.CELL:return c.utils.domData.get(e.parentNode.parentNode,"itemModel");default:throw Error("Unknown elemType in domToRowModel:"+t)}},se.prototype.domToColModel=function(e,t){switch(t){case I.ROW:return 0;case I.NONE:case I.CELL:case I.COL:return c.utils.domData.get(e,"itemModel");default:throw Error("Unknown elemType in domToRowModel")}},se.prototype.onScroll=function(){var e=this.scrollPane;this.scrollLeft(e.scrollLeft),this.scrollTop(e.scrollTop),this.width(e.clientWidth)},se.prototype.buildDom=function(){var e=this,t=this.viewData,o=this.viewSection,s=this.currentEditingColumnIndex;let i=o.optionsObj.prop("horizontalGridlines"),n=o.optionsObj.prop("verticalGridlines"),r=o.optionsObj.prop("zebraStripes");var l={nextField:function(){s(s()+1),e.selectColumn(s.peek())},prevField:function(){s(s()-1),e.selectColumn(s.peek())}};return m("div.gridview_data_pane.flexvbox",g.style("--frozen-offset",this.frozenOffset),g.style("--frozen-width",this.frozenWidth),e._cornerDom=m("div.gridview_data_corner_overlay",m.on("click",(()=>this.selectAll()))),m("div.scroll_shadow_top",g.show(this.scrollShadow.top)),m("div.scroll_shadow_left",g.show(this.scrollShadow.left),g.style("--frozen-scroll-offset",this.frozenScrollOffset)),m("div.frozen_line",g.show(this.frozenLine)),m("div.gridview_header_backdrop_left"),m("div.gridview_header_backdrop_top"),m("div.gridview_left_border",g.show(this.numFrozen),g.style("left","52px")),m("div.scroll_shadow_frozen",g.show(this.frozenShadow)),m.on("mouseleave",(()=>!this.isDisposed()&&this.hoverColumn(-1))),e.colLine=m("div.col_indicator_line",g.show((function(){return e.cellSelector.isCurrentDragType(I.COL)})),g.style("left",e.cellSelector.col.linePos)),e.colShadow=m("div.column_shadow",g.show((function(){return e.cellSelector.isCurrentDragType(I.COL)})),g.style("left",(function(){return e.dragX()-e.colShadowAdjust+"px"}))),e.rowLine=m("div.row_indicator_line",g.show((function(){return e.cellSelector.isCurrentDragType(I.ROW)})),g.style("top",e.cellSelector.row.linePos)),e.rowShadow=m("div.row_shadow",g.show((function(){return e.cellSelector.isCurrentDragType(I.ROW)})),g.style("top",(function(){return e.dragY()-e.rowShadowAdjust+"px"}))),e.scrollPane=m("div.grid_view_data.gridview_data_scroll.show_scrollbar",g.scrollChildIntoView(e.visibleRowIndex),m.onDispose((()=>{e.viewSection.lastScrollPos=a.extend({scrollLeft:e.scrollPane.scrollLeft},e.scrolly.getScrollPos())})),m("div.gridview_stick-top.flexhbox",m("div.gridview_corner_spacer"),e.header=m("div.gridview_data_header.flexhbox",m("div.column_names.record",g.style("minWidth","100%"),g.style("borderLeftWidth",o.borderWidthPx),g.foreach(o.viewFields(),(t=>{var i=c.pureComputed({read:()=>s()===t._index()&&!(()=>this.gristDoc.isReadonlyKo()||e.isPreview)()&&!Boolean(t.column().disableEditData()),write:e=>s(e?t._index():-1)}).extend({rateLimit:0});let n;const r=c.pureComputed((()=>e.gristDoc.docModel.editingFormula()&&c.unwrap(e.hoverColumn)===t._index()));return m("div.column_name.field",g.style("--frozen-position",(()=>c.unwrap(this.frozenPositions.at(t._index())))),g.toggleClass("frozen",(()=>c.unwrap(this.frozenMap.at(t._index())))),g.toggleClass("hover-column",r),m.autoDispose(i),m.autoDispose(r),m.testId("GridView_columnLabel"),(e=>{const o=new ne(e);return[m.autoDispose(o),m.autoDispose(r.subscribe((e=>{e?o.show(`Click to insert $${t.colId.peek()}`):o.hide()})))]}),g.style("width",t.widthPx),g.style("borderRightWidth",o.borderWidthPx),x.makeResizable(t.width,{shouldSave:!this.gristDoc.isReadonly.get()}),g.toggleClass("selected",(()=>c.unwrap(this.isColSelected.at(t._index())))),m.on("contextmenu",(e=>{e.preventDefault();const t=e.currentTarget.querySelector(".g-column-menu-btn");t&&t.click()})),m("div.g-column-label",f.editableLabel(e.isPreview?t.label:t.displayLabel,i,l),m.on("mousedown",(e=>!i()||e.stopPropagation()))),m.on("mouseenter",(()=>e.changeHover(t._index()))),m.on("mouseleave",(()=>e.changeHover(-1))),e.isPreview?null:Z(null,g.cssClass("g-column-main-menu"),g.cssClass("g-column-menu-btn"),m.on("mousedown",(()=>!1)),m.on("click",(e=>this.maybeSelectColumn(e.currentTarget.parentNode,t))),(e=>{n=G(e,(e=>this._columnFilterMenu(e,t,{showAllFiltersButton:!0})),{attach:"body",placement:"bottom-start",boundaries:"viewport",trigger:[]})}),U((e=>this.columnContextMenu(e,this.getSelection(),t,n))),J("column-menu-trigger")))})),this.isPreview?null:g.maybe((()=>!this.gristDoc.isReadonlyKo()),(()=>this._modField=m("div.column_name.mod-add-column.field","+",g.style("width","40px"),m.on("click",(e=>{0===this.viewSection.hiddenColumns().length&&(e.stopImmediatePropagation(),this.addNewColumn())})),U((e=>V(this,this.viewSection))))))))),w.scrolly(t,{paddingBottom:80,paddingRight:28},d),g.maybe(this._isPrinting,(()=>M(this.tableModel,this.sortedRows.getKoArray().peek(),d)))));function d(t){var s=c.computed((()=>t._index()===e.cursor.rowIndex()));const l=c.pureComputed((()=>e.viewSection.rulesColsIds().map((e=>t.cells[e]&&t.cells[e]()||!1)))),a=T.withKoUtils(c.pureComputed((()=>{if(t._isAddRow()||!t.id())return null;const o=l();if(0===o.length)return null;const s=e.viewSection.rulesStyles()||[];return{style:new oe(s,o)}}),this).extend({deferred:!0})),d=ie(e,a,"fillColor"),u=c.pureComputed((()=>function(e){if(!e||7!==e.length)return e;const t=k.hex.hsl(e.substr(1));return t[2]>50?t[2]-=2.6:t[2]>1?t[2]+=11:t[2]+=16,`#${k.hsl.hex(t)}`}(d()))),h=ie(e,a,"textColor"),p=ie(e,a,"fontBold"),f=ie(e,a,"fontItalic"),w=ie(e,a,"fontUnderline"),b=ie(e,a,"fontStrikethrough");return m("div.gridview_row",m.autoDispose(s),m.autoDispose(l),m.autoDispose(a),m.autoDispose(h),m.autoDispose(d),m.autoDispose(u),m.autoDispose(p),m.autoDispose(f),m.autoDispose(w),m.autoDispose(b),m("div.gridview_data_row_num",g.style("width","52px"),m("div.gridview_data_row_info",g.toggleClass("linked_dst",(()=>e.linkedRowId()&&e.linkedRowId()===t.getRowId()))),g.text((function(){return t._index()+1})),g.scope(t._validationFailures,(function(e){if(!t._isAddRow()&&e.length>0)return m("div.validation_error_number",e.length,g.attr("title",(function(){return"Validation failed: "+e.map((function(e){return e.name()})).join(", ")})))})),m.on("contextmenu",(e=>{e.preventDefault(),e.currentTarget.querySelector(".menu_toggle").click()})),e.isPreview?null:Z(null,m.on("click",(o=>e.maybeSelectRow(o.currentTarget.parentNode,t.getRowId()))),U((t=>(t.autoDispose(s.subscribe((()=>t.close()))),e.rowContextMenu())),{trigger:["click"]}),m.on("mousedown",(()=>!1)),J("row-menu-trigger")),g.toggleClass("selected",(()=>!t._isAddRow()&&e.cellSelector.isRowSelected(t._index())))),m("div.record",g.toggleClass("record-add",t._isAddRow),g.style("borderLeftWidth",o.borderWidthPx),g.style("borderBottomWidth",o.borderWidthPx),g.toggleClass("font-bold",p),g.toggleClass("font-underline",w),g.toggleClass("font-italic",f),g.toggleClass("font-strikethrough",b),g.style("--grist-row-rule-background-color",d),g.style("--grist-row-rule-background-color-zebra",u),g.style("--grist-row-color",h),g.toggleClass("record-hlines",i),g.toggleClass("record-vlines",n),g.toggleClass("record-zebra",r),g.toggleClass("record-even",(()=>(t._index()+1)%2==0)),m.on("mouseleave",(t=>{t.relatedTarget&&t.relatedTarget.classList.contains("record")||e.changeHover(-1)})),e.isPreview?null:X((t=>(t.autoDispose(s.subscribe((()=>t.close()))),e.cellContextMenu()))),e.comparison?g.cssClass((()=>{const o=e.extraRows.getRowType(t.id());return o&&`diff-${o}`||""})):null,g.foreach(o.viewFields(),(function(i){var n=c.computed((()=>s()&&i._index()===e.cursor.fieldIndex())),r=c.computed((()=>n()&&o.hasFocus())),l=c.computed((function(){return e.copySelection()&&e.copySelection().isCellSelected(t.id(),i.colId())})),a=e.fieldBuilders.at(i._index()),d=c.computed((()=>!t._isAddRow()&&!e.cellSelector.isCurrentSelectType(I.NONE)&&c.unwrap(e.isColSelected.at(i._index()))&&e.cellSelector.isRowSelected(t._index())));return m("div.field",g.style("--frozen-position",(()=>c.unwrap(e.frozenPositions.at(i._index())))),g.toggleClass("frozen",(()=>c.unwrap(e.frozenMap.at(i._index())))),g.toggleClass("scissors",l),m.autoDispose(l),m.autoDispose(n),m.autoDispose(r),m.autoDispose(d),m.on("mouseenter",(()=>e.changeHover(i._index()))),g.toggleClass("hover-column",(()=>e.gristDoc.docModel.editingFormula()&&c.unwrap(e.hoverColumn)===i._index())),g.style("width",i.widthPx),g.style("borderRightWidth",o.borderWidthPx),g.toggleClass("selected",d),a.buildDomWithCursor(t,r,n),m("div.field_selection"))}))))}},se.prototype.onResize=function(){const e=this.activeFieldBuilder();let t=null;q()&&(t=window.outerHeight),e&&e.isEditorActive()?(this.scrolly.updateSize(t),this.scrolly.scrollRowIntoView(this.cursor.rowIndex.peek())):this.scrolly.scheduleUpdateSize(t),this.width(this.scrollPane.clientWidth)},se.prototype.onRowResize=function(e){this.scrolly.resetItemHeights(e)},se.prototype.onLinkFilterChange=function(e){C.prototype.onLinkFilterChange.call(this,e),this.clearSelection()},se.prototype.onCellContextMenu=function(e,t){let o=this.domToRowModel(t,I.CELL),s=this.domToColModel(t,I.CELL);this.cellSelector.containsCell(o._index(),s._index())?this.preventAssignCursor():this.assignCursor(t,I.NONE)},se.prototype._createColSelectedObs=function(e){return c.pureComputed((function(){return this.cellSelector.isCurrentSelectType(I.ROW)||u.between(e._index(),this.cellSelector.col.start(),this.cellSelector.col.end())}),this)},se.prototype.cellMouseDown=function(e,t){if(t.shiftKey){this.viewSection.hasFocus(!0);let t=this.domToRowModel(e,I.CELL),o=this.domToColModel(e,I.CELL);this.cellSelector.selectArea(this.cursor.rowIndex(),this.cursor.fieldIndex(),t._index(),o._index())}else this.assignCursor(e,I.NONE)},se.prototype.colMouseDown=function(e,t){this._colClickTime=Date.now(),this.assignCursor(e,I.COL),this.cellSelector.row.end(this.getLastDataRowIndex())},se.prototype.rowMouseDown=function(e,t){t.shiftKey?(this.cellSelector.currentSelectType(I.ROW),this.cellSelector.row.end(this.currentMouseRow(t.pageY))):this.assignCursor(e,I.ROW)},se.prototype.rowMouseMove=function(e){this.cellSelector.row.end(this.currentMouseRow(e.pageY))},se.prototype.colMouseMove=function(e){var t=Math.min(this.getMousePosCol(e.pageX),this.viewSection.viewFields().peekLength-1);this.cellSelector.col.end(t)},se.prototype.cellMouseMove=function(e){this.colMouseMove(e),this.rowMouseMove(e),this.cellSelector.onlyCellSelected(this.cursor.rowIndex(),this.cursor.fieldIndex())?this.cellSelector.currentSelectType(I.NONE):this.cellSelector.currentSelectType(I.CELL)},se.prototype.createSelector=function(){this.cellSelector=new I.CellSelector(this)},se.prototype.attachSelectorHandlers=function(){const e=(e,t)=>0!==e.button||e.target.classList.contains("ui-resizable-handle")||!this.ctxMenuHolder.isEmpty();this.autoDispose(Y(this.viewPane,".gridview_data_row_num",((t,o)=>{if(!e(t)){if(!this.cellSelector.isSelected(o,I.ROW))return this.rowMouseDown(o,t),{onMove:e=>this.rowMouseMove(e),onStop:e=>{}};if(!this.viewSection.disableDragRows())return this.styleRowDragElements(o,t),{onMove:e=>this.dragRows(e),onStop:e=>this.dropRows()}}}))),this.autoDispose(Y(this.viewPane,".column_name.field:not(.mod-add-column)",((t,o)=>{if(!e(t))return this.cellSelector.isSelected(o,I.COL)?(this.styleColDragElements(o,t),{onMove:e=>this.dragCols(e),onStop:e=>this.dropCols()}):(this.colMouseDown(o,t),{onMove:e=>this.colMouseMove(e),onStop:e=>{}})}))),this.autoDispose(Y(this.scrollPane,".field:not(.column_name)",((t,o)=>{if(!e(t))return this.cellSelector.isSelected(o,I.CELL)?(this.scheduleAssignCursor(o,I.NONE),{onMove:e=>{},onStop:e=>{this.cellSelector.currentDragType(I.NONE)}}):(this.cellMouseDown(o,t),{onMove:e=>this.cellMouseMove(e),onStop:e=>{}})})))},se.prototype.styleRowDragElements=function(e,t){var o=this.cellSelector.rowLower(),s=this.cellSelector.rowUpper(),i=this.scrolly.rowOffsetTree.getCumulativeValueRange(o,s+1),n=this.header.getBoundingClientRect().height+this.scrolly.rowOffsetTree.getSumTo(o)-this.scrollTop();this.rowLine.style.top=n+"px",this.rowShadow.style.top=n+"px",this.rowShadow.style.height=i+"px",this.rowShadowAdjust=t.pageY-n,this.cellSelector.currentDragType(I.ROW),this.cellSelector.row.dropIndex(this.cellSelector.rowLower())},se.prototype.styleColDragElements=function(e,t){this._colClickTime=Date.now();var o=this.cellSelector.colLower(),s=this.cellSelector.colUpper(),i=this.colRightOffsets.peek().getCumulativeValueRange(o,s+1),n=$(".gridview_corner_spacer").width()+this.colRightOffsets.peek().getSumTo(o)-this.scrollLeft();this.colLine.style.left=n+"px",this.colShadow.style.left=n+"px",this.colShadow.style.width=i+"px",this.colShadowAdjust=t.pageX-n,this.cellSelector.currentDragType(I.COL),this.cellSelector.col.dropIndex(this.cellSelector.colLower())},se.prototype.dragRows=function(e){var t=Math.min(this.getMousePosRow(e.pageY+this.scrollTop()),this.getLastDataRowIndex());this.cellSelector.containsRow(t)?t=this.cellSelector.rowLower():t>this.cellSelector.rowUpper()&&(t+=1),this.cellSelector.rowUpper()===this.viewData.peekLength-1&&(t=Math.min(t,this.cellSelector.rowLower()));var o=this.scrolly.rowOffsetTree.getSumTo(t)+this.header.getBoundingClientRect().height-this.scrollTop();this.cellSelector.row.linePos(o+"px"),this.cellSelector.row.dropIndex(t),this.dragY(e.pageY)},se.prototype.dragCols=function(e){let t=Math.min(this.getMousePosCol(e.pageX),this.viewSection.viewFields().peekLength-1);this.cellSelector.containsCol(t)?t=this.cellSelector.colLower():t>this.cellSelector.colUpper()&&(t+=1),this.cellSelector.colUpper()===this.viewSection.viewFields().peekLength-1&&(t=Math.min(t,this.cellSelector.colLower()));let o=$(".gridview_corner_spacer").width()+this.colRightOffsets.peek().getSumTo(t);const s=this.numFrozen(),i=s>0&&t<s,n=this.scrollLeft();o-=i?Math.min(this.frozenOffset.peek(),n):n,this.cellSelector.col.linePos(o+"px"),this.cellSelector.col.dropIndex(t),this.dragX(e.pageX)},se.prototype.dropRows=function(){var e=a.range(this.cellSelector.rowLower(),this.cellSelector.rowUpper()+1);this.moveRows(e,this.cellSelector.row.dropIndex()),this.cellSelector.currentDragType(I.NONE)},se.prototype.dropCols=function(){var e=a.range(this.cellSelector.colLower(),this.cellSelector.colUpper()+1);const t=this.cellSelector.col.dropIndex();this.moveColumns(e,t),Date.now()-this._colClickTime<500&&1===e.length&&t===e[0]&&this.currentEditingColumnIndex(t),this._colClickTime=0,this.cellSelector.currentDragType(I.NONE)},se.prototype.columnContextMenu=function(e,t,o,s){const a=t.colIds;this.ctxMenuHolder.autoDispose(e);const c=this._getColumnMenuOptions(t);return a.length>1&&a.includes(o.column().colId())?W(c):N(((e,t)=>{for(var o in t||(t={}))n.call(t,o)&&l(e,o,t[o]);if(i)for(var o of i(t))r.call(t,o)&&l(e,o,t[o]);return e})({filterOpenFunc:()=>s.open(),sortSpec:this.gristDoc.viewModel.activeSection.peek().activeSortSpec.peek(),colId:o.column.peek().id.peek()},c))},se.prototype._getColumnMenuOptions=function(e){return{columnIndices:e.fields.map((e=>e._index())),totalColumnCount:this.viewSection.viewFields.peek().peekLength,numColumns:e.fields.length,numFrozen:this.viewSection.numFrozen.peek(),disableModify:z(e.fields,(e=>e.disableModify.peek())),isReadonly:this.gristDoc.isReadonly.get()||this.isPreview,isRaw:this.viewSection.isRaw(),isFiltered:this.isFiltered(),isFormula:z(e.fields,(e=>e.column.peek().isRealFormula.peek()))}},se.prototype._columnFilterMenu=function(e,t,o){this.ctxMenuHolder.autoDispose(e);const s=this.viewSection.filters().find((({fieldOrColumn:e})=>e.origCol().origColRef()===t.column().origColRef()));return s.isFiltered.peek()||this.viewSection.setFilter(s.fieldOrColumn.origCol().origColRef(),{filter:te,pinned:!0}),this.createFilterMenu(e,s,o)},se.prototype.maybeSelectColumn=function(e,t){this.viewSection.hasFocus(!0);const o=this.getSelection().colIds;o.length>1&&o.includes(t.column().colId())||this.assignCursor(e,I.COL)},se.prototype.maybeSelectRow=function(e,t){this.viewSection.hasFocus(!0),this.getSelection().rowIds.includes(t)||this.assignCursor(e,I.ROW)},se.prototype.rowContextMenu=function(){return H(this._getRowContextMenuOptions())},se.prototype._getRowContextMenuOptions=function(){return{disableInsert:Boolean(this.gristDoc.isReadonly.get()||this.viewSection.disableAddRemoveRows()||this.tableModel.tableMetaRow.onDemand()),disableDelete:Boolean(this.gristDoc.isReadonly.get()||this.viewSection.disableAddRemoveRows()||this.getSelection().onlyAddRowSelected()),isViewSorted:this.viewSection.activeSortSpec.peek().length>0,numRows:this.getSelection().rowIds.length}},se.prototype.cellContextMenu=function(){return K(this._getRowContextMenuOptions(),this._getColumnMenuOptions(this.getSelection()))},se.prototype.scrollToCursor=function(e=!0){return g.doScrollChildIntoView(this.scrollPane,this.cursor.rowIndex(),e)},se.prototype._duplicateRows=async function(){const e=await C.prototype._duplicateRows.call(this),t=this.viewData.getRowIndex(e[0]);this.setCursorPos({rowId:e[0]}),e.every(((e,o)=>e===this.viewData.getRowId(t+o)))&&this.cellSelector.selectArea(t,0,t+e.length-1,this.viewSection.viewFields().peekLength-1)};class ne{constructor(e){this.el=e}show(e){this.hide(),this.tooltip=Q(this.el,(()=>m("span",e,J("column-formula-tooltip"))))}hide(){this.tooltip&&(this.tooltip.close(),this.tooltip=null)}dispose(){this.hide()}}e.exports=se},42683:(e,t,o)=>{var s=o(77949),i=o(29301),n=o(74392),r=o(83277),l=o(88438),a=o(81294),{Delay:c}=o(96682),d=o(92979),{makeT:u}=o(70387),h=o(87346),p=o(78843),m=o(24412),{menuToggle:g}=o(42882),{menu:f}=o(1370),{testId:w}=o(29922),{contextMenu:b}=o(74624);const v=u("RecordLayout");function _(e){this.viewSection=e.viewSection,this.buildFieldDom=e.buildFieldDom,this.buildContextMenu=e.buildContextMenu,this.isEditingLayout=i.observable(!1),this.editIndex=i.observable(0),this.layoutEditor=i.observable(null),e.resizeCallback&&(this._resizeCallback=e.resizeCallback,this._delayedResize=this.autoDispose(c.create())),this.fieldsById=this.autoDispose(i.computed((function(){return s.indexBy(this.viewSection.viewFields().all(),(function(e){return e.getRowId()}))}),this)),this.layoutSpec=this.autoDispose(i.computed((function(){return this.viewSection.isDisposed()?null:_.updateLayoutSpecWithFields(this.viewSection.layoutSpecObj(),this.viewSection.viewFields().all())}),this).extend({rateLimit:0})),this.autoDispose(this.layoutSpec.subscribe((()=>this.resizeCallback())))}l.makeDisposable(_),_.prototype.resizeCallback=function(){this.isDisposed()||!this._delayedResize||this.isEditingLayout.peek()||this._delayedResize.schedule(0,this._resizeCallback)},_.prototype.getField=function(e){if("string"==typeof e){var t=r.maxsplit(e,":",2);return{isNewField:!0,colRef:parseInt(t[0],10),label:t[1],value:t[2]}}return this.fieldsById()[e]},_.prototype.editLayout=function(e){this.editIndex(e),this.isEditingLayout(!0)},_.prototype.onEditLayoutCancel=function(e){this.isEditingLayout(!1),this.resizeCallback()},_.prototype.onEditLayoutSave=async function(e){try{await this.saveLayoutSpec(e)}finally{this.isEditingLayout(!1),this.resizeCallback()}},_.updateLayoutSpecWithFields=function(e,t){var o=h.Layout.create(e,(function(e){return a("div")})),i=o.getAllLeafIds(),n=t.map((function(e){return e.getRowId()}));return s.difference(i,n).forEach((function(e){o.getLeafBox(e).dispose()})),s.difference(n,i).forEach((function(e){var t=o.buildLayoutBox({leaf:e}),i=o.rootBox().childBoxes.peek();i.length>=1&&s.last(i).isLeaf()?s.last(i).addChild(t,!0):o.rootBox().addChild(t,!0)})),e=o.getLayoutSpec(),o.dispose(),e},_.prototype.saveLayoutSpec=async function(e){if(JSON.stringify(e)===this.viewSection.layoutSpec.peek())return;const t=this.viewSection._table.docModel,o=t.docData,s=this.viewSection.table().tableId(),i=e=>this.getField(e),l=["AddColumn",null,{}];var a=[],c=new Map;this.viewSection.viewFields().all().forEach((e=>{a.push(e.getRowId()),c.set(e.colRef(),e.getRowId())}));var d=0,u=0,h=[],p=[],m=[],g=[],f=[],w=[],b=[];!function e(t){if(t.leaf&&"empty"!==t.leaf){let e=d++,o=i(t.leaf),s=e=>{t.leaf=e};if(o.isNewField)if(c.has(o.colRef)){let t=c.get(o.colRef);h.push(t),p.push(e),s(t)}else Number.isNaN(o.colRef)?(u++,w.push(s),b.push(e)):(m.push(o.colRef),g.push(s),f.push(e));else h.push(o.getRowId()),p.push(e)}t.children&&t.children.map(e)}(e);let _=w.concat(g),y=b.concat(f),x=r.arrayRepeat(u,0).map((()=>l.slice()));await o.bundleActions(v("Updating record layout."),(()=>n.try((()=>u>0?t.dataTables[s].sendTableActions(x):[])).then((e=>{let o=e.map((e=>e.colRef)).concat(m);const s=o.length;return s>0?t.viewFields.sendTableAction(["BulkAddRecord",r.arrayRepeat(s,null),{parentId:r.arrayRepeat(s,this.viewSection.getRowId()),colRef:o,parentPos:y}]):[]})).each(((e,t)=>{_[t](e)})).then((t=>{let s=[],i=new Set(h.concat(t)),n=a.filter((e=>!i.has(e)));return n.length>0&&s.push(["BulkRemoveRecord","_grist_Views_section_field",n]),h.length>0&&s.push(["BulkUpdateRecord","_grist_Views_section_field",h,{parentPos:p}]),s.push(["UpdateRecord","_grist_Views_section",this.viewSection.getRowId(),{layoutSpec:JSON.stringify(e)}]),o.sendActions(s)}))))},_.prototype.buildLayoutDom=function(e,t){const o=Boolean(t&&!this.layoutEditor.peek()),s=h.Layout.create(this.layoutSpec(),(t=>a("div.g_record_layout_leaf.flexhbox.flexauto",this.buildFieldDom(this.getField(t),e),o?d.maybe(this.layoutEditor,(e=>e.buildLeafDom())):null))),i=this.layoutSpec.subscribe((e=>{s.buildLayout(e,o)}));return o&&this.layoutEditor(p.create(this,s)),a("div.g_record_detail.flexauto",a.autoDispose(s),a.autoDispose(i),o?a.onDispose((()=>{this.layoutEditor.peek().dispose(),this.layoutEditor(null)})):null,b((()=>this.buildContextMenu(e))),a("div.detail_row_num",d.text((()=>e._index()+1)),a.on("contextmenu",(e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget.querySelector(".menu_toggle").click()})),g(null,a.on("click",(()=>{this.viewSection.hasFocus(!0),m.allCommands.setCursor.run(e)})),f((()=>this.buildContextMenu(e))),w("card-menu-trigger"))),a("div.g_record_detail_inner",s.rootElem))},_.prototype.getContainingField=function(e,t){return this.getField(h.Layout.getContainingBox(e,t).leafId())},_.prototype.getContainingRow=function(e,t){var o=a.findAncestor(e,t,".g_record_detail");return i.utils.domData.get(o,"itemModel")},e.exports=_},78843:(e,t,o)=>{var s=o(77949),i=o(86277).Events,n=o(88438),{makeT:r}=o(70387),l=o(24412),a=o(29255);const c=r("RecordLayoutEditor"),{basicButton:d,cssButton:u,primaryButton:h}=o(11187),{icon:p}=o(7454),{menu:m,menuDivider:g,menuItem:f}=o(1370),{testId:w}=o(29922),{dom:b,Observable:v,styled:_}=o(18099);function y(e,t,o){this.recordLayout=e,this.layout=t,this.layoutEditor=this.autoDispose(a.LayoutEditor.create(t)),this._hiddenColumns=this.autoDispose(v.create(null,this.getHiddenColumns())),this.listenTo(t,"layoutChanged",(function(){this._hiddenColumns.set(this.getHiddenColumns())})),o&&(this.listenTo(t,"layoutChanged",o),this.listenTo(t,"layoutResized",o)),this.autoDispose(l.createGroup(y.editLayoutCommands,this,!0))}n.makeDisposable(y),s.extend(y.prototype,i),y.editLayoutCommands={accept:function(){this.recordLayout.onEditLayoutSave(this.layout.getLayoutSpec())},cancel:function(){this.layout.buildLayout(this.recordLayout.layoutSpec()),this.recordLayout.onEditLayoutCancel()}},y.prototype.getHiddenColumns=function(){var e=new Set(this.layout.getAllLeafIds().map((function(e){var t=this.recordLayout.getField(e);return t.isNewField?t.colRef:t.colRef.peek()}),this));return this.recordLayout.viewSection.table().columns().all().filter((function(t){return!e.has(t.getRowId())&&!t.isHiddenCol()}))},y.prototype._addField=function(e){var t=this.layout.buildLayoutBox({leaf:e}),o=this.layout.rootBox().childBoxes.peek();o.length>=1&&s.last(o).isLeaf()?s.last(o).addChild(t,!0):this.layout.rootBox().addChild(t,!0)},y.prototype.buildEditorDom=function(){const e=()=>{this._addField(":New_Field:")},t=e=>{setTimeout((()=>this._addField(e.getRowId()+":"+e.label())),0)};return x(d(c("Add Field"),S("Collapse"),m((o=>[f((()=>e()),c("Create New Field")),b.maybe((e=>e(this._hiddenColumns).length>0),(()=>g())),b.forEach(this._hiddenColumns,(e=>f((()=>t(e)),c("Show field {{- label}}",{label:e.label()})))),w("edit-layout-add-menu")]))),b("div.flexauto",{style:"margin-left: 8px"}),this.buildFinishButtons(),w("edit-layout-controls"))},y.prototype.buildFinishButtons=function(){return[h(c("Save Layout"),b.on("click",(()=>l.allCommands.accept.run()))),d(c("Cancel"),b.on("click",(()=>l.allCommands.cancel.run())),{style:"margin-left: 8px"})]},y.prototype.buildLeafDom=function(){return b("div.layout_grabbable.g_record_layout_editing",b("div.g_record_delete_field.glyphicon.glyphicon-eye-close",b.on("mousedown",(e=>e.stopPropagation())),b.on("click",((e,t)=>{e.preventDefault(),e.stopPropagation(),this.layoutEditor.removeContainingBox(t)}))))};const x=_("div",`\n  display: flex;\n  align-items: flex-start;\n\n  & > .${u.className} {\n    white-space: nowrap;\n    overflow: hidden;\n  }\n`),S=_(p,"\n  margin: -3px -2px -2px 2px;\n");e.exports=y},8113:(e,t,o)=>{var s=o(29301),i=o(88438),n=o(81294),r=o(92979),l=o(73783),a=o(87056),{makeT:c}=o(70387);const d=c("ValidationPanel");function u(e){this.gristDoc=e.gristDoc,this.validationsTable=this.gristDoc.docModel.validations,this.validations=this.autoDispose(this.validationsTable.createAllRowsModel("id")),this.docTables=this.autoDispose(this.gristDoc.docModel.tables.createAllRowsModel("tableId")),this.tableChoices=this.autoDispose(this.docTables.map((function(e){return{label:e.tableId,value:e.id()}})))}i.makeDisposable(u),u.prototype.onAddRule=function(){this.validationsTable.sendTableAction(["AddRecord",null,{tableRef:this.docTables.at(0).id(),name:d("Rule {{length}}",{length:this.validations.peekLength+1}),formula:""}]).then((function(){$(".validation_formula").last().find("input").focus()}))},u.prototype.onDeleteRule=function(e){this.validationsTable.sendTableAction(["RemoveRecord",e])},u.prototype.buildDom=function(){return[l.row(1,l.label("Validations"),1,l.buttonGroup(l.button(this.onAddRule.bind(this),"Add Rule",n.testId("Validation_addRule")))),n("div",n.testId("Validation_rules"),r.foreach(this.validations,(e=>{var t=a.create({observable:e.formula}),o=s.observable(!0);return n("div.validation",n.autoDispose(t),n("div.validation_title.flexhbox",n("div.validation_name",l.editableLabel(e.name)),n("div.flexitem"),n("div.validation_trash.glyphicon.glyphicon-remove",n.on("click",this.onDeleteRule.bind(this,e.id())))),l.row(1,n("div.glyphicon.glyphicon-tag.config_icon"),8,l.label("Table"),9,l.select(e.tableRef,this.tableChoices)),n("div.kf_elem.validation_formula",t.buildDom((s=>{t.attachSaveCommand(),s.on("change",(()=>{t.getValue()===e.formula()!==o()&&o(!o())})),s.removeAllListeners("blur")}))),l.row(2,"",1,l.buttonGroup(l.button((()=>t.writeObservable()),"Apply",{title:d("Update formula (Shift+Enter)")},r.toggleClass("disabled",o)))))})))]},e.exports=u},52103:(e,t,o)=>{var s=o(92979),i=$.ui.resizable.prototype._respectSize;$.ui.resizable.prototype._respectSize=function(){var e=i.apply(this,arguments);return this.options.isFlex&&(console.log("Ignoring left, top"),e.left=e.top=void 0),e},t.makeResizable=function(e,t){function o(o,s){e(s.size.width),"resizestop"===o.type&&(t.stop&&t.stop(o,s),e.save&&!1!==t.shouldSave&&e.save())}return t=t||{},function(e){$(e).resizable({handles:t.handles||"e",resize:o,stop:o,isFlex:t.isFlex,minWidth:t.minWidth||10}),t.hasOwnProperty("enabled")&&s.setBinding(e,t.enabled,(function(e,t){t?$(e).resizable("enable"):$(e).resizable("disable").removeClass("ui-state-disabled")}))}}},61237:(e,t,o)=>{var s=o(77949),i=o(29301),n=o(20543),r=o(83277),l=o(10328),{Delay:a}=o(96682),c=o(88438),d=o(92979),u=o(81294),h=o(11527).get("window","$");function p(e,t,o,n,r){this.scrolly=e,this.paneIndex=t,this.container=o,this.itemCreateFunc=r,this.preparedRows=[],s.extend(this.scrolly.options,n),this.container.appendChild(this.scrollDiv=u("div.scrolly_outer",d.style("height",this.scrolly.totalHeightPx),this.blockDiv=u("div",d.style("position","absolute"),d.style("top",this.scrolly.blockTopPx),d.style("width",n.fitToWidth?"100%":""),d.style("padding-right",n.paddingRight+"px")))),i.utils.domNodeDisposal.addDisposeCallback(o,(()=>{for(var e in this.scrolly.destroyPane(this),this)delete this[e]})),h.$(this.container).on("scroll",(()=>this.scrolly.onScroll(this)))}function m(e){this.data=e,this.numRows=0,this.options={paddingBottom:0},this.panes=[],this.activeItemModels=[],this.rowHeights=[],this.rowOffsetTree=new l,this.minRowHeight=23,this.numBuffered=1,this.numRendered=1,this.begin=0,this.end=0,this.scrollTop=0,this.shownHeight=0,this.blockBottom=0,this.blockTop=i.observable(0),this.blockTopPx=i.computed((function(){return this.blockTop()+"px"}),this),this.totalHeight=i.observable(0),this.totalHeightPx=i.computed((function(){return this.totalHeight()+"px"}),this),this.subscription=this.autoDispose(this.data.subscribe(this.onDataSplice,this,"spliceChange")),this.delayedUpdateSize=this.autoDispose(a.create());var t=this.data.all();this.onDataSplice({array:t,start:0,added:t.length,deleted:[]});let o=()=>{this.scheduleUpdateSize()};h.$(h.window).on("resize.scrolly",o),this.autoDisposeCallback((()=>h.$(h.window).off("resize.scrolly",o)))}function g(e){return e._scrollyObj||(e._scrollyObj=m.create(e),e._scrollyObj.autoDisposeCallback((()=>delete e._scrollyObj))),e._scrollyObj}p.prototype.prepareNewRows=function(){var e,t,o,s=this.scrolly.begin,r=this.scrolly.end-s,l=this.scrolly.data.peek(),a=this.scrolly.activeItemModels,c=this.preparedRows;for(c.length>0&&n.equal(c.length,a.length,"Rows and models not in sync: "+c.length+"!="+a.length),this.preparedRows=[],e=0;e<c.length;e++)if(o=c[e],null===(t=a[e])._index())i.removeNode(o);else{var u=t._index()-s;n(u>=0&&u<r,"prepareNewRows saw out-of-range model"),this.preparedRows[u]=o}for(e=0;e<r;e++)this.preparedRows[e]||(t=l[s+e],n(t,"ScrollyPane item missing at index "+(s+e)),t._rowHeightPx(""),o=this.itemCreateFunc(t),d.style("height",t._rowHeightPx)(o),i.utils.domData.set(o,"itemModel",t),this.preparedRows[e]=o,this.blockDiv.appendChild(o))},p.prototype.measurePreparedRow=function(e){var t=this.preparedRows[e].getBoundingClientRect();return t.bottom-t.top},p.prototype.arrangePreparedRows=function(){for(var e=0;e<this.preparedRows.length;e++){var t=this.preparedRows[e],o=this.blockDiv.childNodes[e];t!==o&&this.blockDiv.insertBefore(t,o)}},t.Scrolly=m,c.makeDisposable(m),m.prototype.debug=function(){console.log("Scrolly: numRows "+this.numRows+"; panes "+this.panes.length+"; numRendered "+this.numRendered+" ["+this.begin+", "+this.end+"); block at "+this.blockTop()+" of "+this.totalHeight()+"; scrolled to "+this.scrollTop+"; shownHeight "+this.shownHeight),console.assert(this.numRows,this.data.peekLength,"Wrong numRows; data is "+this.data.peekLength),console.assert(this.numRows,this.rowHeights.length,"Wrong rowHeights size "+this.rowHeights.length),console.assert(this.numRows,this.rowOffsetTree.size(),"Wrong rowOffsetTree size "+this.rowOffsetTree.size());var e=Math.min(this.numRendered,this.numRows);console.assert(this.end-this.begin,e,"Wrong range size "+(this.end-this.begin)),console.assert(this.activeItemModels.length,e,"Wrong activeItemModels.size "+this.activeItemModels.length);var t=this.blockBottom-this.blockTop();if(e>0)for(var o=0;o<this.panes.length;o++){var i=this.panes[o].preparedRows[0].getBoundingClientRect(),n=s.last(this.panes[o].preparedRows).getBoundingClientRect().bottom-i.top;n!==t&&console.warn("Scrolly render pane #%d %dpx bigger from expected (%dpx per row). Ensure items have no margins",o,n-t,(n-t)/e)}},t.getInstance=g,m.prototype.addPane=function(e,t,o){var s=new p(this,this.panes.length,e,t,o);this.panes.push(s),this.scheduleUpdateSize()},m.prototype.scheduleUpdateSize=function(e){this.isDisposed()||this.delayedUpdateSize.isPending()||this.delayedUpdateSize.schedule(0,this.updateSize.bind(this,e),this)},m.prototype.updateSize=function(e){this.resetHeights(),this.shownHeight=Math.max(0,Math.max.apply(null,this.panes.map((function(e){return e.container.clientHeight}))));var t=Math.max(1,Math.ceil((null!=e?e:this.shownHeight)/this.minRowHeight));this.numBuffered=5,this.numRendered=t+2*this.numBuffered,this._updateRange(),this.render(),this.syncScrollPosition()},m.prototype.onScroll=function(e){this.scrollTo(e.container.scrollTop)},m.prototype.scrollTo=function(e){if(e!==this.scrollTop&&(this.scrollTop=e,this.syncScrollPosition(),!(this.blockTop()<=e&&this.blockBottom>=e+this.shownHeight))){var t=e+this.shownHeight>=this.panes[0].container.scrollHeight;this._updateRange(),this.render(),t&&(this.scrollTop=this.panes[0].container.scrollHeight-this.shownHeight),this.syncScrollPosition()}},m.prototype.onDataSplice=function(e){this.numRows=this.data.peekLength,this.rowHeights.splice(e.start,e.deleted.length),r.arraySplice(this.rowHeights,e.start,r.arrayRepeat(e.added,this.minRowHeight)),this.rowOffsetTree.fillFromValues(this.rowHeights),this.totalHeight(this.rowOffsetTree.getTotal()+this.options.paddingBottom),this._updateRange(),this.scheduleUpdateSize()},m.prototype.syncScrollPosition=function(){for(var e=this.scrollTop,t=0;t<this.panes.length;t++)this.panes[t].container.scrollTop=e},m.prototype.createItemModel=function(){var e=this.data.makeItemModel();return e._rowHeightPx=i.observable(""),e},m.prototype.render=function(){var e,t,o,s,i,r=this.end-this.begin,l=this.data.peek(),a=[];n(this.end<=l.length,"Scrolly render() exceeds data length of "+l.length);var c=this.rowOffsetTree.getIndex(this.scrollTop),d=this.rowOffsetTree.getSumTo(c);for(e=0;e<this.activeItemModels.length;e++)(null===(s=(o=this.activeItemModels[e])._index())||s<this.begin||s>=this.end)&&a.push(o);for(e=0,s=this.begin;e<r;e++,s++)l[s]||(o=a.shift()||this.createItemModel(),this.data.setItemModel(o,s),o._rowHeightPx(""));for(e=0;e<a.length;e++)this.data.unsetItemModel(a[e]);for(t=0;t<this.panes.length;t++)this.panes[t].prepareNewRows();for(e=0,s=this.begin;e<r;e++,s++)if(""===(o=l[s])._rowHeightPx.peek()){var u=this.minRowHeight;for(t=0;t<this.panes.length;t++)u=Math.max(u,this.panes[t].measurePreparedRow(e));0!=(i=(u=Math.round(u))-this.rowHeights[s])&&(this.rowHeights[s]=u,this.rowOffsetTree.addValue(s,i))}for(e=0,s=this.begin;e<r;e++,s++)(o=l[s])._rowHeightPx(this.rowHeights[s]+"px");for(t=0;t<this.panes.length;t++)this.panes[t].arrangePreparedRows();this.activeItemModels=l.slice(this.begin,this.end),this.totalHeight(this.rowOffsetTree.getTotal()+this.options.paddingBottom),this.blockTop(this.rowOffsetTree.getSumTo(this.begin)),this.blockBottom=this.rowOffsetTree.getSumTo(this.end),0!=(i=this.rowOffsetTree.getSumTo(c)-d)&&(this.scrollTop+=i,this.syncScrollPosition())},m.prototype.resetHeights=function(e){var t=this.data.peek();if(e)for(var o=0;o<e.length;o++){var s=t[e[o]];s&&s._rowHeightPx("")}else this.activeItemModels.forEach((function(e){e._rowHeightPx("")}));this.render()},m.prototype.resetItemHeights=function(e){this.isDisposed()||(e.forEach((e=>e._rowHeightPx(""))),this.render())},m.prototype.scrollToPosition=function(e){var t=e();this.scrollTo(t),(t=e())!==this.scrollTop&&(this.scrollTop=t,this.syncScrollPosition())},m.prototype.scrollRowIntoView=function(e){this.scrollToPosition((()=>{var t=this.rowOffsetTree.getSumTo(e),o=t+this.rowHeights[e];return r.clamp(this.scrollTop,o-this.shownHeight+43,t-10)}))},m.prototype.scrollToSavedPos=function(e){this.scrollToPosition((()=>this.rowOffsetTree.getSumTo(e.rowIndex)+e.offset))},m.prototype.getScrollPos=function(){var e=this.rowOffsetTree.getIndex(this.scrollTop);return{rowIndex:e,offset:this.scrollTop-this.rowOffsetTree.getSumTo(e)}},m.prototype.destroyPane=function(e){r.arrayRemove(this.panes,e),0===this.panes.length&&this.dispose()},m.prototype._updateRange=function(){const e=this.rowOffsetTree.getIndex(this.scrollTop)-this.numBuffered;this.begin=r.clamp(e,0,this.numRows-this.numRendered),this.end=r.clamp(this.begin+this.numRendered,0,this.numRows)},t.scrolly=function(e,t,o){return n.equal(typeof o,"function"),t=t||{},function(s){var n=g(e);n.addPane(s,t,o),i.utils.domData.set(s,"scrolly",n)}}},88795:(e,t,o)=>{var s=o(77949),i=o(29301),n=o(88438),r=o(55424),l=o(32529),a=o(86277).Events;function c(e,t,o,s){var n=["id"].concat(t);r.call(this,e,n),this._rowId=s,this.events=this.autoDisposeWith("stopListening",a),this._isDeleted=i.observable(!1),this._fields.forEach((function(e){this._assignColumn(e)}),this),o&&o.call(this,e.docModel,e)}n.makeDisposable(c),s.extend(c.prototype,r.prototype),c.prototype._assignColumn=function(e){this.hasOwnProperty(e)&&this[e].assign(this._table.tableData.getValue(this._rowId,e))},c.Floater=function(e,t){this._table=e,this.rowIdObs=t,this._underlyingRowModel=this.autoDispose(i.computed((function(){return e.getRowModel(t())}))),s.each(this._underlyingRowModel(),(function(e,t){i.isObservable(e)&&(this[t]=this.autoDispose(i.pureComputed({owner:this,read:function(){return this._underlyingRowModel()[t]()},write:function(e){this._underlyingRowModel()[t](e)}})),e.saveOnly&&l.addSaveInterface(this[t],(e=>this._underlyingRowModel()[t].saveOnly(e))))}),this)},n.makeDisposable(c.Floater),e.exports=c},10832:(e,t,o)=>{var s=o(77949),i=o(29301),n=o(88438),r=o(88795),l=o(33113),a=o(3871),c=o(20543),d=o(83277);function u(e,t,o,s){l.call(this,e,t),this._fields=o,this._rowConstructor=s,this.rowModels=[],this._rowModelVersions=[],this.listenTo(this,"rowNotify",(function(e,t){c(e!==a.ALL,"Unexpected schema action on a metadata table");for(let o of e)this.rowModels[o]&&this.rowModels[o].dispatchAction(t)}))}n.makeDisposable(u),s.extend(u.prototype,l.prototype),u.prototype.loadData=function(){c(this.tableData.isLoaded,"MetaTableModel: tableData not yet loaded"),this.getAllRows().forEach((function(e){this._createRowModel(e)}),this)},u.prototype.getRowModel=function(e,t){const o=this.rowModels[e]||this.getEmptyRowModel();if(t){const t=this._rowModelVersions[e];t&&t()}return o},u.prototype.getEmptyRowModel=function(){return this._createRowModel(0)},u.prototype._createRowModel=function(e){return this.rowModels[e]||i.ignoreDependencies((()=>{this.rowModels[e]=r.create(this,this._fields,this._rowConstructor,e);let t=this._rowModelVersions[e]||(this._rowModelVersions[e]=i.observable(0));t(t.peek()+1)})),this.rowModels[e]},u.prototype.createFloatingRowModel=function(e){return r.Floater.create(this,e)},u.prototype._process_RemoveRecord=function(e,t,o){l.prototype._process_RemoveRecord.apply(this,arguments),this._deleteRowModel(o)},u.prototype._deleteRowModel=function(e){this.rowModels[e]._isDeleted(!0),this.rowModels[e].dispose(),delete this.rowModels[e]},u.prototype._process_BulkRemoveRecord=function(e,t,o){l.prototype._process_BulkRemoveRecord.apply(this,arguments),o.forEach((e=>this._deleteRowModel(e)))},u.prototype._process_AddRecord=function(e,t,o,s){this._createRowModel(o),l.prototype._process_AddRecord.apply(this,arguments)},u.prototype._process_BulkAddRecord=function(e,t,o,s){o.forEach((e=>this._createRowModel(e))),l.prototype._process_BulkAddRecord.apply(this,arguments)},u.prototype.applySchemaAction=function(e){throw new Error("No schema actions should apply to metadata")},u.prototype.createAllRowsModel=function(e){return this._createRowSetModel(this,e)},u.prototype.createRowGroupModel=function(e,t){var o=this.getRowGrouping(t.groupBy);return this._createRowSetModel(o.getGroup(e),t.sortBy)},u.prototype._createRowSetModel=function(e,t){var o=this.tableData.getRowPropFunc(t),s=a.SortedRowSet.create(null,(function(e,t){return d.nativeCompare(o(e),o(t))}));s.subscribeTo(e);var i=this._createRowModelArray(s.getKoArray());return i.autoDispose(s),i},u.prototype._createRowModelArray=function(e){var t=e.map(this._createRowModelItem,this);return t.subscribe((function(e){var t,o=e.array;for(t=0;t<e.deleted.length;t++)e.deleted[t]._index(null);if(0!=e.added-e.deleted.length)for(t=e.start+e.added;t<o.length;t++)o[t]._index(t)}),null,"spliceChange"),t},u.prototype._createRowModelItem=function(e,t){var o=this._createRowModel(e);c.ok(o,"MetaTableModel._createRowModelItem called for invalid rowId "+e);var s=Object.create(o);return s._index=i.observable(t),s},e.exports=u},10328:e=>{function t(e){if(this.tree=[],e>0){this.tree.length=e;for(var t=0;t<e;t++)this.tree[t]=0;this.mask=i(this.tree.length-1)}}function o(e){return e&-e}function s(e){return e&e-1}function i(e){if(0===e)return 0;for(var t=1;e>>>=1;)t<<=1;return t}function n(e){for(var t=e.length-1;t>=1;t--)e[t]-=e[t-1];return e}function r(e){for(var t=1;t<e.length;t++)e[t]+=e[t-1];return e}t.leastSignificantOne=o,t.stripLeastSignificantOne=s,t.mostSignificantOne=i,t.cumulToValues=n,t.valuesToCumul=r,t.prototype.size=function(){return this.tree.length},t.prototype.toCumulativeArray=function(){for(var e=[this.tree[0]],t=e.length=this.tree.length,o=1;o<t;o++)e[o]=this.tree[o]+e[s(o)];return e},t.prototype.toValueArray=function(){return n(this.toCumulativeArray())},t.prototype.fillFromCumulative=function(e){var t=this.tree.length=e.length;if(t>0){this.tree[0]=e[0];for(var o=1;o<t;o++)this.tree[o]=e[o]-e[s(o)];this.mask=i(this.tree.length-1)}else this.mask=0},t.prototype.fillFromValues=function(e){this.fillFromCumulative(r(e.slice()))},t.prototype.getCumulativeValue=function(e){for(var t=this.tree[0];e>0;)t+=this.tree[e],e=s(e);return t},t.prototype.getCumulativeValueRange=function(e,t){return this.getSumTo(t)-this.getSumTo(e)},t.prototype.getSumTo=function(e){return e>0?this.getCumulativeValue(e-1):0},t.prototype.getTotal=function(){return this.getCumulativeValue(this.tree.length-1)},t.prototype.getValue=function(e){var t=this.tree[e];if(e>0){var o=s(e);for(e--;e!==o;)t-=this.tree[e],e=s(e)}return t},t.prototype.addValue=function(e,t){if(0===e)this.tree[0]+=t;else for(;e<this.tree.length;)this.tree[e]+=t,e+=o(e)},t.prototype.setValue=function(e,t){this.addValue(e,t-this.getValue(e))},t.prototype.getIndex=function(e){if(0===this.tree.length||this.tree[0]>=e)return 0;for(var t=0,o=this.mask,s=this.tree[0];0!==o;){var i=t+o;i<this.tree.length&&s+this.tree[i]<e&&(t=i,s+=this.tree[t]),o>>>=1}return t+1},e.exports=t}}]);
//# sourceMappingURL=288.bundle.js.map