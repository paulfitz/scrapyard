(self.webpackChunkgrist_core=self.webpackChunkgrist_core||[]).push([[928,674],{50489:(e,t,o)=>{"use strict";o.r(t),o.d(t,{setupAceEditorCompletions:()=>s});var n=o(30835);const i=new WeakMap;function s(e,t){!function(){if(r)return;r=!0;const e=n.acequire("ace/ext/language_tools");e.setCompleters([]),e.addCompleter({identifierRegexps:[/[a-zA-Z_0-9.$\u00A2-\uFFFF(]/],async getCompletions(e,t,o,n,s){const r=i.get(e);if(!r||0===n.length)return void s(null,[]);const d=(await r.getSuggestions(n)).map((e=>{const[t,o]=e;if(Array.isArray(t)){const[e,n]=t;return{value:e+"(",caption:e+n,score:1,example:o,funcname:e}}return{value:t,caption:t,score:1,example:o,funcname:""}})),u=d.filter((e=>e.example)).map((e=>e.caption.length)),p=Math.min(Math.min(...u)+a,Math.max(...u),c);for(const e of d){if(!e.example)continue;const t=Math.max(0,p-e.caption.length)+l;e.caption=e.caption+" ".repeat(t)+e.example}s(null,d)}})}(),i.set(e,t);const{Autocomplete:o}=n.acequire("ace/autocomplete"),s=new o;s.autoSelect=!1,e.completer=s,s._gristShouldRefreshCompletions=function(e){const t=this.editor.getCursorPosition(),o=this.editor.session.getTextRange({start:e,end:t}).toLowerCase();return o.endsWith(".")||o.endsWith(".lookupone(")||o.endsWith(".lookuprecords(")}.bind(s);const u=s.updateCompletions.bind(s);s.updateCompletions=function(e){return e&&this.base&&this.completions&&this._gristShouldRefreshCompletions(this.base)&&(this.completions=null),u(e)}.bind(s);const p=s.insertMatch.bind(s);s.insertMatch=function(){const e=this.base,t=p.apply(...arguments);return this._gristShouldRefreshCompletions(e)&&this.showPopup(this.editor),t}.bind(s),function(e){const t=e.$init;e.$init=function(){const e=t.apply(this,arguments);return d(this,e),e}}(s),e.on("destroy",(()=>{s.editor&&s.detach(),s.popup&&(s.popup.destroy(),s.popup.container.remove())}))}let r=!1;const l=8,a=15,c=40;function d(e,t){const o=t.session.bgTokenizer.$tokenizeRow;t.session.bgTokenizer.$tokenizeRow=function(e){const n=o(e);return function(e,t){if(!e.funcname&&!e.example)return t;const o=e.funcname.lastIndexOf("."),n=o<0?0:o+1,i=e.funcname.length,s=[],r="https://support.getgrist.com/functions/#"+e.funcname.slice(n,i).toLowerCase();let l;s.push({value:r,type:"grist_link_hidden"}),e.example&&(e.caption.endsWith(e.example)?l=e.caption.length-e.example.length:console.warn(`Example "${e.example}" does not match caption "${e.caption}"`));let a=0;for(const e of t){if(l&&a+e.value.length>l){const t=l-a;t>0?(s.push({value:e.value.slice(0,t),type:e.type}),s.push({value:e.value.slice(t),type:"grist_example"})):s.push({value:e.value,type:"grist_example"})}else{const t=n-a,o=i-a;if(t>0){const o=e.value.slice(0,t);s.push({value:o,type:e.type})}if(o>0){const n=e.value.slice(Math.max(0,t),o),i=e.type+(e.type?".":"")+"grist_link";if(s.push({value:n,type:i}),o<e.value.length){const t=e.value.slice(o);s.push({value:t,type:e.type})}}else s.push(e)}a+=e.value.length}return s}(t.data[e],n)},t.removeAllListeners("click"),t.on("click",(function(t){(function(e){var t;const o=e.target;if(o&&o.matches(".ace_grist_link")){const e=null==(t=o.parentElement)?void 0:t.querySelector(".ace_grist_link_hidden");if(e)return window.open(e.textContent,"_blank"),!0}return!1})(t.domEvent)||e.insertMatch(),t.stop()}))}},44747:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ChartConfig:()=>ge,ChartView:()=>me,chartTypes:()=>we,isNumericLike:()=>ue,isNumericOnly:()=>de});var n=o(30583),i=o.n(n),s=o(11579),r=o(93965),l=Object.defineProperty,a=Object.defineProperties,c=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,h=(e,t,o)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,m=(e,t)=>{for(var o in t||(t={}))u.call(t,o)&&h(e,o,t[o]);if(d)for(var o of d(t))p.call(t,o)&&h(e,o,t[o]);return e},f=(e,t)=>a(e,c(t));const g=o(49268),b=o(76274),y=o(50949);function v(e){if(!e[0])return;const t=e[0].values,o=t.map(((e,t)=>t));o.sort(((e,o)=>(0,s.typedCompare)(t[e],t[o])));for(const t of e){const e=t.values;t.values=o.map((t=>e[t]))}}function _(e,t){const o=e[t].values.map(r.xD);return e.map(((n,i)=>{if(i===t)return f(m({},e[t]),{values:y(o)});let s=[];for(const[e,t]of o.entries())Array.isArray(t)?s=s.concat(Array(t.length).fill(n.values[e])):s.push(n.values[e]);return f(m({},n),{values:s})}))}function w(e,t){let o=0;for(const n of t){if(o<e[0].values.length&&n!==e[0].values[o]||o>e[0].values.length-1){e[0].values.splice(o,0,n);for(let t=1;t<e.length;++t)e[t].values.splice(o,0,0)}for(;n===e[0].values[o]&&o<e[0].values.length;)o++}return e}function x(e){return Math.floor(100*e)+" %"}var C=o(96682),D=o(88438),k=o(95163),S=o(62258),I=o(92769),T=o(32529),R=o(22641),F=o(3411),A=o(51536),O=o(92478),E=o(29922),M=o(13884),P=o(7454),B=o(1370),$=o(83277),L=o(48210),N=o(86277),z=o(18099),V=o(29301),U=o(70387),j=Object.defineProperty,H=Object.defineProperties,W=Object.getOwnPropertyDescriptors,G=Object.getOwnPropertySymbols,Y=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,q=(e,t,o)=>t in e?j(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,J=(e,t)=>{for(var o in t||(t={}))Y.call(t,o)&&q(e,o,t[o]);if(G)for(var o of G(t))K.call(t,o)&&q(e,o,t[o]);return e},Z=(e,t)=>H(e,W(t));const Q=o(26352),X=o(88466),ee=o(52906),te=o(29809),oe=o(38072),ne=o(7531),ie=o(6311),se=o(37346);let re;const le=(0,z.makeTestId)("test-chart-"),ae=(0,U.makeT)("ChartView");function ce(e){return["pie","donut"].includes(e)}function de(e){return["bar","pie","donut","kaplan_meier","line","area","scatter"].includes(e)}function ue(e,t=$.unwrap){const o=function(e,t=$.unwrap){const o=t(e.pureType);return"Ref"===o?t(t(e.visibleColModel).type):o}(e,t);return["Numeric","Int","Any"].includes(o)}function pe(e,t){if(void 0===e.group)return e.label;const o=""===e.group?"[Blank]":e.group;return t?`${o} • ${e.label}`:String(o)}const he=["ChoiceList","RefList"];class me extends D.Disposable{get _sortSpec(){return this.viewSection.activeSortSpec.peek()}create(e,t){i().call(this,e,t),this._chartDom=this.autoDispose(this.buildDom()),this._resize=this.autoDispose(C.Delay.untilAnimationFrame(this._resizeChart,this)),this.viewPane=this._chartDom,this._chartType=this.viewSection.chartTypeDef,this._options=this.viewSection.optionsObj,this._formatterComp=this.autoDispose(V.computed((()=>{const e=this.viewSection.viewFields().at(1);return null==e?void 0:e.visibleColFormatter()}))),this._update=X((()=>this._updateView()),0);let o=[];this.autoDispose(this._chartType.subscribe(this._update)),this.autoDispose(this._options.subscribe(this._update)),this.autoDispose(this.viewSection.viewFields().subscribe((e=>{this._update(),o.forEach((e=>e.dispose())),o=[...e.map((e=>e.displayColModel.peek().type.subscribe(this._update))),...e.map((e=>e.visibleColModel.peek().type.subscribe(this._update)))]}))),this.listenTo(this.sortedRows,"rowNotify",this._update),this.autoDispose(this.sortedRows.getKoArray().subscribe(this._update)),this.autoDispose(this._formatterComp.subscribe(this._update)),this.autoDispose(this.gristDoc.docPageModel.appModel.currentTheme.addListener((()=>this._update())))}prepareToPrint(e){re.relayout(this._chartDom,{}).catch(I.reportError)}onTableLoaded(){i().prototype.onTableLoaded.call(this),this._update()}onResize(){this._resize()}buildDom(){return(0,z.dom)("div.chart_container",le("container"))}listenTo(...e){}async _updateView(){var e;if(this.isDisposed())return;const t=we[this._chartType()];if("function"!=typeof t)return void console.warn("Unknown trace type %s",this._chartType());const o=this.viewSection.viewFields().all(),n=this.sortedRows.getKoArray().peek(),i=this._options.prop("multiseries").peek()?2:1;let s=o.filter(((e,t)=>t<i||this._isCompatibleSeries(e.column.peek()))).map((e=>{const t=e.displayColModel.peek().colId.peek(),o=this.tableModel.tableData.getRowPropFunc(t),i=e.displayColModel().pureType(),s="Date"===i||"DateTime"===i?function(e){return t=>{const o=1e3*e(t);return o?new Date(o).toISOString():null}}(o):o;return{label:e.label(),values:n.map(s),isInSortSpec:Boolean(L.Sort.findCol(this._sortSpec,e.colRef.peek()))}}));for(let e=0;e<s.length;++e)e<o.length&&he.includes(o[e].column.peek().pureType.peek())&&(e<i?s=_(s,e):s[e].values=s[e].values.map((e=>String((0,r.xD)(e)))));const l={},a=this._options.peek()||{};let c={data:[]};if(ce(this._chartType.peek())&&(l.sort=!1,v(s)),"donut"===this._chartType.peek()&&(l.totalFormatter=this._formatterComp.peek()),!a.multiseries&&s.length)c=t(s,a,l);else if(s.length>1){const o=!s[0].isInSortSpec,n=function(e,t,o){const n=new Map,i=Math.floor(100/t.length);let s=[...new Set(e)];o&&s.sort(),s=s.slice(0,i);for(const e of s)n.set(e,t.map((t=>({label:t.label,group:e,values:[]}))));for(let o=0;o<e.length;o++){const i=e[o],s=n.get(i);if(s)for(let e=0;e<t.length;e++)s[e].values.push(t[e].values[o])}return n}(s[0].values,s.slice(1),o),i=Array.from(new Set(s[1].values));for(const o of n.values()){"bar"===this._chartType.peek()&&(null==(e=this._sortSpec)?void 0:e.length)&&w(o,i);const n=t(o,a,l);n.data=c.data.concat(n.data),c=n}}if(re=re||await(0,S.m)(),this.isDisposed())return;const d=te(c.layout,this._getPlotlyLayout(a)),u=Z(J({},c.config),{displayModeBar:!1});await re.react(this._chartDom,c.data,d,u),this._resizeChart()}_resizeChart(){!this.isDisposed()&&re&&this._chartDom.parentNode&&re.Plots.resize(this._chartDom)}_isCompatibleSeries(e){return!de(this._chartType.peek())||ue(e)}_getPlotlyLayout(e){const t={automargin:!0,title:{standoff:0}};e.logYAxis&&(t.type="log"),e.invertYAxis&&(t.autorange="reversed");const o=J({margin:{l:50,r:50,b:40,t:30,pad:4},yaxis:t,xaxis:{automargin:!0,title:{standoff:0}}},e.stacked?{barmode:"relative"}:{});return ne(o,this._getPlotlyTheme())}_getPlotlyTheme(){const e=this.gristDoc.docPageModel.appModel,{colors:t}=e.currentTheme.get();return{paper_bgcolor:t["chart-bg"],plot_bgcolor:t["chart-bg"],xaxis:{color:t["chart-x-axis"]},yaxis:{color:t["chart-y-axis"]},font:{color:t["chart-fg"]},legend:{bgcolor:t["chart-legend-bg"]}}}}ee(me.prototype,i().prototype),Object.assign(me.prototype,N.Events);const fe=class extends z.Disposable{constructor(e,t){super(),this._gristDoc=e,this._section=t,this._configFieldsHelper=A.M1.create(this,this._gristDoc,this._section),this._xAxisFieldIndex=z.Computed.create(this,(0,z.fromKo)(this._optionsObj.prop("multiseries")),(0,z.fromKo)(this._optionsObj.prop("isXAxisUndefined")),((e,t,o)=>o?-1:t?1:0)),this._groupDataColId=z.Computed.create(this,(e=>{const t=e(this._optionsObj.prop("multiseries")),o=e(e(this._section.viewFields).getObservable());return t&&0!==o.length?e(e(o[0].column).colId):""})).onWrite((e=>this._setGroupDataColumn(e))),this._freezeXAxis=z.Observable.create(this,!1),this._freezeYAxis=z.Observable.create(this,!1),this._xAxis=z.Computed.create(this,this._xAxisFieldIndex,this._freezeXAxis,((e,t,o)=>{if(o)return this._xAxis.get();const n=e(e(this._section.viewFields).getObservable());return-1<t&&t<n.length?e(e(n[t].column).colId):""})).onWrite((e=>this._setXAxis(e))),this._isValueAggregated=z.Computed.create(this,(e=>this._isSummaryTable(e))).onWrite((e=>this._setAggregation(e))),this._columnsOptions=z.Computed.create(this,this._freezeXAxis,((e,t)=>t?this._columnsOptions.get():(e(this._isValueAggregated)?this._getSummarySourceColumns(e):this._getColumns(e)).filter((e=>!e.isHiddenCol.peek())).map((e=>({value:e.colId(),label:e.label.peek(),icon:"FieldColumn"}))))),this._groupDataOptions=z.Computed.create(this,(e=>[{value:"",label:"Pick a column"},...e(this._columnsOptions)])),this._groupDataForce=z.Observable.create(null,!1),this._groupData=z.Computed.create(this,this._groupDataColId,this._groupDataForce,((e,t,o)=>!!t||o)).onWrite((e=>{!1===e&&this._groupDataColId.set(""),this._groupDataForce.set(e)})),this._firstFieldLabel=z.Computed.create(this,(0,z.fromKo)(this._section.chartTypeDef),((e,t)=>function(e){return["pie","donut","kaplan_meier","scatter"].includes(e)}(t)?"LABEL":"X-AXIS")),this._chartType=z.Computed.create(this,(e=>e(this._section.chartTypeDef))).onWrite((e=>this._gristDoc.docData.bundleActions("switched chart type",(async()=>{await this._section.chartTypeDef.saveOnly(e),ce(e)&&(await this._setGroupDataColumn(""),this._groupDataForce.set(!1))})))),fe._instanceMap.set(t,this)}get _optionsObj(){return this._section.optionsObj}buildDom(){return"chart"!==this._section.parentKey()?null:[(0,F.cssRow)((0,B.select)(this._chartType,[{value:"bar",label:"Bar Chart",icon:"ChartBar"},{value:"pie",label:"Pie Chart",icon:"ChartPie"},{value:"donut",label:"Donut Chart",icon:"ChartDonut"},{value:"area",label:"Area Chart",icon:"ChartArea"},{value:"line",label:"Line Chart",icon:"ChartLine"},{value:"scatter",label:"Scatter Plot",icon:"ChartLine"},{value:"kaplan_meier",label:"Kaplan-Meier Plot",icon:"ChartKaplan"}]),le("type")),z.dom.maybe((e=>!ce(e(this._section.chartTypeDef))),(()=>[ve("Split series",this._groupData),ye("Invert Y-axis",this._optionsObj.prop("invertYAxis")),(0,F.cssRow)(De("Orientation"),(0,z.dom)("div",(0,B.linkSelect)((0,k.fromKoSave)(this._optionsObj.prop("orientation")),[{value:"v",label:"Vertical"},{value:"h",label:"Horizontal"}],{defaultLabel:"Vertical"})),le("orientation")),ye("Log scale Y-axis",this._optionsObj.prop("logYAxis"))])),z.dom.maybeOwned((e=>"donut"===e(this._section.chartTypeDef)),(e=>[be("Hole Size",z.Computed.create(e,(e=>{var t;return null!=(t=e(this._optionsObj.prop("donutHoleSize")))?t:.75})),(e=>this._optionsObj.prop("donutHoleSize").saveOnly(e)),le("option")),ye("Show Total",this._optionsObj.prop("showTotal")),z.dom.maybe(this._optionsObj.prop("showTotal"),(()=>function(e,t,o,...n){let i;async function s(e,n=(e=>e)){let s=parseFloat(e);isFinite(s)&&(s=Q(n(s),1,1/0),await o(s)),i.value=t.get()+"px"}return(0,F.cssRow)(De(e),Ae(i=Oe({type:"text"},z.dom.prop("value",(e=>e(t)+"px")),z.dom.on("change",((e,t)=>s(t.value))),z.dom.onKeyDown({ArrowDown:(e,t)=>s(t.value,(e=>e-1)),ArrowUp:(e,t)=>s(t.value,(e=>e+1))})),Ee("input",{type:"number",step:"1",min:String(1)},z.dom.prop("value",t),z.dom.on("change",((e,t)=>s(t.value))))),...n)}("Text Size",z.Computed.create(e,(e=>{var t;return null!=(t=e(this._optionsObj.prop("textSize")))?t:24})),(e=>this._optionsObj.prop("textSize").saveOnly(e)),le("option"))))])),z.dom.maybe((e=>"line"===e(this._section.chartTypeDef)),(()=>[ye("Connect gaps",this._optionsObj.prop("lineConnectGaps")),ye("Show markers",this._optionsObj.prop("lineMarkers"))])),z.dom.maybe((e=>["line","bar"].includes(e(this._section.chartTypeDef))),(()=>[ye("Stack series",this._optionsObj.prop("stacked")),(0,F.cssRow)(De("Error bars"),(0,z.dom)("div",(0,B.linkSelect)((0,k.fromKoSave)(this._optionsObj.prop("errorBars")),[{value:"",label:"None"},{value:"symmetric",label:"Symmetric"},{value:"separate",label:"Above+Below"}],{defaultLabel:"None"})),le("error-bars")),z.dom.domComputed(this._optionsObj.prop("errorBars"),(e=>"symmetric"===e?ke(ae("Each Y series is followed by a series for the length of error bars.")):"separate"===e?ke(ae("Each Y series is followed by two series, for top and bottom error bars.")):null))])),(0,F.cssSeparator)(),z.dom.maybe(this._groupData,(()=>[(0,F.cssLabel)("Split Series"),(0,F.cssRow)((0,B.select)(this._groupDataColId,this._groupDataOptions),le("group-by-column")),Re(ae("Create separate series for each value of the selected column."))])),(0,F.cssLabel)(z.dom.text(this._firstFieldLabel),le("first-field-label")),(0,F.cssRow)((0,B.select)(this._xAxis,this._columnsOptions,{defaultLabel:ae("Pick a column")}),le("x-axis")),ve("Aggregate values",this._isValueAggregated),(0,F.cssLabel)("SERIES"),this._buildYAxis(),(0,F.cssRow)(Ie(Se("Plus"),"Add Series",(0,B.menu)((()=>{const e=this._section.hiddenColumns.peek(),t=this._isCompatibleSeries.bind(this),o=e.filter((e=>!t(e))).length;return[...e.filter((e=>t(e))).map((e=>(0,B.menuItem)((()=>this._configFieldsHelper.addField(e)),e.label.peek()))),o?(0,B.menuText)(`${o} `+(o>1?"non-numeric columns are not shown":"non-numeric column is not shown"),le("yseries-picker-message")):null]})),le("add-y-axis")))]}async _setXAxis(e){const t=this._section.optionsObj,o=()=>this._getColumns().find((t=>t.colId()===e)),n=this._section.viewFields.peek();await this._gristDoc.docData.bundleActions("selected new x-axis",(async()=>{this._freezeYAxis.set(!0),this._freezeXAxis.set(!0);try{-1!==this._xAxisFieldIndex.get()&&this._xAxisFieldIndex.get()<n.peek().length&&await this._configFieldsHelper.removeField(n.peek()[this._xAxisFieldIndex.get()]),await(0,T.setSaveValue)(this._optionsObj.prop("isXAxisUndefined"),!1);const i=n.peek().findIndex((t=>t.column.peek().colId()===e));if(0===i&&t.prop("multiseries").peek())return void await t.prop("multiseries").setAndSave(!1);if(this._isValueAggregated.get()){const t=this._groupDataColId.get(),o=t===e?[e]:[t,e];await this._setGroupByColumns(o)}const s=n.peek()[this._xAxisFieldIndex.get()];if(i>-1)await this._configFieldsHelper.changeFieldPosition(n.peek()[i],s);else{const e=o();e&&await this._configFieldsHelper.addField(e,s)}}finally{this._freezeYAxis.set(!1),this._freezeXAxis.set(!1)}}))}async _setGroupDataColumn(e){const t=this._section.viewFields.peek().peek();await this._gristDoc.docData.bundleActions(ae("selected new group data columns"),(async()=>{this._freezeXAxis.set(!0),this._freezeYAxis.set(!0);try{if(this._groupDataColId.get()&&await this._configFieldsHelper.removeField(t[0]),this._isValueAggregated.get()){const t=this._xAxis.get(),o=t===e?[e]:[e,t];await this._setGroupByColumns(o)}if(e){const o=this._getColumns().find((t=>t.colId()===e)),n=t.find((t=>t.column.peek().colId()===e));n?await this._configFieldsHelper.changeFieldPosition(n,t[0]):await this._configFieldsHelper.addField(o,t[0]),e===this._xAxis.get()&&await this._optionsObj.prop("isXAxisUndefined").setAndSave(!0)}await this._optionsObj.prop("multiseries").setAndSave(Boolean(e))}finally{this._freezeXAxis.set(!1),this._freezeYAxis.set(!1)}}),{nestInActiveBundle:!0})}_getColumns(e=$.unwrap){const t=e(this._section.table);return e(e(t.columns).getObservable())}_getSummarySourceColumns(e=$.unwrap){let t=e(this._section.table);return t=e(t.summarySource),e(e(t.columns).getObservable())}_buildField(e){return(0,A.B3)((0,A.Tw)(z.dom.text(e.label)),Te("Remove",z.dom.on("click",(()=>this._configFieldsHelper.removeField(e))),le("ref-select-remove")),le("y-axis"))}_buildYAxis(){const e=z.Computed.create(this,(0,z.fromKo)(this._optionsObj.prop("multiseries")),(0,z.fromKo)(this._optionsObj.prop("isXAxisUndefined")),((e,t,o)=>(o?0:1)+(t?1:0)));return z.dom.domComputed((t=>this._configFieldsHelper.buildVisibleFieldsConfigHelper({itemCreateFunc:e=>this._buildField(e),draggableOptions:{removeButton:!1,drag_indicator:M.x},skipFirst:e,freeze:this._freezeYAxis,filterFunc:e=>this._isCompatibleSeries(t(e.column),t)})))}_isCompatibleSeries(e,t=$.unwrap){return!de(t(this._chartType))||ue(e,t)}async _setAggregation(e){try{this._freezeXAxis.set(!0),await this._gristDoc.docData.bundleActions(ae("Toggle chart aggregation"),(async()=>{e?await this._doAggregation():await this._undoAggregation()}))}finally{this.isDisposed()||this._freezeXAxis.set(!1)}}async _doAggregation(){this._isSummaryTable()?await this._setGroupByColumns([this._xAxis.get(),this._groupDataColId.get()]):await this._toggleSummaryTable()}async _undoAggregation(){this._isSummaryTable()&&await this._toggleSummaryTable()}_isSummaryTable(e=$.unwrap){return Boolean(e(e(this._section.table).summarySourceTable))}async _toggleSummaryTable(){const e=[this._xAxis.get(),this._groupDataColId.get()],t=(0,R.FU)(this._section);t.summarize=!this._isSummaryTable(),t.columns=this._getColumnIds(e),this._ensureValidLinkingIfAny(t);const o=await this._gristDoc.saveViewSection(this._section,t);return fe._instanceMap.get(o)}async _setGroupByColumns(e){const t=(0,R.FU)(this._section);return t.columns=this._getColumnIds(e),this._ensureValidLinkingIfAny(t),this._gristDoc.saveViewSection(this._section,t)}_ensureValidLinkingIfAny(e){if(!e.summarize)return;if(!this._section.linkSrcSection().getRowId())return;const t=(0,R.FU)(this._section.linkSrcSection());e.columns=se(e.columns,t.columns)}_getColumnIds(e){const t=this._isSummaryTable()?this._section.table().summarySource().columns().all():this._section.table().columns().all();return e.map((e=>e&&t.find((t=>t.colId()===e)))).filter((e=>Boolean(e))).map((e=>e.id()))}};let ge=fe;function be(e,t,o,...n){let i;async function s(e,n=(e=>e)){let s=parseFloat(e);isFinite(s)&&(s=Q(n(s),0,99)/100,await o(s)),i.value=x(t.get())}return(0,F.cssRow)(De(e),Fe({type:"range",min:"0",max:"1",step:"0.01"},z.dom.prop("value",t),z.dom.on("change",((e,t)=>o(Number(t.value))))),Ae(i=Oe({type:"text"},z.dom.prop("value",(e=>x(e(t)))),z.dom.on("change",((e,t)=>s(t.value))),z.dom.onKeyDown({ArrowDown:(e,t)=>s(t.value,(e=>e-1)),ArrowUp:(e,t)=>s(t.value,(e=>e+1))})),Ee("input",{type:"number",step:"0.01",min:"0",max:"0.99"},z.dom.prop("value",t),z.dom.on("change",((e,t)=>o(Number(t.value)))))),...n)}function ye(e,t,...o){return ve(e,(0,k.fromKoSave)(t),...o)}function ve(e,t,...o){return(0,z.dom)("label",F.cssRow.cls(""),De(e),(0,O.n2)(t,...o))}function _e(e,t,o){xe(e);const n=function(e,t){const o=new Map;if(t.errorBars)for(let n=1;n<e.length;n++)o.set(e[n],{type:"data",symmetric:"symmetric"===t.errorBars,array:e[n+1]&&e[n+1].values,arrayminus:"separate"===t.errorBars?e[n+2]&&e[n+2].values:void 0,thickness:1,width:3}),e.splice(n+1,"symmetric"===t.errorBars?1:2);return o}(e,t);"bar"===o.type&&function(e){if(!e[0])return;const t=e[0].values.length,o=new Set(b(g(t),(t=>e[0].values[t])));e.forEach((e=>{e.values=e.values.filter(((e,t)=>o.has(t)))}))}(e);const[i,s]="h"===t.orientation?["y","x"]:["x","y"];function r(e,t){if(!e)return e;const o=t.find((e=>e&&(e>0||e<0)));return o&&o<0?"-"+e:e}return{data:e.slice(1).map((l=>Z(J({name:pe(l,e.length>2),[i]:Ce(e[0].values),[s]:l.values,[`error_${s}`]:n.get(l),orientation:t.orientation},o),{stackgroup:r(o.stackgroup,l.values)}))),layout:{[`${i}axis`]:{title:e.length>0?{text:e[0].label}:{}},[`${s}axis`]:{title:2===e.length?{text:e[1].label}:{}}}}}ge._instanceMap=new WeakMap;const we={bar:(e,t)=>_e(e,t,{type:"bar"}),line:(e,t)=>(v(e),_e(e,t,{type:"scatter",connectgaps:t.lineConnectGaps,mode:t.lineMarkers?"lines+markers":"lines",stackgroup:t.stacked?"A":""})),area:(e,t)=>(v(e),_e(e,t,{type:"scatter",fill:"tozeroy",line:{shape:"spline"}})),scatter:(e,t)=>_e(e.slice(1),t,{type:"scatter",mode:"text+markers",text:e[0].values,textposition:"bottom center"}),pie(e,t,o={}){let n;return 0===e.length?{data:[]}:(e.length>1?(xe(e),n=e[1]):n={label:"Count",values:e[0].values.map((()=>1))},{data:[J({type:"pie",name:pe(n,!1),labels:Ce(e[0].values),values:n.values},o)]})},donut(e,t,o={}){var n;const i=oe(t.donutHoleSize)?t.donutHoleSize:.75,s=[],r=we.pie(e,t,Z(J({},o),{hole:i}));var l;return t.showTotal&&s.push({text:(l=e.length>1?ie(e[1].values.filter(oe)):r.data[0].labels.length,o.totalFormatter?o.totalFormatter.formatAny(l):String(l)),showarrow:!1,font:{size:null!=(n=t.textSize)?n:24}}),te(r,{layout:{annotations:s}})},kaplan_meier:e=>e.length<2?{data:[]}:{data:function(e,t){const o=new Map;for(const[n,i]of e.entries())o.has(i)||o.set(i,[]),o.get(i).push(t[n]);return Array.from(o,(([e,t])=>({label:e,values:t})))}(e[0].values,e[1].values).map((e=>{const t=function(e){const t=new Map;for(const o of e)t.set(o,(t.get(o)||0)+1);const o=Array.from(t.keys());o.sort($.nativeCompare);let n=e.length;const i=[{x:0,y:n}];for(const e of o)n-=t.get(e),i.push({x:e,y:n});return i}(e.values);return{type:"scatter",mode:"lines",line:{shape:"hv"},name:pe(e,!1),x:t.map((e=>e.x)),y:t.map((e=>e.y))}}))}};function xe(e){const t=e.slice(1).map((e=>e.values));for(const o of e)o.values=o.values.filter(((e,o)=>t.some((e=>"number"==typeof e[o]))))}function Ce(e){return e.map((e=>null==e||""===e?"-":e))}const De=(0,z.styled)("div",`\n  flex: 1 0 0px;\n  margin-right: 8px;\n\n  font-weight: initial;   /* negate bootstrap */\n  color: ${E.theme.text};\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: none;\n`),ke=(0,z.styled)(F.cssRow,`\n  font-size: ${E.vars.smallFontSize};\n  color: ${E.theme.lightText};\n`),Se=(0,z.styled)(P.icon,"\n  margin-right: 4px;\n"),Ie=(0,z.styled)("div",`\n  display: flex;\n  cursor: pointer;\n  color: ${E.theme.controlFg};\n  --icon-color: ${E.theme.controlFg};\n\n  &:not(:first-child) {\n    margin-top: 8px;\n  }\n  &:hover, &:focus, &:active {\n    color: ${E.theme.controlHoverFg};\n    --icon-color: ${E.theme.controlHoverFg};\n  }\n`),Te=(0,z.styled)(P.icon,`\n  display: none;\n  cursor: pointer;\n  flex: none;\n  margin-left: 8px;\n  .${A.B3.className}:hover & {\n    display: block;\n  }\n`),Re=(0,z.styled)("div",`\n  margin: -4px 16px 8px 16px;\n  color: ${E.theme.lightText};\n`),Fe=(0,z.styled)("input","\n  input& {\n    width: 82px;\n    margin-right: 4px;\n  }\n"),Ae=(0,z.styled)("div","\n  position: relative;\n"),Oe=(0,z.styled)("input","\n  width: 55px;\n"),Ee=(0,z.styled)("input",`\n  width: 19px;\n  position: absolute;\n  top: 2px;\n  right: 1px;\n  border: none;\n  outline: none;\n  appearance: none;\n  -moz-appearance: none;\n  visibility: hidden;\n\n  .${Ae.className}:hover & {\n    visibility: visible;\n  }\n\n  /* needed for chrome to show spinners, indeed the cursor could be outside of spinners' input\n  element */\n  &[type=number]::-webkit-inner-spin-button {\n    opacity: 1;\n  }\n`)},67931:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Cursor:()=>a});var n=o(24412),i=o(18099),s=o(29301);function r(e){return null==e?void 0:e}const l=class extends i.Disposable{constructor(e,t){super(),this._isLive=s.observable(!0),t=t||{},this.viewData=e.viewData,this._sectionId=this.autoDispose(s.computed((()=>e.viewSection.id()))),this._rowId=s.observable(t.rowId||0),this.rowIndex=this.autoDispose(s.computed({read:()=>{if(!this._isLive())return this.rowIndex.peek();const e=this._rowId();return null==e?null:this.viewData.clampIndex(this.viewData.getRowIndexWithSub(e))},write:e=>{const t=this.viewData.clampIndex(e);this._rowId(null==t?null:this.viewData.getRowId(t))}})),this.fieldIndex=e.viewSection.viewFields().makeLiveIndex(t.fieldIndex||0),this.autoDispose(n.createGroup(l.editorCommands,this,e.viewSection.hasFocus)),this.autoDispose(this._rowId.subscribe((t=>e.viewSection.activeRowId(t)))),this.onDispose((()=>{e.viewSection.lastCursorPos=this.getCursorPos()})),this.currentPosition=this.autoDispose(s.computed((()=>this._isLive()?this.getCursorPos():{})))}getCursorPos(){return{rowId:r(this._rowId()),rowIndex:r(this.rowIndex()),fieldIndex:this.fieldIndex(),sectionId:this._sectionId()}}setCursorPos(e){void 0!==e.rowId&&this.viewData.getRowIndex(e.rowId)>=0?this._rowId(e.rowId):void 0!==e.rowIndex&&e.rowIndex>=0?this.rowIndex(e.rowIndex):this.rowIndex(this.rowIndex.peek()),void 0!==e.fieldIndex&&this.fieldIndex(e.fieldIndex)}setLive(e){this._isLive(e)}};let a=l;a.editorCommands={cursorUp(){this.rowIndex(this.rowIndex()-1)},cursorDown(){this.rowIndex(this.rowIndex()+1)},cursorLeft(){this.fieldIndex(this.fieldIndex()-1)},cursorRight(){this.fieldIndex(this.fieldIndex()+1)},skipUp(){this.rowIndex(this.rowIndex()-5)},skipDown(){this.rowIndex(this.rowIndex()+5)},pageUp(){this.rowIndex(this.rowIndex()-20)},pageDown(){this.rowIndex(this.rowIndex()+20)},prevField(){this.fieldIndex(this.fieldIndex()-1)},nextField(){this.fieldIndex(this.fieldIndex()+1)},moveToFirstRecord(){this.rowIndex(0)},moveToLastRecord(){this.rowIndex(1/0)},moveToFirstField(){this.fieldIndex(0)},moveToLastField(){this.fieldIndex(1/0)},setCursor(e,t){this.rowIndex(e?e._index():0),this.fieldIndex(t?t._index():0)}}},11104:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ACIndexImpl:()=>d,buildHighlightedDom:()=>u,highlightNone:()=>c,normalizeText:()=>l});var n=o(83277);const i=o(41469),s=o(8308),r=o(95030);function l(e){return s(e).trim().toLowerCase()}const a=/[\s!"#$%&'()*+,\-./:;<=>?@[\\\]^_`{|}~]+/,c=e=>[e];class d{constructor(e,t=50,o=!1){this._maxResults=t,this._keepOrder=o,this._allItems=e.slice(0);const i=[];for(let e=0;e<this._allItems.length;e++){const t=this._allItems[e].cleanText.split(a).filter((e=>e));for(let o=0;o<t.length;o++)i.push({word:t[o],index:e,pos:o})}i.sort(((e,t)=>(0,n.localeCompare)(e.word,t.word))),this._words=i}search(e){const t=l(e),o=t.split(a).filter((e=>e)),s=new Map;if(o.length>0){for(let e=0;e<o.length;e++){const t=o[e];for(const[o,n]of this._findOverlaps(t,e))s.set(o,(s.get(o)||0)+n)}for(const[e,o]of s)this._allItems[e].cleanText.startsWith(t)&&s.set(e,o+1)}const r=Array.from(s).sort(((e,t)=>(0,n.nativeCompare)(t[1],e[1])||(0,n.nativeCompare)(e[0],t[0]))).slice(0,this._maxResults),d=r.map((([e,t])=>e));for(let e=0;e<this._allItems.length&&d.length<this._maxResults;e++)this._allItems[e].cleanText&&!s.has(e)&&d.push(e);this._keepOrder&&d.sort(n.nativeCompare);const u=d.map((e=>this._allItems[e]));if(!t)return{items:u,highlightFunc:c,selectIndex:-1};const p=h.bind(null,o);let m=r.length>0?d.indexOf(r[0][0]):-1;return m>=0&&!function(e,t,o){if(e.cleanText.startsWith(t))return!0;const n=new RegExp(o.map((e=>"\\b"+i(e))).join(".*")),s=e.cleanText.split(a).join(" ");return n.test(s)}(u[m],t,o)&&(m=-1),{items:u,highlightFunc:p,selectIndex:m}}_findOverlaps(e,t){const o=(0,n.sortedIndex)(this._words,{word:e},((e,t)=>(0,n.localeCompare)(e.word,t.word))),i=new Map;for(const n of[1,-1]){let s=e,r=o+(n>0?0:-1);for(;s&&r>=0&&r<this._words.length;){for(;r>=0&&r<this._words.length;r+=n){const o=this._words[r];if(!o.word.startsWith(s))break;const n=s.length+(o.word===e?1:0)+Math.pow(2,-(t+o.pos));n>=(i.get(o.index)||0)&&i.set(o.index,n)}s=s.slice(0,-1)}}return i}}function u(e,t,o){return e?t(e).map(((e,t)=>t%2?o(e):e)):e}const p=new RegExp(`(${a.source})`);function h(e,t){const o=t.split(p),n=[""];for(let t=0;t<o.length;t+=2){const i=o[t],l=o[t+1]||"",a=m(s(i).toLowerCase(),e);if(0===a)n[n.length-1]+=i+l;else{const e=r(i,"");n.push(e.slice(0,a).join(""),e.slice(a).join("")+l)}}return n}function m(e,t){return t.reduce(((t,o)=>Math.max(t,function(e,t){let o=0;for(;o<e.length&&e[o]===t[o];)++o;return o}(e,o))),0)}},84462:(e,t,o)=>{"use strict";o.d(t,{H:()=>u,R:()=>c});var n=o(11104),i=o(6632),s=o(29922),r=o(7454),l=o(1370),a=o(18099);function c(e,t,...o){const{acIndex:s,valueObs:r,save:c}=t,f=a.Holder.create(e);let g;const b=()=>!f.isEmpty(),y=()=>f.isEmpty()&&i.Autocomplete.create(f,g,D),v=()=>{f.clear(),g.blur()},_=()=>{g.value=r.get(),v()},w=async()=>{await C()||_()},x=()=>{b()?w().catch((()=>{})):y()},C=async()=>{var e;const t=null==(e=f.get())?void 0:e.getSelectedItem();t&&(g.value=t.value),g.disabled=!0;try{return await c(g.value,t),v(),!0}catch(e){return!1}finally{g.disabled=!1}},D={menuCssClass:`${l.menuCssClass} test-acselect-dropdown`,search:async e=>s.search(e),renderItem:(e,t)=>u((0,n.buildHighlightedDom)(e.label,t,m)),getItemText:e=>e.value,onClick:C};return d(g=p({type:"text"},a.dom.prop("value",r),a.dom.on("focus",((e,t)=>t.select())),a.dom.on("blur",w),a.dom.prop("disabled",(e=>!!t.disabled&&e(t.disabled))),a.dom.onKeyDown({Escape:_,Enter:x,ArrowDown:y,Tab:C}),a.dom.on("input",y)),a.dom.on("mousedown",(e=>{var o;e.preventDefault(),(null==(o=t.disabled)?void 0:o.get())||(b()||g.focus(),x())})),h("Dropdown"),...o)}const d=(0,a.styled)("div",`\n  position: relative;\n  width: 100%;\n  height: 30px;\n  color: ${s.theme.selectButtonFg};\n  --icon-color: ${s.theme.selectButtonFg};\n`),u=(0,a.styled)("li",`\n  color: ${s.theme.menuItemFg};\n  display: block;\n  white-space: pre;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  outline: none;\n  padding: var(--weaseljs-menu-item-padding, 8px 24px);\n  cursor: pointer;\n\n  &.selected {\n    background-color: ${s.theme.menuItemSelectedBg};\n    color:            ${s.theme.menuItemSelectedFg};\n  }\n`),p=(0,a.styled)("input",`\n  color: ${s.theme.inputFg};\n  background-color: ${s.theme.inputBg};\n  appearance: none;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n  height: 100%;\n  width: 100%;\n  padding: 0 6px;\n  outline: none;\n  border: 1px solid ${s.theme.inputBorder};\n  border-radius: 3px;\n  cursor: pointer;\n  line-height: 16px;\n  cursor: pointer;\n\n  &:disabled {\n    color: ${s.theme.inputDisabledFg};\n    background-color: ${s.theme.inputDisabledBg};\n  }\n  &:focus {\n    cursor: initial;\n    outline: none;\n    box-shadow: 0px 0px 2px 2px ${s.theme.inputFocus};\n  }\n  &::placeholder {\n    color: ${s.theme.inputPlaceholderFg};\n  }\n`),h=(0,a.styled)(r.icon,"\n  position: absolute;\n  right: 6px;\n  top: calc(50% - 8px);\n"),m=(0,a.styled)("span",`\n  color: ${s.theme.autocompleteMatchText};\n  .selected > & {\n    color: ${s.theme.autocompleteSelectedMatchText};\n  }\n`)},59011:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CustomSectionElement:()=>i,ViewProcess:()=>n.$m});var n=o(12856);class i{static getSections(e){return e.reduce(((e,t)=>{const o=t.definition.manifest.contributions.customSections,n=t.definition.id;if(o){const t=o.map((e=>({sectionId:e.name,pluginId:n})));return e.concat(t)}return e}),[])}static find(e,t){const o=e.definition.manifest.contributions.customSections;if(o){const n=o.find((({name:e})=>e===t));if(n)return e.safeBrowser.createViewProcess(n.path)}}}},96682:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Delay:()=>i});var n=o(88438);class i extends n.Disposable{constructor(){super(...arguments),this._timeoutId=null}static wrapWithDelay(e,t,o){return function(...n){const i=o||this;setTimeout((()=>t.apply(i,n)),e)}}static untilAnimationFrame(e,t){let o=null;const n=function(...n){null===o&&(o=window.requestAnimationFrame((()=>{o=null,e.apply(t,n)})))};return n.dispose=function(){null!==o&&window.cancelAnimationFrame(o)},n}create(){this.autoDisposeCallback(this.cancel)}cancel(){null!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null)}isPending(){return null!==this._timeoutId}schedule(e,t,o,...n){this.cancel(),this._timeoutId=setTimeout((()=>{this._timeoutId=null,t.apply(o,n)}),e)}}},12856:(e,t,o)=>{"use strict";o.d(t,{u0:()=>g,$m:()=>v});var n=o(11527),i=o(81294),s=o.n(i),r=o(50733);class l{constructor(e){this._rpc=e,this._subscribedTables=new Set}subscribeTable(e){return this._subscribedTables.add(e),Promise.resolve()}unsubscribeTable(e){return this._subscribedTables.delete(e),Promise.resolve()}process(e){const t=e[1];if(!this._subscribedTables.has(t))return Promise.resolve();switch(e[0]){case"RemoveTable":this._subscribedTables.delete(t);break;case"RenameTable":this._subscribedTables.delete(t),this._subscribedTables.add(e[2])}return this._rpc.postMessage({type:"docAction",action:e})}}var a=o(55688),c=o(63678),d=o(36322);const u="_grist_api";var p=o(18975),h=o(45353),m=o(88438);const f=(0,n.get)("document","window");class g extends a.H6{constructor(e,t,o,n="",i=console,s=(0,a.GO)(i,`PLUGIN ${e.definition.id} SafeBrowser:`)){super(e.definition.manifest,s),this._plugin=e,this._clientScope=t,this._untrustedContentOrigin=o,this._mainPath=n,this._baseLogger=i,this._viewProcesses=new Map,this._viewCount=0,this._pluginId=e.definition.id,this._pluginRpc=e.rpc}static createWorker(e,t,o){return new y(e,t,o)}static createView(e,t,o){return f.window.isRunningUnderElectron?new w(e,t,o):new _(e,t,o)}createViewProcess(e){return this._createViewProcess(e)[0]}receiveAction(e){for(const t of this._viewProcesses.values())t.receiveAction(e)}async renderImpl(e,t,o){const[n,i]=this._createViewProcess(e);return this._plugin.getRenderTarget(t,o)(n.element),this._mainProcess&&this._mainProcess.autoDispose(n),i}async disposeImpl(e){const t=this._viewProcesses.get(e);t&&(this._viewProcesses.delete(e),t.dispose())}doForwardCall(e){if(this._mainProcess)return this._mainProcess.rpc.forwardCall(e);throw new Error("Using SafeBrowser as an IForwarder requires a main script")}doForwardMessage(e){if(this._mainProcess)return this._mainProcess.rpc.forwardMessage(e);throw new Error("Using SafeBrowser as an IForwarder requires a main script")}async activateImplementation(){if(this._mainPath){const e=this._createRpc(this._mainPath),t=`plugins/${this._pluginId}/${this._mainPath}`;this._mainProcess=g.createWorker(this,e,t)}}async deactivateImplementation(){this._mainProcess&&this._mainProcess.dispose()}_createViewProcess(e){const t=this._createRpc(e),o=`${this._untrustedContentOrigin}/plugins/${this._plugin.definition.id}/${e}?host=${f.window.location.origin}`,n=this._viewCount++,i=g.createView(this,t,o);return this._viewProcesses.set(n,i),this._pluginRpc.registerForwarder(e,t),i.autoDisposeCallback((()=>{this._pluginRpc.unregisterForwarder(e),this._viewProcesses.delete(n)})),[i,n]}_createRpc(e){const t=new h.Rpc({logger:(0,a.GO)(this._baseLogger,`PLUGIN ${this._pluginId}/${e} SafeBrowser:`)});return t.queueOutgoingUntilReadyMessage(),(0,a.$o)(t,3e3,"Plugin isn't ready; be sure to call grist.ready() from plugin"),t.registerForwarder("*",this._pluginRpc),this._clientScope.servePlugin(this._pluginId,t),t}}class b extends m.Disposable{create(e,t,o){this.rpc=t,this._safeBrowser=e,this._src=o,this._actionRouter=new l(this.rpc);const n={subscribe:(0,c.n)(this._actionRouter.subscribeTable,this._actionRouter),unsubscribe:(0,c.n)(this._actionRouter.unsubscribeTable,this._actionRouter),render:(0,c.n)(this._safeBrowser.renderImpl,this._safeBrowser),dispose:(0,c.n)(this._safeBrowser.disposeImpl,this._safeBrowser)};t.registerImpl(u,n,p.C4.GristAPI),this.autoDisposeCallback((()=>{this.rpc.unregisterImpl(u)}))}receiveAction(e){this._actionRouter.process(e).catch((e=>console.warn("ClientProcess[%s] receiveAction: failed with %s",this._src,e)))}}class y extends b{create(e,t,o){super.create(e,t,o);const n=new Worker((0,d.getOriginUrl)(`/${o}`));n.addEventListener("message",(e=>this.rpc.receiveMessage(e.data))),this.rpc.setSendMessage(n.postMessage.bind(n)),this.autoDisposeCallback((()=>n.terminate()))}}class v extends b{}class _ extends v{create(e,t,o){super.create(e,t,o);const n=this.element=this.autoDispose(s()("iframe.safe_browser_process.clipboard_focus",{src:o})),i=e=>{e.source===n.contentWindow&&this.rpc.receiveMessage(e.data)};f.window.addEventListener("message",i),this.autoDisposeCallback((()=>{f.window.removeEventListener("message",i)})),this.rpc.setSendMessage((e=>n.contentWindow.postMessage(e,"*")))}}class w extends v{create(e,t,o){super.create(e,t,o);const n=this.element=this.autoDispose(s()("webview.safe_browser_process.clipboard_focus",{src:o,allowpopups:"",partition:"plugins"}));r.setPaused(!0),this.autoDisposeCallback((()=>r.setPaused(!1))),n.addEventListener("ipc-message",(e=>{"grist"===e.channel&&t.receiveMessage(e.args[0])})),this.rpc.setSendMessage((e=>n.send("grist",e)))}}},64982:(e,t,o)=>{"use strict";o.d(t,{T:()=>x,c:()=>F});var n,i=o(65106),s=o(6632),r=o(29922),l=o(7454),a=o(65552),c=o(18099),d=Object.defineProperty,u=Object.defineProperties,p=Object.getOwnPropertyDescriptors,h=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,g=(e,t,o)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,b=(e,t)=>{for(var o in t||(t={}))m.call(t,o)&&g(e,o,t[o]);if(h)for(var o of h(t))f.call(t,o)&&g(e,o,t[o]);return e},y=(e,t)=>u(e,p(t));const v={previous:"ArrowLeft",next:"ArrowRight"};class _{constructor(e){this.token=e}}class w{constructor(e,t){this.redo=e,this.undo=t}}class x extends c.Disposable{constructor(e){var t;super(),this._options=e,this._acHolder=c.Holder.create(this),this._tokens=this.autoDispose((0,c.obsArray)()),this._selection=c.Observable.create(this,new Set),this._selectionAnchor=null,this._undoStack=[],this._undoIndex=0,this._inUndoRedo=!1,this._variant=null!=(n=this._options.variant)?n:"horizontal";const o=this._addSelectedItem.bind(this),s=this._openAutocomplete.bind(this);this._acOptions=e.acOptions&&y(b({},e.acOptions),{onClick:o}),this.setTokens(e.initialValue),this.tokensObs=this.autoDispose((0,c.computedArray)(this._tokens,(e=>e.token))),this._keyBindings=b(b({},v),e.keyBindings),this.autoDispose(this._tokens.addListener(this._recordUndo.bind(this))),this._styles=b(b({},F),e.styles);const{cssTokenField:l,cssToken:a,cssInputWrapper:d,cssTokenInput:u,cssDeleteButton:p,cssDeleteIcon:h}=this._styles;function m(e){e.stopPropagation(),e.preventDefault()}this._rootElem=l({tabIndex:"-1"},c.dom.forEach(this._tokens,(t=>a(this._options.renderToken(t.token),c.dom.cls("selected",(e=>e(this._selection).has(t))),e.readonly?null:[p(c.dom.on("mousedown",(e=>e.stopPropagation())),h("CrossSmall"),(0,r.testId)("tokenfield-delete")),c.dom.on("click",(e=>this._onTokenClick(e,t))),c.dom.on("mousedown",(e=>this._onMouseDown(e,t)))],(0,r.testId)("tokenfield-token")))),d(this._textInput=u(c.dom.boolAttr("readonly",null!=(t=this._options.readonly)&&t),c.dom.on("focus",this._onInputFocus.bind(this)),c.dom.on("blur",(()=>{this._acHolder.clear()})),this._acOptions?c.dom.on("click",(()=>this._acHolder.isEmpty()?s():this._acHolder.clear())):null,c.dom.onKeyDown({Escape$:e=>{this._acHolder.clear()},Enter$:e=>o()&&m(e),ArrowDown$:s,Tab$:e=>o()&&m(e)}),c.dom.on("input",s),(0,r.testId)("tokenfield-input"))),c.dom.onKeyDown({a$:this._maybeSelectAllTokens.bind(this),Backspace$:this._maybeBackspace.bind(this),Delete$:this._maybeDelete.bind(this),[this._keyBindings.previous+"$"]:e=>this._maybeAdvance(e,-1),[this._keyBindings.next+"$"]:e=>this._maybeAdvance(e,1),z$:e=>{e[(0,i.lJ)()]&&(e.shiftKey?this._redo(e):this._undo(e))},y$:e=>{e.ctrlKey&&!e.shiftKey&&this._redo(e)}}),this._hiddenInput=R({type:"text",tabIndex:"-1"},c.dom.on("blur",(e=>{e.relatedTarget&&e.relatedTarget!==this._rootElem&&(this._selectionAnchor=null,this._selection.set(new Set))}))),c.dom.on("focus",(()=>this._hiddenInput.focus({preventScroll:!0}))),c.dom.on("copy",this._onCopyEvent.bind(this)),c.dom.on("cut",this._onCutEvent.bind(this)),c.dom.on("paste",this._onPasteEvent.bind(this)),(0,r.testId)("tokenfield"))}static ctor(){return this}attach(e){e.appendChild(this._rootElem)}getRootElem(){return this._rootElem}getTextInput(){return this._textInput}getTextInputValue(){return this._options.trimLabels?this._textInput.value.trim():this._textInput.value}getHiddenInput(){return this._hiddenInput}getAutocomplete(){return this._acHolder.get()}setTokens(e){const t=this._maybeTrimTokens(e);this._tokens.set(t.map((e=>new _(e))))}replaceToken(e,t){const o=this._tokens.get().findIndex((t=>t.token.label===e));-1!==o&&this._tokens.splice(o,1,new _(t))}_openAutocomplete(){this._options.readonly||this._acOptions&&this._acHolder.isEmpty()&&s.Autocomplete.create(this._acHolder,this._textInput,this._acOptions)}_addSelectedItem(){var e;let t=null==(e=this._acHolder.get())?void 0:e.getSelectedItem();const o=this.getTextInputValue();return!t&&this._options.createToken&&o&&(t=this._options.createToken(o)),!!t&&(this._tokens.push(new _(t)),this._textInput.value="",this._acHolder.clear(),!0)}_onInputFocus(){this._selectionAnchor=null,this._selection.set(new Set),this._options.openAutocompleteOnFocus&&this._openAutocomplete()}_onTokenClick(e,t){const o=this._tokens.get().indexOf(t);if(!(o<0)){if(e.target&&e.target.matches("."+this._styles.cssDeleteIcon.className))this._tokens.splice(o,1);else{const n=this._selectionAnchor?this._tokens.get().indexOf(this._selectionAnchor):-1;if(e.shiftKey&&n>=0){const[e,t]=n<=o?[n,o]:[o,n];this._selection.set(new Set(this._tokens.get().slice(e,t+1)))}else e[(0,i.lJ)()]&&n>=0?this._toggleTokenSelection(t):this._resetTokenSelection(t)}this._setFocus()}}_maybeSelectAllTokens(e){if(e[(0,i.lJ)()]&&""===this._textInput.value){e.stopPropagation(),e.preventDefault();const t=this._tokens.get();this._selection.set(new Set(t)),this._selectionAnchor=t?t[0]:null,this._setFocus()}}_setFocus(){0===this._selection.get().size?this._textInput.focus():this._hiddenInput.focus()}_maybeBackspace(e){if(""===this._textInput.value){if(e.stopPropagation(),e.preventDefault(),e.repeat)return;0===this._selection.get().size?this._tokens.pop():this._deleteTokens(this._selection.get(),-1)}}_maybeDelete(e){""===this._textInput.value&&this._selection.get().size>0&&(e.stopPropagation(),e.preventDefault(),this._deleteTokens(this._selection.get(),1))}_maybeAdvance(e,t){if(""!==this._textInput.value)return;const o=this._tokens.get(),n=this._selectionAnchor?o.indexOf(this._selectionAnchor):-1;if(e.shiftKey&&this._selection.get().size>0&&n>=0){const[i,s]=this._getSelectedIndexRange(this._selection.get());if(s<0)return;const r=o[t>0?s===n&&i<n?i:s+1:i===n&&s>n?s:i-1];r&&(e.stopPropagation(),e.preventDefault(),this._toggleTokenSelection(r),this._setFocus())}else{let n=null;this._selection.get().size>0?n=this._getNextToken(this._selection.get(),t):t<0&&o.length>0&&(n=o[o.length-1]),(n||t>0)&&(e.stopPropagation(),e.preventDefault(),this._resetTokenSelection(n),this._setFocus())}}_toggleTokenSelection(e){const t=this._selection.get();t.has(e)?t.delete(e):t.add(e),this._selection.setAndTrigger(t)}_resetTokenSelection(e){this._selectionAnchor=e,this._selection.set(e?new Set([e]):new Set)}_deleteTokens(e,t){if(0===this._selection.get().size)return;const o=t?this._getNextToken(e,t):null;this._tokens.set(this._tokens.get().filter((t=>!e.has(t)))),this._resetTokenSelection(o),this._setFocus()}_getNextToken(e,t){const[o,n]=this._getSelectedIndexRange(e);return n<0?null:this._tokens.get()[t>0?n+1:o-1]||null}_getSelectedIndexRange(e){const t=this._tokens.get();let o=-1,n=-1;for(let i=0;i<t.length;i++)e.has(t[i])&&(-1===o&&(o=i),n=i);return[o,n]}_onCopyEvent(e){if(!e.clipboardData||!this._selection.get().size)return!1;e.preventDefault();const t=this._selection.get(),o=this._tokens.get().filter((e=>t.has(e)));if(this._options.tokensToClipboard)this._options.tokensToClipboard(o.map((e=>e.token)),e.clipboardData);else{const t=o.map((e=>e.token.label));e.clipboardData.setData("text/plain",(0,a.cw)(t,{prettier:!0}))}return!0}_onCutEvent(e){this._onCopyEvent(e)&&this._deleteTokens(this._selection.get(),0)}_onPasteEvent(e){if(!e.clipboardData)return;let t;if(e.preventDefault(),this._options.clipboardToTokens)t=this._options.clipboardToTokens(e.clipboardData);else{const o=e.clipboardData.getData("text/plain");t=(0,a._0)(o).map((e=>this._options.createToken(e))).filter((e=>Boolean(e)))}if(!t.length)return;t=this._maybeTrimTokens(t),t=this._getNonEmptyTokens(t);const o=t.map((e=>new _(e)));this._combineUndo((()=>{this._deleteTokens(this._selection.get(),1);const e=this._selectionAnchor?this._tokens.get().indexOf(this._selectionAnchor):-1;e>=0?(this._tokens.splice(e,0,...o),this._selectionAnchor=o[0],this._selection.set(new Set(o))):(this._tokens.push(...o),this._resetTokenSelection(null))})),this._setFocus()}_onMouseDown(e,t){const o=e.clientX,n=e.clientY,i=`.${this._styles.cssToken.className}, .${this._styles.cssInputWrapper.className}`,s="horizontal"===this._variant?I:T;let r,l,a,d=!1;const u=c.dom.onElem(document,"mousemove",(e=>{d||(d=!0,this._selection.get().has(t)||this._resetTokenSelection(t),this._rootElem.classList.add("token-dragactive"),r=Array.prototype.filter.call(this._rootElem.children,(e=>e.matches(i))),r.forEach((e=>e.classList.add(s.className))),l=r.filter((e=>e.matches(".selected"))),l.forEach((e=>e.classList.add("token-dragging"))),a=r.find((e=>e.previousElementSibling===l[l.length-1])),null==a||a.classList.add(s.className+"-next"),null==a||a.style.setProperty("--count",String(l.length)));const c=`translate(${e.clientX-o}px, ${e.clientY-n}px)`;l.forEach((e=>{e.style.transform=c}))}),{useCapture:!0}),p=c.dom.onElem(document,"mouseup",(e=>{if(u.dispose(),p.dispose(),!d)return;this._rootElem.classList.remove("token-dragactive"),r.forEach((e=>e.classList.remove(s.className))),l.forEach((e=>e.classList.remove("token-dragging"))),l.forEach((e=>{e.style.transform=""})),null==a||a.classList.remove(s.className+"-next");const t=r.findIndex((t=>t.contains(e.target)));if(t<0)return;const o=this._tokens.get()[t],n=this._selection.get();if(n.has(o))return;const i=this._tokens.get().filter((e=>n.has(e)));i.length&&this._combineUndo((()=>{this._deleteTokens(n,0);const e=o?this._tokens.get().indexOf(o):this._tokens.get().length;this._tokens.splice(e,0,...i),this._selectionAnchor=i[0],this._selection.set(new Set(i))}))}),{useCapture:!0})}_recordUndo(e,t,o){if(this._inUndoRedo)return;const n=o||{start:0,numAdded:e.length,deleted:[...t]},i=e.slice(n.start,n.start+n.numAdded);this._undoIndex=Math.min(this._undoIndex+1,this._undoStack.length),this._undoStack.splice(this._undoIndex,this._undoStack.length,new w((()=>this._tokens.splice(n.start,n.deleted.length,...i)),(()=>this._tokens.splice(n.start,n.numAdded,...n.deleted))))}_combineUndo(e){const t=this._undoIndex+1;try{e()}finally{if(this._undoStack.length>t+1){const e=this._undoStack.slice(t),o=()=>e.forEach((e=>e.redo())),n=()=>e.slice().reverse().forEach((e=>e.undo()));this._undoIndex=t,this._undoStack.splice(this._undoIndex,e.length,new w(o,n))}}}_undo(e){if(""===this._textInput.value&&this._undoIndex>=0&&this._undoIndex<this._undoStack.length){e.stopPropagation(),e.preventDefault(),this._inUndoRedo=!0;try{this._undoStack[this._undoIndex].undo(),this._undoIndex--}finally{this._inUndoRedo=!1}}}_redo(e){if(this._undoIndex+1<this._undoStack.length){e.stopPropagation(),e.preventDefault(),this._inUndoRedo=!0;try{this._undoIndex+=1,this._undoStack[this._undoIndex].redo()}finally{this._inUndoRedo=!1}}}_maybeTrimTokens(e){return this._options.trimLabels?e.map((e=>y(b({},e),{label:e.label.trim()}))):e}_getNonEmptyTokens(e){return e.filter((e=>""!==e.label))}}const C=(0,c.styled)("div",`\n  display: flex;\n  border: 1px solid ${r.colors.darkGrey};\n  border-radius: 3px;\n  padding: 0 4px;\n  line-height: 16px;\n\n  &.token-dragactive {\n    cursor: grabbing;\n  }\n`),D=(0,c.styled)("div",`\n  position: relative;\n  flex: none;\n  border-radius: 3px;\n  background-color: ${r.colors.mediumGreyOpaque};\n  padding: 4px;\n  margin: 3px 2px;\n  user-select: none;\n  cursor: grab;\n\n  &.selected {\n    background-color: ${r.colors.darkGrey};\n  }\n  &.token-dragging {\n    pointer-events: none;\n    z-index: 1;\n    opacity: 0.7;\n  }\n  .${C.className}.token-dragactive & {\n    cursor: unset;\n  }\n`),k=(0,c.styled)("div","\n  position: relative;\n  flex: auto;\n  margin: 3px 2px;\n  display: flex;\n"),S=(0,c.styled)("input",`\n  color: ${r.theme.cellEditorFg};\n  background-color: ${r.theme.cellEditorBg};\n  flex: auto;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n  padding: 0;\n  border: none;\n  outline: none;\n  line-height: inherit;\n`),I=(0,c.styled)("div",`\n  &::before {\n    content: "";\n    position: absolute;\n    left: -8px;\n    right: 50%;\n    top: 0px;\n    bottom: 0px;\n  }\n  &:hover {\n    transform: translateX(2px);\n  }\n  &:hover::after {\n    content: "";\n    position: absolute;\n    background-color: ${r.colors.lightGreen};\n    width: 2px;\n    top: 0px;\n    bottom: 0px;\n    left: -4px;\n  }\n`),T=(0,c.styled)("div",`\n  /* This pseudo-element prevents small, flickering height changes when\n   * dragging the selection over targets. */\n  &::before {\n    content: "";\n    position: absolute;\n    top: -8px;\n    bottom: 0px;\n    left: 0px;\n    right: 0px;\n  }\n  &-next::before {\n    /* 27.75px is the height of a token. */\n    top: calc(-27.75px * var(--count, 1) - 8px);\n  }\n  &:hover {\n    transform: translateY(4px);\n    margin-bottom: 8px;\n  }\n  &:hover::after {\n    content: "";\n    position: absolute;\n    background-color: ${r.colors.lightGreen};\n    height: 2px;\n    top: -5px;\n    bottom: 0px;\n    left: 0px;\n    right: 0px;\n  }\n`),R=(0,c.styled)("input","\n  left: -10000px;\n  width: 1px;\n  position: absolute;\n"),F={cssTokenField:C,cssToken:D,cssInputWrapper:k,cssTokenInput:S,cssDeleteButton:(0,c.styled)("div",`\n  display: inline;\n  margin-left: 4px;\n  vertical-align: bottom;\n  line-height: 1;\n  cursor: pointer;\n  .${C.className}.token-dragactive & {\n    cursor: unset;\n  }\n`),cssDeleteIcon:(0,c.styled)(l.icon,`\n  --icon-color: ${r.colors.slate};\n  &:hover {\n    --icon-color: ${r.colors.dark};\n  }\n`)}},6632:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Autocomplete:()=>g,attachMouseOverOnMove:()=>v,defaultPopperOptions:()=>b,findAncestorChild:()=>y});var n=o(84418),i=o(92769),s=o(18099),r=o(20106),l=o(21467),a=Object.defineProperty,c=Object.defineProperties,d=Object.getOwnPropertyDescriptors,u=Object.getOwnPropertySymbols,p=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,m=(e,t,o)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const f=o(7531);class g extends s.Disposable{constructor(e,t){var o;super(),this._triggerElem=e,this._options=t,this._selectedIndex=-1,this._selected=null,this._items=this.autoDispose((0,s.obsArray)([]));const i=_(this._menuContent=(0,l.cssMenu)({class:t.menuCssClass||""},s.dom.forEach(this._items,(e=>t.renderItem(e,this._highlightFunc))),s.dom.style("min-width",e.getBoundingClientRect().width+"px"),s.dom.on("mouseleave",(e=>this._setSelected(-1,!0))),s.dom.on("click",(e=>{this._setSelected(this._findTargetItem(e.target),!0),t.onClick&&t.onClick()}))),s.dom.on("mousedown",(e=>e.preventDefault())));this._mouseOver=v(this._menuContent,(e=>this._setSelected(this._findTargetItem(e.target),!0))),this.autoDispose((0,s.onKeyElem)(e,"keydown",{ArrowDown:()=>this._setSelected(this._getNext(1),!0),ArrowUp:()=>this._setSelected(this._getNext(-1),!0)})),this.search(),this.autoDispose(s.dom.onElem(e,"input",(()=>this.search())));var r,a;(null!=(r=e,o="string"==typeof(a=void 0===t.attach?document.body:t.attach)?r.closest(a):a||r.parentNode)?o:document.body).appendChild(i),this.onDispose((()=>{s.dom.domDispose(i),i.remove()}));const c=f({},b,t.popperOptions);this._popper=(0,n.fi)(e,i,c),this.onDispose((()=>this._popper.destroy()))}getSelectedItem(){return this._items.get()[this._selectedIndex]}search(e){this._updateChoices(this._triggerElem.value,e).catch(i.reportError)}_setSelected(e,t){const o=this._menuContent.children[e]||null,n=this._selected;if(o!==n){const e=this._options.selectedCssClass||"selected";n&&n.classList.remove(e),o&&(o.classList.add(e),o.scrollIntoView({block:"nearest"}))}this._selected=o,this._selectedIndex=o?e:-1,t&&(this._triggerElem.value=o?this._options.getItemText(this.getSelectedItem()):this._lastAsTyped)}_findTargetItem(e){const t=y(this._menuContent,e);return Array.prototype.indexOf.call(this._menuContent.children,t)}_getNext(e){const t=this._items.get().length+1,o=(this._selectedIndex+e+t)%t;return o===t-1?-1:o}async _updateChoices(e,t){this._lastAsTyped=e;const o=await this._options.search(e);let n;this._highlightFunc=o.highlightFunc,this._items.set(o.items),this._popper.forceUpdate(),this._mouseOver.reset(),n=t?t(this._items.get()):e?o.selectIndex:-1,this._setSelected(n,!1)}}const b={placement:"bottom-start",modifiers:[c(((e,t)=>{for(var o in t||(t={}))p.call(t,o)&&m(e,o,t[o]);if(u)for(var o of u(t))h.call(t,o)&&m(e,o,t[o]);return e})({},r.Z),d({options:{padding:4}})),{name:"applyMaxSize",enabled:!0,phase:"beforeWrite",requires:["maxSize"],fn({state:e}){const{height:t}=e.modifiersData.maxSize;Object.assign(e.styles.popper,{maxHeight:`${Math.max(160,t)}px`})}},{name:"computeStyles",options:{gpuAcceleration:!1}}]};function y(e,t){for(;t&&t.parentElement!==e;)t=t.parentElement;return t}function v(e,t){let o;function n(t,n){o&&o.dispose(),o=s.dom.onElem(e,t,n)}function i(){n("mousemove",((e,o)=>{n("mouseover",t),t(e,o)}))}return i(),{reset:i}}const _=(0,s.styled)("div","\n  position: absolute;\n  display: flex;\n  flex-direction: column;\n  outline: none;\n")},61217:(e,t,o)=>{"use strict";o.r(t),o.d(t,{copyToClipboard:()=>i});const n=(0,o(11527).get)("document","window");async function i(e){if(n.window.navigator&&n.window.navigator.clipboard&&n.window.navigator.clipboard.writeText)try{return void await n.window.navigator.clipboard.writeText(e)}catch(e){}const t=n.document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="absolute",t.style.left="-10000px",n.document.body.appendChild(t);const o=n.document.getSelection().rangeCount>0&&n.document.getSelection().getRangeAt(0);t.select(),n.document.execCommand("copy"),n.document.body.removeChild(t),o&&(n.document.getSelection().removeAllRanges(),n.document.getSelection().addRange(o))}},88101:(e,t,o)=>{"use strict";o.d(t,{b:()=>r});var n=o(92769),i=o(18099),s=o(2996);function r(e,t=n.reportError){const o=s.G.document.createComment("a"),r=s.G.document.createComment("b");return[o,r,n=>{let s=!1;e.then((e=>s||(0,i.replaceContent)(o,r,e))).catch(t),(0,i.onDisposeElem)(r,(()=>{s=!0}))}]}},95163:(e,t,o)=>{"use strict";o.r(t),o.d(t,{KoSaveWrapObs:()=>r,fromKoSave:()=>s});var n=o(18099);const i=new WeakMap;function s(e){return i.get(e)||i.set(e,new r(e)).get(e)}class r extends n.KoWrapObs{constructor(e){if(!("saveOnly"in e))throw new Error("fromKoSave needs a saveable observable");super(e)}set(e){this._koObs.saveOnly(e)}}},59727:(e,t,o)=>{"use strict";o.d(t,{$:()=>i});var n=o(18099);function i(e,t){return(0,n.setDisposeOwner)(e,new s(t))}class s extends n.MutableObsArray{constructor(e){super(Array.from(e.peek())),this._koSub=null,this._koSub=e.subscribe((e=>{const t=e.array.slice(e.start,e.start+e.added);this.splice(e.start,e.deleted.length,...t)}),null,"spliceChange")}dispose(){this._koSub.dispose(),super.dispose()}}},56209:(e,t,o)=>{"use strict";o.d(t,{HD:()=>c,h4:()=>r,hj:()=>l,jn:()=>a});var n=o(83277),i=o(18099),s=o(268);function r(e,t,o,r){let l=!1;const a=(0,s.G)(),c=i.Observable.create(e,function(e){const t=null==e?null:(0,n.safeJsonParse)(e,null);return r(t)?t:o}(a.getItem(t)));return c.addListener((e=>{if(l)return;const n=function(e){return e!==o&&r(e)?JSON.stringify(e):null}(e);null==n?a.removeItem(t):a.setItem(t,n)})),Object.assign(c,{pauseSaving(e){l=e}})}function l(e){return"number"==typeof e}function a(e){return"boolean"==typeof e}function c(e){return"string"==typeof e}},88480:(e,t,o)=>{"use strict";o.d(t,{L:()=>l,n:()=>i.getOptionFull});var n=o(18099),i=o(21467),s=o(6632),r=o(1370);class l extends n.Disposable{constructor(e,t,o,l={}){var u;super(),this._ctl=e,this._items=t,this._action=o,this._selectedIndex=-1;const p=l.renderItem||(e=>(0,i.getOptionFull)(e).label);this.content=(0,i.cssMenuWrap)((0,n.dom)("div",{class:r.menuCssClass+" grist-floating-menu"},i.cssMenu.cls(""),d.cls(""),null==(u=l.headerDom)?void 0:u.call(l),this._menuContent=a(n.dom.forEach(this._items,(e=>{const t=(0,i.getOptionFull)(e);return c({class:r.menuItem.className+" "+i.cssMenuItem.className},n.dom.on("click",(()=>this._doAction(t.value))),p(e),n.dom.cls("disabled",Boolean(t.disabled)),n.dom.data("itemValue",t.value))})))),n.dom.on("mouseleave",(e=>this.setSelected(-1)))),this.autoDispose(t.addListener((()=>this._update()))),this._mouseOver=(0,s.attachMouseOverOnMove)(this._menuContent,(e=>this.setSelected(this._findTargetItem(e.target)))),this._update()}listenKeys(e){this.autoDispose(n.dom.onKeyElem(e,"keydown",{Escape:()=>this._ctl.close(),ArrowDown:()=>this.setSelected(this._getNextSelectable(1)),ArrowUp:()=>this.setSelected(this._getNextSelectable(-1)),Enter:()=>this._doAction(this._getSelectedData())}))}setSelected(e){const t=this._menuContent.children[e]||null,o=this._selected;if(t!==o){const e=i.cssMenuItem.className+"-sel";o&&o.classList.remove(e),t&&(t.classList.add(e),t.scrollIntoView({block:"nearest"}))}this._selected=t,this._selectedIndex=t?e:-1}_update(){var e;null==(e=this._mouseOver)||e.reset()}_findTargetItem(e){const t=(0,s.findAncestorChild)(this._menuContent,e);return(null==t?void 0:t.classList.contains("disabled"))?-1:Array.prototype.indexOf.call(this._menuContent.children,t)}_getSelectedData(){return this._selected?n.dom.getData(this._selected,"itemValue"):null}_doAction(e){e&&this._action(e),this._ctl.close()}_getNext(e,t){const o=this._items.get().length+1,n=(e+t+o)%o;return n===o-1?-1:n}_getNextSelectable(e){var t;let o=this._getNext(this._selectedIndex,e);for(;null==(t=this._menuContent.children[o])?void 0:t.classList.contains("disabled");)o=this._getNext(o,e);return o}}const a=(0,n.styled)("ul","\n  overflow: auto;\n  list-style: none;\n  outline: none;\n  padding: 0;\n  width: 100%;\n  margin: 0;\n"),c=(0,n.styled)("li","\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  display: block;\n"),d=(0,n.styled)("div","\n  overflow: hidden;\n  display: flex;\n  flex-direction: column;\n")},52064:(e,t,o)=>{"use strict";o.r(t),o.d(t,{addToSort:()=>c,sortBy:()=>d,updatePositions:()=>u});var n=o(6870),i=o(3871),s=o(631),r=o(11579),l=o(48210);const a=o(49268);function c(e,t,o){const n=e.peek(),i=l.Sort.findColIndex(n,t);-1!==i?n.splice(i,1,t*o):n.push(t*o),e(n)}function d(e,t,o){var n;let i=e.peek();const s=null!=(n=l.Sort.findCol(i,t))?n:t;i=[l.Sort.setColDirection(s,o)],e(i)}async function u(e,t){const o=t.table.peek().tableId.peek(),l=e.getTableModel(o),c=new r.SortFunc(new n.ClientColumnGetters(l,{unversioned:!0}));c.updateSpec(t.activeDisplaySortSpec.peek());const d=i.SortedRowSet.create(null,((e,t)=>c.compare(e,t)),l.tableData);d.subscribeTo(l);const u=d.getKoArray().peek().slice(0);d.dispose();const p={[s.MANUALSORT]:a(0,u.length)};await e.docData.sendActions([["BulkUpdateRecord",o,u,p],["UpdateRecord","_grist_Views_section",t.getRowId(),{sortColRefs:"[]"}]],`Updated table ${o} row positions.`),t.activeSortJson.revert()}},15323:(e,t,o)=>{"use strict";o.r(t),o.d(t,{fieldInsertPositions:()=>u,getDocIdHash:()=>h,makeDeleteAction:()=>b,makePasteHtml:()=>m,makePasteText:()=>p,parsePasteHtml:()=>f});var n=o(11527),i=o(3534),s=o(83277),r=o(79801),l=o(18099);const a=o(13314),c=o(90445),d=(0,n.get)("document","DOMParser");function u(e,t,o=1){const n=t<e.peekLength?e.at(t).parentPos():null;return Array(o).fill(n)}function p(e,t){const o=t.rowIds.map((e=>t.columns.map((t=>t.fmtGetter(e)))));return(0,r.tsvEncode)(o)}function h(){const e=window.gristDocPageModel.currentDocId.get();return(0,i.zJ)(e)}function m(e,t,o){const n=t.rowStyle||{},i=t.colStyle||{};return(0,l.dom)("table",{border:"1",cellspacing:"0",style:"white-space: pre","data-grist-doc-id-hash":h()},(0,l.dom)("colgroup",t.colIds.map(((o,n)=>(0,l.dom)("col",{style:g(i[o]),"data-grist-col-ref":String(t.colRefs[n]),"data-grist-col-type":e.getColType(o)})))),o?(0,l.dom)("tr",t.colIds.map((e=>(0,l.dom)("th",e)))):null,t.rowIds.map((e=>(0,l.dom)("tr",{style:g(n[e])},t.columns.map((t=>{const o=t.rawGetter(e),n=t.fmtGetter(e),i=o===n?{}:{"data-grist-raw-value":JSON.stringify(o)};return(0,l.dom)("td",i,n)})))))).outerHTML}function f(e){const t=(new d.DOMParser).parseFromString(e,"text/html").querySelector("table"),o=t.getAttribute("data-grist-doc-id-hash"),n=[...t.querySelectorAll("col")],i=[...t.querySelectorAll("tr")].map((e=>Array.from(e.querySelectorAll("td, th"),((e,t)=>{const i=n[t],r=null==i?void 0:i.getAttribute("data-grist-col-type"),l=i&&Number(i.getAttribute("data-grist-col-ref")),a={displayValue:e.textContent,docIdHash:o,colType:r,colRef:l};return e.hasAttribute("data-grist-raw-value")&&(a.rawValue=(0,s.safeJsonParse)(e.getAttribute("data-grist-raw-value"),a.displayValue)),a})))).filter((e=>e.length>0));if(0===i.length)throw new Error("Unable to parse data from text/html");return i}function g(e){return a(e,((e,t)=>`${t}: ${e};`)).join(" ")}function b(e){const t=e.rowIds.filter((e=>"number"==typeof e));if(0===t.length)return null;const o=t.map((()=>"")),n=e.fields.filter((e=>!e.column().isRealFormula()&&!e.disableEditData())).map((e=>e.colId())),i=e.fields[0].column().table().tableId();return 0===n.length?null:["BulkUpdateRecord",i,t,c(n,n.map((()=>o)))]}},80864:(e,t,o)=>{"use strict";o.r(t),o.d(t,{setTestState:()=>i});const n=(0,o(11527).get)("window");function i(e){"testGrist"in n.window||(n.window.testGrist={}),Object.assign(n.window.testGrist,e)}},3534:(e,t,o)=>{"use strict";o.d(t,{rq:()=>i,zJ:()=>r});const n=/(https?:\/\/[A-Za-z\d][A-Za-z\d-.]*(?!\.)(?::\d+)?(?:\/[^\s]*)?[\w\d/])/;function i(e){return e?e.split(n).map(((e,t)=>({value:e,isLink:t%2==1}))):[{value:e,isLink:!1}]}function s(e){let t=2166136261;for(let o=0;o<e.length;o++)t^=e.charCodeAt(o),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return("0000000"+(t>>>0).toString(16)).substr(-8)}function r(e){let t="";for(let o=0;o<4;o++)t+=s(t+e);return t}},56634:(e,t,o)=>{"use strict";o.d(t,{O8:()=>d,QK:()=>h,c5:()=>m,lX:()=>u,IL:()=>p});var n=o(92769),i=o(86391),s=o(83277),r=o(36322),l=o(6015);const a=o(78870),c=o(82238),d=[".grist",".csv",".tsv",".txt",".xlsx",".xlsm"];async function u(e,t=a){t(0);let o=null;const n=window.electronSelectFiles;if("function"==typeof n)o=await n(function(e){const t={filters:[],properties:["openFile"]};if(e.extensions){const o=e.extensions.map((e=>c(e,".")));t.filters.push({name:"Select files",extensions:o})}return e.multiple&&t.properties.push("multiSelections"),t}(e));else{const n=await(0,i.y)(function(e){const t={};return e.multiple&&(t.multiple=e.multiple),e.extensions&&(t.accept=e.extensions.join(",")),t}(e));o=await p(n,e,t)}return t(100),o}async function p(e,t,o=a){if(!e.length)return null;const i=new FormData;for(const t of e)i.append("upload",t);const l=window.gristConfig||{},{maxUploadSizeImport:c,maxUploadSizeAttachment:d}=l;if("import"===t.sizeLimit&&c){if(e.reduce(((e,t)=>e+(t.name.endsWith(".grist")?0:t.size)),0)>c)throw new n.UserError(`Imported files may not exceed ${(0,s.byteString)(c)}`)}else if("attachment"===t.sizeLimit&&d&&e.some((e=>e.size>d)))throw new n.UserError(`Attachments may not exceed ${(0,s.byteString)(d)}`);return new Promise(((e,l)=>{const a=new XMLHttpRequest;a.open("post",(0,r.docUrl)(t.docWorkerUrl,"uploads"),!0),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.withCredentials=!0,a.upload.addEventListener("progress",(e=>{e.lengthComputable&&o(e.loaded/e.total*100)})),a.addEventListener("error",(e=>{console.warn("Upload error",e),l(new Error("Upload error"))})),a.addEventListener("load",(()=>{if(200!==a.status){console.warn("Upload failed",a.status,a.responseText);const e=(0,s.safeJsonParse)(a.responseText,null);l(new n.UserError("Upload failed: "+(e&&e.error||a.status)))}else e(JSON.parse(a.responseText))})),a.send(i)}))}async function h(e,t,o,n=a){if(m(t))return e.fetchURL(t,o);let i;try{i=await window.fetch(t)}catch(n){return console.log(`Could not fetch ${t} on the Client, falling back to server fetch: ${n.message}`),e.fetchURL(t,o)}const s=(0,l.basename)(t),r=i.headers.get("content-type"),c=r?{type:r}:{},d=new File([await i.blob()],s,c);return await p([d],{docWorkerUrl:e.docWorkerUrl},n)}function m(e){return e?!!/^https:\/\/(docs|drive).google.com\/(spreadsheets|file)\/d\/([^/]*)/i.exec(e):null}},6870:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ClientColumnGetters:()=>r});var n=o(631),i=o(11579),s=o(48210);class r{constructor(e,t={}){this._tableModel=e,this._options=t}getColGetter(e){var t;const o=this._tableModel.docModel.columns.getRowModel(s.Sort.getColRef(e)),r=o.colId();let l=this._tableModel.tableData.getRowPropFunc(r);if(!l)return null;if(this._options.unversioned&&this._tableModel.tableData.mayHaveVersions()){const e=l;l=t=>{const o=e(t);if(o&&n.isVersions(o)){const e=o[1];return"parent"in e?e.parent:"local"in e?e.local:e.remote}return o}}if(s.Sort.specToDetails(e).orderByChoice&&"Choice"===o.pureType()){const e=(null==(t=o.widgetOptionsJson.peek())?void 0:t.choices)||[];l=(0,i.choiceGetter)(l,e)}return l}getManualSortGetter(){const e=this._tableModel.tableMetaRow.columns().peek().find((e=>e.colId()===n.MANUALSORT));return e?this.getColGetter(e.getRowId()):null}}},45051:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ALL_INCLUSIVE_FILTER_JSON:()=>c,ColumnFilter:()=>a,NEW_FILTER_JSON:()=>d});var n=o(91655),i=o(34903),s=o(75083),r=o(83277),l=o(18099);class a extends l.Disposable{constructor(e,t="",o="",n=[]){super(),this._initialFilterJson=e,this._columnType=t,this.visibleColumnType=o,this._allValues=n,this.min=l.Observable.create(this,void 0),this.max=l.Observable.create(this,void 0),this.filterFunc=l.Observable.create(this,(()=>!0)),this.isInclusionFilter=l.Computed.create(this,this.filterFunc,(()=>this._include)),this.state=l.Computed.create(this,this.filterFunc,(()=>this._getState())),this.isRange=l.Computed.create(this,this.filterFunc,(()=>this._isRange())),this.setState(e),this.autoDispose(this.min.addListener((()=>this._updateState()))),this.autoDispose(this.max.addListener((()=>this._updateState())))}get columnType(){return this._columnType}get initialFilterJson(){return this._initialFilterJson}setState(e){const t=(0,i.nR)(e);(0,i.xX)(t)?(this.min.set(t.min),this.max.set(t.max),this._include=!1,this._values=new Set):(this.min.set(void 0),this.max.set(void 0),this._include=t.include,this._values=t.values),this._updateState()}includes(e){return this.filterFunc.get()(e)}add(e){this.addMany([e])}addMany(e){this._toValues();for(const t of e)this._include?this._values.add(t):this._values.delete(t);this._updateState()}delete(e){this.deleteMany([e])}deleteMany(e){this._toValues();for(const t of e)this._include?this._values.delete(t):this._values.add(t);this._updateState()}clear(){this._values.clear(),this._include=!0,this._updateState()}selectAll(){this._values.clear(),this._include=!1,this._updateState()}makeFilterJson(){let e;if(void 0!==this.min.get()||void 0!==this.max.get())e={min:this.min.get(),max:this.max.get()};else{const t=Array.from(this._values).sort(r.nativeCompare);e={[this._include?"included":"excluded"]:t}}return JSON.stringify(e)}hasChanged(){return this.makeFilterJson()!==this._initialFilterJson}getBoundsValue(e){const t=this[e].get();return void 0===t?"min"===e?-1/0:1/0:(0,i.CV)(t)?(0,s.ZW)(t):t}_updateState(){this.filterFunc.set((0,n.o)(this._getState(),this._columnType))}_getState(){return{include:this._include,values:this._values,min:this.min.get(),max:this.max.get()}}_isRange(){return(0,i.xX)(this._getState())}_toValues(){if(this._isRange()){const e=this.filterFunc.get(),t=this._include?{included:this._allValues.filter((t=>e(t)))}:{excluded:this._allValues.filter((t=>!e(t)))};this.setState(t)}}}const c='{"excluded":[]}',d="{}"},82882:(e,t,o)=>{"use strict";o.d(t,{V:()=>i});var n=o(49142);class i{constructor(e){var t,o,i,s,r,l,a;this.name="string"==typeof e?e:e.name,this.title="string"==typeof e?e:null!=(t=e.title)?t:e.name,this.description="string"==typeof e?"":null!=(o=e.description)?o:"",this.optional="string"!=typeof e&&null!=(i=e.optional)&&i,this.type="string"==typeof e?"Any":null!=(s=e.type)?s:"Any",this.typeDesc=String(null!=(l=null==(r=n.UD[this.type])?void 0:r.label)?l:"any").toLowerCase(),this.allowMultiple="string"!=typeof e&&null!=(a=e.allowMultiple)&&a}canByMapped(e){return e===this.type||"Any"===e||"Any"===this.type}}},92517:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DataRowModel:()=>l});var n=o(33620),i=o(55424),s=o.n(i),r=o(29301);class l extends(s()){constructor(e,t){super(e,t),this.cells=this;const o=e.tableMetaRow.validations;this._isAddRow=r.observable(!1),this._isRealChange=r.observable(!0),this._validationFailures=this.autoDispose(r.pureComputed((()=>o().all().filter((e=>!this.cells[this.getValidationNameFromId(e.id())]())))))}getValidationNameFromId(e){return"validation___"+e}async updateColValues(e){const t=this._isAddRow.peek()?["AddRecord",null,e]:["UpdateRecord",this._rowId,e];try{return await this._table.sendTableAction(t)}finally{Object.keys(e).forEach((e=>this._assignColumn(e)))}}assign(e){this._rowId=e,this._isAddRow("new"===e),this._isRealChange(!1),setTimeout((()=>this.isDisposed()||this._isRealChange(!0)),0),null!==this._rowId&&this._fields.forEach((e=>this._assignColumn(e)))}_assignColumn(e){if(!this.isDisposed()&&this.hasOwnProperty(e)){const t="new"!==this._rowId&&this._rowId?this._table.tableData.getValue(this._rowId,e):"";n.withKoUtils(this.cells[e]).assign(t)}}}},89971:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DataTableModelWithDiff:()=>c,ExtraRows:()=>a,TableDataWithDiff:()=>d});var n=o(41367),i=o.n(n),s=o(549),r=o(9072),l=o(6263);class a{constructor(e,t){var o,n,i,s,r,l,a,c;this.tableId=e,this.comparison=t;const d=h(e,t);this.leftTableDelta=null==(n=null==(o=this.comparison)?void 0:o.leftChanges)?void 0:n.tableDeltas[e],d&&(this.rightTableDelta=null==(s=null==(i=this.comparison)?void 0:i.rightChanges)?void 0:s.tableDeltas[d]),this.rightAddRows=new Set(null==(r=this.rightTableDelta)?void 0:r.addRows.map((e=>2*-e-1))),this.rightRemoveRows=new Set(null==(l=this.rightTableDelta)?void 0:l.removeRows),this.leftAddRows=new Set(null==(a=this.leftTableDelta)?void 0:a.addRows),this.leftRemoveRows=new Set(null==(c=this.leftTableDelta)?void 0:c.removeRows.map((e=>2*-e-2)))}static interpretRowId(e){return e>=0?{type:"shared",id:e}:-1===e?{type:"skipped",id:e}:e%2!=0?{type:"remote-add",id:-(e+1)/2}:{type:"local-remove",id:-(e+2)/2}}getExtraRows(){return[...this.rightAddRows].concat([...this.leftRemoveRows])}getRowType(e){return this.rightAddRows.has(e)?"remote-add":this.leftAddRows.has(e)?"local-add":this.rightRemoveRows.has(e)?"remote-remove":this.leftRemoveRows.has(e)?"local-remove":""}}class c extends r.G{constructor(e,t){super(),this.core=e,this.tableMetaRow=e.tableMetaRow,this.tableQuerySets=e.tableQuerySets,this.docModel=e.docModel;const o=e.tableData.tableId,n=h(o,t)||"";this.tableData=new d(e.tableData,t.leftChanges.tableDeltas[o]||(0,s.dB)(),t.rightChanges.tableDeltas[n]||(0,s.dB)()),this.isLoaded=e.isLoaded,this._wrappedModel=new(i())(this.docModel,this.tableData,this.tableMetaRow)}createLazyRowsModel(e,t){return this._wrappedModel.createLazyRowsModel(e,t)}createFloatingRowModel(e){return this._wrappedModel.createFloatingRowModel(e)}fetch(e){return this.core.fetch(e)}getAllRows(){return this.core.getAllRows()}getNumRows(){return this.core.getNumRows()}getRowGrouping(e){return this.core.getRowGrouping(e)}sendTableActions(e,t){return this.core.sendTableActions(e,t)}sendTableAction(e,t){return this.core.sendTableAction(e,t)}}class d{constructor(e,t,o){this.core=e,this.leftTableDelta=t,this.rightTableDelta=o,this.dataLoadedEmitter=e.dataLoadedEmitter,this.tableActionEmitter=e.tableActionEmitter,this._leftRemovals=new Set(t.removeRows),this._rightRemovals=new Set(o.removeRows),this._updates=new Set([...t.updateRows.filter((e=>!this._rightRemovals.has(e))),...o.updateRows.filter((e=>!this._leftRemovals.has(e)))])}getColIds(){return this.core.getColIds()}sendTableActions(e,t){return this.core.sendTableActions(e,t)}sendTableAction(e,t){return this.core.sendTableAction(e,t)}getRowPropFunc(e){const t=this.core.getRowPropFunc(e);return t?o=>"new"!==o&&(o<0||this._updates.has(o))?this.getValue(o,e):t(o):t}getKeepFunc(){return e=>"new"===e||this._updates.has(e)||e<0||this._leftRemovals.has(e)||this._rightRemovals.has(e)}getSkipRowId(){return-1}mayHaveVersions(){return!0}getValue(e,t){var o,n,i,s;if(-1===e&&"id"!==t)return[l.w.Skip];if(this._updates.has(e)){const i=null==(o=this.leftTableDelta.columnDeltas[t])?void 0:o[e],s=null==(n=this.rightTableDelta.columnDeltas[t])?void 0:n[e];if(void 0!==i&&void 0!==s)return[l.w.Versions,{parent:u(i),local:p(i),remote:p(s)}];if(void 0!==s)return[l.w.Versions,{parent:u(s),remote:p(s)}];if(void 0!==i)return[l.w.Versions,{parent:u(i),local:p(i)}]}else{if("id"===t)return e;const{type:o,id:n}=a.interpretRowId(e);if("remote-add"===o){const e=null==(i=this.rightTableDelta.columnDeltas[t])?void 0:i[n];return void 0!==e?p(e):void 0}if("local-remove"===o){const e=null==(s=this.leftTableDelta.columnDeltas[t])?void 0:s[n];return void 0!==e?u(e):void 0}}return this.core.getValue(e,t)}get tableId(){return this.core.tableId}numRecords(){return this.core.numRecords()}}function u(e){var t;return"?"===e[0]?null:null==(t=e[0])?void 0:t[0]}function p(e){var t;return"?"===e[1]?null:null==(t=e[1])?void 0:t[0]}function h(e,t){if(!t)return e;const o=(0,s.Yo)(t.leftChanges.tableRenames,e);return(0,s.d)(t.rightChanges.tableRenames,o)}},25192:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DynamicQuerySet:()=>y,QuerySet:()=>v,QuerySetManager:()=>b,TableQuerySets:()=>_,getFilterFunc:()=>w});var n=o(3871),i=o(631),s=o(83277),r=o(8954),l=o(63678),a=o(93965),c=o(18099),d=o(29301),u=Object.defineProperty,p=Object.getOwnPropertySymbols,h=Object.prototype.hasOwnProperty,m=Object.prototype.propertyIsEnumerable,f=(e,t,o)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const g=o(88466);class b extends c.Disposable{constructor(e,t){super(),this._docModel=e,this._queryMap=this.autoDispose(new r.i({create:o=>v.create(null,e,t,o,this),dispose:(e,t)=>t.dispose(),gracePeriodMs:6e4}))}useQuerySet(e,t){const o=(n=function(e,t){var o;const n=null==(o=Object.values(e.dataTables).find((e=>e.tableData.tableId===t.tableId)))?void 0:o.tableMetaRow;if(!n)throw new Error(`Table ${t.tableId} not found`);const i={id:"id"};for(const e of n.columns.peek().peek())i[e.colId.peek()]=e.getRowId();const r=Object.keys(t.filters).map((e=>{const o=t.filters[e];return o.sort(s.nativeCompare),[i[e],t.operations[e],o]}));return r.sort(((e,t)=>(0,s.nativeCompare)(e[0],t[0])||(0,s.nativeCompare)(e[1],t[1]))),{tableRef:n.getRowId(),filterTuples:r}}(this._docModel,t),JSON.stringify([n.tableRef,n.filterTuples]));var n;const i=this._queryMap.use(o);return e.autoDispose(i),i.get()}purgeKey(e){this._queryMap.purgeKey(e)}testSetGracePeriodMs(e){return this._queryMap.testSetGracePeriodMs(e)}}class y extends n.RowSource{constructor(e,t){super(),this._querySetManager=e,this._tableModel=t,this._holder=c.Holder.create(this),this._updateQuerySetDebounced=g((0,l.n)(this._updateQuerySet,this),0)}getAllRows(){return this._querySet?this._querySet.getAllRows():[]}getNumRows(){return this._querySet?this._querySet.getNumRows():0}get isTruncated(){return!!this._querySet&&this._querySet.isTruncated}makeQuery(e,t,o){const n={tableId:this._tableModel.tableData.tableId,filters:e,operations:t},i=this._querySetManager.useQuerySet(this._holder,n);i.fetchPromise.then((()=>{this._updateQuerySetDebounced(i,o)})).catch((e=>{o(e,!1)}))}_updateQuerySet(e,t){try{if(e!==this._querySet){const t=this._querySet;this._querySet=e,t&&(this.stopListening(t,"rowChange"),this.stopListening(t,"rowNotify"),this.trigger("rowChange","remove",t.getAllRows())),this.trigger("rowChange","add",this._querySet.getAllRows()),this.listenTo(this._querySet,"rowNotify",(0,l.n)(this.trigger,this,"rowNotify")),this.listenTo(this._querySet,"rowChange",(0,l.n)(this.trigger,this,"rowChange"))}t(null,!0)}catch(e){t(e,!0)}}}class v extends n.BaseFilteredRowSource{constructor(e,t,o,n){const i=function(e){const[t,o]=JSON.parse(e);return{tableRef:t,filterTuples:o}}(o),s=function(e,t){const o=e.dataTablesByRef.get(t.tableRef).tableMetaRow,n={},i={};for(const[o,s,r]of t.filterTuples){const t="id"===o?"id":e.columns.getRowModel(o).colId.peek();n[t]=r,i[t]=s}return{tableId:o.tableId.peek(),filters:n,operations:i}}(e,i);super(w(e.docData,s)),this.isTruncated=!1;const r=this.autoDispose(function(e,t){const o=e.tables.getRowModel(t.tableRef)._isDeleted,n=t.filterTuples.map((([t,,])=>"id"===t?null:e.columns.getRowModel(t)._isDeleted));return d.computed((()=>Boolean(o()||n.some((e=>null==e?void 0:e())))))}(e,i));this.autoDispose(r.subscribe((e=>{e&&n.purgeKey(o)})));const l=e.dataTables[s.tableId],a=Object.keys(s.filters);if(a.length>0){const e=Math.floor(500/a.length);for(const t of a){const o=s.filters[t];o.length>e&&(s.filters[t]=o.slice(0,e),this.isTruncated=!0)}}let c;if(l.tableMetaRow.onDemand()){const e=l.tableQuerySets;c=t.useQuerySet(((e,t)=>{for(var o in t||(t={}))h.call(t,o)&&f(e,o,t[o]);if(p)for(var o of p(t))m.call(t,o)&&f(e,o,t[o]);return e})({limit:1e4},s)).then((o=>{o.tableData[2].length>=1e4&&(this.isTruncated=!0),this.onDispose((()=>{t.disposeQuerySet(o.querySubId).catch((e=>{console.log(`Promise rejected for disposeQuerySet: ${e.message}`)})),e.removeQuerySet(this)})),e.addQuerySet(this,o.tableData)}))}else c=l.fetch(!1);this.fetchPromise=c.then((()=>this.subscribeTo(l)))}}class _{constructor(e){this._tableData=e,this._querySets=new Set}addQuerySet(e,t){this._querySets.add(e),this._tableData.loadPartial(t)}removeQuerySet(e){this._querySets.delete(e);const t=new Set(e.getAllRows());for(const e of this._querySets)for(const o of e.getAllRows())t.delete(o);this._tableData.unloadPartial(Array.from(t))}}function w(e,t){const o=e.getTable(t.tableId),n=Object.keys(t.filters).sort().map((e=>{const n=o.getRowPropFunc(e),s=new Set(t.filters[e]);switch(t.operations[e]){case"intersects":return e=>{const t=n(e);return(0,i.isList)(t)&&(0,a.xD)(t).some((e=>s.has(e)))};case"empty":return e=>{const t=n(e);return!t||(0,i.isList)(t)&&1===t.length};case"in":return e=>s.has(n(e))}}));return e=>n.every((t=>t(e)))}},60686:(e,t,o)=>{"use strict";o.r(t),o.d(t,{SectionFilter:()=>s});var n=o(91655),i=o(18099);class s extends i.Disposable{constructor(e,t){super(),this.viewSection=e,this._tableData=t,this._openFilterOverride=i.Observable.create(this,null),this._tempRows=(0,i.obsArray)();const o=i.Computed.create(this,this._openFilterOverride,((e,t)=>{const o=t&&e(t.colFilter.filterFunc);return this._buildPlainFilterFunc((function(e,n){return(null==t?void 0:t.colRef)===e.origCol().getRowId()?o:n}),e)}));this.sectionFilterFunc=i.Computed.create(this,o,this._tempRows,((e,t,o)=>this._addRowsToFilter(t,o))),this.autoDispose(o.addListener((e=>{this._tempRows.set(this._tempRows.get().filter((t=>!e(t))))})))}setFilterOverride(e,t){this._openFilterOverride.set({colRef:e,colFilter:t}),t.onDispose((()=>{const e=this._openFilterOverride.get();e&&e.colFilter===t&&this._openFilterOverride.set(null)}))}addTemporaryRow(e){this.sectionFilterFunc.get()(e)||this._tempRows.push(e)}resetTemporaryRows(){this._tempRows.set([])}buildFilterFunc(e,t){return this._addRowsToFilter(this._buildPlainFilterFunc(e,t),this._tempRows.get())}_addRowsToFilter(e,t){return o=>t.includes(o)||"number"!=typeof o||e(o)}_buildPlainFilterFunc(e,t){const o=t(this.viewSection.filters).map((({filter:o,fieldOrColumn:i})=>{const s=(0,n.v)(t(o),t(t(i.origCol).type)),r=e(i,s),l=this._tableData.getRowPropFunc(i.colId.peek());return r&&l?function(e,t){return e&&t?o=>t(e(o)):()=>!0}(l,r):null})).filter((e=>null!==e));return e=>o.every((t=>Boolean(t&&t(e))))}}},53186:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CombinedStyle:()=>n});class n{constructor(e,t){var o,n,i,s,r,l;for(let a=0;a<e.length;a++)if(t[a]){const t=null==(o=e[a])?void 0:o.textColor,c=null==(n=e[a])?void 0:n.fillColor,d=null==(i=e[a])?void 0:i.fontBold,u=null==(s=e[a])?void 0:s.fontUnderline,p=null==(r=e[a])?void 0:r.fontItalic,h=null==(l=e[a])?void 0:l.fontStrikethrough;this.textColor=t||this.textColor,this.fillColor=c||this.fillColor,this.fontBold=d||this.fontBold,this.fontUnderline=u||this.fontUnderline,this.fontItalic=p||this.fontItalic,this.fontStrikethrough=h||this.fontStrikethrough}}}},3871:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ALL:()=>a,ArrayRowSource:()=>p,BaseFilteredRowSource:()=>f,ExtendedRowSource:()=>m,FilteredRowSource:()=>g,MappedRowSource:()=>h,RowGrouping:()=>v,RowListener:()=>u,RowSource:()=>c,RowWatcher:()=>w,SortedRowSet:()=>_});var n=o(13988),i=o.n(n),s=o(9072),r=o(83277),l=o(18099);const a=Symbol("ALL");class c extends s.G{}const d={add:"onAddRows",remove:"onRemoveRows",update:"onUpdateRows"};class u extends s.G{subscribeTo(e){this.onAddRows(e.getAllRows()),this.listenTo(e,"rowChange",((e,t)=>{this[d[e]](t)})),this.listenTo(e,"rowNotify",this.onRowNotify)}unsubscribeFrom(e){this.stopListening(e,"rowChange"),this.stopListening(e,"rowNotify"),this.onRemoveRows(e.getAllRows())}onAddRows(e){}onRemoveRows(e){}onUpdateRows(e){}onRowNotify(e,t){this.trigger("rowNotify",e,t)}}class p extends c{constructor(e){super(),this._rows=e}getAllRows(){return this._rows}getNumRows(){return this._rows.length}}class h extends c{constructor(e,t){super(),this.parentRowSource=e,this._mapperFunc=e=>t(e),this.listenTo(e,"rowChange",((e,t)=>{this.trigger("rowChange",e,Array.from(t,this._mapperFunc))})),this.listenTo(e,"rowNotify",((e,t)=>{this.trigger("rowNotify",e===a?a:Array.from(e,this._mapperFunc),t)}))}getAllRows(){return Array.from(this.parentRowSource.getAllRows(),this._mapperFunc)}getNumRows(){return this.parentRowSource.getNumRows()}}class m extends c{constructor(e,t){super(),this.parentRowSource=e,this.extras=t,this.listenTo(e,"rowChange",((e,t)=>{this.trigger("rowChange",e,t)})),this.listenTo(e,"rowNotify",((e,t)=>{this.trigger("rowNotify",e===a?a:e,t)}))}getAllRows(){return[...this.parentRowSource.getAllRows()].concat(this.extras)}getNumRows(){return this.parentRowSource.getNumRows()+this.extras.length}}class f extends u{constructor(e){super(),this._filterFunc=e,this._matchingRows=new Set}getAllRows(){return this._matchingRows.values()}getNumRows(){return this._matchingRows.size}onAddRows(e){const t=[];for(const o of e)this._filterFunc(o)?(this._matchingRows.add(o),t.push(o)):this._addExcludedRow(o);t.length>0&&this.trigger("rowChange","add",t)}onRemoveRows(e){const t=[];for(const o of e)this._matchingRows.delete(o)&&t.push(o),this._deleteExcludedRow(o);t.length>0&&this.trigger("rowChange","remove",t)}onUpdateRows(e){const t=this._updateRowsHelper({},e);t.removes&&this.trigger("rowChange","remove",t.removes),t.updates&&this.trigger("rowChange","update",t.updates),t.adds&&this.trigger("rowChange","add",t.adds)}onRowNotify(e,t){if(e===a)this.trigger("rowNotify",a,t);else{const o=[];for(const t of e)this._matchingRows.has(t)&&o.push(t);o.length>0&&this.trigger("rowNotify",o,t)}}_updateRowsHelper(e,t){for(const o of t)this._filterFunc(o)?this._matchingRows.has(o)?(e.updates||(e.updates=[])).push(o):this._deleteExcludedRow(o)&&(this._matchingRows.add(o),(e.adds||(e.adds=[])).push(o)):this._matchingRows.delete(o)&&(this._addExcludedRow(o),(e.removes||(e.removes=[])).push(o));return e}_addExcludedRow(e){}_deleteExcludedRow(e){return!0}}class g extends f{constructor(){super(...arguments),this._excludedRows=new Set}updateFilter(e){this._filterFunc=e;const t={};this._updateRowsHelper(t,this._matchingRows),this._updateRowsHelper(t,this._excludedRows),t.removes&&this.trigger("rowChange","remove",t.removes),t.adds&&this.trigger("rowChange","add",t.adds)}refilterRows(e){const t=this._updateRowsHelper({},e);t.removes&&this.trigger("rowChange","remove",t.removes),t.adds&&this.trigger("rowChange","add",t.adds)}getHiddenRows(){return this._excludedRows.values()}_addExcludedRow(e){this._excludedRows.add(e)}_deleteExcludedRow(e){return this._excludedRows.delete(e)}}class b extends c{constructor(e){super(),this.groupValue=e,this._rows=new Set}getAllRows(){return this._rows.values()}getNumRows(){return this._rows.size}_addAll(e){for(const t of e)this._rows.add(t)}_removeAll(e){for(const t of e)this._rows.delete(t)}}function y(e,t,o){let n=e.get(t);n||e.set(t,n=[]),n.push(o)}class v extends u{constructor(e){super(),this._groupFunc=e,this._rowsToValues=new Map,this._valuesToGroups=new Map,this.onDispose((()=>{for(const e of this._valuesToGroups.values())e.dispose()}))}getGroup(e){let t=this._valuesToGroups.get(e);return t||(t=new b(e),this._valuesToGroups.set(e,t)),t}onAddRows(e){const t=new Map;for(const o of e){const e=this._groupFunc(o);y(t,e,o),this._rowsToValues.set(o,e)}t.forEach(((e,t)=>{const o=this.getGroup(t);o._addAll(e),o.trigger("rowChange","add",e)}))}onRemoveRows(e){const t=new Map;for(const o of e)y(t,this._rowsToValues.get(o),o),this._rowsToValues.delete(o);t.forEach(((e,t)=>{const o=this._valuesToGroups.get(t);o._removeAll(e),o.trigger("rowChange","remove",e)}))}onUpdateRows(e){let t,o,n;for(const i of e){const e=this._rowsToValues.get(i),s=this._groupFunc(i);s===e?y(t||(t=new Map),e,i):(this._rowsToValues.set(i,s),y(o||(o=new Map),e,i),y(n||(n=new Map),s,i))}o&&o.forEach(((e,t)=>{const o=this._valuesToGroups.get(t);o._removeAll(e),o.trigger("rowChange","remove",e)})),t&&t.forEach(((e,t)=>{this._valuesToGroups.get(t).trigger("rowChange","update",e)})),n&&n.forEach(((e,t)=>{const o=this.getGroup(t);o._addAll(e),o.trigger("rowChange","add",e)}))}onRowNotify(e,t){if(e===a)for(const e of this._valuesToGroups.values())e.trigger("rowNotify",a,t);else{const o=new Map;for(const t of e)y(o,this._rowsToValues.get(t),t);o.forEach(((e,o)=>{this._valuesToGroups.get(o).trigger("rowNotify",e,t)}))}}}class _ extends u{constructor(e,t){super(),this._compareFunc=e,this._skippableRows=t,this._allRows=new Set,this._isPaused=!1,this._koArray=this.autoDispose(i()()),this._keepFunc=null==t?void 0:t.getKeepFunc()}getKoArray(){return this._koArray}pause(e){!e&&this._isPaused&&this._koArray.assign(Array.from(this._allRows).sort(this._compareFunc)),this._isPaused=Boolean(e)}updateSort(e){this._compareFunc=e,this._isPaused||this._koArray.assign(Array.from(this._koArray.peek()).sort(this._compareFunc))}onAddRows(e){for(const t of e)this._allRows.add(t);if(!this._isPaused)if(this._canChangeIncrementally(e))for(const t of e){const e=(0,r.sortedIndex)(this._koArray.peek(),t,this._compareFunc);this._koArray.splice(e,0,t)}else this._koArray.assign(this._keep(Array.from(this._allRows).sort(this._compareFunc)))}onRemoveRows(e){for(const t of e)this._allRows.delete(t);if(!this._isPaused)if(this._canChangeIncrementally(e))for(const t of e){const e=this._koArray.peek().indexOf(t);-1!==e&&this._koArray.splice(e,1)}else this._koArray.assign(this._keep(Array.from(this._allRows).sort(this._compareFunc)))}onUpdateRows(e){if(this._isPaused)return;const t=Array.from(e).sort(this._compareFunc);(function(e,t,o,n){let i=0;for(const s of o){if(!t.has(s))continue;const o=e.indexOf(s,i);if(-1===o||!x(e,o,n))return!1;i=o}return!0})(this._koArray.peek(),this._allRows,t,this._compareFunc)||(this._canChangeIncrementally(e)?(this.onRemoveRows(e),this.onAddRows(e)):this._koArray.assign(this._keep(Array.from(this._koArray.peek()).sort(this._compareFunc))))}_canChangeIncrementally(e){return!this._keepFunc&&function(e){return Array.isArray(e)&&e.length<=2}(e)}_keep(e,t=2){var o;if(!this._keepFunc)return e;const n=e.map(this._keepFunc),i=e.map((()=>!1)),s=e.length;s>=1&&(n[0]=!0),s>=2&&(n[s-1]=!0);let r=-t-1;for(let e=0;e<s;e++)n[e]?r=e:e-r<=t&&(n[e]=!0);r=s+t+1;for(let e=s-1;e>=0;e--)n[e]?r=e:r-e<=t&&(n[e]=!0);let l=!1;for(let e=0;e<s;e++)n[e]?l=!1:l||(i[e]=!0,l=!0);const a=(null==(o=this._skippableRows)?void 0:o.getSkipRowId())||0;return e.map(((e,t)=>i[t]?a:e)).filter(((e,t)=>n[t]||i[t]||"new"===e))}}class w extends u{constructor(){super(...arguments),this.rowFilter=l.Observable.create(this,(()=>!1)),this._rowCounter=new Map}clear(){this._rowCounter.clear(),this.rowFilter.set((()=>!1)),this.stopListening()}onAddRows(e){for(const t of e)this._rowCounter.set(t,(this._rowCounter.get(t)||0)+1);this.rowFilter.set((e=>{var t;return(null!=(t=this._rowCounter.get(e))?t:0)>0}))}onRemoveRows(e){for(const t of e)this._rowCounter.set(t,(this._rowCounter.get(t)||0)-1);this.rowFilter.set((e=>{var t;return(null!=(t=this._rowCounter.get(e))?t:0)>0}))}}function x(e,t,o){const n=e[t];return(0===t||o(e[t-1],n)<=0)&&(t===e.length-1||o(n,e[t+1])<=0)}},85050:(e,t,o)=>{"use strict";o.d(t,{L:()=>r,m:()=>l});var n=o(29922),i=o(30835),s=o(18099);function r(e,t,...o){const n=i.acequire("ace/ext/static_highlight"),r=i.acequire("ace/mode/python").Mode,l=i.acequire("ace/theme/chrome"),c=new r;return a((0,s.dom)("div",(o=>(0,s.subscribeElem)(o,e,(e=>{if(e){if(t.maxLines){const o=e.split(/\n/);o.length>t.maxLines&&(e=o.slice(0,t.maxLines).join("\n")+" …")}o.innerHTML=n.render(e,c,l,1,!0).html}else o.textContent=t.placeholder||""})))),...o)}o(81674),o(76832),o(17832);const l=(0,s.styled)("div",`\n  font-family: 'Monaco', 'Menlo', monospace;\n  font-size: ${n.vars.smallFontSize};\n  background-color: ${n.colors.light};\n  &[disabled], &.disabled {\n    background-color: ${n.colors.mediumGreyOpaque};\n  }\n`),a=(0,s.styled)(l,`\n  position: relative;\n  white-space: pre;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  border: 1px solid ${n.colors.darkGrey};\n  border-radius: 3px;\n  min-height: 28px;\n  padding: 5px 6px;\n  color: ${n.colors.slate};\n\n  &.disabled, &.disabled .ace-chrome {\n    background-color: ${n.colors.mediumGreyOpaque};\n  }\n  & .ace_line {\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n`)},62905:(e,t,o)=>{"use strict";o.r(t),o.d(t,{attachColumnFilterMenu:()=>Ae,columnFilterMenu:()=>xe,createFilterMenu:()=>Se,cssItemValue:()=>Ve});var n,i=o(24412),s=o(70387),r=o(45051),l=o(11104),a=o(18099);const c=o(41469),d=o(37707),u=new Intl.Collator("en-US",{numeric:!0}).compare;class p extends a.Disposable{constructor(e){super(),this._params=e,this.columnFilter=this._params.columnFilter,this.filterInfo=this._params.filterInfo,this.gristDoc=this._params.gristDoc,this.initialPinned=this.filterInfo.isPinned.peek(),this.limitShown=null!=(n=this._params.limitShow)?n:500,this.searchValue=a.Observable.create(this,""),this.isSortedByCount=a.Observable.create(this,!1),this.filterSet=a.Computed.create(this,this.searchValue,((e,t)=>{const o=new RegExp(c((0,l.normalizeText)(t)),"i"),n=["Bool","Choice","ChoiceList"].includes(this.columnFilter.columnType);return new Set(this._params.valueCount.filter((([e,{label:t,count:i}])=>(!!n||i)&&o.test((0,l.normalizeText)(t)))).map((([e])=>e)))})),this.filteredValues=a.Computed.create(this,this.filterSet,this.isSortedByCount,((e,t,o)=>{const n=o?"count":"displayValue";let i=d;return["Date","DateTime","Numeric","Int"].includes(this.columnFilter.visibleColumnType)&&(i=e=>d(e)||isNaN(e)),this._params.valueCount.filter((([e])=>t.has(e))).sort(((e,t)=>((e,t)=>i(e)?-1:i(t)?1:u(e,t))(e[1][n],t[1][n])))})),this.otherValues=a.Computed.create(this,this.filterSet,((e,t)=>this._params.valueCount.filter((([e])=>!t.has(e))))),this.filteredKeys=a.Computed.create(this,this.filterSet,((e,t)=>this._params.valueCount.filter((([e])=>t.has(e))).map((([e])=>e)))),this.valuesBeyondLimit=a.Computed.create(this,this.filteredValues,((e,t)=>t.slice(this.limitShown)))}}var h=o(37540),m=o(3411),f=o(11187),g=o(92478),b=o(29922),y=o(7454),v=o(1370),_=o(34903),w=o(75083),x=o(21467),C=o(93965),D=o(631),k=o(55330),S=o(88918),I=o(68652),T=o.n(I),R=Object.defineProperty,F=Object.getOwnPropertySymbols,A=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable,E=(e,t,o)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,M=(e,t)=>{for(var o in t||(t={}))A.call(t,o)&&E(e,o,t[o]);if(F)for(var o of F(t))O.call(t,o)&&E(e,o,t[o]);return e};const P={getCurrentTime:S.Z},B=[w.zr,[{quantity:-3,unit:"day"}],[{quantity:-7,unit:"day"}],[{quantity:-30,unit:"day"}],[{quantity:0,unit:"year"}],[{quantity:3,unit:"day"}],[{quantity:7,unit:"day"}],[{quantity:30,unit:"day"}],[{quantity:0,unit:"year",endOf:!0}]];function L(e){if(void 0===e)return B;(0,_.CV)(e)&&(e=(0,w.ZW)(e));const t=T().utc(1e3*e),o=[e];let n=N(e,{unit:"day"});return Math.abs(n[0].quantity)<=90&&o.push(n),n=N(e,{unit:"week"}),Math.abs(n[0].quantity)<=4&&o.push(n),n=N(e,{unit:"month"}),Math.abs(n[0].quantity)<=(1===t.date()?12:3)&&o.push(n),1===t.date()&&0===t.month()&&o.push(N(e,{unit:"year"})),31===t.date()&&11===t.month()&&o.push(N(e,{unit:"year",endOf:!0})),t.clone().endOf("month").date()===t.date()&&(n=N(e,{unit:"month",endOf:!0}),Math.abs(n[0].quantity)<12&&o.push(n)),o}function N(e,t){const{unit:o}=t,n=T().utc(1e3*e),i=function(){const e=P.getCurrentTime();return T().utc([e.year(),e.month(),e.date()])}(),s=(0,w.QG)(n,i.clone(),o),r=i.clone().add(s,o);t.endOf?(r.endOf(o),r.startOf("day")):r.startOf(o);const l=(0,w.QG)(n,r,"day"),a=[M({quantity:s},t)];return l&&a.push({quantity:l,unit:"day"}),a}function z(e,t){return(0,_.CV)(e)?(0,w.iv)(e):t(e)}class V extends a.Disposable{constructor(e){super(),this._opts=e,this._moveToSelected=this._moveToSelected.bind(this),this.autoDispose(this.columnFilter.min.addListener((()=>this._setRange()))),this.autoDispose(this.columnFilter.max.addListener((()=>this._setRange()))),this.autoDispose(this._opts.selectedBoundObs.addListener(this._moveToSelected))}get columnFilter(){return this._opts.columnFilter}get selectedBoundObs(){return this._opts.selectedBoundObs}buildDom(){return setTimeout((()=>this._moveToSelected()),0),U(H(j("← List view",a.dom.on("click",(()=>this._opts.selectedBoundObs.set(null)))),j("Today",a.dom.on("click",(()=>{this._$el.datepicker("update",this._getCurrentTime()),this._cleanup()}))),(0,b.testId)("calendar-links")),W((e=>{const t=this._$el=$(e);t.datepicker({defaultViewDate:this._getCurrentTime(),todayHighlight:!0}),t[0].querySelector(".datepicker"),this._setRange(),t.on("changeDate",(()=>this._onChangeDate())),t.on("changeMonth",(()=>setTimeout((()=>this._cleanup()),0))),t.on("changeYear",(()=>setTimeout((()=>this._cleanup()),0))),t.on("changeDecade",(()=>setTimeout((()=>this._cleanup()),0))),t.on("changeCentury",(()=>setTimeout((()=>this._cleanup()),0)))})))}_setRange(){this._$el.datepicker("setRange",this._getRange()),this._moveToSelected()}_moveToSelected(){const e=this._opts.selectedBoundObs.get();let t=this._getCurrentTime();if(null!==e){const o=this.columnFilter.getBoundsValue(e);isFinite(o)&&(t=new Date(1e3*o))}this._$el.datepicker("update",t),this._cleanup()}_getCurrentTime(){return(0,S.Z)().toDate()}_onChangeDate(){const e=this._$el.datepicker("getUTCDate").valueOf()/1e3,{min:t,max:o}=this.columnFilter;"min"===this.selectedBoundObs.get()?(t.set(this._updateBoundValue(t.get(),e)),this.columnFilter.getBoundsValue("max")<e&&o.set(this._updateBoundValue(o.get(),e))):(o.set(this._updateBoundValue(o.get(),e)),this.columnFilter.getBoundsValue("min")>e&&t.set(this._updateBoundValue(t.get(),e))),this._cleanup()}_getRange(){const e=this.columnFilter.getBoundsValue("min"),t=this.columnFilter.getBoundsValue("max"),o=e=>{const t=T().utc(1e3*e);return new Date(Date.UTC(t.year(),t.month(),t.date()))};return isFinite(e)||isFinite(t)?isFinite(e)?isFinite(t)?[o(e),o(t)]:[o(e),{valueOf:()=>1/0}]:[{valueOf:()=>-1/0},o(t)]:[]}_updateBoundValue(e,t){return(0,_.CV)(e)?function(e,t){const o=Array.isArray(e)?e:[e];if([1,2].includes(o.length)){const{unit:e,endOf:n}=o[0],i=N(t,{unit:e,endOf:n});return L(t).find((e=>(0,_.CV)(e)&&(0,w.u7)(e,i)))?i:t}throw new Error(`Relative date spec does only support 1 or 2 periods, got ${o.length}!`)}(e,t):t}_cleanup(){const e=this._$el.get()[0].querySelectorAll(".active");for(const t of e)t.classList.remove("active")}}const U=(0,a.styled)("div","\n  padding: 16px 16px;\n"),j=f.textButton,H=(0,a.styled)("div","\n  display: flex;\n  justify-content: space-between;\n"),W=(0,a.styled)("div","\n  padding-top: 16px;\n  background-color: white;\n");var G=o(31490),Y=Object.defineProperty,K=Object.defineProperties,q=Object.getOwnPropertyDescriptors,J=Object.getOwnPropertySymbols,Z=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable,X=(e,t,o)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var ee=o(88480);class te extends a.Disposable{constructor(e,t,o){super(),this._obs=t,this._opt=o,this._items=a.Observable.create(this,[]),this._dropdownList=ee.L.create(this,e,this._items,this._action.bind(this)),this._dropdownList.listenKeys(e.getTriggerElem()),this.content=this._dropdownList.content,this.autoDispose(this._obs.addListener((()=>this._update()))),this._update()}_getOptions(){var e,t;return(e=this._obs.get(),t=this._opt.valueFormatter,L(e).map((e=>({spec:e,label:z(e,t)})))).map((e=>({label:e.label,value:e.spec})))}_update(){this._items.set(this._getOptions());const e=this._items.get().findIndex((e=>(0,_.t0)(e.value,this._obs.get())));this._dropdownList.setSelected(null!=e?e:-1)}_action(e){this._obs.set(e)}}var oe=o(29813);const ne=[{label:"Today",min:w.zr,max:w.zr},{label:"Last 7 days",min:[{quantity:-7,unit:"day"}],max:[{quantity:-1,unit:"day"}]},{label:"Next 7 days",min:[{quantity:1,unit:"day"}],max:[{quantity:7,unit:"day"}]},{label:"Last Week",min:[{quantity:-1,unit:"week"}],max:[{quantity:-1,unit:"week",endOf:!0}]},{label:"Last 30 days",min:[{quantity:-30,unit:"day"}],max:[{quantity:-1,unit:"day"}]},{label:"This week",min:[{quantity:0,unit:"week"}],max:[{quantity:0,unit:"week",endOf:!0}]},{label:"This month",min:[{quantity:0,unit:"month"}],max:[{quantity:0,unit:"month",endOf:!0}]},{label:"This year",min:[{quantity:0,unit:"year"}],max:[{quantity:0,unit:"year",endOf:!0}]}];var ie=o(11486),se=Object.defineProperty,re=Object.defineProperties,le=Object.getOwnPropertyDescriptors,ae=Object.getOwnPropertySymbols,ce=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable,ue=(e,t,o)=>t in e?se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,pe=(e,t)=>{for(var o in t||(t={}))ce.call(t,o)&&ue(e,o,t[o]);if(ae)for(var o of ae(t))de.call(t,o)&&ue(e,o,t[o]);return e};const he=o(15145),me=o(72827),fe=o(78870),ge=o(19647),be=o(2278),ye=o(14116),ve=o(88466),_e=(0,s.makeT)("ColumnFilterMenu"),we=(0,a.makeTestId)("test-filter-menu-");function xe(e,t){const{model:o,doCancel:n,doSave:s,onClose:r,renderValue:l,valueParser:c,showAllFiltersButton:d}=t,{columnFilter:u,filterInfo:p,gristDoc:h}=o,b=t.valueFormatter||(e=>(null==e?void 0:e.toString())||""),w=new Map,x=u.filterFunc.addListener(ve((e=>{for(const[t,o]of w)o.checked=e(t)}))),{searchValue:C,filteredValues:k,filteredKeys:S,isSortedByCount:I}=o,T=a.Computed.create(e,(e=>e(o.valuesBeyondLimit).length>0)),R=a.Computed.create(e,(e=>Boolean(e(C)))),F=(0,D.isNumberType)(u.columnType)||(0,D.isDateLikeType)(u.columnType),A=(0,D.isDateLikeType)(u.columnType),O=a.Observable.create(e,null),E=a.Computed.create(e,(e=>A&&e(O)?"calendarView":"listView")),M=a.Computed.create(e,(e=>"min"===e(O))).onWrite((e=>e?O.set("min"):O.set("max"))),P=a.Computed.create(e,(e=>"max"===e(O))).onWrite((e=>e?O.set("max"):O.set("min")));let B,$=!1,L=!1;return Oe({tabindex:"-1"},we("wrapper"),(t=>{oe.FocusLayer.create(e,{defaultFocusElem:t,pauseMousetrap:!0}),setTimeout((()=>{const e=B;e.focus(),e.select()}),0)}),a.dom.cls(v.menuCssClass),a.dom.autoDispose(x),a.dom.onDispose((()=>$?n():s(L))),a.dom.onKeyDown({Enter:()=>r(),Escape:()=>r()}),a.dom.maybe(F,(()=>[Xe(Ce(u.min,{isDateFilter:A,placeholder:_e(A?"Start":"Min"),valueParser:c,valueFormatter:b,isSelected:M,viewTypeObs:E,nextSelected:()=>O.set("max")},we("min"),a.dom.onKeyDown({Tab:e=>e.shiftKey||O.set("max")})),Ce(u.max,{isDateFilter:A,placeholder:_e(A?"End":"Max"),valueParser:c,valueFormatter:b,isSelected:P,viewTypeObs:E},we("max"),a.dom.onKeyDown({Tab:e=>e.shiftKey?O.set("min"):O.set("max")}))),a.dom.maybe(A,(()=>{function e(e){const{min:t,max:o}=e;u.min.set(t),u.max.set(o),O.set("min")}return[ze(we("presets-links"),Ne(ne[0].label,a.dom.on("click",(()=>e(ne[0])))),Ne(ne[1].label,a.dom.on("click",(()=>e(ne[1])))),Ne("More ",(0,y.icon)("Dropdown"),(0,v.menu)((()=>ne.map((t=>(0,v.menuItem)((()=>e(t)),t.label)))),{attach:"."+Oe.className})))]})),Be()])),a.dom.domComputed(E,(e=>"listView"===e?[Ee(Ke("Search"),B=Ye(C,{onInput:!0},we("search-input"),{type:"search",placeholder:_e("Search values")},a.dom.onKeyDown({Enter:()=>{C.get()&&u.setState({included:S.get()})},Escape$:e=>{C.get()&&(C.set(""),B.focus(),e.stopPropagation())}})),a.dom.maybe(C,(()=>Ke("CrossSmall",we("search-close"),a.dom.on("click",(()=>{C.set(""),B.focus()})))))),Be(),Le(a.dom.domComputed((e=>{const t=e(C);e(S);const o=t?{included:e(S)}:{excluded:[]},n=t?{excluded:e(S)}:{included:[]},i=e(u.state);return[Me(a.dom.text(_e(t?"All Shown":"All")),a.dom.prop("disabled",(0,_.oz)(i,o)),a.dom.on("click",(()=>u.setState(o))),we("bulk-action")),Pe("•"),Me(_e(t?"All Except":"None"),a.dom.prop("disabled",(0,_.oz)(i,n)),a.dom.on("click",(()=>u.setState(n))),we("bulk-action"))]})),Je("Sort",Je.cls("-active",I),a.dom.on("click",(()=>I.set(!I.get()))))),$e(we("list"),a.dom.maybe((e=>0===e(k).length),(()=>qe(_e("No matching values")))),a.dom.domComputed(k,(e=>e.slice(0,o.limitShown).map((([e,t])=>Le(Ze((0,g.kZ)({type:"checkbox"},a.dom.on("change",((t,o)=>{o.checked?u.add(e):u.delete(e)})),(t=>{t.checked=u.includes(e),w.set(e,t)}),a.dom.style("position","relative")),l(e,t)),Ue(t.count.toLocaleString(),we("count"))))))))]:a.dom.create(V,{viewTypeObs:E,selectedBoundObs:O,columnFilter:u}))),[Be(),je(a.dom.domComputed((e=>{const t=e(T),n=e(R),i=e(o.otherValues),s=Boolean(i.length),r=e(o.valuesBeyondLimit);return e(u.isRange)||"calendarView"===e(E)?[]:t?n?[ke(_e("Other Matching"),r,!1,o),ke(_e("Other Non-Matching"),i,!0,o)]:[ke(_e("Other Values"),he(i,r),!1,o),ke(_e("Future Values"),[],!0,o)]:s?[ke(_e("Others"),i,!0,o)]:[ke(_e("Future Values"),[],!0,o)]})),He((0,a.dom)("div",We("Close",we("apply-btn"),a.dom.on("click",(()=>{L=!0,r()}))),(0,f.basicButton)("Cancel",we("cancel-btn"),a.dom.on("click",(()=>{$=!0,r()}))),d?Ge("All filters",a.dom.on("click",(()=>{r(),i.allCommands.sortFilterMenuOpen.run(p.viewSection.getRowId())})),we("all-filters-btn")):null),(0,a.dom)("div",(0,m.cssPinButton)((0,y.icon)("PinTilted"),m.cssPinButton.cls("-pinned",o.filterInfo.isPinned),a.dom.on("click",(()=>p.pinned(!p.pinned()))),h.behavioralPromptsManager.attachTip("filterButtons",{popupOptions:{attach:null,modifiers:{flip:{behavior:["right","top"]}},placement:"right"}}),we("pin-btn")))))],a.dom.on("click",(e=>e.stopPropagation())))}function Ce(e,t,...o){const n=()=>[a.dom.maybe((t=>(0,_.CV)(t(e))),(()=>function(e,t){return it(nt(a.dom.text((t=>(0,w.iv)(t(e)))),(0,G.cssDeleteButton)(a.dom.on("mousedown",(e=>e.stopPropagation())),(0,G.cssDeleteIcon)("CrossSmall"),a.dom.on("click",(()=>e.set(void 0))),we("tokenfield-delete")),we("tokenfield-token")))}(e))),De(e,t)];return et(a.dom.maybe(t.isDateFilter,(()=>[tt("FieldDate"),n(),(0,y.icon)("Dropdown")])),a.dom.maybe(!t.isDateFilter,(()=>[n()])),et.cls("-relative",(t=>(0,_.CV)(t(e)))),a.dom.cls("selected",(e=>"calendarView"===e(t.viewTypeObs)&&e(t.isSelected))),a.dom.on("click",(()=>t.isSelected.set(!0))),(o=>t.isDateFilter?function(e,t,o){const n=function(e,t,o){const n=function(e,t,o){const n=x.PopupControl.create(null);var i;return n.attachElem(e,(function(e){const o=t(e);return{content:o,dispose:function(){(0,a.domDispose)(o)}}}),(i=((e,t)=>{for(var o in t||(t={}))Z.call(t,o)&&X(e,o,t[o]);if(J)for(var o of J(t))Q.call(t,o)&&X(e,o,t[o]);return e})({attach:"body",boundaries:"viewport"},o),K(i,q({trigger:void 0})))),n}(e,(e=>te.create(null,e,t,o).content),o);return a.dom.autoDisposeElem(e,n),n}(e,t,(s=pe({},o),r={placement:"right-start",attach:"."+Oe.className},re(s,le(r)))),i=()=>{o.isSelected.get()?n.open():n.close()};var s,r;a.dom.update(e,[a.dom.on("click",(()=>n.toggle())),a.dom.autoDispose(o.isSelected.addListener(i)),a.dom.autoDispose(t.addListener(i)),a.dom.onKeyDown({Enter$:e=>{var t;"listView"!==o.viewTypeObs.get()&&(o.isSelected.get()&&(n.isOpen()?null==(t=o.nextSelected)||t.call(o):n.open()),e.stopPropagation())}})])}(o,e,t):null),a.dom.onKeyDown({Backspace$:()=>(0,_.CV)(e.get())&&e.set(void 0)}),...o)}function De(e,t,...o){const n=t.valueParser||Number,i=t.valueFormatter,s=t.placeholder;let r,l=!1;const c=()=>{d.flush(),l=!1,r.value=i(e.get()),setTimeout((()=>t.isSelected.get()&&r.focus()))},d=ve((()=>{if((0,_.CV)(e.get()))return;l=!0;const t=r.value?n(r.value):void 0;(void 0===t||"number"==typeof t&&!isNaN(t))&&e.set(t)}),100);return r=ot({inputmode:"numeric",placeholder:s,value:i(e.get())},a.dom.on("input",d),a.dom.on("blur",c),a.dom.autoDispose(e.addListener((()=>l?null:r.value=i(e.get())))),a.dom.autoDispose(t.isSelected.addListener((e=>e&&r.focus()))),a.dom.onKeyDown({Enter$:()=>c(),Tab$:()=>c()}),...o)}function ke(e,t,o,n){const i=n.columnFilter,s=a.Computed.create(null,i.isInclusionFilter,i.filterFunc,((e,n)=>{const s=t.map((e=>({getState:()=>i.includes(e[0])})));if(o&&s.push({getState:()=>!n}),!s.length)return!1;const r=s[0].getState();return be(ye(s),(e=>e.getState()!==r))?g.HF:r})).onWrite((e=>{if(o){const t=e?{excluded:n.filteredKeys.get().filter((e=>!i.includes(e)))}:{included:n.filteredKeys.get().filter((e=>i.includes(e)))};i.setState(t)}else{const o=t.map((([e])=>e));e?i.addMany(o):i.deleteMany(o)}}));return Le(a.dom.autoDispose(s),we("summary"),(0,g.af)(s,`${e} ${function(e){const t=e.length;return t?"("+t.toLocaleString()+")":""}(t)}`.trim()),Ue(function(e){const t=function(e){return e.reduce(((e,t)=>e+t[1].count),0)}(e);return t?t.toLocaleString():""}(t),we("count")))}function Se(e){var t,o;const{openCtl:n,sectionFilter:i,filterInfo:s,rowSource:l,tableData:c,gristDoc:d,showAllFiltersButton:u,onClose:h=fe}=e,{fieldOrColumn:m,filter:f,isPinned:g}=s,b=m.origCol.peek().type.peek(),y=(null==(t=m.visibleColModel.peek())?void 0:t.type.peek())||b,{keyMapFunc:v,labelMapFunc:_,valueMapFunc:w}=function(e,t,o){const n=t.getRowPropFunc(o.colId()),i=t.getRowPropFunc(o.displayColModel().colId()),s=o.visibleColFormatter();let r;return r=(0,D.isRefListType)(e)?e=>{const t=i(e);return t?((0,D.isList)(t)?t.slice(1):[t]).map((e=>s.formatAny(e))):""}:e=>s.formatAny(i(e)),{keyMapFunc:n,labelMapFunc:r,valueMapFunc:e=>(0,C.xD)(i(e))}}(b,c,m),x=null==(o=m.createValueParser)?void 0:o.call(m);let k=m.visibleColFormatter();if("DateTime"===(0,D.extractTypeFromColType)(k.type)){const{docSettings:e}=k,t=m.origCol.peek().widgetOptionsJson();k=(0,ie.SP)("Date",t,e)}const S=(0,D.isDateLikeType)(y)?e=>k.formatAny(e):void 0;function I(e,t){return e.getRowId()===m.getRowId()?null:t}const T=a.Computed.create(null,(e=>i.buildFilterFunc(I,e)));n.autoDispose(T);const[R,F]=ge(Array.from(l.getAllRows()),T.get()),A=function(e){var t;const o=e.origCol().type();let n=[];return"Bool"===o?n=[!0,!1]:["Choice","ChoiceList"].includes(o)&&(n=null!=(t=e.origCol().widgetOptionsJson.prop("choices")())?t:[]),new Map(n.map((e=>[e,{label:String(e),count:0,displayValue:e}])))}(m);Te(A,R,{keyMapFunc:v,labelMapFunc:_,columnType:b,valueMapFunc:w}),Te(A,F,{keyMapFunc:v,labelMapFunc:_,columnType:b,areHiddenRows:!0,valueMapFunc:w});const O=Array.from(A),E=r.ColumnFilter.create(n,f.peek(),b,y,O.map((e=>e[0])));i.setFilterOverride(m.origCol().getRowId(),E);const M=p.create(n,{columnFilter:E,filterInfo:s,valueCount:O,gristDoc:d});return xe(n,{model:M,valueCounts:A,onClose:()=>{n.close(),h()},doSave:(e=!1)=>{const t=E.makeFilterJson(),{viewSection:o}=i;o.setFilter(m.origCol().origColRef(),{filter:t}),e&&i.resetTemporaryRows(),E.initialFilterJson===r.NEW_FILTER_JSON&&g()&&2===o.pinnedActiveFilters.get().length&&o.showNestedFilteringPopup.set(!0)},doCancel:()=>{const{viewSection:e}=i;if(E.initialFilterJson===r.NEW_FILTER_JSON)e.revertFilter(m.origCol().origColRef());else{const t=E.initialFilterJson;E.setState(t),e.setFilter(m.origCol().origColRef(),{filter:t,pinned:M.initialPinned})}},renderValue:Ie(b,m),valueParser:x,valueFormatter:S,showAllFiltersButton:u})}function Ie(e,t){if(["Choice","ChoiceList"].includes(e)){const e=t.widgetOptionsJson.peek(),o=new Set(e.choices||[]),n=e.choiceOptions||{};return(e,t)=>{var i,s,r,l,c,d,u,p,h,m;return""===t.label?Ve(t.label):(0,k.choiceToken)(t.label,{fillColor:null==(i=n[t.label])?void 0:i.fillColor,textColor:null==(s=n[t.label])?void 0:s.textColor,fontBold:null!=(l=null==(r=n[t.label])?void 0:r.fontBold)&&l,fontUnderline:null!=(d=null==(c=n[t.label])?void 0:c.fontUnderline)&&d,fontItalic:null!=(p=null==(u=n[t.label])?void 0:u.fontItalic)&&p,fontStrikethrough:null!=(m=null==(h=n[t.label])?void 0:h.fontStrikethrough)&&m,invalid:!o.has(t.label)},a.dom.cls(Qe.className),we("choice-token"))}}return(e,t)=>Ve(void 0===t.label?String(e):t.label)}function Te(e,t,{keyMapFunc:o=me,labelMapFunc:n=me,columnType:i,areHiddenRows:s=!1,valueMapFunc:r}){for(const l of t){let t=o(l);if((0,D.isList)(t)&&"ChoiceList"===i){const o=(0,C.xD)(t);o.length||Re(e,"",(()=>""),(()=>""),s);for(const t of o)Re(e,t,(()=>t),(()=>t),s)}else if((0,D.isList)(t)&&(0,D.isRefListType)(i)){const o=(0,C.xD)(t);o.length||Re(e,null,(()=>null),(()=>null),s);const i=n(l),a=r(l);o.forEach(((t,o)=>{Re(e,t,(()=>i[o]),(()=>a[o]),s)}))}else Array.isArray(t)&&(t=JSON.stringify(t)),Re(e,t,(()=>n(l)),(()=>r(l)),s)}}function Re(e,t,o,n,i){e.has(t)||e.set(t,{label:o(),count:0,displayValue:n()}),i||e.get(t).count++}const Fe={placement:"bottom-start",boundaries:"viewport",trigger:["click"]};function Ae(e,t={}){const o=t,{popupOptions:n}=o,i=((e,t)=>{var o={};for(var n in e)ce.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n]);if(null!=e&&ae)for(var n of ae(e))t.indexOf(n)<0&&de.call(e,n)&&(o[n]=e[n]);return o})(o,["popupOptions"]),s=pe(pe({},Fe),n);return t=>{const o=e.viewSection.viewInstance();o&&o.createFilterMenu&&(0,x.setPopupToCreateDom)(t,(t=>o.createFilterMenu(t,e,i)),s)}}const Oe=(0,a.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  min-width: 252px;\n  max-width: 400px;\n  max-height: 90vh;\n  outline: none;\n  background-color: ${b.theme.menuBg};\n  padding-top: 0;\n  padding-bottom: 12px;\n`),Ee=(0,a.styled)("div","\n  height: 40px;\n  flex-shrink: 0;\n\n  display: flex;\n  align-items: center;\n\n  margin: 0 16px;\n"),Me=(0,a.styled)(f.textButton,`\n  --icon-color: ${b.theme.controlFg};\n`),Pe=(0,a.styled)("span",`\n  color: ${b.theme.controlFg};\n  margin: 0 4px;\n  user-select: none;\n`),Be=(0,a.styled)(v.menuDivider,"\n  flex-shrink: 0;\n  margin: 0;\n"),$e=(0,a.styled)("div","\n  flex-shrink: 1;\n  overflow: auto;\n  min-height: 80px;\n  margin-top: 4px;\n  padding-bottom: 8px;\n"),Le=(0,a.styled)("div","\n  display: flex;\n  padding: 8px 16px;\n"),Ne=f.textButton,ze=(0,a.styled)(Le,"\n  column-gap: 12px;\n  padding-top: 0;\n  padding-bottom: 16px;\n"),Ve=(0,a.styled)(g.Jr,"\n  margin-right: 12px;\n  white-space: pre;\n"),Ue=(0,a.styled)("div",`\n  flex-grow: 1;\n  align-self: normal;\n  text-align: right;\n  color: ${b.theme.lightText};\n`),je=(0,a.styled)("div","\n  display: flex;\n  flex-shrink: 0;\n  flex-direction: column;\n  padding-top: 4px;\n"),He=(0,a.styled)("div","\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 8px 16px;\n"),We=(0,a.styled)(f.primaryButton,"\n  margin-right: 8px;\n"),Ge=(0,a.styled)(f.textButton,"\n  margin-left: 8px;\n"),Ye=(0,a.styled)(a.input,`\n  color: ${b.theme.inputFg};\n  background-color: ${b.theme.inputBg};\n  flex-grow: 1;\n  min-width: 1px;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n\n  font-size: ${b.vars.mediumFontSize};\n\n  margin: 0px 16px 0px 8px;\n  padding: 0px;\n  border: none;\n  outline: none;\n\n  &::placeholder {\n    color: ${b.theme.inputPlaceholderFg};\n  }\n`),Ke=(0,a.styled)(y.icon,`\n  --icon-color: ${b.theme.lightText};\n  flex-shrink: 0;\n  margin-left: auto;\n  margin-right: 4px;\n`),qe=(0,a.styled)(Le,`\n  font-style: italic;\n  color: ${b.theme.lightText};\n  justify-content: center;\n`),Je=(0,a.styled)(y.icon,`\n  --icon-color: ${b.theme.controlSecondaryFg};\n  margin-left: auto;\n  &-active {\n    --icon-color: ${b.theme.controlFg}\n  }\n`),Ze=(0,a.styled)(g.xY,"\n  align-items: center;\n  font-weight: initial;   /* negate bootstrap */\n"),Qe=(0,a.styled)("div","\n  margin-left: 8px;\n  margin-right: 12px;\n"),Xe=(0,a.styled)(Le,"\n  display: flex;\n  align-items: center;\n  row-gap: 6px;\n  flex-direction: column;\n  padding: 16px 16px;\n"),et=(0,a.styled)("div",`\n  position: relative;\n  width: 100%;\n  display: flex;\n  background-color: ${b.theme.inputBg};\n  height: 30px;\n  width: 100%;\n  border-radius: 3px;\n  border: 1px solid ${b.theme.inputBorder};\n  outline: none;\n  padding: 5px;\n  &.selected {\n    border: 1px solid ${b.theme.inputValid};\n  }\n  &-relative input {\n    padding: 0;\n    max-width: 0;\n  }\n`),tt=v.cssOptionRowIcon,ot=(0,a.styled)(h.g,"\n  height: unset;\n  border: none;\n  padding: 0;\n  width: unset;\n  flex-grow: 1;\n"),nt=(0,a.styled)(G.cssToken,"\n  height: 18px;\n  line-height: unset;\n  align-self: center;\n  cursor: default;\n"),it=(0,a.styled)("div","\n  width: 100%;\n  display: flex;\n  outline: none;\n")},3898:(e,t,o)=>{"use strict";o.r(t),o.d(t,{buildFormulaConfig:()=>j,buildNameConfig:()=>U,cssFieldFormula:()=>W});var n=o(70387),i=o(85050),s=o(7485),r=o(3411),l=o(8881),a=o(92769),c=o(98987),d=o(11187),u=o(92478),p=o(29922),h=o(7454),m=o(1370),f=o(48402),g=o(631),b=o(83277),y=o(93965),v=o(18099),_=o(21467),w=Object.defineProperty,x=Object.defineProperties,C=Object.getOwnPropertyDescriptors,D=Object.getOwnPropertySymbols,k=Object.prototype.hasOwnProperty,S=Object.prototype.propertyIsEnumerable,I=(e,t,o)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const T=o(36812),R=(0,n.makeT)("TriggerFormulas");function F(e,t,o){const n=v.Computed.create(e,(e=>e(t.recalcWhen)!==g.RecalcWhen.NEVER)).onWrite((e=>l(e?g.RecalcWhen.DEFAULT:g.RecalcWhen.NEVER,null))),i=v.Observable.create(e,!1),s=v.Computed.create(e,(e=>{return e(i)||(o=e(t.recalcWhen),n=e(t.recalcDeps),o===g.RecalcWhen.MANUAL_UPDATES||o===g.RecalcWhen.DEFAULT&&null!=n&&!(0,g.isEmptyList)(n));var o,n})).onWrite((async function(e){await l(g.RecalcWhen.DEFAULT,null),i.set(e)}));async function l(e,o){if(e!==t.recalcWhen.peek()||o!==t.recalcDeps.peek())return t._table.sendTableAction(["UpdateRecord",t.id.peek(),{recalcWhen:e,recalcDeps:(0,y.Cx)(o)}])}const c=t._table.docModel,w=v.Computed.create(e,(e=>{if(e(t.recalcWhen)===g.RecalcWhen.MANUAL_UPDATES)return R("Any field");const o=(0,y.xD)(e(t.recalcDeps));return o&&0!==o.length?o.map((t=>{var o;return e(null==(o=c.columns.getRowModel(t))?void 0:o.label)})).join(", "):""})),F=v.Computed.create(e,(e=>Boolean(o.disabled&&e(o.disabled)||o.notTrigger&&e(o.notTrigger)))),N=v.Computed.create(e,(e=>Boolean(e(s)||e(F))));return[(0,r.cssRow)((0,u.rp)(n,R("Apply to new records"),v.dom.boolAttr("disabled",N),(0,p.testId)("field-formula-apply-to-new"))),(0,r.cssRow)((0,u.rp)(s,v.dom.text((e=>e(s)?R("Apply on changes to:"):R("Apply on record changes"))),v.dom.boolAttr("disabled",F),(0,p.testId)("field-formula-apply-on-changes"))),v.dom.maybe(s,(()=>A((0,f.G)(O(v.dom.text(w)),(0,h.icon)("Dropdown"),(0,p.testId)("field-triggers-select"),v.dom.cls("disabled",(e=>!!o.disabled&&e(o.disabled))),(e=>{var o;(0,_.setPopupToCreateDom)(e,(e=>function(e,t,o,n){const i=e,s=new Set((0,y.xD)(o.recalcDeps.peek())),r=v.Observable.create(i,o.recalcWhen.peek()===g.RecalcWhen.MANUAL_UPDATES),l=t.columns.peek().peek().filter((e=>!e.isHiddenCol.peek()));l.sort(((e,t)=>(0,b.nativeCompare)(e.label.peek(),t.label.peek())));const c=l.map((e=>v.Observable.create(i,s.has(e.id.peek())))),h=c.find(((e,t)=>l[t].id.peek()===o.id.peek()));i.autoDispose(r.addListener((e=>{e&&c.forEach((e=>e.set(!1)))})));const f=v.Computed.create(i,(e=>e(r)?g.RecalcWhen.MANUAL_UPDATES:g.RecalcWhen.DEFAULT)),_=v.Computed.create(i,(e=>e(r)?null:l.filter(((t,o)=>e(c[o]))).map((e=>e.id.peek())))),w=v.Computed.create(i,(e=>e(f)!==e(o.recalcWhen)||!T(new Set(e(_)),s)));let x=!0;function C(t){x=t,e.close()}return E({tabindex:"-1"},(0,p.testId)("field-triggers-dropdown"),v.dom.cls(m.menuCssClass),v.dom.onDispose((function(){x&&w.get()&&n(f.get(),_.get()).catch(a.reportError)})),v.dom.onKeyDown({Enter:()=>C(!0),Escape:()=>C(!1)}),(e=>{setTimeout((()=>e.focus()),0)}),P(B((0,u.rp)(h,[R("Current field "),$("(data cleaning)")],v.dom.boolAttr("disabled",r))),(0,m.menuDivider)(),B((0,u.rp)(r,[`${R("Any field")} `,$("(except formulas)")]))),M(l.map(((e,t)=>B((0,u.rp)(c[t],e.label.peek(),v.dom.boolAttr("disabled",r)))))),P(L(v.dom.maybe(w,(()=>(0,d.primaryButton)(R("OK"),v.dom.on("click",(()=>C(!0))),(0,p.testId)("trigger-deps-apply")))),(0,d.basicButton)(v.dom.text((e=>e(w)?R("Cancel"):R("Close"))),v.dom.on("click",(()=>C(!1))),(0,p.testId)("trigger-deps-cancel")))))}(e,t.table.peek(),t,l)),(o=((e,t)=>{for(var o in t||(t={}))k.call(t,o)&&I(e,o,t[o]);if(D)for(var o of D(t))S.call(t,o)&&I(e,o,t[o]);return e})({},_.defaultMenuOptions),x(o,C({placement:"bottom-end"}))))})))))]}const A=(0,v.styled)(r.cssRow,"\n  margin-left: 40px;\n"),O=(0,v.styled)("div",`\n  flex: 1 1 0px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n\n  &:empty::before {\n    content: "Select fields";\n    color: ${p.theme.selectButtonPlaceholderFg};\n  }\n`),E=(0,v.styled)(_.cssMenu,"\n  display: flex;\n  flex-direction: column;\n  max-height: calc(max(300px, 95vh - 300px));\n  max-width: 400px;\n  padding-bottom: 0px;\n"),M=(0,v.styled)(c.a,`\n  flex: auto;\n  min-height: 80px;\n  border-top: 1px solid ${p.theme.menuBorder};\n  border-bottom: 1px solid ${p.theme.menuBorder};\n  margin-top: 8px;\n  padding: 8px 0;\n`),P=(0,v.styled)("div","\n  flex: none;\n"),B=(0,v.styled)(_.cssMenuItem,"\n  justify-content: flex-start;\n  align-items: center;\n  display: flex;\n  padding: 8px 16px;\n  white-space: nowrap;\n"),$=(0,v.styled)("span",`\n  color: ${p.theme.lightText};\n`),L=(0,v.styled)(B,"\n  justify-content: space-between;\n  margin: 3px 0;\n");var N=o(29002),z=o(20354);const V=(0,n.makeT)("FieldConfig");function U(e,t,o,n){const s=t.untieColIdFromLabel,l=v.Observable.create(e,""),a=v.Computed.create(e,l,((e,o)=>"$"+(o?(0,b.sanitizeIdent)(o):e(t.colId)))),c=v.Computed.create(e,(e=>Boolean(e(e(t.table).summarySourceTable))));let d;return e.autoDispose(o.subscribe((()=>{null==d||d.blur()}))),[(0,r.cssLabel)(V("COLUMN LABEL AND ID")),(0,r.cssRow)(v.dom.cls(r.cssBlockedCursor.className,t.disableModify),Y(d=Z((0,v.fromKo)(t.label),(async e=>{await t.label.saveOnly(e),l.set("")}),v.dom.on("input",((e,t)=>{s.peek()||l.set(t.value)})),v.dom.boolAttr("readonly",(e=>e(t.disableModify)||e(n))),(0,p.testId)("field-label")),Z(a,(e=>t.colId.saveOnly(e.startsWith("$")?e.slice(1):e)),v.dom.boolAttr("readonly",(e=>e(n)||e(t.disableModify)||!e(t.untieColIdFromLabel))),i.m.cls(""),{style:"margin-top: 8px"},(0,p.testId)("field-col-id"))),K(q(),G((0,h.icon)("FieldReference"),G.cls("-selected",(e=>!e(s))),v.dom.on("click",(()=>{t.disableModify.peek()||n.peek()||s.saveOnly(!s.peek()).catch(reportError)})),G.cls("-disabled",(e=>e(t.disableModify)||e(n))),(0,p.testId)("field-derive-id")))),v.dom.maybe(c,(()=>(0,r.cssRow)(V("Column options are limited in summary tables."))))]}function j(e,t,o,n){const i=v.Computed.create(e,(e=>e(t.disableModify))),a=v.Observable.create(e,!1),c=v.Observable.create(e,!1),u=v.Computed.create(e,(e=>Boolean(e(e(t.table).summarySourceTable)))),h=v.Computed.create(e,(e=>e(t.id)?e(t.isRealFormula)||e(a)?"formula":e(c)||!e(t.isEmpty)?"data":"empty":null));let f=null;const g=()=>(0,v.bundleChanges)((()=>{a.set(!1),c.set(!1),f=null}));e.autoDispose(t.id.subscribe(g)),e.autoDispose(t.formula.subscribe(g)),e.autoDispose(t.isFormula.subscribe(g));const b=v.Computed.create(e,(e=>{var t;return null==(t=e(o.currentView))?void 0:t.viewSection})),y=v.Computed.create(e,(e=>{const t=e(b);return!!t&&e(t.selectedFields).length>1})),_=v.Computed.create(e,(e=>{if(!e(y))return!1;const t=e(b);return!!t&&e(t.columnsBehavior)})),w=v.Computed.create(e,(e=>{if(!e(y))return!1;const t=e(b);return!!t&&e(t.columnsAllIsFormula)})),x=()=>{return((null==(e=b.get())?void 0:e.selectedFields.peek().map((e=>e.column.peek())))||[]).map((e=>e.id.peek()))||[];var e},C=(e,t)=>(0,r.cssRow)((0,m.selectMenu)(e,(()=>y.get()?[w.get()?(0,m.selectOption)((()=>o.convertIsFormula(x(),{toFormula:!1,noRecalc:!0})),"Convert columns to data","Database",v.dom.cls("disabled",u)):null,(0,m.selectOption)((()=>Promise.all([o.clearColumns(x())])),"Clear and reset","CrossSmall")]:t),(0,p.testId)("field-behaviour"),(e=>e.removeAttribute("tabindex")),v.dom.cls(r.cssBlockedCursor.className,i),v.dom.cls("disabled",i))),D=v.Computed.create(e,h,((e,t)=>{if(e(y)){const t=e(_);return"formula"===t?V("Formula Columns",{count:2}):"data"===t?V("Data Columns",{count:2}):"mixed"===t?V("Mixed Behavior"):V("Empty Columns",{count:2})}return V("formula"===t?"Formula Columns":"data"===t?"Data Columns":"Empty Columns",{count:1})})),k=v.Computed.create(e,(e=>e(D)===V("Data Columns",{count:2})||e(D)===V("Data Columns",{count:1})?"Database":"Script")),S=()=>(0,m.selectTitle)(D,k),I=()=>o.convertIsFormula([t.id.peek()],{toFormula:!1,noRecalc:!0}),T=()=>(0,m.selectOption)(I,V("Convert column to data"),"Database",v.dom.cls("disabled",u)),R=()=>(0,m.selectOption)((()=>o.clearColumns([t.id.peek()])),V("Clear and reset"),"CrossSmall"),A=()=>{c.set(!0),null==f||f.focus()},O=()=>o.convertIsFormula([t.id.peek()],{toFormula:!1,noRecalc:!1}),E=()=>(a.set(!0),null==f?void 0:f.focus()),M=()=>(c.set(!0),null==f?void 0:f.focus()),P=async(t,n)=>{const i=Boolean(n),s=t.formula.peek();(i||s)&&await o.convertToFormula(t.id.peek(),n),e.isDisposed()||g()},B=async(t,n)=>{n&&!t.hasTriggerFormula.peek()?await o.convertToTrigger(t.id.peek(),n):t.hasTriggerFormula.peek()&&await o.updateFormula(t.id.peek(),n),e.isDisposed()||g()},$=v.Computed.create(e,(e=>e(i)||e(y))),L=(0,z.Ue)(e,o,t),N=e=>[(0,r.cssRow)(f=H(t,n,V("Enter formula"),$,e,g)),v.dom.maybe(L,(e=>(0,r.cssRow)((0,z.So)(e),(0,p.testId)("field-error-count"))))];return v.dom.maybe(h,(e=>[(0,r.cssLabel)(V("COLUMN BEHAVIOR")),..."empty"===e?[C(S(),[T()]),J(),(0,r.cssRow)((0,d.textButton)(V("Set formula"),v.dom.on("click",E),v.dom.prop("disabled",$),(0,p.testId)("field-set-formula"))),(0,r.cssRow)((0,l.withInfoTooltip)((0,d.textButton)(V("Set trigger formula"),v.dom.on("click",M),v.dom.prop("disabled",(e=>e(u)||e($))),(0,p.testId)("field-set-trigger")),s.D.setTriggerFormula())),(0,r.cssRow)((0,d.textButton)(V("Make into data column"),v.dom.on("click",I),v.dom.prop("disabled",(e=>e(u)||e($))),(0,p.testId)("field-set-data")))]:"formula"===e?[C(S(),[T(),R()]),N(P),J(),(0,r.cssRow)((0,d.textButton)(V("Convert to trigger formula"),v.dom.on("click",O),v.dom.hide(a),v.dom.prop("disabled",(e=>e(u)||e($))),(0,p.testId)("field-set-trigger")))]:[C(S(),[v.dom.domComputed(t.hasTriggerFormula,(e=>e?(0,m.selectOption)((()=>o.convertIsFormula([t.id.peek()],{toFormula:!0,noRecalc:!0})),V("Clear and make into formula"),"Script"):(0,m.selectOption)((()=>(a.set(!0),null==f?void 0:f.focus())),V("Clear and make into formula"),"Script"))),R()]),v.dom.maybe((e=>e(c)||e(t.hasTriggerFormula)),(()=>[(0,r.cssLabel)(V("TRIGGER FORMULA")),N(B),v.dom.create(F,t,{disabled:$,notTrigger:c})])),v.dom.maybe((e=>!(e(c)||e(t.hasTriggerFormula))),(()=>[J(),(0,r.cssRow)((0,l.withInfoTooltip)((0,d.textButton)(V("Set trigger formula"),v.dom.on("click",A),v.dom.prop("disabled",$),(0,p.testId)("field-set-trigger")),s.D.setTriggerFormula()))]))]]))}function H(e,t,o,n,i,s){return W(e.formula,{placeholder:o,maxLines:2},v.dom.cls("formula_field_sidepane"),W.cls("-disabled",n),W.cls("-disabled-icon",(t=>!t(e.formula))),v.dom.cls("disabled"),{tabIndex:"-1"},v.dom.on("focus",((e,o)=>t(o,void 0,i,s))))}const W=(0,v.styled)(i.L,`\n  flex: auto;\n  cursor: pointer;\n  margin-top: 4px;\n  padding-left: 24px;\n  --icon-color: ${p.theme.accentIcon};\n\n  &-disabled-icon.formula_field_sidepane::before {\n    --icon-color: ${p.theme.lightText};\n  }\n  &-disabled {\n    pointer-events: none;\n  }\n`),G=(0,v.styled)(h.cssIconButton,`\n  margin-left: 8px;\n  background-color: ${p.theme.rightPanelToggleButtonDisabledBg};\n  box-shadow: inset 0 0 0 1px ${p.theme.inputBorder};\n\n  &-selected, &-selected:hover {\n    box-shadow: none;\n    background-color: ${p.theme.rightPanelToggleButtonEnabledBg};\n    --icon-color: ${p.theme.rightPanelToggleButtonEnabledFg};\n  }\n  &-selected:hover {\n    --icon-color: ${p.theme.rightPanelToggleButtonEnabledHoverFg};\n  }\n  &-disabled, &-disabled:hover {\n    --icon-color: ${p.theme.rightPanelToggleButtonDisabledFg};\n    background-color: ${p.theme.rightPanelToggleButtonDisabledBg};\n  }\n`),Y=(0,v.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex: auto;\n  min-width: 80px;\n"),K=(0,v.styled)("div","\n  position: relative;\n"),q=(0,v.styled)("div",`\n  position: absolute;\n  border: 2px solid ${p.theme.inputBorder};\n  top: -9px;\n  bottom: -9px;\n  right: 11px;\n  left: 0px;\n  border-left: none;\n  z-index: -1;\n`),J=(0,v.styled)("div","\n  margin-top: 16px;\n"),Z=(0,v.styled)(N.textInput,`\n  color: ${p.theme.inputFg};\n  background-color: ${p.theme.mainPanelBg};\n  border: 1px solid ${p.theme.inputBorder};\n\n  &::placeholder {\n    color: ${p.theme.inputPlaceholderFg};\n  }\n\n  &[readonly] {\n    background-color: ${p.theme.inputDisabledBg};\n    color: ${p.theme.inputDisabledFg};\n  }\n`)},86391:(e,t,o)=>{"use strict";o.d(t,{y:()=>u});var n=o(11527),i=o(81294),s=o.n(i);const r=n.get("document","window");function l(){}let a,c,d=l;function u(e){return new Promise((t=>function(e,t){c||(a=s()("form#file_dialog_form",{style:"position: absolute; top: 0; display: none"},c=s()("input#file_dialog_input",{type:"file"})),r.document.body.appendChild(a),c.addEventListener("change",(e=>{d(c.files?Array.from(c.files):[]),d=l}))),a.reset(),c.multiple=Boolean(e.multiple),c.accept=e.accept||"",d=t,setTimeout((()=>c.click()),0)}(e,t)))}},60664:(e,t,o)=>{"use strict";o.d(t,{B:()=>p,s:()=>h});var n=o(45051),i=o(62905),s=o(11187),r=o(29922),l=o(7454),a=o(18099),c=o(70387),d=o(59793);const u=(0,c.makeT)("FilterBar");function p(e,t,o){const n=new WeakMap;return m((0,r.testId)("filter-bar"),a.dom.forEach(o.activeFilters,(e=>function(e,t){const{fieldOrColumn:o,filter:n,pinned:s,isPinned:l}=e;return f((0,r.testId)("filter-field"),v((0,r.testId)("btn"),b("FilterSimple"),g(a.dom.text(o.origCol().label)),y.cls("-grayed",(e=>e(n.isSaved)&&e(s.isSaved))),(0,i.attachColumnFilterMenu)(e,{popupOptions:{placement:"bottom-start",attach:"body",trigger:["click",(e,n)=>t.set(o.origCol(),n)]},showAllFiltersButton:!0})),f.cls("-unpinned",(e=>!e(l))))}(e,n))),a.dom.maybe(o.showNestedFilteringPopup,(()=>(0,a.dom)("div",t.behavioralPromptsManager.attachTip("nestedFiltering",{onDispose:()=>o.showNestedFilteringPopup.set(!1)})))),function(e,t){return a.dom.domComputed((o=>{const n=o(e.filters);return _(y.cls("-grayed"),b("Plus"),h(n,t,{allowedColumns:"unpinned-or-unfiltered"}),(0,r.testId)("add-filter-btn"))}))}(o,n),m.cls("-hidden",(e=>0===e(o.pinnedActiveFilters).length)))}function h(e,t,o={}){const{allowedColumns:i,menuOptions:s}=o;return(0,d.z)({action:e=>function({fieldOrColumn:e,isFiltered:t,viewSection:o},i){var s;o.setFilter(e.origCol().origColRef(),{filter:t.peek()?void 0:n.NEW_FILTER_JSON,pinned:!0}),null==(s=i.get(e.origCol()))||s.open()}(e,t),options:()=>e.map((e=>({label:e.fieldOrColumn.origCol().label.peek(),value:e,disabled:"unpinned-or-unfiltered"===i?e.isPinned.peek()&&e.isFiltered.peek():e.isFiltered.peek()}))),popupOptions:s,placeholder:u("Search Columns")})}const m=(0,a.styled)("div.filter_bar","\n  display: flex;\n  flex-direction: row;\n  margin-bottom: 8px;\n  margin-left: -4px;\n  overflow-x: scroll;\n  scrollbar-width: none;\n  &::-webkit-scrollbar {\n    display: none;\n  }\n  &-hidden {\n    display: none;\n  }\n"),f=(0,a.styled)("div",`\n  border-radius: ${r.vars.controlBorderRadius};\n  flex-shrink: 0;\n  margin: 0 4px;\n  &-unpinned {\n    display: none;\n  }\n`),g=(0,a.styled)("span","\n  flex-grow: 1;\n  padding: 0 4px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n"),b=(0,a.styled)(l.icon,"\n  margin-top: -3px;\n"),y=(0,a.styled)("div",`\n  height: 24px;\n  padding: 3px 8px;\n  .${m.className} > & {\n    margin: 0 4px;\n  }\n  &-grayed {\n    color:        ${r.theme.filterBarButtonSavedFg};\n    --icon-color: ${r.theme.filterBarButtonSavedFg};\n    background-color: ${r.theme.filterBarButtonSavedBg};\n    border-color: ${r.theme.filterBarButtonSavedBg};\n  }\n  &-grayed:hover {\n    background-color: ${r.theme.filterBarButtonSavedHoverBg};\n    border-color: ${r.theme.filterBarButtonSavedHoverBg};\n  }\n`),v=(...e)=>(0,a.dom)("div",s.cssButton.cls(""),s.cssButton.cls("-primary"),y.cls(""),...e),_=(0,a.styled)(v,"\n  padding: 3px 3px\n")},91465:(e,t,o)=>{"use strict";o.d(t,{P:()=>_});var n=o(70387),i=o(62905),s=o(60664),r=o(3411),l=o(29922),a=o(7454),c=o(18099),d=Object.defineProperty,u=Object.defineProperties,p=Object.getOwnPropertyDescriptors,h=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,g=(e,t,o)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,b=(e,t)=>{for(var o in t||(t={}))m.call(t,o)&&g(e,o,t[o]);if(h)for(var o of h(t))f.call(t,o)&&g(e,o,t[o]);return e};const y=(0,c.makeTestId)("test-filter-config-"),v=(0,n.makeT)("SortConfig");class _ extends c.Disposable{constructor(e,t={}){super(),this._section=e,this._options=t,this._popupControls=new WeakMap,this._canAddFilter=c.Computed.create(this,(e=>e(this._section.filters).some((t=>!e(t.isFiltered)))))}buildDom(){const{menuOptions:e}=this._options;return(0,c.dom)("div",c.dom.forEach(this._section.activeFilters,(t=>{const{fieldOrColumn:o,filter:n,pinned:s,isPinned:l}=t;return(0,r.cssRow)((0,r.cssSortFilterColumn)(w(D("FilterSimple",D.cls("-accent",(e=>!e(n.isSaved)||!e(s.isSaved))),y("filter-icon"))),x(c.dom.text(o.label)),(0,i.attachColumnFilterMenu)(t,{popupOptions:(d=b({placement:"bottom-end"},e),h={trigger:["click",(e,t)=>this._popupControls.set(o.origCol(),t)]},u(d,p(h)))}),y("column")),S((0,a.icon)("PinTilted"),c.dom.on("click",(()=>this._section.setFilter(o.origCol().origColRef(),{pinned:!l.peek()}))),r.cssPinButton.cls("-pinned",l),y("pin-filter")),w(k("Remove",c.dom.on("click",(()=>this._section.setFilter(o.origCol().origColRef(),{filter:"",pinned:!1}))),y("remove-filter"))),y("filter"));var d,h})),(0,r.cssRow)(c.dom.domComputed((e=>{const t=e(this._section.filters);return C(v("Add Column"),(0,s.s)(t,this._popupControls,{menuOptions:b({placement:"bottom-end"},this._options.menuOptions)}),c.dom.on("click",(e=>e.stopPropagation())),c.dom.hide((e=>!e(this._canAddFilter))),y("add-filter-btn"))}))),y("container"))}}const w=(0,c.styled)("div",""),x=(0,c.styled)("div","\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n  flex-grow: 1;\n"),C=(0,c.styled)("div",`\n  color: ${l.theme.controlFg};\n  cursor: pointer;\n\n  &:hover {\n    color: ${l.theme.controlHoverFg};\n  }\n`),D=(0,c.styled)(r.cssIcon,`\n  flex: none;\n  margin: 0px 6px 0px 0px;\n  background-color: ${l.theme.controlSecondaryFg};\n\n  &-accent {\n    background-color: ${l.theme.accentIcon};\n  }\n`),k=(0,c.styled)(r.cssIcon,`\n  flex: none;\n  margin: 0 6px;\n  background-color: ${l.theme.controlSecondaryFg};\n  cursor: pointer;\n\n  &:hover {\n    background-color: ${l.theme.controlSecondaryHoverFg};\n  }\n`),S=(0,c.styled)(r.cssPinButton,"\n  margin-left: 6px;\n")},22641:(e,t,o)=>{"use strict";o.d(t,{FU:()=>y,lt:()=>x,ng:()=>C});var n=o(70387),i=o(38109),s=o(7485),r=o(21602),l=o(8881),a=o(90098),c=o(11187),d=o(29922),u=o(7454),p=o(20742),h=o(83277),m=o(18099),f=o(21467);const g=o(83116),b=(0,n.makeT)("PageWidgetPicker");function y(e){const t=(0,r.N3)({srcSectionRef:e.linkSrcSectionRef.peek(),srcColRef:e.linkSrcColRef.peek(),targetColRef:e.linkTargetColRef.peek()});return{type:e.parentKey.peek(),table:e.table.peek().summarySourceTable.peek()||e.tableRef.peek(),summarize:Boolean(e.table.peek().summarySourceTable.peek()),columns:e.table.peek().columns.peek().peek().filter((e=>e.summarySourceCol.peek())).map((e=>e.summarySourceCol.peek())),link:t,section:e.id.peek()}}const v=(0,m.makeTestId)("test-wselect-");function _(e,t){return"New Table"!==e?["record","single","detail","chart","custom"]:t?["record"]:["record","single","detail"]}function w(e,t,o){return null!==e&&_(e,o).includes(t)}function x(e,t,o,n={}){n.placement="left",(0,f.setPopupToCreateDom)(e,(e=>D(e,t,o,n)),{placement:"left",trigger:["click"],attach:"body",boundaries:"viewport"})}function C(e,t,o,n={}){(0,f.popupOpen)(e,(e=>D(e,t,o,n)),{placement:"right"})}function D(e,t,o,n={}){const{behavioralPromptsManager:i,docModel:s}=t,l=(0,m.fromKo)(s.visibleTables.getObservable()),c=(0,m.fromKo)(s.columns.createAllRowsModel("parentPos").getObservable()),d={type:"record",table:null,summarize:!1,columns:[],link:r.bG,section:0},u=n.value&&n.value()||d,f={type:m.Observable.create(e,u.type),table:m.Observable.create(e,u.table),summarize:m.Observable.create(e,u.summarize),columns:m.Observable.create(e,u.columns),link:m.Observable.create(e,u.link),section:m.Observable.create(e,u.section)};async function g(){e.close();const t=f.type.get(),n=o({type:t,table:f.table.get(),summarize:f.summarize.get(),columns:G(f.columns.get(),c.get().map((e=>e.id.peek()))),link:f.link.get(),section:f.section.get()});if("New Table"===f.table.get())await n;else if(await(0,h.isLongerThan)(n,500)){const e=(0,a.a)(t).label;await(0,p.spinnerModal)(b("Building {{- label}} widget",{label:e}),n)}}return n.placement&&"left"===n.placement&&e.autoDispose(f.summarize.addListener(((t,o)=>t&&e.update()))),R(m.dom.create(S,f,l,c,g,i,n),(e=>{setTimeout((()=>e.focus()),0)}),(0,m.onKeyDown)({Escape:()=>e.close(),Enter:()=>w(f.table.get(),f.type.get(),n.isNewPage)&&g()}))}const k=179==o.j?["record","single","detail","chart","custom"]:null;class S extends(179==o.j?m.Disposable:null){constructor(e,t,o,n,i,s={}){super(),this._value=e,this._tables=t,this._columns=o,this._onSave=n,this._behavioralPromptsManager=i,this._options=s,this._selectByOptions=this._options.selectBy?m.Computed.create(this,(e=>{const t={type:e(this._value.type),table:e(this._value.table),summarize:e(this._value.summarize),columns:e(this._value.columns),link:this._value.link.get(),section:e(this._value.section)};return this._options.selectBy(t)})):null,this._isNewTableDisabled=m.Computed.create(this,this._value.type,((e,t)=>!w("New Table",t,this._options.isNewPage)))}buildDom(){return T(v("container"),F(A(I(b("Select Widget")),k.map((e=>{const{label:t,icon:o}=(0,a.a)(e),n=(0,m.computed)(this._value.table,((t,o)=>this._isTypeDisabled(e,o)));return E(m.dom.autoDispose(n),P(o),t,m.dom.on("click",(()=>!n.get()&&this._selectType(e))),E.cls("-selected",(t=>t(this._value.type)===e)),E.cls("-disabled",n),v("type"))}))),A(v("data"),I(b("Select Data")),E(M("TypeTable"),"New Table",m.dom.on("click",(e=>!this._isNewTableDisabled.get()&&this._selectTable("New Table"))),this._behavioralPromptsManager.attachTip("pageWidgetPicker",{popupOptions:{attach:null,placement:"right-start"}}),E.cls("-selected",(e=>"New Table"===e(this._value.table))),E.cls("-disabled",this._isNewTableDisabled),v("table")),m.dom.forEach(this._tables,(e=>(0,m.dom)("div",L(E(M("TypeTable"),B(m.dom.text((t=>t(e.tableNameDef)||t(e.tableId)))),m.dom.on("click",(()=>this._selectTable(e.id()))),E.cls("-selected",(t=>t(this._value.table)===e.id())),v("table-label")),N(z("Pivot"),E.cls("-selected",(t=>t(this._value.summarize)&&t(this._value.table)===e.id())),m.dom.on("click",((t,o)=>this._selectPivot(e.id(),o))),v("pivot")),v("table")))))),A(I(b("Group by")),m.dom.hide((e=>!e(this._value.summarize))),(0,m.domComputed)((e=>e(this._columns).filter((t=>!t.isHiddenCol()&&t.parentId()===e(this._value.table)))),(e=>e?m.dom.forEach(e,(e=>E(M("FieldColumn"),$(m.dom.text(e.label)),m.dom.on("click",(()=>this._toggleColumnId(e.id()))),E.cls("-selected",(t=>t(this._value.columns).includes(e.id()))),v("column")))):null)))),V(U(m.dom.maybe((e=>this._selectByOptions&&e(this._selectByOptions).length>1),(()=>(0,l.withInfoTooltip)(W(j("SELECT BY"),m.dom.update(H(this._value.link,this._selectByOptions),v("selectby"))),s.D.selectBy(),{tooltipMenuOptions:{attach:null},domArgs:[this._behavioralPromptsManager.attachTip("pageWidgetPickerSelectBy",{popupOptions:{attach:null,placement:"bottom"}})]}))),(0,m.dom)("div",{style:"flex-grow: 1"}),(0,c.bigPrimaryButton)(this._options.buttonLabel||b("Add to Page"),m.dom.prop("disabled",(e=>!w(e(this._value.table),e(this._value.type),this._options.isNewPage))),m.dom.on("click",(()=>this._onSave().catch(i.eK))),v("addBtn")))))}_closeSummarizePanel(){this._value.summarize.set(!1),this._value.columns.set([])}_openSummarizePanel(){this._value.summarize.set(!0)}_selectType(e){this._value.type.set(e)}_selectTable(e){e!==this._value.table.get()&&this._value.link.set(r.bG),this._value.table.set(e),this._closeSummarizePanel()}_isSelected(e){return e.classList.contains(E.className+"-selected")}_selectPivot(e,t){this._isSelected(t)?this._closeSummarizePanel():(e!==this._value.table.get()&&(this._value.columns.set([]),this._value.table.set(e),this._value.link.set(r.bG)),this._openSummarizePanel())}_toggleColumnId(e){const t=this._value.columns.get(),o=t.includes(e)?g(t,e):[...t,e];this._value.columns.set(o)}_isTypeDisabled(e,t){return null!==t&&!_(t,this._options.isNewPage).includes(e)}}function I(e,...t){return O((0,m.dom)("h4",e),...t,v("heading"))}const T=(0,m.styled)("div",`\n  --outline: 1px solid ${d.theme.widgetPickerBorder};\n\n  max-height: 386px;\n  box-shadow: 0 2px 20px 0 ${d.theme.widgetPickerShadow};\n  border-radius: 2px;\n  display: flex;\n  flex-direction: column;\n  user-select: none;\n  background-color: ${d.theme.widgetPickerPrimaryBg};\n`),R=(0,m.styled)("div","\n  &:focus {\n    outline: none;\n  }\n"),F=(0,m.styled)("div","\n  display: flex;\n  min-height: 0;\n"),A=(0,m.styled)("div",`\n  width: 224px;\n  font-size: ${d.vars.mediumFontSize};\n  overflow: auto;\n  padding-bottom: 18px;\n  &:nth-of-type(2n) {\n    background-color: ${d.theme.widgetPickerSecondaryBg};\n    outline: var(--outline);\n  }\n`),O=(0,m.styled)("div",`\n  color: ${d.theme.text};\n  margin: 24px 0 24px 24px;\n  font-size: ${d.vars.mediumFontSize};\n`),E=(0,m.styled)("div",`\n  color: ${d.theme.widgetPickerItemFg};\n  padding: 0 0 0 24px;\n  height: 32px;\n  display: flex;\n  flex-direction: row;\n  flex: 1 1 0px;\n  align-items: center;\n  white-space: nowrap;\n  overflow: hidden;\n  cursor: pointer;\n  &-selected {\n    background-color: ${d.theme.widgetPickerItemSelectedBg};\n  }\n  &-disabled {\n    color: ${d.theme.widgetPickerItemDisabledBg};\n    cursor: default;\n  }\n  &-disabled&-selected {\n    background-color: inherit;\n  }\n`),M=(0,m.styled)(u.icon,`\n  margin-right: 8px;\n  flex-shrink: 0;\n  --icon-color: ${d.theme.widgetPickerIcon};\n  .${E.className}-disabled > & {\n    opacity: 0.25;\n  }\n`),P=(0,m.styled)(M,`\n  --icon-color: ${d.theme.widgetPickerPrimaryIcon};\n`),B=(0,m.styled)("span","\n  text-overflow: ellipsis;\n  overflow: hidden;\n"),$=(0,m.styled)(B,"\n  padding-right: 8px;\n"),L=(0,m.styled)("div","\n  display: flex;\n  align-items: center;\n"),N=(0,m.styled)(E,"\n  width: 48px;\n  padding-left: 8px;\n  flex: 0 0 auto;\n"),z=(0,m.styled)(u.icon,`\n  width: 24px;\n  height: 24px;\n  background-color: ${d.theme.widgetPickerSummaryIcon};\n`),V=(0,m.styled)("div","\n  display: flex;\n  border-top: var(--outline);\n"),U=(0,m.styled)("div","\n  flex-grow: 1;\n  height: 65px;\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  padding: 0 24px 0 24px;\n"),j=(0,m.styled)("span",`\n  color: ${d.theme.text};\n  font-size: ${d.vars.xsmallFontSize};\n  margin-right: 8px;\n`),H=(0,m.styled)(m.select,`\n  color: ${d.theme.selectButtonFg};\n  background-color: ${d.theme.selectButtonBg};\n  flex: 1 0 160px;\n  width: 160px;\n`),W=(0,m.styled)("div","\n  display: flex;\n  align-items: center;\n");function G(e,t){const o={};for(const[e,n]of t.entries())o[n]=e;return e.slice().sort(((e,t)=>(0,h.nativeCompare)(o[e],o[t])))}},98108:(e,t,o)=>{"use strict";o.d(t,{QN:()=>he,lX:()=>fe,Ql:()=>pe});var n=o(24412),i=o(13988),s=o(15323),r=o(51536),l=o(29922),a=o(7454),c=o(1370),d=o(83277),u=o(18099),p=o(29301),h=o.n(p),m=o(21467),f=o(70387);const g=(0,f.makeT)("RefSelect");class b extends(179==o.j?u.Disposable:null){constructor(e){super(),this._docModel=e.docModel,this._origColumn=e.origColumn,this._colId=this._origColumn.colId,this.isForeignRefCol=this.autoDispose(h().computed((()=>{const e=this._origColumn.refTable();return Boolean(e&&e.getRowId()!==this._origColumn.parentId())}))),this._fieldObs=this.autoDispose(h().computed((()=>{const t=e.fieldBuilder();return t?t.field:null}))),this._validCols=this.autoDispose(h().computed((()=>{const e=this._origColumn.refTable();return e?e.columns().all().filter((e=>!e.isHiddenCol()&&!d.startsWith(e.type(),"Ref:"))):[]})));const t=this.autoDispose(h().computed((()=>this.isForeignRefCol()&&this._fieldObs()?this._getReferencedCols(this._fieldObs()).map((e=>({label:e.label(),value:e.colId()}))):[])));this._added=this.autoDispose(i.syncedKoArray(t)),this._addedSet=this.autoDispose(h().computed((()=>new Set(this._added.all().map((e=>e.value))))))}buildDom(){return y((0,l.testId)("ref-select"),u.dom.forEach((0,u.fromKo)(this._added.getObservable()),(e=>(0,r.B3)((0,r.Tw)(u.dom.text(e.label)),x("Remove",u.dom.on("click",(()=>this._removeFormulaField(e))),(0,l.testId)("ref-select-remove")),(0,l.testId)("ref-select-item")))),_(w("Plus"),g("Add Column"),(0,m.menu)((()=>[...this._validCols.peek().filter((e=>!this._addedSet.peek().has(e.colId.peek()))).map((e=>(0,m.menuItem)((()=>this._addFormulaField({label:e.label(),value:e.colId()})),e.label.peek()))),v(g("No columns to add")),(0,l.testId)("ref-select-menu")])),(0,l.testId)("ref-select-add")))}async _addFormulaField(e){const t=this._fieldObs();if(!t)return;const o=this._docModel.dataTables[this._origColumn.table().tableId()].tableData,n=this._origColumn.table().columns().all().find((t=>t.formula()===`$${this._colId()}.${e.value}`&&!t.isHiddenCol())),i=t.viewSection().viewFields(),r=i.all().sort(((e,t)=>e.parentPos()>t.parentPos()?1:-1)).findIndex((e=>e.getRowId()===t.getRowId())),l=s.fieldInsertPositions(i,r+1)[0];let a;a=n?Promise.resolve({colRef:n.getRowId(),colId:n.colId()}):o.sendTableAction(["AddColumn",`${this._colId()}_${e.value}`,{type:"Any",isFormula:!0,formula:`$${this._colId()}.${e.value}`,_position:l}]);const c=await a;if(t.viewSection().isRaw())return;const d={colRef:c.colRef,parentId:t.viewSection().getRowId(),parentPos:l};return this._docModel.viewFields.sendTableAction(["AddRecord",null,d])}_removeFormulaField(e){const t=this._docModel.dataTables[this._origColumn.table().tableId()].tableData;this._getReferrerFields(e.value).forEach((e=>{const o=this._fieldObs().viewSection().getRowId();return e.column().viewFields().all().filter((e=>!e.viewSection().isRaw())).some((e=>e.parentId()!==o))?this._docModel.viewFields.sendTableAction(["RemoveRecord",e.getRowId()]):t.sendTableAction(["RemoveColumn",e.column().colId()])}))}_getReferrerFields(e){const t=new RegExp("^\\$"+this._colId()+"\\."+e+"$");return this._fieldObs().viewSection().viewFields().all().filter((e=>t.exec(e.column().formula())))}_getReferencedCols(e){const t=this._getFormulaMatchSet(e);return this._validCols().filter((e=>t.has(e.colId())))}_getFormulaMatchSet(e){const t=e.viewSection().viewFields().all(),o=new RegExp("^\\$"+this._colId()+"\\.(\\w+)$");return new Set(t.map((e=>{const t=o.exec(e.column().formula());return t?t[1]:null})))}}const y=(0,u.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  width: 100%;\n\n  & > .${r.B3.className} {\n    margin: 2px 0;\n  }\n`),v=(0,u.styled)(c.menuText,"\n  font-size: inherit;\n  &:not(:first-child) {\n    display: none;\n  }\n"),_=(0,u.styled)("div",`\n  display: flex;\n  cursor: pointer;\n  color: ${l.colors.lightGreen};\n  --icon-color: ${l.colors.lightGreen};\n\n  &:not(:first-child) {\n    margin-top: 8px;\n  }\n  &:hover, &:focus, &:active {\n    color: ${l.colors.darkGreen};\n    --icon-color: ${l.colors.darkGreen};\n  }\n`),w=(0,u.styled)(a.icon,"\n  margin-right: 4px;\n"),x=(0,u.styled)(a.icon,`\n  display: none;\n  cursor: pointer;\n  flex: none;\n  margin-left: 8px;\n  .${r.B3.className}:hover & {\n    display: block;\n  }\n`);var C=o(88101),D=o(62258),k=o(56209),S=o(38109),I=o(32529),T=o(3411),R=o(92478);const F=(0,f.makeT)("GridOptions");class A extends(179==o.j?u.Disposable:null){constructor(e){super(),this._section=e}buildDom(){const e=this._section;return[(0,T.cssLabel)(F("Grid Options")),(0,u.dom)("div",[(0,T.cssRow)(E(O(0,e.optionsObj.prop("verticalGridlines"))),F("Vertical Gridlines"),(0,l.testId)("v-grid-button")),(0,T.cssRow)(E(O(0,e.optionsObj.prop("horizontalGridlines"))),F("Horizontal Gridlines"),(0,l.testId)("h-grid-button")),(0,T.cssRow)(E(O(0,e.optionsObj.prop("zebraStripes"))),F("Zebra Stripes"),(0,l.testId)("zebra-stripe-button")),(0,l.testId)("grid-options")])]}}function O(e,t){const o=u.Computed.create(null,(e=>e(t)));return o.onWrite((async e=>{await(0,I.setSaveValue)(t,e)})),o}const E=(0,u.styled)(R.n2,"\n  margin-right: 8px;\n");var M=o(22641),P=o(21602),B=o(73783),$=o(82882),L=o(92769),N=o(11187),z=o(13884),V=o(29002),U=o(4425),j=o(21296);const H=(0,f.makeT)("CustomSectionConfig"),W="custom",G=(0,u.makeTestId)("test-config-widget-");class Y extends(179==o.j?u.Disposable:null){constructor(e,t,o){super(),this._value=e,this._column=t,this._section=o}buildDom(){const e=u.Computed.create(this,(e=>{const t=e(this._value);return Array.isArray(t)?null:t}));e.onWrite((e=>this._value.set(e)));const t=u.Computed.create(this,(e=>e(this._section.columns).filter((t=>this._column.canByMapped(e(t.pureType)))).map((t=>({value:t.getRowId(),label:e(t.label),icon:"FieldColumn"})))));return[(0,T.cssLabel)(this._column.title,this._column.optional?ie(H(" (optional)")):null,G("label-for-"+this._column.name)),this._column.description?(0,T.cssHelp)(this._column.description,G("help-for-"+this._column.name)):null,(0,T.cssRow)((0,c.select)(e,t,{defaultLabel:"any"!=this._column.typeDesc?H("Pick a {{columnType}} column",{columnType:this._column.typeDesc}):H("Pick a column")}),G("mapping-for-"+this._column.name))]}}class K extends(179==o.j?u.Disposable:null){constructor(e,t,o){super(),this._value=e,this._column=t,this._section=o,this._typeFilter=(e=d.unwrap)=>t=>this._column.canByMapped(e(t.pureType))}buildDom(){return u.dom.domComputed((e=>[(0,T.cssLabel)(this._column.title,T.cssLabel.cls("-required",!this._column.optional),G("label-for-"+this._column.name)),this._buildDraggableList(e),this._buildAddColumn()]))}_buildAddColumn(){return[(0,T.cssRow)(se(oe("Plus"),H("Add")+" "+this._column.title,(0,c.menu)((()=>{const e=this._getNotMappedColumns(),t=e.filter(this._typeFilter()),o=e.length-t.length;return[...t.map((e=>(0,c.menuItem)((()=>this._addColumn(e)),e.label.peek()))),o>0?(0,c.menuText)(H("{{wrongTypeCount}} non-{{columnType}} columns are not shown",{wrongTypeCount:o,columnType:this._column.type.toLowerCase(),count:o}),G("map-message-"+this._column.name)):null]})),G("add-column-for-"+this._column.name)))]}_buildDraggableList(e){return u.dom.update(B.draggableList(this._readItems(e),this._renderItem.bind(this,e),{itemClass:r.KM.className,reorder:this._reorder.bind(this),receive:this._addColumn.bind(this),drag_indicator:z.x}),G("map-list-for-"+this._column.name))}_getNotMappedColumns(){const e=this._section.columns.peek(),t=this._list();return e.filter((e=>!t.includes(e.id.peek())))}_readItems(e){let t=e(this._value)||[];Array.isArray(t)||(t=[]);const o=e(this._section.columns).filter(this._typeFilter(e)),n=new Map(o.map((e=>[e.id.peek(),e])));return t.map((e=>n.get(e))).filter((e=>Boolean(e)))}_renderItem(e,t){return(0,r.B3)((0,r.Tw)(u.dom.text(t.label),G("ref-select-label")),ne("Remove",u.dom.on("click",(()=>this._remove(t))),G("ref-select-remove")))}_list(e){if(!e){let e=this._value.get()||[];return Array.isArray(e)||(e=[]),e}this._value.set(e)}_reorder(e,t){const o=e.id.peek(),n=null==t?void 0:t.id.peek(),i=this._list(),s=i.indexOf(o);i.splice(s,1);const r=n?i.indexOf(n):i.length;i.splice(r,0,o),this._list(i)}_remove(e){const t=this._list();this._value.set(t.filter((t=>t!=e.id.peek())))}_addColumn(e){const t=this._list();t.push(e.id.peek()),this._value.set(t)}}class q extends(179==o.j?u.Disposable:null){constructor(e,t){var o;super(),this._section=e,this._canSelect=!0;const n=t.app.topAppModel.api,i=window.gristConfig||{};this._canSelect=null==(o=i.enableWidgetRepository)||o,this._widgets=u.Observable.create(this,[]),this._canSelect&&(e.customDef.widgetDef.peek()&&this._widgets.set([e.customDef.widgetDef.peek()]),n.getWidgets().then((t=>{if(this.isDisposed())return;const o=e.customDef.widgetDef.peek();o&&!t.some((e=>e.widgetId===o.widgetId))&&t.push(o),this._widgets.set(t.sort(((e,t)=>(0,d.nativeCompare)(e.name.toLowerCase(),t.name.toLowerCase()))))})).catch(L.reportError)),this._selectedId=u.Computed.create(this,(t=>t(e.customDef.widgetDef)?e.customDef.widgetDef.peek().widgetId:W)),this._selectedId.onWrite((async t=>{var o;if(t===W)(0,u.bundleChanges)((()=>{e.customDef.url(null),e.customDef.widgetDef(null),e.customDef.access(j.u.none),e.customDef.widgetOptions(null),e.hasCustomOptions(!1),e.customDef.columnsMapping(null),e.columnsToMap(null),this._desiredAccess.set(j.u.none)})),await e.saveCustomDef();else{const n=this._widgets.get().find((e=>e.widgetId===t));if(!n)throw new Error("Error accessing widget from the list");if((null==(o=e.customDef.widgetDef.peek())?void 0:o.widgetId)===t)return;(0,u.bundleChanges)((()=>{e.customDef.access(j.u.none),this._desiredAccess.set(n.accessLevel||j.u.none),e.customDef.widgetDef(n),e.customDef.url(n.url),e.customDef.widgetOptions(null),e.hasCustomOptions(!1),e.customDef.columnsMapping(null),e.columnsToMap(null)})),await e.saveCustomDef()}})),this._url=u.Computed.create(this,(t=>t(e.customDef.url)||"")),this._url.onWrite((t=>e.customDef.url.setAndSave(t))),this._currentAccess=u.Computed.create(this,(t=>t(e.customDef.access)||j.u.none)),this._currentAccess.onWrite((async t=>{await e.customDef.access.setAndSave(t)})),this._desiredAccess=(0,u.fromKo)(e.desiredAccessLevel),this.autoDispose(e.id.subscribe((()=>this._reject()))),this._hasConfiguration=u.Computed.create(this,(t=>t(e.hasCustomOptions)))}buildDom(){const e=new u.MultiHolder,t=u.Computed.create(e,(e=>e(this._desiredAccess)&&!(0,j.Z)(e(this._currentAccess),e(this._desiredAccess)))),o=u.Computed.create(e,(e=>Boolean(e(this._selectedId)))),n=u.Computed.create(e,(e=>e(this._selectedId)===W||!this._canSelect)),i=u.Computed.create(e,(e=>[{label:"Custom URL",value:"custom"},...e(this._widgets).map((e=>({label:e.name,value:e.widgetId})))])),s=[{label:H("No document access"),value:j.u.none},{label:H("Read selected table"),value:j.u.read_table},{label:H("Full document access"),value:j.u.full}];return(0,u.dom)("div",u.dom.autoDispose(e),this._canSelect?(0,T.cssRow)((0,c.select)(this._selectedId,i,{defaultLabel:H("Select Custom Widget"),menuCssClass:te.className}),G("select")):null,u.dom.maybe(n,(()=>[(0,T.cssRow)(re(this._url,(async e=>this._url.set(e)),u.dom.attr("placeholder",H("Enter Custom URL")),G("url")))])),u.dom.maybe(t,(()=>B.prompt({tabindex:"-1"},Z(J((0,a.icon)("Lock")),(0,u.dom)("div",Q(u.dom.domComputed(this._desiredAccess,(e=>function(e){if(!e)return null;switch(e){case j.u.none:return X(H("Widget does not require any permissions."));case j.u.read_table:return X(H("Widget needs to {{read}} the current table.",{read:(0,u.dom)("b","read")}));case j.u.full:return X(H("Widget needs {{fullAccess}} to this document.",{fullAccess:(0,u.dom)("b","full access")}));default:throw new Error(`Unsupported ${e} access level`)}}(e)))),Q((0,N.primaryButton)("Accept",G("access-accept"),u.dom.on("click",(()=>this._accept()))),(0,N.basicButton)("Reject",G("access-reject"),u.dom.on("click",(()=>this._reject()))))))))),u.dom.maybe((e=>e(o)||!this._canSelect),(()=>[(0,T.cssLabel)("ACCESS LEVEL"),(0,T.cssRow)((0,c.select)(this._currentAccess,s),G("access"))])),u.dom.maybe(this._hasConfiguration,(()=>ee((0,N.textButton)(H("Open configuration"),u.dom.on("click",(()=>this._openConfiguration())),G("open-configuration"))))),ee((0,U.Y3)(u.dom.attr("href","https://support.getgrist.com/widget-custom"),u.dom.attr("target","_blank"),H("Learn more about custom widgets"))),u.dom.maybeOwned((e=>e(this._section.columnsToMap)),((e,t)=>{const o=t=>{const o=u.Computed.create(e,(e=>(e(this._section.customDef.columnsMapping)||{})[t.name]));return o.onWrite((async e=>{const o=this._section.customDef.columnsMapping.peek()||{};o[t.name]=e,await this._section.customDef.columnsMapping.setAndSave(o)})),o},n=t.map((e=>new $.V(e))).map((e=>({value:o(e),column:e})));return[(0,T.cssSeparator)(),...n.map((e=>e.column.allowMultiple?u.dom.create(K,e.value,e.column,this._section):u.dom.create(Y,e.value,e.column,this._section)))]})))}_openConfiguration(){n.allCommands.openWidgetConfiguration.run()}_accept(){this._desiredAccess.get()&&this._currentAccess.set(this._desiredAccess.get()),this._reject()}_reject(){this._desiredAccess.set(null)}}const J=(0,u.styled)("div",`\n  padding-left: 8px;\n  padding-top: 6px;\n  --icon-color: ${l.colors.error}\n`),Z=(0,u.styled)("div","\n  display: flex;\n"),Q=(0,u.styled)("div","\n  display: flex;\n  padding: 8px;\n  gap: 8px;\n"),X=(0,u.styled)("span","\n  white-space: pre-wrap;\n"),ee=(0,u.styled)("div","\n  margin: 16px 16px 12px 16px;\n"),te=(0,u.styled)("div",`\n  & > li:first-child {\n    border-bottom: 1px solid ${l.colors.mediumGrey};\n  }\n`),oe=(0,u.styled)(a.icon,"\n  margin-right: 4px;\n"),ne=(0,u.styled)(a.icon,`\n  display: none;\n  cursor: pointer;\n  flex: none;\n  margin-left: 8px;\n  .${r.B3.className}:hover & {\n    display: block;\n  }\n`),ie=(0,u.styled)("span",`\n  text-transform: none;\n  font-size: ${l.vars.xsmallFontSize};\n  color: ${l.colors.slate};\n`),se=(0,u.styled)("div",`\n  display: flex;\n  cursor: pointer;\n  color: ${l.colors.lightGreen};\n  --icon-color: ${l.colors.lightGreen};\n\n  &:not(:first-child) {\n    margin-top: 8px;\n  }\n  &:hover, &:focus, &:active {\n    color: ${l.colors.darkGreen};\n    --icon-color: ${l.colors.darkGreen};\n  }\n`),re=(0,u.styled)(V.textInput,`\n  flex: 1 0 auto;\n\n  &:disabled {\n    color: ${l.colors.slate};\n    background-color: ${l.colors.lightGrey};\n    pointer-events: none;\n  }\n`);var le=o(90098),ae=o(45689);const ce=(0,f.makeT)("RightPanel"),de=(0,ae.U)("pageWidget","field"),ue=(0,ae.U)("widget","sortAndFilter","data");function pe(e){const t=new Map([["record",{label:ce("Columns",{count:1}),icon:"TypeCell",pluralLabel:ce("Columns",{count:2})}],["detail",{label:ce("Fields",{count:1}),icon:"TypeCell",pluralLabel:ce("Fields",{count:2})}],["single",{label:ce("Fields",{count:1}),icon:"TypeCell",pluralLabel:ce("Fields",{count:2})}],["chart",{label:ce("Series",{count:1}),icon:"ChartLine",pluralLabel:ce("Series",{count:2})}],["custom",{label:ce("Columns",{count:1}),icon:"TypeCell",pluralLabel:ce("Columns",{count:2})}]]);return t.get(e||"record")||t.get("record")}class he extends(179==o.j?u.Disposable:null){constructor(e,t){super(),this._gristDoc=e,this._isOpen=t,this._topTab=(0,k.h4)(this,"rightTopTab","pageWidget",de.guard),this._subTab=(0,k.h4)(this,"rightPageSubTab","widget",ue.guard),this._pageWidgetType=u.Computed.create(this,(e=>{const t=e(this._gristDoc.viewModel.activeSection);return e(t.parentKey)||null})),this._validSection=u.Computed.create(this,(e=>{const t=e(this._gristDoc.viewModel.activeSection);return t.getRowId()?t:null})),this._extraTool=e.rightPanelTool,this.autoDispose((0,u.subscribe)(this._extraTool,((e,o)=>o&&t.set(!0)))),this.header=this._buildHeaderDom(),this.content=this._buildContentDom(),this.autoDispose(n.createGroup({fieldTabOpen:()=>this._openFieldTab(),viewTabOpen:()=>this._openViewTab(),sortFilterTabOpen:()=>this._openSortFilter(),dataSelectionTabOpen:()=>this._openDataSelection()},this,!0))}_openFieldTab(){this._open("field")}_openViewTab(){this._open("pageWidget","widget")}_openSortFilter(){this._open("pageWidget","sortAndFilter")}_openDataSelection(){this._open("pageWidget","data")}_open(e,t){(0,u.bundleChanges)((()=>{this._isOpen.set(!0),this._topTab.set(e),t&&this._subTab.set(t)}))}_buildHeaderDom(){return u.dom.domComputed((e=>{if(!e(this._isOpen))return null;const t=e(this._extraTool);return t?this._buildToolHeader(t):this._buildStandardHeader()}))}_buildToolHeader(e){return we(xe(e.icon),e.label,Ce(De("CrossBig"),u.dom.on("click",(()=>this._gristDoc.showTool("none"))),(0,l.testId)("right-tool-close")),we.cls("-selected",!0))}_buildStandardHeader(){return u.dom.maybe(this._pageWidgetType,(e=>{const t=le.e.get(e)||{label:"Table",icon:"TypeTable"},o=pe(e);return[we(xe(t.icon),t.label,we.cls("-selected",(e=>"pageWidget"===e(this._topTab))),u.dom.on("click",(()=>this._topTab.set("pageWidget"))),(0,l.testId)("right-tab-pagewidget")),we(xe(o.icon),o.label,we.cls("-selected",(e=>"field"===e(this._topTab))),u.dom.on("click",(()=>this._topTab.set("field"))),(0,l.testId)("right-tab-field"))]}))}_buildContentDom(){return u.dom.domComputed((e=>{if(!e(this._isOpen))return null;const t=e(this._extraTool);if(t)return function(e){function t(e){return(0,u.dom)("div.config_item",u.dom.show(e.showObs||!0),e.buildDom())}return"buildDom"in e?e.buildDom():Ie(u.dom.forEach(e,(e=>e.header?(0,u.dom)("div.config_group",u.dom.show(e.showObs||!0),e.label?(0,u.dom)("div.config_header",e.label):null,u.dom.forEach(e.items,(e=>t(e)))):t(e))))}(t.content);const o=e(this._topTab);return"field"===o?u.dom.create(this._buildFieldContent.bind(this)):"pageWidget"===o&&e(this._pageWidgetType)?u.dom.create(this._buildPageWidgetContent.bind(this)):null}))}_buildFieldContent(e){var t;const o=e.autoDispose(p.computed((()=>{var e,t;const o=null==(t=(e=this._gristDoc.viewModel).activeSection)?void 0:t.call(e).viewInstance();return o&&o.activeFieldBuilder()}))),n=e.autoDispose(p.computed((()=>{var e,t,n;const i=null==(t=(e=this._gristDoc.viewModel).activeSection)?void 0:t.call(e).viewInstance();if(i&&i.selectedColumns)return i.selectedColumns();const s=null==(n=o())?void 0:n.field;return s?[s]:[]}))),i=e.autoDispose(p.pureComputed((()=>{const e=n();return Boolean(e&&e.length>1)})));e.autoDispose(n.subscribe((t=>{if(e.isDisposed()||this._gristDoc.isDisposed()||this._gristDoc.viewModel.isDisposed())return;const o=this._gristDoc.viewModel.activeSection();o&&!o.isDisposed()&&o.selectedFields(t||[])}))),null==(t=this._gristDoc.viewModel.activeSection())||t.selectedFields(n.peek()||[]);const s=this._gristDoc.docModel,r=e.autoDispose(p.computed((()=>{var e;return(null==(e=o())?void 0:e.origColumn.origColRef())||0}))),a=e.autoDispose(s.columns.createFloatingRowModel(r)),c=e.autoDispose(p.computed((()=>Boolean(r())))),d=b.create(e,{docModel:s,origColumn:a,fieldBuilder:o}),h=e.autoDispose(p.computed((()=>{var e,t,o;const n=null==(t=(e=this._gristDoc.viewModel).activeSection)?void 0:t.call(e).viewInstance();return null!=(o=null==n?void 0:n.cursor.currentPosition())?o:{}})));return(0,C.b)(D.nt().then((e=>{const{buildNameConfig:t,buildFormulaConfig:n}=e.FieldConfig;return u.dom.maybe(c,(()=>fe(Pe(u.dom.create(t,a,h,i)),Te(),Pe(u.dom.create(n,a,this._gristDoc,this._activateFormulaEditor.bind(this))),Te(),u.dom.maybe(o,(e=>[(0,T.cssLabel)(ce("COLUMN TYPE")),Pe(e.buildSelectTypeDom()),Pe(e.buildSelectWidgetDom()),Pe(e.buildConfigDom()),e.buildColorConfigDom(),Pe(e.buildSettingOptions(),u.dom.maybe(i,(()=>me())))])),Te(),Pe(u.dom.maybe(d.isForeignRefCol,(()=>[(0,T.cssLabel)("Add referenced columns"),ye(d.buildDom()),Te()])),(0,T.cssLabel)(ce("TRANSFORM")),u.dom.maybe(o,(e=>e.buildTransformDom())),u.dom.maybe(i,(()=>me())),(0,l.testId)("panel-transform")),this._disableIfReadonly())))})))}_activateFormulaEditor(e,t,o,n){const i=this._gristDoc.viewModel.activeSection().viewInstance();if(!i)return;const s=i.moveEditRowToCursor();return i.activeFieldBuilder.peek().openSideFormulaEditor(s,e,t,o,n)}_buildPageWidgetContent(e){return[ke(Se(ce("Widget"),Se.cls("-selected",(e=>"widget"===e(this._subTab))),u.dom.on("click",(()=>this._subTab.set("widget"))),(0,l.testId)("config-widget")),Se(ce("Sort & Filter"),Se.cls("-selected",(e=>"sortAndFilter"===e(this._subTab))),u.dom.on("click",(()=>this._subTab.set("sortAndFilter"))),(0,l.testId)("config-sortAndFilter")),Se(ce("Data"),Se.cls("-selected",(e=>"data"===e(this._subTab))),u.dom.on("click",(()=>this._subTab.set("data"))),(0,l.testId)("config-data"))),u.dom.domComputed(this._subTab,(e=>u.dom.maybe(this._validSection,(t=>fe("widget"===e?u.dom.create(this._buildPageWidgetConfig.bind(this),t):"sortAndFilter"===e?u.dom.create(this._buildPageSortFilterConfig.bind(this)):"data"===e?u.dom.create(this._buildPageDataConfig.bind(this),t):null)))))]}_createViewConfigTab(e){const t=u.Observable.create(e,null),o=this._gristDoc;return D.nt().then((n=>{e.isDisposed()||t.set(e.autoDispose(n.ViewConfigTab.create({gristDoc:o,viewModel:o.viewModel})))})).catch(S.eK),t}_buildPageWidgetConfig(e,t){const o=this._createViewConfigTab(e),n=u.Computed.create(e,(e=>{const o="custom"===e(this._pageWidgetType),n=e(t.columnsToMap);return Boolean(o&&n)}));return u.dom.maybe(o,(o=>[this._disableIfReadonly(),(0,T.cssLabel)(u.dom.text((e=>e(t.isRaw)?ce("DATA TABLE NAME"):ce("WIDGET TITLE"))),u.dom.style("margin-bottom","14px")),ye(Me(u.Computed.create(e,(e=>e(t.titleDef))),(e=>t.titleDef.saveOnly(e)),u.dom.boolAttr("disabled",(e=>{const o=e(t.isRaw),n=0!==e(e(t.table).summarySourceTable);return o&&n})),(0,l.testId)("right-widget-title"))),u.dom.maybe((e=>!e(t.isRaw)),(()=>ye((0,N.primaryButton)(ce("Change Widget"),this._createPageWidgetPicker()),ye.cls("-top-space")))),Te(),u.dom.maybe((e=>["detail","single"].includes(e(this._pageWidgetType))),(()=>[(0,T.cssLabel)(ce("Theme")),(0,u.dom)("div",o._buildThemeDom(),o._buildLayoutDom())])),(0,u.domComputed)((e=>"record"!==e(this._pageWidgetType)?null:u.dom.create(A,t))),(0,u.domComputed)((e=>"record"!==e(this._pageWidgetType)?null:[Te(),(0,T.cssLabel)(ce("ROW STYLE")),(0,C.b)(D.nt().then((e=>u.dom.create(e.ConditionalStyle,ce("Row Style"),t,this._gristDoc))))])),u.dom.maybe((e=>"chart"===e(this._pageWidgetType)),(()=>[(0,T.cssLabel)(ce("CHART TYPE")),o._buildChartConfigDom()])),u.dom.maybe((e=>"custom"===e(this._pageWidgetType)),(()=>{const e=o._buildCustomTypeItems();return[(0,T.cssLabel)(ce("CUSTOM")),u.dom.maybe((e=>e(this._gristDoc.app.features).customViewPlugin),(()=>(0,u.dom)("div",e[0].buildDom()))),u.dom.maybe((e=>"plugin"===e(t.customDef.mode)),(()=>(0,u.dom)("div",e[2].buildDom()))),u.dom.maybe((e=>"url"===e(t.customDef.mode)),(()=>u.dom.create(q,t,this._gristDoc)))]})),u.dom.maybe((e=>!(e(n)||"chart"===e(this._pageWidgetType)||e(t.isRaw))),(()=>[Te(),u.dom.create(r.M1,this._gristDoc,t)]))]))}_buildPageSortFilterConfig(e){const t=this._createViewConfigTab(e);return u.dom.maybe(t,(e=>e.buildSortFilterDom()))}_buildPageDataConfig(e,t){const o=this._createViewConfigTab(e),n=this._gristDoc.viewModel,i=t.table,s=u.Computed.create(e,(e=>e(e(i).groupByColumns))),r=u.Computed.create(e,(e=>(0,P.N3)({srcSectionRef:e(t.linkSrcSectionRef),srcColRef:e(t.linkSrcColRef),targetColRef:e(t.linkTargetColRef)}))),a=u.Observable.create(e,!1),d=u.Computed.create(e,(e=>(e(a),(0,P.Kg)(this._gristDoc.docModel,n.viewSections().all(),t))));return r.onWrite((e=>this._gristDoc.saveLink(e))),[this._disableIfReadonly(),(0,T.cssLabel)(ce("DATA TABLE")),ye(_e("TypeTable"),Fe(ce("SOURCE DATA")),Ae(u.dom.text((e=>e(e(i).primaryTableId))),(0,l.testId)("pwc-table"))),(0,u.dom)("div",ye(_e("Pivot"),Fe(ce("GROUPED BY"))),ye((0,u.domComputed)(s,(e=>Oe(e.map((e=>Ee(u.dom.text(e.label),(0,l.testId)("pwc-groupedBy-col")))))))),(0,l.testId)("pwc-groupedBy"),u.dom.hide((e=>!e(e(i).summarySourceTable)))),u.dom.maybe((e=>!e(t.isRaw)),(()=>ve((0,N.primaryButton)(ce("Edit Data Selection"),this._createPageWidgetPicker(),(0,l.testId)("pwc-editDataSelection")),u.dom.maybe((e=>Boolean(e(e(t.table).summarySourceTable))),(()=>(0,N.basicButton)(ce("Detach"),u.dom.on("click",(()=>this._gristDoc.docData.sendAction(["DetachSummaryViewSection",t.getRowId()]))),(0,l.testId)("detach-button")))),ye.cls("-top-space")))),u.dom.maybe(o,(e=>ye((0,u.dom)("div",e._buildAdvancedSettingsDom())))),Te(),u.dom.maybe((e=>!e(t.isRaw)),(()=>[(0,T.cssLabel)(ce("SELECT BY")),ye(u.dom.update((0,c.select)(r,d,{defaultLabel:ce("Select Widget")}),u.dom.on("click",(()=>{a.set(!a.get())}))),(0,l.testId)("right-select-by"))])),(0,u.domComputed)((e=>{const o=t.getRowId(),i=e(e(n.viewSections).getObservable()).filter((t=>e(t.linkSrcSectionRef)===o));return i.length?[(0,T.cssLabel)(ce("SELECTOR FOR"),(0,l.testId)("selector-for")),ye(Oe(i.map((e=>this._buildSectionItem(e)))))]:null}))]}_createPageWidgetPicker(){const e=this._gristDoc,t=e.viewModel.activeSection,o=o=>e.saveViewSection(t.peek(),o);return n=>{(0,M.lt)(n,e,o,{buttonLabel:ce("Save"),value:()=>(0,M.FU)(t.peek()),selectBy:t=>e.selectBy(t)})}}_buildSectionItem(e){return Ee(u.dom.text(e.titleDef),(0,l.testId)("selector-for-entry"))}_disableIfReadonly(){if(this._gristDoc.docPageModel)return u.dom.maybe(this._gristDoc.docPageModel.isReadonly,(()=>ge((0,l.testId)("disable-overlay"),be(ce("You do not have edit access to this document")))))}}function me(){return ge((0,l.testId)("panel-disabled-section"))}function fe(...e){return Re((0,u.dom)("div",{style:"position: relative; padding-top: 1px;"},...e))}const ge=(0,u.styled)("div",`\n  background-color: ${l.theme.rightPanelDisabledOverlay};\n  opacity: 0.8;\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  z-index: 100;\n`),be=(0,u.styled)("span",`\n  color: ${l.theme.text};\n  position: absolute;\n  bottom: -40px;\n  padding: 4px 16px;\n`),ye=(0,u.styled)("div",`\n  color: ${l.theme.text};\n  display: flex;\n  margin: 8px 16px;\n  align-items: center;\n  &-top-space {\n    margin-top: 24px;\n  }\n  &-disabled {\n    color: ${l.theme.disabledText};\n  }\n`),ve=(0,u.styled)(ye,"\n  margin-left: 0;\n  margin-right: 0;\n  & > button {\n    margin-left: 16px;\n  }\n"),_e=(0,u.styled)(a.icon,`\n  flex: 0 0 auto;\n  --icon-color: ${l.theme.lightText};\n`),we=(0,u.styled)("div",`\n  flex: 1 1 0px;\n  height: 100%;\n  background-color: ${l.theme.rightPanelTabBg};\n  font-weight: ${l.vars.headerControlTextWeight};\n  color: ${l.theme.rightPanelTabFg};\n  --icon-color: ${l.theme.rightPanelTabIcon};\n  display: flex;\n  align-items: center;\n  cursor: default;\n\n  &-selected {\n    background-color: ${l.theme.rightPanelTabSelectedBg};\n    font-weight: initial;\n    color: ${l.theme.rightPanelTabSelectedFg};\n    --icon-color: ${l.theme.rightPanelTabSelectedFg};\n  }\n  &:not(&-selected):hover {\n    background-color: ${l.theme.rightPanelTabHoverBg};\n    --icon-color: ${l.theme.rightPanelTabIconHover};\n  }\n`),xe=(0,u.styled)(a.icon,"\n  flex: none;\n  margin: 16px;\n  height: 16px;\n  width: 16px;\n  background-color: var(--icon-color);\n"),Ce=(0,u.styled)("div",`\n  margin-left: auto;\n  margin-right: 8px;\n  width: 32px;\n  height: 32px;\n  background: none;\n  border-radius: 16px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n\n  &:hover {\n    background-color: ${l.theme.rightPanelTabButtonHoverBg};\n  }\n`),De=(0,u.styled)(a.icon,"\n  height: 16px;\n  width: 16px;\n  background-color: var(--icon-color);\n"),ke=(0,u.styled)("div","\n  height: 48px;\n  flex: none;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n"),Se=(0,u.styled)("div",`\n  color: ${l.theme.rightPanelSubtabFg};\n  flex: auto;\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  justify-content: flex-end;\n  text-align: center;\n  padding-bottom: 8px;\n  border-bottom: 1px solid ${l.theme.pagePanelsBorder};\n  cursor: default;\n\n  &-selected {\n    color: ${l.theme.rightPanelSubtabSelectedFg};\n    border-bottom: 1px solid ${l.theme.rightPanelSubtabSelectedUnderline};\n  }\n  &:not(&-selected):hover {\n    color: ${l.theme.rightPanelSubtabHoverFg};\n  }\n  &:hover {\n    border-bottom: 1px solid ${l.theme.rightPanelSubtabHoverUnderline};\n  }\n  .${ke.className}:hover > &-selected:not(:hover) {\n    border-bottom: 1px solid ${l.theme.pagePanelsBorder};\n  }\n`),Ie=(0,u.styled)("div","\n  padding: 16px 8px;\n  overflow: auto;\n"),Te=(0,u.styled)("div",`\n  border-bottom: 1px solid ${l.theme.pagePanelsBorder};\n  margin-top: 16px;\n`),Re=(0,u.styled)("div",'\n  overflow: auto;\n  --color-list-item: none;\n  --color-list-item-hover: none;\n\n  &:after {\n    content: "";\n    display: block;\n    height: 40px;\n  }\n  & .fieldbuilder_settings {\n    margin: 16px 0 0 0;\n  }\n'),Fe=(0,u.styled)("div",`\n  flex: 0 0 81px;\n  color: ${l.theme.lightText};\n  font-size: ${l.vars.xsmallFontSize};\n  margin-left: 4px;\n  margin-top: 2px;\n`),Ae=(0,u.styled)("div","\n  flex: 0 1 auto;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  min-width: 1em;\n"),Oe=(0,u.styled)("div","\n  list-style: none;\n  width: 100%;\n"),Ee=(0,u.styled)("li",`\n  background-color: ${l.theme.hover};\n  border-radius: 2px;\n  margin-bottom: 4px;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  width: 100%;\n  padding: 4px 8px;\n`),Me=(0,u.styled)(V.textInput,`\n  flex: 1 0 auto;\n  color: ${l.theme.inputFg};\n  background-color: ${l.theme.inputBg};\n\n  &:disabled {\n    color: ${l.theme.inputDisabledFg};\n    background-color: ${l.theme.inputDisabledBg};\n    pointer-events: none;\n  }\n`),Pe=(0,u.styled)("div","\n  position: relative;\n")},3411:(e,t,o)=>{"use strict";o.r(t),o.d(t,{cssBlockedCursor:()=>u,cssButtonRow:()=>p,cssHelp:()=>a,cssIcon:()=>r,cssLabel:()=>l,cssPinButton:()=>f,cssRow:()=>c,cssSaveButtonsRow:()=>m,cssSeparator:()=>h,cssSortFilterColumn:()=>d});var n=o(29922),i=o(7454),s=o(18099);const r=(0,s.styled)(i.icon,`\n  flex: 0 0 auto;\n  --icon-color: ${n.theme.lightText};\n`),l=(0,s.styled)("div",`\n  color: ${n.theme.text};\n  text-transform: uppercase;\n  margin: 16px 16px 12px 16px;\n  font-size: ${n.vars.xsmallFontSize};\n`),a=(0,s.styled)("div",`\n  margin: -8px 16px 12px 16px;\n  font-style: italic;\n  font-size: ${n.vars.xsmallFontSize};\n`),c=(0,s.styled)("div",`\n  display: flex;\n  margin: 8px 16px;\n  align-items: center;\n  color: ${n.theme.text};\n  &-top-space {\n    margin-top: 24px;\n  }\n  &-disabled {\n    color: ${n.theme.disabledText};\n  }\n`),d=(0,s.styled)("div",`\n  cursor: pointer;\n  display: flex;\n  flex-grow: 1;\n  align-items: center;\n  color: ${n.theme.text};\n  background-color: ${n.theme.hover};\n  overflow: hidden;\n  border-radius: 4px;\n  padding: 4px 8px;\n`),u=(0,s.styled)("span","\n  &, & * {\n    cursor: not-allowed !important;\n  }\n"),p=(0,s.styled)(c,"\n  margin-left: 0;\n  margin-right: 0;\n  & > button {\n    margin-left: 16px;\n  }\n"),h=(0,s.styled)("div",`\n  border-bottom: 1px solid ${n.theme.pagePanelsBorder};\n  margin-top: 16px;\n`),m=(0,s.styled)("div","\n  margin: 16px 16px 12px 16px;\n"),f=(0,s.styled)("div",`\n  cursor: pointer;\n  --icon-color: ${n.theme.controlSecondaryFg};\n  border-radius: ${n.vars.controlBorderRadius};\n  padding: 3px;\n\n  &-pinned {\n    background-color: ${n.theme.controlPrimaryBg};\n    --icon-color: ${n.theme.controlPrimaryFg};\n  }\n\n  &:not(&-pinned):hover {\n    background-color: ${n.theme.hover};\n  }\n`)},21376:(e,t,o)=>{"use strict";o.d(t,{m:()=>w});var n=o(13988),i=o.n(n),s=o(73783),r=o(70387),l=o(52064),a=o(59793),c=o(3411),d=o(92478),u=o(29922),p=o(13884),h=o(1370),m=o(48210),f=o(18099),g=o(21467);const b=o(29274),y=o(36812),v=(0,f.makeTestId)("test-sort-config-"),_=(0,r.makeT)("SortConfig");class w extends f.Disposable{constructor(e,t,o={}){super(),this._section=e,this._gristDoc=t,this._options=o,this._columns=f.Computed.create(this,(e=>e(e(e(this._section.table).columns).getObservable()).filter((t=>!e(t.isHiddenCol))).map((t=>({label:e(t.label),value:t.getRowId(),icon:"FieldColumn",type:t.type()}))))),this._colRefs=f.Computed.create(this,(e=>e(this._section.activeSortSpec).map((e=>m.Sort.getColRef(e))))),this._sortRows=this.autoDispose(i()(this._colRefs.get())),this._changedColRefs=f.Computed.create(this,(e=>{const t=b(e(this._section.activeSortSpec),m.Sort.parseSortColRefs(e(this._section.sortColRefs)));return new Set(t.map((e=>m.Sort.getColRef(e))))})),this.autoDispose(this._colRefs.addListener(((e,t)=>{y(e,t)||this._sortRows.assign(e)})))}buildDom(){return(0,f.dom)("div",s.draggableList(this._sortRows,(e=>this._createRow(e)),{reorder:(e,t)=>this._reorder(e,t),removeButton:!1,drag_indicator:p.x,itemClass:x.className}),this._buildAddToSortButton(this._columns),this._buildUpdateDataButton(),v("container"))}_createRow(e){return this._buildSortRow(e,this._section.activeSortSpec,this._columns)}_buildSortRow(e,t,o){const n=new f.MultiHolder,{menuOptions:i}=this._options,s=f.Computed.create(n,(()=>e)),r=f.Computed.create(n,(o=>m.Sort.specToDetails(m.Sort.findCol(o(t),e)))),l=f.Computed.create(n,r,((e,t)=>m.Sort.hasOptions(t))),a=f.Computed.create(n,r,((e,t)=>t.direction===m.Sort.ASC));s.onWrite((o=>{let n=t.peek();const i=m.Sort.findCol(n,e),s=m.Sort.findCol(n,o);s?(n=m.Sort.swap(n,e,o),n=m.Sort.setSortDirection(n,e,m.Sort.direction(s)),n=m.Sort.setSortDirection(n,o,m.Sort.direction(i))):n=m.Sort.replace(n,e,m.Sort.createColSpec(o,m.Sort.direction(i))),this._saveSort(n)}));const u=(o,i,s)=>{const l=f.Computed.create(n,r,((e,t)=>t[o]||!1));return l.onWrite((n=>{const i=t.peek(),s=m.Sort.specToDetails(m.Sort.findCol(i,e));s[o]=n,this._saveSort(m.Sort.replace(i,m.Sort.getColRef(e),s))})),{computed:l,allowedTypes:i,flag:o,label:s}},p=u("orderByChoice",["Choice"],_("Use choice position")),b=u("naturalSort",["Text"],_("Natural sort")),y=[p,u("emptyLast",null,_("Empty values last")),b],w=o.get().find((t=>t.value===m.Sort.getColRef(e)));return D(f.dom.autoDispose(n),(0,c.cssSortFilterColumn)(f.dom.domComputed(a,(e=>I("Sort",I.cls("-accent",(e=>e(this._changedColRefs).has(w.value))),f.dom.style("transform",e?"scaleY(-1)":"none"),v("order"),v(e?"sort-order-asc":"sort-order-desc")))),C(w.label),f.dom.on("click",(()=>{this._saveSort(m.Sort.flipSort(t.peek(),e))})),v("column")),F(T((0,c.cssIcon)("Dots",f.dom.cls(R.className,l)),v("options-icon")),(0,h.menu)((e=>y.map((({computed:e,allowedTypes:t,flag:o,label:n})=>{const i=!t||t.includes(w.type);return(0,g.cssMenuItem)((0,d.Ad)(e,n,f.dom.prop("disabled",!i)),f.dom.cls(A.className),f.dom.cls("disabled",!i),v("option"),v(`option-${o}`))}))),i)),S("Remove",f.dom.on("click",(()=>{const o=t.peek();m.Sort.findCol(o,e)&&this._saveSort(m.Sort.removeCol(o,e))})),v("remove")),v("row"))}_buildAddToSortButton(e){const t=f.Computed.create(null,(t=>{const o=t(this._section.activeSortSpec),n=new Set(o.map((e=>m.Sort.getColRef(e))));return t(e).filter((e=>!n.has(e.value)))})),{menuOptions:o}=this._options;return O(f.dom.autoDispose(t),f.dom.domComputed((e=>{const n=e(t);return k(_("Add Column"),(0,a.z)({popupOptions:o,options:()=>n.map((e=>({label:e.label,value:e}))),action:e=>(0,l.addToSort)(this._section.activeSortSpec,e.value,1),placeholder:_("Search Columns")}),f.dom.on("click",(e=>{e.stopPropagation()})),v("add"))})),f.dom.hide((e=>!e(t).length)))}_buildUpdateDataButton(){return f.dom.maybe(this._section.isSorted,(()=>O(k(_("Update Data"),f.dom.on("click",(()=>(0,l.updatePositions)(this._gristDoc,this._section))),v("update"),f.dom.show((e=>e(e(this._section.table).supportsManualSort)&&!e(this._gristDoc.isReadonly)))))))}_reorder(e,t){const o=this._section.activeSortSpec.peek(),n=m.Sort.findCol(o,e);if(void 0===n)throw new Error(`Col ${e} not found in active sort spec`);const i=m.Sort.reorderSortRefs(this._section.activeSortSpec.peek(),n,t);this._saveSort(i)}_saveSort(e){this._section.activeSortSpec(e)}}const x=(0,f.styled)("div","\n  display: flex !important;\n  align-items: center;\n  margin: 0 16px 0px 0px;\n  & > .kf_draggable_content {\n    margin: 4px 0;\n    flex: 1 1 0px;\n    min-width: 0px;\n  }\n"),C=(0,f.styled)("div","\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n  flex-grow: 1;\n"),D=(0,f.styled)("div","\n  display: flex;\n  align-items: center;\n  width: 100%;\n"),k=(0,f.styled)("div",`\n  color: ${u.theme.controlFg};\n  cursor: pointer;\n\n  &:hover {\n    color: ${u.theme.controlHoverFg};\n  }\n`),S=(0,f.styled)(c.cssIcon,`\n  flex: none;\n  margin: 0 6px;\n  cursor: pointer;\n  background-color: ${u.theme.controlSecondaryFg};\n\n  &:hover {\n    background-color: ${u.theme.controlSecondaryHoverFg};\n  }\n`),I=(0,f.styled)(c.cssIcon,`\n  flex: none;\n  margin: 0px 6px 0px 0px;\n  background-color: ${u.theme.controlSecondaryFg};\n\n  &-accent {\n    background-color: ${u.theme.accentIcon};\n  }\n`),T=(0,f.styled)("div","\n  padding: 3px;\n  border-radius: 3px;\n  cursor: pointer;\n  user-select: none;\n"),R=(0,f.styled)("div",`\n  background: ${u.theme.accentIcon}\n`),F=(0,f.styled)("div",`\n  display: inline-flex;\n  cursor: pointer;\n  border-radius: 3px;\n  border: 1px solid transparent;\n  margin-left: 6px;\n  &:hover, &.weasel-popup-open {\n    background-color: ${u.theme.hover};\n  }\n`),A=(0,f.styled)("div",`\n  &:hover {\n    background-color: ${u.theme.hover};\n  }\n  & label {\n    flex: 1;\n    cursor: pointer;\n  }\n  &.disabled * {\n    color: ${u.theme.menuItemDisabledFg} important;\n    cursor: not-allowed;\n  }\n`),O=(0,f.styled)(c.cssRow,"\n  margin-top: 4px;\n")},51536:(e,t,o)=>{"use strict";o.d(t,{B3:()=>F,KM:()=>R,M1:()=>k,Tw:()=>O});var n=o(13988),i=o(73783),s=o(70387),r=o(15323),l=o(98108),a=o(11187),c=o(92478),d=o(29922),u=o(13884),p=o(7454),h=o(83277),m=o(18099),f=Object.defineProperty,g=Object.getOwnPropertySymbols,b=Object.prototype.hasOwnProperty,y=Object.prototype.propertyIsEnumerable,v=(e,t,o)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,_=(e,t)=>{for(var o in t||(t={}))b.call(t,o)&&v(e,o,t[o]);if(g)for(var o of g(t))y.call(t,o)&&v(e,o,t[o]);return e};const w=o(29274),x=o(36812),C=(0,m.makeTestId)("test-vfc-"),D=(0,s.makeT)("VisibleFieldsConfig");class k extends m.Disposable{constructor(e,t){super(),this._gristDoc=e,this._section=t,this._hiddenFields=this.autoDispose((0,n.syncedKoArray)(this._section.hiddenColumns)),this._fieldLabel=m.Computed.create(this,(e=>{const t=e(this._section.parentKey);return(0,l.Ql)(t).pluralLabel})),this._collapseHiddenFields=m.Observable.create(this,!1),this._showVisibleBatchButtons=m.Observable.create(this,!1),this._showHiddenBatchButtons=m.Observable.create(this,!1),this._visibleFieldsSelection=new Set,this._hiddenFieldsSelection=new Set,this.autoDispose(this._section.viewFields.peek().subscribe((e=>{T(this._visibleFieldsSelection,e),this._showVisibleBatchButtons.set(Boolean(this._visibleFieldsSelection.size))}),null,"spliceChange")),this.autoDispose(this._hiddenFields.subscribe((e=>{T(this._hiddenFieldsSelection,e),this._showHiddenBatchButtons.set(Boolean(this._hiddenFieldsSelection.size))}),null,"spliceChange"))}buildVisibleFieldsConfigHelper(e){let t=this._section.viewFields.peek();if(e.skipFirst||e.filterFunc){let o=function(){if(r&&r.get())return;const e=l.peek().filter(((e,t)=>t+1>i.get())).filter(s);x(a.all(),e)||a.assign(e)};const i=e.skipFirst||m.Observable.create(this,-1),s=e.filterFunc||(()=>!0),r=e.freeze,l=this._section.viewFields.peek(),a=new n.KoArray;o(),this.autoDispose(l.subscribe(o)),this.autoDispose((0,m.subscribe)(i,o)),e.freeze&&this.autoDispose((0,m.subscribe)(e.freeze,o)),t=a}return i.draggableList(t,e.itemCreateFunc,_({itemClass:R.className,reorder:this.changeFieldPosition.bind(this),remove:this.removeField.bind(this),receive:this.addField.bind(this)},e.draggableOptions))}buildSectionFieldsConfigHelper(e){const t=this.buildVisibleFieldsConfigHelper(e.visibleFields),o=i.draggableList(this._hiddenFields,e.hiddenFields.itemCreateFunc,_({itemClass:R.className,reorder(){throw new Error(D("Hidden Fields cannot be reordered"))},receive(){throw new Error(D("Cannot drop items into Hidden Fields"))},remove:e=>e,removeButton:!1},e.hiddenFields.draggableOptions));return i.connectDraggableOneWay(o,t),[t,o]}buildDom(){const[e,t]=this.buildSectionFieldsConfigHelper({visibleFields:{itemCreateFunc:e=>this._buildVisibleFieldItem(e),draggableOptions:{removeButton:!1,drag_indicator:u.x}},hiddenFields:{itemCreateFunc:e=>this._buildHiddenFieldItem(e),draggableOptions:{removeButton:!1,drag_indicator:u.x}}});return[B(E(m.dom.text((e=>`Visible ${e(this._fieldLabel)}`))),m.dom.maybe((e=>Boolean(e(e(this._section.viewFields).getObservable()).length)),(()=>P((0,p.icon)("Tick"),D("Select All"),m.dom.on("click",(()=>this._setVisibleCheckboxes(e,!0))),C("visible-fields-select-all"))))),m.dom.update(e,C("visible-fields")),m.dom.maybe(this._showVisibleBatchButtons,(()=>M((0,a.primaryButton)(m.dom.text((e=>`Hide ${e(this._fieldLabel)}`)),m.dom.on("click",(()=>this._removeSelectedFields()))),(0,a.basicButton)(D("Clear"),m.dom.on("click",(()=>this._setVisibleCheckboxes(e,!1)))),C("visible-batch-buttons")))),B($("Dropdown",m.dom.style("transform",(e=>e(this._collapseHiddenFields)?"rotate(-90deg)":"")),m.dom.style("cursor","pointer"),m.dom.on("click",(()=>this._collapseHiddenFields.set(!this._collapseHiddenFields.get()))),C("collapse-hidden")),E(m.dom.text((e=>`Hidden ${e(this._fieldLabel)}`))),m.dom.maybe((e=>Boolean(e(this._hiddenFields.getObservable()).length&&!e(this._collapseHiddenFields))),(()=>P((0,p.icon)("Tick"),D("Select All"),m.dom.on("click",(()=>this._setHiddenCheckboxes(t,!0))),C("hidden-fields-select-all"))))),(0,m.dom)("div",m.dom.hide(this._collapseHiddenFields),m.dom.update(t,C("hidden-fields")),m.dom.maybe(this._showHiddenBatchButtons,(()=>M((0,a.primaryButton)(m.dom.text((e=>`Show ${e(this._fieldLabel)}`)),m.dom.on("click",(()=>this._addSelectedFields()))),(0,a.basicButton)(D("Clear"),m.dom.on("click",(()=>this._setHiddenCheckboxes(t,!1)))),C("hidden-batch-buttons")))))]}async removeField(e){const t=this._section.viewFields.peek().peek().find((t=>t.column.peek().getRowId()===e.origCol.peek().id.peek()));if(!t)return;const o=["RemoveRecord",t.id.peek()];await this._gristDoc.docModel.viewFields.sendTableAction(o)}async addField(e,t=null){if(-1!==this._section.viewFields.peek().peek().findIndex((t=>t.column.peek().getRowId()===e.id.peek())))return;const o=S(this._section.viewFields.peek(),0,t),n=["AddRecord",null,{parentId:this._section.id.peek(),colRef:e.id.peek(),parentPos:o}];await this._gristDoc.docModel.viewFields.sendTableAction(n)}changeFieldPosition(e,t){const o=S(this._section.viewFields.peek(),0,t),n=["UpdateRecord",e.id.peek(),{parentPos:o}];return this._gristDoc.docModel.viewFields.sendTableAction(n)}_setVisibleCheckboxes(e,t){this._setCheckboxesHelper(e,this._section.viewFields.peek().peek(),this._visibleFieldsSelection,t),this._showVisibleBatchButtons.set(t)}_setHiddenCheckboxes(e,t){this._setCheckboxesHelper(e,this._hiddenFields.peek(),this._hiddenFieldsSelection,t),this._showHiddenBatchButtons.set(t)}_setCheckboxesHelper(e,t,o,n){var i;(i=e,i.querySelectorAll("input")).forEach((e=>e.checked=n)),o.clear(),n&&t.forEach((e=>o.add(e.id.peek())))}_buildHiddenFieldItem(e){const t=e.id.peek(),o=this._hiddenFieldsSelection;return F(O(m.dom.text(e.label)),A("EyeShow",m.dom.on("click",(()=>this.addField(e))),C("hide")),I(m.dom.prop("checked",o.has(t)),m.dom.on("change",((e,n)=>{n.checked?o.add(t):o.delete(t),this._showHiddenBatchButtons.set(Boolean(o.size))}))))}_buildVisibleFieldItem(e){const t=e.id.peek(),o=this._visibleFieldsSelection;return F(O(m.dom.text(e.label)),A("EyeHide",m.dom.on("click",(()=>this.removeField(e))),C("hide")),I(m.dom.prop("checked",o.has(t)),m.dom.on("change",((e,n)=>{n.checked?o.add(t):o.delete(t),this._showVisibleBatchButtons.set(Boolean(o.size))}))))}async _removeSelectedFields(){const e=["BulkRemoveRecord",Array.from(this._visibleFieldsSelection).sort(h.nativeCompare)];await this._gristDoc.docModel.viewFields.sendTableAction(e)}async _addSelectedFields(){const e=Array.from(this._hiddenFieldsSelection),t=["BulkAddRecord",h.arrayRepeat(e.length,null),{parentId:h.arrayRepeat(e.length,this._section.id.peek()),colRef:e}];await this._gristDoc.docModel.viewFields.sendTableAction(t)}}function S(e,t,o){const n=function(e,t){return null!==t?e.peek().indexOf(t):e.peek().length}(e,o);return r.fieldInsertPositions(e,n,1)[0]}function I(...e){return c.xY({style:"flex-shrink: 0;"},c.kZ({type:"checkbox"},...e))}function T(e,t){const o=w(t.deleted,t.array);for(const t of o)e.delete(t.id.peek())}const R=(0,m.styled)("div","\n  display: flex !important;\n  align-items: center;\n  margin: 0 16px 0px 0px;\n  & > .kf_draggable_content {\n    margin: 2px 0;\n    flex: 1 1 0px;\n    min-width: 0px;\n  }\n"),F=(0,m.styled)("div",`\n  display: flex;\n  background-color: ${d.theme.hover};\n  width: 100%;\n  border-radius: 2px;\n  margin: 0 8px 0 0;\n  padding: 4px 8px;\n  cursor: default;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n\n  --icon-color: ${d.theme.lightText};\n`),A=(0,m.styled)(p.icon,`\n  --icon-color: ${d.theme.lightText};\n  display: none;\n  cursor: pointer;\n  flex: none;\n  margin-right: 8px;\n  .kf_draggable:hover & {\n    display: block;\n  }\n`),O=(0,m.styled)("span",`\n  color: ${d.theme.text};\n  flex: 1 1 auto;\n  text-overflow: ellipsis;\n  overflow: hidden;\n`),E=(0,m.styled)("span",`\n  color: ${d.theme.text};\n  flex: 1 1 0px;\n  font-size: ${d.vars.xsmallFontSize};\n  text-transform: uppercase;\n`),M=(0,m.styled)("div",`\n  display: flex;\n  margin: 16px;\n  overflow: hidden;\n  --icon-color: ${d.theme.lightText};\n  & > .${a.cssButton.className} {\n    margin-right: 8px;\n  }\n`),P=(0,m.styled)("div",`\n  --icon-color: ${d.theme.controlFg};\n  color: ${d.theme.controlFg};\n  cursor: pointer;\n`),B=(0,m.styled)(M,"\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 12px;\n"),$=(0,m.styled)(p.icon,`\n  --icon-color: ${d.theme.lightText};\n  flex: none;\n  margin-right: 4px;\n`)},59793:(e,t,o)=>{"use strict";o.d(t,{z:()=>h});var n=o(18099),i=o(29922),s=o(11104),r=o(1370),l=o(7454),a=o(21467),c=o(32275),d=o(88480);const u=(0,n.makeTestId)("test-sd-");class p{constructor(e,t,o){this.label=e,this.value=t,this.disabled=o,this.cleanText=(0,s.normalizeText)(this.label)}}function h(e){return t=>{const o=(0,c.mergeWith)({},a.defaultMenuOptions,e.popupOptions,((e,t)=>Array.isArray(t)?t:void 0));(0,a.setPopupToFunc)(t,(t=>m.create(null,t,e)),o)}}class m extends n.Disposable{constructor(e,t){super(),this._ctl=e,this._options=t;const o=t.options().map(d.n).map((e=>new p(e.label,e.value,e.disabled)));this._acIndex=new s.ACIndexImpl(o),this._items=n.Observable.create(this,o),this._highlightFunc=()=>[],this._simpleList=this._buildSimpleList(),this._simpleList.listenKeys(this._inputElem),this._update(),setTimeout((()=>this._inputElem.focus()),1)}get content(){return this._simpleList.content}_buildSimpleList(){const e=this._action.bind(this),t=this._buildHeader.bind(this),o=this._buildItem.bind(this);return d.L.create(this,this._ctl,this._items,e,{headerDom:t,renderItem:o})}_buildHeader(){return[g(b("Search"),this._inputElem=y({placeholder:this._options.placeholder||"Search"},n.dom.on("input",(()=>{this._update()})),n.dom.on("blur",(()=>setTimeout((()=>this._inputElem.focus()),0)))),n.dom.on("click",(e=>e.stopPropagation())),u("search")),v()]}_buildItem(e){return[(0,s.buildHighlightedDom)(e.label,this._highlightFunc,f),u("searchable-list-item")]}_update(){var e;const t=this._acIndex.search((null==(e=this._inputElem)?void 0:e.value)||"");this._highlightFunc=t.highlightFunc,this._items.set(t.items),this._simpleList.setSelected(t.selectIndex)}_action(e){e&&this._options.action(e),this._ctl.close()}}const f=(0,n.styled)("span",`\n  color: ${i.theme.autocompleteMatchText};\n  .${a.cssMenuItem.className}-sel > & {\n    color: ${i.theme.autocompleteSelectedMatchText};\n  }\n`),g=(0,n.styled)("div","\n  display: flex;\n  padding: 13px 17px 15px 17px;\n"),b=(0,n.styled)(l.icon,`\n  --icon-color: ${i.theme.lightText};\n  flex-shrink: 0;\n  margin-left: auto;\n  margin-right: 4px;\n`),y=(0,n.styled)("input",`\n  color: ${i.theme.inputFg};\n  background-color: ${i.theme.inputBg};\n  flex-grow: 1;\n  min-width: 1px;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n\n  font-size: ${i.vars.mediumFontSize};\n\n  margin: 0px 16px 0px 8px;\n  padding: 0px;\n  border: none;\n  outline: none;\n\n  &::placeholder {\n    color: ${i.theme.inputPlaceholderFg};\n  }\n`),v=(0,n.styled)(r.menuDivider,"\n  flex-shrink: 0;\n  margin: 0;\n")},21602:(e,t,o)=>{"use strict";o.d(t,{Kg:()=>_,N3:()=>S,bG:()=>g,pS:()=>I,vH:()=>T});var n=o(631),i=o(20543),s=o.n(i),r=o(83277),l=Object.defineProperty,a=Object.defineProperties,c=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,h=(e,t,o)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,m=(e,t)=>{for(var o in t||(t={}))u.call(t,o)&&h(e,o,t[o]);if(d)for(var o of d(t))p.call(t,o)&&h(e,o,t[o]);return e};const f=o(36812),g=S({srcSectionRef:0,srcColRef:0,targetColRef:0}),b={label:"Select Widget",value:g};function y(e){var t;return e.isSummary&&"group"===(null==(t=e.column)?void 0:t.colId.peek())}function v(e,t){if(e.section.getRowId()===t.section.getRowId())return!1;if(e.tableId!==t.tableId)return!1;if(y(e)&&(!t.column||y(t))||y(t))return!1;if(e.isSummary&&!e.column&&t.column||t.isSummary&&!t.column&&e.column)return!1;if(!e.column&&!t.column&&t.isSummary&&(!e.isSummary||!r.isSubset(e.groupbyColumns,t.groupbyColumns)))return!1;if("chart"===e.widgetType)return!1;if("custom"===e.widgetType){if(e.tableId!==e.section.table.peek().primaryTableId.peek())return!1;if(!e.section.allowSelectBy.get())return!1}return!e.ancestors.has(t.section.getRowId())}function _(e,t,o){const n=x(e,t),i=x(e,[o]),s=[b];for(const e of n){const t=i.filter((t=>v(e,t))),o=t.length>1;for(const n of t){const t=S({srcSectionRef:e.section.getRowId(),srcColRef:e.column?e.column.getRowId():0,targetColRef:n.column?n.column.getRowId():0});let i=e.section.titleDef();e.column&&!y(e)&&(i+=` • ${e.column.label.peek()}`),n.column&&!y(n)&&(o||y(e))&&(i+=` → ${n.column.label.peek()}`),s.push({label:i,value:t})}}return s}function w(e){return Boolean(e.getRowId)}function x(e,t){const o=[];for(const n of t)w(n)?o.push(...C(n)):o.push(...D(e,n));return o}function C(e){if(e.isDisposed())return[];const t=e.table.peek(),o=new Set;for(let t=e;t.getRowId();t=t.linkSrcSection.peek()){if(o.has(t.getRowId())){console.warn(`Links should not create a cycle - section ids: ${Array.from(o)}`);break}o.add(t.getRowId())}const n=t.primaryTableId.peek()!==t.tableId.peek(),i={tableId:t.primaryTableId.peek(),isSummary:n,groupbyColumns:n?t.summarySourceColRefs.peek():void 0,widgetType:e.parentKey.peek(),ancestors:o,section:e};return k(t,i)}function D(e,t){if("number"!=typeof t.table)return[];let o=e.tables.getRowModel(t.table);const n=t.summarize,i=n?new Set(t.columns):void 0;let s=!0;if(n){const t=e.tables.rowModels.find((e=>(null==e?void 0:e.summarySourceTable.peek())&&f(e.summarySourceColRefs.peek(),i)));t?o=t:s=!1}const r={tableId:o.primaryTableId.peek(),isSummary:n,groupbyColumns:i,widgetType:t.type,ancestors:new Set,section:e.viewSections.getRowModel(t.section)};return k(o,r,s)}function k(e,t,o=!0){const i=[t],s=e.columns.peek().peek();for(const e of s){if(!o&&!t.groupbyColumns.has(e.getRowId()))continue;const s=(0,n.getReferencedTableId)(e.type.peek());s&&i.push((r=m({},t),a(r,c({tableId:s,column:e}))))}var r;return i}function S(e){return JSON.stringify([e.srcSectionRef,e.srcColRef,e.targetColRef])}function I(e){const[t,o,n]=JSON.parse(e);return{srcSectionRef:t,srcColRef:o,targetColRef:n}}class T{constructor(e){this.tgtCol=e.linkTargetCol(),this.srcCol=e.linkSrcCol(),this.srcSection=e.linkSrcSection(),this.tgtSection=e,this.srcColId=this.srcCol.colId(),this.tgtColId=this.tgtCol.colId(),this._assertValid()}_assertValid(){var e,t,o,i;const r=(null==(e=this.srcCol)?void 0:e.getRowId())?this.srcCol:null,l=(null==(t=this.tgtCol)?void 0:t.getRowId())?this.tgtCol:null,a=r?(0,n.getReferencedTableId)(r.type()):this.srcSection.table().primaryTableId(),c=l?(0,n.getReferencedTableId)(l.type()):this.tgtSection.table().primaryTableId(),d=this.srcSection.table().summarySourceTable(),u=this.tgtSection.table().summarySourceTable();try{s()(Boolean(this.srcSection.getRowId()),"srcSection was disposed"),s()(!l||l.parentId()===this.tgtSection.tableRef(),"tgtCol belongs to wrong table"),s()(!r||r.parentId()===this.srcSection.tableRef(),"srcCol belongs to wrong table"),s()(this.srcSection.getRowId()!==this.tgtSection.getRowId(),"srcSection links to itself"),0!==d&&d===u||(s()(c,"tgtCol not a valid reference"),s()(a,"srcCol not a valid reference")),s()(a===c,"mismatched tableIds")}catch(e){throw new Error(`LinkConfig invalid: ${this.srcSection.getRowId()}:${null==(o=this.srcCol)?void 0:o.getRowId()}[${a}] -> ${this.tgtSection.getRowId()}:${null==(i=this.tgtCol)?void 0:i.getRowId()}[${c}]: ${e}`)}}}},98987:(e,t,o)=>{"use strict";o.d(t,{a:()=>i});var n=o(18099);function i(...e){const t=n.Observable.create(null,!0),o=n.Observable.create(null,!0);return r(n.dom.autoDispose(t),n.dom.autoDispose(o),(e=>{setTimeout((()=>o.set(s(e))),0)}),n.dom.on("scroll",((e,n)=>{t.set(function(e){return 0===e.scrollTop}(n)),o.set(s(n))})),n.dom.style("box-shadow",(e=>[e(t)?null:"inset 0 4px 6px 0 rgba(217,217,217,0.4)",e(o)?null:"inset 0 -4px 6px 0 rgba(217,217,217,0.4)"].filter((e=>e)).join(", "))),...e)}function s(e){return e.scrollTop>=e.scrollHeight-e.offsetHeight}const r=(0,n.styled)("div","\n  flex: 1 1 0;\n  width: 100%;\n  overflow-y: auto;\n")},90098:(e,t,o)=>{"use strict";o.d(t,{a:()=>i,e:()=>n});const n=new Map([["record",{label:"Table",icon:"TypeTable"}],["single",{label:"Card",icon:"TypeCard"}],["detail",{label:"Card List",icon:"TypeCardList"}],["chart",{label:"Chart",icon:"TypeChart"}],["custom",{label:"Custom",icon:"TypeCustom"}]]);function i(e){return n.get(e||"record")||n.get("record")}},89068:(e,t,o)=>{"use strict";o.d(t,{Mv:()=>D,UV:()=>S,Lz:()=>k});var n=o(11187);const i=["#FFFFFF","#DCDCDC","#888888","#000000","#FECBCC","#FD8182","#E00A17","#740206","#F3E1D2","#D6A77F","#AA632B","#653008","#FEE7C3","#FECC81","#FD9D28","#B36F19","#FFFACD","#FEF47A","#E8D62F","#928619","#E1FEDE","#98FD90","#2AE028","#126E0E","#CCFEFE","#8AFCFE","#24D6DB","#0C686A","#D3E7FE","#75B5FC","#157AFB","#084794","#E8D0FE","#BC77FC","#8725FB","#460D81","#FED6FB","#FD79F4","#E621D7","#760C6E"];function s(e){return e%4<=1}var r=o(29922),l=o(29002),a=o(7454),c=o(48402),d=o(83277),u=o(18099),p=o(21467),h=o(70387),m=Object.defineProperty,f=Object.defineProperties,g=Object.getOwnPropertyDescriptors,b=Object.getOwnPropertySymbols,y=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable,_=(e,t,o)=>t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,w=(e,t)=>{for(var o in t||(t={}))y.call(t,o)&&_(e,o,t[o]);if(b)for(var o of b(t))v.call(t,o)&&_(e,o,t[o]);return e},x=(e,t)=>f(e,g(t));const C=(0,h.makeT)("ColorSelect");class D{constructor(e){this.allowsNone=!1,this.defaultColor="",this.noneText="",Object.assign(this,e)}}function k(e,t){const{textColor:o,fillColor:n}=e,{onSave:i,onOpen:s,onRevert:l,placeholder:d=C("Default cell style")}=t,h=(0,c.G)(U(q("T",u.dom.style("color",(e=>e(o.color)||o.defaultColor)),u.dom.style("background-color",(e=>{var t;return(null==(t=e(n.color))?void 0:t.slice(0,7))||n.defaultColor})),u.dom.cls("font-bold",(t=>{var o;return null!=(o=t(e.fontBold))&&o})),u.dom.cls("font-italic",(t=>{var o;return null!=(o=t(e.fontItalic))&&o})),u.dom.cls("font-underline",(t=>{var o;return null!=(o=t(e.fontUnderline))&&o})),u.dom.cls("font-strikethrough",(t=>{var o;return null!=(o=t(e.fontStrikethrough))&&o})),H.cls(""),(0,r.testId)("btn-icon")),u.dom.text(d)),(0,a.icon)("Dropdown"),(0,r.testId)("color-select"));return(0,p.setPopupToCreateDom)(h,(t=>(null==s||s(),I(t,e,i,l))),x(w({},p.defaultMenuOptions),{placement:"bottom-end"})),h}function S(e,t){const{textColor:o,fillColor:n}=e,i=J("T",u.dom.style("color",(e=>e(o.color)||o.defaultColor)),u.dom.style("background-color",(e=>{var t;return(null==(t=e(n.color))?void 0:t.slice(0,7))||n.defaultColor})),u.dom.cls("font-bold",(t=>{var o;return null!=(o=t(e.fontBold))&&o})),u.dom.cls("font-italic",(t=>{var o;return null!=(o=t(e.fontItalic))&&o})),u.dom.cls("font-underline",(t=>{var o;return null!=(o=t(e.fontUnderline))&&o})),u.dom.cls("font-strikethrough",(t=>{var o;return null!=(o=t(e.fontStrikethrough))&&o})),(0,r.testId)("color-button"));return(0,p.setPopupToCreateDom)(i,(o=>I(o,e,t)),x(w({},p.defaultMenuOptions),{placement:"bottom-end"})),i}function I(e,{textColor:t,fillColor:o,fontBold:i,fontUnderline:s,fontItalic:l,fontStrikethrough:a},c,d){const p=R.create(null,t.color),h=R.create(null,o.color),m=F.create(null,i),f=F.create(null,s),g=F.create(null,l),b=F.create(null,a),y=[p,h,m,f,g,b],v=u.Computed.create(null,(e=>y.every((t=>!1===e(t.needsSaving)))));function _(){null==d||d(),d||y.forEach((e=>e.revert())),e.close()}return e.onDispose((async()=>{if(!v.get())try{await c()}catch(e){null==d||d(),d||y.forEach((e=>e.revert()))}y.forEach((e=>e.dispose())),v.dispose()})),V(u.dom.create(O,{fontBoldModel:m,fontUnderlineModel:f,fontItalicModel:g,fontStrikethroughModel:b}),z(),u.dom.create(A,p,w({title:"text"},t)),z(),u.dom.create(A,h,w({title:"fill"},o)),(e=>{setTimeout((()=>e.focus()),0)}),(0,u.onKeyDown)({Escape:()=>{_()},Enter:()=>{e.close()}}),Z((0,n.primaryButton)(C("Apply"),u.dom.on("click",(()=>e.close())),u.dom.boolAttr("disabled",v),(0,r.testId)("colors-save")),(0,n.basicButton)(C("Cancel"),u.dom.on("click",(()=>_())),(0,r.testId)("colors-cancel"))),u.dom.on("focusout",((e,t)=>e.target!==t&&t.focus())))}class T extends u.Disposable{constructor(e){super(),this.obs=e,this._localChange=!1,this._serverValue=u.Observable.create(this,this.obs.get()),this.needsSaving=u.Computed.create(this,(e=>{const t=e(this.obs),o=e(this._serverValue);return t!==("boolean"==typeof t?null!=o&&o:o)})),this.autoDispose(this.obs.addListener((e=>{this._localChange||this._serverValue.set(e)})))}setValue(e){this._localChange=!0,this.obs.set(e),this._localChange=!1}revert(){this.obs.set(this._serverValue.get())}}class R extends T{}class F extends T{}class A extends u.Disposable{constructor(e,t){super(),this._model=e,this._options=t,this._color=u.Computed.create(this,this._model.obs,((e,t)=>(t||this._options.defaultColor).toUpperCase().slice(0,7)))}buildDom(){const e=this._options.title,t=u.Computed.create(null,(e=>e(this._color)||this._options.noneText));return[L(e),$(B(u.dom.update(W(H.cls(""),u.dom.style("background-color",this._color),K("Empty",u.dom.hide((e=>!0===Boolean(e(this._color)))))),P({type:"color"},u.dom.attr("value",this._color),u.dom.on("input",((e,t)=>this._setValue(t.value||void 0))),(0,r.testId)(`${e}-input`))),j(t,(async e=>{e&&!(0,d.isValidHex)(e)||this._model.setValue(e||void 0)}),u.dom.autoDispose(t),(0,r.testId)(`${e}-hex`),u.dom.on("click",((e,t)=>setTimeout((()=>t.select()),0))))),G(G.cls("-selected",(e=>!e(this._color))),u.dom.on("click",(()=>this._setValue(void 0))),u.dom.hide(!this._options.allowsNone),K("Empty"),(0,r.testId)(`${e}-empty`))),N(i.map(((e,t)=>W(u.dom.style("background-color",e),H.cls("",s(t)),W.cls("-selected",(t=>t(this._color)===e)),u.dom.style("outline-color",s(t)?"":e),u.dom.on("click",(()=>this._setValue(e))),(0,r.testId)(`color-${e}`)))),(0,r.testId)(`${e}-palette`))]}_setValue(e){this._model.setValue(e)}}class O extends u.Disposable{constructor(e){super(),this._options=e}buildDom(){function e(e,t){return M(Y(e),u.dom.on("click",(()=>t.setValue(!t.obs.get()))),M.cls("-selected",(e=>{var o;return null!=(o=e(t.obs))&&o})),(0,r.testId)(`font-option-${e}`))}return E(e("FontBold",this._options.fontBoldModel),e("FontUnderline",this._options.fontUnderlineModel),e("FontItalic",this._options.fontItalicModel),e("FontStrikethrough",this._options.fontStrikethroughModel))}}const E=(0,u.styled)("div",`\n  display: flex;\n  gap: 1px;\n  background: ${r.colors.darkGrey};\n  border: 1px solid ${r.colors.darkGrey};\n`),M=(0,u.styled)("div",`\n  display: grid;\n  place-items: center;\n  flex-grow: 1;\n  background: ${r.colors.light};\n  --icon-color: ${r.colors.dark};\n  height: 24px;\n  cursor: pointer;\n  &:hover:not(&-selected) {\n    background: ${r.colors.lightGrey};\n  }\n  &-selected {\n    background: ${r.colors.dark};\n    --icon-color: ${r.colors.light}\n  }\n`),P=(0,u.styled)("input","\n  opacity: 0;\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  padding: 0;\n  border: none;\n"),B=(0,u.styled)("div","\n  display: flex;\n"),$=(0,u.styled)("div","\n  display: flex;\n  justify-content: space-between;\n  margin-bottom: 8px;\n"),L=(0,u.styled)("div",`\n  text-transform: uppercase;\n  font-size: ${r.vars.smallFontSize};\n  margin-bottom: 12px;\n`),N=(0,u.styled)("div","\n  width: 236px;\n  height: calc(4 * 20px + 3 * 4px);\n  display: flex;\n  flex-direction: column;\n  flex-wrap: wrap;\n  justify-content: space-between;\n  align-content: space-between;\n"),z=(0,u.styled)("div","\n  height: 24px;\n"),V=(0,u.styled)("div","\n  padding: 18px 16px;\n  background-color: white;\n  box-shadow: 0 2px 16px 0 rgba(38,38,51,0.6);\n  z-index: 20;\n  margin: 2px 0;\n  &:focus {\n    outline: none;\n  }\n"),U=(0,u.styled)("div","\n  display: flex;\n  align-items: center;\n"),j=(0,u.styled)(l.textInput,`\n  border: 1px solid ${r.theme.inputBorder};\n  border-left: none;\n  font-size: ${r.vars.smallFontSize};\n  display: flex;\n  align-items: center;\n  color: ${r.theme.lightText};\n  background-color: ${r.theme.inputBg};\n  width: 56px;\n  outline: none;\n  padding: 0 3px;\n  height: unset;\n  border-radius: unset;\n`),H=(0,u.styled)("div","\n  border: 1px solid #D9D9D9;\n"),W=(0,u.styled)("div","\n  width: 20px;\n  height: 20px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  position: relative;\n  &-selected {\n    outline: 1px solid #D9D9D9;\n    outline-offset: 1px;\n  }\n"),G=(0,u.styled)(W,`\n  --icon-color: ${r.colors.error};\n  border: 1px solid #D9D9D9;\n  &-selected {\n    outline: 1px solid ${r.colors.dark};\n    outline-offset: 1px;\n  }\n`),Y=(0,u.styled)(a.icon,"\n  height: 12px;\n  width: 12px;\n"),K=(0,u.styled)(a.icon,`\n  height: 100%;\n  width: 100%;\n  --icon-color: ${r.colors.error}\n`),q=(0,u.styled)(W,"\n  margin-right: 6px;\n  margin-left: 4px;\n"),J=(0,u.styled)(W,"\n  min-width: 18px;\n  width: 18px;\n  height: 18px;\n  cursor: pointer;\n  display: grid;\n  place-items: center;\n"),Z=(0,u.styled)("div","\n  gap: 8px;\n  display: flex;\n  margin-top: 24px;\n")},88261:(e,t,o)=>{"use strict";o.r(t),o.d(t,{alignmentSelect:()=>d,buttonSelect:()=>a,buttonToggleSelect:()=>c,colorSelect:()=>u,cssButtonSelect:()=>m,makeButtonSelect:()=>p});var n=o(29922),i=o(7454),s=o(83277),r=o(18099);const l=o(88466);function a(e,t,...o){return p(e,t,(t=>{e.set(t)}),...o)}function c(e,t,...o){return p(e,t,(t=>{e.set(e.get()===t?null:t)}),...o)}function d(e,...t){return a(e,[{value:"left",icon:"LeftAlign"},{value:"center",icon:"CenterAlign"},{value:"right",icon:"RightAlign"}],{},(0,n.testId)("alignment-select"),...t)}function u(e,t,...o){const n=l((t=>e.set(t.target.value)),300),i=l((e=>t(e.target.value)),300);return b(y({type:"color"},r.dom.attr("value",(t=>t(e).slice(0,7))),r.dom.on("input",n),r.dom.on("change",i)),r.dom.style("background-color",(t=>t(e)||"#000000")),b.cls("-dark",(t=>(0,s.isColorDark)(t(e)||"#000000"))),v("Dots"),...o)}function p(e,t,o,...s){return m(r.dom.forEach(t,(t=>{const s=function(e){return h(e)?e.value:e}(t),l=function(e){return h(e)?e.label:e}(t);return f(f.cls("-selected",(t=>t(e)===s)),r.dom.on("click",(()=>o(s))),h(t)&&t.icon?(0,i.icon)(t.icon):null,l?g(l):null,(0,n.testId)("select-button"))})),...s)}function h(e){return"string"!=typeof e}const m=(0,r.styled)("div",`\n  /* Resets */\n  position: relative;\n  outline: none;\n  border-style: none;\n  display: flex;\n\n  /* Vars */\n  color: ${n.theme.text};\n  flex: 1 1 0;\n`),f=(0,r.styled)("div",`\n  /* Resets */\n  position: relative;\n  outline: none;\n  border-style: none;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n\n  /* Vars */\n  flex: 1 1 0;\n  font-size: ${n.vars.mediumFontSize};\n  letter-spacing: -0.08px;\n  text-align: center;\n  line-height: normal;\n  min-width: 32px;\n  white-space: nowrap;\n  padding: 4px 10px;\n\n  background-color: ${n.theme.buttonGroupBg};\n  border: 1px solid ${n.theme.buttonGroupBorder};\n  --icon-color: ${n.theme.buttonGroupIcon};\n\n  margin-left: -1px;\n\n  cursor: pointer;\n\n  &:first-child {\n    border-top-left-radius: ${n.vars.controlBorderRadius};\n    border-bottom-left-radius: ${n.vars.controlBorderRadius};\n    margin-left: 0;\n  }\n\n  &:last-child {\n    border-top-right-radius: ${n.vars.controlBorderRadius};\n    border-bottom-right-radius: ${n.vars.controlBorderRadius};\n  }\n\n  &:hover:not(&-selected) {\n    border: 1px solid ${n.theme.buttonGroupBorderHover};\n    z-index: 5;  /* Update z-index so selected borders take precedent */\n  }\n\n  &-selected {\n    color: ${n.theme.buttonGroupSelectedFg};\n    --icon-color: ${n.theme.buttonGroupSelectedFg};\n    border: 1px solid ${n.theme.buttonGroupSelectedBorder};\n    background-color: ${n.theme.buttonGroupSelectedBg};\n    z-index: 10;  /* Update z-index so selected borders take precedent */\n  }\n\n  /* Styles when container includes cssButtonSelect.cls('-light') */\n  .${m.className}-light > & {\n    border: none;\n    border-radius: ${n.vars.controlBorderRadius};\n    margin-left: 0px;\n    padding: 8px;\n    color: ${n.theme.buttonGroupLightFg};\n    --icon-color: ${n.theme.buttonGroupLightFg};\n  }\n  .${m.className}-light > &-selected {\n    border: none;\n    color: ${n.theme.buttonGroupLightSelectedFg};\n    --icon-color: ${n.theme.buttonGroupLightSelectedFg};\n    background-color: initial;\n  }\n  .${m.className}-light > &:hover {\n    border: none;\n    background-color: ${n.theme.hover};\n  }\n  .${m.className}-disabled > &,\n  .${m.className}-disabled > &:hover {\n    --icon-color: ${n.theme.rightPanelToggleButtonDisabledFg};\n    color: ${n.theme.rightPanelToggleButtonDisabledFg};\n    background-color: ${n.theme.rightPanelToggleButtonDisabledBg};\n    border-color: ${n.theme.buttonGroupBorder};\n    pointer-events: none;\n  }\n`),g=(0,r.styled)("span","\n  margin: 0 2px;\n  vertical-align: middle;\n"),b=(0,r.styled)("div",`\n  position: relative;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 100%;\n  min-width: 32px;\n  max-width: 56px;\n  height: 32px;\n  border-radius: 4px;\n  border: 1px solid ${n.colors.darkGrey};\n\n  &:hover {\n    border: 1px solid ${n.colors.hover};\n  }\n\n  &-dark {\n    border: none !important;\n  }\n`),y=(0,r.styled)("input","\n  position: absolute;\n  cursor: pointer;\n  opacity: 0;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n"),v=(0,r.styled)(i.icon,`\n  margin: 0 2px;\n  background-color: ${n.colors.slate};\n  pointer-events: none;\n\n  .${b.className}-dark & {\n    background-color: ${n.colors.light};\n  }\n`)},13884:(e,t,o)=>{"use strict";o.d(t,{x:()=>s});var n=o(29922),i=o(7454);const s=(0,o(18099).styled)(((...e)=>(0,i.icon)("DragDrop",(0,n.testId)("dragger"),...e)),`\n  --icon-color: ${n.theme.controlSecondaryFg};\n  visibility: hidden;\n  align-self: center;\n  flex-shrink: 0;\n  .kf_draggable:hover & {\n    visibility: visible;\n  }\n`)},73974:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CellStyle:()=>c});var n=o(24412),i=o(11187),s=o(89068),r=o(29922),l=o(31825),a=o(18099);class c extends a.Disposable{constructor(e,t,o){super(),this._field=e,this._gristDoc=t,this._defaultTextColor=o}buildDom(){return[d(u("CELL STYLE"),p("Open row styles",a.dom.on("click",n.allCommands.viewTabOpen.run))),h(a.dom.domComputedOwned((0,a.fromKo)(this._field.config.style),((e,t)=>{const o=(0,a.fromKo)(t.prop("textColor")),n=(0,a.fromKo)(t.prop("fillColor")),i=(0,a.fromKo)(t.prop("fontBold")),r=(0,a.fromKo)(t.prop("fontUnderline")),l=(0,a.fromKo)(t.prop("fontItalic")),c=(0,a.fromKo)(t.prop("fontStrikethrough")),d=a.Computed.create(e,(e=>!!e(this._field.config.multiselect)&&[e(t.mixed("textColor")),e(t.mixed("fillColor")),e(t.mixed("fontBold")),e(t.mixed("fontUnderline")),e(t.mixed("fontItalic")),e(t.mixed("fontStrikethrough"))].some(Boolean)));return(0,s.Lz)({textColor:new s.Mv({color:o,defaultColor:this._defaultTextColor,noneText:"default"}),fillColor:new s.Mv({color:n,allowsNone:!0,noneText:"none"}),fontBold:i,fontItalic:l,fontUnderline:r,fontStrikethrough:c},{onSave:()=>t.save(),onRevert:()=>t.revert(),placeholder:e=>e(d)?"Mixed style":"Default cell style"})}))),a.dom.create(l.o,"Cell Style",this._field,this._gristDoc,(0,a.fromKo)(this._field.config.multiselect))]}}const d=(0,a.styled)("div","\n  display: flex;\n  margin: 16px 16px 12px 16px;\n  justify-content: space-between;\n  align-items: baseline;\n"),u=(0,a.styled)("div",`\n  color: ${r.theme.text};\n  text-transform: uppercase;\n  font-size: ${r.vars.xsmallFontSize};\n`),p=(0,a.styled)(i.textButton,`\n  font-size: ${r.vars.mediumFontSize};\n`),h=(0,a.styled)("div",`\n  display: flex;\n  margin: 8px 16px;\n  align-items: center;\n  &-top-space {\n    margin-top: 24px;\n  }\n  &-disabled {\n    color: ${r.theme.disabledText};\n  }\n`)},31490:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ChoiceItem:()=>b,ChoiceListEditor:()=>y,cssChoiceList:()=>S,cssDeleteButton:()=>x,cssDeleteIcon:()=>C,cssMatchText:()=>T,cssPlusButton:()=>R,cssPlusIcon:()=>F,cssToken:()=>w});var n=o(24412),i=o(11104),s=o(64982),r=o(29922),l=o(1370),a=o(16151),c=o(41880),d=o(63074),u=o(65552),p=o(93965),h=o(74987),m=o(55330),f=o(7454),g=o(18099);class b{constructor(e,t,o){this.label=e,this.isInvalid=t,this.isNew=o,this.cleanText=(0,i.normalizeText)(this.label)}}class y extends d._{constructor(e){super(e),this.options=e,this._enableAddNew=!0,this._showAddNew=!1;const t=e.field.widgetOptionsJson.peek().choices||[];this._choiceOptionsByName=e.field.widgetOptionsJson.peek().choiceOptions||{};const o=t.map((e=>new b(e,!1))),c=new Set(t),d=new i.ACIndexImpl(o),u={menuCssClass:`${l.menuCssClass} ${S.className} test-autocomplete`,search:async e=>this._maybeShowAddNew(d.search(e),e),renderItem:(e,t)=>this._renderACItem(e,t),getItemText:e=>e.label};this.commandGroup=this.autoDispose((0,n.createGroup)(e.commands,null,!0)),this._alignment=e.field.widgetOptionsJson.peek().alignment||"left";const f=(0,p.xD)(e.cellValue),y=(e.editValue||!Array.isArray(f)?[]:f).map((e=>new b(String(e),!c.has(String(e)))));this._tokenField=s.T.ctor().create(this,{initialValue:y,renderToken:e=>{var t,o,n,i,s,r,l,a;return[e.label,g.dom.style("background-color",(0,h.Yp)(this._choiceOptionsByName[e.label])),g.dom.style("color",(0,h.Us)(this._choiceOptionsByName[e.label])),g.dom.cls("font-bold",null!=(o=null==(t=this._choiceOptionsByName[e.label])?void 0:t.fontBold)&&o),g.dom.cls("font-underline",null!=(i=null==(n=this._choiceOptionsByName[e.label])?void 0:n.fontUnderline)&&i),g.dom.cls("font-italic",null!=(r=null==(s=this._choiceOptionsByName[e.label])?void 0:s.fontItalic)&&r),g.dom.cls("font-strikethrough",null!=(a=null==(l=this._choiceOptionsByName[e.label])?void 0:l.fontStrikethrough)&&a),m.cssChoiceToken.cls("-invalid",e.isInvalid)]},createToken:e=>new b(e,!c.has(e)),acOptions:u,openAutocompleteOnFocus:!0,readonly:e.readonly,trimLabels:!0,styles:{cssTokenField:_,cssToken:w,cssDeleteButton:x,cssDeleteIcon:C}}),this._dom=(0,g.dom)("div.default_editor",g.dom.cls("readonly_editor",e.readonly),g.dom.cls(I.className,e.readonly),this.cellEditorDiv=v((0,r.testId)("widget-text-editor"),this._contentSizer=D(),(e=>this._tokenField.attach(e))),(0,a.createMobileButtons)(e.commands)),this._textInput=this._tokenField.getTextInput(),g.dom.update(this._tokenField.getRootElem(),g.dom.style("justify-content",this._alignment)),g.dom.update(this._tokenField.getHiddenInput(),this.commandGroup.attach()),g.dom.update(this._textInput,g.dom.on("input",(()=>this.resizeInput(!0))),g.dom.prop("value",e.editValue||""),this.commandGroup.attach())}attach(e){this._editorPlacement=c.EditorPlacement.create(this,this._dom,e,{margins:(0,a.getButtonMargins)()}),this.autoDispose(this._editorPlacement.onReposition.addListener((()=>this.resizeInput()))),this.autoDispose(this._tokenField.tokensObs.addListener((()=>Promise.resolve().then((()=>this.resizeInput()))))),this.setSizerLimits(),this.resizeInput(),this._textInput.focus();const t=Math.min(this.options.cursorPos,this._textInput.value.length);this._textInput.setSelectionRange(t,t)}getDom(){return this._dom}getCellValue(){return(0,p.Cx)(this._tokenField.tokensObs.get().map((e=>e.label)))}getTextValue(){const e=this._tokenField.tokensObs.get().map((e=>e.label));return(0,u.cw)(e,{prettier:!0})}getCursorPos(){return this._textInput.selectionStart||0}async prepForSave(){const e=this._tokenField.tokensObs.get().filter((e=>e.isNew)).map((e=>e.label));if(e.length>0){const t=this.options.field.widgetOptionsJson.prop("choices");await t.saveOnly([...t.peek()||[],...new Set(e)])}}setSizerLimits(){const e=this._tokenField.getRootElem(),t=this._editorPlacement.calcSizeWithPadding(e,{width:1/0,height:1/0},{calcOnly:!0});this._contentSizer.style.maxWidth=Math.ceil(t.width)+"px"}resizeInput(e=!1){if(this.isDisposed())return;const t=this._tokenField.getRootElem();e&&this._inputSizer||(this._contentSizer.innerHTML="",g.dom.update(this._contentSizer,g.dom.update(t.cloneNode(!0),g.dom.style("width",""),g.dom.style("height",""),this._inputSizer=k(),g.dom.cls("test-tokenfield",!1)))),this._inputSizer.textContent=this._textInput.value+"​";const o=this._contentSizer.getBoundingClientRect(),n=this._editorPlacement.calcSizeWithPadding(t,o);t.style.width=n.width+"px",t.style.height=n.height+"px",this._textInput.style.width=this._inputSizer.getBoundingClientRect().width+"px"}_maybeShowAddNew(e,t){this._showAddNew=!1;const o=t.trim();if(!this._enableAddNew||!o)return e;const n=new b(o,!1,!0);return e.items.find((e=>e.cleanText===n.cleanText))||(e.items.push(n),this._showAddNew=!0),e}_renderACItem(e,t){const o=this._choiceOptionsByName[e.label];return(0,m.cssChoiceACItem)(e.isNew?[m.cssChoiceACItem.cls("-new"),R(F("Plus"))]:[m.cssChoiceACItem.cls("-with-new",this._showAddNew)],(0,m.choiceToken)((0,i.buildHighlightedDom)(e.label,t,T),o||{},g.dom.style("max-width","100%"),(0,r.testId)("choice-list-editor-item-label")),(0,r.testId)("choice-list-editor-item"),e.isNew?(0,r.testId)("choice-list-editor-new-item"):null)}}const v=(0,g.styled)("div",`\n  background-color: ${r.theme.cellEditorBg};\n  font-family: var(--grist-font-family-data);\n  font-size: var(--grist-medium-font-size);\n`),_=(0,g.styled)(s.c.cssTokenField,"\n  border: none;\n  align-items: start;\n  align-content: start;\n  padding: 0 3px;\n  height: min-content;\n  min-height: 22px;\n  color: black;\n  flex-wrap: wrap;\n"),w=(0,g.styled)(s.c.cssToken,`\n  padding: 1px 4px;\n  margin: 2px;\n  line-height: 16px;\n  white-space: pre;\n\n  &.selected {\n    box-shadow: inset 0 0 0 1px ${r.colors.lightGreen};\n  }\n`),x=(0,g.styled)(s.c.cssDeleteButton,`\n  position: absolute;\n  top: -8px;\n  right: -6px;\n  border-radius: 16px;\n  background-color: ${r.colors.dark};\n  width: 14px;\n  height: 14px;\n  cursor: pointer;\n  z-index: 1;\n  display: none;\n  align-items: center;\n  justify-content: center;\n\n  .${w.className}:hover & {\n    display: flex;\n  }\n  .${_.className}.token-dragactive & {\n    cursor: unset;\n  }\n`),C=(0,g.styled)(s.c.cssDeleteIcon,`\n  --icon-color: ${r.colors.light};\n  &:hover {\n    --icon-color: ${r.colors.darkGrey};\n  }\n`),D=(0,g.styled)("div",`\n  position: absolute;\n  left: 0;\n  top: -100px;\n  border: none;\n  visibility: hidden;\n  overflow: visible;\n  width: max-content;\n\n  & .${s.c.cssInputWrapper.className} {\n    display: none;\n  }\n`),k=(0,g.styled)("div","\n  flex: auto;\n  min-width: 24px;\n  margin: 3px 2px;\n"),S=(0,g.styled)("div",`\n  z-index: 1001;\n  box-shadow: 0 0px 8px 0 ${r.theme.menuShadow};\n  overflow-y: auto;\n  padding: 8px 0 0 0;\n  --weaseljs-menu-item-padding: 8px 16px;\n`),I=(0,g.styled)("div","\n  padding-left: 16px;\n  background: white;\n"),T=(0,g.styled)("span","\n  text-decoration: underline;\n"),R=(0,g.styled)("div",`\n  display: inline-block;\n  width: 20px;\n  height: 20px;\n  border-radius: 20px;\n  margin-right: 8px;\n  text-align: center;\n  background-color: ${r.colors.lightGreen};\n  color: ${r.colors.light};\n\n  .selected > & {\n    background-color: ${r.colors.darkGreen};\n  }\n`),F=(0,g.styled)(f.icon,`\n  background-color: ${r.colors.light};\n`)},74987:(e,t,o)=>{"use strict";o.d(t,{Rf:()=>ie,Yp:()=>oe,Us:()=>ne});var n=o(3411),i=o(29922),s=o(64982),r=o(11187),l=o(89068),a=o(29002),c=o(7454),d=o(18099),u=o(77143),p=Object.defineProperty,h=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,g=(e,t,o)=>t in e?p(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,b=(e,t)=>{for(var o in t||(t={}))m.call(t,o)&&g(e,o,t[o]);if(h)for(var o of h(t))f.call(t,o)&&g(e,o,t[o]);return e};const y=o(36812),v=o(76274);class _{constructor(e){for(const{label:t,previousLabel:o}of e.filter((e=>e.previousLabel)))t!==o&&(this[o]=t)}}class w{constructor(e,t,o){this.label=e,this.previousLabel=t,this.options=o}static from(e){return new w(e.label,e.previousLabel,e.options)}rename(e){return new w(e,this.previousLabel,this.options)}changeStyle(e){return new w(this.label,this.previousLabel,b(b({},this.options),e))}}const x={ChoiceItemType:(0,u.iface)([],{label:"string",previousLabel:(0,u.union)("string","null"),options:(0,u.opt)("ChoiceOptionsType")}),ChoiceOptionsType:(0,u.iface)([],{textColor:(0,u.opt)("string"),fillColor:(0,u.opt)("string"),fontBold:(0,u.opt)("boolean"),fontUnderline:(0,u.opt)("boolean"),fontItalic:(0,u.opt)("boolean"),fontStrikethrough:(0,u.opt)("boolean")})},{ChoiceItemType:C}=(0,u.createCheckers)(x);class D extends d.Disposable{constructor(e,t,o,n,i){super(),this._values=e,this._choiceOptionsByName=t,this._onSave=o,this._disabled=n,this._mixed=i,this._isEditing=d.Observable.create(this,!1),this._tokenFieldHolder=d.Holder.create(this),this.autoDispose(this._values.addListener((()=>{this._cancel()})))}buildDom(e=6){return d.dom.domComputed(this._isEditing,(t=>{if(t){const e=this._mixed.get()?[]:this._values.get().map((e=>new w(e,e,this._choiceOptionsByName.get().get(e)))),t=s.T.ctor().create(this._tokenFieldHolder,{initialValue:e,renderToken:e=>this._renderToken(e),createToken:e=>new w(e,null),clipboardToTokens:R,tokensToClipboard:(e,t)=>{t.setData("application/json",JSON.stringify(e)),t.setData("text/plain",e.map((e=>e.label)).join("\n"))},openAutocompleteOnFocus:!1,trimLabels:!0,styles:{cssTokenField:E,cssToken:M,cssTokenInput:N,cssInputWrapper:z,cssDeleteButton:W,cssDeleteIcon:G},keyBindings:{previous:"ArrowUp",next:"ArrowDown"},variant:"vertical"});return j(F((e=>{t.attach(e),this._focusOnOpen(t.getTextInput())}),(0,i.testId)("choice-list-entry")),H((0,r.primaryButton)("Save",d.dom.on("click",(()=>this._save())),(0,i.testId)("choice-list-entry-save")),(0,r.basicButton)("Cancel",d.dom.on("click",(()=>this._cancel())),(0,i.testId)("choice-list-entry-cancel"))),d.dom.onKeyDown({Escape$:()=>this._cancel()}),d.dom.onKeyDown({Enter$:()=>this._save()}))}{const t=new d.MultiHolder,o=d.Computed.create(t,this._values,((t,o)=>o.length<=e?o:o.slice(0,e-1))),s=d.Computed.create(t,o,((e,t)=>0===t.length));return j(d.dom.autoDispose(t),d.dom.maybe(this._mixed,(()=>[A(d.dom.cls(n.cssBlockedCursor.className,this._disabled),S("Mixed configuration"))])),d.dom.maybe((e=>!e(this._mixed)),(()=>[A(d.dom.cls(n.cssBlockedCursor.className,this._disabled),d.dom.maybe(s,(()=>S("No choices configured"))),d.dom.domComputed(this._choiceOptionsByName,(e=>d.dom.forEach(o,(t=>{var o,n,s,r,l,a,c,u;return S(P(d.dom.style("background-color",T(e.get(t))||"#FFFFFF"),d.dom.style("color",I(e.get(t))||"#000000"),d.dom.cls("font-bold",null!=(n=null==(o=e.get(t))?void 0:o.fontBold)&&n),d.dom.cls("font-underline",null!=(r=null==(s=e.get(t))?void 0:s.fontUnderline)&&r),d.dom.cls("font-italic",null!=(a=null==(l=e.get(t))?void 0:l.fontItalic)&&a),d.dom.cls("font-strikethrough",null!=(u=null==(c=e.get(t))?void 0:c.fontStrikethrough)&&u),"T",(0,i.testId)("choice-list-entry-color")),B(t,(0,i.testId)("choice-list-entry-label")))})))),d.dom.maybe((t=>t(this._values).length>e),(()=>S((0,d.dom)("span",(0,i.testId)("choice-list-entry-label"),d.dom.text((t=>`+${t(this._values).length-(e-1)} more`)))))),d.dom.on("click",(()=>this._startEditing())),A.cls("-disabled",this._disabled),(0,i.testId)("choice-list-entry"))])),d.dom.maybe((e=>!e(this._disabled)),(()=>[H((0,r.primaryButton)(d.dom.text((e=>e(this._mixed)?"Reset":"Edit")),d.dom.on("click",(()=>this._startEditing())),(0,i.testId)("choice-list-entry-edit")))])))}}))}_startEditing(){this._disabled.get()||this._isEditing.set(!0)}_save(){const e=this._tokenFieldHolder.get();if(!e)return;const t=e.tokensObs.get(),o=e.getTextInputValue();""!==o&&t.push(new w(o,null));const n=v(t,(e=>e.label)),i=n.map((e=>e.label)),s=new Map,r=["fillColor","textColor","fontBold","fontItalic","fontStrikethrough","fontUnderline"];for(const e of n)if(e.options){const t={};r.filter((t=>void 0!==e.options[t])).forEach((o=>t[o]=e.options[o])),s.set(e.label,t)}y(this._values.get(),i)&&y(this._choiceOptionsByName.get(),s)?this._cancel():this._onSave(i,s,new _(n))}_cancel(){this._isEditing.set(!1)}_focusOnOpen(e){setTimeout((()=>k(e)),0)}_renderToken(e){var t,o,n,s;const r=d.Observable.create(null,T(e.options)),c=d.Observable.create(null,I(e.options)),u=d.Observable.create(null,null==(t=e.options)?void 0:t.fontBold),p=d.Observable.create(null,null==(o=e.options)?void 0:o.fontItalic),h=d.Observable.create(null,null==(n=e.options)?void 0:n.fontUnderline),m=d.Observable.create(null,null==(s=e.options)?void 0:s.fontStrikethrough),f=d.Observable.create(null,e.label);function g(e){e.stopPropagation()}const b=U(d.dom.autoDispose(r),d.dom.autoDispose(c),d.dom.autoDispose(f),(0,l.UV)({textColor:new l.Mv({color:c,defaultColor:"#000000"}),fillColor:new l.Mv({color:r,allowsNone:!0,noneText:"none",defaultColor:"#FFFFFF"}),fontBold:u,fontItalic:p,fontUnderline:h,fontStrikethrough:m},(async()=>{const t=this._tokenFieldHolder.get();if(!t)return;const o=r.get(),n=c.get(),i=u.get(),s=p.get(),l=h.get(),a=m.get();t.replaceToken(e.label,w.from(e).changeStyle({fillColor:o,textColor:n,fontBold:i,fontItalic:s,fontUnderline:l,fontStrikethrough:a}))})),(0,a.editableLabel)(f,{save:async t=>{const o=this._tokenFieldHolder.get();o&&((t=t.trim())?o.replaceToken(e.label,w.from(e).rename(t)):f.set(e.label))},inputArgs:[(0,i.testId)("token-label"),d.dom.on("keydown",g),d.dom.on("copy",g),d.dom.on("cut",g),d.dom.on("paste",g),d.dom.onKeyDown({Enter:()=>{const e=this._tokenFieldHolder.get();e&&k(e.getTextInput())},Escape:()=>{var e;return null==(e=b.parentElement)?void 0:e.focus()}}),d.dom.on("click",g),d.dom.cls($.className)],args:[d.dom.cls(L.className)]}));return[b,d.dom.onKeyDown({Escape$:()=>this._cancel()})]}}function k(e){e.focus(),e.setSelectionRange(e.value.length,e.value.length),e.scrollTo(0,e.scrollHeight)}function S(...e){return O(...e,(0,i.testId)("choice-list-entry-row"))}function I(e){return null==e?void 0:e.textColor}function T(e){return null==e?void 0:e.fillColor}function R(e){const t=e.getData("application/json");if(t&&function(e){try{return JSON.parse(e),!0}catch(e){return!1}}(t)){const e=JSON.parse(t);if(Array.isArray(e)&&e.every((e=>C.test(e))))return e.forEach((e=>e.previousLabel=null)),e}const o=e.getData("text/plain");return o?o.split("\n").map((e=>new w(e,null))):[]}const F=(0,d.styled)("div",`\n  width: 100%;\n  padding: 1px;\n  line-height: 1.5;\n  padding-left: 4px;\n  padding-right: 4px;\n  border: 1px solid ${i.theme.choiceEntryBorderHover};\n  border-radius: 4px;\n  background-color: ${i.theme.choiceEntryBg};\n`),A=(0,d.styled)(F,`\n  cursor: pointer;\n  border: 1px solid ${i.theme.choiceEntryBorder};\n\n  &:hover:not(&-disabled) {\n    border: 1px solid ${i.theme.choiceEntryBorderHover};\n  }\n  &-disabled {\n    opacity: 0.6;\n  }\n`),O=(0,d.styled)("div",`\n  display: flex;\n  margin-top: 4px;\n  margin-bottom: 4px;\n  padding: 4px 8px;\n  color: ${i.colors.dark};\n  background-color: ${i.colors.mediumGreyOpaque};\n  border-radius: 3px;\n  text-overflow: ellipsis;\n`),E=(0,d.styled)("div","\n  &.token-dragactive {\n    cursor: grabbing;\n  }\n"),M=(0,d.styled)(O,`\n  position: relative;\n  display: flex;\n  justify-content: space-between;\n  user-select: none;\n  cursor: grab;\n\n  &.selected {\n    background-color: ${i.colors.darkGrey};\n  }\n  &.token-dragging {\n    pointer-events: none;\n    z-index: 1;\n    opacity: 0.7;\n  }\n  .${E.className}.token-dragactive & {\n    cursor: unset;\n  }\n  &:focus {\n    outline: none;\n  }\n`),P=(0,d.styled)("div","\n  flex-shrink: 0;\n  width: 18px;\n  height: 18px;\n  display: grid;\n  place-items: center;\n"),B=(0,d.styled)("span","\n  margin-left: 6px;\n  display: inline-block;\n  text-overflow: ellipsis;\n  white-space: pre;\n  overflow: hidden;\n"),$=(0,d.styled)("input","\n  display: inline-block;\n  text-overflow: ellipsis;\n  white-space: pre;\n  overflow: hidden;\n"),L=(0,d.styled)("div","\n  margin-left: 6px;\n  text-overflow: ellipsis;\n  white-space: pre;\n  overflow: hidden;\n"),N=(0,d.styled)("input",`\n  background-color: ${i.theme.choiceEntryBg};\n  padding-top: 4px;\n  padding-bottom: 4px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  flex: auto;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n  border: none;\n  outline: none;\n`),z=(0,d.styled)("div","\n  margin-top: 4px;\n  margin-bottom: 4px;\n  position: relative;\n  flex: auto;\n  display: flex;\n"),V=(0,d.styled)("div","\n  display: flex;\n"),U=(0,d.styled)(V,"\n  max-width: calc(100% - 20px);\n"),j=(0,d.styled)("div","\n  width: 100%;\n  display: flex;\n  flex-direction: column;\n"),H=(0,d.styled)("div","\n  gap: 8px;\n  display: flex;\n  margin-top: 8px;\n  margin-bottom: 16px;\n"),W=(0,d.styled)("div",`\n  display: inline;\n  float: right;\n  margin-left: 4px;\n  cursor: pointer;\n  .${E.className}.token-dragactive & {\n    cursor: unset;\n  }\n`),G=(0,d.styled)(c.icon,`\n   --icon-color: ${i.colors.slate};\n   &:hover {\n     --icon-color: ${i.colors.dark};\n   }\n `);var Y=o(55330),K=o(61957),q=Object.defineProperty,J=Object.defineProperties,Z=Object.getOwnPropertyDescriptors,Q=Object.getOwnPropertySymbols,X=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable,te=(e,t,o)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;function oe(e){var t;return null!=(t=null==e?void 0:e.fillColor)?t:Y.DEFAULT_FILL_COLOR}function ne(e){var t;return null!=(t=null==e?void 0:e.textColor)?t:Y.DEFAULT_TEXT_COLOR}class ie extends K.D{constructor(e){super(e),this._choices=this.options.prop("choices"),this._choiceOptions=this.options.prop("choiceOptions"),this._choiceValues=d.Computed.create(this,(e=>e(this._choices)||[])),this._choiceValuesSet=d.Computed.create(this,this._choiceValues,((e,t)=>new Set(t))),this._choiceOptionsByName=d.Computed.create(this,(e=>{return(t=e(this._choiceOptions))?new Map(Object.entries(t)):new Map;var t}))}buildDom(e){const t=e.cells[this.field.colId()];return re(le(d.dom.style("justify-content",(e=>"right"===e(this.alignment)?"flex-end":e(this.alignment))),d.dom.domComputed((o=>{if(this.isDisposed()||o(e._isAddRow))return null;const n=o(this.valueFormatter).formatAny(o(t));return""===n?null:(0,Y.choiceToken)(n,(s=((e,t)=>{for(var o in t||(t={}))X.call(t,o)&&te(e,o,t[o]);if(Q)for(var o of Q(t))ee.call(t,o)&&te(e,o,t[o]);return e})({},o(this._choiceOptionsByName).get(n)||{}),r={invalid:!o(this._choiceValuesSet).has(n)},J(s,Z(r))),d.dom.cls(ae.className),(0,i.testId)("choice-token"));var s,r}))))}buildConfigDom(){const e=d.Computed.create(null,(e=>e(this.field.disableModify)||e(e(this.field.column).disableEditData)||e(this.field.config.options.disabled("choices")))),t=d.Computed.create(null,(t=>!t(e)&&(t(this.field.config.options.mixed("choices"))||t(this.field.config.options.mixed("choiceOptions")))));return[super.buildConfigDom(),(0,n.cssLabel)("CHOICES"),(0,n.cssRow)(d.dom.autoDispose(e),d.dom.autoDispose(t),d.dom.create(D,this._choiceValues,this._choiceOptionsByName,this.save.bind(this),e,t))]}buildTransformConfigDom(){return this.buildConfigDom()}getChoiceValuesSet(){return this._choiceValuesSet}getChoiceOptions(){return this._choiceOptionsByName}save(e,t,o){const n={choices:e,choiceOptions:se(t)};return this.field.config.updateChoices(o,n)}}function se(e){const t={};for(const[o,n]of e.entries())t[o]=n;return t}const re=(0,d.styled)("div.field_clip","\n  padding: 0 3px;\n"),le=(0,d.styled)("div","\n  display: flex;\n  width: 100%;\n  min-width: 0px;\n  overflow: hidden;\n"),ae=(0,d.styled)("div","\n  margin: 2px;\n  height: min-content;\n  line-height: 16px;\n")},55330:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DEFAULT_FILL_COLOR:()=>s,DEFAULT_TEXT_COLOR:()=>r,choiceToken:()=>l,cssChoiceACItem:()=>c,cssChoiceToken:()=>a});var n=o(29922),i=o(18099);const s=n.colors.mediumGreyOpaque.value,r="#000000";function l(e,t,...o){const{fillColor:n,textColor:l,fontBold:c,fontItalic:d,fontUnderline:u,fontStrikethrough:p,invalid:h}=t;return a(e,i.dom.style("background-color",null!=n?n:s),i.dom.style("color",null!=l?l:r),i.dom.cls("font-bold",null!=c&&c),i.dom.cls("font-underline",null!=u&&u),i.dom.cls("font-italic",null!=d&&d),i.dom.cls("font-strikethrough",null!=p&&p),h?a.cls("-invalid"):null,...o)}const a=(0,i.styled)("div",`\n  display: inline-block;\n  padding: 1px 4px;\n  border-radius: 3px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: pre;\n\n  &-invalid {\n    background-color: white !important;\n    box-shadow: inset 0 0 0 1px ${n.colors.error};\n  }\n`),c=(0,i.styled)("li",`\n  display: block;\n  font-family: ${n.vars.fontFamily};\n  white-space: pre;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  outline: none;\n  padding: var(--weaseljs-menu-item-padding, 8px 24px);\n  cursor: pointer;\n\n  &.selected {\n    background-color: ${n.theme.autocompleteChoiceSelectedBg};\n  }\n  &-with-new {\n    scroll-margin-bottom: 37px;\n  }\n  &-new {\n    display: flex;\n    align-items: center;\n    position: sticky;\n    bottom: 0px;\n    height: 37px;\n    background-color: ${n.theme.menuBg};\n    border-top: 1px solid ${n.theme.menuBorder};\n    scroll-margin-bottom: initial;\n  }\n`)},31825:(e,t,o)=>{"use strict";o.d(t,{o:()=>g});var n=o(3898),i=o(7485),s=o(8881),r=o(11187),l=o(89068),a=o(29922),c=o(7454),d=o(49506),u=o(20354),p=o(631),h=o(18099);const m=o(88466),f=(0,h.makeTestId)("test-widget-style-");class g extends h.Disposable{constructor(e,t,o,n){super(),this._label=e,this._ruleOwner=t,this._gristDoc=o,this._disabled=n,this._dataChangeTrigger=h.Observable.create(this,0),this._currentRecord=h.Computed.create(this,(e=>{if(!e(this._ruleOwner.hasRules))return;e(this._dataChangeTrigger);const n=e(t.tableId),i=o.docData.getTable(n),s=e(o.cursorPosition);return s&&"number"==typeof s.rowId?i.getRecord(s.rowId):void 0}));const i=m((()=>{this._dataChangeTrigger.isDisposed()||this._dataChangeTrigger.set(this._dataChangeTrigger.get()+1)}),0);h.Computed.create(this,(e=>{const n=e(t.tableId),s=o.docData.getTable(n);return s?e.owner.autoDispose(s.tableActionEmitter.addListener(i)):null}))}buildDom(){return[v({style:"margin-top: 16px"},(0,s.withInfoTooltip)((0,r.textButton)("Add conditional style",f("add-conditional-style"),h.dom.on("click",(()=>this._ruleOwner.addEmptyRule())),h.dom.prop("disabled",this._disabled)),"Row Style"===this._label?i.D.addRowConditionalStyle():i.D.addColumnConditionalStyle()),h.dom.hide((e=>e(this._ruleOwner.hasRules)))),h.dom.domComputedOwned((e=>e(this._ruleOwner.rulesCols)),((e,t)=>x(h.dom.show((e=>t.length>0&&(!this._disabled||!e(this._disabled)))),...t.map(((t,o)=>{const n=this._buildStyleOption(e,o,"textColor"),i=this._buildStyleOption(e,o,"fillColor"),s=this._buildStyleOption(e,o,"fontBold"),r=this._buildStyleOption(e,o,"fontItalic"),a=this._buildStyleOption(e,o,"fontUnderline"),c=this._buildStyleOption(e,o,"fontStrikethrough"),d=h.Computed.create(e,(e=>{const o=e(this._currentRecord);if(!o)return null;const n=o[e(t.colId)];return null!=n?n:null})),u=h.Computed.create(e,(e=>!(0,p.isValidRuleValue)(e(d)))),m=h.Computed.create(e,(e=>{const t=e(d);return e(u)?(0,p.isRaisedException)(t)?"Error in style rule":"Rule must return True or False":""}));return(0,h.dom)("div",f(`conditional-rule-${o}`),f("conditional-rule"),w("IF..."),k(S(this._buildRuleFormula(t.formula,t,u),D(h.dom.text(m),h.dom.show(u),f(`rule-error-${o}`)),(0,l.Lz)({textColor:new l.Mv({color:n,allowsNone:!0,noneText:"default"}),fillColor:new l.Mv({color:i,allowsNone:!0,noneText:"none"}),fontBold:s,fontItalic:r,fontUnderline:a,fontStrikethrough:c},{onSave:async()=>{await this._ruleOwner.rulesStyles.save()},placeholder:this._label||"Conditional Style"})),_("Remove",f(`remove-rule-${o}`),h.dom.on("click",(()=>this._ruleOwner.removeRule(o))))))}))))),v((0,r.textButton)("Add another rule",h.dom.on("click",(()=>this._ruleOwner.addEmptyRule())),f("add-another-rule"),h.dom.prop("disabled",(e=>this._disabled&&e(this._disabled)))),h.dom.show((e=>e(this._ruleOwner.hasRules))))]}_buildStyleOption(e,t,o){const n=h.Computed.create(e,(e=>{var n;const i=e(this._ruleOwner.rulesStyles);return null==(n=null==i?void 0:i[t])?void 0:n[o]}));return n.onWrite((e=>{var n,i;const s=Array.from(null!=(n=this._ruleOwner.rulesStyles.peek())?n:[]);s[t]=null!=(i=s[t])?i:{},s[t][o]=e,this._ruleOwner.rulesStyles(s)})),n}_buildRuleFormula(e,t,o){return(0,n.cssFieldFormula)(e,{maxLines:1},h.dom.cls("formula_field_sidepane"),h.dom.cls(C.className,o),{tabIndex:"-1"},h.dom.on("focus",((e,o)=>{const n=this._gristDoc.viewModel.activeSection(),i=n.viewInstance(),s=(0,u.Ex)({gristDoc:this._gristDoc,editingFormula:n.editingFormula,column:t,editRow:null==i?void 0:i.moveEditRowToCursor(),refElem:o,setupCleanup:d.Sf});this._gristDoc.fieldEditorHolder.autoDispose(s)})))}}const b=(0,h.styled)(c.icon,"\n  flex: 0 0 auto;\n"),y=(0,h.styled)("div",`\n  text-transform: uppercase;\n  margin: 16px 16px 12px 16px;\n  color: ${a.theme.text};\n  font-size: ${a.vars.xsmallFontSize};\n`),v=(0,h.styled)("div",`\n  display: flex;\n  margin: 8px 16px;\n  align-items: center;\n  &-top-space {\n    margin-top: 24px;\n  }\n  &-disabled {\n    color: ${a.theme.disabledText};\n  }\n`),_=(0,h.styled)(b,`\n  flex: none;\n  margin: 6px;\n  margin-right: 0px;\n  transform: translateY(4px);\n  cursor: pointer;\n  --icon-color: ${a.theme.controlSecondaryFg};\n  &:hover {\n    --icon-color: ${a.theme.controlFg};\n  }\n`),w=(0,h.styled)(y,"\n  margin-top: 0px;\n  margin-bottom: 0px;\n"),x=(0,h.styled)("div","\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  margin-top: 16px;\n  margin-bottom: 12px;\n"),C=(0,h.styled)("div",`\n  border-color: ${a.theme.inputInvalid};\n`),D=(0,h.styled)(u.So,"\n  margin: 2px 0px 10px 0px;\n"),k=(0,h.styled)(v,"\n  align-items: flex-start;\n  margin-top: 0px;\n  margin-bottom: 0px;\n"),S=(0,h.styled)("div","\n  overflow: hidden;\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n")},66632:(e,t,o)=>{"use strict";o.d(t,{g:()=>a});var n=o(84462),i=o(18099),s=o(11104),r=o(29922),l=o(22985);function a(e,t,o,{defaultCurrencyLabel:a,disabled:c}){const d=l.QT.map((e=>({value:e.code,label:`${e.code} ${e.name}`,cleanText:`${e.code} ${e.name}`.trim().toLowerCase()})));d.unshift({label:a,value:a,cleanText:a.toLowerCase()});const u=i.Computed.create(e,(e=>e(t)||a)),p=new s.ACIndexImpl(d,200,!0);return(0,n.R)(e,{acIndex:p,valueObs:u,disabled:c,save(e,t){if(!t)throw new Error("Invalid currency");o(t.value===a?void 0:t.value)}},(0,r.testId)("currency-autocomplete"))}},85837:(e,t,o)=>{"use strict";o.d(t,{XY:()=>M,c8:()=>E,un:()=>z});var n=o(29813),i=o(59727),s=o(76961),r=o(92769),l=o(3871),a=o(18222),c=o(11187),d=o(92478),u=o(29922),p=o(7454),h=o(1370),m=o(631),f=o(18099),g=o(84418),b=o(29301),y=o(60611),v=o.n(y),_=o(20106),w=Object.defineProperty,x=Object.defineProperties,C=Object.getOwnPropertyDescriptors,D=Object.getOwnPropertySymbols,k=Object.prototype.hasOwnProperty,S=Object.prototype.propertyIsEnumerable,I=(e,t,o)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,T=(e,t)=>{for(var o in t||(t={}))k.call(t,o)&&I(e,o,t[o]);if(D)for(var o of D(t))S.call(t,o)&&I(e,o,t[o]);return e},R=(e,t)=>x(e,C(t));const F=o(16914),A=(0,f.makeTestId)("test-discussion-");class O extends f.Disposable{constructor(e){super(),this.gristDoc=e}async comment(e){}async reply(e,t){const o=H(this.gristDoc);await this.gristDoc.docData.bundleActions("Reply to a comment",(()=>{var n,i;return Promise.all([this.gristDoc.docModel.cells.sendTableAction(["AddRecord",null,{parentId:e.id.peek(),root:!1,type:m.CellInfoType.COMMENT,userRef:null!=(n=null==o?void 0:o.ref)?n:"",content:JSON.stringify({userName:null!=(i=null==o?void 0:o.name)?i:"",timeCreated:Date.now(),timeUpdated:null,text:t}),tableRef:e.tableRef.peek(),colRef:e.colRef.peek(),rowId:e.rowId.peek()}])])}))}resolve(e){var t;const o=H(this.gristDoc);return e.resolved(!0),e.resolvedBy(null!=(t=null==o?void 0:o.email)?t:""),e.timeUpdated.setAndSave(Date.now())}async update(e,t){const o=Date.now();return e.text(t.trim()),e.timeUpdated.setAndSave(o)}async open(e){return e.resolved(!1),e.resolvedBy(""),e.timeUpdated.setAndSave(Date.now())}async remove(e){await e._table.sendTableAction(["RemoveRecord",e.id.peek()])}}class E extends O{constructor(e){super(e.gristDoc),this.props=e;const{column:t,rowId:o}=e;this.comments=f.Computed.create(this,(e=>e(e(t.cells).getObservable()).filter((t=>e(t.rowId)===o&&e(t.root)&&!e(t.hidden)))))}async comment(e){var t,o;const n=this.props,i=H(n.gristDoc),s=Date.now(),r=["AddRecord","_grist_Cells",null,{tableRef:n.tableRef,colRef:n.column.id.peek(),rowId:n.rowId,type:m.CellInfoType.COMMENT,root:!0,userRef:null!=(t=null==i?void 0:i.ref)?t:"",content:JSON.stringify({timeCreated:s,text:e,userName:null!=(o=null==i?void 0:i.name)?o:""})}];await n.gristDoc.docData.sendActions([r],"Started discussion")}}class M extends f.Disposable{constructor(e){super(),this.props=e,this._isEmpty=f.Computed.create(this,(t=>0===t(e.topic.comments).filter((e=>!t(e.resolved))).filter((e=>!t(e.hidden))).length));const t=(0,f.dom)("div",A("popup"),f.dom.domComputed((e=>e(this._isEmpty)),(t=>t?f.dom.create(P,{closeClicked:e.closeClicked,onSave:e=>this.props.topic.comment(e)}):f.dom.create(B,{topic:e.topic,readonly:e.gristDoc.isReadonly,gristDoc:e.gristDoc,panel:!1,closeClicked:e.closeClicked}))));!function(e,t,o,n,i){const s=(0,g.fi)(t,o,n);e.onDispose((()=>s.destroy())),document.body.appendChild(o),e.onDispose((()=>{f.dom.domDispose(o),o.remove()})),e.autoDispose(function(e,t){return f.dom.onElem(document,"click",(t=>{var o;const n=t.target;if(n&&!e.contains(n)){if(null==(o=n.parentElement)?void 0:o.closest(".grist-floating-menu"))return;i()}}),{useCapture:!0})}(o))}(this,e.domEl,t,W,this.props.closeClicked)}}class P extends f.Disposable{constructor(e){super(),this.props=e,this._newText=f.Observable.create(this,"")}buildDom(){return re(A("topic-empty"),A("topic"),this._createCommentEntry(),f.dom.onKeyDown({Escape:()=>{var e,t;return null==(t=(e=this.props).closeClicked)?void 0:t.call(e)}}))}_createCommentEntry(){return Z(f.dom.create(N,{mode:"start",text:this._newText,onSave:()=>this.props.onSave(this._newText.get()),onCancel:()=>{var e,t;return null==(t=(e=this.props).closeClicked)?void 0:t.call(e)},editorArgs:[{placeholder:"Write a comment"}],mainButton:"Comment",buttons:["Cancel"],args:[A("editor-start")]}))}}class B extends f.Disposable{constructor(e){super(),this.props=e,this._newText=f.Observable.create(this,""),this._commentInEdit=f.Observable.create(this,null),this._closing=f.Observable.create(this,!1),e.panel?this._comments=f.Computed.create(this,(t=>t(e.topic.comments).filter((e=>!t(e.hidden)&&t(e.root))))):this._comments=f.Computed.create(this,(t=>t(e.topic.comments).filter((e=>!t(e.resolved)&&!t(e.hidden)&&t(e.root))))),this._commentsToRender=f.Computed.create(this,(e=>{const t=e(this._comments).sort(((t,o)=>{var n,i;return(null!=(n=e(t.timeCreated))?n:0)-(null!=(i=e(o.timeCreated))?i:0)})),o=Math.max(0,t.length-200);return t.slice(o)})),this._truncated=f.Computed.create(this,(e=>e(this._comments).length>200))}buildDom(){return re(f.dom.maybe(this._truncated,(()=>Fe("Showing last 200 comments"))),re.cls("-panel",this.props.panel),Se(L.EDIT,(e=>this._onEditComment(e))),Se(L.CANCEL,(e=>this._onCancelEdit())),f.dom.hide(this._closing),A("topic"),A("topic-filled"),f.dom.maybe(!this.props.panel,(()=>se(A("topic-header"),(0,f.dom)("div",f.dom.style("align-self","center"),"Comments"),Ce(),ke((0,p.icon)("Popup"),A("topic-button-panel"),f.dom.on("click",(()=>this.props.gristDoc.showTool("discussion"))),{title:"Open panel"}),se.cls("-border")))),this._discussionList=ue(A("topic-comments"),f.dom.forEach(this._commentsToRender,(e=>le(ae(ae.cls("-resolved",(t=>Boolean(t(e.resolved)))),f.dom.create(L,R(T({},this.props),{comment:e}))))))),this.props.panel?null:this._createCommentEntry(),f.dom.onKeyDown({Escape:()=>{var e,t;return null==(t=(e=this.props).closeClicked)?void 0:t.call(e)}}))}_onCancelEdit(){var e;this._commentInEdit.get()&&(null==(e=this._commentInEdit.get())||e.isEditing.set(!1)),this._commentInEdit.set(null)}_onEditComment(e){var t;this._commentInEdit.get()&&(null==(t=this._commentInEdit.get())||t.isEditing.set(!1)),e.isEditing.set(!0),this._commentInEdit.set(e)}async _save(){try{return await this.props.topic.comment(this._newText.get().trim())}catch(e){return(0,r.reportError)(e)}finally{this._newText.set(""),this._discussionList.scrollTo(0,1e4)}}_createCommentEntry(){return ee(f.dom.create(N,{mode:"comment",text:this._newText,onSave:()=>this._save(),onCancel:()=>{var e,t;return null==(t=(e=this.props).closeClicked)?void 0:t.call(e)},mainButton:"Send",editorArgs:[{placeholder:"Comment"}],args:[A("editor-add")]}))}}const $=class extends f.Disposable{constructor(e){super(),this.props=e,this.isEditing=f.Observable.create(this,!1),this.replying=f.Observable.create(this,!1),this._expanded=f.Observable.create(this,!1),this._replies=(0,i.$)(this,e.comment.children()),this._hasReplies=f.Computed.create(this,(e=>e(this._replies).length>0)),this._resolved=f.Computed.create(this,(t=>Boolean(t(e.comment.resolved)))),this._showReplies=f.Computed.create(this,(e=>!this.props.isReply&&e(this._replies).length>0&&(e(this._expanded)||!e(this.props.comment.resolved))))}buildDom(){var e;const t=this.props.comment,o=this.props.topic,n=e=>t.hidden()?null:H(this.props.gristDoc,e.userRef(),e.userName());return this._bodyDom=me(...null!=(e=this.props.args)?e:[],this.props.isReply?A("reply"):A("comment"),f.dom.on("click",(()=>{this.props.isReply||(Ie(this._bodyDom,$.SELECT,t),this._resolved.get()&&this._expanded.set(!this._expanded.get()))})),f.dom.maybe((e=>!e(t.hidden)),(()=>[pe(V(n(t),A("comment-avatar")),ge(be((0,f.dom)("div",U(n(t),A("comment-nick")),f.dom.domComputed((e=>{var o,n;return we(function(e){const t=v()(e);return v()().diff(t,"days")<1?t.fromNow():t.format("MMM D, YYYY")}(null!=(n=null!=(o=e(t.timeUpdated))?o:e(t.timeCreated))?n:0),A("comment-time"))}))),Ce(),ye((0,p.icon)("Dots"),A("comment-menu"),f.dom.style("margin-left","3px"),(0,h.menu)((()=>this._menuItems()),{placement:"bottom-start"}),f.dom.on("click",G))))),f.dom.maybe((e=>!e(this.isEditing)),(()=>f.dom.domComputed(t.hidden,(e=>e?ce("CENSORED",A("comment-text")):de(f.dom.text((e=>{var o;return null!=(o=e(t.text))?o:""})),{style:"margin-top: 4px"},A("comment-text")))))),f.dom.maybeOwned(this.isEditing,(e=>{var n;const i=f.Observable.create(e,null!=(n=t.text.peek())?n:"");return f.dom.create(N,{text:i,mainButton:"Save",buttons:["Cancel"],onSave:async()=>{const e=i.get();i.set(""),await o.update(t,e),Ie(this._bodyDom,$.CANCEL,this),this.isEditing.set(!1)},onCancel:()=>{Ie(this._bodyDom,$.CANCEL,this),this.isEditing.set(!1)},mode:"start",args:[A("editor-edit")]})})),f.dom.maybe(this._showReplies,(()=>he(A("replies"),fe(f.dom.forEach(this._replies,(e=>(0,f.dom)("div",f.dom.create($,R(T({},this.props),{comment:e,isReply:!0,args:[f.dom.style("padding-left","0px"),f.dom.style("padding-right","0px")]}))))))))),f.dom.maybe((e=>!e(this.isEditing)&&!this.props.isReply&&!e(t.resolved)),(()=>f.dom.domComputed((e=>{if(e(this.replying)){const e=f.Observable.create(null,"");return f.dom.create(N,{text:e,args:[f.dom.style("margin-top","8px"),A("editor-reply")],mainButton:"Reply",buttons:["Cancel"],onSave:async()=>{const n=e.get();this.replying.set(!1),await o.reply(t,n)},onCancel:()=>this.replying.set(!1),onClick:e=>{"Cancel"===e&&this.replying.set(!1)},mode:"reply"})}return _e((0,p.icon)("Message"),"Reply",A("comment-reply-button"),f.dom.on("click",Y((()=>this.replying.set(!0)))),f.dom.style("margin-left",(e=>e(this._hasReplies)?"16px":"0px")))})))),f.dom.domComputed((e=>!e(t.resolved)||this.props.isReply?null:Te(A("comment-resolved"),(0,p.icon)("FieldChoice"),Re(f.dom.text("Marked as resolved")))))]))),this._bodyDom}_menuItems(){var e,t;const o=null==(t=null==(e=this.props.gristDoc.app.topAppModel.appObs.get())?void 0:e.currentUser)?void 0:t.ref,n=!this.props.comment.resolved()&&!this.props.isReply,i=this.props.comment;return[n?(0,h.menuItem)((()=>this.props.topic.resolve(this.props.comment)),"Resolve"):null,i.resolved()?(0,h.menuItem)((()=>this.props.topic.open(i)),"Open"):null,(0,h.menuItem)((()=>this.props.topic.remove(i)),"Remove",f.dom.cls("disabled",(e=>o!==e(i.userRef)))),(0,h.menuItem)((()=>this._edit()),"Edit",f.dom.cls("disabled",(e=>o!==e(i.userRef))))]}_edit(){Ie(this._bodyDom,$.EDIT,this),this.isEditing.set(!0)}};let L=$;L.EDIT="comment-edit",L.CANCEL="comment-cancel",L.SELECT="comment-select";class N extends f.Disposable{constructor(e){super(),this.props=e}buildDom(){var e,t,o;const i=this.props.text,s=e=>f.dom.on("click",(()=>{var t,o,n,i;"Cancel"===e?null==(o=(t=this.props).onCancel)||o.call(t):null==(i=(n=this.props).onClick)||i.call(n,e)})),r=async()=>{var e,t;return i.get()?await(null==(t=(e=this.props).onSave)?void 0:t.call(e)):{}};let l;return te(...null!=(e=this.props.args)?e:[],te.cls(`-${null!=(t=this.props.mode)?t:"comment"}`),A("comment-input"),f.dom.on("click",G),l=function(e,...t){return ie(function(e){return[f.dom.prop("value",e),f.dom.on("input",((t,o)=>e.set(o.value)))]}(e),(e=>{setTimeout((()=>e.focus()),10)}),function(e){return t=>{t.addEventListener("input",(()=>j(t))),setTimeout((()=>j(t)),10),f.dom.autoDisposeElem(t,e.addListener((e=>{e||(t.style.height="5px")})))}}(e),...t)}(i,oe.cls(""),ie.cls(`-${this.props.mode}`),f.dom.onKeyDown({Enter$:async e=>{if((e.ctrlKey||e.metaKey)&&i.get().trim())return await(null==r?void 0:r()),e.preventDefault(),void e.stopPropagation()},Escape:e=>{var t,o;null==(o=(t=this.props).onCancel)||o.call(t),e.preventDefault(),e.stopPropagation()}}),...this.props.editorArgs||[],A("textarea")),(e=>{n.FocusLayer.create(this,{defaultFocusElem:l,allowFocus:e=>e!==document.body,pauseMousetrap:!0})}),ne((0,c.primaryButton)(null!=(o=this.props.mainButton)?o:"Send",f.dom.prop("disabled",(e=>!e(i).trim())),f.dom.on("click",Y(r)),A("button-send")),f.dom.forEach(this.props.buttons||[],(e=>(0,c.basicButton)(e,s(e),A(`button-${e}`))))))}}class z extends f.Disposable{constructor(e){var t,o;super(),this._grist=e,this._length=f.Observable.create(this,0);const n=(null==(o=null==(t=e.app.topAppModel.appObs.get())?void 0:t.currentUser)?void 0:o.id)||0;this._resolved=this.autoDispose((0,s.pD)(`u:${n};showResolvedDiscussions`,!1)),this._onlyMine=this.autoDispose((0,s.pD)(`u:${n};showMyDiscussions`,!1)),this._currentPage=this.autoDispose((0,s.pD)(`u:${n};showCurrentPage`,!0)),this._currentPageKo=b.observable(this._currentPage.get()),this._currentPage.addListener((e=>this._currentPageKo(e)))}buildDom(){var e;const t=new f.MultiHolder,o=f.Computed.create(t,(e=>e(e(this._grist.viewModel.viewSections).getObservable()))),n=f.Computed.create(t,(e=>e(this._currentPageKo)?[...new Set(e(o).map((t=>e(t.table))).filter((t=>e(t.tableId))))]:e(this._grist.docModel.visibleTables.getObservable()).filter((t=>e(t.tableId))))),i=f.Computed.create(t,(e=>{if(e(this._currentPageKo)){const t=new Set;return e(o).forEach((o=>{e(e(o.viewFields).getObservable()).forEach((o=>t.add(e(o.colRef))))})),o=>t.has(e(o.colRef))}return()=>!0})),s=l.RowWatcher.create(t);s.rowFilter.set((()=>!0));const r=t.autoDispose(b.computed((()=>{if(this._currentPageKo()){const e=[];for(const t of this._grist.viewModel.viewSections().all()){const o=t.viewInstance();o&&e.push(o.rowSource)}return e}return null})));null==(e=r.peek())||e.forEach((e=>s.subscribeTo(e))),t.autoDispose(r.subscribe((e=>{(0,f.bundleChanges)((()=>{s.clear(),e?e.forEach((e=>s.subscribeTo(e))):s.rowFilter.set((()=>!0))}))})));const a=s.rowFilter,c=f.Computed.create(t,(e=>{var t,o,n;const s=e(a),r=e(i),l=e(this._resolved),c=!e(this._onlyMine),d=null!=(n=null==(o=null==(t=e(this._grist.app.topAppModel.appObs))?void 0:t.currentUser)?void 0:o.email)?n:"";return t=>!e(t.hidden)&&s(e(t.rowId))&&r(t)&&(c||(t=>{const o=e(e(t.children).getObservable());return e(t.userRef)===d||o.some((t=>e(t.userRef)===d))})(t))&&(l||!e(t.resolved))})),d=f.Computed.create(t,(e=>F(F(e(n).map((t=>e(e(t.columns).getObservable()).map((t=>e(e(t.cells).getObservable()).filter((t=>e(t.root)&&e(t.type)===m.CellInfoType.COMMENT)))))))))),u=f.Computed.create(t,(e=>{const t=e(d),o=e(c);return t.filter(o)})),p=O.create(t,this._grist);return p.comments=u,t.autoDispose(u.addListener((e=>this._length.set(e.length)))),this._length.set(u.get().length),q(f.dom.autoDispose(t),A("panel"),J(f.dom.create(B,{readonly:this._grist.isReadonly,gristDoc:this._grist,topic:p,panel:!0})),Se(L.SELECT,(e=>{this._navigate(e).catch((()=>{}))})))}buildMenu(){return Q((0,f.dom)("span",f.dom.text((e=>`${e(this._length)} comments`)),A("comment-count")),ve((0,p.icon)("Dots"),A("panel-menu"),(0,h.menu)((()=>[X((0,d.rp)(this._onlyMine,"Only my threads",A("my-threads")),(0,d.rp)(this._currentPage,"Only current page",A("only-page")),(0,d.rp)(this._resolved,"Show resolved comments",A("show-resolved")))]),{placement:"bottom-start"}),f.dom.on("click",G)))}async _navigate(e){const t=e.rowId.peek();function o(t){var o;const n=t.filter((t=>t.tableRef.peek()===e.tableRef.peek())).filter((t=>t.viewFields.peek().all().find((t=>t.colRef.peek()===e.colRef.peek()))))[0],i=null==n?void 0:n.getRowId(),s=null!=(o=null==n?void 0:n.viewFields.peek().all().findIndex((t=>t.colRef.peek()===e.colRef.peek())))?o:-1;return-1!==s?{sectionId:i,fieldIndex:s}:null}let n=0,i=-1;const s=o(this._grist.viewModel.viewSections.peek().all());if(s)n=s.sectionId,i=s.fieldIndex;else for(const e of this._grist.docModel.pages.getAllRows()){const t=o(this._grist.docModel.pages.getRowModel(e).view.peek().viewSections.peek().all());if(t){n=t.sectionId,i=t.fieldIndex;break}}if(!n)return;const r=this._grist.cursorPosition.get();(null==r?void 0:r.sectionId)===n&&r.fieldIndex===i&&r.rowId===t||await this._grist.recursiveMoveToCursorPos({rowId:t,sectionId:n,fieldIndex:i},!0)}}function V(e,...t){return K(e,"small",...t)}function U(e,...t){var o;return xe(null!=(o=null==e?void 0:e.name)?o:"Anonymous",...t)}function j(e){e.style.height="5px";const t=getComputedStyle(e,null).borderTopWidth||"0";e.style.height=`calc(${e.scrollHeight}px + 2 * ${t})`}function H(e,t,o){var n;if(t)return"string"!=typeof o?null:{name:o,ref:t||"",email:"",id:0};{const i=null==(n=e.app.topAppModel.appObs.get())?void 0:n.currentValidUser;if(!i)return{name:o||"",ref:t||"",email:"",id:0};if(!i.ref)throw new Error("User reference is not set");return i}}const W={placement:"bottom",strategy:"fixed",modifiers:[R(T({},_.Z),{options:{padding:4}}),{name:"applyMaxSize",enabled:!0,phase:"beforeWrite",requires:["maxSize"],fn({state:e}){const{height:t}=e.modifiersData.maxSize;Object.assign(e.styles.popper,{maxHeight:`${Math.min(Math.max(250,t),600)}px`})}},{name:"offset",options:{offset:[0,4]}},{name:"computeStyles",options:{gpuAcceleration:!1}},{name:"eventListeners",enabled:!1}]};function G(e){e.stopPropagation()}function Y(e){return t=>{G(t),e()}}const K=(0,f.styled)(a.O_,"\n  flex: none;\n  margin-top: 2px;\n"),q=(0,f.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex: 1;\n  overflow: auto;\n  padding: 8px;\n"),J=(0,f.styled)("div","\n  margin-bottom: 0px;\n"),Z=(0,f.styled)("div","\n  padding: 16px;\n"),Q=(0,f.styled)("div","\n  display: flex;\n  flex: 1;\n  align-items: center;\n  justify-content: space-between;\n"),X=(0,f.styled)("div","\n  display: flex;\n  padding: 12px;\n  padding-left: 16px;\n  padding-right: 16px;\n  gap: 10px;\n  flex-direction: column;\n"),ee=(0,f.styled)(Z,`\n  border-top: 1px solid ${u.theme.commentsPopupBorder};\n`),te=(0,f.styled)("div",'\n  display: grid;\n  &-comment {\n    grid-template-columns: 1fr auto;\n    grid-template-rows: 1fr;\n    gap: 8px;\n    grid-template-areas: "text buttons";\n  }\n  &-start, &-reply {\n    grid-template-rows: 1fr auto;\n    grid-template-columns: 1fr;\n    gap: 8px;\n    grid-template-areas: "text" "buttons";\n  }\n'),oe=(0,f.styled)("div","\n  grid-area: text;\n"),ne=(0,f.styled)("div","\n  grid-area: buttons;\n  display: flex;\n  align-items: flex-start;\n\n  gap: 8px;\n"),ie=(0,f.styled)("textarea",`\n  min-height: 5em;\n  border-radius: 3px;\n  padding: 4px 6px;\n  color: ${u.theme.inputFg};\n  background-color: ${u.theme.inputBg};\n  border: 1px solid ${u.theme.inputBorder};\n  outline: none;\n  width: 100%;\n  resize: none;\n  max-height: 10em;\n  &-comment, &-reply {\n    min-height: 28px;\n    height: 28px;\n  }\n  &::placeholder {\n    color: ${u.theme.inputPlaceholderFg};\n  }\n`),se=(0,f.styled)("div",`\n  color: ${u.theme.text};\n  background-color: ${u.theme.commentsPopupHeaderBg};\n  padding: 12px; /* 12px * 2 + 24px (size of the icon) == 48px in height */\n  padding-right: 16px;\n  display: flex;\n  gap: 8px;\n  &-border {\n    border-bottom: 1px solid ${u.theme.commentsPopupBorder};\n  }\n`),re=(0,f.styled)("div",`\n  position: relative;\n  display: flex;\n  flex-direction: column;\n  border: 1px solid ${u.theme.commentsPopupBorder};\n  border-radius: 4px;\n  background-color: ${u.theme.commentsPopupBodyBg};\n  box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);\n  z-index: 100;\n  width: 325px;\n  overflow: hidden;\n  outline: none;\n  max-height: inherit;\n  &-disabled {\n    background-color: ${u.theme.commentsPanelResolvedTopicBg}\n  }\n  &-panel {\n    width: unset;\n    box-shadow: none;\n    border-radius: 0px;\n    background: unset;\n    border: 0px;\n  }\n`),le=(0,f.styled)("div",`\n  border-bottom: 1px solid ${u.theme.commentsPopupBorder};\n  &:last-child {\n    border-bottom: none;\n  }\n  .${re.className}-panel & {\n    border: 1px solid ${u.theme.commentsPanelTopicBorder};\n    border-radius: 4px;\n    background-color: ${u.theme.commentsPanelTopicBg};\n    margin-bottom: 4px;\n  }\n`),ae=(0,f.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  padding: 16px;\n  &-resolved {\n    background-color: ${u.theme.commentsPanelResolvedTopicBg};\n    cursor: pointer;\n  }\n  &-resolved * {\n    color: ${u.theme.lightText} !important;\n  }\n`),ce=(0,f.styled)("div",`\n  color: ${u.theme.text};\n  margin-top: 4px;\n`),de=(0,f.styled)("pre",`\n  color: ${u.theme.text};\n  padding: 0px;\n  font-size: revert;\n  border: 0px;\n  background: inherit;\n  font-family: inherit;\n  margin: 0px;\n  white-space: break-spaces;\n  word-break: break-word;\n  word-wrap: break-word;\n`),ue=(0,f.styled)("div","\n  display: flex;\n  flex-direction: column;\n  overflow: auto;\n"),pe=(0,f.styled)("div","\n  display: flex;\n  align-items: flex-start;\n  gap: 8px;\n"),he=(0,f.styled)("div","\n  margin-top: 16px;\n"),me=(0,f.styled)("div",`\n  border-bottom: 1px solid ${u.theme.commentsPopupBorder};\n  .${ue.className} &:last-child {\n    border-bottom: 0px;\n  }\n`),fe=(0,f.styled)("div","\n  margin-left: 16px;\n  display: flex;\n  flex-direction: column;\n  gap: 20px;\n"),ge=(0,f.styled)("div","\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  gap: 2px;\n  overflow: hidden;\n"),be=(0,f.styled)("div","\n  display: flex;\n  align-items: baseline;\n  overflow: hidden;\n"),ye=(0,f.styled)("div",`\n  flex: none;\n  margin: 0 4px 0 auto;\n  height: 24px;\n  width: 24px;\n  padding: 4px;\n  line-height: 0px;\n  border-radius: 3px;\n  cursor: pointer;\n  --icon-color: ${u.theme.controlSecondaryFg};\n  &:hover, &.weasel-popup-open {\n    background-color: ${u.theme.controlSecondaryHoverBg};\n  }\n`),ve=(0,f.styled)("div",`\n  flex: none;\n  margin: 0 4px 0 auto;\n  height: 24px;\n  width: 24px;\n  padding: 4px;\n  line-height: 0px;\n  border-radius: 3px;\n  cursor: pointer;\n  --icon-color: ${u.theme.rightPanelTabSelectedFg};\n  &:hover, &.weasel-popup-open {\n    background-color: ${u.theme.rightPanelTabButtonHoverBg};\n  }\n`),_e=(0,f.styled)(c.textButton,"\n  align-self: flex-start;\n  display: flex;\n  gap: 4px;\n  margin-top: 16px;\n"),we=(0,f.styled)("div",`\n  color: ${u.theme.lightText};\n  font-size: ${u.vars.smallFontSize};\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  letter-spacing: 0.02em;\n  line-height: 16px;\n`),xe=(0,f.styled)("div",`\n  font-weight: 600;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  overflow: hidden;\n  color: ${u.theme.commentsUserNameFg};\n  &-small {\n    font-size: 12px;\n  }\n`),Ce=(0,f.styled)("div","\n  flex-grow: 1;\n"),De=(0,f.styled)("div",`\n  padding: 4px;\n  border-radius: 4px;\n  line-height: 1px;\n  cursor: pointer;\n  --icon-color: ${u.theme.controlSecondaryFg};\n  &:hover {\n    background-color: ${u.theme.hover};\n  }\n`),ke=(0,f.styled)(De,`\n  &:hover {\n    --icon-color: ${u.theme.controlPrimaryBg};\n  }\n`);function Se(e,t){return o=>{f.dom.onElem(o,e,((e,o)=>{var n;t(null!=(n=e.detail.args)?n:{},e,o)}))}}function Ie(e,t,o){e.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:{args:o}}))}const Te=(0,f.styled)("div",`\n  margin-top: 5px;\n  --icon-color: ${u.theme.text};\n`),Re=(0,f.styled)("span",`\n  color: ${u.theme.text};\n  font-size: ${u.vars.smallFontSize};\n  margin-left: 5px;\n`),Fe=(0,f.styled)("div","\n  position: absolute;\n  background: white;\n  inset: 0;\n  height: 2rem;\n  opacity: 57%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-weight: 600;\n")},16151:(e,t,o)=>{"use strict";o.r(t),o.d(t,{createMobileButtons:()=>l,getButtonMargins:()=>a});var n=o(65106),i=o(29922),s=o(7454),r=o(18099);function l(e){return(0,n.nI)()?null:[d(p(h("CrossSmall")),r.dom.on("click",e.fieldEditCancel)),u(p(h("Tick")),r.dom.on("click",e.fieldEditSaveHere))]}function a(){return(0,n.nI)()?void 0:{left:20,right:20,top:0,bottom:0}}const c=(0,r.styled)("div","\n  height: 40px;\n  width: 40px;\n  padding: 8px;\n  position: absolute;\n  top: -8px;\n  --icon-color: white;\n"),d=(0,r.styled)(c,`\n  --icon-background-color: ${i.colors.error};\n  left: -40px;\n`),u=(0,r.styled)(c,`\n  --icon-background-color: ${i.colors.lightGreen};\n  right: -40px;\n`),p=(0,r.styled)("div","\n  border-radius: 20px;\n  background-color: var(--icon-background-color);\n  height: 24px;\n  width: 24px;\n"),h=(0,r.styled)(s.icon,"\n  height: 24px;\n  width: 24px;\n")},41880:(e,t,o)=>{"use strict";o.r(t),o.d(t,{EditorPlacement:()=>i});var n=o(18099);class i extends n.Disposable{constructor(e,t,o={}){var i,r,l,a;super(),this._cellElem=t,this.onReposition=this.autoDispose(new n.Emitter),this._margins={top:((null==(i=o.margins)?void 0:i.top)||0)+12,bottom:((null==(r=o.margins)?void 0:r.bottom)||0)+12,left:((null==(l=o.margins)?void 0:l.left)||0)+12,right:((null==(a=o.margins)?void 0:a.right)||0)+12},this._maxRect=document.body.getBoundingClientRect(),this._cellRect=s(this._cellElem),this.autoDispose(n.dom.onElem(window,"resize",(()=>{this._maxRect=document.body.getBoundingClientRect(),this._cellRect=s(this._cellElem),this.onReposition.emit()})));const c=this._editorRoot=(0,n.dom)("div.cell_editor",e);c.style.visibility="hidden",document.body.appendChild(c),this.onDispose((()=>{n.dom.domDispose(c),c.remove()}))}calcSize(e,t={}){const o=this._maxRect,n=this._margins,i=o.right-n.right-this._cellRect.left,s=Math.min(o.width-n.left-n.right,Math.max(560,i)),r=Math.min(s,Math.max(this._cellRect.width,e.width)),l=Math.max(n.left,Math.min(this._cellRect.left-o.left,o.width-n.right-r)),a=o.bottom-n.bottom-this._cellRect.top,c=Math.min(o.height-n.top-n.bottom,Math.max(400,a)),d=Math.min(c,Math.max(this._cellRect.height,e.height)),u=Math.max(n.top,Math.min(this._cellRect.top-o.top,o.height-n.bottom-d));return t.calcOnly||Object.assign(this._editorRoot.style,{visibility:"visible",left:l+"px",top:u+"px",width:r+"px","max-height":c+"px"}),{width:r,height:d}}calcSizeWithPadding(e,t,o={}){const n=this._editorRoot.getBoundingClientRect(),i=e.getBoundingClientRect(),s=n.height-i.height,r=n.width-i.width,{width:l,height:a}=this.calcSize({width:t.width+r,height:t.height+s},o);return{width:l-r,height:a-s}}}function s(e){const t=e.getBoundingClientRect(),o=getComputedStyle(e,null),n=parseFloat(o.getPropertyValue("border-top-width")),i=parseFloat(o.getPropertyValue("border-right-width")),s=parseFloat(o.getPropertyValue("border-bottom-width")),r=parseFloat(o.getPropertyValue("border-left-width"));return{width:t.width-r-i,height:t.height-n-s,top:t.top+n,bottom:t.bottom-s,left:t.left+r,right:t.right-i}}},86448:(e,t,o)=>{"use strict";o.r(t),o.d(t,{FieldBuilder:()=>Wo,createAllFieldWidgets:()=>jo});var n=o(87056),i=o(24412),s=o(18099);const r=o(78870);class l extends s.Disposable{constructor(e,t){super(),this.gristDoc=e,this._fieldBuilder=t,this.editor=null,this.formulaUpToDate=s.Observable.create(this,!0),this._shouldExecute=!1,this._triggerFinalize=r,this._isFinalizing=!1,this.field=t.field,this.origColumn=this.field.column(),this.origDisplayCol=this.field.displayColModel(),this.origWidgetOptions=this.field.widgetOptionsJson(),this.isCallPending=t.isCallPending,this._tableData=e.docData.getTable(this.origColumn.table().tableId()),this.autoDispose(i.createGroup({undo:this.cancel,redo:r},this,!0)),this.onDispose((()=>{this._setTransforming(!1),this._fieldBuilder.columnTransform=null,this.isCallPending(!1)}))}buildDom(){throw new Error("Not Implemented")}async finalize(){return this._triggerFinalize()}buildEditorDom(e){return this.editor.buildDom((e=>{this.editor.adjustContentToWidth(),this.editor.attachSaveCommand(),e.on("change",(()=>{this.editor&&this.formulaUpToDate.set(this.editor.getValue()===this.transformColumn.formula())})),e.focus()}))}async prepare(e){const t=e||this.origColumn.type.peek(),o=this._tableData.docData.startBundlingActions({description:`Transformed column ${this.origColumn.colId()}.`,shouldIncludeInBundle:this._shouldIncludeInBundle.bind(this),prepare:this._doPrepare.bind(this,t),finalize:this._doFinalize.bind(this)});this._triggerFinalize=o.triggerFinalize,await o.preparePromise}async _doPrepare(e){if(!this.isDisposed()){this.isCallPending(!0);try{const t=await this.addTransformColumn(e);return this.field.colRef(t),this.transformColumn=this.field.column(),this.transformColumn.origColRef(this.origColumn.getRowId()),this._setTransforming(!0),this.postAddTransformColumn()}finally{this.isCallPending(!1)}}}_shouldIncludeInBundle(e){return e.every((e=>{var t,o,n;return(null==(t=e[2])?void 0:t.toString().startsWith("gristHelper_Transform"))||(null==(o=e[2])?void 0:o.toString().startsWith("gristHelper_Converted"))||(null==(n=e[3])?void 0:n.toString().startsWith("gristHelper_Converted"))||"SetDisplayFormula"===e[0]||"_grist_Tables_column"===e[1]||"_grist_Views_section_field"===e[1]}))}async addTransformColumn(e){return(await this._tableData.sendTableAction(["AddColumn","gristHelper_Transform",{type:e,isFormula:!0,formula:this.getIdentityFormula()}])).colRef}postAddTransformColumn(){}async cancel(){return this._shouldExecute=!1,this._triggerFinalize()}async execute(){return this._shouldExecute=!0,this._triggerFinalize()}async _doFinalize(){if(this.isDisposed()||this._isFinalizing)return;this._isFinalizing=!0;const e=this.transformColumn.colId(),t=this.field,o=this.origColumn.getRowId(),n=this._tableData;this.isCallPending(!0);try{this._shouldExecute&&await this.gristDoc.docData.sendActions(this.executeActions())}finally{t.colRef(o),n.sendTableAction(["RemoveColumn",e]),this.cleanup(),this.dispose()}}executeActions(){return[["CopyFromColumn",this._tableData.tableId,this.transformColumn.colId.peek(),this.origColumn.colId.peek(),JSON.stringify(this._fieldBuilder.options.peek())]]}cleanup(){}getIdentityFormula(){return"return $"+this.origColumn.colId()}_setTransforming(e){this.origColumn.isTransforming(e),this.transformColumn.isTransforming(e)}isFinalizing(){return this._isFinalizing}}var a=o(3411),c=o(11187),d=o(29922);class u extends l{constructor(e,t){super(e,t)}buildDom(){return this.editor=this.autoDispose(n.create({gristDoc:this.gristDoc,observable:this.transformColumn.formula})),[(0,s.dom)("div.transform_menu",(0,s.dom)("div.transform_editor",this.buildEditorDom(this.getIdentityFormula()),(0,d.testId)("formula-transform-top"))),(0,a.cssButtonRow)((0,c.basicButton)(s.dom.on("click",(()=>this.cancel())),"Cancel",(0,d.testId)("formula-transform-cancel")),(0,c.basicButton)(s.dom.on("click",(()=>this.editor.writeObservable())),"Preview",s.dom.cls("disabled",this.formulaUpToDate),{title:"Update formula (Shift+Enter)"},(0,d.testId)("formula-transform-update")),(0,c.primaryButton)(s.dom.on("click",(()=>this.execute())),"Apply",(0,d.testId)("formula-transform-apply")))]}}var p=o(56209),h=o(65552),m=o(631),f=o(83277),g=o(50590),b=o(62862),y=o(93965),v=Object.defineProperty,_=Object.defineProperties,w=Object.getOwnPropertyDescriptors,x=Object.getOwnPropertySymbols,C=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable,k=(e,t,o)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,S=(e,t)=>{for(var o in t||(t={}))C.call(t,o)&&k(e,o,t[o]);if(x)for(var o of x(t))D.call(t,o)&&k(e,o,t[o]);return e},I=(e,t)=>_(e,w(t));function T(e,t,o){switch(e){case"Ref":case"RefList":{const n=function(e,t){const o=e.docData.getTable(t.table().tableId()),n=o&&o.getColValues(t.colId());if(n)for(const t of n){if(m.isReferencing(t))return t[1];if(m.isList(t)){const e=t[1];if(m.isReference(e))return e[1]}else if("string"==typeof t){const o=t.match(/^\[?(\w+)\[/);if(o&&e.docData.getTable(o[1]))return o[1]}}return null}(o,t)||t.table().primaryTableId();return`${e}:${n}`}case"DateTime":return"DateTime:"+o.docInfoRow.timezone();default:return e}}async function R(e,t,o,n,i){const s=m.extractTypeFromColType(n),r=e.docData.getTable(t.table().tableId()),l=t.visibleColModel(),a=0!==l.getRowId()?l:t;let c=S({},a.widgetOptionsJson()||{});if(A(t)){delete c.rulesOptions;const{rulesOptions:e}=t.widgetOptionsJson()||{};e&&(c.rulesOptions=e)}const d={type:T(n,t,e),isFormula:!0,visibleCol:0,formula:`rec.${i}`,rules:t.rules()};switch(s){case"Bool":delete c.widget;break;case"Date":case"DateTime":{let{dateFormat:e}=c;if(!e){const t=r.getColValues(a.colId())||[];e=(0,b.guessDateFormat)(t.map(String)),c=S(S({},c),(0,b.dateTimeWidgetOptions)(e,!0))}"DateTime"!==s||c.timeFormat||(c.timeFormat=b.timeFormatOptions[0],c.isCustomTimeFormat=!1);break}case"Numeric":case"Int":if(!["Numeric","Int"].includes(a.type())){const t=g.Z.fromSettings(e.docData.docSettings()),o=r.getColValues(a.colId())||[];c=S(S({},c),t.guessOptions(o.filter(p.HD)))}break;case"Choice":if(!Array.isArray(c.choices)){const e=r.getDistinctValues(a.colId(),100);e&&(e.delete(""),e.delete(null),c=I(S({},c),{choices:Array.from(e,String)}))}break;case"ChoiceList":if(!Array.isArray(c.choices)){const e=new Set;for(let t of r.getColValues(a.colId())||[]){if(null===t)continue;t=String((0,y.xD)(t)).trim();const o=t.startsWith("[")&&f.safeJsonParse(t,null)||(0,h._0)(t);for(const t of o)if(e.add(String(t).trim()),e.size>100)break}e.delete(""),c=I(S({},c),{choices:Array.from(e)})}break;case"Ref":case"RefList":{const i=f.removePrefix(n,`${s}:`)||void 0;let l,a;const c=m.extractInfoFromColType(t.type.peek());if(i||"Ref"!==c.type&&"RefList"!==c.type){const n=r.getDistinctValues(o.colId(),100);if(!n)break;if(n.delete(m.getDefaultForType(t.type())),l=(await e.docData.findColFromValues(Array.from(n),2,i)).find((e=>e!==t.getRowId())),!l)break;if(a=e.columns.getRowModel(l).table().tableId(),i&&a!==i){console.warn("Inappropriate column received from findColFromValues");break}}else l=t.visibleCol.peek(),a=c.tableId;d.type=`${s}:${a}`,d.visibleCol=l;break}}return Object.keys(c).length&&(d.widgetOptions=JSON.stringify(c)),d}async function F(e,t,o){const n=null==o?t.visibleCol():o;if(A(t)){const o=function(e,t){return t?e.columns.getRowModel(t).colId():void 0}(e,n),i=t.colId(),s=0===n?"":`$${i}.${o}`;return t.saveDisplayFormula(s)}}function A(e){return(0,m.isFullReferencingType)(e.type())}var O=o(92769),E=o(70387),M=Object.defineProperty,P=Object.defineProperties,B=Object.getOwnPropertyDescriptors,$=Object.getOwnPropertySymbols,L=Object.prototype.hasOwnProperty,N=Object.prototype.propertyIsEnumerable,z=(e,t,o)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,V=(e,t)=>{for(var o in t||(t={}))L.call(t,o)&&z(e,o,t[o]);if($)for(var o of $(t))N.call(t,o)&&z(e,o,t[o]);return e};const U=(0,E.makeT)("TypeTransform");class j extends l{constructor(e,t){super(e,t),this._reviseTypeChange=s.Observable.create(this,!1),this._shouldExecute=!0,this._transformWidget=s.Computed.create(this,(0,s.fromKo)(t.widgetImpl),((e,t)=>e(this.origColumn.isTransforming)?t:null))}buildDom(){const e=s.Observable.create(null,!1);return this._reviseTypeChange.set(!1),this.editor=this.autoDispose(n.create({gristDoc:this.gristDoc,observable:this.transformColumn.formula})),(0,s.dom)("div",(0,d.testId)("type-transform-top"),s.dom.maybe(this._transformWidget,(e=>e.buildTransformConfigDom())),s.dom.maybe(this._reviseTypeChange,(()=>(0,s.dom)("div.transform_editor",this.buildEditorDom(),(0,d.testId)("type-transform-formula")))),(0,a.cssButtonRow)((0,c.basicButton)(s.dom.on("click",(()=>{this.cancel().catch(O.reportError),e.set(!0)})),U("Cancel"),(0,d.testId)("type-transform-cancel"),s.dom.cls("disabled",e)),s.dom.domComputed(this._reviseTypeChange,(t=>t?(0,c.basicButton)(s.dom.on("click",(()=>this.editor.writeObservable())),U("Preview"),(0,d.testId)("type-transform-update"),s.dom.cls("disabled",(t=>t(e)||t(this.formulaUpToDate))),{title:U("Update formula (Shift+Enter)")}):(0,c.basicButton)(s.dom.on("click",(()=>{this._reviseTypeChange.set(!0)})),U("Revise"),(0,d.testId)("type-transform-revise"),s.dom.cls("disabled",e)))),(0,c.primaryButton)(s.dom.on("click",(()=>{this.execute().catch(O.reportError),e.set(!0)})),U("Apply"),(0,d.testId)("type-transform-apply"),s.dom.cls("disabled",e))))}async addTransformColumn(e){const t=this.gristDoc.docModel,o=await this._tableData.sendTableActions([["AddColumn","gristHelper_Converted",{type:"Any"}],["AddColumn","gristHelper_Transform",{type:"Any"}]]),n=o[0].colRef,i=o[1].colRef;this.transformColumn=t.columns.getRowModel(i),this._convertColumn=t.columns.getRowModel(n);const s=await R(t,this.origColumn,this.origDisplayCol,e,this._convertColumn.colId.peek()),r=s.rules;var l,a;return delete s.rules,await this._tableData.sendTableActions([["ModifyColumn",this._convertColumn.colId.peek(),(l=V({},s),a={isFormula:!1,formula:""},P(l,B(a)))],["ModifyColumn",this.transformColumn.colId.peek(),s]]),r&&await this.gristDoc.docData.sendActions([["UpdateRecord","_grist_Tables_column",i,{rules:r}]]),await this.convertValues(),i}convertValuesActions(){return[["ConvertFromColumn",this._tableData.tableId,this.origColumn.colId.peek(),this._convertColumn.colId.peek(),this.transformColumn.type.peek(),this.transformColumn.widgetOptions.peek(),this.transformColumn.visibleCol.peek()]]}async convertValues(){await Promise.all([this.gristDoc.docData.sendActions(this.convertValuesActions()),F(this.gristDoc.docModel,this.transformColumn)])}executeActions(){return[...this.convertValuesActions(),...super.executeActions()]}postAddTransformColumn(){this.autoDispose(this.transformColumn.type.subscribe(this.convertValues,this,"change")),this.autoDispose(this.transformColumn.type.subscribe(this.convertValues,this,"save")),this.autoDispose(this.transformColumn.visibleCol.subscribe(this.convertValues,this,"save")),this.autoDispose(this.field.widgetOptionsJson.subscribe(this.convertValues,this,"save"))}cleanup(){this._tableData.sendTableAction(["RemoveColumn",this._convertColumn.colId.peek()])}async setType(e){const t=this.gristDoc.docModel,o=await R(t,this.origColumn,this.origDisplayCol,e,this._convertColumn.colId.peek()),n=this.transformColumn;await n.updateColValues(o)}}var H=o(81294),W=o.n(H),G=o(92979),Y=o(73783),K=o(33620),q=o(38109),J=o(32529),Z=o(53186),Q=o(36258),X=o(1370);const ee=(0,E.makeT)("FieldMenus");var te=o(88261),oe=o(64283),ne=o(64055);class ie extends oe.a{constructor(){super(...arguments),this._diffTool=new ne.diff_match_patch}buildConfigDom(){return(0,s.dom)("div")}buildDom(e){const t=s.Computed.create(null,(t=>{if(t(e._isAddRow)||this.isDisposed()||t(this.field.displayColModel).isDisposed())return[];const o=t(e.cells[t(t(this.field.displayColModel).colId)]),n=t(this.valueFormatter);return this._prepareCellDiff(o,n)}));return(0,s.dom)("div.field_clip",s.dom.autoDispose(t),s.dom.style("text-align",this.options.prop("alignment")),s.dom.cls("text_wrapping",(e=>Boolean(e(this.options.prop("wrap"))))),(0,f.inlineStyle)("--grist-diff-color","#000000"),(0,f.inlineStyle)("--grist-diff-background-color","#00000000"),s.dom.forEach(t,(([e,t])=>e===ne.DIFF_DELETE?(0,s.dom)("span.diff-parent",t):e===ne.DIFF_INSERT?(0,s.dom)("span.diff-remote",t):e===se?(0,s.dom)("span.diff-local",t):(0,s.dom)("span.diff-common",t))))}_prepareCellDiff(e,t){if(!(0,m.isVersions)(e))return[[ne.DIFF_EQUAL,t.formatAny(e)]];const o=e[1];return"local"in o?"remote"in o?[[ne.DIFF_DELETE,t.formatAny(o.parent)],[se,t.formatAny(o.local)],[ne.DIFF_INSERT,t.formatAny(o.remote)]]:this._prepareTextDiff(t.formatAny(o.parent),t.formatAny(o.local)).map((([e,t])=>[e===ne.DIFF_INSERT?se:e,t])):this._prepareTextDiff(t.formatAny(o.parent),t.formatAny(o.remote))}_prepareTextDiff(e,t){const o=this._diffTool.diff_main(e,t);return this._diffTool.diff_cleanupSemantic(o),o.length>2&&this._notDiffWorthy(e,o.length)&&this._notDiffWorthy(t,o.length)?[[ne.DIFF_DELETE,e],[ne.DIFF_INSERT,t]]:(1===o.length&&o[0][0]===ne.DIFF_DELETE&&o.push([1,"∅"]),o)}_notDiffWorthy(e,t){return e.length<5*t||this._isMostlyNumeric(e)}_isMostlyNumeric(e){return[...e].filter((e=>e>="0"&&e<="9")).length>e.length/2}}const se=2;var re=o(11486),le=o(49506),ae=o(85837),ce=o(20354),de=o(49142),ue=o(56634),pe=o(29002),he=o(7454),me=o(20742),fe=o(6015),ge=Object.defineProperty,be=Object.defineProperties,ye=Object.getOwnPropertyDescriptors,ve=Object.getOwnPropertySymbols,_e=Object.prototype.hasOwnProperty,we=Object.prototype.propertyIsEnumerable,xe=(e,t,o)=>t in e?ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Ce=(e,t)=>{for(var o in t||(t={}))_e.call(t,o)&&xe(e,o,t[o]);if(ve)for(var o of ve(t))we.call(t,o)&&xe(e,o,t[o]);return e};const De=(0,s.makeTestId)("test-pw-"),ke=(0,s.styled)("div.attachment_widget.field_clip","\n  display: flex;\n  flex-wrap: wrap;\n  white-space: pre-wrap;\n"),Se=(0,s.styled)("div.attachment_icon.glyphicon.glyphicon-paperclip","\n  position: absolute;\n  top: 2px;\n  left: 2px;\n  padding: 2px;\n  background-color: #D0D0D0;\n  color: white;\n  border-radius: 2px;\n  border: none;\n  cursor: pointer;\n  box-shadow: 0 0 0 1px white;\n  z-index: 1;\n\n  &:hover {\n    background-color: #3290BF;\n  }\n"),Ie=(0,s.styled)("div",`\n  color: black;\n  background-color: white;\n  border: 1px solid #bbb;\n  margin: 0 2px 2px 0;\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 0;\n  &:hover {\n    border-color: ${d.colors.lightGreen};\n  }\n`),Te=(0,s.styled)("div",`\n  color: ${d.colors.slate};\n  margin-right: 9px;\n`);class Re extends oe.a{constructor(e){super(e),this._attachmentsTable=this._getDocData().getMetaTable("_grist_Attachments"),this._height=this.options.prop("height"),this.autoDispose(this._height.subscribe((()=>{this.field.viewSection().events.trigger("rowHeightChange")})))}buildDom(e){const t=e[this.field.colId()],o=s.Computed.create(null,(0,s.fromKo)(t),((e,t)=>Array.isArray(t)?t.slice(1):[])),n=this.field.colId(),i=this.field.column().table().tableId();return ke(s.dom.autoDispose(o),(0,H.dragOverClass)("attachment_drag_over"),Se(s.dom.cls("attachment_hover_icon",(e=>e(o).length>0)),s.dom.on("click",(()=>this._selectAndSave(t)))),s.dom.maybe(e.id,(e=>s.dom.forEach(o,(t=>isNaN(t)?null:this._buildAttachment(t,o,{rowId:e,colId:n,tableId:i}))))),s.dom.on("drop",(e=>this._uploadAndSave(t,e.dataTransfer.files))))}buildConfigDom(){const e=this.field.config.options,t=e.prop("height"),o=(0,s.input)((0,s.fromKo)(t),{onInput:!0},{style:"margin: 0 5px;",type:"range",min:"16",max:"96",value:"36"},De("thumbnail-size"),s.dom.prop("disabled",(t=>t(e.disabled("height")))));return(0,s.onElem)(o,"change",(e=>{t.setAndSave(e.target.value).catch(reportError)})),(0,a.cssRow)(Te("Size"),o)}_buildAttachment(e,t,o){const n=this._attachmentsTable.getValue(e,"fileName"),r=this._attachmentsTable.getValue(e,"fileIdent"),l=this._attachmentsTable.getValue(e,"imageHeight"),a=this._attachmentsTable.getValue(e,"imageWidth"),c=Boolean(l),d=c?a/l:1;return Ie({title:n},s.dom.style("height",(e=>`${e(this._height)}px`)),s.dom.style("width",(e=>parseInt(e(this._height),10)*d+"px")),c?(0,s.dom)("img",{style:"height: 100%; min-width: 100%; vertical-align: top;"},s.dom.attr("src",this._getUrl(e,o))):Fe(n,r,this._height),s.dom.on("dblclick",(()=>i.allCommands.input.run(String(t.get().indexOf(e)+1)))),De("thumbnail"))}_getUrl(e,t){const o=this._getDocComm();return o.docUrl("attachment")+"?"+(0,f.encodeQueryParams)((n=Ce(Ce({},o.getUrlParams()),t),i={attId:e,name:this._attachmentsTable.getValue(e,"fileName")},be(n,ye(i))));var n,i}async _selectAndSave(e){const t=await(0,ue.lX)({docWorkerUrl:this._getDocComm().docWorkerUrl,multiple:!0,sizeLimit:"attachment"});return this._save(e,t)}async _uploadAndSave(e,t){const o=await(0,ue.IL)(Array.from(t),{docWorkerUrl:this._getDocComm().docWorkerUrl,sizeLimit:"attachment"});return this._save(e,o)}async _save(e,t){if(!t)return;const o=await this._getDocComm().addAttachments(t.uploadId),n=e()?e():["L"];e.setAndSave(n.concat(o)),this.field.viewSection().events.trigger("rowHeightChange")}}function Fe(e,t,o){const n=(0,fe.extname)("x"+e).slice(1)||(0,fe.extname)("x"+t).slice(1)||"?";return Ae(n.toUpperCase(),o&&Ae.cls((e=>{const t=parseFloat(e(o));return t<28?"-small":t<60?"-medium":"-large"})))}const Ae=(0,s.styled)("div",`\n  height: 100%;\n  width: 100%;\n  max-height: 80px;\n  max-width: 80px;\n  background-color: ${d.colors.slate};\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: ${d.vars.mediumFontSize};\n  font-weight: bold;\n  color: white;\n  overflow: hidden;\n\n  &-small { font-size: ${d.vars.xxsmallFontSize}; }\n  &-medium { font-size: ${d.vars.smallFontSize}; }\n  &-large { font-size: ${d.vars.mediumFontSize}; }\n`);var Oe=o(63074),Ee=o(65604),Me=Object.defineProperty,Pe=Object.defineProperties,Be=Object.getOwnPropertyDescriptors,$e=Object.getOwnPropertySymbols,Le=Object.prototype.hasOwnProperty,Ne=Object.prototype.propertyIsEnumerable,ze=(e,t,o)=>t in e?Me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Ve=(e,t)=>{for(var o in t||(t={}))Le.call(t,o)&&ze(e,o,t[o]);if($e)for(var o of $e(t))Ne.call(t,o)&&ze(e,o,t[o]);return e},Ue=(e,t)=>Pe(e,Be(t));class je extends Oe._{constructor(e){super(e);const t=e.gristDoc.docData,o=e.cellValue,n={rowId:e.rowId,colId:e.field.colId(),tableId:e.field.column().table().tableId()},i=e.editValue&&parseInt(e.editValue,0)-1||0;this._attachmentsTable=t.getMetaTable("_grist_Attachments"),this._docComm=t.docComm,this._rowIds=(0,s.obsArray)(Array.isArray(o)?o.slice(1):[]),this._attachments=(0,s.computedArray)(this._rowIds,(e=>{const t=this._attachmentsTable.getValue(e,"fileIdent"),o=Ee.lookup(t)||"application/octet-stream",i=(0,s.observable)(this._attachmentsTable.getValue(e,"fileName"));return{rowId:e,fileIdent:t,fileType:o,filename:i,hasPreview:Boolean(this._attachmentsTable.getValue(e,"imageHeight")),url:(0,s.computed)((t=>this._getUrl(n,e,t(i)))),inlineUrl:(0,s.computed)((t=>this._getUrl(n,e,t(i),!0)))}})),this._index=(0,s.makeLiveIndex)(this,this._attachments,i),this._selected=this.autoDispose((0,s.computed)((e=>{const t=e(this._index);return null===t?null:e(this._attachments)[t]})))}attach(e){(0,me.modal)(((e,t)=>(this.onDispose(e.close),[We.cls(""),s.dom.onKeyDown({Enter:t=>{e.close(),this.options.commands.fieldEditSaveHere()},Escape:t=>{e.close(),this.options.commands.fieldEditCancel()},ArrowLeft$:e=>!He(e)&&this._moveIndex(-1),ArrowRight$:e=>!He(e)&&this._moveIndex(1)}),s.dom.on("click",((t,o)=>{t.target===o&&e.close()})),...this._buildDom(e)])),{noEscapeKey:!0})}getCellValue(){return["L",...this._rowIds.get()]}getCursorPos(){return 0}getTextValue(){return""}_buildDom(e){return[Ge(Ze(s.dom.text((e=>{const t=e(this._attachments).length;return t?`${(e(this._index)||0)+1} of ${t}`:""})),(0,d.testId)("pw-counter")),s.dom.maybe(this._selected,(e=>qe(Je(e.filename,{save:t=>this._renameAttachment(e,t),inputArgs:[(0,d.testId)("pw-name")]})))),Ze(Qe(s.dom.maybe(this._selected,(e=>(0,c.basicButtonLink)(Xe.cls(""),et("Download"),"Download",s.dom.attr("href",e.url),s.dom.attr("target","_blank"),s.dom.attr("download",e.filename),(0,d.testId)("pw-download")))),this.options.readonly?null:[Xe(et("FieldAttachment"),"Add",s.dom.on("click",(()=>this._select())),(0,d.testId)("pw-add")),s.dom.maybe(this._selected,(()=>Xe(et("Remove"),"Delete",s.dom.on("click",(()=>this._remove())),(0,d.testId)("pw-remove"))))]),Ye(Ke("CrossBig"),s.dom.on("click",(()=>e.close())),(0,d.testId)("pw-close")))),tt(tt.cls("-left"),Ke("Expand"),(0,d.testId)("pw-left"),s.dom.hide((e=>!e(this._attachments).length||0===e(this._index))),s.dom.on("click",(()=>this._moveIndex(-1)))),tt(tt.cls("-right"),Ke("Expand"),(0,d.testId)("pw-right"),s.dom.hide((e=>!e(this._attachments).length||e(this._index)===e(this._attachments).length-1)),s.dom.on("click",(()=>this._moveIndex(1)))),s.dom.domComputed(this._selected,(e=>function(e,t){const o=[nt.cls(""),(0,d.testId)("pw-attachment-content")];return e?e.hasPreview?(0,s.dom)("img",s.dom.attr("src",e.url),...o):e.fileType.startsWith("video/")?(0,s.dom)("video",s.dom.attr("src",e.inlineUrl),{autoplay:!1,controls:!0},...o):e.fileType.startsWith("audio/")?(0,s.dom)("audio",s.dom.attr("src",e.inlineUrl),{autoplay:!1,controls:!0},...o):e.fileType.startsWith("text/")||"application/json"===e.fileType?(0,s.dom)("div",...o,it(nt.cls(""),Fe(e.filename.get(),e.fileIdent),st("Preview not available."))):(0,s.dom)("object",{type:e.fileType},s.dom.attr("data",e.inlineUrl),...o,it(nt.cls(""),Fe(e.filename.get(),e.fileIdent),st("Preview not available."))):it("No attachments",t?null:st("Drop files here to attach."),...o)}(e,this.options.readonly))),e=>function(e,t){let o=null;function n(n,i){o=i?n.target:null,n.stopPropagation(),n.preventDefault(),e.classList.toggle(t,i)}s.dom.onElem(e,"dragenter",(e=>n(e,!0))),s.dom.onElem(e,"dragleave",(e=>e.target===o&&n(e,!1))),s.dom.onElem(e,"drop",(e=>n(e,!1)))}(e,ot.className),rt(this.options.readonly?null:it("Drop files here to attach")),this.options.readonly?null:s.dom.on("drop",(e=>this._upload(e.dataTransfer.files))),(0,d.testId)("pw-modal")]}async _renameAttachment(e,t){await this._attachmentsTable.sendTableAction(["UpdateRecord",e.rowId,{fileName:t}]),e.filename.set(this._attachmentsTable.getValue(e.rowId,"fileName"))}_getUrl(e,t,o,n){return this._docComm.docUrl("attachment")+"?"+(0,f.encodeQueryParams)(Ve(Ue(Ve(Ue(Ve({},this._docComm.getUrlParams()),{name:o}),e),{maybeNew:1,attId:t}),n?{inline:1}:{}))}_moveIndex(e){const t=this._index.get()+e;this._index.set((0,f.clamp)(t,0,this._attachments.get().length))}_remove(){this._rowIds.splice(this._index.get(),1)}async _select(){const e=await(0,ue.lX)({docWorkerUrl:this._docComm.docWorkerUrl,multiple:!0,sizeLimit:"attachment"});return this._add(e)}async _upload(e){const t=await(0,ue.IL)(Array.from(e),{docWorkerUrl:this._docComm.docWorkerUrl,sizeLimit:"attachment"});return this._add(t)}async _add(e){if(!e)return;const t=await this._docComm.addAttachments(e.uploadId),o=this._rowIds.get().length;t.length>0&&(this._rowIds.push(...t),this._index.set(o))}}function He(e){return"INPUT"===e.target.tagName}const We=(0,s.styled)("div","\n  background-color: initial;\n  width: 100%;\n  height: 100%;\n  border: none;\n  border-radius: 0px;\n  box-shadow: none;\n  padding: 0px;\n"),Ge=(0,s.styled)("div","\n  padding: 16px 24px;\n  position: fixed;\n  width: 100%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  color: white;\n"),Ye=(0,s.styled)("div",`\n  padding: 6px;\n  border-radius: 32px;\n  cursor: pointer;\n  background-color: ${d.colors.light};\n  --icon-color: ${d.colors.lightGreen};\n\n  &:hover {\n    background-color: ${d.colors.mediumGreyOpaque};\n    --icon-color: ${d.colors.darkGreen};\n  }\n`),Ke=(0,s.styled)(he.icon,"\n  padding: 10px;\n"),qe=(0,s.styled)("div",`\n  display: inline-block;\n  padding: 8px 16px;\n  margin-right: 8px;\n  min-width: 0px;\n  overflow: hidden;\n\n  &:hover {\n    outline: 1px solid ${d.colors.slate};\n  }\n  &:focus-within {\n    outline: 1px solid ${d.colors.darkGreen};\n  }\n`),Je=(0,s.styled)(pe.editableLabel,`\n  font-size: ${d.vars.mediumFontSize};\n  font-weight: bold;\n  color: white;\n`),Ze=(0,s.styled)("div","\n  flex: 1;\n  display: flex;\n"),Qe=(0,s.styled)(c.cssButtonGroup,"\n  margin-left: auto;\n  margin-right: 16px;\n  height: 32px;\n  flex: none;\n"),Xe=(0,s.styled)(c.basicButton,`\n  background-color: ${d.colors.light};\n  font-weight: normal;\n  padding: 0 16px;\n  border-top: none;\n  border-right: none;\n  border-bottom: none;\n  border-left: 1px solid ${d.colors.darkGrey};\n  display: flex;\n  align-items: center;\n\n  &:first-child {\n    border: none;\n  }\n  &:hover {\n    background-color: ${d.colors.mediumGreyOpaque};\n    border-color: ${d.colors.darkGrey};\n  }\n`),et=(0,s.styled)(he.icon,`\n  --icon-color: ${d.colors.slate};\n  margin-right: 4px;\n`),tt=(0,s.styled)("div",`\n  position: fixed;\n  height: 32px;\n  margin: auto 24px;\n  top: 0px;\n  bottom: 0px;\n  z-index: 1;\n\n  padding: 6px;\n  border-radius: 32px;\n  cursor: pointer;\n  background-color: ${d.colors.lightGreen};\n  --icon-color: ${d.colors.light};\n\n  &:hover {\n    background-color: ${d.colors.darkGreen};\n  }\n  &-left {\n    transform: rotateY(180deg);\n    left: 0px;\n  }\n  &-right {\n    right: 0px;\n  }\n`),ot=(0,s.styled)("div",""),nt=(0,s.styled)("div",`\n  display: block;\n  height: calc(100% - 72px);\n  width: calc(100% - 64px);\n  max-width: 800px;\n  margin-left: auto;\n  margin-right: auto;\n  margin-top: 64px;\n  margin-bottom: 8px;\n  outline: none;\n  img& {\n    width: max-content;\n    height: unset;\n  }\n  audio& {\n    padding-bottom: 64px;\n  }\n  .${ot.className} > & {\n    display: none;\n  }\n`),it=(0,s.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  align-items: center;\n  font-size: ${d.vars.mediumFontSize};\n  font-weight: bold;\n  color: white;\n  padding: 0px;\n`),st=(0,s.styled)("div","\n  font-weight: normal;\n  margin-top: 24px;\n"),rt=(0,s.styled)(nt,`\n  border: 2px dashed ${d.colors.mediumGreyOpaque};\n  height: calc(100% - 96px);\n  margin-top: 64px;\n  padding: 0px;\n  justify-content: center;\n  display: none;\n  .${ot.className} > & {\n    display: flex;\n  }\n`);var lt=o(9443),at=o.n(lt),ct=o(91938),dt=o.n(ct),ut=o(74987),pt=o(55330),ht=Object.defineProperty,mt=Object.defineProperties,ft=Object.getOwnPropertyDescriptors,gt=Object.getOwnPropertySymbols,bt=Object.prototype.hasOwnProperty,yt=Object.prototype.propertyIsEnumerable,vt=(e,t,o)=>t in e?ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;class _t extends ut.Rf{buildDom(e){const t=e.cells[this.field.colId.peek()];return wt(s.dom.cls("field_clip"),wt.cls("-wrap",this.wrapping),s.dom.style("justify-content",(e=>"right"===e(this.alignment)?"flex-end":e(this.alignment))),s.dom.domComputed((o=>o(e._isAddRow)?null:[o(t),o(this.getChoiceValuesSet()),o(this.getChoiceOptions())]),(e=>{if(!e)return null;const[t,o,n]=e,i=(0,y.xD)(t);return i?(Array.isArray(i)?i:[i]).map((e=>{return(0,pt.choiceToken)(String(e),(t=((e,t)=>{for(var o in t||(t={}))bt.call(t,o)&&vt(e,o,t[o]);if(gt)for(var o of gt(t))yt.call(t,o)&&vt(e,o,t[o]);return e})({},n.get(String(e))||{}),i={invalid:!o.has(String(e))},mt(t,ft(i))),s.dom.cls(xt.className),(0,d.testId)("choice-list-cell-token"));var t,i})):null})))}}const wt=(0,s.styled)("div","\n  display: flex;\n  align-content: start;\n  align-items: start;\n  padding: 0 3px;\n\n  position: relative;\n  min-height: 22px;\n\n  &-wrap {\n    flex-wrap: wrap;\n  }\n"),xt=(0,s.styled)("div","\n  flex: 0 1 auto;\n  min-width: 0px;\n  margin: 2px;\n  line-height: 16px;\n");var Ct=o(31490),Dt=o(40293),kt=o.n(Dt),St=o(38062),It=o.n(St),Tt=o(52445),Rt=o.n(Tt),Ft=o(38149),At=o.n(Ft),Ot=o(16151),Et=o(41880);class Mt extends Oe._{constructor(e){var t;super(e),this.options=e;const o=(0,f.undef)(e.state,e.editValue,String(null!=(t=e.cellValue)?t:""));this.editorState=s.Observable.create(this,o),this.commandGroup=this.autoDispose((0,i.createGroup)(e.commands,null,!0)),this._alignment=e.field.widgetOptionsJson.peek().alignment||"left",this._dom=(0,s.dom)("div.default_editor",s.dom.cls("readonly_editor",e.readonly),this.cellEditorDiv=(0,s.dom)("div.celleditor_cursor_editor",(0,d.testId)("widget-text-editor"),this._contentSizer=(0,s.dom)("div.celleditor_content_measure"),this.textInput=(0,s.dom)("textarea",s.dom.cls("celleditor_text_editor"),s.dom.style("text-align",this._alignment),s.dom.prop("value",o),s.dom.boolAttr("readonly",e.readonly),this.commandGroup.attach(),s.dom.on("input",(()=>this.onInput())))),(0,Ot.createMobileButtons)(e.commands))}attach(e){this._editorPlacement=Et.EditorPlacement.create(this,this._dom,e,{margins:(0,Ot.getButtonMargins)()}),this.autoDispose(this._editorPlacement.onReposition.addListener(this.resizeInput,this)),this.setSizerLimits(),this.resizeInput(),this.textInput.focus();const t=Math.min(this.options.cursorPos,this.textInput.value.length);this.textInput.setSelectionRange(t,t)}getDom(){return this._dom}getCellValue(){return this.options.field.createValueParser()(this.getTextValue())}getTextValue(){return this.textInput.value}getCursorPos(){return this.textInput.selectionStart}setSizerLimits(){const e=this._editorPlacement.calcSizeWithPadding(this.textInput,{width:1/0,height:1/0},{calcOnly:!0});this._contentSizer.style.maxWidth=Math.ceil(e.width)+"px"}onInput(){this.resizeInput(),this.editorState.set(String(this.getTextValue()))}resizeInput(){const e=this.textInput;this._contentSizer.textContent=e.value+"​";const t=this._contentSizer.getBoundingClientRect();"left"===this._alignment&&(t.width+=16);const o=this._editorPlacement.calcSizeWithPadding(e,t);var n,i,s;e.style.width=o.width+"px",e.style.height=o.height+"px",s=o,(i=t).width<=s.width&&i.height<=s.height&&((n=e).scrollHeight>n.clientHeight||n.scrollWidth>n.clientWidth)&&(e.style.overflow="hidden",e.clientHeight,e.style.overflow="auto")}}var Pt=o(3988),Bt=o(4425),$t=o(61957);class Lt extends $t.D{constructor(e){super(e,{defaultTextColor:d.colors.lightGreen.value})}buildDom(e){const t=e.cells[this.field.colId()],o=s.Computed.create(null,(e=>(0,Pt.constructUrl)(e(t))));return Nt(s.dom.autoDispose(o),s.dom.style("text-align",this.alignment),s.dom.cls("text_wrapping",this.wrapping),s.dom.maybe((e=>Boolean(e(t))),(()=>(0,Bt.rg)(o,(0,he.cssIconBackground)((0,he.icon)("FieldLink",(0,d.testId)("tb-link-icon")),s.dom.cls(zt.className)),(0,d.testId)("tb-link")))),s.dom.text((e=>function(e){if("string"!=typeof e)return"";const t=e.lastIndexOf(" ");return t>=0?e.slice(0,t):e}(e(t)))))}}const Nt=(0,s.styled)("div.field_clip",`\n  color: var(--grist-actual-cell-color, ${d.colors.lightGreen});\n`),zt=(0,$t.T)(Nt.className);var Vt=o(66632),Ut=o(99597),jt=o(17933),Ht=Object.defineProperty,Wt=Object.defineProperties,Gt=Object.getOwnPropertyDescriptors,Yt=Object.getOwnPropertySymbols,Kt=Object.prototype.hasOwnProperty,qt=Object.prototype.propertyIsEnumerable,Jt=(e,t,o)=>t in e?Ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Zt=(e,t)=>{for(var o in t||(t={}))Kt.call(t,o)&&Jt(e,o,t[o]);if(Yt)for(var o of Yt(t))qt.call(t,o)&&Jt(e,o,t[o]);return e};const Qt=[{value:"currency",label:"$"},{value:"decimal",label:","},{value:"percent",label:"%"},{value:"scientific",label:"Exp"}],Xt=[{value:"parens",label:"(-)"}];class eo extends $t.D{constructor(e){super(e)}buildConfigDom(){const e=new s.MultiHolder,t=s.Computed.create(e,(e=>{const{numMode:t}=e(this.field.config.options),o=e(this.field.documentSettings);return(0,Ut.y6)({numMode:t},o).resolvedOptions()})),o=this.field.config.options,n=(0,s.fromKo)(o),i=(0,s.fromKo)(this.field.documentSettings),r=s.Computed.create(e,n,((e,t)=>t.numMode||null)),l=s.Computed.create(e,n,((e,t)=>t.numSign||null)),c=s.Computed.create(e,n,((e,t)=>t.currency)),u=s.Computed.create(e,(e=>e(this.field.config.options.disabled("currency")))),p=s.Computed.create(e,n,((e,t)=>to(t.decimals,""))),h=s.Computed.create(e,n,((e,t)=>to(t.maxDecimals,""))),m=s.Computed.create(e,t,((e,t)=>t.minimumFractionDigits)),g=s.Computed.create(e,t,((e,t)=>t.maximumFractionDigits)),b=s.Computed.create(e,i,((e,t)=>{var o,n;return null!=(n=t.currency)?n:jt.z(null!=(o=t.locale)?o:"en-US")})),y=(e,t)=>{const n=Zt({},o.peek());var i;t!==n[e]&&(o(Zt((i=Zt({},n),Wt(i,Gt({[e]:t}))),function(e,t){return"numMode"!==e||t&&"scientific"!==t&&"percent"!==t?{}:{numSign:void 0}}(e,t))),o.save().catch((e=>{(0,O.reportError)(e),o(n)})))},v=e=>y("currency",e),_=te.cssButtonSelect.cls("-disabled",u);return[super.buildConfigDom(),(0,a.cssLabel)("Number Format"),(0,a.cssRow)(s.dom.autoDispose(e),(0,te.makeButtonSelect)(r,Qt,(e=>y("numMode",e!==r.get()?e:void 0)),_,uo.cls(""),(0,d.testId)("numeric-mode")),(0,te.makeButtonSelect)(l,Xt,(e=>y("numSign",e!==l.get()?e:void 0)),_,po.cls(""),(0,d.testId)("numeric-sign"))),s.dom.maybe((e=>"currency"===e(r)),(()=>[(0,a.cssLabel)("Currency"),(0,a.cssRow)(s.dom.domComputed(b,(t=>(0,Vt.g)(e,c,v,{defaultCurrencyLabel:`Default currency (${t})`,disabled:u}))),(0,d.testId)("numeric-currency"))])),(0,a.cssLabel)("Decimals"),(0,a.cssRow)(oo("min",p,m,(e=>y("decimals",e&&(0,f.clamp)(e,0,20))),u,(0,d.testId)("numeric-min-decimals")),oo("max",h,g,(e=>y("maxDecimals",e&&(0,f.clamp)(e,0,20))),u,(0,d.testId)("numeric-max-decimals")))]}}function to(e,t){return null!=e?Number(e):t}function oo(e,t,o,n,i,...r){return no(no.cls("-disabled",i),io(e),so({type:"text",size:"2",min:"0"},s.dom.prop("value",t),s.dom.prop("placeholder",o),s.dom.on("change",((e,o)=>{const i=parseInt(o.value,10);o.value=String(t.get()),n(Number.isNaN(i)?void 0:i),o.blur()})),s.dom.on("focus",((e,t)=>t.select()))),ro(lo(ao("DropdownUp"),s.dom.on("click",(()=>n(to(t.get(),o.get())+1)))),lo(co("Dropdown"),s.dom.on("click",(()=>n(to(t.get(),o.get())-1))))),...r)}const no=(0,s.styled)("div",`\n  position: relative;\n  flex: auto;\n  --icon-color: ${d.theme.lightText};\n  color: ${d.theme.lightText};\n  font-weight: normal;\n  display: flex;\n  align-items: center;\n  &:first-child {\n    margin-right: 16px;\n  }\n  &-disabled {\n    background-color: ${d.theme.rightPanelToggleButtonDisabledBg};\n    pointer-events: none;\n  }\n`),io=(0,s.styled)("div","\n  position: absolute;\n  padding-left: 8px;\n  pointer-events: none;\n"),so=(0,s.styled)("input",`\n  padding: 4px 32px 4px 40px;\n  border: 1px solid ${d.theme.inputBorder};\n  border-radius: 3px;\n  background-color: ${d.theme.inputBg};\n  color: ${d.theme.inputFg};\n  width: 100%;\n  text-align: right;\n  appearance: none;\n  -moz-appearance: none;\n  -webkit-appearance: none;\n`),ro=(0,s.styled)("div","\n  position: absolute;\n  right: 8px;\n  width: 16px;\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n"),lo=(0,s.styled)("div",`\n  --icon-color: ${d.theme.controlSecondaryFg};\n  flex: 1 1 0px;\n  min-height: 0px;\n  position: relative;\n  cursor: pointer;\n  overflow: hidden;\n  &:hover {\n    --icon-color: ${d.theme.controlSecondaryHoverFg};\n  }\n`),ao=(0,s.styled)(he.icon,"\n  position: absolute;\n  top: 0px;\n"),co=(0,s.styled)(he.icon,"\n  position: absolute;\n  bottom: 0px;\n"),uo=(0,s.styled)(te.makeButtonSelect,`\n  flex: 4 4 0px;\n  background-color: ${d.theme.inputBg};\n`),po=(0,s.styled)(te.makeButtonSelect,`\n  flex: 1 1 0px;\n  background-color: ${d.theme.inputBg};\n  margin-left: 16px;\n`);class ho extends $t.D{constructor(e){super(e),this._visibleColRef=s.Computed.create(this,(e=>e(this.field.visibleColRef))),this._visibleColRef.onWrite((e=>this.field.visibleColRef.saveOnly(e))),this._validCols=s.Computed.create(this,(e=>{const t=e(e(this.field.column).refTable);return t?e(e(t.columns).getObservable()).filter((t=>!e(t.isHiddenCol))).map((t=>({label:e(t.label),value:t.getRowId(),icon:"FieldColumn",disabled:(0,m.isFullReferencingType)(e(t.type))||e(t.isTransforming)}))).concat([{label:"Row ID",value:0,icon:"FieldColumn"}]):[]}))}buildConfigDom(){return[this.buildTransformConfigDom(),(0,a.cssLabel)("CELL FORMAT"),super.buildConfigDom()]}buildTransformConfigDom(){const e=s.Computed.create(null,(e=>e(this.field.config.multiselect)));return[(0,a.cssLabel)("SHOW COLUMN"),(0,a.cssRow)(s.dom.autoDispose(e),(0,X.select)(this._visibleColRef,this._validCols,{disabled:e}),(0,d.testId)("fbuilder-ref-col-select"))]}buildDom(e){const t=s.Computed.create(null,(t=>{const o=e.cells[t(this.field.colId)];return o&&t(o)})),o=s.Computed.create(null,(o=>{let[n,i]=["",!1];if(o(e._isAddRow)||this.isDisposed()||o(this.field.displayColModel).isDisposed())return{value:n,hasBlankReference:i};const s=e.cells[o(o(this.field.displayColModel).colId)];if(!s)return{value:n,hasBlankReference:i};const r=o(s);return n=(0,m.isVersions)(r)?o(this.field.formatter).formatAny(r[1].local||r[1].parent):o(this.field.formatter).formatAny(r),i=0!==t.get()&&""===n.trim(),{value:n,hasBlankReference:i}}));return fo(s.dom.autoDispose(o),s.dom.autoDispose(t),fo.cls("-blank",(e=>e(o).hasBlankReference)),s.dom.style("text-align",this.alignment),s.dom.cls("text_wrapping",this.wrapping),mo("FieldReference",(0,d.testId)("ref-link-icon"),(0,d.hideInPrintView)()),s.dom.text((e=>0===e(t)?"":e(o).hasBlankReference?"[Blank]":e(o).value)))}}const mo=(0,s.styled)(he.icon,`\n  float: left;\n  background-color: ${d.colors.slate};\n  margin: -1px 2px 2px 0;\n`),fo=(0,s.styled)("div.field_clip",`\n  &-blank {\n    color: ${d.colors.slate}\n  }\n`);var go=o(11104),bo=o(6632);class yo{constructor(e,t){this.field=e;const o=e.column().type(),n=(0,m.getReferencedTableId)(o);if(!n)throw new Error("Non-Reference column of type "+o);this.refTableId=n;const i=t.getTable(n);if(!i)throw new Error("Invalid referenced table "+n);this.tableData=i,this.visibleColFormatter=e.visibleColFormatter(),this.visibleColModel=e.visibleColModel(),this.visibleColId=this.visibleColModel.colId()||"id",this.isRefList=(0,m.isRefListType)(o)}idToText(e){return"number"==typeof e?this.visibleColFormatter.formatAny(this.tableData.getValue(e,this.visibleColId)):String(e||"")}autocompleteSearch(e){return this.tableData.columnACIndexes.getColACIndex(this.visibleColId,this.visibleColFormatter).search(e)}}function vo(e,t,o,n){return o?xo(xo.cls("-new"),Co(Do("Plus")),e,(0,d.testId)("ref-editor-item"),(0,d.testId)("ref-editor-new-item")):xo(xo.cls("-with-new",n),(0,go.buildHighlightedDom)(e,t,So),(0,d.testId)("ref-editor-item"))}const _o=(0,s.styled)("div","\n  & > .celleditor_text_editor, & > .celleditor_content_measure {\n    padding-left: 18px;\n  }\n"),wo=(0,s.styled)("div","\n  z-index: 1001;\n  overflow-y: auto;\n  padding: 8px 0 0 0;\n  --weaseljs-menu-item-padding: 8px 16px;\n"),xo=(0,s.styled)("li",`\n  display: block;\n  font-family: ${d.vars.fontFamily};\n  white-space: pre;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  outline: none;\n  padding: var(--weaseljs-menu-item-padding, 8px 24px);\n  cursor: pointer;\n  color: ${d.theme.menuItemFg};\n\n  &.selected {\n    background-color: ${d.theme.menuItemSelectedBg};\n    color:            ${d.theme.menuItemSelectedFg};\n  }\n  &-with-new {\n    scroll-margin-bottom: 37px;\n  }\n  &-new {\n    color: ${d.theme.lightText};\n    position: sticky;\n    bottom: 0px;\n    height: 37px;\n    background-color: ${d.theme.menuBg};\n    border-top: 1px solid ${d.theme.menuBorder};\n    scroll-margin-bottom: initial;\n  }\n  &-new.selected {\n    color: ${d.theme.menuItemSelectedFg};\n  }\n`),Co=(0,s.styled)("div",`\n  display: inline-block;\n  width: 20px;\n  height: 20px;\n  border-radius: 20px;\n  margin-right: 8px;\n  text-align: center;\n  background-color: ${d.colors.lightGreen};\n  color: ${d.colors.light};\n\n  .selected > & {\n    background-color: ${d.colors.darkGreen};\n  }\n`),Do=(0,s.styled)(he.icon,`\n  background-color: ${d.colors.light};\n`),ko=(0,s.styled)(he.icon,`\n  background-color: ${d.colors.slate};\n  position: absolute;\n  top: 0;\n  left: 0;\n  margin: 3px 3px 0 3px;\n`),So=(0,s.styled)("span",`\n  color: ${d.theme.autocompleteMatchText};\n  .selected > & {\n    color: ${d.theme.autocompleteSelectedMatchText};\n  }\n`);var Io=o(64982);class To{constructor(e,t){this.text=e,this.rowId=t,this.label="number"==typeof this.rowId?String(this.rowId):this.text,this.cleanText=(0,go.normalizeText)(this.text)}}class Ro extends Oe._{constructor(e){super(e),this.options=e,this._showAddNew=!1;const t=e.gristDoc.docData;this._utils=new yo(e.field,t);const o=this._utils.visibleColModel;this._enableAddNew=o&&!o.isRealFormula()&&!!o.colId();const n={menuCssClass:`${X.menuCssClass} ${wo.className}`,search:this._doSearch.bind(this),renderItem:this._renderItem.bind(this),getItemText:e=>e.text};this.commandGroup=this.autoDispose((0,i.createGroup)(e.commands,null,!0)),this._alignment=e.field.widgetOptionsJson.peek().alignment||"left";const r=(0,y.xD)(e.cellValue),l=e.editValue||!Array.isArray(r)?[]:r,a=void 0===e.editValue&&!this._utils.tableData.isLoaded,c=a?[]:l.map((e=>new To(this._utils.idToText(e),"number"==typeof e?e:"invalid")));this._tokenField=Io.T.ctor().create(this,{initialValue:c,renderToken:e=>{const t=""===e.cleanText;return[t?"[Blank]":e.text,Oo.cls("-blank",t),pt.cssChoiceToken.cls("-invalid","invalid"===e.rowId)]},createToken:e=>new To(e,"invalid"),acOptions:n,openAutocompleteOnFocus:!0,readonly:e.readonly,trimLabels:!0,styles:{cssTokenField:Ao,cssToken:Oo,cssDeleteButton:Eo,cssDeleteIcon:Mo}}),this._dom=(0,s.dom)("div.default_editor",s.dom.cls("readonly_editor",e.readonly),s.dom.cls($o.className,e.readonly),this.cellEditorDiv=Fo((0,d.testId)("widget-text-editor"),this._contentSizer=Po(),(e=>this._tokenField.attach(e))),(0,Ot.createMobileButtons)(e.commands)),this._textInput=this._tokenField.getTextInput(),s.dom.update(this._tokenField.getRootElem(),s.dom.style("justify-content",this._alignment)),s.dom.update(this._tokenField.getHiddenInput(),this.commandGroup.attach()),s.dom.update(this._textInput,s.dom.on("input",(()=>this.resizeInput(!0))),s.dom.prop("value",e.editValue||""),this.commandGroup.attach()),t.fetchTable(this._utils.refTableId).then((()=>{if(this.isDisposed())return;a&&(this._tokenField.setTokens(l.map((e=>new To(this._utils.idToText(e),"number"==typeof e?e:"invalid")))),this.resizeInput());const e=this._tokenField.getAutocomplete();e&&e.search()})).catch(O.reportError)}attach(e){this._editorPlacement=Et.EditorPlacement.create(this,this._dom,e,{margins:(0,Ot.getButtonMargins)()}),this.autoDispose(this._editorPlacement.onReposition.addListener((()=>this.resizeInput()))),this.autoDispose(this._tokenField.tokensObs.addListener((()=>Promise.resolve().then((()=>this.resizeInput()))))),this.setSizerLimits(),this.resizeInput(),this._textInput.focus();const t=Math.min(this.options.cursorPos,this._textInput.value.length);this._textInput.setSelectionRange(t,t)}getDom(){return this._dom}getCellValue(){const e=this._tokenField.tokensObs.get().map((e=>"number"==typeof e.rowId?e.rowId:e.text));return(0,y.Cx)(e)}getTextValue(){const e=this._tokenField.tokensObs.get().map((e=>"number"==typeof e.rowId?String(e.rowId):e.text));return(0,h.cw)(e,{prettier:!0})}getCursorPos(){return this._textInput.selectionStart||0}async prepForSave(){const e=this._tokenField.tokensObs.get(),t=e.filter((e=>"new"===e.rowId));if(0===t.length)return;const o={[this._utils.visibleColId]:t.map((e=>e.text))},n=await this._utils.tableData.sendTableAction(["BulkAddRecord",new Array(t.length).fill(null),o]);let i=0;const s=e.map((e=>"new"===e.rowId?new To(e.text,n[i++]):e));this._tokenField.setTokens(s)}setSizerLimits(){const e=this._tokenField.getRootElem(),t=this._editorPlacement.calcSizeWithPadding(e,{width:1/0,height:1/0},{calcOnly:!0});this._contentSizer.style.maxWidth=Math.ceil(t.width)+"px"}resizeInput(e=!1){if(this.isDisposed())return;const t=this._tokenField.getRootElem();e&&this._inputSizer||(this._contentSizer.innerHTML="",s.dom.update(this._contentSizer,s.dom.update(t.cloneNode(!0),s.dom.style("width",""),s.dom.style("height",""),this._inputSizer=Bo(),s.dom.cls("test-tokenfield",!1)))),this._inputSizer.textContent=this._textInput.value+"​";const o=this._contentSizer.getBoundingClientRect(),n=this._editorPlacement.calcSizeWithPadding(t,o);t.style.width=n.width+"px",t.style.height=n.height+"px",this._textInput.style.width=this._inputSizer.getBoundingClientRect().width+"px"}async _doSearch(e){const{items:t,selectIndex:o,highlightFunc:n}=this._utils.autocompleteSearch(e),i={selectIndex:o,highlightFunc:n,items:t.map((e=>new To(e.text,e.rowId)))};if(this._showAddNew=!1,!this._enableAddNew||!e)return i;const s=(0,go.normalizeText)(e);return i.items.find((e=>e.cleanText===s))||(i.items.push(new To(e,"new")),this._showAddNew=!0),i}_renderItem(e,t){return vo(e.text,t,"new"===e.rowId,this._showAddNew)}}const Fo=(0,s.styled)("div",`\n  background-color: ${d.theme.cellEditorBg};\n  font-family: var(--grist-font-family-data);\n  font-size: var(--grist-medium-font-size);\n`),Ao=(0,s.styled)(Io.c.cssTokenField,"\n  border: none;\n  align-items: start;\n  align-content: start;\n  padding: 0 3px;\n  height: min-content;\n  min-height: 22px;\n  color: black;\n  flex-wrap: wrap;\n"),Oo=(0,s.styled)(Io.c.cssToken,`\n  padding: 1px 4px;\n  margin: 2px;\n  line-height: 16px;\n  white-space: pre;\n\n  &.selected {\n    box-shadow: inset 0 0 0 1px ${d.colors.lightGreen};\n  }\n\n  &-blank {\n    color: ${d.colors.slate};\n  }\n`),Eo=(0,s.styled)(Io.c.cssDeleteButton,`\n  position: absolute;\n  top: -8px;\n  right: -6px;\n  border-radius: 16px;\n  background-color: ${d.colors.dark};\n  width: 14px;\n  height: 14px;\n  cursor: pointer;\n  z-index: 1;\n  display: none;\n  align-items: center;\n  justify-content: center;\n\n  .${Oo.className}:hover & {\n    display: flex;\n  }\n  .${Ao.className}.token-dragactive & {\n    cursor: unset;\n  }\n`),Mo=(0,s.styled)(Io.c.cssDeleteIcon,`\n  --icon-color: ${d.colors.light};\n  &:hover {\n    --icon-color: ${d.colors.darkGrey};\n  }\n`),Po=(0,s.styled)("div",`\n  position: absolute;\n  left: 0;\n  top: -100px;\n  border: none;\n  visibility: hidden;\n  overflow: visible;\n  width: max-content;\n\n  & .${Io.c.cssInputWrapper.className} {\n    display: none;\n  }\n`),Bo=(0,s.styled)("div","\n  flex: auto;\n  min-width: 24px;\n  margin: 3px 2px;\n"),$o=(0,s.styled)("div","\n  padding-left: 16px;\n  background: white;\n");var Lo=o(29301);class No extends oe.a{_addClickEventHandler(e){return s.dom.on("click",(t=>{t.shiftKey||this.field.column().isRealFormula()||(i.allCommands.setCursor.run(e,this.field),i.allCommands.input.run(" "))}))}}const zo={TextBox:$t.D,TextEditor:Mt,NumericTextBox:eo,HyperLinkTextBox:Lt,HyperLinkEditor:class extends Mt{constructor(e){super(e),this.textInput.setAttribute("placeholder","[link label] url")}},Spinner:class extends eo{constructor(e){super(e);const t=this.autoDispose(Lo.computed((()=>{const{numMode:e}=this.options(),t=this.field.documentSettings();return(0,Ut.y6)({numMode:e},t).resolvedOptions()})));this._stepSize=this.autoDispose(Lo.computed((()=>{const e="percent"===this.options().numMode?2:0;return Math.pow(10,-(this.options().decimals||t().minimumFractionDigits)-e)})))}buildDom(e){const t=e.cells[this.field.colId.peek()];return s.dom.update(super.buildDom(e),s.dom.cls("widget_spinner"),Y.spinner(t,this._stepSize))}},CheckBox:class extends No{constructor(e,t={}){super(e,{defaultTextColor:"#606060"})}buildDom(e){const t=e.cells[this.field.colId.peek()];return(0,s.dom)("div.field_clip",(0,s.dom)("div.widget_checkbox",(0,s.dom)("div.widget_checkmark",s.dom.show(t),(0,s.dom)("div.checkmark_kick"),(0,s.dom)("div.checkmark_stem")),this._addClickEventHandler(e)))}},CheckBoxEditor:at(),Reference:ho,Switch:class extends No{constructor(e,t={}){super(e,{defaultTextColor:"#2CB0AF"})}buildDom(e){const t=e.cells[this.field.colId.peek()];return(0,s.dom)("div.field_clip",(0,s.dom)("div.widget_switch",s.dom.cls("switch_on",t),s.dom.cls("switch_transition",e._isRealChange),(0,s.dom)("div.switch_slider"),(0,s.dom)("div.switch_circle"),this._addClickEventHandler(e)))}},ReferenceEditor:class extends Mt{constructor(e){super(e),this._showAddNew=!1;const t=e.gristDoc.docData;this._utils=new yo(e.field,t);const o=this._utils.visibleColModel;this._enableAddNew=o&&!o.isRealFormula()&&!!o.colId(),e.readonly||(this.cellEditorDiv.classList.add(_o.className),this.cellEditorDiv.appendChild(ko("FieldReference"))),this.textInput.value=(0,f.undef)(e.state,e.editValue,this._idToText());const n=void 0===e.editValue&&!this._utils.tableData.isLoaded;t.fetchTable(this._utils.refTableId).then((()=>{this.isDisposed()||(n&&""===this.textInput.value&&(this.textInput.value=(0,f.undef)(e.state,e.editValue,this._idToText()),this.resizeInput()),this._autocomplete&&(void 0===e.editValue?this._autocomplete.search((t=>t.findIndex((t=>t.rowId===e.cellValue)))):this._autocomplete.search()))})).catch(O.reportError)}attach(e){super.attach(e),this.options.readonly||(this._autocomplete=this.autoDispose(new bo.Autocomplete(this.textInput,{menuCssClass:X.menuCssClass+" "+wo.className,search:this._doSearch.bind(this),renderItem:this._renderItem.bind(this),getItemText:e=>e.text,onClick:()=>this.options.commands.fieldEditSaveHere()})))}async prepForSave(){const e=this._autocomplete&&this._autocomplete.getSelectedItem();if(e&&"new"===e.rowId&&e.text===this.textInput.value){const t={[this._utils.visibleColId]:this.textInput.value};e.rowId=await this._utils.tableData.sendTableAction(["AddRecord",null,t])}}getCellValue(){const e=this._autocomplete&&this._autocomplete.getSelectedItem();return e?e.rowId:(t=this.textInput.value,o=this._idToText(),t.trim().toLowerCase()===o.trim().toLowerCase()?this.options.cellValue:super.getCellValue());var t,o}_idToText(){return this._utils.idToText(this.options.cellValue)}async _doSearch(e){const t=this._utils.autocompleteSearch(e);if(this._showAddNew=!1,!this._enableAddNew||!e)return t;const o=(0,go.normalizeText)(e);return t.items.find((e=>e.cleanText===o))||(t.items.push({rowId:"new",text:e,cleanText:o}),this._showAddNew=!0),t}_renderItem(e,t){return vo(e.text,t,"new"===e.rowId,this._showAddNew)}},ReferenceList:class extends ho{buildDom(e){return wt(s.dom.cls("field_clip"),wt.cls("-wrap",this.wrapping),s.dom.style("justify-content",(e=>"right"===e(this.alignment)?"flex-end":e(this.alignment))),s.dom.domComputed((t=>{if(t(e._isAddRow)||this.isDisposed()||t(this.field.displayColModel).isDisposed())return null;const o=e.cells[t(t(this.field.displayColModel).colId)];if(!o)return null;const n=t(o);if(!n)return null;const i=(0,m.isList)(n)?n.slice(1):[n],s=t(this.field.visibleColFormatter);return i.map((e=>s.formatAny(e)))}),(e=>e?e.map((e=>{const t=""===e.trim();return(0,pt.choiceToken)(t?"[Blank]":e,{textColor:t?d.colors.slate.value:void 0},s.dom.cls(xt.className),(0,d.testId)("ref-list-cell-token"))})):null)))}},ReferenceListEditor:Ro,ChoiceTextBox:ut.Rf,ChoiceEditor:dt(),ChoiceListCell:_t,ChoiceListEditor:Ct.ChoiceListEditor,DateTimeTextBox:At(),DateTextBox:It(),DateEditor:kt(),AttachmentsWidget:Re,AttachmentsEditor:je,DateTimeEditor:Rt()};var Vo=o(77949);const Uo=(0,s.makeTestId)("test-fbuilder-");function jo(e,t,o,n={}){return t().map((function(t){return new Wo(e,t,o,n)})).setAutoDisposeValues()}function Ho(e,t,o){return K.withKoUtils(Lo.computed((()=>{var n;if(e.isDisposed())return!1;const i=null==(n=t())?void 0:n.style;return(null==i?void 0:i[o])||e.field[o]()}))).onlyNotifyUnequal()}class Wo extends s.Disposable{constructor(e,t,o,n={}){super(),this.gristDoc=e,this.field=t,this._cursor=o,this._options=n,this._docModel=e.docModel,this.origColumn=t.column(),this.options=t.widgetOptionsJson,this._comments=Lo.pureComputed((()=>(0,s.toKo)(Lo,(0,Q.COMMENTS)())())),this._readOnlyPureType=Lo.pureComputed((()=>this.field.column().pureType())),this._readonly=s.Computed.create(this,(o=>o(e.isReadonly)||o(t.disableEditData)||Boolean(this._options.isPreview))),this._availableTypes=s.Computed.create(this,(e=>{const t=e(this.origColumn.isFormula),o=[];return Vo.each(de.UD,((e,n)=>{const i={value:n,label:e.label,icon:e.icon};"Any"===n&&(i.disabled=!t),o.push(i)})),o})),this._isRightType=Lo.pureComputed((()=>m.isRightType(this._readOnlyPureType())||Vo.constant(!1))),this._isRef=this.autoDispose(Lo.computed((()=>{const e=this.field.column().type();return"Attachments"!==e&&(0,m.isFullReferencingType)(e)}))),this._refTableId=this.autoDispose(Lo.computed({read:()=>(0,m.getReferencedTableId)(this.field.column().type()),write:e=>{this.field.column().type().startsWith("Ref:")?this._setType(`Ref:${e}`):this._setType(`RefList:${e}`)}})),this.widget=Lo.pureComputed((()=>this.field.widget())),this.isCallPending=Lo.observable(!1),this.columnTransform=null,this._isTransformingFormula=this.autoDispose(Lo.computed((()=>this.field.column().isTransforming()&&this.columnTransform instanceof u))),this._isTransformingType=this.autoDispose(Lo.computed((()=>(this.field.column().isTransforming()||this.isCallPending())&&this.columnTransform instanceof j))),this._fieldEditorHolder=s.Holder.create(this),this._rowMap=new Map,this._widgetCons=this.autoDispose(K.withKoUtils(Lo.computed((()=>function(e,t){const{config:o}=(0,de.Tb)(e,t);return zo[o.cons]}(this.options().widget,this._readOnlyPureType())))).onlyNotifyUnequal()),this.widgetImpl=this.autoDispose(K.computedBuilder((()=>{const e=this._widgetCons();return e.create.bind(e,this.field,this.field.colId())}),this).extend({deferred:!0})),this.diffImpl=this.autoDispose(ie.create(this.field)),this._showRefConfigPopup=Lo.observable(!1)}buildSelectWidgetDom(){return s.dom.maybe((e=>!e(this._isTransformingType)&&e(this._readOnlyPureType)),(e=>{const t=function(e){return e&&de.UD[e]||de.UD.Text}(e).widgets,o=Object.keys(t).map((e=>({label:e,value:e,icon:t[e].icon})));if(o.length<=1)return null;const n=s.Computed.create(null,(e=>{if(!(o.length<=2))return e(this.field.config.widget)}));n.onWrite((e=>this.field.config.widget(e)));const i=s.Computed.create(null,(e=>!e(this.field.config.sameWidgets)));return[(0,a.cssLabel)("CELL FORMAT"),(0,a.cssRow)(s.dom.autoDispose(n),o.length<=2?(0,te.buttonSelect)((0,s.fromKo)(this.field.config.widget),o,te.cssButtonSelect.cls("-disabled",i)):(0,X.select)(n,o,{disabled:i,defaultLabel:"Mixed format"}),Uo("widget-select"))]}))}buildSelectTypeDom(){const e=new s.MultiHolder,t=s.Computed.create(e,(e=>e(e(this.field.viewSection).columnsType))),o=s.Computed.create(e,(e=>{const o=e((0,s.fromKo)(this._readOnlyPureType));return"mixed"===e(t)?"":o}));o.onWrite((e=>{if(e!==this._readOnlyPureType.peek()||"mixed"===t.get())return["Ref","RefList"].includes(e)&&this._showRefConfigPopup(!0),this._setType(e)}));const n=()=>this.isDisposed()||o.set(this.field.column().pureType()),i=s.Computed.create(e,(e=>e(e(this.field.viewSection).columnsAllIsFormula)));return[(0,a.cssRow)(s.dom.autoDispose(e),(0,X.select)(o,this._availableTypes,{disabled:e=>e(this._isTransformingFormula)||e(this.origColumn.disableModifyBase)||e(this.field.config.multiselect)&&!e(i)||e(this.isCallPending),menuCssClass:Go.className,defaultLabel:"Mixed types",renderOptionArgs:e=>{if(!["Ref","RefList"].includes(o.get()))return"Reference"===e.label?this.gristDoc.behavioralPromptsManager.attachTip("referenceColumns",{popupOptions:{attach:`.${Go.className}`,placement:"left-start"}}):null}}),Uo("type-select"),s.dom.cls("tour-type-selector"),s.dom.cls(a.cssBlockedCursor.className,(e=>e(this.origColumn.disableModifyBase)||e(this.field.config.multiselect)&&!e(i)))),s.dom.maybe((e=>e(this._isRef)&&!e(this._isTransformingType)),(()=>this._buildRefTableSelect())),s.dom.maybe(this._isTransformingType,(()=>W()("div.type_transform_prompt",Y.prompt(W()("div",s.dom.maybe(this._isRef,(()=>this._buildRefTableSelect())),s.dom.maybe((e=>e(this.field.column().isTransforming)),(()=>this.columnTransform.buildDom())))),s.dom.onDispose(n))))]}_setType(e){if(this.origColumn.isFormula()){const t=this.field.column(),o=T(e,t,this._docModel);if(this.field.viewSection.peek().selectedFields.peek().length>1&&["formula","empty"].indexOf(this.field.viewSection.peek().columnsBehavior.peek()))return this.gristDoc.docData.bundleActions("Changing multiple column types",(()=>Promise.all(this.field.viewSection.peek().selectedFields.peek().map((e=>e.column.peek().type.setAndSave(o)))))).catch(q.eK);t.type.setAndSave(o).catch(q.eK)}else{if(!this.columnTransform)return this.columnTransform=j.create(null,this.gristDoc,this),this.columnTransform.prepare(e);if(this.columnTransform instanceof j)return this.columnTransform.setType(e)}}_buildRefTableSelect(){const e=s.Computed.create(null,(e=>e(this._docModel.visibleTables.getObservable()).map((t=>({value:e(t.tableId),label:e(t.tableNameDef),icon:"FieldTable"}))))),t=s.Computed.create(null,(e=>e(this.origColumn.disableModifyBase)||e(this.field.config.multiselect)));return[(0,a.cssLabel)("DATA FROM TABLE",this._showRefConfigPopup.peek()?this.gristDoc.behavioralPromptsManager.attachTip("referenceColumnsConfig",{onDispose:()=>this._showRefConfigPopup(!1),popupOptions:{placement:"left-start"}}):null),(0,a.cssRow)(W().autoDispose(e),W().autoDispose(t),(0,X.select)((0,s.fromKo)(this._refTableId),e,{disabled:t}),Uo("ref-table-select"))]}buildTransformDom(){const e=Lo.computed({read:()=>this.field.column().isTransforming(),write:e=>e?(this.columnTransform=u.create(null,this.gristDoc,this),this.columnTransform.prepare()):this.columnTransform&&this.columnTransform.cancel()});return W()("div",W().autoDispose(e),W().onDispose((()=>{this.columnTransform&&this.columnTransform.finalize().catch(q.eK)})),Y.row(15,Y.label("Apply Formula to Data"),3,Y.buttonGroup(Y.checkButton(e,W()("span.glyphicon.glyphicon-flash"),W().testId("FieldBuilder_editTransform"),G.toggleClass("disabled",(()=>this._isTransformingType()||this.origColumn.isFormula()||this.origColumn.disableModifyBase()))))),G.maybe(this._isTransformingFormula,(()=>this.columnTransform.buildDom())))}buildConfigDom(){return W()("div",G.maybe((()=>!this._isTransformingType()&&this.widgetImpl()),(e=>W()("div",e.buildConfigDom(),Yo()))))}buildColorConfigDom(){return W()("div",G.maybe((()=>!this._isTransformingType()&&this.widgetImpl()),(e=>W()("div",e.buildColorConfigDom(this.gristDoc)))))}buildSettingOptions(){return W()("div",G.maybe((()=>!this._isTransformingType()&&this.widgetImpl()),(e=>W()("div",G.maybe((()=>this.origColumn.viewFields().all().length>1),(()=>W()("div.fieldbuilder_settings",Y.row(G.toggleClass("fieldbuilder_settings_header",!0),Y.label(W()("div.fieldbuilder_settings_button",W().testId("FieldBuilder_settings"),G.text((()=>this.field.useColOptions()?"Common":"Separate"))," ▾",(0,X.menu)((()=>{return e=this.field.useColOptions(),t=this.field.viewSection().isRaw(),o={useSeparate:()=>this.fieldSettingsUseSeparate(),saveAsCommon:()=>this.fieldSettingsSaveAsCommon(),revertToCommon:()=>this.fieldSettingsRevertToCommon()},e=e||t,[(0,X.menuSubHeader)(ee(e?"Using common settings":"Using separate settings")),e?(0,X.menuItem)(o.useSeparate,ee("Use separate settings"),s.dom.cls("disabled",t)):[(0,X.menuItem)(o.saveAsCommon,ee("Save as common settings")),(0,X.menuItem)(o.revertToCommon,ee("Revert to common settings"))]];var e,t,o}))),"Field in ",G.text((()=>this.origColumn.viewFields().all().length))," views")))))))))}fieldSettingsUseSeparate(){return this.gristDoc.docData.bundleActions(`Use separate field settings for ${this.origColumn.colId()}`,(()=>Promise.all([(0,J.setSaveValue)(this.field.widgetOptions,this.field.column().widgetOptions()),(0,J.setSaveValue)(this.field.visibleCol,this.field.column().visibleCol()),this.field.saveDisplayFormula(this.field.column()._displayColModel().formula()||"")])))}fieldSettingsSaveAsCommon(){return this.gristDoc.docData.bundleActions(`Save field settings for ${this.origColumn.colId()} as common`,(()=>Promise.all([(0,J.setSaveValue)(this.field.column().widgetOptions,this.field.widgetOptions()),(0,J.setSaveValue)(this.field.column().visibleCol,this.field.visibleCol()),this.field.column().saveDisplayFormula(this.field._displayColModel().formula()||""),(0,J.setSaveValue)(this.field.widgetOptions,""),(0,J.setSaveValue)(this.field.visibleCol,0),this.field.saveDisplayFormula("")])))}fieldSettingsRevertToCommon(){return this.gristDoc.docData.bundleActions(`Revert field settings for ${this.origColumn.colId()} to common`,(()=>Promise.all([(0,J.setSaveValue)(this.field.widgetOptions,""),(0,J.setSaveValue)(this.field.visibleCol,0),this.field.saveDisplayFormula("")])))}buildDomWithCursor(e,t,o){const n=K.withKoUtils(Lo.pureComputed((()=>this.field.rulesColsIds().map((t=>{var o,n,i;return null!=(i=null==(n=(o=e.cells)[t])?void 0:n.call(o))&&i}))),this).extend({deferred:!0})),i=K.withKoUtils(Lo.pureComputed((()=>{if(this.isDisposed())return null;if(e._isAddRow()||!e.id())return null;const t=this.field.rulesStyles();if(!Array.isArray(t)||0===t.length)return null;const o=n();if(t.length<o.length)return;const i=o.some((e=>!m.isValidRuleValue(e)));return i?{error:i}:{style:new Z.CombinedStyle(t,o)}}),this).extend({deferred:!0})).previousOnUndefined(),r=K.withKoUtils(Lo.computed((()=>{if(this.isDisposed())return null;const t=e.cells[this.field.colId()],o=t&&t();return t&&this._isRightType()(o,this.options)||e._isAddRow.peek()?this.widgetImpl():m.isVersions(o)?this.diffImpl:null})).extend({deferred:!0})).onlyNotifyUnequal(),l=K.withKoUtils(Lo.computed((()=>{var e,t;return this.isDisposed()?null:(null==(t=null==(e=i())?void 0:e.style)?void 0:t.textColor)||""}))).onlyNotifyUnequal(),a=K.withKoUtils(Lo.computed((()=>{var e,t;return this.isDisposed()?null:Ko((null==(t=null==(e=i())?void 0:e.style)?void 0:t.fillColor)||"")}))).onlyNotifyUnequal(),c=Ho(this,i,"fontBold"),d=Ho(this,i,"fontItalic"),u=Ho(this,i,"fontUnderline"),p=Ho(this,i,"fontStrikethrough"),h=Lo.pureComputed((()=>{var e;return Boolean(null==(e=i())?void 0:e.error)})),f=Lo.pureComputed((()=>this.field.textColor()||"")),g=Lo.pureComputed((()=>Ko(this.field.fillColor()||""))),b=K.withKoUtils(Lo.computed((()=>{if(this.isDisposed())return!1;if(!this._comments())return!1;if(this.gristDoc.isReadonlyKo())return!1;const t=e.id(),o=this.field.column().cells().all().find((e=>e.rowId()===t&&!e.resolved()&&e.type()===m.CellInfoType.COMMENT&&!e.hidden()&&e.root()));return Boolean(o)})).extend({deferred:!0})).onlyNotifyUnequal(),y=new s.MultiHolder;return y.autoDispose(b),y.autoDispose(r),y.autoDispose(n),y.autoDispose(h),y.autoDispose(f),y.autoDispose(g),y.autoDispose(i),y.autoDispose(c),y.autoDispose(d),y.autoDispose(u),y.autoDispose(p),n=>{this._rowMap.set(e,n),W()(n,W().autoDispose(y),G.style("--grist-cell-color",f),G.style("--grist-cell-background-color",g),G.style("--grist-rule-color",l),G.style("--grist-column-rule-background-color",a),this._options.isPreview?null:G.cssClass(this.field.formulaCssClass),G.toggleClass("field-with-comments",b),G.maybe(b,(()=>W()("div.field-comment-indicator"))),G.toggleClass("readonly",(0,s.toKo)(Lo,this._readonly)),G.maybe(o,(()=>W()("div.selected_cursor",G.toggleClass("active_cursor",t)))),G.scope(r,(o=>{if(this.isDisposed())return null;const n=o?o.buildDom(e):function(e,t){const o=e.cells[t.colId.peek()],n=t.widgetOptionsJson;return(0,s.dom)("div.field_clip.invalid",s.dom.clsPrefix("field-error-",(e=>(0,m.getObjCode)(e(o))||"")),s.dom.style("text-align",n.prop("alignment")),s.dom.cls("text_wrapping",(e=>Boolean(e(n.prop("wrap"))))),s.dom.text((e=>(0,re.cT)(o?e(o):"???"))))}(e,this.field);return W()(n,G.toggleClass("has_cursor",t),G.toggleClass("field-error-from-style",h),G.toggleClass("font-bold",c),G.toggleClass("font-underline",u),G.toggleClass("font-italic",d),G.toggleClass("font-strikethrough",p))})))}}buildEditorDom(e,t,o){if(this.columnTransform)return void this.columnTransform.finalize().catch(q.eK);const n=e.cells[this.field.colId()],i=n&&n();if(m.isCensored(i)&&!this.origColumn.isFormula.peek())return void this._fieldEditorHolder.clear();const s=function(e,t){const{config:o}=(0,de.Tb)(e,t);return zo[o.editCons]}(this.options().widget,this._readOnlyPureType());if(!s)return void this._fieldEditorHolder.clear();if(this._readonly.get()&&s.supportsReadonly&&!s.supportsReadonly())return void this._fieldEditorHolder.clear();if(!this._readonly.get()&&(0,le.qw)(s,e,this.field,o.init))return void this._fieldEditorHolder.clear();const r=this._rowMap.get(t),l=le.P1.create(this._fieldEditorHolder,{gristDoc:this.gristDoc,field:this.field,cursor:this._cursor,editRow:e,cellElem:r,editorCtor:s,state:o.state,startVal:this._readonly.get()?void 0:o.init,readonly:this._readonly.get()});this.gristDoc.fieldEditorHolder.autoDispose(l),l.onDispose((()=>this.gristDoc.activeEditor.set(null))),this.gristDoc.activeEditor.set(l)}buildDiscussionPopup(e,t,o){const n=this.gristDoc.fieldEditorHolder,i=this._rowMap.get(t);if(this.columnTransform)return void this.columnTransform.finalize().catch(q.eK);if(e._isAddRow.peek()||this._readonly.get())return;const r=e.cells[this.field.colId()],l=r&&r();if(m.isCensored(l))return void this._fieldEditorHolder.clear();const a=this.field.viewSection.peek().tableRef.peek(),c=s.MultiHolder.create(n),d=ae.c8.create(c,{gristDoc:this.gristDoc,tableRef:a,column:this.field.column.peek(),rowId:e.id.peek()});ae.XY.create(c,{domEl:i,topic:d,discussionId:o,gristDoc:this.gristDoc,closeClicked:()=>n.clear()})}isEditorActive(){return!this._fieldEditorHolder.isEmpty()}openSideFormulaEditor(e,t,o,n,i){const s=(0,ce.Ex)({gristDoc:this.gristDoc,column:this.field.column(),editingFormula:this.field.editingFormula,setupCleanup:le.Sf,editRow:e,refElem:t,editValue:o,onSave:n,onCancel:i});this.gristDoc.fieldEditorHolder.autoDispose(s)}}const Go=(0,s.styled)("div","\n  max-height: 500px;\n"),Yo=(0,s.styled)("div",`\n  border-bottom: 1px solid ${d.theme.pagePanelsBorder};\n  margin-top: 16px;\n`);function Ko(e){return e?e.startsWith("#")&&9===e.length?e.substring(0,7):e.startsWith("rgba")?e.replace(/^rgba\((\d+)[,\s]+(\d+)[,\s]+(\d+)[/,\s]+([\d.%]+)\)$/i,"rgb($1, $2, $3)"):e:e}},49506:(e,t,o)=>{"use strict";o.d(t,{P1:()=>y,qw:()=>g,Sf:()=>v});var n=o(24412),i=o(7935),s=o(92769),r=o(8881),l=o(29922),a=o(7454),c=o(4425),d=o(18099);const u=(0,d.styled)("div",`\n  display: flex;\n  align-items: center;\n  --icon-color: ${l.colors.lightGreen};\n\n  & > .${c.Y3.className} {\n    margin-left: 8px;\n  }\n`);var p=o(20354),h=o(48517),m=o(83277);const f=o(36812);function g(e,t,o,n){if(!o.column.peek().isRealFormula.peek()&&e.skipEditor){const i=t.cells[o.colId()].peek(),r=e.skipEditor(n,i);if(void 0!==r)return b(t,o,r).catch(s.reportError),!0}return!1}async function b(e,t,o){const n=e.cells[t.colId()];if(!f(o,n.peek()))return n.setAndSave(o)}class y extends d.Disposable{constructor(e){super(),this.saveEmitter=this.autoDispose(new d.Emitter),this.cancelEmitter=this.autoDispose(new d.Emitter),this.changeEmitter=this.autoDispose(new d.Emitter),this._editorHolder=d.Holder.create(this),this._saveEdit=(0,h.tJ)((()=>this._doSaveEdit())),this._editorHasChanged=!1,this._isFormula=!1,this._readonly=!1,this._gristDoc=e.gristDoc,this._field=e.field,this._cursor=e.cursor,this._editRow=e.editRow,this._editorCtor=e.editorCtor,this._cellElem=e.cellElem,this._readonly=e.readonly;const t=e.startVal;let o=!1;const i=this._field.column();this._isFormula=i.isRealFormula.peek();let r=t;var l,a,c;!e.readonly&&t&&m.startsWith(t,"=")&&(this._isFormula||this._field.column().isEmpty()?(this._isFormula=!0,r=m.removePrefix(t,"=")):o=!0),this._editCommands={fieldEditSave:()=>{this._saveEdit().then((e=>{e||n.allCommands.fieldEditSave.run()})).catch(s.reportError)},fieldEditSaveHere:()=>{this._saveEdit().catch(s.reportError)},fieldEditCancel:()=>{this._cancelEdit()},prevField:()=>{this._saveEdit().then(n.allCommands.prevField.run).catch(s.reportError)},nextField:()=>{this._saveEdit().then(n.allCommands.nextField.run).catch(s.reportError)},makeFormula:()=>this._makeFormula(),unmakeFormula:()=>this._unmakeFormula()},e.readonly&&(this._editCommands.fieldEditSave=()=>{this._editCommands.fieldEditCancel(),n.allCommands.fieldEditSave.run()},this._editCommands.fieldEditSaveHere=this._editCommands.fieldEditCancel,this._editCommands.prevField=()=>{this._cancelEdit(),n.allCommands.prevField.run()},this._editCommands.nextField=()=>{this._cancelEdit(),n.allCommands.nextField.run()},this._editCommands.makeFormula=()=>!0,this._editCommands.unmakeFormula=()=>!0),this.rebuildEditor(r,Number.POSITIVE_INFINITY,e.state),o&&this._offerToMakeFormula(),this._gristDoc.editorMonitor.monitorEditor(this),e.readonly?(this,l=this._gristDoc,a=this._field,c=()=>this._cancelEdit(),l.app.on("clipboard_focus",c),this.onDispose((()=>{a.editingFormula(!1),l.app.off("clipboard_focus",c)}))):v(this,this._gristDoc,this._field.editingFormula,this._saveEdit)}rebuildEditor(e,t,o){const n=this._isFormula?p.tC:this._editorCtor,i=this._field.column(),s=this._editRow.cells[this._field.colId()].peek();let r;r=i.isFormula()?i.formula():Array.isArray(s)&&"C"===s[0]?"":s;const l=(0,p.Nk)(this._gristDoc,this._editRow,i);this._readonly||this._field.editingFormula(this._isFormula&&void 0!==e),this._editorHasChanged=!1;const a=this._editorHolder.autoDispose(n.create({gristDoc:this._gristDoc,field:this._field,column:this._field.column(),editingFormula:this._field.editingFormula,cellValue:r,rowId:this._editRow.id(),formulaError:l,editValue:e,cursorPos:t,state:o,commands:this._editCommands,readonly:this._readonly}));a.editorState&&a.autoDispose(a.editorState.addListener((e=>{this._editorHasChanged=!0;const t={position:this.cellPosition(),wasModified:this._editorHasChanged,currentState:e,type:this._field.column.peek().pureType.peek()};this.changeEmitter.emit(t)}))),a.attach(this._cellElem)}getDom(){var e;return null==(e=this._editorHolder.get())?void 0:e.getDom()}cellPosition(){return{rowId:this._editRow.getRowId(),colRef:this._field.colRef.peek(),sectionId:this._field.viewSection.peek().id.peek()}}_makeFormula(){const e=this._editorHolder.get();if(e&&!this._field.editingFormula.peek()&&0===e.getCursorPos()){if(this._field.column().isEmpty())return this._isFormula=!0,this.rebuildEditor(e.getTextValue(),0),!1;this._offerToMakeFormula()}return!0}_unmakeFormula(){const e=this._editorHolder.get();return!(e&&this._field.editingFormula.peek()&&0===e.getCursorPos()&&!this._field.column().isRealFormula()&&(this._isFormula=!1,this.rebuildEditor("="+e.getTextValue(),1),1))}_offerToMakeFormula(){var e;const t=null==(e=this._editorHolder.get())?void 0:e.getDom();t&&function(e,t){const o=(0,r.showTooltip)(e,(function(e){return u((0,a.icon)("Convert"),(0,c.Y3)("Convert column to formula",d.dom.on("mousedown",(e=>{e.preventDefault(),t()})),(0,l.testId)("editor-tooltip-convert")),(0,r.tooltipCloseButton)(e))}),{key:"col-to-formula"});d.dom.onDisposeElem(e,o.close);const n=d.dom.onElem(e,"keydown",(()=>{n.dispose(),o.close()}))}(t,(()=>this._convertEditorToFormula()))}_convertEditorToFormula(){const e=this._editorHolder.get();if(e){const t=e.getTextValue(),o=t.startsWith("=")?t.slice(1):t;this._isFormula=!0,this.rebuildEditor(o,0)}}_cancelEdit(){var e,t;if(this.isDisposed())return;const o={position:this.cellPosition(),wasModified:this._editorHasChanged,currentState:null==(t=null==(e=this._editorHolder.get())?void 0:e.editorState)?void 0:t.get(),type:this._field.column.peek().pureType.peek()};this.cancelEmitter.emit(o),this.dispose()}async _doSaveEdit(){var e,t,o;const n=this._editorHolder.get();if(!n)return!1;const i=this._cursor.rowIndex();if(await n.prepForSave(),this.isDisposed())return console.warn("Unable to finish saving edited cell"),!1;const s=this._field.editingFormula(),r=this._field.column();let l=null;if(s){const t=String(null!=(e=n.getCellValue())?e:"");s===r.isFormula.peek()&&t===r.formula.peek()||(l=this._gristDoc.docData.bundleActions(null,(()=>Promise.all([r.updateColValues({isFormula:s,formula:t}),this._editRow._isAddRow.peek()&&""!==t?this._editRow.updateColValues({}):void 0]))))}else{const e=n.getCellValue();r.isRealFormula()?console.warn("It should be impossible to save a plain data value into a formula column"):l=b(this._editRow,this._field,e)}const a={position:this.cellPosition(),wasModified:this._editorHasChanged,currentState:null==(o=null==(t=this._editorHolder.get())?void 0:t.editorState)?void 0:o.get(),type:this._field.column.peek().pureType.peek()};this.saveEmitter.emit(a);const c=this._cursor;return this.dispose(),await l,s||i!==c.rowIndex()}}function v(e,t,o,n){const r=()=>n().catch(s.reportError);t.app.on("clipboard_focus",r),i.LV.create(e,(async()=>{await r()})),e.onDispose((()=>{t.app.off("clipboard_focus",r),o(!1)}))}},20354:(e,t,o)=>{"use strict";o.d(t,{Ex:()=>y,Nk:()=>v,So:()=>x,Ue:()=>_,tC:()=>b});var n=o(87056),i=o(24412),s=o(29922),r=o(7454),l=o(16151),a=o(41880),c=o(63074),d=o(83277),u=o(18099),p=o(631),h=o(93965),m=o(48517),f=o(92769);const g=o(88466);class b extends c._{constructor(e){super(e);const t=e.editingFormula,o=(0,d.undef)(e.state,e.editValue,String(e.cellValue));this.editorState=u.Observable.create(this,o),this._formulaEditor=n.create({column:e.column,calcSize:this._calcSize.bind(this),gristDoc:e.gristDoc,saveValueOnBlurEvent:!e.readonly,editorState:this.editorState,readonly:e.readonly});const r=e.readonly?e.commands:Object.assign({setCursor:this._onSetCursor},e.commands);this._commandGroup=this.autoDispose((0,i.createGroup)(r,this,t));const a=u.Observable.create(this,!0),c=u.Computed.create(this,(t=>e.formulaError?(0,p.isRaisedException)(t(e.formulaError))?(0,h.xD)(t(e.formulaError)):new h.es(["Unknown error"]):null)),m=u.Computed.create(this,c,((e,t)=>t?t.message?`${t.name} : ${t.message}`:t.name:"")),f=u.Computed.create(this,c,((e,t)=>{var o;return t&&null!=(o=t.details)?o:""}));this.autoDispose(f.addListener((()=>setTimeout((()=>this._formulaEditor.resize()),0)))),this.autoDispose(this._formulaEditor),this._dom=(0,u.dom)("div.default_editor.formula_editor_wrapper",u.dom.cls("readonly_editor",e.readonly),(0,l.createMobileButtons)(e.commands),e.cssClass?u.dom.cls(e.cssClass):null,u.dom.on("mousedown",(e=>{e.preventDefault(),this._formulaEditor.getEditor().focus()})),(0,u.dom)("div.formula_editor.formula_field_edit",(0,s.testId)("formula-editor"),this._formulaEditor.buildDom((n=>{n.setFontSize(11),n.setHighlightActiveLine(!1),n.getSession().setUseWrapMode(!1),n.renderer.setPadding(0);const i=o,s=Math.min(e.cursorPos,i.length);this._formulaEditor.setValue(i,s),this._formulaEditor.attachCommandGroup(this._commandGroup),(e.state||e.readonly)&&t(!0),e.readonly&&(this._formulaEditor.enable(!1),n.gotoLine(0,0)),n.once("change",(()=>null==t?void 0:t(!0)))}))),e.formulaError?[(0,u.dom)("div.error_msg",(0,s.testId)("formula-error-msg"),u.dom.on("click",(()=>{f.get()&&(a.set(!a.get()),this._formulaEditor.resize())})),u.dom.maybe(f,(()=>u.dom.domComputed(a,(e=>w(e?"Expand":"Collapse"))))),u.dom.text(m)),u.dom.maybe((e=>Boolean(e(f)&&!e(a))),(()=>(0,u.dom)("div.error_details",(0,u.dom)("div.error_details_inner",u.dom.text(f)),(0,s.testId)("formula-error-details"))))]:null)}attach(e){this._editorPlacement=a.EditorPlacement.create(this,this._dom,e,{margins:(0,l.getButtonMargins)()}),this.autoDispose(this._editorPlacement.onReposition.addListener(this._formulaEditor.resize,this._formulaEditor)),this._formulaEditor.onAttach(),this._formulaEditor.editor.focus()}getDom(){return this._dom}getCellValue(){return this._formulaEditor.getValue()}getTextValue(){return this._formulaEditor.getValue()}getCursorPos(){const e=this._formulaEditor.getEditor();return e.getSession().getDocument().positionToIndex(e.getCursorPosition())}_calcSize(e,t){const o=this._dom.querySelector(".error_details"),n=(null==o?void 0:o.getBoundingClientRect().height)||0,i=(null==o?void 0:o.scrollHeight)||0,s={width:Math.max(t.width,this.options.formulaError?400:0),height:t.height+(i-n)},r=this._editorPlacement.calcSizeWithPadding(e,s);if(o){const e=n+(r.height-t.height),s=Math.min(i,Math.max(e,64));o.style.height=`${s}px`,r.height-=s-n}return r}_onSetCursor(e,t){if(!t)return;if(this.options.readonly)return;const o=this._formulaEditor.getEditor();if(o.selection.isEmpty()){const e=o.getCursorPosition(),i=function(e,t){let o=e.slice(0,t).search(/[$A-Za-z0-9_]+$/);o<0&&(o=t);const n=e.slice(o).match(/^[$a-zA-Z0-9_]+/);if(n){const e=n[0];return{ident:e,start:o,end:o+e.length}}return null}(o.session.getLine(e.row),e.column);if(i){if(i.ident.startsWith("$")){const s=n.makeRange(e.row,i.start,e.row,i.end);o.session.replace(s,"$"+t.colId())}}else o.insert("$"+t.colId())}else o.session.replace(o.selection.getRange(),"$"+t.colId());this._formulaEditor.resize(),o.focus()}}function y(e){var t,o,n,i;const{gristDoc:s,editRow:r,refElem:l,setupCleanup:a}=e,c=u.MultiHolder.create(null),d=null!=(o=e.column)?o:null==(t=e.field)?void 0:t.column();if(!d)throw new Error("Column or field is required");const p=(0,m.tJ)((async()=>{var t;const o=String(g.getCellValue());o!==d.formula.peek()?(e.onSave?await e.onSave(d,o):await d.updateColValues({formula:o}),c.dispose()):(c.dispose(),null==(t=e.onCancel)||t.call(e))})),h={fieldEditSave:()=>{p().catch(f.reportError)},fieldEditSaveHere:()=>{p().catch(f.reportError)},fieldEditCancel:()=>{var t;c.dispose(),null==(t=e.onCancel)||t.call(e)}},g=b.create(c,{gristDoc:s,column:d,editingFormula:e.editingFormula,rowId:r?r.id():0,cellValue:d.formula(),formulaError:r?v(s,r,d):void 0,editValue:e.editValue,cursorPos:Number.POSITIVE_INFINITY,commands:h,cssClass:"formula_editor_sidepane",readonly:!1});g.attach(l);const y=null!=(i=e.editingFormula)?i:null==(n=null==e?void 0:e.field)?void 0:n.editingFormula;if(!y)throw new Error("editingFormula is required");return d.formula()||y(!0),a(c,s,y,p),c}function v(e,t,o){const n=o.colId.peek(),i=t.cells[n].peek();if((o.isFormula()||o.hasTriggerFormula())&&(0,p.isRaisedException)(i)){const s=u.Observable.create(null,i);return e.docData.getFormulaError(o.table().tableId(),n,t.getRowId()).then((e=>{s.set(e)})).catch(f.reportError),s}}function _(e,t,o){const n=u.Observable.create(e,""),i=g((function(){var i;if(e.isDisposed())return;const s=t.docData.getTable(o.table.peek().tableId.peek()),r=o.isRealFormula.peek()||o.hasTriggerFormula.peek();if(s&&r){const e=o.colId.peek(),t=(null==(i=s.getColValues(e))?void 0:i.length)||0,r=s.countErrors(e)||0;n.set(0===r?"":1===t?"Error in the cell":r===t?`Errors in all ${r} cells`:`Errors in ${r} of ${t} cells`)}else n.set("")}),0);return u.Computed.create(e,(e=>{const n=t.docData.getTable(e(e(o.table).tableId));return n?e.owner.autoDispose(n.tableActionEmitter.addListener(i)):null})),e.autoDispose((0,u.subscribe)((e=>{e(o.id),e(o.isRealFormula),i()}))),n}const w=(0,u.styled)(r.icon,`\n  margin: -3px 4px 0 4px;\n  --icon-color: ${s.colors.slate};\n`),x=(0,u.styled)("div",`\n  color: ${s.theme.errorText};\n`)},61957:(e,t,o)=>{"use strict";o.d(t,{D:()=>h,T:()=>f});var n=o(95163),i=o(3534),s=o(3411),r=o(88261),l=o(29922),a=o(7454),c=o(4425),d=o(64283),u=o(18099);const p=(0,o(70387).makeT)("NTextBox");class h extends d.a{constructor(e,t={}){super(e,t),this.alignment=(0,u.fromKo)(this.options.prop("alignment")),this.wrapping=(0,u.fromKo)(this.field.wrap),this.autoDispose(this.wrapping.addListener((()=>{this.field.viewSection().events.trigger("rowHeightChange")})))}buildConfigDom(){const e=this.field.config.options,t=u.Computed.create(this,(t=>t(e.disabled("alignment")))),o=u.Computed.create(this,(t=>t(e.disabled("wrap"))));return[(0,s.cssRow)((0,r.alignmentSelect)((0,n.fromKoSave)(this.field.config.alignment),r.cssButtonSelect.cls("-disabled",t)),(0,u.dom)("div",{style:"margin-left: 8px;"},(0,r.makeButtonSelect)((0,u.fromKo)(this.field.config.wrap),[{value:!0,icon:"Wrap"}],(()=>{const e=!this.field.config.wrap.peek();this.field.config.wrap.setAndSave(e).catch(reportError)}),r.cssButtonSelect.cls("-disabled",o)),(0,l.testId)("tb-wrap-text")))]}buildDom(e){const t=e.cells[this.field.colId.peek()];return(0,u.dom)("div.field_clip",u.dom.style("text-align",this.alignment),u.dom.cls("text_wrapping",this.wrapping),u.dom.domComputed((o=>o(e._isAddRow)?null:function(e){try{const t=[];for(const{value:o,isLink:n}of(0,i.rq)(e))n?t.push(m((0,c.rg)(o,(0,a.cssIconBackground)((0,a.icon)("FieldLink",(0,l.testId)("tb-link-icon")),u.dom.cls(g.className))),b(o),(0,l.testId)("text-link"))):t.push(o);return t}catch(t){return console.warn("makeLinks failed",t),e}}(o(this.valueFormatter).formatAny(o(t),p)))))}}const m=(0,u.styled)("span","\n  white-space: inherit;\n  .text_wrapping & {\n    word-break: break-all;\n    white-space: pre-wrap;\n  }\n"),f=e=>(0,u.styled)("span",`\n  --icon-color: var(--grist-actual-cell-color, ${l.colors.lightGreen});\n  margin: -1px 2px 2px 0;\n  border-radius: 3px;\n  transition-property: background-color;\n  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);\n  transition-duration: 150ms;\n  transition-delay: 90ms;\n  .${e}:hover & {\n    --icon-background: ${l.colors.lightGreen};\n    --icon-color: white;\n    transition-duration: 80ms;\n    transition-delay: 0ms;\n  }\n`),g=f(m.className),b=(0,u.styled)("span",`\n  color: var(--grist-actual-cell-color, ${l.colors.lightGreen});;\n`)},64283:(e,t,o)=>{"use strict";o.d(t,{a:()=>s});var n=o(73974),i=o(18099);class s extends i.Disposable{constructor(e,t={}){super(),this.field=e,this.options=e.widgetOptionsJson,this.valueFormatter=(0,i.fromKo)(e.formatter),this.defaultTextColor=(null==t?void 0:t.defaultTextColor)||"#000000"}static create(...e){return i.Disposable.create.call(this,null,...e)}buildConfigDom(){return null}buildTransformConfigDom(){return null}buildColorConfigDom(e){return i.dom.create(n.CellStyle,this.field,e,this.defaultTextColor)}_getDocData(){return this.field._table.tableData.docData}_getDocComm(){return this._getDocData().docComm}}},63074:(e,t,o)=>{"use strict";o.d(t,{_:()=>i});var n=o(18099);class i extends n.Disposable{constructor(e){super(),this.options=e}static create(e,t){return t?n.Disposable.create.call(this,e,t):n.Disposable.create.call(this,null,e)}static skipEditor(e,t){}static supportsReadonly(){return!0}getDom(){return null}prepForSave(){}}},73454:(e,t,o)=>{"use strict";o.r(t),o.d(t,{buildTZAutocomplete:()=>f,timezoneOptionsImpl:()=>m});var n=o(11104),i=o(84462),s=o(29922),r=o(83277),l=Object.defineProperty,a=Object.defineProperties,c=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,h=(e,t,o)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;function m(e,t,o){const n=o.unix(e/1e3),i=t.map((t=>({cleanText:t.toLowerCase().trim(),value:t,label:`(GMT${n.tz(t).format("Z")}) ${t}`,offset:-o.tz.zone(t).parse(e)})));return i.sort(((e,t)=>(0,r.nativeCompare)(e.offset,t.offset)||(0,r.nativeCompare)(e.value,t.value))),i}function f(e,t,o,r,l){const f=new n.ACIndexImpl(function(e){return m(Date.now(),e.tz.names(),e)}(t),1e3,!0);return(0,i.R)(e,(g=((e,t)=>{for(var o in t||(t={}))u.call(t,o)&&h(e,o,t[o]);if(d)for(var o of d(t))p.call(t,o)&&h(e,o,t[o]);return e})({},l),a(g,c({acIndex:f,valueObs:o,save:(e,t)=>{if(!t){const o=f.search(e);o.selectIndex>=0&&o.items.length>0&&(e=(t=o.items[o.selectIndex]).value)}if(!t)throw new Error("Invalid time zone");if(e!==o.get())return r(e)}}))),(0,s.testId)("tz-autocomplete"));var g}},49142:(e,t,o)=>{"use strict";o.d(t,{JH:()=>s,Tb:()=>i,UD:()=>r});var n=o(77949);function i(e,t){const o=r[t]||r.Text;return e in o.widgets||(e=o.default),{name:e,config:o.widgets[e]}}function s(e,t){const{name:o,config:s}=i(e.widget,t);return n.default.defaults({widget:o},e,s.options)}const r={Any:{label:"Any",icon:"FieldAny",widgets:{TextBox:{cons:"TextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{alignment:"left",wrap:void 0}}},default:"TextBox"},Text:{label:"Text",icon:"FieldText",widgets:{TextBox:{cons:"TextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{alignment:"left",wrap:void 0}},HyperLink:{cons:"HyperLinkTextBox",editCons:"HyperLinkEditor",icon:"FieldLink",options:{alignment:"left",wrap:void 0}}},default:"TextBox"},Numeric:{label:"Numeric",icon:"FieldNumeric",widgets:{TextBox:{cons:"NumericTextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{alignment:"right",wrap:void 0,decimals:void 0,maxDecimals:void 0,numMode:void 0,numSign:void 0,currency:void 0}},Spinner:{cons:"Spinner",editCons:"TextEditor",icon:"FieldSpinner",options:{alignment:"right",wrap:void 0,decimals:void 0,maxDecimals:void 0,numMode:void 0,numSign:void 0,currency:void 0}}},default:"TextBox"},Int:{label:"Integer",icon:"FieldInteger",widgets:{TextBox:{cons:"NumericTextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{decimals:0,alignment:"right",wrap:void 0,maxDecimals:void 0,numMode:void 0,numSign:void 0,currency:void 0}},Spinner:{cons:"Spinner",editCons:"TextEditor",icon:"FieldSpinner",options:{decimals:0,alignment:"right",wrap:void 0,maxDecimals:void 0,numMode:void 0,numSign:void 0,currency:void 0}}},default:"TextBox"},Bool:{label:"Toggle",icon:"FieldToggle",widgets:{TextBox:{cons:"TextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{alignment:"center",wrap:void 0}},CheckBox:{cons:"CheckBox",editCons:"CheckBoxEditor",icon:"FieldCheckbox",options:{}},Switch:{cons:"Switch",editCons:"CheckBoxEditor",icon:"FieldSwitcher",options:{}}},default:"CheckBox"},Date:{label:"Date",icon:"FieldDate",widgets:{TextBox:{cons:"DateTextBox",editCons:"DateEditor",icon:"FieldTextbox",options:{dateFormat:"YYYY-MM-DD",isCustomDateFormat:!1,alignment:"left"}}},default:"TextBox"},DateTime:{label:"DateTime",icon:"FieldDateTime",widgets:{TextBox:{cons:"DateTimeTextBox",editCons:"DateTimeEditor",icon:"FieldTextbox",options:{dateFormat:"YYYY-MM-DD",timeFormat:"h:mma",isCustomDateFormat:!1,isCustomTimeFormat:!1,alignment:"left"}}},default:"TextBox"},Choice:{label:"Choice",icon:"FieldChoice",widgets:{TextBox:{cons:"ChoiceTextBox",editCons:"ChoiceEditor",icon:"FieldTextbox",options:{alignment:"left",wrap:void 0,choices:void 0,choiceOptions:void 0}}},default:"TextBox"},ChoiceList:{label:"Choice List",icon:"FieldChoice",widgets:{TextBox:{cons:"ChoiceListCell",editCons:"ChoiceListEditor",icon:"FieldTextbox",options:{alignment:"left",wrap:void 0,choices:void 0,choiceOptions:void 0}}},default:"TextBox"},Ref:{label:"Reference",icon:"FieldReference",widgets:{Reference:{cons:"Reference",editCons:"ReferenceEditor",icon:"FieldReference",options:{alignment:"left",wrap:void 0}}},default:"Reference"},RefList:{label:"Reference List",icon:"FieldReference",widgets:{Reference:{cons:"ReferenceList",editCons:"ReferenceListEditor",icon:"FieldReference",options:{alignment:"left",wrap:void 0}}},default:"Reference"},Attachments:{label:"Attachment",icon:"FieldAttachment",widgets:{Attachments:{cons:"AttachmentsWidget",editCons:"AttachmentsEditor",icon:"FieldAttachment",options:{height:"36"}}},default:"Attachments"}}},549:(e,t,o)=>{"use strict";o.d(t,{$g:()=>s,QB:()=>r,Yo:()=>a,d:()=>c,dB:()=>i,r2:()=>l});const n=o(39898);function i(){return{updateRows:[],removeRows:[],addRows:[],columnDeltas:{},columnRenames:[]}}function s(e){const t={};for(const[o,i]of n(e.tableDeltas)){const e=t[o]={header:[],cells:[]},s={},r=new Set;for(const[e,t]of n(i.columnDeltas)){r.add(e);for(const o of Object.keys(t))s[o]||(s[o]={}),s[o][e]=t[o]}const l=[...r].filter((e=>"manualSort"!==e));e.header=l;const a=new Set(i.addRows),c=new Set(i.removeRows),d=new Set(i.updateRows),u=Object.keys(s).map((e=>parseInt(e,10))),p=new Set(u),h=[...a,...c,...d].filter((e=>!p.has(e))).sort(((e,t)=>e-t));for(const t of u){if(h.length>0&&t>h[0])for(e.cells.push(["...",h[0],l.map((e=>[null,null]))]);t>h[0];)h.shift();const o=[];if(a.has(t)&&c.has(t))o.push(["-",e=>[e[0],null]]),o.push(["+",e=>[null,e[1]]]);else{let e="...";d.has(t)&&(e="→"),a.has(t)&&(e="+"),c.has(t)&&(e="-"),o.push([e,e=>e])}for(const[n,i]of o){const o=[],r=s[t];l.forEach((e=>{const t=r?r[e]:null;t?o.push(i(t)):o.push([null,null])})),e.cells.push([n,t,o])}}}return t}function r(e){return`-${e}`}function l(e){return[...e.tableRenames.map((e=>e[1]||r(e[0]||""))),...Object.keys(e.tableDeltas)]}function a(e,t){if(null===t)return t;const o=e.find((e=>e[1]===t));return o?o[0]:t}function c(e,t){if(null===t)return t;const o=e.find((e=>e[0]===t)),n=o?o[1]:t;return(null==n?void 0:n.startsWith("-"))?null:n}},48517:(e,t,o)=>{"use strict";function n(e){let t;return()=>{return t||((o=e.call(null)).catch((()=>{t=void 0})),t=o);var o}}o.d(t,{tJ:()=>n}),Map},91655:(e,t,o)=>{"use strict";o.d(t,{o:()=>d,v:()=>u});var n=o(34903),i=o(93965),s=o(68652),r=o.n(s),l=o(631),a=o(75083),c=o(32275);function d(e,t=""){if((0,n.xX)(e)){let{min:o,max:n}=e;if((0,l.isNumberType)(t)||(0,l.isDateLikeType)(t)){if((0,l.isDateLikeType)(t)){const e=(0,l.extractInfoFromColType)(t),i="DateTime"===e.type&&e.timezone||"utc";o=p(o,i,(e=>e.startOf("day"))),n=p(n,i,(e=>e.endOf("day")))}return e=>"number"==typeof e&&(void 0===n||e<=n)&&(void 0===o||o<=e)}return()=>!0}const{include:o,values:s}=e;return e=>{if((0,l.isList)(e)&&t&&(0,l.isListType)(t)){const n=(0,i.xD)(e);if(n.length)return n.some((e=>s.has(e)===o));e="ChoiceList"===t?"":null}return s.has(Array.isArray(e)?JSON.stringify(e):e)===o}}function u(e,t){return e?d((0,n.nR)(e),t):null}function p(e,t,o=c.noop){if(void 0===e)return;const n=(0,a.CV)(e)?(0,a.ZW)(e):e,i=r().tz(1e3*n,t);return o(i),Math.floor(i.valueOf()/1e3)}},21296:(e,t,o)=>{"use strict";o.d(t,{Z:()=>i,u:()=>n});var n=(e=>(e.none="none",e.read_table="read table",e.full="full",e))(n||{});function i(e,t){function o(e){switch(e){case"none":return 0;case"read table":return 1;case"full":return 2;default:throw new Error(`Unrecognized access level ${e}`)}}return o(e)>=o(t)}},9072:(e,t,o)=>{"use strict";o.d(t,{G:()=>s});var n=o(86277),i=o(18099);class s extends i.Disposable{constructor(){super(),this.onDispose(this.stopListening,this)}}Object.assign(s.prototype,n.Events)},413:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CALCULATING_USER_ACTIONS:()=>R,fromTableDataAction:()=>E,getColIdsFromDocAction:()=>P,getColValues:()=>M,getColValuesFromDocAction:()=>B,getNumRows:()=>A,getSelectionDesc:()=>F,getTableId:()=>T,isAddColumn:()=>b,isAddRecord:()=>d,isAddTable:()=>w,isBulkAddRecord:()=>u,isBulkRemoveRecord:()=>h,isBulkUpdateRecord:()=>f,isDataAction:()=>I,isModifyColumn:()=>_,isRemoveColumn:()=>y,isRemoveRecord:()=>p,isRemoveTable:()=>x,isRenameColumn:()=>v,isRenameTable:()=>C,isReplaceTableData:()=>g,isSchemaAction:()=>S,isUpdateRecord:()=>m,toTableDataAction:()=>O});var n=Object.defineProperty,i=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,l=(e,t,o)=>t in e?n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,a=(e,t)=>{for(var o in t||(t={}))s.call(t,o)&&l(e,o,t[o]);if(i)for(var o of i(t))r.call(t,o)&&l(e,o,t[o]);return e};const c=o(13314);function d(e){return"AddRecord"===e[0]}function u(e){return"BulkAddRecord"===e[0]}function p(e){return"RemoveRecord"===e[0]}function h(e){return"BulkRemoveRecord"===e[0]}function m(e){return"UpdateRecord"===e[0]}function f(e){return"BulkUpdateRecord"===e[0]}function g(e){return"ReplaceTableData"===e[0]}function b(e){return"AddColumn"===e[0]}function y(e){return"RemoveColumn"===e[0]}function v(e){return"RenameColumn"===e[0]}function _(e){return"ModifyColumn"===e[0]}function w(e){return"AddTable"===e[0]}function x(e){return"RemoveTable"===e[0]}function C(e){return"RenameTable"===e[0]}const D=new Set(["AddTable","RemoveTable","RenameTable","AddColumn","RemoveColumn","RenameColumn","ModifyColumn"]),k=new Set(["AddRecord","RemoveRecord","UpdateRecord","BulkAddRecord","BulkRemoveRecord","BulkUpdateRecord","ReplaceTableData","TableData"]);function S(e){return D.has(e[0])}function I(e){return k.has(e[0])}function T(e){return e[1]}const R=new Set(["Calculate","UpdateCurrentTime","RespondToRequests"]);function F(e,t){const o=e[1],n=e[2],i=e[3];return`table ${o}, row${"object"==typeof n?"s":""} ${n}; ${c(i,((e,o)=>t?o:`${o}: ${e}`)).join(", ")}`}function A(e){return I(e)?Array.isArray(e[2])?e[2].length:1:0}function O(e,t){const o=a({},t),n=o.id;return delete o.id,["TableData",e,n,o]}function E(e){const t="tableData"in e?e.tableData:e,o=t[2],n=t[3];return a({id:o},n)}function M(e){const t=new Set;for(const o of e)for(const e of Object.keys(o))"id"!==e&&t.add(e);const o={};for(const n of t)o[n]=e.map((e=>e[n]));return o}function P(e){if(e[3])return Object.keys(e[3])}function B(e,t){const o=e[3];if(!o)return;const n=o[t];return n?Array.isArray(e[2])?n:[n]:void 0}},34903:(e,t,o)=>{"use strict";o.d(t,{CV:()=>n.CV,nR:()=>i,oz:()=>s,t0:()=>l,xX:()=>r});var n=o(75083);function i(e){return"string"==typeof e?i(e&&JSON.parse(e)||{}):void 0!==e.min||void 0!==e.max?{min:e.min,max:e.max}:{include:Boolean(e.included),values:new Set(e.included||e.excluded||[])}}function s(e,t){const o=i(t);if(r(e)||r(o)){if(!r(e)||!r(o))return!1;if(e.min!==o.min||e.max!==o.max)return!1}else{if(e.include!==o.include)return!1;if(e.values.size!==o.values.size)return!1;if(o.values)for(const t of o.values)if(!e.values.has(t))return!1}return!0}function r(e){const{min:t,max:o}=e;return void 0!==t||void 0!==o}function l(e,t){return(0,n.CV)(e)&&(0,n.CV)(t)?(0,n.u7)(e,t):!(0,n.CV)(e)&&!(0,n.CV)(t)&&e===t}},22985:(e,t,o)=>{"use strict";o.d(t,{QT:()=>a,zC:()=>d,k1:()=>l});var n=o(33029),i=o(17933),s=o(83277);const r=["af-ZA","ak-GH","am-ET","ar-AE","ar-BH","ar-DZ","ar-EG","ar-IN","ar-IQ","ar-JO","ar-KW","ar-LB","ar-LY","ar-MA","ar-OM","ar-QA","ar-SA","ar-SD","ar-SS","ar-SY","ar-TN","ar-YE","as-IN","ast-ES","az-AZ","az-IR","be-BY","bem-ZM","bg-BG","bn-BD","bn-IN","bo-CN","bo-IN","br-FR","brx-IN","bs-BA","ca-AD","ca-ES","ca-FR","ca-IT","ce-RU","chr-US","ckb-IQ","cs-CZ","cy-GB","da-DK","de-AT","de-BE","de-CH","de-DE","de-IT","de-LI","de-LU","doi-IN","dz-BT","el-CY","el-GR","en-AG","en-AU","en-BW","en-CA","en-DK","en-GB","en-HK","en-IE","en-IL","en-IN","en-NG","en-NZ","en-PH","en-SC","en-SG","en-US","en-ZA","en-ZM","en-ZW","es-AR","es-BO","es-CL","es-CO","es-CR","es-CU","es-DO","es-EC","es-ES","es-GT","es-HN","es-MX","es-NI","es-PA","es-PE","es-PR","es-PY","es-SV","es-US","es-UY","es-VE","et-EE","eu-ES","fa-IR","ff-SN","fi-FI","fil-PH","fo-FO","fr-BE","fr-CA","fr-CH","fr-FR","fr-LU","fur-IT","fy-DE","fy-NL","ga-IE","gd-GB","gl-ES","gu-IN","gv-GB","ha-NG","he-IL","hi-IN","hr-HR","hsb-DE","hu-HU","hy-AM","ia-FR","id-ID","ig-NG","is-IS","it-CH","it-IT","ja-JP","kab-DZ","ka-GE","kk-KZ","kl-GL","km-KH","kn-IN","kok-IN","ko-KR","ks-IN","ku-TR","kw-GB","ky-KG","lb-LU","lg-UG","ln-CD","lo-LA","lt-LT","lv-LV","mai-IN","mai-NP","mfe-MU","mg-MG","mi-NZ","mk-MK","ml-IN","mni-IN","mn-MN","mr-IN","ms-MY","mt-MT","my-MM","ne-NP","nl-AW","nl-BE","nl-NL","nn-NO","om-ET","om-KE","or-IN","os-RU","pa-IN","pa-PK","pl-PL","ps-AF","pt-BR","pt-PT","ro-RO","ru-RU","ru-UA","rw-RW","sa-IN","sat-IN","sd-IN","se-NO","si-LK","sk-SK","sl-SI","so-DJ","so-ET","so-KE","so-SO","sq-AL","sq-MK","sr-ME","sr-RS","sv-FI","sv-SE","sw-KE","sw-TZ","ta-IN","ta-LK","te-IN","tg-TJ","th-TH","ti-ER","ti-ET","tk-TM","to-TO","tr-CY","tr-TR","tt-RU","ug-CN","uk-UA","ur-IN","ur-PK","uz-UZ","vi-VN","wae-CH","wo-SN","xh-ZA","yi-US","yo-NG","yue-HK","zh-CN","zh-HK","zh-SG","zh-TW","zu-ZA"];let l,a;try{const e=new Intl.DisplayNames("en",{type:"region"}),t=new Intl.DisplayNames("en",{type:"language"}),o=o=>{try{const n=new Intl.Locale(o);return`${e.of(n.region)} (${t.of(n.language)})`}catch(e){return o}};l=Intl.DisplayNames.supportedLocalesOf(r).map((e=>({name:o(e),code:e})))}catch(e){l=r.map((e=>({name:e,code:e})))}n.SS="SSP",n.XK="EUR";const c=Object.values(n);function d(e){const t=i.z(null!=e?e:"en-US");return null!=t?t:"USD"}try{const e=new Intl.DisplayNames("en",{type:"currency"});a=[...new Set(c)].map((t=>({name:e.of(t),code:t})))}catch(e){a=[...new Set(c)].map((e=>({name:e,code:e})))}a=[...a].sort(((e,t)=>(0,s.nativeCompare)(e.code,t.code)))},99597:(e,t,o)=>{"use strict";o.d(t,{LX:()=>d,QS:()=>r,y6:()=>a,zC:()=>l});var n=o(83277),i=o(45689),s=o(17933);const r=(0,i.U)("currency","decimal","percent","scientific");function l(e,t){var o;return e.currency||t.currency||s.z(null!=(o=t.locale)?o:"en-US")}function a(e,t){const o=l(e,t),i=d(e.numMode,o);void 0!==e.decimals&&null!==e.decimals&&(i.minimumFractionDigits=(0,n.clamp)(Number(e.decimals),0,20));const s=new Intl.NumberFormat(t.locale,i).resolvedOptions();return void 0!==e.maxDecimals&&null!==e.maxDecimals?i.maximumFractionDigits=(0,n.clamp)(Number(e.maxDecimals),s.minimumFractionDigits||0,20):e.numMode||(i.maximumFractionDigits=(0,n.clamp)(10,s.minimumFractionDigits||0,20)),new Intl.NumberFormat(t.locale,i)}const c=function(){try{return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",currencyDisplay:"narrowSymbol"}),"narrowSymbol"}catch(e){return"symbol"}}();function d(e,t){switch(e){case"currency":return{style:"currency",currency:t,currencyDisplay:c};case"decimal":return{useGrouping:!0};case"percent":return{style:"percent"};case"scientific":return{notation:"scientific"};default:return{useGrouping:!1}}}},50590:(e,t,o)=>{"use strict";o.d(t,{Z:()=>a});var n=o(83277),i=o(99597);const s=o(41469),r=o(97322),l=class{static fromSettings(e,t={}){return new l(e.locale,(0,i.zC)(t,e))}constructor(e,t){var o;const n=new Map;for(const o of i.QS.values){const s=Intl.NumberFormat(e,(0,i.LX)(o,t)).formatToParts(-1234567.5678);n.set(o,s)}function l(e,t="decimal"){const o=n.get(t).find((t=>t.type===e));return(null==o?void 0:o.value)||""}this.currencySymbol=l("currency","currency"),this.percentageSymbol=l("percentSign","percent"),this.exponentSeparator=l("exponentSeparator","scientific"),this.minusSign=l("minusSign"),this.decimalSeparator=l("decimal"),this.digitGroupSeparator=l("group"),this.digitGroupSeparatorCurrency=l("group","currency"),this.currencyEndsInMinusSign="minusSign"===r(n.get("currency")).type,this.defaultNumDecimalsCurrency=(null==(o=l("fraction","currency"))?void 0:o.length)||0,this._exponentSeparatorRegex=new RegExp(s(this.exponentSeparator),"i"),this._digitGroupSeparatorRegex=new RegExp(`[${s(this.digitGroupSeparator+this.digitGroupSeparatorCurrency)}](\\d\\d)`,"g");const a=this.digitsMap=function(e){const t=Intl.NumberFormat(e),o=new Map;for(let e=0;e<10;e++){const n=String(e),i=t.format(e);i!==n&&o.set(i,n)}return o}(e);if(0===a.size)this._replaceDigits=e=>e;else{const e=new RegExp([...a.keys()].join("|"),"g");this._replaceDigits=t=>t.replace(e,(e=>a.get(e)||e))}}parse(e){const[t,o]=c(e,this.currencySymbol),[n,i]=c(t,this.percentageSymbol),s="("===(e=n.replace(l.removeCharsRegex,""))[0]&&")"===e[e.length-1];if(s&&(e=e.substring(1,e.length-1)),""===e)return null;const r=e!==(e=e.replace(this._exponentSeparatorRegex,"e")),a=(e=this._replaceDigits(e))!==(e=e.replace(this._digitGroupSeparatorRegex,"$1"));e=(e=(e=e.replace(this.decimalSeparator,".")).replace(this.minusSign,"-")).replace(this.minusSign,"-"),o&&this.currencyEndsInMinusSign&&e.endsWith("-")&&(e="-"+e.substring(0,e.length-1));let d=Number(e);if(isNaN(d))return null;if(s){if(d<=0)return null;d=-d}return i&&(d*=.01),{result:d,cleaned:e,options:{isCurrency:o,isPercent:i,isParenthesised:s,hasDigitGroupSeparator:a,isScientific:r}}}guessOptions(e){let t=null,o=!1,s=0;const r=/\.\d+/;let l=0;const a={};for(const e of i.QS.values)a[e]=0;for(const i of(0,n.getDistinctValues)(e)){if(!i)continue;const e=this.parse(i);if(!e)continue;const{result:n,cleaned:c,options:{isCurrency:d,isPercent:u,isParenthesised:p,hasDigitGroupSeparator:h,isScientific:m}}=e;n<0&&!p?t=!1:null===t&&p&&(t=!0),o=o||h;let f="decimal";d?f="currency":u?f="percent":m&&(f="scientific"),a[f]+=1;const g=r.exec(c);if(g){const e=g[0].length-1;l=Math.max(l,e),g[0].endsWith("0")&&(s=Math.max(s,e))}}const c=Math.max(...Object.values(a));if(0===c)return{};const d={},u=i.QS.values.find((e=>a[e]===c));return("decimal"!==u||o)&&(d.numMode=u),t&&(d.numSign="parens"),(s>0||"currency"===u&&l<this.defaultNumDecimalsCurrency)&&(d.decimals=s),d}};let a=l;function c(e,t){const o=e.replace(t,"");return[o,o.length<e.length]}a.removeCharsRegex=/[\s\u200e\u200f\u061c]/g},55688:(e,t,o)=>{"use strict";o.d(t,{$o:()=>c,GO:()=>a,H6:()=>s,dl:()=>r});var n=o(45353),i=o(87479);class s{constructor(e,t){this._logger=t,this._activated=!1;const o=e.components.deactivate,n=o&&o.inactivitySec?o.inactivitySec:300;this.inactivityTimer=new i.w((()=>this.deactivate()),1e3*n)}activated(){return this._activated}async activate(){this._logger.info&&this._logger.info("Activating plugin component"),await this.activateImplementation(),this._activated=!0,this.inactivityTimer.enable()}async deactivate(){if(this._activated){this._logger.info&&this._logger.info("Deactivating plugin component"),this._activated=!1,this.inactivityTimer.disable();try{await this.deactivateImplementation()}catch(e){this._logger.warn&&this._logger.warn(`Deactivate failed: ${e.message}`)}}}async forwardCall(e){return this._activated||await this.activate(),await this.inactivityTimer.disableUntilFinish(this.doForwardCall(e))}async forwardMessage(e){this._activated||await this.activate(),this.inactivityTimer.ping(),this.doForwardMessage(e)}}class r{constructor(e,t){this.definition=e,this._renderTargets=new Map,this._nextRenderTargetId=0;const o=this.rpc=new n.Rpc({logger:t});o.setSendMessage((e=>o.receiveMessage(e))),this._renderTargets.set("fullscreen",l)}getStub(e,t){const o=this.definition.manifest.components[e.component];return this.rpc.getStubForward(o,e.name,t)}async shutdown(){await Promise.all([this.safeBrowser&&this.safeBrowser.deactivate(),this.safePython&&this.safePython.deactivate(),this.unsafeNode&&this.unsafeNode.deactivate()])}addRenderTarget(e){const t=this._nextRenderTargetId++;return this._renderTargets.set(t,e),t}getRenderTarget(e,t){const o=this._renderTargets.get(e);if(!o)throw new Error(`Unknown render target ${e}`);return(e,n)=>o(e,n||t)}removeRenderTarget(e){return this._renderTargets.delete(e)}}function l(e){e.classList.add("plugin_instance_fullscreen"),document.body.appendChild(e)}function a(e,t){const o=e.debug||e.log,n=e.warn;return{warn:n&&(e=>n("%s %s",t,e)),info:o&&(e=>o("%s %s",t,e))}}function c(e,t,o){if(!e._logger.warn)return;const i=setTimeout((()=>e._logger.warn(o)),t),s=e._dispatch;e._dispatch=t=>{t.mtype===n.MsgType.Ready&&clearTimeout(i),s.call(e,t)}}},75083:(e,t,o)=>{"use strict";o.d(t,{CV:()=>a,QG:()=>h,ZW:()=>c,iv:()=>d,u7:()=>p,zr:()=>l});var n=o(32275),i=o(68652),s=o.n(i),r=o(88918);const l=[{quantity:0,unit:"day"}];function a(e){return!(0,n.isUndefined)(e)&&!(0,n.isNumber)(e)}function c(e){const t=(0,r.Z)().startOf("day"),o=s().utc(t.toObject()),n=Array.isArray(e)?e:[e];for(const e of n){const{quantity:t,unit:n,endOf:i}=e;o.add(t,n),i?(o.endOf(n),o.startOf("day")):o.startOf(n)}return Math.floor(o.valueOf()/1e3)}function d(e){var t;if(1===(e=(null==(t=e[1])?void 0:t.quantity)?e:[e[0]]).length){const{quantity:t,unit:o,endOf:n}=e[0];return"day"===o?0===t?"Today":-1===t?"Yesterday":1===t?"Tomorrow":u(e[0]):n?`Last day of ${u(e[0])}`:`1st day of ${u(e[0])}`}if(2===e.length){let t=e[1].quantity;e[0].endOf&&(t-=1);let o="";return"week"===e[0].unit&&(0===e[1].quantity?o="start ":6===e[1].quantity&&(o="end ")),`${function(e,t){if("week"===t)return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][(e+7)%7];const o=e=>s().localeData().ordinal(e);return e<0?-1===e?"Last day":`${o(-e)} to last day`:`${o(e+1)} day`}(t,e[0].unit)} ${o}of ${u(e[0])}`}throw new Error(`Relative date spec does not support more that 2 periods: ${e.length}`)}function u(e){const{quantity:t,unit:o}=e;if(0===t)return`this ${o}`;if(-1===t)return`last ${o}`;if(1===t)return`next ${o}`;const n=Math.abs(t);return`${n} ${o}${n>1?"s":""} ${t<1?"ago":"from now"}`}function p(e,t){e=Array.isArray(e)?e:[e],t=Array.isArray(t)?t:[t],2===e.length&&0===e[1].quantity&&(e=[e[0]]),2===t.length&&0===t[1].quantity&&(t=[t[0]]);const o=e.map((e=>(0,n.omitBy)(e,n.isUndefined))),i=t.map((e=>(0,n.omitBy)(e,n.isUndefined)));return(0,n.isEqual)(o,i)}function h(e,t,o){return e.clone().startOf(o).diff(t.clone().startOf(o),o)}},11579:(e,t,o)=>{"use strict";o.r(t),o.d(t,{SortFunc:()=>c,choiceGetter:()=>s,typedCompare:()=>a});var n=o(83277),i=o(48210);function s(e,t){return o=>{const n=e(o),i=t.indexOf(n);return i>=0?String(i).padStart(5,"0"):n}}const r=new Intl.Collator(void 0,{numeric:!0});function l(e,t){return"string"==typeof e&&"string"==typeof t?r.compare(e,t):a(e,t)}function a(e,t){let o,i,s;if(0!==(o=(0,n.nativeCompare)(i=typeof e,typeof t)))return o;if("object"===i){if(0!==(o=(0,n.nativeCompare)(s=e instanceof Array,t instanceof Array)))return o;if(s)return function(e,t){for(let o=0;o<e.length;o++){if(o>=t.length)return 1;const n=a(e[o],t[o]);if(n)return n}return e.length===t.length?0:-1}(e,t)}return"string"===i?(0,n.localeCompare)(e,t):(0,n.nativeCompare)(e,t)}class c{constructor(e){this._getters=e,this._colGetters=[],this._directions=[],this._comparators=[]}updateSpec(e){this._colGetters=e.map((e=>this._getters.getColGetter(e))).filter((e=>e)),this._directions=e.map((e=>i.Sort.direction(e))),this._comparators=e.map((e=>{const t=i.Sort.specToDetails(e);let o=a;var n;return t.naturalSort&&(o=l),t.emptyLast&&(n=o,o=(e,t)=>e||"number"==typeof e?t||"number"==typeof t?n(e,t):-1:1),o}));const t=this._getters.getManualSortGetter();t&&(this._colGetters.push(t),this._directions.push(1),this._comparators.push(a))}compare(e,t){for(let o=0,n=this._colGetters.length;o<n;o++){const n=this._colGetters[o],i=n(e),s=n(t),r=(0,this._comparators[o])(i,s);if(0!==r)return r*this._directions[o]}return(0,n.nativeCompare)(e,t)}}},48210:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Sort:()=>n});var n,i=Object.defineProperty,s=Object.defineProperties,r=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,d=(e,t,o)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,u=(e,t)=>{for(var o in t||(t={}))a.call(t,o)&&d(e,o,t[o]);if(l)for(var o of l(t))c.call(t,o)&&d(e,o,t[o]);return e},p=(e,t)=>s(e,r(t));(e=>{e.ASC=1,e.DESC=-1;const t=-1;function o(t){const o=`${t.direction===e.ASC?"":"-"}${t.colRef}`,n=[];return t.emptyLast&&n.push("emptyLast"),t.naturalSort&&n.push("naturalSort"),t.orderByChoice&&n.push("orderByChoice"),n.length?o+(n.length?":":"")+n.join(";"):+o}function n(t){return"number"==typeof t?{colRef:Math.abs(t),direction:t>=0?e.ASC:e.DESC}:i(t)}function i(t){const o=t.match(/^(-)?(\d+)(:([\w\d;]+))?$/);if(!o)throw new Error("Error parsing sort expression "+t);const[,n,i,,s]=o,r=null==s?void 0:s.split(";");return{colRef:+i,direction:"-"===n?e.DESC:e.ASC,orderByChoice:null==r?void 0:r.includes("orderByChoice"),emptyLast:null==r?void 0:r.includes("emptyLast"),naturalSort:null==r?void 0:r.includes("naturalSort")}}function s(e){return"number"==typeof e?Math.abs(e):i(e).colRef}function r(e,t){return"number"==typeof e?Math.abs(e)*t:o(p(u({},i(e)),{direction:t}))}function l(e,t,o){const n=m(e,t);return!!n&&s(n)===s(t)&&c(n)===o}function a(t){return"number"==typeof t?t>=0:i(t).direction===e.ASC}function c(t){return a(t)?e.ASC:e.DESC}function d(e,t){return s(e)===s(t)}function h(e,t){return e.findIndex((e=>d(e,t)))}function m(e,t){return e.find((e=>d(e,t)))}function f(t){if("number"==typeof t)return-t;const n=i(t);return o(p(u({},n),{direction:n.direction===e.ASC?e.DESC:e.ASC}))}e.hasOptions=function(e){if("number"==typeof e)return!1;const t="object"!=typeof e?n(e):e;return Boolean(t.emptyLast||t.naturalSort||t.orderByChoice)},e.detailsToSpec=o,e.specToDetails=n,e.getColRef=s,e.swap=function(e,o,n){const i=h(e,o),s=h(e,n);if(i===t||s===t)throw new Error(`Column expressions can be found (${o} or ${n})`);const r=e.slice();return r[i]=e[s],r[s]=e[i],r},e.setColDirection=r,e.createColSpec=function(e,t){return e*t},e.contains=l,e.containsOnly=function(e,t,o){return 1===e.length&&l(e,t,o)},e.isAscending=a,e.direction=c,e.sameColumn=d,e.swapColRef=function(e,t){if("number"==typeof e)return e>=0?t:-t;const n=i(e);return o(p(u({},n),{colRef:t}))},e.findColIndex=h,e.removeCol=function(e,t){return e.filter((e=>s(e)!==s(t)))},e.findCol=m,e.replace=function(e,t,n){const i=h(e,t);if(i>=0){const t=e.slice();return t[i]="object"==typeof n?o(n):n,t}return e},e.flipCol=f,e.flipSort=function(e,o){const n=h(e,s(o));if(n!==t){const t=Array.from(e);return t[n]=f(t[n]),t}return e},e.setSortDirection=function(e,o,n){const i=h(e,s(o));if(i!==t){const t=Array.from(e);return t[i]=r(t[i],n),t}return e},e.parseSortColRefs=function(e){try{return JSON.parse(e)}catch(e){return[]}},e.reorderSortRefs=function(e,o,n){const i=e.slice(),s=h(i,o);if(s===t)return e;i.splice(s,1);const r=n?h(i,n):i.length;return r===t?e:(i.splice(r,0,o),i)},e.parseNames=function(e,t){const o=/^(-)?([\w]+)(:.+)?/;return e.map((e=>{const n=e.match(o);if(!n)throw new Error(`unknown key ${e}`);const[,i,s,r]=n;let l=Number(s);if(isNaN(l)){if(!t.has(s))throw new Error(`unknown key ${s}`);l=t.get(s)}else if(![...t.values()].includes(l))throw new Error(`invalid column id ${s}`);return`${i||""}${l}${null!=r?r:""}`}))}})(n||(n={}))},11486:(e,t,o)=>{"use strict";o.d(t,{EF:()=>A,SP:()=>F,Ss:()=>C,cT:()=>w,ku:()=>O});var n=o(65552),i=o(631),s=o(83277),r=o(33444),l=o(99597),a=(o(48807),o(6263)),c=o(93965),d=o(68652),u=o.n(d),p=Object.defineProperty,h=Object.defineProperties,m=Object.getOwnPropertyDescriptors,f=Object.getOwnPropertySymbols,g=Object.prototype.hasOwnProperty,b=Object.prototype.propertyIsEnumerable,y=(e,t,o)=>t in e?p(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,v=(e,t)=>{for(var o in t||(t={}))g.call(t,o)&&y(e,o,t[o]);if(f)for(var o of f(t))b.call(t,o)&&y(e,o,t[o]);return e};const _=o(99451);function w(e){return C((0,c.xD)(e))}function x(e){return e.some((e=>"object"==typeof e&&e&&(Array.isArray(e)||_(e))))}function C(e,t=!0){if("object"==typeof e&&e){if(Array.isArray(e))return!t||x(e)?"["+e.map((e=>C(e,!1))).join(", ")+"]":(0,n.cw)(e.map((e=>C(e,!0))),{prettier:!0});if(_(e)){const t=e;return"{"+Object.keys(t).map((e=>`${JSON.stringify(e)}: ${C(t[e],!1)}`)).join(", ")+"}"}return t&&e instanceof c.wc?u()(e).tz(e.timezone).format("YYYY-MM-DD HH:mm:ssZ"):String(e)}return t?null==e?"":String(e):JSON.stringify(e)}class D{constructor(e,t,o){this.type=e,this.widgetOpts=t,this.docSettings=o,this.isRightType=i.isRightType(i.extractTypeFromColType(e))||i.isRightType("Any")}formatAny(e,t){return this.isRightType(e)?this.format(e,t):w(e)}format(e,t){return String(e)}}class k extends D{format(e){return w(e)}}class S extends D{constructor(e,t,o){super(e,t,o),this._numFormat=(0,l.y6)(t,o),this._formatter="parens"===t.numSign?this._formatParens:this._formatPlain}format(e){return null===e?"":this._formatter(e)}_formatPlain(e){return this._numFormat.format(e)}_formatParens(e){return e>=0?` ${this._numFormat.format(e)} `:`(${this._numFormat.format(-e)})`}}class I extends D{constructor(e,t,o,n="UTC"){super(e,t,o),this.isRightType=e=>null===e||"number"==typeof e||Array.isArray(e)&&(e[0]===a.w.Date||e[0]===a.w.DateTime),this._dateTimeFormat=t.dateFormat||"YYYY-MM-DD",this._timezone=n}format(e){if(null===e)return"";let t=this._timezone;return Array.isArray(e)&&(t=e[2]||t,e=e[1]),u().tz(1e3*e,t).format(this._dateTimeFormat)}}class T extends D{constructor(e,t,o){super(e,t,o),this.visibleColFormatter=t.visibleColFormatter||F("Id",{tableId:(0,i.getReferencedTableId)(e)},o)}formatAny(e){var t,o;return Array.isArray(e)&&e[0]===a.w.Exception&&"InvalidTypedValue"===e[1]&&(null==(o=null==(t=e[2])?void 0:t.startsWith)?void 0:o.call(t,"Ref"))?e[3]:this.formatNotInvalidRef(e)}formatNotInvalidRef(e){return this.visibleColFormatter.formatAny(e)}}const R={Numeric:S,Int:class extends S{constructor(e,t,o){super(e,v({decimals:0},t),o)}},Bool:class extends D{format(e,t){return"boolean"==typeof e&&t?t(String(e)):super.format(e,t)}},Date:I,DateTime:class extends I{constructor(e,t,o){const n=s.removePrefix(e,"DateTime:")||"",i=void 0===t.timeFormat?"h:mma":t.timeFormat;super(e,{dateFormat:(t.dateFormat||"YYYY-MM-DD")+" "+i},o,n)}},Ref:T,RefList:class extends T{formatNotInvalidRef(e){if(!(0,i.isList)(e)||x((0,c.xD)(e)))return w(e);const t=e.slice(1).map((e=>super.formatNotInvalidRef(e)));return(0,n.cw)(t,{prettier:!0})}},Id:class extends D{format(e){return e>0?`${this.widgetOpts.tableId}[${e}]`:""}}};function F(e,t,o){return new(R[i.extractTypeFromColType(e)]||k)(e,t,o)}function A(e){const{type:t,widgetOpts:o,docSettings:n}=e,i=O(e);return F(t,(s=v({},o),h(s,m({visibleColFormatter:i}))),n);var s}function O({docData:e,docSettings:t,type:o,visibleColType:n,visibleColWidgetOpts:s,widgetOpts:l}){let a=i.getReferencedTableId(o);if(a){if(n)return F(n,s,t);{const o=e.getMetaTable("_grist_Tables"),n=o.findRow("tableId",a);return(0,r.Pr)(o,n)&&(a=""),F("Id",{tableId:a},t)}}return F(o,l,t)}},48807:(e,t,o)=>{"use strict";o.d(t,{jo:()=>k});var n=o(65552),i=o(631),s=o(83277),r=o(50590),l=o(62862),a=o(11486),c=o(93965),d=Object.defineProperty,u=Object.defineProperties,p=Object.getOwnPropertyDescriptors,h=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,g=(e,t,o)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const b=o(16914);o(87604);class y{constructor(e,t,o){this.type=e,this.widgetOpts=t,this.docSettings=o}cleanParse(e){var t;return e&&null!=(t=this.parse(e))?t:e}parse(e){return e}}class v extends y{}class _ extends y{constructor(e,t,o){super(e,t,o),this._parse=r.Z.fromSettings(o,t)}parse(e){var t,o;return null!=(o=null==(t=this._parse.parse(e))?void 0:t.result)?o:null}}class w extends y{constructor(){super(...arguments),this.tableData=this.widgetOpts.tableData,this.visibleColParser=D(this.widgetOpts.visibleColType,this.widgetOpts.visibleColWidgetOpts,this.docSettings),this._visibleColId=this.widgetOpts.visibleColId}parse(e){const t=this.visibleColParser.cleanParse(e);return this.lookup(t,e)}lookup(e,t){var o;if(null==e||""===e||!t)return 0;if("id"===this._visibleColId){const o=Number(e);if(!Number.isInteger(o))return t;e=o}if(!(null==(o=this.tableData)?void 0:o.isLoaded)){const o={column:this._visibleColId};return e!==t&&(o.raw=t),["l",e,o]}return this.tableData.findMatchingRowId({[this._visibleColId]:e})||t}}class x extends w{parse(e){var t;let o;try{o=JSON.parse(e)}catch(e){o=null}if(Array.isArray(o)||(o=(0,n._0)(e)),o=o.map((e=>"string"==typeof e?this.visibleColParser.cleanParse(e):(0,c.Cx)(e))),!o.length||!e)return null;if("id"===this._visibleColId){const t=o.map(Number);if(!t.every(Number.isInteger))return e;o=t}if(!(null==(t=this.tableData)?void 0:t.isLoaded)){const t={column:this._visibleColId};return 1===o.length&&o[0]===e||(t.raw=e),["l",o,t]}const i=[];for(const t of o){const o=this.tableData.findMatchingRowId({[this._visibleColId]:t});if(!o)return e;i.push(o)}return["L",...i]}}const C={Numeric:_,Int:_,Date:class extends y{parse(e){return(0,l.parseDateStrict)(e,this.widgetOpts.dateFormat)}},DateTime:class extends y{constructor(e,t,o){super(e,t,o);const n=s.removePrefix(e,"DateTime:")||"";var i;this.widgetOpts=(i=((e,t)=>{for(var o in t||(t={}))m.call(t,o)&&g(e,o,t[o]);if(h)for(var o of h(t))f.call(t,o)&&g(e,o,t[o]);return e})({},t),u(i,p({timezone:n})))}parse(e){return(0,l.parseDateTime)(e,this.widgetOpts)}},ChoiceList:class extends y{cleanParse(e){e=e.trim();const t=(this._parseJson(e)||this._parseCsv(e)).map((e=>e.trim())).filter((e=>e));return t.length?["L",...t]:null}_parseJson(e){if("["===e[0]){const t=(0,s.safeJsonParse)(e,null);return null==t?void 0:t.filter((e=>e||0===e)).map((e=>(0,a.Ss)(e)))}}_parseCsv(e){return b(e.split(/[\n\r]+/),(e=>(0,n._0)(e).map((e=>e.trim()))))}},Ref:w,RefList:x,Attachments:x};function D(e,t,o){return new(C[i.extractTypeFromColType(e)]||v)(e,t,o)}function k(e,t,o){return D(...function(e,t,o){const n=e.getMetaTable("_grist_Tables_column"),r=e.getMetaTable("_grist_Views_section_field"),l=n.getRecord(t);let a=l;return o&&(a=r.getRecord(o)||l),function(e,t,o,n){const r=e.getMetaTable("_grist_Tables_column"),l=(0,s.safeJsonParse)(o,{});if((0,i.isFullReferencingType)(t)){const o=r.getRecord(n);l.visibleColId=(null==o?void 0:o.colId)||"id",l.visibleColType=null==o?void 0:o.type,l.visibleColWidgetOpts=(0,s.safeJsonParse)((null==o?void 0:o.widgetOptions)||"",{}),l.tableData=e.getTable((0,i.getReferencedTableId)(t))}return[t,l,e.docSettings()]}(e,l.type,a.widgetOptions,a.visibleCol)}(e,t,o))}},65552:(e,t,o)=>{"use strict";function n(e,t={}){return e.map(s).join(t.prettier?", ":",")}function i(e){const t=e.split(/((?:(?:"[^"]*")|[^,])*)/),o=t.filter(((e,t)=>t%2)).map(r);return t[0]&&o.unshift(""),t[t.length-1]&&o.push(""),o}function s(e){return/[,\r\n"]|^\s|\s$/.test(e)?'"'+e.replace(/"/g,'""')+'"':e}function r(e){return e.trim().replace(/^"|"$/g,"").replace(/""/g,'"')}o.d(t,{_0:()=>i,cw:()=>n})},88918:(e,t,o)=>{"use strict";o.d(t,{Z:()=>s});var n=o(68652),i=o.n(n);function s(){const e=()=>i()();if("undefined"==typeof window||!window)return e();const t=new URLSearchParams(window.location.search);return t.has("currentTime")?i()(t.get("currentTime")||void 0):e()}},631:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CellInfoType:()=>N,MANUALSORT:()=>r,RecalcWhen:()=>F,extractInfoFromColType:()=>d,extractTypeFromColType:()=>R,getDefaultForType:()=>c,getObjCode:()=>h,getReferencedTableId:()=>O,isCensored:()=>b,isDateLikeType:()=>B,isEmptyList:()=>C,isFullReferencingType:()=>$,isHiddenCol:()=>l,isList:()=>y,isListOrNull:()=>x,isListType:()=>M,isNumberType:()=>P,isObject:()=>p,isRaisedException:()=>m,isRefListType:()=>E,isReference:()=>v,isReferenceList:()=>_,isReferencing:()=>w,isRightType:()=>T,isSkip:()=>g,isValidRuleValue:()=>L,isVersions:()=>f,reencodeAsAny:()=>u,sequelizeToGristType:()=>A});var n=o(6263),i=o(83277);const s=o(18882),r="manualSort";function l(e){return e.startsWith("gristHelper_")||e===r}const a={Any:[null,"NULL"],Attachments:[null,"NULL"],Blob:[null,"NULL"],Bool:[!1,"0"],Choice:["","''"],ChoiceList:[null,"NULL"],Date:[null,"NULL"],DateTime:[null,"NULL"],Id:[0,"0"],Int:[0,"0"],ManualSortPos:[Number.POSITIVE_INFINITY,"1e999"],Numeric:[0,"0"],PositionNumber:[Number.POSITIVE_INFINITY,"1e999"],Ref:[0,"0"],RefList:[null,"NULL"],Text:["","''"]};function c(e,t={}){const o=R(e);return(a[o]||a.Any)[t.sqlFormatted?1:0]}function d(e){if("Attachments"===e)return{type:"RefList",tableId:"_grist_Attachments"};const t=e.indexOf(":"),[o,n]=-1===t?[e]:[e.slice(0,t),e.slice(t+1)];return"Ref"===o||"RefList"===o?{type:o,tableId:String(n)}:"DateTime"===o?{type:o,timezone:String(n)}:{type:o}}function u(e,t){if("number"==typeof e)switch(t.type){case"Date":return[n.w.Date,e];case"DateTime":return[n.w.DateTime,e,t.timezone];case"Ref":return[n.w.Reference,t.tableId,e]}return e}function p(e){return Array.isArray(e)}function h(e){return Array.isArray(e)?e[0]:null}function m(e){return h(e)===n.w.Exception}function f(e){return h(e)===n.w.Versions}function g(e){return h(e)===n.w.Skip}function b(e){return h(e)===n.w.Censored}function y(e){return Array.isArray(e)&&e[0]===n.w.List}function v(e){return Array.isArray(e)&&e[0]===n.w.Reference}function _(e){return Array.isArray(e)&&e[0]===n.w.ReferenceList}function w(e){return Array.isArray(e)&&(e[0]===n.w.ReferenceList||e[0]===n.w.Reference)}function x(e){return null===e||y(e)}function C(e){return Array.isArray(e)&&1===e.length&&e[0]===n.w.List}function D(e){return"number"==typeof e||"boolean"==typeof e}function k(e){return D(e)||null===e}const S=[n.w.Exception,n.w.Pending,n.w.Skip,n.w.Unmarshallable,n.w.Versions],I={Any:function(e){return!S.includes(h(e))},Attachments:x,Text:s,Blob:s,Int:k,Bool:function(e){return"boolean"==typeof e||1===e||0===e},Date:k,DateTime:k,Numeric:k,Id:D,PositionNumber:D,ManualSortPos:D,Ref:D,RefList:x,Choice:s,ChoiceList:x};function T(e){return I[e]}function R(e){if(!e)return e;const t=e.indexOf(":");return-1===t?e:e.slice(0,t)}var F=(e=>(e[e.DEFAULT=0]="DEFAULT",e[e.NEVER=1]="NEVER",e[e.MANUAL_UPDATES=2]="MANUAL_UPDATES",e))(F||{});function A(e){let t=e.length;const o=e.indexOf("(");t=o>0?o:t;const n=e.indexOf(" ");switch(t=n>0&&n<t?n:t,e.substring(0,t)){case"INTEGER":case"BIGINT":case"SMALLINT":case"INT":return"Int";case"NUMBER":case"FLOAT":case"DECIMAL":case"NUMERIC":case"REAL":case"DOUBLE":case"DOUBLE PRECISION":return"Numeric";case"BOOLEAN":case"TINYINT":return"Bool";case"STRING":case"CHAR":case"TEXT":case"UUID":case"UUIDV1":case"UUIDV4":case"VARCHAR":case"NVARCHAR":case"TINYTEXT":case"MEDIUMTEXT":case"LONGTEXT":case"ENUM":case"TIME":case"DATE":case"DATEONLY":case"DATETIME":case"NOW":return"Text";case"BLOB":case"TINYBLOB":case"MEDIUMBLOB":case"LONGBLOB":throw new Error("SQL type: `"+e+"` is currently unsupported");case"NONE":case"HSTORE":case"JSON":case"JSONB":case"VIRTUAL":case"ARRAY":case"RANGE":case"GEOMETRY":throw new Error("SQL type: `"+e+"` is currently untested");default:throw new Error("Unrecognized datatype: `"+e+"`")}}function O(e){return"Attachments"===e?"_grist_Attachments":(0,i.removePrefix)(e,"Ref:")||(0,i.removePrefix)(e,"RefList:")}function E(e){return"Attachments"===e||(null==e?void 0:e.startsWith("RefList:"))}function M(e){return"ChoiceList"===e||E(e)}function P(e){return["Numeric","Int"].includes(e||"")}function B(e){return"Date"===e||e.startsWith("DateTime")}function $(e){return e.startsWith("Ref:")||E(e)}function L(e){return null===e||"boolean"==typeof e}var N=(e=>(e[e.COMMENT=1]="COMMENT",e))(N||{})},33444:(e,t,o)=>{"use strict";function n(e,t){const o=e.getValue(t,"tableId");return!o||i(e,t)||o.startsWith("GristHidden_")}function i(e,t){return 0!==e.getValue(t,"summarySourceTable")}o.d(t,{$U:()=>i,Pr:()=>n})},62862:(e,t,o)=>{"use strict";o.r(t),o.d(t,{TWO_DIGIT_YEAR_THRESHOLD:()=>u,dateFormatOptions:()=>T,dateTimeWidgetOptions:()=>F,guessDateFormat:()=>S,guessDateFormats:()=>I,parseDate:()=>_,parseDateStrict:()=>w,parseDateTime:()=>x,timeFormatOptions:()=>R});var n=o(83277),i=o(76466),s=o.n(i),r=o(68652),l=o.n(r);const a=o(41469),c=o(97322),d=o(28082),u=10,p=(new Date).getFullYear()+u-2e3;l().parseTwoDigitYear=function(e){const t=parseInt(e,10);return t+(t>p?1900:2e3)};const h=["M D YYYY","M D YY","M D","M","MMMM D YYYY","MMMM D","MMMM Do YYYY","MMMM Do","D MMMM YYYY","D MMMM","Do MMMM YYYY","Do MMMM","MMMM","MMM D YYYY","MMM D","MMM Do YYYY","MMM Do","D MMM YYYY","D MMM","Do MMM YYYY","Do MMM","MMM","YYYY M D","YYYY M","YYYY","D M YYYY","D M YY","D M","D"],m=["YYYY M D",...h.filter((e=>e.includes("MMM")))],f=/(?:^|\s+|T)(?:(\d\d?)(?::(\d\d?)(?::(\d\d?))?)?|(\d\d?)(\d\d))\s*([ap]m?)?$/i,g=/[^a-zA-Z](UTC?|GMT|Z)$/i,b=/([+-]\d\d?)(?::?(\d\d))?$/i,y=/[\W_]+/g,v=d((e=>{const t=[...new Set(l().tz.zone(e).abbrs.map(a))].join("|");return new RegExp(`[^a-zA-Z](${t})$`,"i")}));function _(e,t={}){if(!e)return null;const o=[...C(t.dateFormat||"YYYY-MM-DD",e),...h];let n=e.replace(y," ").trim(),i="",s=t.time;if(s){const e=D(s,t.timezone),o=k(e.remaining);if(!o||o.remaining)return null;s=o.time;const{tzOffset:r}=e;n+=" "+s+r,i=" HH:mm:ss"+(r?"Z":"")}for(const e of o){const o=e+i,s=l().tz(n,o,!0,t.timezone||"UTC");if(s.isValid())return s.valueOf()/1e3}return null}function w(e,t,o,n="UTC"){if(!e)return;const i=[...C(t=t||"YYYY-MM-DD",e),...m],s=e.replace(y," ").trim();for(const e of i){const t=l().tz(s,e,!0,n);if(t.isValid()){const e=t.valueOf()/1e3;if(!o)return e;o.add(e)}}}function x(e,t){if(!(e=e.trim()))return;const o=t.dateFormat||"YYYY-MM-DD",n=t.timezone||"UTC",i=w(e,o,void 0,n);if(i)return i;const s=D(e,n);let r="";s&&(r=s.tzOffset,e=s.remaining);const a=k(e);if(!a)return;const c=w(e=a.remaining,o);if(!c)return;e=l().unix(c).utc().format("YYYY-MM-DD")+" "+a.time+r;const d="YYYY-MM-DD HH:mm:ss"+(r?"Z":"");return l().tz(e,d,!0,n).valueOf()/1e3}function C(e,t){let o=e.replace(/MM+/g,(e=>"MM"===e?"M":e)).replace(/DD+/g,(e=>"DD"===e?"D":e)).replace(y," ").trim();o.includes("M")&&o.includes("D")&&!o.includes("Y")&&(o+=" YYYY"),o=function(e,t){var o,n;const i=/Y+|M+o?|D+o?|[a-zA-Z0-9]+/gi,s=(null==(o=e.match(i))?void 0:o.length)||0;let r=(null==(n=t.match(i))?void 0:n.length)||0;return r>s&&(/Y+/.test(t)&&(t=t.replace(/Y+/," ").trim(),r-=1),r>s&&(t=t.replace(/M+/," ").trim())),t}(t,o);const n=new Set([o]),i=o.replace(/Y{2,4}/,(e=>"YY"===e?"YYYY":"YYYY"===e?"YY":e));return n.add(i),n.add(o.replace(/MMM+/,"M")),i!==o&&n.add(i.replace(/MMM+/,"M")),n}function D(e,t){e=e.trim();let o=g.exec(e),n=0,i="";return o?(i="+00:00",n=o.index+1):(o=b.exec(e),o?(i=function(e){const[,t,o]=e;return t.slice(0,1)+t.slice(1).padStart(2,"0")+":"+(o||"0").padStart(2,"0")}(o),n=o.index):t&&(o=v(t).exec(e),o&&(n=o.index+1))),o&&(e=e.slice(0,n).trim()),{remaining:e,tzOffset:i}}function k(e){const t=f.exec(e);if(!t)return;let o=parseInt(t[1]||t[4],10);const n=(t[2]||t[5]||"0").padStart(2,"0"),i=(t[3]||"0").padStart(2,"0"),s=(t[6]||"").toLowerCase();o<12&&o>0&&s.startsWith("p")?o+=12:12===o&&s.startsWith("a")&&(o=0);const r=String(o).padStart(2,"0");return{remaining:e.slice(0,t.index).trim(),time:`${r}:${n}:${i}`}}function S(e,t="UTC"){const o=I(e,t);return o?c(o):"YYYY-MM-DD"}function I(e,t="UTC"){const o=e.filter(n.isNonNullish),i=(0,n.getDistinctValues)(o,100),r={};for(const e of i){let t;try{t=s()(e)}catch(e){continue}"string"==typeof t&&(t=[t]);for(const e of t)r[e]=0}const a=Object.keys(r);if(!a.length||a.length>10)return null;for(const e of a)for(const n of o)l().tz(n,e,!0,t).isValid()&&(r[e]+=1);const c=Math.max(...Object.values(r));return a.filter((e=>r[e]===c)).sort()}const T=["YYYY-MM-DD","MM-DD-YYYY","MM/DD/YYYY","MM-DD-YY","MM/DD/YY","DD MMM YYYY","MMMM Do, YYYY","DD-MM-YYYY"],R=["h:mma","h:mma z","HH:mm","HH:mm z","HH:mm:ss","HH:mm:ss z"];function F(e,t){const o=e.match(/[hHkaAmsSzZT]|$/).index,n=e.substr(0,o).trim(),i=e.substr(o).trim()||(t?R[0]:"");return{dateFormat:n,timeFormat:i,isCustomDateFormat:!T.includes(n),isCustomTimeFormat:!R.includes(i)}}},79801:(e,t,o)=>{"use strict";function n(e){return e.map((e=>e.map((e=>function(e){const t="string"==typeof e?e:null==e?"":String(e);return t.includes("\t")||t.includes("\n")?'"'+t.replace(/"/g,'""')+'"':t}(e))).join("\t"))).join("\n")}function i(e){const t=[];let o=[];const n=/(("([^"]*"")*[^"]*"(?!"))?[^\t\n]*)(\t|\n|$)/g;for(;;){const i=n.exec(e);if(!i)break;const s=i[4];let r=i[1];if(r.startsWith('"')&&(r=r.replace(/"([^"]*"")*[^"]*"(?!")/,(e=>e.slice(1,-1).replace(/""/g,'"')))),o.push(r),"\t"!==s&&(t.push(o),o=[],""===s))break}return t}o.r(t),o.d(t,{tsvDecode:()=>i,tsvEncode:()=>n})},6263:(e,t,o)=>{"use strict";o.d(t,{w:()=>n});var n=(e=>(e.List="L",e.LookUp="l",e.Dict="O",e.DateTime="D",e.Date="d",e.Skip="S",e.Censored="C",e.Reference="R",e.ReferenceList="r",e.Exception="E",e.Pending="P",e.Unmarshallable="U",e.Versions="V",e))(n||{})},18975:(e,t,o)=>{"use strict";o.d(t,{C4:()=>s});var n=o(77143);const i=[{ColumnToMap:n.iface([],{name:"string",title:n.opt(n.union("string","null")),description:n.opt(n.union("string","null")),type:n.opt("string"),optional:n.opt("boolean"),allowMultiple:n.opt("boolean")}),ColumnsToMap:n.array(n.union("string","ColumnToMap")),InteractionOptionsRequest:n.iface([],{requiredAccess:n.opt("string"),hasCustomOptions:n.opt("boolean"),columns:n.opt("ColumnsToMap")}),InteractionOptions:n.iface([],{accessLevel:"string"}),WidgetColumnMap:n.iface([],{[n.indexKey]:n.union("string",n.array("string"),"null")}),CustomSectionAPI:n.iface([],{configure:n.func("void",n.param("customOptions","InteractionOptionsRequest")),mappings:n.func(n.union("WidgetColumnMap","null"))})},{EditOptionsAPI:n.iface([],{getParseOptions:n.func("ParseOptions",n.param("parseOptions","ParseOptions",!0))}),ParseFileAPI:n.iface([],{parseFile:n.func("ParseFileResult",n.param("file","FileSource"),n.param("parseOptions","ParseOptions",!0))}),ParseOptions:n.iface([],{NUM_ROWS:n.opt("number"),SCHEMA:n.opt(n.array("ParseOptionSchema"))}),ParseOptionSchema:n.iface([],{name:"string",label:"string",type:"string",visible:"boolean"}),FileSource:n.iface([],{path:"string",origName:"string"}),ParseFileResult:n.iface(["GristTables"],{parseOptions:"ParseOptions"})},{ComponentKind:n.union(n.lit("safeBrowser"),n.lit("safePython"),n.lit("unsafeNode")),GristAPI:n.iface([],{render:n.func("number",n.param("path","string"),n.param("target","RenderTarget"),n.param("options","RenderOptions",!0)),dispose:n.func("void",n.param("procId","number")),subscribe:n.func("void",n.param("tableId","string")),unsubscribe:n.func("void",n.param("tableId","string"))}),GristDocAPI:n.iface([],{getDocName:n.func("string"),listTables:n.func(n.array("string")),fetchTable:n.func("any",n.param("tableId","string")),applyUserActions:n.func("any",n.param("actions",n.array(n.array("any"))),n.param("options","any",!0)),getAccessToken:n.func("AccessTokenResult",n.param("options","AccessTokenOptions"))}),GristView:n.iface([],{fetchSelectedTable:n.func("any"),fetchSelectedRecord:n.func("any",n.param("rowId","number")),allowSelectBy:n.func("void"),setSelectedRows:n.func("void",n.param("rowIds",n.array("number")))}),AccessTokenOptions:n.iface([],{readOnly:n.opt("boolean")}),AccessTokenResult:n.iface([],{token:"string",baseUrl:"string",ttlMsecs:"number"})},{GristTable:n.iface([],{table_name:n.union("string","null"),column_metadata:n.array("GristColumn"),table_data:n.array(n.array("any"))}),GristTables:n.iface([],{tables:n.array("GristTable")}),GristColumn:n.iface([],{id:"string",type:"string"}),APIType:n.enumtype({ImportSourceAPI:0,ImportProcessorAPI:1,ParseOptionsAPI:2,ParseFileAPI:3})},{ImportSourceAPI:n.iface([],{getImportSource:n.func(n.union("ImportSource","undefined"))}),ImportProcessorAPI:n.iface([],{processImport:n.func(n.array("GristTable"),n.param("source","ImportSource"))}),FileContent:n.iface([],{content:"any",name:"string"}),FileListItem:n.iface([],{kind:n.lit("fileList"),files:n.array("FileContent")}),URL:n.iface([],{kind:n.lit("url"),url:"string"}),ImportSource:n.iface([],{item:n.union("FileListItem","URL"),options:n.opt(n.union("string","Buffer")),description:n.opt("string")})},{InternalImportSourceAPI:n.iface([],{getImportSource:n.func(n.union("ImportSource","undefined"),n.param("inlineTarget","RenderTarget"))})},{RenderTarget:n.union(n.lit("fullscreen"),"number"),RenderOptions:n.iface([],{height:n.opt("string")})},{Storage:n.iface([],{getItem:n.func("any",n.param("key","string")),hasItem:n.func("boolean",n.param("key","string")),setItem:n.func("void",n.param("key","string"),n.param("value","any")),removeItem:n.func("void",n.param("key","string")),clear:n.func("void")})},{WidgetAPI:n.iface([],{getOptions:n.func(n.union("object","null")),setOptions:n.func("void",n.param("options",n.iface([],{[n.indexKey]:"any"}))),clearOptions:n.func("void"),setOption:n.func("void",n.param("key","string"),n.param("value","any")),getOption:n.func("any",n.param("key","string"))})}];void 0===o(13039).Buffer&&i.push({Buffer:new n.BasicType((e=>!1),"Buffer is not supported")}),function(e){const t=new Set;for(const o of e)for(const e of Object.keys(o)){if(t.has(e))throw new Error(`TypeCheckers: Duplicate type name ${e}`);t.add(e)}}(i);const s=(0,n.createCheckers)(...i)},93965:(e,t,o)=>{"use strict";o.d(t,{Cx:()=>m,es:()=>c,wc:()=>r,xD:()=>f});var n=o(6263);const i=o(99451);class s extends Date{static fromGristValue(e){return new s(1e3*e)}toString(){return this.toISOString().slice(0,10)}}class r extends Date{static fromGristValue(e,t){return Object.assign(new r(1e3*e),{timezone:t})}toString(){return this.toISOString()}}class l{constructor(e,t){this.tableId=e,this.rowId=t}toString(){return`${this.tableId}[${this.rowId}]`}}class a{constructor(e,t){this.tableId=e,this.rowIds=t}toString(){return`${this.tableId}[[${this.rowIds}]]`}}class c{constructor(e){var t;if(!e.length)throw new Error("RaisedException requires a name as first element");e=[...e],this.name=e.shift(),this.message=e.shift(),this.details=e.shift(),this.user_input=null==(t=e.shift())?void 0:t.u}toString(){switch(this.name){case"ZeroDivisionError":return"#DIV/0!";case"UnmarshallableError":return this.details||"#"+this.name;case"InvalidTypedValue":return`#Invalid ${this.message}: ${this.details}`}return"#"+this.name}}class d{constructor(e){this.value=e}static safeRepr(e){try{return String(e)}catch(t){return`<${typeof e}>`}}toString(){return String(this.value)}}class u{toString(){return"Loading..."}}class p{toString(){return"..."}}class h{toString(){return"CENSORED"}}function m(e){try{switch(typeof e){case"string":case"number":case"boolean":return e}if(null==e)return null;if(e instanceof l)return[n.w.Reference,e.tableId,e.rowId];if(e instanceof a)return[n.w.ReferenceList,e.tableId,e.rowIds];if(e instanceof Date){const t=e.valueOf()/1e3;return"timezone"in e?[n.w.DateTime,t,e.timezone]:[n.w.DateTime,t,"UTC"]}if(e instanceof h)return[n.w.Censored];if(e instanceof c)return[n.w.Exception,e.name,e.message,e.details];if(Array.isArray(e))return[n.w.List,...e.map(m)];if(i(e))return[n.w.Dict,g(e,m,{sort:!0})]}catch(e){}return[n.w.Unmarshallable,d.safeRepr(e)]}function f(e){if(!Array.isArray(e))return e;const t=e[0],o=e.slice(1);let n;try{switch(t){case"D":return r.fromGristValue(o[0],String(o[1]));case"d":return s.fromGristValue(o[0]);case"E":return new c(o);case"L":return o.map(f);case"O":return g(o[0],f,{sort:!0});case"P":return new u;case"r":return new a(String(o[0]),o[1]);case"R":return new l(String(o[0]),o[1]);case"S":return new p;case"C":return new h;case"U":return new d(o[0])}}catch(e){n=e}return new d(`${t}(${JSON.stringify(o).slice(1,-1)})`+(n?`#${n.name}(${n.message})`:""))}function g(e,t,o={}){const n={},i=Object.keys(e);o.sort&&i.sort();for(const o of i)n[o]=t(e[o]);return n}},87056:(e,t,o)=>{var n=o(30835),i=o(77949);o(76832),o(17832),o(37e3),o(43488);var{setupAceEditorCompletions:s}=o(50489),{getGristConfig:r}=o(36322),l=o(81294),a=o(88438),c=o(32529);function d(e){e=e||{},this.observable=e.observable||null,this.saveValueOnBlurEvent=!(!1===e.saveValueOnBlurEvent),this.calcSize=e.calcSize||((e,t)=>t),this.gristDoc=e.gristDoc||null,this.column=e.column||null,this.editorState=e.editorState||null,this._readonly=e.readonly||!1,this.editor=null,this.editorDom=null,this.session=null,this._setupCallback=null,this._setupTimer=null,this.textPadding=10}a.makeDisposable(d),d.prototype.buildDom=function(e){return this._fullDom=l("div.code_editor_container",this.editorDom=l("div")),this._setupCallback=e,this._setupTimer=setTimeout((()=>this._setup()),0),this._fullDom},d.prototype.onAttach=function(){this._setupTimer&&(clearTimeout(this._setupTimer),this._setupTimer=null,this._setup())},d.prototype.writeObservable=function(){this.observable&&c.setSaveValue(this.observable,this.getValue())},d.prototype.getEditor=function(){return this.editor},d.prototype.getValue=function(){return this.editor&&this.editor.getValue()},d.prototype.setValue=function(e,t){if(this.editor.setValue(e,0===t?-1:1),t>0&&t<e.length){var o=this.session.getDocument().indexToPosition(t);this.editor.moveCursorTo(o.row,o.column)}},d.prototype.isBuilt=function(){return null!==this.editor},d.prototype.enable=function(e){var t=this.editor;t.setReadOnly(!e),t.renderer.$cursorLayer.element.style.opacity=e?100:0,t.gotoLine(1/0,1/0)},d.prototype.attachCommandGroup=function(e){i.each(e.knownKeys,((t,o)=>{this.editor.commands.addCommand({name:t,readOnly:this._readonly,bindKey:{win:o,mac:o,sender:"editor|cli"},exec:()=>!e.commands[t]()})}))},d.prototype.attachSaveCommand=function(){if(!this.observable)throw new Error("Cannot attach save command to editor with no bound observable");var e="Shift+Enter";this.editor.commands.addCommand({name:"saveFormula",bindKey:{win:e,mac:e,sender:"editor|cli"},exec:()=>(this.writeObservable(),!0)})},d.prototype.adjustContentToWidth=function(){var e=this.editor.renderer.characterWidth,t=this.editor.renderer.scroller.clientWidth;t>0&&this.editor.getSession().setWrapLimit(parseInt(t/e,10)-1)},d.prototype.onChange=function(){this.editorState&&this.editorState.set(this.getValue()),this.resize()},d.prototype.setFontSize=function(e){this.editor.setFontSize(e),this.resize()},d.prototype._setup=function(){var e;if(this.editor=this.autoDisposeWith("destroy",n.edit(this.editorDom)),this.gristDoc&&this.column){const e=e=>{const t=this.gristDoc.viewModel.activeSection(),o=t.table().tableId(),n=this.column.colId(),i=t.activeRowId();return this.gristDoc.docComm.autocomplete(e,o,n,i)};s(this.editor,{getSuggestions:e})}this.editor.setOptions({enableLiveAutocompletion:!0}),this.session=this.editor.getSession(),this.session.setMode("ace/mode/python");const t=null==(e=this.gristDoc)?void 0:e.docPageModel.appModel.currentTheme;if(this._setAceTheme(null==t?void 0:t.get()),!r().enableCustomCss&&t&&this.autoDispose(t.addListener((e=>{this._setAceTheme(e)}))),this.editor.renderer.setShowGutter(!1),this.session.setTabSize(2),this.session.setUseWrapMode(!0),this.editor.on("change",this.onChange.bind(this)),this.editor.$blockScrolling=1/0,this.editor.setFontSize(11),this.resize(),this.observable){var o=this.observable.subscribeInit((e=>{void 0!==e&&this.setValue(e)}));l(this.editorDom,l.autoDispose(o)),this.saveValueOnBlurEvent&&this.editor.on("blur",(()=>{this.writeObservable()}))}this._setupCallback&&(this._setupCallback.call(null,this.editor),this._setupCallback=null)},d.prototype.resize=function(){var e=this.session.getUseWrapMode(),t=e?0:this._getContentWidth(),o=this._getContentHeight(),n={width:e?0:t+this.textPadding,height:o},i=this.calcSize(this._fullDom,n);i.height<o&&(n.width+=20,i=this.calcSize(this._fullDom,n)),i.width<t&&(n.height+=20,i=this.calcSize(this._fullDom,n)),this.editorDom.style.width=i.width?Math.ceil(i.width)+"px":"auto",this.editorDom.style.height=Math.ceil(i.height)+"px",this.editor.resize()},d.prototype._getContentWidth=function(){return this.session.getScreenWidth()*this.editor.renderer.characterWidth},d.prototype._getContentHeight=function(){return Math.max(1,this.session.getScreenLength())*this.editor.renderer.lineHeight},d.prototype._setAceTheme=function(e){const{enableCustomCss:t}=r(),o="dark"!==(null==e?void 0:e.appearance)||t?"chrome":"dracula";this.editor.setTheme(`ace/theme/${o}`)};let u=null;d.makeRange=function(e,t,o,i){return u=u||n.acequire("ace/range").Range,new u(e,t,o,i)},e.exports=d},27601:(e,t,o)=>{var n=o(88438);function i(e){this.gristDoc=e,this._debugName=this.constructor.name+"["+i._nextObjectId+"]",this._eventNamespace=".Events_"+i._nextObjectId++,this._eventSources=[],this.autoDisposeCallback(this.clearEvents)}i._nextObjectId=1,i.setBaseFor=function(e){e.prototype=Object.create(i.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n.makeDisposable(e)},i.prototype.onEvent=function(e,t,o,n){"string"!=typeof o&&(n=o,o=null),-1===this._eventSources.indexOf(e)&&this._eventSources.push(e);var i=this;$(e).on(t+this._eventNamespace,o,(function(e){if(Array.prototype.unshift.call(arguments,this),i._eventSources)return n.apply(i,arguments)}))},i.prototype.clearEvent=function(e,t){$(e).off(t+this._eventNamespace)},i.prototype.clearEvents=function(){for(var e=this._eventSources,t=0;t<e.length;t++)$(e[t]).off(this._eventNamespace);this._eventSources.length=0},e.exports=i},30583:(e,t,o)=>{const n=o(77949),i=o(29301),s=o(68652),{getSelectionDesc:r}=o(413),{nativeCompare:l,roundDownToMultiple:a,waitObs:c}=o(83277),d=o(83277),u=o(631).MANUALSORT,p=o(631),h=o(15323),{DataRowModel:m}=o(92517),{DynamicQuerySet:f}=o(25192),{SortFunc:g}=o(11579),b=o(3871),y=o(27601),{Cursor:v}=o(67931),_=o(86448),w=o(24412),x=o(86277).Events,{ClientColumnGetters:C}=o(6870),{reportError:D,reportSuccess:k}=o(92769),{urlState:S}=o(3988),{SectionFilter:I}=o(60686),{copyToClipboard:T}=o(61217),{setTestState:R}=o(80864),{ExtraRows:F}=o(89971),{createFilterMenu:A}=o(62905),{closeRegisteredMenu:O}=o(1370),{COMMENTS:E}=o(36258),{DismissedPopup:M}=o(56964),{markAsSeen:P}=o(30919),{buildConfirmDelete:B,reportUndo:$}=o(54292);function L(e,t,o){if(y.call(this,e),this.options=o||{},this.viewSection=t,this._name=this.viewSection.titleDef.peek(),this.schemaModel=this.viewSection.table(),this.comparison=this.gristDoc.comparison,this.tableModel=this.gristDoc.getTableModelMaybeWithDiff(this.schemaModel.tableId()),this.extraRows=new F(this.schemaModel.tableId(),this.comparison&&this.comparison.details),this._queryRowSource=f.create(this,e.querySetManager,this.tableModel),this.viewSection.table().summarySourceTable()){const e=this.tableModel.tableData.getRowPropFunc("group");this._mainRowSource=b.BaseFilteredRowSource.create(this,(t=>!e||!p.isEmptyList(e(t)))),this._mainRowSource.subscribeTo(this._queryRowSource)}else this._mainRowSource=this._queryRowSource;if(this.comparison){const e=this.extraRows.getExtraRows();this._mainRowSource=b.ExtendedRowSource.create(this,this._mainRowSource,e)}this._sectionFilter=I.create(this,this.viewSection,this.tableModel.tableData),this._filteredRowSource=b.FilteredRowSource.create(this,this._sectionFilter.sectionFilterFunc.get()),this._filteredRowSource.subscribeTo(this._mainRowSource),this.autoDispose(this._sectionFilter.sectionFilterFunc.addListener((e=>{this._filteredRowSource.updateFilter(e)}))),this.rowSource=this._filteredRowSource,this.sortedRows=b.SortedRowSet.create(this,null,this.tableModel.tableData),this.sortFunc=new g(new C(this.tableModel,{unversioned:!0})),this.autoDispose(this.viewSection.activeDisplaySortSpec.subscribeInit((function(e){this.sortFunc.updateSpec(e),this.sortedRows.updateSort(((e,t)=>l("new"===e,"new"===t)||this.sortFunc.compare(e,t)))}),this)),this.sortedRows.subscribeTo(this._filteredRowSource),this.newRowSource=b.RowSource.create(this),this.newRowSource.getAllRows=function(){return["new"]},this.viewData=this.autoDispose(this.tableModel.createLazyRowsModel(this.sortedRows)),this.editRowModel=this.autoDispose(this.tableModel.createFloatingRowModel()),this.editRowModel._saveField=(e,t)=>this._saveEditRowField(this.editRowModel,e,t),this.listenTo(this.viewData,"rowModelNotify",(e=>this.onRowResize(e))),this.listenTo(this.viewSection.events,"rowHeightChange",this.onResize),this.autoDispose(w.createGroup(L.commonCommands,this,this.viewSection.hasFocus)),this.linkedRowId=this.autoDispose(i.computed((()=>{let e=this.viewSection.linkingState();return e&&e.cursorPos?e.cursorPos():null})).extend({deferred:!0})),this.autoDispose(this.linkedRowId.subscribe((e=>this.setCursorPos({rowId:e})))),this.disableEditing=this.autoDispose(i.computed((()=>{const e=this.viewSection.linkingState();return e&&e.disableEditing()}))),this.isPreview=this.options.isPreview,this.enableAddRow=this.autoDispose(i.computed((()=>this.options.addNewRow&&!this.viewSection.disableAddRemoveRows()&&!this.disableEditing()))),this.autoDispose(this.enableAddRow.subscribeInit((e=>{e?this.sortedRows.subscribeTo(this.newRowSource):this.sortedRows.unsubscribeFrom(this.newRowSource)}))),this._isLoading=i.observable(!0),this._pendingCursorPos=this.viewSection.lastCursorPos,console.log("%s BaseView viewSection %s (%s) lastCursorPos %s",this._debugName,this.viewSection.getRowId(),this.viewSection.table().tableId(),JSON.stringify(this.viewSection.lastCursorPos)),this.cursor=this.autoDispose(v.create(null,this,this.viewSection.lastCursorPos)),this.currentColumn=this.autoDispose(i.pureComputed((()=>this.viewSection.viewFields().at(this.cursor.fieldIndex()).column())).extend({rateLimit:0})),this.currentEditingColumnIndex=i.observable(-1),this.fieldBuilders=this.autoDispose(_.createAllFieldWidgets(this.gristDoc,this.viewSection.viewFields,this.cursor,{isPreview:this.isPreview})),this.activeFieldBuilder=this.autoDispose(i.pureComputed((()=>this.fieldBuilders.at(this.cursor.fieldIndex())))),this.selectedColumns=null,this.isTruncated=i.observable(!1),this.autoDispose(i.computed((()=>{this._isLoading(!0);const e=this.viewSection.linkingFilter();this._queryRowSource.makeQuery(e.filters,e.operations,(e=>{this.isDisposed()||(e&&D(e),this.onTableLoaded())}))}))),this.autoDispose(this.viewSection.linkingFilter.subscribe((e=>this.onLinkFilterChange()))),this.autoDispose(this.viewSection.activeSortSpec.subscribe((()=>this.setCursorPos({rowIndex:0})))),this.copySelection=i.observable(null),this._isPrinting=i.observable(!1)}y.setBaseFor(L),n.extend(y.prototype,x),L.commonCommands={input:function(e){this.scrollToCursor(!0).catch(D),this.activateEditorAtCursor({init:e})},editField:function(){O(),this.scrollToCursor(!0),this.activateEditorAtCursor()},insertRecordBefore:function(){this.insertRow(this.cursor.rowIndex())},insertRecordAfter:function(){this.insertRow(this.cursor.rowIndex()+1)},insertCurrentDate:function(){this.insertCurrentDate(!1)},insertCurrentDateTime:function(){this.insertCurrentDate(!0)},copyLink:function(){this.copyLink().catch(D)},deleteRecords:function(e){this.deleteRecords(e)},filterByThisCellValue:function(){this.filterByThisCellValue()},duplicateRows:function(){this._duplicateRows().catch(D)},openDiscussion:function(){this.openDiscussionAtCursor()}},L.prototype.selectedRows=function(){return[]},L.prototype.deleteRows=function(e){return this.tableModel.sendTableAction(["BulkRemoveRecord",e])},L.prototype.deleteRecords=function(e){const t=this.selectedRows();if(this.viewSection.disableAddRemoveRows()||0===t.length)return;const o=e instanceof KeyboardEvent,n=this.gristDoc.docPageModel.appModel.dismissedPopups,i=M.check("deleteRecords"),s=async e=>(e&&P(n,i),this.deleteRows(t));if(o&&!n.get().includes(i)){this.scrollToCursor();const e=this.viewPane.querySelector(".selected_cursor")||this.viewPane;B(e,s,t.length<=1)}else s().then((()=>($(this.gristDoc,`You deleted ${t.length} row${t.length>1?"s":""}.`),!0)))},L.prototype.setCursorPos=function(e){this.isDisposed()||(this._isLoading.peek()?(this._pendingCursorPos=e,this.cursor.setLive(!1)):this.cursor.setCursorPos(e))},L.prototype.getLoadingDonePromise=function(){return c(this._isLoading,(e=>!e))},L.prototype.activateEditorAtCursor=function(e){var t=this.activeFieldBuilder();if(!t.isEditorActive()){var o=this.viewData.getRowId(this.cursor.rowIndex()),n=this.getRenderedRowModel(o);n&&(this.editRowModel.assign(o),t.buildEditorDom(this.editRowModel,n,e||{}))}},L.prototype.openDiscussionAtCursor=function(e){if(!E().get())return!1;var t=this.activeFieldBuilder();if(t.isEditorActive())return!1;var o=this.viewData.getRowId(this.cursor.rowIndex()),n=this.getRenderedRowModel(o);return!!n&&(this.editRowModel.assign(o),t.buildDiscussionPopup(this.editRowModel,n,e),!0)},L.prototype.moveEditRowToCursor=function(){var e=this.viewData.getRowId(this.cursor.rowIndex());return this.editRowModel.assign(e),this.editRowModel},L.prototype.getAnchorLinkForSection=function(e){const t=this.viewData.getRowId(this.cursor.rowIndex())||this.tableModel.tableData.findMatchingRowId({})||"new",o=this.cursor.fieldIndex.peek(),n=null!==o?this.viewSection.viewFields().peek()[o]:null;return{hash:{sectionId:e,rowId:t,colRef:null==n?void 0:n.colRef.peek()}}},L.prototype.copyLink=async function(){const e=this.viewSection.getRowId(),t=this.getAnchorLinkForSection(e);try{const e=S().makeUrl(t);await T(e),R({clipboard:e}),k("Link copied to clipboard",{key:"clipboard"})}catch(e){throw new Error("cannot copy to clipboard")}},L.prototype.filterByThisCellValue=function(){const e=this.viewData.getRowId(this.cursor.rowIndex()),t=this.viewSection.viewFields().peek()[this.cursor.fieldIndex()].column();let o,n=this.tableModel.tableData.getValue(e,t.colId.peek());const i=t.type.peek();p.isList(n)&&p.isListType(i)?(o=n.slice(1),o.length||(o=["ChoiceList"===i?"":null])):(Array.isArray(n)&&(n=JSON.stringify(n)),o=[n]),this.viewSection.setFilter(t.getRowId(),{filter:JSON.stringify({included:o})})},L.prototype.insertRow=function(e){if(!this.viewSection.disableAddRemoveRows()&&!this.disableEditing()){var t=this.viewData.getRowId(e),o=Number.isInteger(t)?this.tableModel.tableData.getValue(t,"manualSort"):null;return this.sendTableAction(["AddRecord",null,{manualSort:o}]).then((e=>(this.isDisposed()||(this._sectionFilter.addTemporaryRow(e),this.setCursorPos({rowId:e})),e)))}},L.prototype._getDefaultColValues=function(){const e=this.viewSection.linkingState.peek();return e?e.getDefaultColValues():{}},L.prototype._enhanceAction=function(e){if("AddRecord"===e[0]||"BulkAddRecord"===e[0]){let t=this._getDefaultColValues(),o=e[1];return"BulkAddRecord"===e[0]&&(t=n.mapObject(t,(e=>o.map((()=>e))))),Object.assign(t,e[2]),[e[0],o,t]}return e},L.prototype.prepTableActions=function(e){return(e=e.map((e=>this._enhanceAction(e)))).forEach((e=>{e.splice(1,0,this.tableModel.tableData.tableId)})),e},L.prototype.sendTableActions=function(e,t){return this.tableModel.sendTableActions(e.map((e=>this._enhanceAction(e))),t)},L.prototype.sendTableAction=function(e,t){return e?this.tableModel.sendTableAction(this._enhanceAction(e),t):null},L.prototype.insertCurrentDate=function(e){let t=this.currentColumn();if(t.isRealFormula())return;let o,n=t.pureType(),i=Date.now();const r=this.gristDoc.docInfo.timezone.peek();if("Text"===n||"Any"===n)o=s.tz(i,r).format("YYYY-MM-DD"+(e?" HH:mm:ss":""));else if("Date"===n){const e=s.tz(i,r).utcOffset();o=a(i/1e3+60*e,86400)}else{if("DateTime"!==n)return;o=i/1e3}var l=this.viewData.getRowId(this.cursor.rowIndex());this.editRowModel.assign(l),this.editRowModel[t.colId()].setAndSave(o)},L.prototype._saveEditRowField=function(e,t,o){if(e._isAddRow.peek()){this.cursor.setLive(!1);const n=this._getDefaultColValues();return n[t]=o,e.updateColValues(n).then((e=>(this.isDisposed()||(this._sectionFilter.addTemporaryRow(e),this.setCursorPos({rowId:e})),e))).finally((()=>!this.isDisposed()&&this.cursor.setLive(!0)))}{var n=e.getRowId(),i=this.getRenderedRowModel(n);i&&i[t](o);const s=m.prototype._saveField.call(e,t,o).then((e=>(this.isDisposed()||this._sectionFilter.addTemporaryRow(n),e))).finally((()=>!this.isDisposed()&&i&&i._assignColumn(t)));return this.viewSection.isSorted()?s:null}},L.prototype.copy=function(e){return this.copySelection(e),{data:this.tableModel.tableData,selection:e}},L.prototype.cut=function(e){return this.copySelection(e),{data:this.tableModel.tableData,selection:e,cutCallback:()=>h.makeDeleteAction(e)}},L.prototype.sendPasteActions=function(e,t){let o=null;return e&&(o=e(),o&&t.unshift(o)),this.gristDoc.docData.sendActions(t,this._getPasteDesc(t[t.length-1],o))},L.prototype._getPasteDesc=function(e,t){return t?`Moved ${r(t,!0)} to ${r(e,!0)}.`:`Pasted data to ${r(e,!0)}.`},L.prototype.buildDom=function(){throw new Error("Not Implemented")},L.prototype.buildTitleControls=function(){return null},L.prototype.onTableLoaded=function(){this._pendingCursorPos&&(this.cursor.setCursorPos(this._pendingCursorPos),this._pendingCursorPos=null),this._isLoading(!1),this.isTruncated(this._queryRowSource.isTruncated),this.cursor.setLive(!0)},L.prototype.onResize=function(){},L.prototype.onRowResize=function(e){},L.prototype.onLinkFilterChange=function(e){this.setCursorPos({rowIndex:0})},L.prototype.prepareToPrint=function(e){this._isPrinting(e)},L.prototype.getRenderedRowModel=function(e){return this.viewData.getRowModel(e)},L.prototype.getLastDataRowIndex=function(){let e=this.viewData.peekLength-1;return e>=0&&"new"===this.viewData.getRowId(e)?e-1:e},L.prototype.createFilterMenu=function(e,t,o){const{showAllFiltersButton:n,onClose:i}=o;return A({openCtl:e,sectionFilter:this._sectionFilter,filterInfo:t,rowSource:this._mainRowSource,tableData:this.tableModel.tableData,gristDoc:this.gristDoc,showAllFiltersButton:n,onClose:i})},L.prototype.isFiltered=function(){return this._filteredRowSource.getNumRows()<this.tableModel.tableData.numRecords()},L.prototype.scrollToCursor=function(){return Promise.resolve()},L.prototype._getRowInsertPos=function(e,t){var o=this.viewData.getRowId(e),n=this.tableModel.tableData.getValue(o,u);return Array(t).fill(n)},L.prototype._duplicateRows=async function(){if(this.viewSection.disableAddRemoveRows()||this.disableEditing())return;const e=this.getSelection().rowIds,t=e.length,o=["BulkAddRecord"];o.push(d.arrayRepeat(t,null));const n={};o.push(n);const i=this.viewData.getRowIndex(e[t-1]);n.manualSort=this._getRowInsertPos(i+1,t);for(const t of this.viewSection.columns.peek()){const o=t.colId.peek();t.isFormula.peek()||(n[o]=e.map((e=>this.tableModel.tableData.getValue(e,o))),n[o].every(p.isCensored)?delete n[o]:n[o].forEach(((e,t)=>{p.isCensored(e)&&(n[o][t]=null)})))}return await this.sendTableAction(o,`Duplicated rows ${e}`)},e.exports=L},13988:(e,t,o)=>{var n=o(29301),i=o(74392),s=o(88438),r=o(83277);function l(e){return c.create(e)}function a(e,t){e(this,t)}function c(e){this._array=n.observable(e||[]),this._preparedSpliceEvent=null,this._syncSubscription=null,this._disposeElements=d,this.autoDispose(this._array.subscribe(this._emitPreparedEvent,this,"spectate")),this.autoDisposeCallback((function(){this._disposeElements(this.peek())}))}function d(){}function u(e){return e}o(33620),e.exports=t=l,t.default=l,l.isKoArray=function(e){return e&&"function"==typeof e.subscribe&&"function"==typeof e.all},t.isKoArray=l.isKoArray,l.syncedKoArray=function(e,t,o){var n=l();return t=t||u,n.autoDispose(e.subscribeInit((function(e){l.isKoArray(e)?n.syncMap(e,t,o):e&&(n.syncMapDisable(),n.assign(e.map((function(e,n){return t.call(o,e,n)}))))}))),n},t.syncedKoArray=l.syncedKoArray,s.makeDisposable(a),l.syncedMap=function(e,t,o){var n=new Map,i=e.subscribeForEach({add:e=>n.set(e,a.create(t,e)),remove:e=>r.popFromMap(n,e).dispose(),addDelay:o&&o.addDelay});return n.dispose=()=>{i.dispose(),n.forEach(((e,t)=>e.dispose()))},n},t.KoArray=c,s.makeDisposable(c),c.prototype.setAutoDisposeValues=function(){return this._disposeElements=this._doDisposeElements,this},c.prototype.all=function(){return this._array()},c.prototype.peek=function(){return this._array.peek()},c.prototype.getObservable=function(){return this._array},Object.defineProperty(c.prototype,"peekLength",{configurable:!1,enumerable:!1,get:function(){return this._array.peek().length}}),c.prototype.at=function(e){var t=this._array();return e>=0&&e<t.length?t[e]:null},c.prototype.assign=function(e){var t=this.peek();this._prepareSpliceEvent(0,e.length,t),this._array(e.slice()),this._disposeElements(t)},c.prototype.subscribe=function(e,t,o){return this._array.subscribe(e,t,o)},c.prototype._prepareSpliceEvent=function(e,t,o){this._preparedSpliceEvent={array:null,start:e,added:t,deleted:o}},c.prototype._emitPreparedEvent=function(){var e=this._preparedSpliceEvent;e&&(e.array=this.peek(),this._preparedSpliceEvent=null,this._array.notifySubscribers(e,"spliceChange"))},c.prototype._preChange=function(){this._array.valueWillMutate()},c.prototype._postChange=function(){this._array.valueHasMutated()},c.prototype._doDisposeElements=function(e){for(var t=0;t<e.length;t++)e[t].dispose()},c.prototype.push=function(){var e=this.peek(),t=e.length;this._preChange();var o=e.push.apply(e,arguments);return this._prepareSpliceEvent(t,arguments.length,[]),this._postChange(),o},c.prototype.unshift=function(){var e=this.peek();this._preChange();var t=e.unshift.apply(e,arguments);return this._prepareSpliceEvent(0,arguments.length,[]),this._postChange(),t},c.prototype.splice=function(e,t){return this.arraySplice(e,t,Array.prototype.slice.call(arguments,2))},c.prototype.arraySplice=function(e,t,o){var n=this.peek(),i=n.length,s=Math.min(i,Math.max(0,e<0?i+e:e));this._preChange();var l=void 0===t?n.splice(e):n.splice(e,t);return r.arraySplice(n,s,o),this._prepareSpliceEvent(s,o.length,l),this._postChange(),this._disposeElements(l),l},c.prototype.slice=function(){var e=this.all();return e.slice.apply(e,arguments)},c.prototype.map=function(e,t){var o=new c;return o.syncMap(this,e,t),o},c.prototype.syncMap=function(e,t,o){this.syncMapDisable(),t=t||u,this.assign(e.peek().map((function(e,n){return t.call(o,e,n)}))),this._syncSubscription=this.autoDispose(e.subscribe((function(e){for(var n=e.array,i=[],s=e.start,r=0;r<e.added;s++,r++)i.push(t.call(o,n[s],s));this.arraySplice(e.start,e.deleted.length,i)}),this,"spliceChange"))},c.prototype.syncMapDisable=function(){this._syncSubscription&&(this.disposeDiscard(this._syncSubscription),this._syncSubscription=null)},c.prototype.subscribeForEach=function(e){var t=e.context,o=e.add||d,n=e.remove||d,s="number"==typeof e.addDelay,r=this.subscribe((function(r){var l,a=r.array;for(l=0;l<r.deleted.length;l++)n.call(t,r.deleted[l],this);var c=()=>{var e=r.start+r.added;for(l=r.start;l<e;l++)o.call(t,a[l],l,this)};s?e.addDelay>0?setTimeout(c,e.addDelay):i.resolve(null).then(c):c()}),this,"spliceChange");return this.peek().forEach((function(e,n){o.call(t,e,n,this)}),this),r},c.prototype.clampIndex=function(e){var t=this.peekLength;return 0===t?null:r.clamp(e||0,0,t-1)},c.prototype.makeLiveIndex=function(e){var t=n.observable(this.clampIndex(e)),o=!0;this.subscribe((function(e){var n=t.peek();o?null===n?t(this.clampIndex(0)):n>=e.start+e.deleted.length?t(this.clampIndex(n+e.added-e.deleted.length)):n>=e.start+e.added&&t(this.clampIndex(e.start+e.added)):t(this.clampIndex(n))}),this,"spliceChange");var i=n.pureComputed({read:t,write:function(e){t(this.clampIndex(e))},owner:this});return i.setLive=e=>{o=e},i}},92979:(e,t,o)=>{var n=o(11527).get("document","Node"),i=o(29301),s=o(81294),r=o(13988);function l(e,t,o){var n;i.isObservable(t)?(n=t.subscribe((function(t){o(e,t)})),i.utils.domNodeDisposal.addDisposeCallback(e,(function(){n.dispose()})),o(e,t.peek())):"function"==typeof t?(t=i.computed(t),n=t.subscribe((function(t){o(e,t)})),i.utils.domNodeDisposal.addDisposeCallback(e,(function(){n.dispose(),t.dispose()})),o(e,t.peek())):o(e,t)}function a(e,t){return function(o){l(o,e,t)}}t.setBinding=l,t.makeBinding=a,t.text=function(e){return function(t){var o=n.document.createTextNode("");l(t,e,(function(e,t){o.nodeValue=t})),t.appendChild(o)}},t.bootstrapToken=function(e,t){var o=e.cloneNode();return l(o,t,(function(e,t){o.textContent=t})),o},t.attr=function(e,t){return a(t,(function(t,o){null==o?t.removeAttribute(e):t.setAttribute(e,o)}))},t.boolAttr=function(e,t){return a(t,(function(t,o){o?t.setAttribute(e,""):t.removeAttribute(e)}))},t.style=function(e,t){return a(t,(function(t,o){e.startsWith("--")?t.style.setProperty(e,o):t.style[e]=o}))},t.show=function(e){return a(e,(function(e,t){e.style.display=t?"":"none"}))},t.hide=function(e){return a(e,(function(e,t){e.style.display=t?"none":""}))},t.domData=function(e,t){return a(t,(function(t,o){i.utils.domData.set(t,e,o)}))},t.value=function(e){return a(e,(function(e,t){e.value!==t&&(e.value=t)}))},t.toggleClass=function(e,t){return a(t,(function(t,o){t.classList.toggle(e,!!o)}))},t.toggleDisabled=function(e){return a(e,(function(e,t){t?e.setAttribute("disabled","disabled"):e.removeAttribute("disabled")}))},t.cssClass=function(e){var t;return a(e,(function(e,o){t&&e.classList.remove(t),t=o,o&&e.classList.add(o)}))};const c=Symbol();function d(e,t,o){if(null===t)return Promise.resolve();const n=i.utils.domData.get(e,"scrolly");if(n)return o?(n.scrollRowIntoView(t),e[c]=null,Promise.resolve()):(e[c]=t,new Promise(((t,o)=>{setTimeout((()=>{try{if(null===e[c])return void t();n.isDisposed()||n.scrollRowIntoView(e[c]),t()}catch(e){o(e)}finally{e[c]=null}}),0)})));{const o=e.children[t];if(o){0===t&&(e.scrollTop=0);const n=o.getBoundingClientRect(),i=e.getBoundingClientRect();n.top<i.top?o.scrollIntoView(!0):n.bottom>i.bottom&&o.scrollIntoView(!1)}}return Promise.resolve()}function u(e,t){var o,r=[];return a(e,(function(e,l){o||(o=e.appendChild(n.document.createComment("")));for(var a=s.frag(t(l)),c=0;c<r.length;c++)r[c].parentNode===e&&i.removeNode(r[c]);r.length=0;var d=o.nextSibling;e.insertBefore(a,d);for(var u=o.nextSibling;u!==d;u=u.nextSibling)r.push(u)}))}t.scrollChildIntoView=function(e){return a(e,d)},t.doScrollChildIntoView=d,t.scope=u,t.maybe=function(e,t){return u(e,(function(e){return e?t(e):null}))},t.foreach=function(e,t){var o,s=[];return function(l){o||(o=l.appendChild(n.document.createComment("")));var a=function(e){var r,a=e.start,c=s.splice(a,e.deleted.length);for(r=0;r<c.length;r++)c[r]&&c[r].parentNode===l&&i.removeNode(c[r]);if(e.added>0){var d=n.document.createDocumentFragment(),u=[a,0];for(r=0;r<e.added;r++){var p=e.array[a+r],h=t(p);h&&(i.utils.domData.set(h,"itemModel",p),d.appendChild(h)),u.push(h)}Array.prototype.splice.apply(s,u);var m=o;for(r=a-1;r>=0;r--)if(s[r]&&s[r].parentNode===l){m=s[r];break}l.insertBefore(d,m.nextSibling)}},c=e;if(r.isKoArray(e)){var d=e.subscribe(a,null,"spliceChange");i.utils.domNodeDisposal.addDisposeCallback(l,(function(){d.dispose()})),c=e.all()}else if(!Array.isArray(e))throw new Error("koDom.foreach applied to non-array: "+e);a({array:c,start:0,added:c.length,deleted:[]})}}},73783:(e,t,o)=>{var n=o(11527).get("$","window","document");const i=o(72827),s=o(52906),r=o(88466),l=o(68525);var a=o(29301),c=o(74392),d=o(83277),u=o(24412),p=o(81294),h=o(92979),m=o(13988),f=o(32529).setSaveValue;function g(e,t,o){let i=null,s=null;function r(t,o){c(),n.$(n.window).on("mouseup",l),s=e.peek(),a(o,!0)}function l(){n.$(n.window).off("mouseup",l),c(),f(e,e.peek(),s)}function a(o,n){const s=t(e.peek(),o);s!==e.peek()&&(e(s),i=setTimeout(a,n?600:100,o,!1))}function c(){i&&(clearTimeout(i),i=null)}return p("div.kf_spinner",p("div.kf_spinner_half",p("div.kf_spinner_arrow.up"),h.toggleClass("disabled",(()=>o(e(),1))),p.on("mousedown",(()=>{r(0,1)}))),p("div.kf_spinner_half",p("div.kf_spinner_arrow.down"),h.toggleClass("disabled",(()=>o(e(),-1))),p.on("mousedown",(()=>{r(0,-1)}))),p.on("dblclick",(()=>!1)))}function b(e,t,o){var i=a.utils.domData.get(e,"reorderFunc"),s=a.utils.domData.get(o.item[0],"originalPrev");i&&!o.item.prev().is(s)&&i(a.utils.domData.get(o.item[0],"model"),w(o.item)).catch((function(t){console.warn("Failed to reorder item",t),n.$(e).sortable("cancel")})),x(o.item[0])}function y(e,t){var o=a.utils.domData.get(t.item[0],"originalParent"),i=a.utils.domData.get(o[0],"removeFunc"),s=a.utils.domData.get(t.item.parent()[0],"receiveFunc");i&&s?i(a.utils.domData.get(t.item[0],"model")).then((function(e){return s(e,w(t.item)).then((function(){t.item.remove()})).catch(v.bind(null,t,o,e))})).catch((function(e){console.warn("Error removing item",e),n.$(o).sortable("cancel")})).finally((function(){x(t.item[0])})):console.warn("Missing remove or receive")}function v(e,t,o,n){console.warn("Error receiving item. Trying to return removed item.",n);var i=a.utils.domData.get(t[0],"receiveFunc");if(i){var s=a.utils.domData.get(e.item[0],"originalPrev");i(o,s.length>0?w(s):_(t.children(".kf_draggable").first())).catch((function(e){console.warn("Failed to receive item in original collection.",e)})).finally((function(){e.item.remove()}))}}function _(e){return e.length&&e.length>0?a.utils.domData.get(e[0],"model"):null}function w(e){return e.next?_(e.next(".kf_draggable")):null}function x(e){a.utils.domData.set(e,"originalPrev",null),a.utils.domData.set(e,"originalParent",null),a.utils.domData.set(e,"crossedContainers",!1)}function C(e){n.$(e).on("sortremove",(function(e,t){a.utils.domData.set(t.item[0],"crossedContainers",!0),a.utils.domData.set(t.item[0],"stopIndex",t.item.index())})),n.$(e).sortable("option","disabled")&&(a.utils.domData.get(e,"receiveFunc")||a.utils.domData.get(e,"removeFunc"))&&n.$(e).sortable("option",{disabled:!1})}function D(e,t){C(e),n.$(e).addClass(t),n.$(e).sortable("option",{connectWith:"."+t})}t.button=function(e,...t){return p("div.kf_button.flexitem",p.on("click",(function(){this.classList.contains("disabled")||e()})),t)},t.accentButton=function(e,...t){return this.button(e,{class:"kf_button flexitem accent"},t)},t.liteButton=function(e,...t){return this.button(e,{class:"kf_button flexitem lite"},t)},t.logoButton=function(e,t,o,...n){return this.button(e,{class:"kf_button kf_logo_button flexitem flexhbox"},p("div.kf_btn_logo",{style:`background-image: url(${t})`}),p("div.kf_btn_text",o),n)},t.buttonGroup=function(e){return p("div.kf_button_group.kf_elem.flexhbox",p.fwdArgs(arguments,0))},t.accentButtonGroup=function(e){return this.buttonGroup([{class:"kf_button_group kf_elem flexhbox accent"}].concat(p.fwdArgs(arguments,0)))},t.liteButtonGroup=function(e){return this.buttonGroup([{class:"kf_button_group kf_elem flexhbox lite"}].concat(p.fwdArgs(arguments,0)))},t.checkButton=function(e,t){return p("div.kf_button.kf_check_button.flexitem",h.toggleClass("active",e),p.on("click",(function(){this.classList.contains("disabled")||f(e,!e())})),p.fwdArgs(arguments,1))},t.flatCheckButton=function(e,t){return p("div.flexnone",h.toggleClass("mod-active",e),p.on("click",(function(){this.classList.contains("mod-disabled")||f(e,!e())})),p.fwdArgs(arguments,1))},t.buttonSelect=function(e,t){var o=p("div.kf_button_group.kf_elem.flexhbox",p.fwdArgs(arguments,1));return n.$(o).on("click",".kf_button:not(.disabled)",(function(){f(e,a.utils.domData.get(this,"kfOptionValue"))})),h.makeBinding(e,(function(e,t){Array.prototype.forEach.call(e.querySelectorAll(".kf_button"),(function(e,o){var n=a.utils.domData.get(e,"kfOptionValue");e.classList.toggle("active",n===t)}))}))(o),o},t.optionButton=function(e,t){return p("div.kf_button.flexitem",(function(t){a.utils.domData.set(t,"kfOptionValue",e)}),p.fwdArgs(arguments,1))},t.toolTip=function(e){return p("div.kf_tooltip",p("div.kf_tooltip_pointer"),p("div.kf_tooltip_content",p.fwdArgs(arguments,0)),p.defer((function(e){var t=e.getBoundingClientRect().width,o=e.parentNode.getBoundingClientRect();e.style.left=-t/2+o.width/2+"px",e.style.top=o.height+"px"})))},t.prompt=function(e){return p("div.kf_prompt",p("div.kf_prompt_pointer"),p("div.kf_prompt_pointer_overlap"),p("div.kf_prompt_content",p.fwdArgs(arguments,0)))},t.checkbox=function(e,t){return p("label.kf_checkbox_label.kf_elem",p("input.kf_checkbox",{type:"checkbox"},h.makeBinding(e,(function(e,t){e.checked=t})),p.on("change",(function(){f(e,this.checked)}))),p.fwdArgs(arguments,1))},t.radio=function(e,t,...o){return p("label.kf_radio_label",p("input.kf_radio",{type:"radio"},h.makeBinding(t,((t,o)=>{t.checked=o===e})),p.on("change",(function(){this.checked&&f(t,e)}))),...o)},t.spinner=function(e,t,o,n){var i=void 0!==n?n:1/0,s=void 0!==o?o:-1/0;return g(e,(function(e,o){const n=(a.unwrap(t)||1)*o;return e=e||0,e=Math.round(e/n)*n+n,e=parseFloat(e.toPrecision(15)),d.clamp(e,s,i)}),(function(e,t){return t>0?e>=i:e<=s}))},t.selectSpinner=function(e,t){return g(e,(function(e,o){const n=t.peek(),i=n.indexOf(e);return n[d.mod(i+o,n.length)]}),(function(e,o){return t().length<=1}))},t.alignmentSelector=function(e){return this.buttonSelect(e,this.optionButton("left",p("span.glyphicon.glyphicon-align-left"),p.testId("koForm_alignLeft")),this.optionButton("center",p("span.glyphicon.glyphicon-align-center"),p.testId("koForm_alignCenter")),this.optionButton("right",p("span.glyphicon.glyphicon-align-right"),p.testId("koForm_alignRight")))},t.collapserLabel=function(e,t){return p("div.kf_collapser.kf_elem",p("span.kf_triangle_toggle",h.text((function(){return e()?"►":"▼"}))),p.on("click",(function(){e(!e.peek())})),p.fwdArgs(arguments,1))},t.collapsible=function(e,t){var o=a.observable(void 0===t||t),n=e(o);return[n[0],p("div",h.hide(o),p.fwdArgs(n,1))]},t.draggableList=function(e,t,o){var r,l;s(o=o||{},{removeButton:!0,axis:"y",drag_indicator:!0,itemClass:"kf_draggable__item"}),t=t||i;var d=p("div.kf_drag_container",(function(e){o.reorder&&(r=c.method(o.reorder),a.utils.domData.set(e,"reorderFunc",r)),o.remove&&(l=c.method(o.remove),a.utils.domData.set(e,"removeFunc",l)),o.receive&&a.utils.domData.set(e,"receiveFunc",c.method(o.receive))}),h.foreach(e,(e=>{var i=t(e);return i?p("div.kf_draggable",p.on("mousedown",(()=>n.document.activeElement.blur())),h.cssClass(o.itemClass),o.drag_indicator?"boolean"==typeof o.drag_indicator?p("span.kf_drag_indicator.glyphicon.glyphicon-option-vertical"):o.drag_indicator():null,h.style("display","x"===o.axis?"inline-block":"block"),h.domData("model",e),h.maybe(void 0!==l&&o.removeButton,(function(){return p("span.drag_delete.glyphicon.glyphicon-remove",p.on("click",(function(){l(e).catch((function(e){console.warn("Failed to remove item",e)}))})))})),p("span.kf_draggable_content.flexauto",i)):null})));return n.$(d).sortable({axis:o.axis,tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"kf_draggable__placeholder--"+("x"===o.axis?"horizontal":"vertical")}),void 0===r&&n.$(d).sortable("option",{disabled:!0}),n.$(d).on("sortstart",(function(e,t){a.utils.domData.set(t.item[0],"originalParent",t.item.parent()),a.utils.domData.set(t.item[0],"originalPrev",t.item.prev())})),n.$(d).on("sortstop",(function(e,t){a.utils.domData.get(t.item[0],"crossedContainers")?y.call(d,e,t):b.bind(null,d).call(this,e,t)})),d};var k=0;function S(e,t,o){var n={};t&&(t.type&&(n.type=t.type),t.maxSize&&(n.maxlength=t.maxSize,n.style="max-width: "+(t.maxSize+2)+"em"),t.placeholder&&(n.placeholder=t.placeholder));var i=t=>f(e,t.target.value),s=r(i,t.delay),l=e=>{t&&t.delay?p(e,p.on("input",s),p.on("change",(e=>{s(e),s.flush()}))):p(e,p.on("change",i))};return p("div.kf_elem",p("input.kf_text",n,h.toggleDisabled(t.disabled||!1),h.value(e),l,p.fwdArgs(arguments,2)))}function I(e,t){t.textContent=e.value;var o=t.getBoundingClientRect();e.style.width=Math.ceil(o.width)+"px"}function T(e,t,o){var i=e||a.observable(0);return n.$(o).on("click",t,(function(){i(p.childIndex(this))})),a.utils.domData.set(o,"kfSelectedTab",i),o}function R(e,t,o){return function(n){var i=p.findLastChild(n,e);if(i){var s=a.utils.domData.get(i,"kfSelectedTab"),r=i.firstChild,l=i.lastChild,c=r.childNodes.length,d=a.computed((function(){return s()===c}));h.toggleClass("active",d)(t),p.autoDispose(t,d),h.show(d)(o),r.appendChild(t),l.appendChild(o)}else console.log("koForm: Attempting to add tab without an existing tabs container")}}t.connectAllDraggables=function(e){e.length<2&&console.warn("connectAllDraggables requires at least 2 draggable components");for(var t="connected-draggable-"+k++,o=0;o<arguments.length;o++)D(arguments[o],t)},t.connectDraggableOneWay=function(e,t){e.id="connected-draggable-"+k++,t.id="connected-draggable-"+k++,C(e),C(t),n.$(e).sortable("option",{connectWith:"#"+t.id})},t.label=function(e){return p("div.kf_label.kf_elem",p.fwdArgs(arguments,0))},t.lightLabel=function(e){return p("div.kf_light_label.kf_elem",p.fwdArgs(arguments,0))},t.midTabs=function(e){return T(e,".kf_mid_tab_label",p("div.flexitem.kf_mid_tabs",p("div.flexhbox.flexnone.kf_mid_tab_labels"),t.scrollable()))},t.midTab=function(e,t){return R(".kf_mid_tabs",p("div.kf_mid_tab_label.flexitem",e),p("div.kf_mid_tab_content",p.fwdArgs(arguments,1)))},t.numText=function(e,t){var o={type:"number"};return(t=t||{}).placeholder&&(o.placeholder=t.placeholder),void 0!==t.min&&(o.min=t.min),void 0!==t.max&&(o.max=t.max),p("div.kf_elem",p("input.kf_num_text",o,h.value(e),p.on("input",(function(){f(e,Number(this.value))}))))},t.text=function(e,t,...o){return S(e,t=Object.assign({type:"text"},t||{}),o)},t.color=function(e,...t){const o=r((t=>f(e,t.target.value)),300);return p("div.kf_elem",p("input.kf_color",{type:"color"},h.value(e),p.on("change",o),...t))},t.password=function(e,t,...o){return S(e,t=Object.assign({type:"password"},t||{}),o)},t.statusPanel=function(e,o){var n={};["success","info","warning","error"].forEach((function(e){var t;o[e]&&(t=void 0!==o[e].value?o[e].value:o[e],n[t]={},n[t].className="kf_status_"+e,n[t].label=o[e].label||null)}));var i=a.pureComputed((function(){return void 0!==n[e()].label}));return p("div.kf_status_panel.flexhbox",p.autoDispose(i),p("div.kf_status_indicator.flexauto",h.cssClass((function(){if(n[e()])return n[e()].className;console.error("Status must match an available status code",Object.keys(n))})),"●"),p("div.kf_status_detail.flexauto",h.maybe(o.heading,(function(){return t.row(t.label(o.heading))})),h.maybe(i,(function(){return t.row(t.lightLabel(h.text(a.pureComputed((function(){return n[e()].label})))))}))))},t.editableLabel=function(e,t,o){var n,i=t||a.observable(!1),s=!1,r=Object.assign({cancel:function(){s=!0,i(!1)},accept:function(){s=!1,i(!1)}},o||{});return p("div.kf_editable_label",p("div.kf_elabel_text",h.text(e),h.hide(i)),n=p("div.elabel_content_measure"),t?null:p.on("click",(()=>i(!0))),h.maybe(i,(function(){var t=u.createGroup(r,this,!0);return p("input.kf_elabel_input",{type:"text"},(e=>p.hide(e)),h.value(e),p.autoDispose(t),t.attach(),p.on("blur",(function(){i(!1)})),p.on("change",(function(){i(!1)})),p.on("input",(function(){I(this,n)})),p.onDispose((t=>{s||e()===t.value||f(e,t.value)})),p.defer((function(e){s=!1,I(e,n),p.show(e),e.focus(),e.select()})))})))},t.row=function(e){for(var t=1,o=p("div.kf_row.flexhbox"),n=0;n<arguments.length;n++){var i=arguments[n];"number"==typeof i?t=i:"function"==typeof i?i(o):void 0!==i&&(("string"==typeof i||Array.isArray(i))&&(i=p("div",i)),i.style.flex=i.style.webkitFlex=t+" 1 0px",o.appendChild(i),t=1)}return o},t.helpRow=function(e){var o=t.row.apply(null,arguments);return o.classList.add("kf_help_row"),o},t.scrollable=function(e){var t,o;return[p("div.flexnone.kf_scroll_shadow_outer",o=p("div.kf_scroll_shadow",p.hide)),t=p("div.flexitem.kf_scrollable",p.on("scroll",(function(){o.style.display=t.scrollTop>0?"":"none"})),p.fwdArgs(arguments,0))]},t.select=function(e,t,o){var n=(e,t)=>{let n=new Set(o.multiple?t:[t]);for(let t of e.querySelectorAll("option"))t.selected=n.has(a.utils.domData.get(t,"value"))};return p("div.kf_elem",p("div.kf_select_arrow",p("select.kf_select",l(o=o||{},["size","multiple"]),h.toggleDisabled(o.disabled||!1),h.foreach(t,(function(e){if(!e)return null;let t="string"==typeof e?e:e.value,o="string"==typeof e?e:e.label,n="string"!=typeof e&&e.disabled;return p("option",{value:t},h.domData("value",t),h.toggleDisabled(n),h.text(o))})),h.makeBinding(m.isKoArray(t)?t.getObservable():t,(t=>n(t,e()))),h.makeBinding(e,((e,t)=>n(e,t))),p.on("change",(function(){let t=[],n=this.querySelectorAll("option");for(let e=0;e<n.length;e++)if(n[e].selected){let i=a.utils.domData.get(n[e],"value");if(t.push(i),!o.multiple)break}t.sort(),f(e,o.multiple?t:t[0])})))))},t.separator=function(){return p("hr.kf_separator")},t.topTabs=function(e){return T(e,".kf_top_tab_label",p("div.flexvbox.kf_top_tabs",p("div.flexhbox.flexnone.kf_top_tab_labels"),p("div.flexitem.kf_top_tab_container")))},t.topTab=function(e,t){return R(".kf_top_tabs",p("div.kf_top_tab_label.flexitem",e),p("div.kf_top_tab_content.flexvbox",p.fwdArgs(arguments,1)))}},55424:(e,t,o)=>{var n=o(77949),i=o(29301),s=o(83277),r=o(88438),l=o(32529);function a(e,t){this._table=e,this._fields=t.slice(0),this._index=i.observable(null),this._rowId=null,this._fields.forEach((function(e){this._createField(e)}),this)}r.makeDisposable(a),n.extend(a.prototype,l.ActionDispatcher),a.prototype.getRowId=function(){return this._rowId},a.prototype._createField=function(e){this[e]=l.addSaveInterface(i.observable(),(t=>this._saveField(e,t)))},a.prototype._saveField=function(e,t){var o={};return o[e]=t,this.updateColValues(o)},a.prototype.updateColValues=function(e){return this._table.sendTableAction(["UpdateRecord",this._rowId,e])},a.prototype._assignColumn=function(e){throw new Error("Not Implemented")},a.prototype._process_RemoveColumn=function(e,t,o){s.arrayRemove(this._fields,o)||console.error("RowModel #RemoveColumn %s %s: column not found",t,o),delete this[o]},a.prototype._process_ModifyColumn=function(e,t,o,n){},a.prototype._process_UpdateRecord=function(e,t,o,n){for(var i in n)this._assignColumn(i)},a.prototype._process_BulkUpdateRecord=function(e,t,o,n){for(var i in n)this._assignColumn(i)},a.prototype._process_AddColumn=function(e,t,o,n){this._fields.push(o),this._createField(o),this._assignColumn(o)},a.prototype._process_RenameColumn=function(e,t,o,n){if(-1===this._fields.indexOf(n)){var i=this._fields.indexOf(o);-1!==i?(this._fields[i]=n,this[n]=this[o],l.addSaveInterface(this[n],this._saveField.bind(this,n)),this._assignColumn(n),delete this[o]):console.error("RowModel #RenameColumn %s %s %s: not found",t,o,n)}else console.error("RowModel #RenameColumn %s %s %s: already exists",t,o,n)},e.exports=a},41367:(e,t,o)=>{var n=o(77949),i=o(20543),s=o(86277).Events,r=o(83277),l=o(88438),a=o(13988),c=o(3871),d=o(33113),{DataRowModel:u}=o(92517);const{TableQuerySets:p}=o(25192);function h(e,t,o){d.call(this,e,t),this.tableMetaRow=o,this.tableQuerySets=new p(this.tableData);var n=t.getColIds();i(n.includes("id"),"Expecting tableData columns to include `id`"),this._newRowModel=this.autoDispose(new u(this,n)),this._floatingRows=new Set,this.listenTo(this,"rowNotify",(function(e,t){e===c.ALL?(this._newRowModel.dispatchAction(t),this._floatingRows.forEach((e=>{e.dispatchAction(t)}))):this._floatingRows.forEach((o=>{e.includes(o.getRowId())&&o.dispatchAction(t)}))}))}function m(e,t){a.KoArray.call(this,e.getKoArray().peek().map((function(e){return null}))),this._rowIdArray=e.getKoArray(),this._makeRowModel=t,this._assignedRowModels=new Map,this._allRowModels=new Set,this.autoDispose(this._rowIdArray.subscribe(this._onSpliceChange,this,"spliceChange")),this.listenTo(e,"rowNotify",this.onRowNotify),this.autoDisposeCallback((function(){for(let e of this._allRowModels)"function"==typeof e.dispose&&e.dispose()}))}l.makeDisposable(h),n.extend(h.prototype,d.prototype),h.prototype.createLazyRowsModel=function(e,t){var o=t||u,n=this;return new m(e,(function(){return new o(n,n._newRowModel._fields)}))},h.prototype.createFloatingRowModel=function(e){var t=new(e||u)(this,this._newRowModel._fields);return this._floatingRows.add(t),t.autoDisposeCallback((()=>{this._floatingRows.delete(t)})),t},m.prototype=Object.create(a.KoArray.prototype),l.makeDisposable(m),n.extend(m.prototype,s),m.prototype.makeItemModel=function(){var e=this._makeRowModel();return this._allRowModels.add(e),e},m.prototype.unsetItemModel=function(e){this.setItemModel(e,null)},m.prototype.setItemModel=function(e,t){var o=this.peek(),n=e._index.peek();null!==n&&o[n]===e&&(o[n]=null),null!==e._rowId&&this._assignedRowModels.delete(e._rowId),this._setItemModel(e,t),null!==t&&0!==o.length&&(null!==o[t=r.clamp(t,0,o.length-1)]&&o[t]!==e&&this.unsetItemModel(o[t]),o[t]=e,this._assignedRowModels.set(e._rowId,e))},m.prototype.setFloatingRowModel=function(e,t){this._setItemModel(e,t)},m.prototype._setItemModel=function(e,t){var o=this.peek();null===t||0===o.length?(e._index(null),e.assign(null)):(t=r.clamp(t,0,o.length-1),e._index(t),e.assign(this._rowIdArray.peek()[t]))},m.prototype.onRowNotify=function(e,t){if(e===c.ALL){for(let e of this._allRowModels)e.dispatchAction(t);this.trigger("rowModelNotify",this._allRowModels)}else{var o=[];for(let i of e){var n=this._assignedRowModels.get(i);n&&(n.dispatchAction(t),o.push(n))}this.trigger("rowModelNotify",o)}},m.prototype._onSpliceChange=function(e){var t,o,n=e.deleted.length,i=this.peek();for(t=e.start,o=0;o<n;t++,o++)i[t]&&this.unsetItemModel(i[t]);var s=e.added-n;if(0!==s){var l=e.start+n;for(let e of this._assignedRowModels.values()){var a=e._index.peek();a>=l&&e._index(a+s)}}var c=new Array(2+e.added);for(c[0]=e.start,c[1]=n,t=2;t<c.length;t++)c[t]=null;this.arraySplice(e.start,n,r.arrayRepeat(e.added,null))},m.prototype.getRowId=function(e){return this._rowIdArray.at(e)},m.prototype.getRowIndex=function(e){return this._rowIdArray.peek().indexOf(e)},m.prototype.getRowIndexWithSub=function(e){return this._rowIdArray.all().indexOf(e)},m.prototype.getRowModel=function(e){return this._assignedRowModels.get(e)},e.exports=h},33113:(e,t,o)=>{var n=o(77949),i=o(29301),s=o(88438),r=o(3871),l=o(32529);function a(e,t){this.docModel=e,this.tableData=t,this.rowGroupings={},this.isLoaded=i.observable(t.isLoaded),this.autoDispose(t.dataLoadedEmitter.addListener(this.onDataLoaded,this)),this.autoDispose(t.tableActionEmitter.addListener(this.dispatchAction,this))}s.makeDisposable(a),n.extend(a.prototype,r.RowSource.prototype,l.ActionDispatcher),a.prototype.fetch=function(e){return this.isLoaded.peek()&&e&&this.isLoaded(!1),this.tableData.docData.fetchTable(this.tableData.tableId,e)},a.prototype.getAllRows=function(){return this.tableData.getRowIds()},a.prototype.getNumRows=function(){return this.tableData.numRecords()},a.prototype.getRowGrouping=function(e){var t=this.rowGroupings[e];return t||((t=r.RowGrouping.create(null,this.tableData.getRowPropFunc(e))).subscribeTo(this),this.rowGroupings[e]=t),t},a.prototype.onDataLoaded=function(e,t){this.trigger("rowChange","remove",e),this.trigger("rowChange","add",t),this.isLoaded(!0)},a.prototype.sendTableActions=function(e,t){return this.tableData.sendTableActions(e,t)},a.prototype.sendTableAction=function(e,t){return this.tableData.sendTableAction(e,t)},a.prototype._process_AddRecord=function(e,t,o,n){this.trigger("rowChange","add",[o])},a.prototype._process_RemoveRecord=function(e,t,o){this.trigger("rowChange","remove",[o])},a.prototype._process_UpdateRecord=function(e,t,o,n){this.trigger("rowChange","update",[o]),this.trigger("rowNotify",[o],e)},a.prototype._process_ReplaceTableData=function(){},a.prototype._process_BulkAddRecord=function(e,t,o,n){this.trigger("rowChange","add",o)},a.prototype._process_BulkRemoveRecord=function(e,t,o){this.trigger("rowChange","remove",o)},a.prototype._process_BulkUpdateRecord=function(e,t,o,n){this.trigger("rowChange","update",o),this.trigger("rowNotify",o,e)},a.prototype.applySchemaAction=function(e){this.trigger("rowNotify",r.ALL,e)},a.prototype._process_AddColumn=function(e){this.applySchemaAction(e)},a.prototype._process_RemoveColumn=function(e){this.applySchemaAction(e)},a.prototype._process_RenameColumn=function(e){this.applySchemaAction(e)},a.prototype._process_ModifyColumn=function(e){this.applySchemaAction(e)},a.prototype._process_RenameTable=n.noop,a.prototype._process_RemoveTable=n.noop,e.exports=a},32529:(e,t,o)=>{var n=o(77949),i=o(74392),s=o(20543),r=o(83277),l=o(29301),a=o(33620);function c(e,t){return e.saveOnly=function(o){return i.try((()=>t.call(this,o))).tap((()=>e.notifySubscribers(o,"save")))},e.save=function(){return this.saveOnly(this.peek())},e.setAndSave=function(e){return this(e),this.saveOnly(e)},e}function d(e,t){return e(t)}function u(e,t){return e.saveOnly(t)}function p(e){return e.update=function(e){this(n.extend(this.peek(),e))},e._props={},e.prop=function(e){return this._props[e]||(this._props[e]=function(e,t){var o=l.pureComputed({read:function(){return e()[t]},write:function(o){var n=e.peek();n[t]=o,e(n)}});return e.saveOnly&&c(o,(function(o){var i=n.clone(e.peek());return i[t]=o,e.saveOnly(i)})),o}(this,e))},e}t.addSaveInterface=c,t.savingComputed=function(e){return c(l.pureComputed({read:e.read,write:t=>e.write(d,t)}),(t=>e.write(u,t)))},t.setSaveValue=function(e,t,o){let n=void 0===o?e.peek():o;if(t!==n&&(e(t),e.save))return i.try((()=>e.save())).catch((o=>{throw console.warn("setSaveValue %s -> %s failed: %s",n,t,o),e(n),o}))},t.createField=function(e){return c(l.observable(),e)},t.fieldWithDefault=function(e,t,o){var n=a.observableWithDefault(e,t,o);return e.saveOnly&&c(n,e.saveOnly),n},t.jsonObservable=function(e,t,o){t=t||function(e){return e||{}};var n=l.pureComputed({read:function(){var n=e();return t.call(o,n?JSON.parse(n):null)},write:function(t){e(JSON.stringify(t))}});return e.saveOnly&&c(n,(function(t){return e.saveOnly(JSON.stringify(t))})),p(n)},t.objObservable=p;var h={};function m(e){var t=l.observable(h),o=e.read,n=e.save,s=l.pureComputed({read:()=>t()!==h?t():o(),write:e=>t(e!==o()?e:h)});return s.isSaved=l.pureComputed((()=>t()===h)),s.revert=function(){t(h)},n&&c(s,(e=>i.try((()=>e!==o()?n(e):null)).finally(s.revert))),s}function f(e,t,o){s(r.startsWith(e[0],"Bulk"));var i=e[2],l=e[3],a=e.slice(0);a[0]=a[0].slice(4);for(var c=a[3]=l&&n.clone(l),d=0;d<i.length;d++){if(a[2]=i[d],c)for(var u in c)c[u]=l[u][d];t.call(o,a)}}t.customValue=function(e){var t={read:()=>e()};return e.saveOnly&&(t.save=t=>e.saveOnly(t)),m(t)},t.customComputed=m,t.bulkActionExpand=f;var g={dispatchAction:function(e){console.assert(!("function"==typeof this.isDisposed&&this.isDisposed()),`Dispatching action ${e[0]} on disposed object`,this);var t=this["_process_"+e[0]];if("function"==typeof t){var o=e.slice(0);return o[0]=e,t.apply(this,o)}console.warn("Received unknown action %s",e[0])},dispatchBulk:function(e,t,o,n){f(e,this.dispatchAction,this)}};t.ActionDispatcher=g},73353:(e,t,o)=>{var n=o(88438);const{CellStyle:i}=o(73974),{dom:s}=o(18099);function r(e,t={}){this.field=e,this.options=e.widgetOptionsJson;const{defaultTextColor:o="#000000"}=t;this.defaultTextColor=o,this.valueFormatter=this.field.visibleColFormatter,this.defaultTextColor=t.defaultTextColor||"#000000"}n.makeDisposable(r),r.prototype.buildConfigDom=function(){throw new Error("Not Implemented")},r.prototype.buildTransformConfigDom=function(){return null},r.prototype.buildDom=function(e){throw new Error("Not Implemented")},r.prototype.buildColorConfigDom=function(e){return s.create(i,this.field,e,this.defaultTextColor)},e.exports=r},16284:e=>{function t(e){}t.prototype.attach=function(e){},t.prototype.getDom=function(){return null},t.prototype.getCellValue=function(){throw new Error("Not Implemented")},t.prototype.prepForSave=function(){},t.prototype.getTextValue=function(){throw new Error("Not Implemented")},t.prototype.getCursorPos=function(){throw new Error("Not Implemented")},e.exports=t},9443:(e,t,o)=>{var n=o(88438),i=o(77949),s=o(21870);function r(e){s.call(this,e)}n.makeDisposable(r),i.extend(r.prototype,s.prototype),r.skipEditor=function(e,t){if(" "===e)return!t},r.supportsReadonly=function(){return!1},e.exports=r},91938:(e,t,o)=>{var n=o(77949),i=o(88438),s=o(21870);const{Autocomplete:r}=o(6632),{ACIndexImpl:l,buildHighlightedDom:a}=o(11104),{ChoiceItem:c,cssChoiceList:d,cssMatchText:u,cssPlusButton:p,cssPlusIcon:h}=o(31490),{menuCssClass:m}=o(1370),{testId:f}=o(29922),{choiceToken:g,cssChoiceACItem:b}=o(55330),{dom:y}=o(18099);function v(e){s.call(this,e),this.choices=e.field.widgetOptionsJson.peek().choices||[],this.choiceOptions=e.field.widgetOptionsJson.peek().choiceOptions||{},this.enableAddNew=!0}i.makeDisposable(v),n.extend(v.prototype,s.prototype),v.prototype.getCellValue=function(){const e=this.autocomplete&&this.autocomplete.getSelectedItem();return e?e.label:s.prototype.getCellValue.call(this)},v.prototype.renderACItem=function(e,t){const o=this.choiceOptions[e.label];return b(e.isNew?[b.cls("-new"),p(h("Plus")),f("choice-editor-new-item")]:[b.cls("-with-new",this.showAddNew)],g(a(e.label,t,u),o||{},y.style("max-width","100%"),f("choice-editor-item-label")),f("choice-editor-item"))},v.prototype.attach=function(e){if(s.prototype.attach.call(this,e),this.options.readonly)return;const t=this.choices.map((e=>new c(e,!1))),o=new l(t),n={popperOptions:{placement:"bottom"},menuCssClass:`${m} ${d.className} test-autocomplete`,search:e=>this.maybeShowAddNew(o.search(e),e),renderItem:(e,t)=>this.renderACItem(e,t),getItemText:e=>e.label,onClick:()=>this.options.commands.fieldEditSave()};this.autocomplete=r.create(this,this.textInput,n)},v.prototype.prepForSave=async function(){const e=this.autocomplete&&this.autocomplete.getSelectedItem();if(e&&e.isNew){const t=this.options.field.widgetOptionsJson.prop("choices");await t.saveOnly([...t.peek()||[],e.label])}},v.prototype.maybeShowAddNew=function(e,t){this.showAddNew=!1;const o=t.trim();if(!this.enableAddNew||!o)return e;const n=new c(o,!1,!0);return e.items.find((e=>e.cleanText===n.cleanText))||(e.items.push(n),this.showAddNew=!0),e},e.exports=v},40293:(e,t,o)=>{const n=o(68652),i=o(77949),s=o(83277),r=o(24412),l=o(88438),a=o(81294),c=o(92979),d=o(21870),{parseDate:u,TWO_DIGIT_YEAR_THRESHOLD:p}=o(62862);var h=$.fn.datepicker.Constructor;function m(e){this.timezone=e.timezone||"UTC",this.dateFormat=e.field.widgetOptionsJson.peek().dateFormat,this.locale=e.field.documentSettings.peek().locale,this.safeFormat=function(e){let t=e;return t.includes("Y")||(t+=" YYYY"),t.includes("D")&&t.includes("M")||(t="YYYY-MM-DD"),t}(this.dateFormat);const t=n.tz.guess();let o=n.tz(t).format(this.safeFormat);e.readonly&&(o=null),d.call(this,i.defaults(e,{placeholder:o}));const l=this.formatValue(e.cellValue,this.safeFormat,!0);if(this.textInput.value=s.undef(e.state,e.editValue,l),!e.readonly){this._keyboardNav=!1,this._datePickerWidget=$(this.textInput).datepicker({keyboardNavigation:!1,forceParse:!1,todayHighlight:!0,todayBtn:"linked",assumeNearbyYear:p,language:this.getLanguage(),format:{toDisplay:(e,t,o)=>n.utc(e).format(this.safeFormat),toValue:(e,t,o)=>{const n=u(e,{dateFormat:this.safeFormat,timezone:this.timezone});return null===n?null:new Date(1e3*n)}}}),this.autoDisposeCallback((()=>this._datePickerWidget.datepicker("destroy"))),this._datePickerWidget.on("keydown",(e=>{13!==e.keyCode&&27!==e.keyCode||(this._datePickerWidget.datepicker("destroy"),setTimeout((()=>e.currentTarget.dispatchEvent(e.originalEvent)),0))}));let t=Object.assign({},e.commands,{datepickerFocus:()=>{this._allowKeyboardNav(!0)}});this._datepickerCommands=this.autoDispose(r.createGroup(t,this,!0)),this._datePickerWidget.on("show",(()=>{a(document.querySelector(".datepicker"),c.attr("tabIndex",0),c.toggleClass("clipboard_focus",!0)),a(this.textInput,a.on("input",(()=>{this._allowKeyboardNav(!1)})),this._datepickerCommands.attach())}))}}Object.defineProperty(h.prototype,"isInput",{get:function(){return!0},set:function(e){}}),l.makeDisposable(m),i.extend(m.prototype,d.prototype),m.prototype.getCellValue=function(){let e=u(this.textInput.value,{dateFormat:this.safeFormat,timezone:this.timezone});return null!==e?e:this.textInput.value},m.prototype._allowKeyboardNav=function(e){this._keyboardNav!==e&&(this._keyboardNav=e,$(this.textInput).data().datepicker.o.keyboardNavigation=e,$(this.textInput).data().datepicker.o.forceParse=e)},m.prototype.formatValue=function(e,t,o){return i.isNumber(e)&&t?n.tz(1e3*e,this.timezone).format(t):o&&"string"==typeof e?e:""},m.prototype.getLanguage=function(){return this.locale.substr(0,this.locale.indexOf("-"))},e.exports=m},38062:(e,t,o)=>{var n=o(77949),i=o(29301),s=o(81294),r=o(88438),l=o(92979),a=o(73783),c=o(73353);const{fromKoSave:d}=o(95163),{alignmentSelect:u,cssButtonSelect:p}=o(88261),{cssRow:h,cssLabel:m}=o(3411),{cssTextInput:f}=o(29002),{styled:g,fromKo:b}=o(18099),{select:y}=o(1370),{dateFormatOptions:v}=o(62862);function _(e){c.call(this,e),this.alignment=this.options.prop("alignment"),this.dateFormat=this.field.config.options.prop("dateFormat"),this.isCustomDateFormat=this.field.config.options.prop("isCustomDateFormat"),this.mixedDateFormat=i.pureComputed((()=>null===this.dateFormat()||null===this.isCustomDateFormat())),this.standardDateFormat=this.autoDispose(i.computed({owner:this,read:function(){return this.mixedDateFormat()?null:this.isCustomDateFormat()?"Custom":this.dateFormat()},write:function(e){"Custom"===e?this.isCustomDateFormat.setAndSave(!0):(this.field.config.options.update({isCustomDateFormat:!1,dateFormat:e}),this.field.config.options.save())}})),this.timezone=i.observable("UTC")}r.makeDisposable(_),n.extend(_.prototype,c.prototype),_.prototype.buildDateConfigDom=function(){const e=this.field.config.options.disabled("dateFormat");return s("div",m("Date Format"),h(s(y(b(this.standardDateFormat),[...v,"Custom"],{disabled:e,defaultLabel:"Mixed format"}),s.testId("Widget_dateFormat"))),l.maybe((()=>!this.mixedDateFormat()&&this.isCustomDateFormat()),(()=>h(s(function(e,t){const o=a.text(e,null!=t?t:{}),n=o.querySelector("input");return s(n,l.cssClass(f.className),l.cssClass(x.className)),s(o,l.cssClass(w.className)),o}(this.dateFormat,{disabled:e}),s.testId("Widget_dateCustomFormat"))))))},_.prototype.buildConfigDom=function(){return s("div",this.buildDateConfigDom(),h(u(d(this.field.config.options.prop("alignment")),p.cls("-disabled",this.field.config.options.disabled("alignment")))))},_.prototype.buildTransformConfigDom=function(){return this.buildDateConfigDom()},_.prototype.buildDom=function(e){let t=e[this.field.colId()];return s("div.field_clip",l.style("text-align",this.alignment),l.text((()=>e._isAddRow()?"":this.valueFormatter().format(t()))))};const w=g("div","\n  flex: 1;\n  margin: 0px;\n"),x=g("div","\n  &:focus {\n    outline: none;\n    box-shadow: 0 0 3px 2px var(--grist-color-cursor);\n    border: 1px solid transparent;\n  }\n");e.exports=_},52445:(e,t,o)=>{const n=o(68652),i=o(77949),s=o(81294),r=o(88438),l=o(92979),a=o(40293),c=o(83277),{parseDate:d}=o(62862),u=o(21870);function p(e){e.timezone=c.removePrefix(e.field.column().type(),"DateTime:");var t=e.commands;e.readonly||(e.commands=Object.assign({},t,{prevField:()=>1===this._focusIndex()?this._setFocus(0):t.prevField(),nextField:()=>0===this._focusIndex()?this._setFocus(1):t.nextField()})),a.call(this,e),this._timeFormat=e.field.widgetOptionsJson.peek().timeFormat,this._dateSizer=this.contentSizer,this._dateInput=this.textInput;const o=i.isNumber(e.cellValue),r=this.formatValue(e.cellValue,this._timeFormat,!1),d=n.tz("0","H",this.timezone).format(this._timeFormat);if(e.readonly){if(o){const e=r||d,t=e?" ":"";this.textInput.value=this.textInput.value+t+e}}else s(this.dom,l.toggleClass("celleditor_datetime",!0)),s(this.dom.firstChild,l.toggleClass("celleditor_datetime_editor",!0)),this.dom.appendChild(s("div.celleditor_cursor_editor.celleditor_datetime_editor",this._timeSizer=s("div.celleditor_content_measure"),this._timeInput=s("textarea.celleditor_text_editor",l.attr("placeholder",d),l.value(r),this.commandGroup.attach(),s.on("input",(()=>this.onChange())))));if("string"==typeof e.state)try{const{date:t,time:o}=JSON.parse(e.state);this._dateInput.value=t,this._timeInput.value=o,this.onChange()}catch(e){console.error("DateTimeEditor can't restore its previous state")}}r.makeDisposable(p),i.extend(p.prototype,a.prototype),p.prototype.setSizerLimits=function(){var e=this.editorPlacement.calcSize({width:1/0,height:1/0},{calcOnly:!0});this.options.readonly||(this._dateSizer.style.maxWidth=this._timeSizer.style.maxWidth=Math.ceil(e.width/2-6)+"px")},p.prototype._focusIndex=function(){return document.activeElement===this._dateInput?0:document.activeElement===this._timeInput?1:null},p.prototype._setFocus=function(e){var t=0===e?this._dateInput:1===e?this._timeInput:null;t&&(t.focus(),t.selectionStart=0,t.selectionEnd=t.value.length)},p.prototype.onChange=function(){this._resizeInput();const e=this._dateInput.value,t=this._timeInput.value;this.editorState.set(JSON.stringify({date:e,time:t}))},p.prototype.getCellValue=function(){let e=this._dateInput.value,t=this._timeInput.value,o=d(e,{dateFormat:this.safeFormat,time:t,timeFormat:this._timeFormat,timezone:this.timezone});return null!==o?o:e&&t?`${e} ${t}`:e||t},p.prototype._resizeInput=function(){if(this.options.readonly)u.prototype._resizeInput.call(this);else{this._dateSizer.textContent=this._dateInput.value,this._timeSizer.textContent=this._timeInput.value;var e=this._dateSizer.getBoundingClientRect(),t=this._timeSizer.getBoundingClientRect(),o=this.editorPlacement.calcSize({width:e.width+t.width+12,height:Math.max(e.height,t.height)+3});this.dom.style.width=o.width+"px",this._dateInput.parentNode.style.flexBasis=e.width+6+"px",this._timeInput.parentNode.style.flexBasis=t.width+6+"px",this._dateInput.style.height=Math.ceil(o.height-3)+"px",this._timeInput.style.height=Math.ceil(o.height-3)+"px"}},e.exports=p},38149:(e,t,o)=>{var n=o(77949),i=o(29301),s=o(68652),r=o(81294),l=o(88438),a=o(92979),c=o(73783),d=o(38062),u=o(83277);const{fromKoSave:p}=o(95163),{alignmentSelect:h,cssButtonSelect:m}=o(88261),{cssRow:f,cssLabel:g}=o(3411),{cssTextInput:b}=o(29002),{dom:y,styled:v,fromKo:_}=o(18099),{select:w}=o(1370),{buildTZAutocomplete:x}=o(73454),{timeFormatOptions:C}=o(62862);function D(e){d.call(this,e),this._timezone=this.autoDispose(i.computed((()=>u.removePrefix(e.column().type(),"DateTime:")))),this._setTimezone=t=>e.column().type.setAndSave("DateTime:"+t),this.timeFormat=this.field.config.options.prop("timeFormat"),this.isCustomTimeFormat=this.field.config.options.prop("isCustomTimeFormat"),this.mixedTimeFormat=i.pureComputed((()=>null===this.timeFormat()||null===this.isCustomTimeFormat())),this.standardTimeFormat=this.autoDispose(i.computed({owner:this,read:function(){return this.isCustomTimeFormat()?"Custom":this.timeFormat()},write:function(e){"Custom"===e?this.isCustomTimeFormat.setAndSave(!0):(this.isCustomTimeFormat.setAndSave(!1),this.timeFormat.setAndSave(e))}}))}l.makeDisposable(D),n.extend(D.prototype,d.prototype),D.prototype.buildConfigDom=function(e){const t=i.pureComputed((()=>this.field.config.options.disabled("timeFormat")()||this.field.column().disableEditData())),o=p(this.field.config.options.prop("alignment"));return r("div",g("Timezone"),f(y.create(x,s,_(this._timezone),this._setTimezone,{disabled:_(t)})),this.buildDateConfigDom(),g("Time Format"),f(r(w(_(this.standardTimeFormat),[...C,"Custom"],{disabled:_(t),defaultLabel:"Mixed format"}),r.testId("Widget_timeFormat"))),a.maybe((()=>!this.mixedTimeFormat()&&this.isCustomTimeFormat()),(()=>f(r(function(e,t){const o=c.text(e,t||{}),n=o.querySelector("input");return r(n,a.cssClass(b.className),a.cssClass(S.className)),r(o,a.cssClass(k.className)),o}(this.timeFormat,{disabled:this.field.config.options.disabled("timeFormat")}),r.testId("Widget_timeCustomFormat"))))),e?null:f(h(o,m.cls("-disabled",this.field.config.options.disabled("alignment")))))},D.prototype.buildTransformConfigDom=function(){return this.buildConfigDom(!0)};const k=v("div","\n  flex: 1;\n  margin: 0px;\n"),S=v("div","\n  &:focus {\n    outline: none;\n    box-shadow: 0 0 3px 2px #5e9ed6;\n    border: 1px solid transparent;\n  }\n");e.exports=D},21870:(e,t,o)=>{var n=o(77949),i=o(83277),s=o(81294),r=o(92979),l=o(88438),a=o(16284),c=o(24412);const{testId:d}=o(29922),{createMobileButtons:u,getButtonMargins:p}=o(16151),{EditorPlacement:h}=o(41880),{observable:m}=o(18099);function f(e){this.options=e,this.commandGroup=this.autoDispose(c.createGroup(e.commands,null,!0)),this._alignment=e.field.widgetOptionsJson.peek().alignment||"left";const t=i.undef(e.state,e.editValue,String(null==e.cellValue?"":e.cellValue));this.editorState=this.autoDispose(m(t)),this.dom=s("div.default_editor",r.toggleClass("readonly_editor",e.readonly),s("div.celleditor_cursor_editor",s.testId("TextEditor_editor"),d("widget-text-editor"),this.contentSizer=s("div.celleditor_content_measure"),this.textInput=s("textarea.celleditor_text_editor",r.attr("placeholder",e.placeholder||""),r.style("text-align",this._alignment),r.boolAttr("readonly",e.readonly),r.value(t),this.commandGroup.attach(),s.on("input",(()=>this.onChange())))),u(e.commands))}l.makeDisposable(f),n.extend(f.prototype,a.prototype),f.prototype.attach=function(e){this.editorPlacement=h.create(this,this.dom,e,{margins:p()}),this.autoDispose(this.editorPlacement.onReposition.addListener(this._resizeInput,this)),this.setSizerLimits(),this._resizeInput(),this.textInput.focus();var t=Math.min(this.options.cursorPos,this.textInput.value.length);this.textInput.setSelectionRange(t,t)},f.prototype.getDom=function(){return this.dom},f.prototype.setSizerLimits=function(){const e=this.editorPlacement.calcSizeWithPadding(this.textInput,{width:1/0,height:1/0},{calcOnly:!0});this.contentSizer.style.maxWidth=Math.ceil(e.width)+"px"},f.prototype.getCellValue=function(){return this.textInput.value},f.prototype.onChange=function(){this.editorState&&this.editorState.set(this.getTextValue()),this._resizeInput()},f.prototype.getTextValue=function(){return this.textInput.value},f.prototype.getCursorPos=function(){return this.textInput.selectionStart},f.prototype._resizeInput=function(){var e=this.textInput;this.contentSizer.textContent=e.value+"​";var t=this.contentSizer.getBoundingClientRect();"left"===this._alignment&&(t.width+=16);var o=this.editorPlacement.calcSizeWithPadding(e,t);e.style.width=o.width+"px",e.style.height=o.height+"px"},e.exports=f},49674:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=49674,e.exports=t}}]);
//# sourceMappingURL=928.bundle.js.map